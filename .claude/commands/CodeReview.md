---
description: 代码审查 - 全面代码审查，重点检测过度设计和接口一致性
---

# 代码审查指令

本指令用于对指定代码进行全面审查，生成CR文档。

**🔴 重点审查项**：过度设计检测、接口一致性验证

---

## 🔴 执行前必读

1. **Rules/RulesReadMe.md** - 项目通用规则
2. **Rules/开发文档规范.md** - CR文档格式规范
3. **.kiro/steering/structure.md** - 项目架构规范
4. **.kiro/steering/tech.md** - 技术栈规范

---

## 📋 执行流程

### 第一步：收集审查信息

向用户确认：

1. **审查范围**（必填）
   - 具体文件路径 / 模块路径 / TD任务编号

2. **关联文档**（可选）
   - PRD、FD、TDD、TD文档编号（用于验证功能完整性）

---

## 🎯 审查检查清单

### 一、🔴 过度设计检测（重点）

**目标**：识别代码复杂度超出实际需求的情况

| 检查项 | 判定标准 | 严重程度 |
|--------|---------|---------|
| 抽象层级过多 | 简单功能却有3层以上抽象（Interface→Impl→Wrapper） | 🔴 高 |
| 无用设计模式 | Factory/Strategy/Decorator只有1个实现 | 🔴 高 |
| 过早优化 | 添加缓存/池化但无性能数据支撑 | 🟡 中 |
| 冗余参数 | 函数参数>5个，或存在从未使用的参数 | 🟡 中 |
| 过度泛型 | 泛型约束复杂但实际只用于1-2种类型 | 🟡 中 |
| 无用扩展点 | 预留扩展接口但项目中从未使用 | � 低 |中
| 配置过度 | 可配置项>10个但大部分使用默认值 | 🟢 低 |

**审查方法**：
```
1. 统计类/接口数量 vs 实际功能点数量（比例>3:1可能过度设计）
2. 检查每个接口的实现数量（只有1个实现且无Mock需求→可能不需要接口）
3. 检查设计模式使用（Factory只创建1种对象→过度设计）
4. 对比PRD/FD需求描述（代码功能>需求描述→可能过度设计）
```

---

### 二、🔴 接口一致性验证（重点）

**目标**：确保实现类完全匹配接口定义

| 检查项 | 判定标准 | 严重程度 |
|--------|---------|---------|
| 方法签名匹配 | 实现类方法签名与接口完全一致 | 🔴 高 |
| 返回类型一致 | 返回接口声明的类型（含泛型） | 🔴 高 |
| 空实现检测 | 存在TODO、throw NotImplementedError() | 🔴 高 |
| 假实现检测 | 直接返回空值/默认值而非真正实现 | 🔴 高 |
| 契约遵守 | 遵守接口文档中的前置/后置条件 | 🟡 中 |
| 异常处理一致 | 抛出接口声明的异常类型 | 🟡 中 |

**审查方法**：
```
1. 定位接口：domain/repository/*.kt, domain/service/*.kt
2. 定位实现：data/repository/*Impl.kt
3. 逐方法对比：方法名、参数类型、返回类型、suspend修饰符
4. 追踪调用链：ViewModel → UseCase → Repository接口 → RepositoryImpl
```

---

### 三、架构合规性检查

| 检查项 | 判定标准 | 严重程度 |
|--------|---------|---------|
| 层级依赖违规 | Domain层依赖了Data/Presentation层 | 🔴 高 |
| 包结构错误 | 文件未放在正确的包路径下 | 🟡 中 |
| 命名规范违规 | 类名缺少ViewModel/UseCase/Repository后缀 | 🟡 中 |
| DI注入错误 | 手动创建依赖而非Hilt注入 | 🔴 高 |
| 数据流向错误 | 未遵循UI→ViewModel→UseCase→Repository | 🔴 高 |

---

### 四、代码质量检查

| 检查项 | 判定标准 | 严重程度 |
|--------|---------|---------|
| 错误处理缺失 | 未使用Result包装，缺少try-catch | 🔴 高 |
| 空安全问题 | 未正确处理nullable类型，强制!! | 🔴 高 |
| 硬编码 | 魔法数字、硬编码字符串 | 🟡 中 |
| 代码重复 | >10行相似代码块 | 🟡 中 |
| 函数过长 | 单个函数>50行 | 🟢 低 |
| 嵌套过深 | 单个函数嵌套>3层 | 🟡 中 |
| 注释缺失 | 公开API无KDoc注释 | 🟢 低 |

---

### 五、功能完整性检查

| 检查项 | 判定标准 | 严重程度 |
|--------|---------|---------|
| TODO/FIXME | 存在未完成的TODO标记 | 🟡 中 |
| 未实现方法 | throw NotImplementedError() | 🔴 高 |
| 空实现 | 空函数体或只返回默认值 | 🔴 高 |
| 功能缺失 | 代码实现与PRD/FD描述不一致 | 🔴 高 |
| 死代码 | 存在永远不会执行的代码分支 | 🟡 中 |

---

### 六、性能风险检查

| 检查项 | 判定标准 | 严重程度 |
|--------|---------|---------|
| 内存泄漏 | ViewModel持有Activity/Context引用 | 🔴 高 |
| 协程作用域错误 | 使用GlobalScope而非viewModelScope | 🔴 高 |
| 主线程阻塞 | IO操作未在Dispatchers.IO执行 | 🔴 高 |
| Compose重组问题 | 未正确使用remember/derivedStateOf | 🟡 中 |
| 列表性能 | LazyColumn未使用key参数 | 🟡 中 |
| 图片加载 | 未使用异步加载或缺少缓存策略 | 🟡 中 |
| N+1查询 | 循环中执行数据库/网络请求 | 🔴 高 |

---

### 七、安全合规检查

| 检查项 | 判定标准 | 严重程度 |
|--------|---------|---------|
| 敏感数据存储 | API密钥未使用EncryptedSharedPreferences | 🔴 高 |
| 日志泄露 | Release版本输出敏感信息 | 🔴 高 |
| 权限滥用 | 申请非必要权限 | 🟡 中 |
| 数据脱敏缺失 | 发送AI的数据未经PrivacyEngine处理 | 🔴 高 |
| 网络安全 | 未使用HTTPS或未验证证书 | 🔴 高 |
| SQL注入 | 使用字符串拼接构建SQL | 🔴 高 |

---

### 八、测试覆盖检查

| 检查项 | 判定标准 | 严重程度 |
|--------|---------|---------|
| 单元测试缺失 | 核心UseCase/ViewModel无测试文件 | 🟡 中 |
| 边界测试缺失 | 未测试边界条件和异常情况 | 🟢 低 |
| Mock使用错误 | 未正确使用MockK进行依赖模拟 | 🟢 低 |
| 测试命名不规范 | 测试方法名未描述测试场景 | 🟢 低 |

---


## 📝 审查报告模板

保存到 `文档/开发文档/CR/CR-xxxxx-yyyy.md`

```markdown
# CR-xxxxx-代码审查报告

> **文档类型**: 代码审查报告 (CR)  
> **创建日期**: YYYY-MM-DD  
> **审查人**: [审查人]  
> **审查范围**: [文件/模块路径]  
> **关联文档**: [PRD/FD/TDD/TD编号]

---

## 📊 审查结果摘要

| 审查项 | 状态 | 问题数 | 说明 |
|--------|------|--------|------|
| 🔴 过度设计 | ✅/⚠️/❌ | x | [简要说明] |
| 🔴 接口一致性 | ✅/⚠️/❌ | x | [简要说明] |
| 架构合规性 | ✅/⚠️/❌ | x | [简要说明] |
| 代码质量 | ✅/⚠️/❌ | x | [简要说明] |
| 功能完整性 | ✅/⚠️/❌ | x | [简要说明] |
| 性能风险 | ✅/⚠️/❌ | x | [简要说明] |
| 安全合规 | ✅/⚠️/❌ | x | [简要说明] |
| 测试覆盖 | ✅/⚠️/❌ | x | [简要说明] |

**整体评分**: x.x/10 ([优秀/良好/合格/需改进])

---

## 一、🔴 过度设计检测结果

### ✅ 设计合理

[列出设计合理的部分及原因]

### ❌ 过度设计问题

#### OD-001: [问题标题]

**问题描述**: [具体描述]

**代码位置**: `文件路径:行号`

**当前代码**:
```kotlin
// 过度设计的代码
```

**简化建议**:
```kotlin
// 简化后的代码
```

**简化理由**: [为什么可以简化]

---

## 二、🔴 接口一致性验证结果

### 接口-实现对照表

| 接口 | 实现类 | 方法数 | 状态 |
|------|--------|--------|------|
| XxxRepository | XxxRepositoryImpl | x | ✅/❌ |

### ✅ 一致的实现

[列出完全匹配的接口-实现对]

### ❌ 不一致问题

#### IC-001: [问题标题]

**接口定义** (`domain/repository/XxxRepository.kt:行号`):
```kotlin
suspend fun doSomething(param: String): Result<Data>
```

**实际实现** (`data/repository/XxxRepositoryImpl.kt:行号`):
```kotlin
// 问题代码
```

**问题类型**: [空实现/签名不匹配/返回类型错误/未实现]

**修复建议**:
```kotlin
// 正确的实现代码
```

---

## 三、架构合规性检查结果

### ✅ 合规项
[列出符合规范的项目]

### ❌ 不合规项

#### AR-001: [问题标题]
**问题描述**: [具体描述]
**代码位置**: `文件路径:行号`
**修复建议**: [具体建议]

---

## 四、代码质量检查结果

### ✅ 合规项
[列出符合规范的项目]

### ⚠️ 警告项

#### CQ-001: [问题标题]
**问题描述**: [具体描述]
**代码位置**: `文件路径:行号`
**问题代码**:
```kotlin
// 问题代码
```
**修复建议**:
```kotlin
// 修复后代码
```

---

## 五、功能完整性检查结果

### ✅ 已实现功能
[列出已完整实现的功能]

### ❌ 未实现/空实现

#### FI-001: [问题标题]
**问题描述**: [具体描述]
**代码位置**: `文件路径:行号`
**关联需求**: [PRD/FD中的需求描述]

---

## 六、性能风险检查结果

### ✅ 无风险项
[列出无性能风险的部分]

### ⚠️ 潜在风险

#### PR-001: [问题标题]
**风险描述**: [具体描述]
**代码位置**: `文件路径:行号`
**优化建议**: [具体建议]

---

## 七、安全合规检查结果

### ✅ 合规项
[列出符合安全规范的项目]

### ❌ 不合规项

#### SC-001: [问题标题]
**问题描述**: [具体描述]
**代码位置**: `文件路径:行号`
**修复建议**: [具体建议]

---

## 八、测试覆盖检查结果

### 测试文件对照

| 源文件 | 测试文件 | 状态 |
|--------|---------|------|
| XxxViewModel.kt | XxxViewModelTest.kt | ✅/❌ |

### ⚠️ 测试缺失

#### TC-001: [问题标题]
**缺失测试**: [需要补充的测试]
**建议测试用例**: [测试场景描述]

---

## 🔧 修复优先级汇总

### P1 - 必须修复（阻塞发布）

| 编号 | 类型 | 问题 | 文件 |
|------|------|------|------|
| IC-001 | 接口一致性 | [问题描述] | [文件路径] |
| FI-001 | 功能完整性 | [问题描述] | [文件路径] |

### P2 - 建议修复（影响质量）

| 编号 | 类型 | 问题 | 文件 |
|------|------|------|------|
| OD-001 | 过度设计 | [问题描述] | [文件路径] |
| CQ-001 | 代码质量 | [问题描述] | [文件路径] |

### P3 - 可选优化

| 编号 | 类型 | 问题 | 文件 |
|------|------|------|------|
| PR-001 | 性能风险 | [问题描述] | [文件路径] |

---

## 📊 统计信息

| 类别 | 数量 |
|------|------|
| ✅ 合规项 | x |
| ⚠️ 警告项 | x |
| ❌ 不合规项 | x |
| **总计** | **x** |

---

**文档版本**: 1.0  
**最后更新**: YYYY-MM-DD
```

---

## ⚠️ 关键规则

1. **接口优先**：先读接口定义，再读实现，逐方法对比
2. **追踪调用链**：从ViewModel追踪到Repository，验证完整性
3. **质疑每个抽象**：每个接口/抽象类都要问"为什么需要"
4. **对比需求文档**：代码功能不应超出PRD/FD描述范围
5. **给出具体代码**：每个问题必须给出修复代码示例
6. **编号规则**：CR文档编号需查询现有最大编号后递增

---

## 📝 示例用法

```
/CodeReview 
审查范围：app/src/main/java/com/empathy/ai/data/repository/AiRepositoryImpl.kt
关联文档：TD-00003
```

执行结果：生成 `CR-00010-AiRepositoryImpl代码审查.md`
