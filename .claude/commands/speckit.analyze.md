---
description: 一致性分析 - 对 PRD、TDD 和 FD 进行一致性和质量分析（只读，不修改文件）
---

**说明：** 本命令用于在任务生成后，对需求文档、技术设计和功能文档三个核心文档进行跨文档的一致性和质量分析。这是一个只读命令，不会修改任何文件，只输出结构化的分析报告。

## 用户输入

```text
$ARGUMENTS
```

在继续之前，**必须**考虑用户输入（如果非空）。

## 目标

在实施前识别三个核心产物（`PRD`、`TDD`、`FD`）之间的不一致、重复、歧义和未充分指定的项目。此命令必须在 `/speckit.tasks` 成功生成完整的 FD 后才能运行。

## 操作约束

**严格只读**: **不要**修改任何文件。输出结构化分析报告。提供可选的修复计划（用户必须明确批准后才能手动调用任何后续编辑命令）。

**宪法权威**: 项目宪法（`.specify/memory/constitution.md`）在此分析范围内是**不可协商的**。宪法冲突自动为关键级别，需要调整 PRD、TDD 或 FD - 而不是稀释、重新解释或静默忽略原则。

## 执行步骤

### 1. 初始化分析上下文

查找文档路径：
- PRD = `文档/开发文档/PRD/PRD-xxxxx-功能名称.md`
- TDD = `文档/开发文档/TDD/TDD-xxxxx-功能名称.md`
- FD = `文档/开发文档/FD/FD-xxxxx-功能名称.md`

如果任何必需文件缺失则中止并显示错误消息（指示用户运行缺失的前置命令）。

### 2. 加载产物（渐进式披露）

仅从每个产物加载最少必要的上下文：

**从 PRD:**
- 概述/上下文
- 功能需求
- 非功能需求
- 用户故事
- 边界情况（如存在）

**从 TDD:**
- 架构/技术栈选择
- 数据模型引用
- 阶段
- 技术约束

**从 FD:**
- 任务 ID
- 描述
- 阶段分组
- 并行标记 [P]
- 引用的文件路径

**从宪法:**
- 加载 `.specify/memory/constitution.md` 用于原则验证

### 3. 构建语义模型

创建内部表示（不在输出中包含原始产物）：

- **需求清单**: 每个功能 + 非功能需求带有稳定键
- **用户故事/操作清单**: 带有验收标准的离散用户操作
- **任务覆盖映射**: 将每个任务映射到一个或多个需求或故事
- **宪法规则集**: 提取原则名称和必须/应该规范性声明

### 4. 检测通道（高效分析）

聚焦于高信号发现。限制为总共 50 个发现；在溢出摘要中汇总其余部分。

#### A. 重复检测
- 识别近似重复的需求
- 标记较低质量的措辞以进行整合

#### B. 歧义检测
- 标记缺乏可衡量标准的模糊形容词（快速、可扩展、安全、直观、健壮）
- 标记未解决的占位符（TODO、TKTK、???、`<placeholder>` 等）

#### C. 未充分指定
- 有动词但缺少对象或可衡量结果的需求
- 缺少验收标准对齐的用户故事
- 引用 PRD/TDD 中未定义的文件或组件的任务

#### D. 宪法对齐
- 任何与必须原则冲突的需求或计划元素
- 宪法中缺少的强制章节或质量门禁

#### E. 覆盖差距
- 零关联任务的需求
- 无映射需求/故事的任务
- 未反映在任务中的非功能需求（例如，性能、安全）

#### F. 不一致
- 术语漂移（同一概念在不同文件中命名不同）
- TDD 中引用但 PRD 中缺失的数据实体（或反之）
- 任务排序矛盾

### 5. 严重性分配

使用此启发式方法优先排序发现：

- **关键**: 违反宪法必须、缺少核心规格产物、或阻塞基线功能的零覆盖需求
- **高**: 重复或冲突的需求、歧义的安全/性能属性、不可测试的验收标准
- **中**: 术语漂移、缺少非功能任务覆盖、未充分指定的边界情况
- **低**: 风格/措辞改进、不影响执行顺序的轻微冗余

### 6. 生成紧凑分析报告

输出 Markdown 报告（不写入文件），结构如下：

## 规格分析报告

| ID | 类别 | 严重性 | 位置 | 摘要 | 建议 |
|----|------|--------|------|------|------|
| A1 | 重复 | 高 | PRD:L120-134 | 两个相似的需求... | 合并措辞；保留更清晰的版本 |

**覆盖摘要表:**

| 需求键 | 有任务? | 任务 ID | 备注 |
|--------|---------|---------|------|

**宪法对齐问题:** （如有）

**未映射任务:** （如有）

**指标:**
- 总需求数
- 总任务数
- 覆盖率 %（有 >=1 任务的需求）
- 歧义数
- 重复数
- 关键问题数

### 7. 提供下一步操作

在报告末尾，输出简洁的下一步操作块：

- 如果存在关键问题：建议在 `/speckit.implement` 之前解决
- 如果只有低/中问题：用户可以继续，但提供改进建议
- 提供明确的命令建议

### 8. 提供修复方案

询问用户："是否希望我为前 N 个问题建议具体的修复编辑？"（不要自动应用。）

## 文档信息

**相关文档**:
- 需求文档: `文档/开发文档/PRD/PRD-xxxxx-功能名称.md`
- 技术设计: `文档/开发文档/TDD/TDD-xxxxx-功能名称.md`
- 功能文档: `文档/开发文档/FD/FD-xxxxx-功能名称.md`
