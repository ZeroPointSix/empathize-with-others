---
description: 需求定义 - 从自然语言功能描述创建或更新 PRD 需求文档
handoffs: 
  - label: 构建技术计划
    agent: speckit.plan
    prompt: 为需求创建技术设计。我正在使用...
  - label: 澄清需求
    agent: speckit.clarify
    prompt: 澄清需求中的模糊点
    send: true
---

**说明：** 本命令用于从自然语言功能描述创建或更新 PRD 需求文档。会自动生成文档编号、创建需求文件、进行质量验证，并处理需要澄清的问题。

## 用户输入

```text
$ARGUMENTS
```

在继续之前，**必须**考虑用户输入（如果非空）。

## 执行流程

用户在 `/speckit.specify` 后输入的文本**就是**功能描述。假设你始终可以在此对话中获取它，即使 `$ARGUMENTS` 在下面显示为字面量。除非用户提供了空命令，否则不要要求用户重复。

根据该功能描述，执行以下操作：

1. **生成简短名称**（2-4个词）用于文档编号：
   - 分析功能描述并提取最有意义的关键词
   - 创建2-4个词的简短名称，捕捉功能的本质
   - 尽可能使用动作-名词格式（例如："悬浮窗最小化"、"联系人管理"）
   - 保留技术术语和缩写（OAuth2、API、JWT等）
   - 保持简洁但足够描述性，一眼就能理解功能
   - 示例：
     - "我想添加用户认证" → "用户认证"
     - "实现悬浮窗最小化功能" → "悬浮窗最小化"
     - "创建联系人管理页面" → "联系人管理"

2. **确定文档编号**：
   - 检查 `文档/开发文档/PRD/` 目录下现有的 PRD 文档
   - 找到最高编号 N
   - 使用 N+1 作为新文档编号
   - 如果目录不存在或为空，从 00001 开始
   - 文档命名格式：`PRD-xxxxx-功能名称.md`

3. **创建目录结构**（如果不存在）：
   ```
   文档/开发文档/PRD/
   ```

4. 加载 `.specify/templates/spec-template.md` 了解所需章节。

5. 按照以下执行流程：

    1. 解析用户描述
       如果为空：错误 "未提供功能描述"
    2. 从描述中提取关键概念
       识别：参与者、操作、数据、约束
    3. 对于不明确的方面：
       - 根据上下文和行业标准做出合理推断
       - 仅在以下情况标记 [待澄清: 具体问题]：
         - 选择显著影响功能范围或用户体验
         - 存在多种合理解释且含义不同
         - 不存在合理的默认值
       - **限制：最多3个 [待澄清] 标记**
       - 按影响优先级排序：范围 > 安全/隐私 > 用户体验 > 技术细节
    4. 填写用户场景与测试章节
       如果无法确定用户流程：错误 "无法确定用户场景"
    5. 生成功能需求
       每个需求必须可测试
       对未指定的细节使用合理默认值（在假设章节记录）
    6. 定义成功标准
       创建可衡量的、技术无关的结果
       包括定量指标（时间、性能、数量）和定性指标（用户满意度、任务完成率）
       每个标准必须可验证且不涉及实现细节
    7. 识别关键实体（如涉及数据）
    8. 返回：成功（需求文档准备就绪）

6. 使用模板结构将需求文档写入 `文档/开发文档/PRD/PRD-xxxxx-功能名称.md`，用从功能描述（参数）派生的具体细节替换占位符，同时保留章节顺序和标题。

7. **需求文档质量验证**：写入初始文档后，根据质量标准进行验证：

   a. **创建质量检查清单**：在 `文档/开发文档/PRD/` 目录下生成检查清单，使用以下验证项：

      ```markdown
      # 需求文档质量检查清单: [功能名称]
      
      **用途**: 在进入设计阶段前验证需求文档的完整性和质量
      **创建日期**: [日期]
      **关联文档**: PRD-xxxxx-功能名称.md
      
      ## 内容质量
      
      - [ ] 无实现细节（语言、框架、API）
      - [ ] 聚焦于用户价值和业务需求
      - [ ] 为非技术利益相关者编写
      - [ ] 所有必填章节已完成
      
      ## 需求完整性
      
      - [ ] 无 [待澄清] 标记残留
      - [ ] 需求可测试且无歧义
      - [ ] 成功标准可衡量
      - [ ] 成功标准技术无关（无实现细节）
      - [ ] 所有验收场景已定义
      - [ ] 边界情况已识别
      - [ ] 范围明确界定
      - [ ] 依赖和假设已识别
      
      ## 功能就绪性
      
      - [ ] 所有功能需求有明确的验收标准
      - [ ] 用户场景覆盖主要流程
      - [ ] 功能满足成功标准中定义的可衡量结果
      - [ ] 无实现细节泄露到需求文档
      
      ## 备注
      
      - 标记为未完成的项目需要在 `/speckit.clarify` 或 `/speckit.plan` 之前更新文档
      ```

   b. **运行验证检查**：根据每个检查项审查文档：
      - 对于每个项目，确定是否通过或失败
      - 记录发现的具体问题（引用相关文档章节）

   c. **处理验证结果**：

      - **如果所有项目通过**：标记检查清单完成并继续下一步

      - **如果项目失败（不包括 [待澄清]）**：
        1. 列出失败项目和具体问题
        2. 更新文档以解决每个问题
        3. 重新运行验证直到所有项目通过（最多3次迭代）
        4. 如果3次迭代后仍然失败，在检查清单备注中记录剩余问题并警告用户

      - **如果 [待澄清] 标记残留**：
        1. 从文档中提取所有 [待澄清: ...] 标记
        2. **限制检查**：如果超过3个标记，只保留3个最关键的（按范围/安全/用户体验影响），其余做出合理推断
        3. 对于每个需要澄清的问题（最多3个），以以下格式向用户展示选项：

           ```markdown
           ## 问题 [N]: [主题]
           
           **上下文**: [引用相关文档章节]
           
           **需要了解的内容**: [待澄清标记中的具体问题]
           
           **建议答案**:
           
           | 选项 | 答案 | 影响 |
           |------|------|------|
           | A    | [第一个建议答案] | [这对功能意味着什么] |
           | B    | [第二个建议答案] | [这对功能意味着什么] |
           | C    | [第三个建议答案] | [这对功能意味着什么] |
           | 自定义 | 提供你自己的答案 | [说明如何提供自定义输入] |
           
           **你的选择**: _[等待用户响应]_
           ```

        4. **关键 - 表格格式**：确保 Markdown 表格格式正确：
           - 使用一致的间距和对齐的管道符
           - 每个单元格内容周围应有空格：`| 内容 |` 而不是 `|内容|`
           - 标题分隔符必须至少有3个破折号：`|--------|`
        5. 按顺序编号问题（Q1、Q2、Q3 - 最多3个）
        6. 在等待响应之前一起展示所有问题
        7. 等待用户回复所有问题的选择（例如，"Q1: A, Q2: 自定义 - [详情], Q3: B"）
        8. 通过用用户选择或提供的答案替换每个 [待澄清] 标记来更新文档
        9. 所有澄清解决后重新运行验证

   d. **更新检查清单**：每次验证迭代后，更新检查清单文件的当前通过/失败状态

8. 报告完成情况，包括文档编号、文档路径、检查清单结果，以及下一阶段的就绪状态（`/speckit.clarify` 或 `/speckit.plan`）。

## 通用指南

### 快速指南

- 聚焦于用户**需要什么**和**为什么**。
- 避免**如何**实现（无技术栈、API、代码结构）。
- 为业务利益相关者编写，而非开发者。
- 不要创建嵌入在文档中的检查清单。那将是单独的命令。

### 章节要求

- **必填章节**：每个功能都必须完成
- **可选章节**：仅在与功能相关时包含
- 当章节不适用时，完全删除它（不要留下"N/A"）

### AI 生成指南

从用户提示创建此文档时：

1. **做出合理推断**：使用上下文、行业标准和常见模式填补空白
2. **记录假设**：在假设章节记录合理的默认值
3. **限制澄清**：最多3个 [待澄清] 标记 - 仅用于以下关键决策：
   - 显著影响功能范围或用户体验
   - 存在多种合理解释且含义不同
   - 缺乏任何合理的默认值
4. **优先级排序**：范围 > 安全/隐私 > 用户体验 > 技术细节
5. **像测试人员一样思考**：每个模糊的需求都应该无法通过"可测试且无歧义"的检查项
6. **常见需要澄清的领域**（仅在不存在合理默认值时）：
   - 功能范围和边界（包含/排除特定用例）
   - 用户类型和权限（如果存在多种冲突的解释）
   - 安全/合规要求（当法律/财务上重要时）

**合理默认值示例**（不要询问这些）：

- 数据保留：该领域的行业标准实践
- 性能目标：标准 Web/移动应用期望，除非另有说明
- 错误处理：用户友好的消息和适当的回退
- 认证方法：Web 应用的标准会话或 OAuth2
- 集成模式：RESTful API，除非另有说明

### 成功标准指南

成功标准必须：

1. **可衡量**：包含具体指标（时间、百分比、数量、比率）
2. **技术无关**：不提及框架、语言、数据库或工具
3. **用户聚焦**：从用户/业务角度描述结果，而非系统内部
4. **可验证**：可以在不知道实现细节的情况下测试/验证

**好的示例**：

- "用户可以在3分钟内完成结账"
- "系统支持10,000个并发用户"
- "95%的搜索在1秒内返回结果"
- "任务完成率提高40%"

**不好的示例**（聚焦实现）：

- "API响应时间低于200ms"（太技术化，使用"用户立即看到结果"）
- "数据库可以处理1000 TPS"（实现细节，使用面向用户的指标）
- "React组件高效渲染"（框架特定）
- "Redis缓存命中率高于80%"（技术特定）

## 文档信息

**存放路径**: `文档/开发文档/PRD/PRD-xxxxx-功能名称.md`

**相关文档**:
- 功能文档: `文档/开发文档/FD/FD-xxxxx-功能名称.md`
- 技术设计: `文档/开发文档/TDD/TDD-xxxxx-功能名称.md`
- 测试计划: `文档/开发文档/TP/TP-xxxxx-功能名称.md`
