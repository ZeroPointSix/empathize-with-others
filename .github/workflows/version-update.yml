# ç‰ˆæœ¬å·å’Œå›¾æ ‡è‡ªåŠ¨æ›´æ–°å·¥ä½œæµ
# 
# è§¦å‘æ¡ä»¶:
# - pushåˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨æ‰§è¡Œ
# - æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒé€‰æ‹©å‘å¸ƒé˜¶æ®µï¼‰
#
# @see TDD-00024 å›¾æ ‡å’Œç‰ˆæœ¬å·è‡ªåŠ¨æ›´æ–°æŠ€æœ¯è®¾è®¡

name: Version Update

on:
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/version-update.yml'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      stage:
        description: 'å‘å¸ƒé˜¶æ®µ'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - beta
          - production
      dry_run:
        description: 'é¢„è§ˆæ¨¡å¼ï¼ˆä¸å®é™…æ‰§è¡Œæ›´æ–°ï¼‰'
        required: false
        default: false
        type: boolean
      force:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥æœªæäº¤çš„æ›´æ”¹ï¼‰'
        required: false
        default: false
        type: boolean

env:
  JAVA_VERSION: '17'
  GRADLE_VERSION: '8.13'

jobs:
  version-update:
    name: æ›´æ–°ç‰ˆæœ¬å·å’Œå›¾æ ‡
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºåˆ†ææäº¤
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½®JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: é…ç½®Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: æˆäºˆGradleæ‰§è¡Œæƒé™
        run: chmod +x ./gradlew
      
      - name: åˆ†æGitæäº¤
        id: analyze
        run: |
          echo "ğŸ“Š åˆ†æGitæäº¤..."
          ./gradlew analyzeCommits --no-daemon
      
      - name: ç¡®å®šå‘å¸ƒé˜¶æ®µ
        id: stage
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            STAGE="${{ github.event.inputs.stage }}"
          else
            # è‡ªåŠ¨æ¨é€æ—¶ï¼Œæ ¹æ®åˆ†æ”¯ç¡®å®šé˜¶æ®µ
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              STAGE="dev"
            else
              STAGE="dev"
            fi
          fi
          echo "stage=$STAGE" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ å‘å¸ƒé˜¶æ®µ: $STAGE"
      
      - name: æ„å»ºå‚æ•°
        id: params
        run: |
          PARAMS="--stage=${{ steps.stage.outputs.stage }}"
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            PARAMS="$PARAMS --dry-run"
          fi
          
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            PARAMS="$PARAMS --force"
          fi
          
          echo "params=$PARAMS" >> $GITHUB_OUTPUT
          echo "ğŸ”§ æ„å»ºå‚æ•°: $PARAMS"
      
      - name: æ›´æ–°ç‰ˆæœ¬å·å’Œå›¾æ ‡
        run: |
          echo "ğŸš€ å¼€å§‹æ›´æ–°ç‰ˆæœ¬å·å’Œå›¾æ ‡..."
          ./gradlew updateVersionAndIcon ${{ steps.params.outputs.params }} --no-daemon
      
      - name: æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬
        run: |
          echo "ğŸ“‹ å½“å‰ç‰ˆæœ¬ä¿¡æ¯:"
          ./gradlew showCurrentVersion --no-daemon
      
      - name: æäº¤æ›´æ”¹
        if: github.event.inputs.dry_run != 'true'
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet && git diff --staged --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
            exit 0
          fi
          
          # è·å–æ–°ç‰ˆæœ¬å·
          VERSION=$(grep "APP_VERSION_NAME=" gradle.properties | cut -d'=' -f2)
          
          # æäº¤æ›´æ”¹
          git add -A
          git commit -m "chore: æ›´æ–°ç‰ˆæœ¬å·åˆ° $VERSION [skip ci]"
          
          echo "âœ… å·²æäº¤ç‰ˆæœ¬æ›´æ–°: $VERSION"
      
      - name: æ¨é€æ›´æ”¹
        if: github.event.inputs.dry_run != 'true'
        run: |
          git push origin ${{ github.ref_name }}
          echo "âœ… å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“"
      
      - name: åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
        if: github.event.inputs.dry_run != 'true' && steps.stage.outputs.stage == 'production'
        run: |
          VERSION=$(grep "APP_VERSION_NAME=" gradle.properties | cut -d'=' -f2)
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
          echo "ğŸ·ï¸ å·²åˆ›å»ºæ ‡ç­¾: v$VERSION"

  # æ„å»ºéªŒè¯ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
  build-verify:
    name: æ„å»ºéªŒè¯
    needs: version-update
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
      
      - name: è®¾ç½®JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: æˆäºˆGradleæ‰§è¡Œæƒé™
        run: chmod +x ./gradlew
      
      - name: æ„å»ºDebug APK
        run: |
          echo "ğŸ”¨ æ„å»ºDebug APK..."
          ./gradlew assembleDebug --no-daemon
      
      - name: éªŒè¯ç‰ˆæœ¬å·
        run: |
          echo "âœ… éªŒè¯APKç‰ˆæœ¬å·..."
          # ä½¿ç”¨aaptæˆ–apkanalyzeréªŒè¯ç‰ˆæœ¬å·
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          if [ -f "$APK_PATH" ]; then
            echo "APKæ„å»ºæˆåŠŸ: $APK_PATH"
          else
            echo "âŒ APKæ„å»ºå¤±è´¥"
            exit 1
          fi
      
      - name: ä¸Šä¼ APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7
