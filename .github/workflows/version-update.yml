# ÁâàÊú¨Âè∑ÂíåÂõæÊ†áËá™Âä®Êõ¥Êñ∞Â∑•‰ΩúÊµÅ
# 
# Ëß¶ÂèëÊù°‰ª∂:
# - pushÂà∞mainÂàÜÊîØÊó∂Ëá™Âä®ÊâßË°å
# - ÊâãÂä®Ëß¶ÂèëÔºàÊîØÊåÅÈÄâÊã©ÂèëÂ∏ÉÈò∂ÊÆµÔºâ
#
# @see TDD-00024 ÂõæÊ†áÂíåÁâàÊú¨Âè∑Ëá™Âä®Êõ¥Êñ∞ÊäÄÊúØËÆæËÆ°

name: Version Update

on:
  # Êé®ÈÄÅÂà∞mainÂàÜÊîØÊó∂Ëß¶Âèë
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/version-update.yml'
  
  # ÊâãÂä®Ëß¶Âèë
  workflow_dispatch:
    inputs:
      stage:
        description: 'ÂèëÂ∏ÉÈò∂ÊÆµ'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - beta
          - production
      dry_run:
        description: 'È¢ÑËßàÊ®°ÂºèÔºà‰∏çÂÆûÈôÖÊâßË°åÊõ¥Êñ∞Ôºâ'
        required: false
        default: false
        type: boolean
      force:
        description: 'Âº∫Âà∂Êõ¥Êñ∞ÔºàÂøΩÁï•Êú™Êèê‰∫§ÁöÑÊõ¥ÊîπÔºâ'
        required: false
        default: false
        type: boolean

concurrency:
  group: version-update-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '17'
  GRADLE_VERSION: '8.13'

jobs:
  version-update:
    name: Êõ¥Êñ∞ÁâàÊú¨Âè∑ÂíåÂõæÊ†á
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤ÔºåÁî®‰∫éÂàÜÊûêÊèê‰∫§
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ËÆæÁΩÆJDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: ÈÖçÁΩÆGit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Êéà‰∫àGradleÊâßË°åÊùÉÈôê
        run: chmod +x ./gradlew

      - name: Ê≥®ÂÖ•Á≠æÂêçÂèÇÊï∞ÔºàÈÅøÂÖçËß£ÊûêÈò∂ÊÆµÊä•ÈîôÔºâ
        run: |
          if [ -n "${{ secrets.RELEASE_KEY_ALIAS }}" ]; then
            {
              echo "RELEASE_STORE_FILE=empathy-release-key.jks"
              echo "RELEASE_KEY_ALIAS=${{ secrets.RELEASE_KEY_ALIAS }}"
              echo "RELEASE_KEY_PASSWORD=${{ secrets.RELEASE_KEY_PASSWORD }}"
              echo "RELEASE_STORE_PASSWORD=${{ secrets.RELEASE_STORE_PASSWORD }}"
            } >> gradle.properties
          fi

      - name: ÂàÜÊûêGitÊèê‰∫§
        id: analyze
        run: |
          echo "üìä ÂàÜÊûêGitÊèê‰∫§..."
          ./gradlew analyzeCommits --no-daemon
      
      - name: Á°ÆÂÆöÂèëÂ∏ÉÈò∂ÊÆµ
        id: stage
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            STAGE="${{ github.event.inputs.stage }}"
          else
            # Ëá™Âä®Êé®ÈÄÅÊó∂ÔºåÊ†πÊçÆÂàÜÊîØÁ°ÆÂÆöÈò∂ÊÆµ
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              STAGE="dev"
            else
              STAGE="dev"
            fi
          fi
          echo "stage=$STAGE" >> $GITHUB_OUTPUT
          echo "üì¶ ÂèëÂ∏ÉÈò∂ÊÆµ: $STAGE"
      
      - name: ÊûÑÂª∫ÂèÇÊï∞
        id: params
        run: |
          PARAMS="--stage=${{ steps.stage.outputs.stage }}"
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            PARAMS="$PARAMS --dry-run"
          fi
          
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            PARAMS="$PARAMS --force"
          fi
          
          echo "params=$PARAMS" >> $GITHUB_OUTPUT
          echo "üîß ÊûÑÂª∫ÂèÇÊï∞: $PARAMS"
      
      - name: Êõ¥Êñ∞ÁâàÊú¨Âè∑ÂíåÂõæÊ†á
        run: |
          echo "üöÄ ÂºÄÂßãÊõ¥Êñ∞ÁâàÊú¨Âè∑ÂíåÂõæÊ†á..."
          ./gradlew updateVersionAndIcon ${{ steps.params.outputs.params }} --no-daemon
      
      - name: ÊòæÁ§∫ÂΩìÂâçÁâàÊú¨
        run: |
          echo "üìã ÂΩìÂâçÁâàÊú¨‰ø°ÊÅØ:"
          ./gradlew showCurrentVersion --no-daemon
      
      - name: Êèê‰∫§Êõ¥Êîπ
        if: github.event.inputs.dry_run != 'true'
        run: |
          # Ê£ÄÊü•ÊòØÂê¶ÊúâÊõ¥Êîπ
          if git diff --quiet && git diff --staged --quiet; then
            echo "Ê≤°ÊúâÈúÄË¶ÅÊèê‰∫§ÁöÑÊõ¥Êîπ"
            exit 0
          fi
          
          # Ëé∑ÂèñÊñ∞ÁâàÊú¨Âè∑
          VERSION=$(grep "APP_VERSION_NAME=" gradle.properties | cut -d'=' -f2)
          
          # Êèê‰∫§Êõ¥Êîπ
          git add -A
          git commit -m "chore: Êõ¥Êñ∞ÁâàÊú¨Âè∑Âà∞ $VERSION [skip ci]"
          
          echo "‚úÖ Â∑≤Êèê‰∫§ÁâàÊú¨Êõ¥Êñ∞: $VERSION"
      
      - name: Êé®ÈÄÅÊõ¥Êîπ
        if: github.event.inputs.dry_run != 'true'
        run: |
          git pull --rebase origin ${{ github.ref_name }}
          git push origin ${{ github.ref_name }}
          echo "‚úÖ Â∑≤Êé®ÈÄÅÂà∞ËøúÁ®ã‰ªìÂ∫ì"
      
      - name: ÂàõÂª∫ÁâàÊú¨Ê†áÁ≠æ
        if: github.event.inputs.dry_run != 'true' && steps.stage.outputs.stage == 'production'
        run: |
          VERSION=$(grep "APP_VERSION_NAME=" gradle.properties | cut -d'=' -f2)
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "üè∑Ô∏è Ê†áÁ≠æÂ∑≤Â≠òÂú®: v$VERSION"
            exit 0
          fi
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
          echo "üè∑Ô∏è Â∑≤ÂàõÂª∫Ê†áÁ≠æ: v$VERSION"

  # ÊûÑÂª∫È™åËØÅ‰ªªÂä°ÔºàÂèØÈÄâÔºâ
  build-verify:
    name: ÊûÑÂª∫È™åËØÅ
    needs: version-update
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'
    
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
      
      - name: ËÆæÁΩÆJDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Êéà‰∫àGradleÊâßË°åÊùÉÈôê
        run: chmod +x ./gradlew
      
      - name: ÊûÑÂª∫Debug APK
        run: |
          echo "üî® ÊûÑÂª∫Debug APK..."
          ./gradlew assembleDebug --no-daemon
      
      - name: È™åËØÅÁâàÊú¨Âè∑
        run: |
          echo "‚úÖ È™åËØÅAPKÁâàÊú¨Âè∑..."
          # ‰ΩøÁî®aaptÊàñapkanalyzerÈ™åËØÅÁâàÊú¨Âè∑
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          if [ -f "$APK_PATH" ]; then
            echo "APKÊûÑÂª∫ÊàêÂäü: $APK_PATH"
          else
            echo "‚ùå APKÊûÑÂª∫Â§±Ë¥•"
            exit 1
          fi
      
      - name: ‰∏ä‰º†APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

  # ‰∫ëÁ´ØÁºñËØëÂπ∂Ëá™Âä®ÂèëÂ∏É ReleaseÔºà‰ΩøÁî®Êèê‰∫§‰ø°ÊÅØ‰Ωú‰∏∫ÂèëÂ∏ÉËØ¥ÊòéÔºâ
  release:
    name: Release ÂèëÂ∏É
    needs: version-update
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'

    permissions:
      contents: write

    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: ËÆæÁΩÆJDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: ÂáÜÂ§áÁ≠æÂêçÈÖçÁΩÆ
        run: |
          RAW_KEYSTORE="${{ secrets.RELEASE_STORE_FILE_BASE64 }}"
          RAW_KEYSTORE_CLEAN=$(printf "%s" "$RAW_KEYSTORE" | tr -d '\n\r ')
          if [ -z "$RAW_KEYSTORE_CLEAN" ]; then
            echo "Áº∫Â∞ë RELEASE_STORE_FILE_BASE64ÔºåÊó†Ê≥ïÊûÑÂª∫ Release APK"
            exit 1
          fi

          printf "%s" "$RAW_KEYSTORE_CLEAN" | base64 --decode > empathy-release-key.jks

          {
            echo "RELEASE_STORE_FILE=empathy-release-key.jks"
            echo "RELEASE_KEY_ALIAS=${{ secrets.RELEASE_KEY_ALIAS }}"
            echo "RELEASE_KEY_PASSWORD=${{ secrets.RELEASE_KEY_PASSWORD }}"
            echo "RELEASE_STORE_PASSWORD=${{ secrets.RELEASE_STORE_PASSWORD }}"
          } >> gradle.properties

      - name: Êéà‰∫àGradleÊâßË°åÊùÉÈôê
        run: chmod +x ./gradlew

      - name: ÊûÑÂª∫Release APK
        run: |
          echo "üî® ÊûÑÂª∫Release APK..."
          ./gradlew assembleRelease --no-daemon

      - name: Ëé∑ÂèñÁâàÊú¨Âè∑‰∏éÂèëÂ∏ÉËØ¥Êòé
        id: release_meta
        run: |
          VERSION=$(grep "APP_VERSION_NAME=" gradle.properties | cut -d'=' -f2)
          NOTES=$(git log -1 --pretty=%B)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ÂèëÂ∏ÉGitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.release_meta.outputs.version }}
          name: v${{ steps.release_meta.outputs.version }}
          body: ${{ steps.release_meta.outputs.notes }}
          artifacts: app/build/outputs/apk/release/app-release.apk
          allowUpdates: true
