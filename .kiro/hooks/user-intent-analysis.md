---
event: onUserInput
description: 接收用户指令时自动分析意图并检查工作状态
---

# 用户意图分析 Hook

每当接收到用户指令时，自动执行以下操作：

## 🔒 安全机制

### 1. 输入验证
- 限制输入长度不超过 10,000 字符
- 过滤潜在的恶意代码注入
- 检测敏感信息泄露风险

### 2. 权限控制
- 只能读取指定的配置文件
- 禁止执行系统命令
- 限制文件访问范围

## 触发条件
- 任何用户输入指令
- 不包括系统内部命令

## 执行流程

### 1. 强制读取关键文件 📋
在分析用户意图之前，必须先读取：
- `Rules/RulesReadMe.md` - 项目通用规则和文档规范
- `WORKSPACE.md` - 当前工作状态和任务协调

### 2. 意图分析 🧠

#### 2.1 基础意图分类
- **开发任务**: 编码、调试、测试、构建
- **文档任务**: 编写、审查、更新文档
- **设计任务**: 架构设计、功能设计、UI设计
- **审查任务**: 代码审查、安全审查、文档审查
- **管理任务**: 项目管理、任务分配、状态更新

#### 2.2 复杂度评估
- **简单**: 单一明确任务，可直接执行
- **中等**: 需要多步骤，但范围明确
- **复杂**: 涉及多个领域，需要协调

#### 2.3 代理分配建议
根据意图和复杂度，推荐最适合的AI代理：
- **Kiro**: 代码实现、调试、测试
- **Roo**: 代码审查、质量检查
- **Claude**: 功能设计、文档编写
- **产品经理**: 需求分析、任务规划
- **安全审查员**: 安全检查、风险评估

### 3. 工作状态检查 📊

#### 3.1 冲突检测
检查当前是否有冲突的任务：
- 同一文件正在被其他AI编辑
- 相关功能正在开发中
- 资源被锁定

#### 3.2 依赖检查
检查任务依赖：
- 是否有前置任务未完成
- 是否需要等待其他AI的工作
- 是否有技术债务影响

### 4. 执行建议 🎯

#### 4.1 立即执行
如果满足以下条件，建议立即执行：
- 无冲突
- 依赖已满足
- 资源可用
- 符合当前优先级

#### 4.2 延迟执行
如果存在以下情况，建议延迟：
- 有冲突需要解决
- 依赖未满足
- 资源被占用
- 优先级较低

#### 4.3 分解执行
对于复杂任务，建议：
- 分解为多个子任务
- 分配给不同的AI代理
- 设置执行顺序
- 建立检查点

## 输出格式

```
🔍 用户意图分析结果
========================================

📝 用户指令: [原始指令]

🧠 意图分析:
   - 主要意图: [开发/文档/设计/审查/管理]
   - 复杂度: [简单/中等/复杂]
   - 预计工作量: [X小时/X天]

🤖 推荐代理: [Kiro/Roo/Claude/产品经理/安全审查员]

📋 工作状态检查:
   - 冲突检测: [✅ 无冲突 / ⚠️ 存在冲突]
   - 依赖检查: [✅ 已满足 / ⚠️ 未满足]
   - 资源状态: [✅ 可用 / ⚠️ 占用]

💡 执行建议: [立即执行/延迟执行/分解执行]

🔒 安全检查: [✅ 通过 / ⚠️ 需要注意]
```

## 安全注意事项

### 1. 敏感信息保护
- 不记录用户输入的敏感内容
- 不将用户输入传输到外部系统
- 本地处理，数据不出项目范围

### 2. 恶意输入防护
- 检测并阻止代码注入尝试
- 过滤系统命令调用
- 限制文件路径访问

### 3. 资源保护
- 限制分析时间，防止无限循环
- 控制内存使用，防止资源耗尽
- 设置并发限制，防止系统过载

## 配置选项

```yaml
# 可在 .kiro/settings/hooks.yaml 中配置
user-intent-analysis:
  enabled: true
  force-read-rules: true     # 强制读取规则文件
  max-input-length: 10000    # 最大输入长度
  security-check: true       # 启用安全检查
  conflict-detection: true   # 启用冲突检测
  dependency-check: true     # 启用依赖检查
  auto-assign-agent: false   # 自动分配代理（需要确认）
```

## 异常处理

### 1. 文件读取失败
如果无法读取关键文件：
- 记录错误日志
- 使用缓存版本（如果可用）
- 提示用户手动检查

### 2. 意图分析失败
如果无法分析用户意图：
- 使用默认分类（开发任务）
- 提示用户明确需求
- 记录失败案例用于改进

### 3. 安全检查失败
如果发现安全问题：
- 立即停止处理
- 记录安全事件
- 提示用户风险

## 测试用例

### 1. 正常流程测试
- 简单开发指令分析
- 复杂设计指令分析
- 文档编写指令分析

### 2. 异常流程测试
- 超长输入处理
- 恶意输入过滤
- 文件读取失败处理

### 3. 安全测试
- 代码注入尝试
- 路径遍历攻击
- 资源耗尽攻击

## 更新日志

### v1.0.0 (2025-12-22)
- 初始版本
- 基础意图分析功能
- 安全机制实现
- 工作状态检查