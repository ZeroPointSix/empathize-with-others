# 需求文档（MVP 版本）

## 简介

本文档定义了共情 AI 助手的 Android 系统服务层需求（MVP 版本）。**本版本专注于核心功能验证，采用简化的实现方案以确保 2025-12-15 按时交付。**

MVP 版本的核心策略：
- ✅ 仅支持悬浮窗服务（不实现无障碍服务）
- ✅ 用户手动复制粘贴聊天内容（不自动抓取）
- ✅ 专注于微信兼容性（后续扩展其他应用）
- ✅ 简化错误处理和性能优化

**后续版本计划**：v2.0 将引入无障碍服务实现自动屏幕抓取，支持更多聊天应用。

## 术语表

- **FloatingWindowService（悬浮窗服务）**：Android 系统服务，用于在其他应用之上显示悬浮窗口
- **悬浮按钮（Floating Button）**：显示在屏幕上的可拖动按钮，用于触发功能
- **聊天上下文（Chat Context）**：用户手动输入或粘贴的聊天消息内容
- **系统权限（System Permission）**：用户授予应用的特殊权限（悬浮窗权限）
- **前台服务（Foreground Service）**：Android 前台服务，显示持久通知以保持服务运行

## 需求

### 需求 1：悬浮窗服务基础功能

**用户故事**：作为用户，我希望在使用微信时能看到悬浮按钮，以便快速访问 AI 助手功能。

#### 验收标准

1. WHEN 用户启动悬浮窗服务 THEN 系统 SHALL 在屏幕上显示一个可见的悬浮按钮
2. WHEN 悬浮按钮显示在屏幕上 THEN 系统 SHALL 允许用户通过拖动手势移动按钮位置
3. WHEN 用户拖动悬浮按钮到屏幕边缘 THEN 系统 SHALL 自动吸附到最近的边缘位置
4. WHEN 悬浮窗服务运行时 THEN 系统 SHALL 在通知栏显示前台服务通知
5. WHEN 用户停止悬浮窗服务 THEN 系统 SHALL 移除悬浮按钮并清理所有资源

### 需求 2：悬浮窗交互功能

**用户故事**：作为用户，我希望通过悬浮按钮快速触发 AI 分析和安全检查功能，并手动输入聊天内容。

#### 验收标准

1. WHEN 用户点击悬浮按钮 THEN 系统 SHALL 展开功能菜单显示可用操作
2. WHEN 功能菜单展开时 THEN 系统 SHALL 显示"帮我分析"和"帮我检查"两个选项
3. WHEN 用户点击"帮我分析"按钮 THEN 系统 SHALL 打开文本输入对话框供用户粘贴聊天内容
4. WHEN 用户点击"帮我检查"按钮 THEN 系统 SHALL 打开文本输入对话框供用户粘贴草稿内容
5. WHEN 用户点击菜单外部区域 THEN 系统 SHALL 收起功能菜单

### 需求 3：文本内容输入功能

**用户故事**：作为用户，我希望能够方便地输入或粘贴聊天内容，以便 AI 进行分析。

#### 验收标准

1. WHEN 用户触发分析或检查功能 THEN 系统 SHALL 显示文本输入对话框
2. WHEN 文本输入对话框显示时 THEN 系统 SHALL 提供多行文本输入框支持长文本
3. WHEN 用户粘贴文本内容时 THEN 系统 SHALL 自动填充到输入框中
4. WHEN 用户输入文本超过 5000 字符时 THEN 系统 SHALL 显示字符数限制提示
5. WHEN 用户确认输入内容时 THEN 系统 SHALL 将文本传递给对应的 UseCase 进行处理

### 需求 4：服务生命周期管理

**用户故事**：作为用户，我希望能够方便地启动和停止悬浮窗服务，以便控制应用的运行状态。

#### 验收标准

1. WHEN 用户在设置界面启用悬浮窗功能 THEN 系统 SHALL 检查悬浮窗权限并引导用户授权
2. WHEN 用户授予悬浮窗权限后 THEN 系统 SHALL 自动启动悬浮窗服务
3. WHEN 系统服务启动失败时 THEN 系统 SHALL 显示错误提示
4. WHEN 用户禁用悬浮窗功能时 THEN 系统 SHALL 停止服务并释放所有资源
5. WHEN 应用被系统杀死后重启时 THEN 系统 SHALL 根据用户上次的设置状态决定是否启动服务

### 需求 5：权限管理与安全

**用户故事**：作为用户，我希望应用能够安全地使用系统权限，并清楚地告知我权限的用途。

#### 验收标准

1. WHEN 应用请求悬浮窗权限时 THEN 系统 SHALL 显示权限说明对话框解释用途
2. WHEN 用户拒绝授予权限时 THEN 系统 SHALL 禁用悬浮窗功能并显示友好提示
3. WHEN 系统检测到权限被撤销时 THEN 系统 SHALL 停止悬浮窗服务
4. WHEN 用户输入聊天内容时 THEN 系统 SHALL 仅在本地处理数据并通过 PrivacyEngine 脱敏后才发送给 AI
5. WHEN 用户关闭应用时 THEN 系统 SHALL 不保存用户输入的聊天内容

### 需求 6：性能与资源优化

**用户故事**：作为用户，我希望悬浮窗服务不会显著影响设备性能。

#### 验收标准

1. WHEN 悬浮窗服务运行时 THEN 系统 SHALL 保持内存占用低于 150MB
2. WHEN 用户触发 AI 分析时 THEN 系统 SHALL 在 10 秒内返回结果或超时提示
3. WHEN 悬浮按钮被拖动时 THEN 系统 SHALL 保持 UI 响应流畅（60 FPS）
4. WHEN 系统执行耗时操作时 THEN 系统 SHALL 在后台线程执行避免阻塞 UI
5. WHEN 服务停止时 THEN 系统 SHALL 在 1 秒内完成资源清理

### 需求 7：错误处理

**用户故事**：作为用户，我希望系统能够清晰地提示错误信息，帮助我解决问题。

#### 验收标准

1. WHEN 悬浮窗服务启动失败时 THEN 系统 SHALL 显示错误提示说明失败原因
2. WHEN AI 分析请求失败时 THEN 系统 SHALL 显示错误信息并提示用户重试
3. WHEN 用户输入内容为空时 THEN 系统 SHALL 显示提示要求用户输入内容
4. WHEN 网络请求超时时 THEN 系统 SHALL 显示超时提示并允许用户重试
5. WHEN 系统权限被撤销时 THEN 系统 SHALL 停止服务并显示权限请求引导

### 需求 8：微信兼容性

**用户故事**：作为用户，我希望悬浮窗能够在微信中正常显示和使用。

#### 验收标准

1. WHEN 用户在微信聊天界面时 THEN 系统 SHALL 正常显示悬浮按钮
2. WHEN 用户在微信中点击悬浮按钮时 THEN 系统 SHALL 正常展开功能菜单
3. WHEN 用户从微信复制聊天内容后 THEN 系统 SHALL 允许用户粘贴到输入框
4. WHEN 微信切换到后台时 THEN 系统 SHALL 保持悬浮按钮显示
5. WHEN 微信版本更新时 THEN 系统 SHALL 保持基本功能可用

### 需求 9：用户体验

**用户故事**：作为用户，我希望悬浮窗的交互简单直观，不会干扰我的正常使用。

#### 验收标准

1. WHEN 悬浮按钮显示时 THEN 系统 SHALL 使用清晰可见的图标和颜色
2. WHEN 系统执行 AI 分析时 THEN 系统 SHALL 显示加载进度指示器
3. WHEN 操作完成时 THEN 系统 SHALL 显示简短的提示消息
4. WHEN 用户点击悬浮按钮时 THEN 系统 SHALL 在 300 毫秒内响应并展开菜单
5. WHEN 文本输入对话框显示时 THEN 系统 SHALL 自动聚焦输入框并显示软键盘

### 需求 10：联系人关联

**用户故事**：作为用户，我希望能够选择当前聊天的联系人，以便 AI 使用正确的画像信息。

#### 验收标准

1. WHEN 用户触发分析功能时 THEN 系统 SHALL 显示联系人选择器
2. WHEN 联系人选择器显示时 THEN 系统 SHALL 列出所有已创建的联系人
3. WHEN 用户选择联系人后 THEN 系统 SHALL 将联系人 ID 传递给 AnalyzeChatUseCase
4. WHEN 用户未选择联系人时 THEN 系统 SHALL 提示用户必须选择联系人
5. WHEN 用户没有创建任何联系人时 THEN 系统 SHALL 提示用户先创建联系人画像
