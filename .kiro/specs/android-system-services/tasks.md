# 实施计划

## 任务清单

- [x] 1. 设置项目基础设施





  - 添加悬浮窗权限到 AndroidManifest.xml
  - 配置 Hilt 依赖注入模块
  - 创建基础数据模型类
  - _需求：1.4, 4.1, 5.1_

- [x] 2. 实现 FloatingWindowService 核心功能





  - 创建 FloatingWindowService 类并配置前台服务
  - 实现服务生命周期管理（onCreate, onStartCommand, onDestroy）
  - 添加前台服务通知
  - 实现 WindowManager 视图管理
  - _需求：1.1, 1.4, 1.5_

- [x] 2.1 编写 FloatingWindowService 单元测试


  - 测试服务启动和停止
  - 测试视图添加和移除
  - 测试资源清理
  - **属性 1：服务生命周期一致性**
  - **验证需求：1.1, 1.5**

- [x] 3. 实现 FloatingView 统一悬浮视图





  - 创建 FloatingView 类和布局文件
  - 实现悬浮按钮模式（显示、拖动、点击）
  - 实现触摸事件处理和边缘吸附
  - 实现菜单展开模式
  - 实现输入对话框模式
  - _需求：1.2, 1.3, 2.1, 2.2, 2.5_

- [x] 3.1 编写 FloatingView 单元测试


  - 测试拖动位置更新
  - 测试边缘吸附行为
  - 测试点击展开菜单
  - **属性 2：拖动位置更新**
  - **属性 3：点击展开菜单**
  - **验证需求：1.2, 1.3, 2.1**

- [x] 4. 实现输入对话框功能





  - 创建输入对话框布局
  - 实现联系人选择器（Spinner）
  - 实现多行文本输入框
  - 实现输入验证（字符数限制、必填项检查）
  - 添加确认和取消按钮
  - _需求：3.1, 3.2, 3.3, 3.4, 10.1, 10.2, 10.4, 10.5_

- [x] 4.1 编写输入对话框单元测试


  - 测试联系人列表加载
  - 测试输入验证逻辑
  - 测试字符数限制
  - **属性 4：功能触发对话框**
  - **验证需求：3.4, 10.2, 10.4**

- [x] 5. 集成 UseCase 和数据流





  - 在 FloatingWindowService 中注入 AnalyzeChatUseCase
  - 在 FloatingWindowService 中注入 CheckDraftUseCase
  - 在 FloatingWindowService 中注入 ContactRepository
  - 实现 handleAnalyze 方法（加载联系人、显示对话框、调用 UseCase）
  - 实现 handleCheck 方法
  - 添加加载状态和错误处理
  - _需求：2.3, 2.4, 3.5, 10.3_

- [x] 5.1 编写数据流集成测试


  - 测试完整的分析流程
  - 测试 UseCase 调用和数据传递
  - 测试隐私保护流程
  - **属性 6：数据传递和隐私保护**
  - **验证需求：3.5, 5.4, 10.3**

- [x] 6. 实现权限管理





  - 创建 FloatingWindowManager 工具类
  - 实现权限检查方法
  - 实现权限请求方法
  - 实现服务启动和停止方法
  - 在 SettingsScreen 中集成权限管理
  - _需求：4.1, 4.2, 5.1, 5.2, 5.3_

- [x] 6.1 编写权限管理单元测试


  - 测试权限检查逻辑
  - 测试权限请求流程
  - 测试服务启动和停止
  - **属性 5：权限检查流程**
  - **验证需求：4.1, 4.2**

- [x] 7. 实现状态持久化





  - 创建 FloatingWindowPreferences 类
  - 实现状态保存方法
  - 实现状态加载方法
  - 在服务启动时恢复上次的按钮位置
  - 在应用重启时根据状态决定是否启动服务
  - _需求：4.5_

- [x] 8. 实现错误处理




  - 创建 FloatingWindowError 密封类
  - 实现错误处理函数
  - 添加 Toast 提示
  - 添加权限请求对话框
  - 实现超时处理
  - _需求：7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 9. 性能优化





  - 实现内存监控
  - 优化视图复用
  - 添加硬件加速
  - 实现超时控制
  - 确保后台线程执行耗时操作
  - _需求：6.1, 6.2, 6.4, 6.5_

- [x] 10. UI 和用户体验优化





  - 设计悬浮按钮图标和样式
  - 添加加载进度指示器
  - 实现操作完成提示
  - 优化点击响应时间
  - 实现输入框自动聚焦
  - _需求：9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 11. 微信兼容性测试和优化




  - 在微信中测试悬浮按钮显示
  - 测试悬浮按钮拖动和点击
  - 测试从微信复制粘贴功能
  - 测试微信切换到后台时的行为
  - 测试微信最新 3 个版本
  - 添加微信运行检测（可选）
  - _需求：8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 12. 集成测试





  - 测试完整的分析流程（启动服务 → 点击按钮 → 展开菜单 → 选择功能 → 输入内容 → 调用 UseCase → 显示结果）
  - 测试权限请求流程
  - 测试错误处理流程
  - _需求：所有需求_

- [x] 13. 手动测试和 Bug 修复




  - 执行手动测试清单（微信兼容性、性能、错误处理）
  - 修复发现的 Bug
  - 优化用户体验
  - _需求：所有需求_

- [ ] 14. 文档和代码审查
  - 添加代码注释和 KDoc
  - 更新 README 文档
  - 代码审查和优化
  - 确保符合项目规范
  - _需求：所有需求_

- [ ] 15. 最终验收
  - 确保所有测试通过
  - 确认所有需求已实现
  - 性能指标达标（内存 < 150MB，响应 < 300ms）
  - 准备交付
  - _需求：所有需求_
