# 需求文档 - 悬浮窗最小化功能

## 简介

本功能旨在改善用户在等待 AI 响应时的体验。当前实现中，用户发送请求后必须等待 AI 响应完成才能继续操作，这在网络延迟或 AI 处理时间较长时会严重影响用户体验。通过添加最小化功能，用户可以在等待期间继续使用其他应用，AI 响应完成后通过通知提醒用户查看结果。

## 术语表

- **悬浮窗 (FloatingWindow)**: 应用的主要交互界面，显示在其他应用之上
- **输入对话框 (InputDialog)**: 用户输入内容并发送给 AI 的对话框界面
- **最小化状态 (MinimizedState)**: 对话框收起为小型指示器的状态
- **加载指示器 (LoadingIndicator)**: 显示 AI 正在处理的视觉反馈
- **通知 (Notification)**: 系统通知栏中的消息提醒
- **恢复 (Restore)**: 从最小化状态返回到完整对话框的操作

## 需求

### 需求 1：最小化交互

**用户故事**：作为用户，我希望在等待 AI 响应时可以最小化对话框，以便继续使用其他应用而不被阻塞。

#### 验收标准

1. WHEN 用户在输入对话框中点击最小化按钮 THEN 系统 SHALL 将对话框收起为小型加载指示器
2. WHEN 对话框最小化后 THEN 系统 SHALL 在屏幕边缘显示一个小型圆形加载指示器
3. WHEN 加载指示器显示时 THEN 系统 SHALL 显示旋转动画表示正在处理
4. WHEN 用户点击最小化的加载指示器 THEN 系统 SHALL 恢复完整的对话框
5. WHEN 对话框最小化时 THEN 系统 SHALL 保持 AI 请求继续在后台执行

### 需求 2：后台处理

**用户故事**：作为用户，我希望最小化后 AI 请求能在后台继续执行，这样我不需要一直盯着屏幕等待。

#### 验收标准

1. WHEN 对话框最小化时 THEN 系统 SHALL 继续执行 AI 请求而不中断
2. WHEN AI 请求在后台执行时 THEN 系统 SHALL 维持前台服务状态防止被系统杀死
3. WHEN AI 响应返回时 THEN 系统 SHALL 保存响应结果等待用户查看
4. WHEN 后台处理超时（10秒）时 THEN 系统 SHALL 记录错误并准备向用户显示错误信息
5. WHEN 后台处理失败时 THEN 系统 SHALL 保存错误信息等待用户查看

### 需求 3：完成通知

**用户故事**：作为用户，我希望 AI 响应完成后能收到通知，这样我就知道可以查看结果了。

#### 验收标准

1. WHEN AI 响应成功返回且对话框处于最小化状态 THEN 系统 SHALL 发送系统通知
2. WHEN 通知显示时 THEN 系统 SHALL 包含操作类型（分析/检查）和联系人名称
3. WHEN 用户点击通知 THEN 系统 SHALL 恢复对话框并显示 AI 响应结果
4. WHEN 用户忽略通知 THEN 系统 SHALL 保持加载指示器显示为完成状态（绿色对勾）
5. WHEN AI 请求失败且对话框处于最小化状态 THEN 系统 SHALL 发送错误通知

### 需求 4：状态指示

**用户故事**：作为用户，我希望通过加载指示器的外观就能知道当前的处理状态，而不需要点击查看。

#### 验收标准

1. WHEN AI 请求正在处理时 THEN 系统 SHALL 显示蓝色旋转的加载指示器
2. WHEN AI 响应成功返回时 THEN 系统 SHALL 将指示器变为绿色对勾图标
3. WHEN AI 请求失败时 THEN 系统 SHALL 将指示器变为红色错误图标
4. WHEN 指示器显示完成状态（成功或失败）时 THEN 系统 SHALL 停止旋转动画
5. WHEN 用户点击完成状态的指示器 THEN 系统 SHALL 恢复对话框并显示相应结果或错误

### 需求 5：位置管理

**用户故事**：作为用户，我希望最小化的指示器显示在原悬浮按钮的位置，保持一致的视觉体验。

#### 验收标准

1. WHEN 对话框最小化时 THEN 系统 SHALL 将指示器放置在原悬浮按钮的位置
2. WHEN 用户拖动指示器时 THEN 系统 SHALL 保持指示器跟随手指移动
3. WHEN 用户松手时 THEN 系统 SHALL 保存指示器的新位置
4. WHEN 用户恢复对话框后再次最小化时 THEN 系统 SHALL 在当前指示器位置显示
5. WHEN 用户关闭对话框时 THEN 系统 SHALL 恢复原悬浮按钮在指示器的最后位置



### 需求 6：用户体验优化

**用户故事**：作为用户，我希望最小化和恢复操作流畅自然，有清晰的视觉反馈。

#### 验收标准

1. WHEN 对话框最小化时 THEN 系统 SHALL 使用缩放动画（300ms）过渡到指示器
2. WHEN 对话框恢复时 THEN 系统 SHALL 使用缩放动画（300ms）从指示器展开
3. WHEN 指示器状态改变时 THEN 系统 SHALL 使用淡入淡出动画（200ms）切换图标
4. WHEN 用户拖动指示器时 THEN 系统 SHALL 提供触觉反馈
5. WHEN 动画执行时 THEN 系统 SHALL 保持 60 FPS 的流畅度

### 需求 7：错误处理

**用户故事**：作为用户，我希望即使在最小化状态下遇到错误，也能清楚地了解发生了什么。

#### 验收标准

1. WHEN 后台处理超时时 THEN 系统 SHALL 显示红色错误指示器并发送通知
2. WHEN 网络连接断开时 THEN 系统 SHALL 显示错误状态并提供重试选项
3. WHEN 用户点击错误指示器时 THEN 系统 SHALL 恢复对话框并显示详细错误信息
4. WHEN 错误可恢复时 THEN 系统 SHALL 在错误对话框中提供"重试"按钮
5. WHEN 用户选择重试时 THEN 系统 SHALL 重新发起请求并更新指示器状态

### 需求 8：资源管理

**用户故事**：作为开发者，我希望最小化功能不会导致内存泄漏或资源浪费。

#### 验收标准

1. WHEN 对话框最小化时 THEN 系统 SHALL 释放不必要的 UI 资源
2. WHEN 指示器显示时 THEN 系统 SHALL 使用轻量级视图减少内存占用
3. WHEN 用户最小化新请求时 THEN 系统 SHALL 自动关闭之前的最小化指示器
4. WHEN 指示器显示超过 10 分钟时 THEN 系统 SHALL 自动清理已完成的指示器
5. WHEN 用户离开应用超过 5 分钟时 THEN 系统 SHALL 清理所有已完成的指示器

### 需求 9：持久化

**用户故事**：作为用户，我希望即使应用被系统杀死，我的请求状态也能恢复。

#### 验收标准

1. WHEN 对话框最小化时 THEN 系统 SHALL 保存请求状态到本地存储
2. WHEN 应用重启时 THEN 系统 SHALL 恢复所有未完成的请求指示器
3. WHEN 恢复请求时 THEN 系统 SHALL 显示"正在恢复"状态
4. WHEN 请求无法恢复时 THEN 系统 SHALL 显示错误状态并允许用户重新发起
5. WHEN 请求已完成时 THEN 系统 SHALL 恢复结果数据供用户查看
