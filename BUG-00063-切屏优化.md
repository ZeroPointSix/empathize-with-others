# B 文档：导航回退与白屏闪烁问题排查与修复方案

## 背景
用户反馈在联系人列表进入聊天/详情页时出现自动回退（1 秒内返回列表）、页面白屏反复闪烁、以及转场中短暂闪现设置页等层级混乱问题。

当前架构采用 BottomNavScaffold 缓存三个 Tab 内容，NonTabNavGraph 始终挂载承载非 Tab 页面，并共享同一个 NavController。

## 现象复现描述
1. 从联系人列表进入联系人详情页，1 秒内自动返回列表。
2. 页面切换时出现白屏与内容交替闪烁。
3. 转场中偶发看到设置页或 AI 军师页短暂闪现。

## 现有实现要点
1. MainActivity 使用同一个 NavController：底部 Tab 用 BottomNavScaffold 缓存，非 Tab 页面用 NonTabNavGraph 渲染。
2. BottomNavScaffold 通过 alpha 和 pointerInput 隐藏非当前 Tab，但未卸载页面。
3. AiAdvisorScreen 在组合时会执行导航副作用（LaunchedEffect based on navigationTarget）。
4. SettingsScreen 会在 pendingPermissionRequest 时触发系统设置跳转。

## 可能根因
1. **隐藏 Tab 仍在执行导航副作用**
   - BottomNavScaffold 保留所有 Tab 的 Composition，隐藏 Tab 仍会执行 LaunchedEffect。
   - AiAdvisorScreen 的 `LaunchedEffect(uiState.navigationTarget)` 未受 `isVisible` 约束，隐藏时仍可能触发导航。
   - 导航触发改变 navController back stack，造成用户正在浏览的详情页被打断，表现为自动回退/闪现/白屏。
2. **隐藏 Tab 触发权限跳转**
   - SettingsScreen 在隐藏状态下触发 `pendingPermissionRequest` 也会启动系统设置页面，造成层级混乱或短暂闪屏。

## 修复目标
1. 隐藏 Tab 不触发导航或跨 Activity 跳转副作用。
2. 当前可见页面的导航不受其它 Tab 的状态变化影响。
3. 解决因隐藏 Tab 副作用导致的自动回退和白屏闪烁。

## 方案概述
1. **为缓存 Tab 增加可见性保护**
   - 将 `isVisible` 传入需要触发导航/系统跳转的 Tab 页面。
   - 在 `LaunchedEffect` 中判断 `isVisible` 后再执行导航/权限跳转。
2. **导航副作用统一收敛**
   - 对 `AiAdvisorScreen` 的导航事件进行可见性门控。
   - 对 `SettingsScreen` 的权限跳转进行可见性门控。
3. **状态清理**
   - 当页面从可见切换为不可见时，清理待导航状态，避免下次显示时“补触发”。

## 详细改动点
1. `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorScreen.kt`
   - `LaunchedEffect(uiState.navigationTarget)` 增加 `isVisible` 判断，仅可见时执行导航。
   - 进入不可见时清理 `navigationTarget` 或暂停收敛逻辑。
2. `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsScreen.kt`
   - `LaunchedEffect(uiState.pendingPermissionRequest)` 增加 `isVisible` 判断。
3. `app/src/main/java/com/empathy/ai/ui/MainActivity.kt`
   - 传递 `isVisible` 给 AiAdvisorScreen 与 SettingsScreen。

## 风险评估
1. 如果可见性判断不严格，可能导致在 Tab 首次显示时漏触发导航。
2. 需要确保导航状态在可见时仍能触发，避免“导航丢失”。

## 测试方案
1. **UI 测试**
   - 从联系人列表进入详情页，停留 3 秒，不应被其他页面导航打断。
   - 切换到 AI 军师 Tab，确认仍能根据偏好自动导航。
2. **行为测试**
   - 进入设置页切换悬浮窗权限请求，确认只有在设置页可见时触发系统跳转。
3. **回归测试**
   - Tab 切换无白屏闪烁。
   - 返回行为正常，Back stack 无异常跳转。

## 验收标准
1. 联系人详情页不会自动回退或闪屏。
2. 切换过程无设置页/军师页异常闪现。
3. AI 军师和设置页在可见状态下功能与原行为一致。

## 实施记录
1. AiAdvisorScreen 导航副作用增加可见性门控，不可见时清理 navigationTarget，避免隐藏 Tab 导航干扰。
2. SettingsScreen 权限跳转副作用增加可见性门控，不可见时清理 pendingPermissionRequest。
3. MainActivity 传递 SettingsScreen 的 isVisible，确保只在当前 Tab 触发副作用。

## 构建与安装
1. 本地构建: `./gradlew clean assembleDebug` 成功。
2. APK: `app/build/outputs/apk/debug/app-debug.apk`。
3. 安装到 MuMu: `adb -s 127.0.0.1:7555 install -r app-debug.apk` 成功。
4. 启动应用: `adb -s 127.0.0.1:7555 shell am start -n com.empathy.ai/com.empathy.ai.ui.MainActivity` 成功。
5. 重新构建与安装: `./gradlew assembleDebug` 与 `adb -s 127.0.0.1:7555 install -r app-debug.apk` 成功。

## 排查记录（AI 服务商/AI 市场白屏）
1. MuMu 通过设置页进入 AI 配置页与添加服务商页，未稳定复现白屏。
2. 触发过程 logcat 未捕获崩溃或异常日志。
3. 为定位“添加服务商退出后切 AI 军师白屏”，已加入导航与副作用日志（MainActivity/AiAdvisor/AiConfig）。
4. 构建并安装带日志版本到 MuMu，等待复现采集。
5. 复现日志显示 AiAdvisorScreen 可见但 navigationTarget 为空，导致白屏。
6. 修复：在 AiAdvisorScreen 可见且 ON_RESUME 时强制刷新导航目标。
7. 已编译并安装修复版本到 MuMu，等待回归验证。
