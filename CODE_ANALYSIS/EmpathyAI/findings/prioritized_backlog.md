# 优先级技术债务清单 (Prioritized Backlog)

> 技术债务分析报告 - 综合优先级清单
> 分析日期: 2026-01-03

---

## 评分标准

| 优先级 | 符号 | 含义 | 建议处理时间 |
|-------|------|------|-------------|
| P0 | 🔴 紧急 | 影响核心功能或安全 | 立即处理 |
| P1 | 🟠 高 | 显著影响代码质量 | 1-2周内 |
| P2 | 🟡 中 | 影响可维护性 | 1个月内 |
| P3 | 🟢 低 | 锦上添花 | 后续版本 |

---

## P0 - 紧急 (已处理 ✅)

### 1. 清理归档代码目录 ✅ 已完成

| 项目 | 详情 |
|-----|------|
| ~~问题~~ | ~~`历史文档/archived-advanced-features/` 包含71个未使用的Kotlin文件~~ |
| **当前状态** | **✅ 已于 2026-01-03 删除** |
| 影响 | 已消除 |
| 修复方式 | 已完成 |
| 工作量 | - |
| 风险 | 无风险 |

**清理内容**:
- 11 个功能模块
- 46 个 Kotlin 文件
- 1 个 README.md

**清理命令**:
```bash
rm -rf 历史文档/archived-advanced-features/
```

---

## P1 - 高优先级 (1-2周内处理)

### 2. 拆分 FloatingWindowService 超大类

| 项目 | 详情 |
|-----|------|
| 问题 | `FloatingWindowService.kt` 3,140行，承担过多职责 |
| 影响 | 可维护性差、理解成本高、测试困难 |
| 建议拆分为 | - `FloatingWindowLifecycleManager` - 生命周期管理 |
| | - `FloatingWindowRequestHandler` - 请求处理 |
| | - `FloatingWindowResponseManager` - 响应管理 |
| | - `FloatingWindowCleanupManager` - 清理管理 |
| 工作量 | 中-高（需要仔细设计接口） |
| 风险 | 中等（需全面测试） |

### 3. 拆分 FloatingView 超大类

| 项目 | 详情 |
|-----|------|
| 问题 | `FloatingView.kt` 3,243行，承担悬浮窗所有UI逻辑 |
| 影响 | 与 FloatingWindowService 类似 |
| 建议拆分为 | - `FloatingViewRenderer` - 渲染逻辑 |
| | - `FloatingViewTouchHandler` - 触摸处理 |
| | - `FloatingViewDragManager` - 拖拽管理 |
| 工作量 | 中-高 |
| 风险 | 中等 |

### 4. 实现 AI 军师页面

| 项目 | 详情 |
|-----|------|
| 问题 | `NavGraph.kt:160` 标记为 TODO，核心功能缺失 |
| 影响 | 用户无法使用 AI 军师功能 |
| 建议 | 实现完整的 AI 军师页面 |
| 工作量 | 中 |
| 优先级依据 | TODO 中标记为高优先级 |

---

## P2 - 中优先级 (1个月内处理)

### 5. 统一时间常量命名

| 项目 | 详情 |
|-----|------|
| 问题 | 多处使用魔数表示时间（5秒、10秒、10分钟等） |
| 影响 | 可读性差、修改困难 |
| 修复方式 | 提取到统一的 Constants 文件 |
| 涉及文件 | `FloatingWindowService.kt`, `AiProvider.kt` |
| 工作量 | 低 |

**示例:**
```kotlin
object TimeoutConstants {
    const val REQUEST_EXPIRATION_MS = 10 * 60 * 1000L  // 10分钟
    const val PROCESSING_TIMEOUT_MS = 10 * 1000L      // 10秒
    const val CLEANUP_DELAY_MS = 10 * 60 * 1000L      // 10分钟
    const val DEFAULT_TIMEOUT_MS = 30_000L            // 30秒
}
```

### 6. 完善异常处理

| 项目 | 详情 |
|-----|------|
| 问题 | 部分代码使用过于宽泛的 `catch (Exception e)` |
| 影响 | 可能隐藏真实问题 |
| 修复方式 | 使用具体异常类型，增加日志 |
| 工作量 | 低-中 |

### 7. 优化协程调用结构

| 项目 | 详情 |
|-----|------|
| 问题 | 部分代码存在深层嵌套的协程调用 |
| 影响 | 可读性差、错误处理复杂 |
| 修复方式 | 提取为独立的 suspend 函数 |
| 工作量 | 低-中 |

### 8. 实现模型配置功能

| 项目 | 详情 |
|-----|------|
| 问题 | `EditProviderScreen.kt` 中多个 TODO（Temperature、MaxTokens） |
| 影响 | AI 配置功能不完整 |
| 修复方式 | 实现完整的模型参数配置 |
| 工作量 | 中 |

### 9. 提取硬编码字符串

| 项目 | 详情 |
|-----|------|
| 问题 | 多处硬编码的中文字符串 |
| 影响 | 不支持多语言、维护困难 |
| 修复方式 | 提取到 `strings.xml` |
| 工作量 | 低-中 |

---

## P3 - 低优先级 (后续版本处理)

### 10. 标签搜索功能

| 项目 | 详情 |
|-----|------|
| 问题 | `BrainTagScreen.kt:88` TODO |
| 影响 | 标签管理功能不完整 |
| 工作量 | 中 |

### 11. 图片选择器集成

| 项目 | 详情 |
|-----|------|
| 问题 | `NavGraph.kt:272` TODO |
| 影响 | 辅助功能缺失 |
| 工作量 | 中 |

### 12. 提示词 AI 优化

| 项目 | 详情 |
|-----|------|
| 问题 | `PromptEditorScreen.kt:204` TODO |
| 影响 | 高级功能缺失 |
| 工作量 | 高 |

### 13. 深色模式系统集成

| 项目 | 详情 |
|-----|------|
| 问题 | `ContactDetailTabViewModel.kt:1512` TODO |
| 影响 | UI 优化 |
| 工作量 | 中 |

### 14. ContactProfile 添加 createdAt 字段

| 项目 | 详情 |
|-----|------|
| 问题 | `ContactDetailTabViewModel.kt:239` TODO |
| 影响 | 数据模型改进 |
| 工作量 | 中（涉及数据库迁移） |

---

## 风险评估

### 高风险项

| 项目 | 风险类型 | 缓解措施 |
|-----|---------|---------|
| FloatingWindowService 拆分 | 功能回归 | 全面单元测试、集成测试 |
| FloatingView 拆分 | UI 回归 | 截图对比测试、手动验证 |

### 中风险项

| 项目 | 风险类型 | 缓解措施 |
|-----|---------|---------|
| 归档代码清理 | 无风险 | 删除前确认未被引用 |
| 异常处理改进 | 引入新问题 | 逐步修改、增加日志 |

---

## 资源估算

| 优先级 | 任务数 | 预估工作量 |
|-------|-------|-----------|
| P0 | 1 | 极低 |
| P1 | 4 | 高 |
| P2 | 5 | 中 |
| P3 | 5 | 中-高 |

---

## 建议执行顺序

1. **第1天**: 执行 P0 任务（删除归档代码目录）
2. **第1-2周**: 完成 P1 任务中的 AI 军师页面
3. **第3-4周**: 开始 P1 任务中的类拆分（需要更仔细的设计）
4. **后续**: 按优先级处理 P2、P3 任务

---

## 成功指标

| 指标 | 目标值 | 测量方式 |
|-----|-------|---------|
| 归档代码 | 0个文件 | 文件系统检查 |
| 超大类 (>2000行) | ≤1个 | 代码行数统计 |
| TODO 数量 | ≤5个 | 代码搜索 |
| 魔数数量 | 0个 | 代码检查 |
| 代码覆盖率 | ≥55% | 测试报告 |

---

*报告生成时间: 2026-01-03*
*工具: Claude Code Technical Debt Analysis*
