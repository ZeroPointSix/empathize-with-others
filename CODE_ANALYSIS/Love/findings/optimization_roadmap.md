# 优化路线图

> 共情AI助手 (Empathy AI Assistant)
> 分析日期: 2026-01-03
> 版本: v1.0.0

---

## 概述

本文档提供了共情AI助手项目的全面优化路线图，分为四个阶段实施。优化目标是在不改变产品功能的前提下，显著提升应用的性能、稳定性和用户体验。

### 优化目标

| 指标 | 当前状态 | 目标状态 | 提升幅度 |
|------|----------|----------|----------|
| 联系人搜索耗时 | ~50ms (1000条) | ~5ms | 90% |
| 每日总结耗时 | ~30秒 (10人) | ~5秒 | 83% |
| 数据库查询耗时 | ~10ms | ~5ms | 50% |
| AI 请求成功率 | ~90% | ~98% | 8% |
| 内存使用 | 基准 | -20% | 20% |
| 冷启动时间 | ~2秒 | ~1.5秒 | 25% |

---

## 优化阶段总览

```
阶段 1: 快速优化 (第 1-2 周)
├── 数据库索引优化
├── 网络连接池配置
├── 搜索防抖实现
└── 标签分组优化

阶段 2: 核心优化 (第 3-6 周)
├── 多级缓存实现
├── 并发模型优化
├── 请求队列管理
└── 内存优化

阶段 3: 高级优化 (第 7-10 周)
├── 搜索系统重构
├── 数据库分库
├── 性能监控体系
└── 自动化测试

阶段 4: 持续优化 (第 11 周+)
├── 用户反馈响应
├── 新问题修复
└── 持续性能调优
```

---

## 阶段 1: 快速优化 (第 1-2 周)

### 周 1: 基础优化

#### 任务 1.1: 数据库索引添加

**负责人**: 待定
**开始日期**: 第 1 天
**结束日期**: 第 2 天

**任务详情**:
```
1. 添加 ContactProfileEntity 索引
   - Index(value = ["id"], unique = true)
   - Index(value = ["last_interaction_date"])

2. 添加 ConversationLogEntity 索引
   - Index(value = ["contact_id", "timestamp"])
   - Index(value = ["is_summarized", "timestamp"])

3. 添加 BrainTagEntity 索引
   - Index(value = ["contact_id"])

4. 测试验证
   - 验证索引生效
   - 测量查询性能提升
```

**验收标准**:
- [ ] 索引添加完成
- [ ] 单元测试通过
- [ ] 查询性能提升 30% 以上

---

#### 任务 1.2: OkHttp 连接池配置

**负责人**: 待定
**开始日期**: 第 3 天
**结束日期**: 第 3 天

**任务详情**:
```kotlin
// OkHttpClientFactory.kt
fun createOkHttpClient(): OkHttpClient {
    return OkHttpClient.Builder()
        .connectionPool(ConnectionPool(
            maxIdleConnections = 5,
            keepAliveDuration = 5,
            timeUnit = TimeUnit.MINUTES
        ))
        .connectTimeout(30, TimeUnit.SECONDS)
        .readTimeout(60, TimeUnit.SECONDS)
        .writeTimeout(60, TimeUnit.SECONDS)
        .build()
}
```

**验收标准**:
- [ ] 连接池配置完成
- [ ] 网络请求测试通过
- [ ] 连接复用率提升

---

#### 任务 1.3: 搜索防抖实现

**负责人**: 待定
**开始日期**: 第 4 天
**结束日期**: 第 5 天

**任务详情**:
```kotlin
// ContactListViewModel.kt
private var searchJob: Job? = null

private fun updateSearchQuery(query: String) {
    searchJob?.cancel()
    searchJob = viewModelScope.launch {
        delay(300) // 300ms 防抖
        if (query.isNotBlank()) {
            performSearch(query)
        } else {
            clearSearchResults()
        }
    }
}
```

**验收标准**:
- [ ] 搜索防抖功能实现
- [ ] 输入响应流畅
- [ ] 无竞态条件

---

### 周 2: 代码优化

#### 任务 2.1: 标签分组优化

**负责人**: 待定
**开始日期**: 第 8 天
**结束日期**: 第 8 天

**任务详情**:
```kotlin
// AnalyzeChatUseCase.kt
// 优化前
val redTags = brainTags.filter { it.type == TagType.RISK_RED }
val greenTags = brainTags.filter { it.type == TagType.STRATEGY_GREEN }

// 优化后
val (redTags, greenTags) = brainTags.partition { it.type == TagType.RISK_RED }
```

**验收标准**:
- [ ] 代码优化完成
- [ ] 性能测试通过

---

#### 任务 2.2: Moshi 单例化

**负责人**: 待定
**开始日期**: 第 9 天
**结束日期**: 第 10 天

**任务详情**:
```kotlin
// MoshiProvider.kt
object MoshiProvider {
    val moshi: Moshi by lazy {
        Moshi.Builder()
            .add(KotlinJsonAdapterFactory())
            .build()
    }
}
```

**验收标准**:
- [ ] Moshi 单例创建
- [ ] AiRepositoryImpl 使用单例
- [ ] 内存使用减少

---

#### 任务 2.3: 调试日志控制

**负责人**: 待定
**开始日期**: 第 11 天
**结束日期**: 第 14 天

**任务详情**:
- 将所有 `Log.d()` 调用包装在 `BuildConfig.DEBUG` 检查中
- 减少生产环境日志开销

**验收标准**:
- [ ] 所有日志调用添加条件检查
- [ ] 生产环境日志量减少 90%

---

## 阶段 2: 核心优化 (第 3-6 周)

### 周 3-4: 缓存与并发

#### 任务 3.1: 多级缓存实现

**负责人**: 待定
**开始日期**: 第 15 天
**结束日期**: 第 22 天

**任务详情**:
```
1. 实现 MemoryCache
   - 使用 LruCache
   - 大小限制: 100 items

2. 实现 DiskCache
   - 使用 SharedPreferences 或文件
   - 持久化缓存数据

3. 实现 CacheManager
   - 多级缓存协调
   - 缓存失效策略

4. 应用到联系人数据
   - ContactRepositoryImpl 集成缓存
   - BrainTagRepositoryImpl 集成缓存
```

**验收标准**:
- [ ] MemoryCache 实现
- [ ] DiskCache 实现
- [ ] 缓存命中率 > 70%
- [ ] 数据库查询减少 50%

---

#### 任务 3.2: 并发模型优化

**负责人**: 待定
**开始日期**: 第 23 天
**结束日期**: 第 30 天

**任务详情**:
```
1. 实现 ParallelProcessor
   - 支持并行处理
   - 动态调整并发度

2. 每日总结并行化
   -联系人顺序处理改为并行处理 将
   - 添加错误处理和重试

3. 数据加载并行化
   - AnalyzeChatUseCase 并行加载
   - profile + brainTags 同时加载
```

**验收标准**:
- [ ] ParallelProcessor 实现
- [ ] 每日总结耗时降低 70%
- [ ] 数据加载并行化完成

---

### 周 5-6: 请求管理

#### 任务 4.1: API 请求队列

**负责人**: 待定
**开始日期**: 第 31 天
**结束日期**: 第 38 天

**任务详情**:
```
1. 实现 ApiRequestQueue
   - 请求入队/出队
   - 智能重试策略
   - 请求去重

2. 实现 RateLimiter
   - API 速率限制
   - 配额管理

3. 集成到 AiRepositoryImpl
   - 使用队列发送请求
   - 处理重试和错误
```

**验收标准**:
- [ ] ApiRequestQueue 实现
- [ ] 智能重试工作正常
- [ ] API 成功率提升至 98%

---

#### 任务 4.2: 内存优化

**负责人**: 待定
**开始日期**: 第 39 天
**结束日期**: 第 42 天

**任务详情**:
```
1. 减少对象创建
   - 优化 StateFlow 更新
   - 使用对象池

2. 大对象优化
   - Facts JSON 分块加载
   - 对话记录分页加载

3. 内存泄漏修复
   - 检查所有 Context 使用
   - 修复可能的泄漏点
```

**验收标准**:
- [ ] 内存使用降低 20%
- [ ] 无内存泄漏
- [ ] GC 暂停减少

---

## 阶段 3: 高级优化 (第 7-10 周)

### 周 7-8: 搜索与存储

#### 任务 5.1: 搜索系统重构

**负责人**: 待定
**开始日期**: 第 43 天
**结束日期**: 第 56 天

**任务详情**:
```
阶段 7.1: 基础索引
├── ContactSearchIndex 实现
│   ├── 姓名 Hash 索引
│   ├── 目标 Hash 索引
│   └── Facts 倒排索引
└── 搜索结果缓存

阶段 7.2: 高级搜索
├── 中文分词器集成
├── 拼音首字母搜索
└── 标签过滤组合

阶段 7.3: 搜索优化
├── 增量索引更新
├── 搜索结果预加载
└── 搜索建议
```

**验收标准**:
- [ ] 搜索性能提升 10 倍
- [ ] 支持中文分词
- [ ] 用户满意度提升

---

#### 任务 5.2: 数据库分库

**负责人**: 待定
**开始日期**: 第 50 天
**结束日期**: 第 56 天

**任务详情**:
```
1. 对话记录分表
   - 按月分表存储
   - 历史数据归档策略

2. 数据库升级脚本
   - 数据迁移脚本
   - 备份策略

3. 查询路由
   - 根据日期路由到不同表
   - 统一查询接口
```

**验收标准**:
- [ ] 分表实现完成
- [ ] 数据迁移成功
- [ ] 查询性能稳定

---

### 周 9-10: 监控与测试

#### 任务 6.1: 性能监控体系

**负责人**: 待定
**负责人**: 第 57 天
**结束日期**: 第 70 天

**任务详情**:
```
1. PerformanceMonitor 实现
   - 性能指标采集
   - 百分位计算
   - 性能报告生成

2. 监控面板
   - 实时性能指标
   - 异常告警
   - 趋势分析

3. 集成到应用
   - 关键操作埋点
   - 性能日志
```

**验收标准**:
- [ ] 性能监控运行正常
- [ ] 监控面板可访问
- [ ] 异常自动告警

---

#### 任务 6.2: 自动化性能测试

**负责人**: 待定
**开始日期**: 第 64 天
**结束日期**: 第 70 天

**任务详情**:
```
1. 性能基准测试
   - ContactSearchBenchmark
   - DatabaseQueryBenchmark
   - AiRequestBenchmark

2. 回归检测
   - 性能回归检测
   - 基准对比

3. CI 集成
   - 定时性能测试
   - 性能报告生成
```

**验收标准**:
- [ ] 基准测试覆盖核心功能
- [ ] 性能回归检测工作
- [ ] CI 集成完成

---

## 阶段 4: 持续优化 (第 11 周+)

### 持续改进活动

#### 每周任务

| 任务 | 频率 | 负责人 |
|------|------|--------|
| 性能指标审查 | 每周 | 性能负责人 |
| 用户反馈分析 | 每周 | 产品经理 |
| 代码审查优化 | 每周 | 技术负责人 |
| 技术债务清理 | 每月 | 全团队 |

#### 季度任务

| 任务 | 时间 | 负责人 |
|------|------|--------|
| 性能优化回顾 | 每季度 | 技术负责人 |
| 优化策略调整 | 每季度 | 架构师 |
| 技术升级评估 | 每季度 | 架构师 |

---

## 资源规划

### 人力资源

| 阶段 | 人员配置 | 工作量 |
|------|----------|--------|
| 阶段 1 | 1 名工程师 | 2 周 |
| 阶段 2 | 1-2 名工程师 | 4 周 |
| 阶段 3 | 2 名工程师 | 4 周 |
| 阶段 4 | 0.5 名工程师 | 持续 |

### 技术资源

| 资源 | 需求 | 来源 |
|------|------|------|
| 测试设备 | 5 台 | 现有 |
| 性能分析工具 | Android Profiler | 免费 |
| CI/CD 资源 | GitHub Actions | 免费 |

---

## 风险与应对

### 技术风险

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| 搜索系统复杂度过高 | 中 | 高 | 分阶段实施，设置里程碑 |
| 缓存一致性问题 | 中 | 中 | 完善失效机制，增加测试 |
| 并发导致数据竞争 | 低 | 高 | 充分测试，使用协程安全模式 |

### 进度风险

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| 开发资源不足 | 中 | 高 | 预留缓冲时间 |
| 测试发现新问题 | 高 | 中 | 预留测试时间 |
| 需求变更 | 中 | 中 | 敏捷开发，快速响应 |

---

## 成功指标

### 性能指标

| 指标 | 基线 | 目标 | 验收标准 |
|------|------|------|----------|
| 联系人搜索 | 50ms | 5ms | P95 < 10ms |
| 每日总结 | 30秒 | 5秒 | P95 < 8秒 |
| 数据库查询 | 10ms | 5ms | P95 < 8ms |
| AI 请求成功 | 90% | 98% | P95 > 97% |
| 内存使用 | 基准 | -20% | 内存降低 20% |

### 质量指标

| 指标 | 基线 | 目标 | 验收标准 |
|------|------|------|----------|
| 崩溃率 | <1% | <0.1% | Crash-free users > 99.9% |
| ANR 率 | <0.5% | <0.1% | ANR-free > 99.9% |
| 单元测试覆盖 | 50% | 70% | 测试覆盖 > 70% |

---

## 依赖关系

```
阶段 1 完成
    │
    ├── 阶段 2 开始
    │       │
    │       ├── 任务 3.1 (缓存) 需要 阶段 1 完成
    │       │
    │       └── 任务 3.2 (并发) 需要 阶段 1 完成
    │
    └── 阶段 3 开始
            │
            ├── 任务 5.1 (搜索) 需要 阶段 2 完成
            │
            └── 任务 5.2 (分库) 独立进行
```

---

## 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0.0 | 2026-01-03 | 初始版本 | Claude |

---

**文档维护**: 技术团队
**下次审查**: 2026-02-03
**批准人**: 待定
