[根目录](../../../../../../CLAUDE.md) > [app](../../../) > **app**

# App 应用模块

## 模块职责

应用入口和全局初始化模块，负责应用级别的配置管理和生命周期管理。

## 入口与启动

### EmpathyApplication.kt
- **职责**: Hilt应用入口，全局初始化和生命周期管理
- **关键功能**:
  - 初始化Hilt依赖注入框架
  - 恢复悬浮窗服务状态
  - 触发每日对话自动总结
  - 执行数据清理任务
- **依赖**: 使用@HiltAndroidApp注解启用Hilt

## 关键组件

### 应用级协程作用域
- **作用域**: applicationScope = CoroutineScope(SupervisorJob() + Dispatchers.Main)
- **用途**: 执行应用级后台任务，不影响主线程启动
- **任务类型**:
  - 悬浮窗服务恢复
  - 每日总结触发
  - 数据清理执行

### 全局初始化流程
1. **应用启动**: onCreate()方法被调用
2. **Hilt初始化**: 依赖注入框架自动初始化
3. **服务恢复**: 检查并恢复悬浮窗服务
4. **后台任务**: 启动每日总结和数据清理
5. **界面显示**: MainActivity启动并显示主界面

## 配置文件

### AndroidManifest.xml
- **应用包名**: com.empathy.ai
- **主题**: Theme.GiveLove
- **权限配置**:
  - INTERNET: 网络访问
  - SYSTEM_ALERT_WINDOW: 悬浮窗权限
  - FOREGROUND_SERVICE: 前台服务权限
  - FOREGROUND_SERVICE_SPECIAL_USE: 特殊用途前台服务

## 依赖注入

### 注入的组件
- FloatingWindowPreferences: 悬浮窗状态管理
- SummarizeDailyConversationsUseCase: 每日对话总结
- DataCleanupManager: 数据清理管理

### AI 军师模块 (TD-00026)
- `AiAdvisorModule` - AI军师依赖注入模块
  - 提供AiAdvisorViewModel工厂
  - 提供AiAdvisorChatViewModel工厂
  - 绑定AiAdvisorRepository实现

## 运行时行为

### 悬浮窗服务恢复
- **条件检查**: 检查悬浮窗是否已启用
- **权限验证**: 确认悬浮窗权限状态
- **自动启动**: 权限正常时自动启动服务
- **状态同步**: 权限丢失时重置本地状态

### 每日总结机制
- **触发时机**: 应用启动时检查
- **执行条件**: 跨天或首次运行
- **异步处理**: 在IO线程执行，不阻塞UI
- **结果记录**: 记录总结成功/失败状态

### 数据清理策略
- **清理周期**: 每7天执行一次
- **清理范围**: 90天前的对话记录和总结
- **错误处理**: 清理失败不影响应用正常运行

## 常见问题

### Q: 应用启动时悬浮窗服务没有自动恢复？
A: 检查悬浮窗权限是否仍然有效，权限丢失时应用会自动重置状态。

### Q: 每日总结功能在什么时候执行？
A: 应用启动时会检查是否需要执行每日总结，如果是新的一天或首次运行会自动触发。

### Q: 数据清理会删除用户重要数据吗？
A: 只会删除90天前的对话记录和总结数据，联系人画像等核心数据不会被清理。

## 相关文件清单

### 核心文件
- `EmpathyApplication.kt` - 应用入口类
- `AndroidManifest.xml` - 应用配置清单

### 配置文件
- `build.gradle.kts` - 模块构建配置
- `proguard-rules.pro` - 代码混淆规则

### 资源文件
- `res/mipmap-*` - 应用图标
- `res/drawable/*` - 图标资源
- `res/layout/*` - 布局文件
- `res/xml/*` - 配置文件

## 变更记录 (Changelog)

### 2026-01-04 14:38:10 - Claude (AI上下文例行刷新)
- **验证文档时间戳一致性**
- **确认模块状态为完成（AI军师功能 TD-00026）**
- **代码质量A级保持**

### 2026-01-04 - Claude (AI军师功能文档更新)
- 新增AiAdvisorModule依赖注入模块
- 更新测试覆盖信息
- 更新测试统计（146个单元测试 + 26个Android测试）

### 2025-12-20 - Claude (模块文档初始化)
- 创建app模块CLAUDE.md文档
- 添加导航面包屑
- 整理模块职责和关键组件说明

### 2025-12-15 - Kiro (功能完善)
- 添加每日对话总结功能
- 实现数据清理管理器
- 优化悬浮窗服务恢复逻辑

### 2025-12-10 - Kiro (初始版本)
- 实现基础应用入口功能
- 集成Hilt依赖注入
- 配置应用权限和主题

---

**最后更新**: 2026-01-04 14:38:10 | 更新者: Claude
**模块状态**: 完成（AI军师功能 TD-00026）
**代码质量**: A级 (完整注释、错误处理)
**测试覆盖**: 包含146个单元测试和26个Android测试（25主源码 + 146测试 + 26Android测试）