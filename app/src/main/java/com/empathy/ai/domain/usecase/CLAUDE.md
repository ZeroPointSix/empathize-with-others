# Domain UseCase æ¨¡å—æ–‡æ¡£

> [ğŸ“ è¿”å›ä¸Šçº§](../../../CLAUDE.md) | [ğŸ  è¿”å›æ ¹ç›®å½•](../../../../CLAUDE.md)

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

Domain UseCaseæ¨¡å—æ˜¯Clean Architectureä¸­**ä¸šåŠ¡é€»è¾‘å±‚**çš„æ ¸å¿ƒå®ç°ï¼Œå°è£…äº†æ‰€æœ‰å…·ä½“çš„ä¸šåŠ¡åœºæ™¯æ“ä½œã€‚æ¯ä¸ªUseCaseå¯¹åº”ä¸€ä¸ªå…·ä½“çš„ç”¨æˆ·æ•…äº‹æˆ–ä¸šåŠ¡åŠŸèƒ½ï¼Œéµå¾ªå•ä¸€èŒè´£åŸåˆ™ã€‚

### ğŸ¯ æ ¸å¿ƒèŒè´£

- **ä¸šåŠ¡é€»è¾‘å°è£…**ï¼šå°†å¤æ‚çš„ä¸šåŠ¡è§„åˆ™å°è£…ä¸ºå¯å¤ç”¨çš„ç”¨ä¾‹
- **æ•°æ®åè°ƒ**ï¼šåè°ƒå¤šä¸ªRepositoryå®Œæˆä¸šåŠ¡æµç¨‹
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€å¤„ç†ä¸šåŠ¡å¼‚å¸¸å’Œé”™è¯¯åœºæ™¯
- **äº‹åŠ¡ç®¡ç†**ï¼šç¡®ä¿æ•°æ®æ“ä½œçš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§

### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

- **æ–‡ä»¶æ€»æ•°**: 26ä¸ªUseCaseå®ç° + 6ä¸ªæµ‹è¯•æ–‡ä»¶
- **æ ¸å¿ƒç”¨ä¾‹**: 15ä¸ªä¸»è¦ä¸šåŠ¡ç”¨ä¾‹
- **æµ‹è¯•è¦†ç›–**: å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- **ä»£ç è´¨é‡**: 100%ç¬¦åˆClean Architectureè§„èŒƒ

---

## ğŸ—ï¸ æ¨¡å—æ¶æ„

### æ ¸å¿ƒä¸šåŠ¡ç”¨ä¾‹åˆ†ç±»

```mermaid
graph TB
    subgraph "AIåˆ†æç”¨ä¾‹"
        A1[AnalyzeChatUseCase<br/>èŠå¤©åˆ†æ]
        A2[CheckDraftUseCase<br/>è‰ç¨¿æ£€æŸ¥]
        A3[GenerateReplyUseCase<br/>ç”Ÿæˆå›å¤]
        A4[PolishDraftUseCase<br/>æ¶¦è‰²è‰ç¨¿]
        A5[RefinementUseCase<br/>å†…å®¹ä¼˜åŒ–]
    end

    subgraph "è”ç³»äººç®¡ç†ç”¨ä¾‹"
        C1[GetContactUseCase<br/>è·å–è”ç³»äºº]
        C2[GetAllContactsUseCase<br/>è·å–æ‰€æœ‰è”ç³»äºº]
        C3[SaveProfileUseCase<br/>ä¿å­˜ç”»åƒ]
        C4[DeleteContactUseCase<br/>åˆ é™¤è”ç³»äºº]
    end

    subgraph "æ ‡ç­¾ç®¡ç†ç”¨ä¾‹"
        B1[GetBrainTagsUseCase<br/>è·å–æ ‡ç­¾]
        B2[SaveBrainTagUseCase<br/>ä¿å­˜æ ‡ç­¾]
        B3[DeleteBrainTagUseCase<br/>åˆ é™¤æ ‡ç­¾]
    end

    subgraph "AIé…ç½®ç”¨ä¾‹"
        P1[GetProvidersUseCase<br/>è·å–æœåŠ¡å•†]
        P2[SaveProviderUseCase<br/>ä¿å­˜æœåŠ¡å•†]
        P3[DeleteProviderUseCase<br/>åˆ é™¤æœåŠ¡å•†]
        P4[TestConnectionUseCase<br/>æµ‹è¯•è¿æ¥]
    end

    subgraph "æ•°æ®ç®¡ç†ç”¨ä¾‹"
        D1[FeedTextUseCase<br/>æ–‡æœ¬å¯¼å…¥]
        D2[SummarizeDailyConversationsUseCase<br/>æ¯æ—¥æ€»ç»“]
    end
```

---

## ğŸ”¥ æ ¸å¿ƒç”¨ä¾‹è¯¦è§£

### 1. AIåˆ†æç”¨ä¾‹ç¾¤

#### AnalyzeChatUseCase - èŠå¤©åˆ†æâ­
**æ–‡ä»¶ä½ç½®**: `AnalyzeChatUseCase.kt` (345è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½**:
- å¯¹èŠå¤©ä¸Šä¸‹æ–‡è¿›è¡Œæ·±åº¦AIåˆ†æ
- æä¾›ç­–ç•¥å»ºè®®å’Œé£é™©æç¤º
- é›†æˆè®°å¿†ç³»ç»Ÿä¿å­˜å¯¹è¯è®°å½•

**å…³é”®ä¾èµ–**:
```kotlin
// 9ä¸ªæ ¸å¿ƒRepositoryä¾èµ–
private val contactRepository: ContactRepository
private val brainTagRepository: BrainTagRepository
private val conversationRepository: ConversationRepository
private val aiRepository: AiRepository
private val promptBuilder: PromptBuilder
private val conversationContextBuilder: ConversationContextBuilder
```

**æ‰§è¡Œæµç¨‹**:
1. **å‰ç½®æ£€æŸ¥**: ç¡®ä¿AIæœåŠ¡å•†é…ç½®å®Œæ•´
2. **å¹¶è¡ŒåŠ è½½**: è”ç³»äººç”»åƒ + æ ‡ç­¾ + éšç§æ˜ å°„
3. **æ•°æ®æ¸…æ´—**: å»é‡ + æˆªå–æœ€è¿‘Næ¡
4. **å®‰å…¨è„±æ•**: æ ¹æ®éšç§è®¾ç½®è¿›è¡Œæ•°æ®æ©ç 
5. **å†å²ä¸Šä¸‹æ–‡**: æ„å»ºå¸¦æ—¶é—´æµé€æ ‡è®°çš„å†å²å¯¹è¯
6. **è®°å¿†ä¿å­˜**: ä¿å­˜ç”¨æˆ·è¾“å…¥åˆ°å¯¹è¯è®°å½•
7. **æç¤ºè¯æ„å»º**: ä¸‰å±‚åˆ†ç¦»æ¶æ„æ„å»ºAIæŒ‡ä»¤
8. **AIæ¨ç†**: è°ƒç”¨AIè¿›è¡Œåˆ†æ
9. **ç»“æœä¿å­˜**: ä¿å­˜AIå›å¤å¹¶æ›´æ–°äº’åŠ¨æ—¥æœŸ

**ç‰¹è‰²è®¾è®¡**:
- âœ… **è®°å¿†ç³»ç»Ÿé›†æˆ**: è‡ªåŠ¨ä¿å­˜åŒå‘å¯¹è¯å†å²
- âœ… **èº«ä»½å‰ç¼€ç³»ç»Ÿ**: åŒºåˆ†"å¯¹æ–¹è¯´"å’Œ"æˆ‘æ­£åœ¨å›å¤"
- âœ… **ä¸‰å±‚æç¤ºè¯æ¶æ„**: ç³»ç»Ÿçº¦æŸ + ç”¨æˆ·æŒ‡ä»¤ + è¿è¡Œæ—¶æ•°æ®
- âœ… **å®¹é”™è®¾è®¡**: AIåˆ†æå¤±è´¥ä¹Ÿä¸å½±å“ç”¨æˆ·è¾“å…¥ä¿å­˜

#### CheckDraftUseCase - è‰ç¨¿æ£€æŸ¥â­
**æ–‡ä»¶ä½ç½®**: `CheckDraftUseCase.kt` (152è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½**:
- å®æ—¶æ£€æŸ¥ç”¨æˆ·è¾“å…¥è‰ç¨¿çš„å®‰å…¨æ€§
- æœ¬åœ°å…³é”®è¯åŒ¹é… + äº‘ç«¯è¯­ä¹‰åˆ†æ
- æ”¯æŒæœ¬åœ°ä¼˜å…ˆæ¨¡å¼å’Œæ·±åº¦æ£€æŸ¥

**åŒå±‚æ£€æŸ¥æœºåˆ¶**:
```
Layer 1: æœ¬åœ°åŒ¹é… (æé€Ÿ)
â”œâ”€â”€ å…³é”®è¯åŒ¹é…
â”œâ”€â”€ ç«‹å³è¿”å›ç»“æœ
â””â”€â”€ é€‚åˆå®æ—¶æ£€æŸ¥

Layer 2: äº‘ç«¯è¯­ä¹‰æ£€æŸ¥ (æ·±åº¦)
â”œâ”€â”€ AIè¯­ä¹‰åˆ†æ
â”œâ”€â”€ ä¸Šä¸‹æ–‡ç†è§£
â””â”€â”€ é€‚åˆé‡è¦å†…å®¹
```

**é…ç½®é€‰é¡¹**:
- `localFirstEnabled`: æœ¬åœ°ä¼˜å…ˆæ¨¡å¼
- `enableDeepCheck`: æ˜¯å¦å¯ç”¨æ·±åº¦æ£€æŸ¥

#### GenerateReplyUseCase - ç”Ÿæˆå›å¤â­
**æ–‡ä»¶ä½ç½®**: `GenerateReplyUseCase.kt` (149è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½**:
- æ ¹æ®å¯¹æ–¹æ¶ˆæ¯ç”Ÿæˆåˆé€‚çš„å›å¤å»ºè®®
- é›†æˆå†å²å¯¹è¯ä¸Šä¸‹æ–‡
- BUG-00015ä¿®å¤ï¼šä¸‰ç§æ¨¡å¼ä¸Šä¸‹æ–‡å…±äº«

**å…³é”®ä¿®å¤**:
- âœ… **SessionContextService**: ç»Ÿä¸€ç®¡ç†å†å²å¯¹è¯ä¸Šä¸‹æ–‡
- âœ… **èº«ä»½å‰ç¼€ç³»ç»Ÿ**: æ˜ç¡®æ ‡è¯†æ¶ˆæ¯æ¥æº
- âœ… **ç§»é™¤è‡ªåŠ¨ä¿å­˜**: æ”¹ä¸ºç”¨æˆ·ä¸»åŠ¨å¤åˆ¶æ—¶ä¿å­˜

#### PolishDraftUseCase - æ¶¦è‰²è‰ç¨¿
**æ–‡ä»¶ä½ç½®**: `PolishDraftUseCase.kt`

**æ ¸å¿ƒåŠŸèƒ½**: æ¶¦è‰²å’Œä¼˜åŒ–ç”¨æˆ·è‰ç¨¿å†…å®¹

#### RefinementUseCase - å†…å®¹ä¼˜åŒ–
**æ–‡ä»¶ä½ç½®**: `RefinementUseCase.kt`

**æ ¸å¿ƒåŠŸèƒ½**: æ·±åº¦å†…å®¹ä¼˜åŒ–å’Œæ”¹è¿›

### 2. è”ç³»äººç®¡ç†ç”¨ä¾‹ç¾¤

#### SaveProfileUseCase - ä¿å­˜ç”»åƒ
**æ ¸å¿ƒèŒè´£**: ä¿å­˜å’Œæ›´æ–°è”ç³»äººç”»åƒä¿¡æ¯

#### GetContactUseCase/GetAllContactsUseCase - æŸ¥è¯¢è”ç³»äºº
**æ ¸å¿ƒèŒè´£**: æä¾›è”ç³»äººæ•°æ®çš„æŸ¥è¯¢æ¥å£

#### DeleteContactUseCase - åˆ é™¤è”ç³»äºº
**æ ¸å¿ƒèŒè´£**: å®‰å…¨åˆ é™¤è”ç³»äººå’Œç›¸å…³æ•°æ®

### 3. æ ‡ç­¾ç®¡ç†ç”¨ä¾‹ç¾¤

#### SaveBrainTagUseCase - ä¿å­˜æ ‡ç­¾
**æ ¸å¿ƒèŒè´£**: ä¿å­˜è”ç³»äººæ ‡ç­¾(é›·åŒº/ç­–ç•¥)

#### GetBrainTagsUseCase - è·å–æ ‡ç­¾
**æ ¸å¿ƒèŒè´£**: æŸ¥è¯¢è”ç³»äººæ ‡ç­¾åˆ—è¡¨

#### DeleteBrainTagUseCase - åˆ é™¤æ ‡ç­¾
**æ ¸å¿ƒèŒè´£**: åˆ é™¤æŒ‡å®šæ ‡ç­¾

### 4. AIé…ç½®ç”¨ä¾‹ç¾¤

#### TestConnectionUseCase - æµ‹è¯•è¿æ¥
**æ ¸å¿ƒèŒè´£**: æµ‹è¯•AIæœåŠ¡å•†è¿æ¥çŠ¶æ€

#### SaveProviderUseCase/GetProvidersUseCase - æœåŠ¡å•†ç®¡ç†
**æ ¸å¿ƒèŒè´£**: AIæœåŠ¡å•†çš„å¢åˆ æŸ¥æ”¹

### 5. æ•°æ®ç®¡ç†ç”¨ä¾‹ç¾¤

#### FeedTextUseCase - æ–‡æœ¬å¯¼å…¥
**æ ¸å¿ƒèŒè´£**: ä»æ–‡æœ¬æ–‡ä»¶å¯¼å…¥å¯¹è¯è®°å½•

#### SummarizeDailyConversationsUseCase - æ¯æ—¥æ€»ç»“
**æ ¸å¿ƒèŒè´£**: è‡ªåŠ¨ç”Ÿæˆæ¯æ—¥å¯¹è¯æ€»ç»“

---

## ğŸ§ª æµ‹è¯•æ¶æ„

### æµ‹è¯•æ–‡ä»¶åˆ†å¸ƒ
```
test/
â”œâ”€â”€ DeleteContactUseCaseTest.kt
â”œâ”€â”€ DeleteBrainTagUseCaseTest.kt
â”œâ”€â”€ GetBrainTagsUseCaseTest.kt
â”œâ”€â”€ SaveBrainTagUseCaseTest.kt
â”œâ”€â”€ RefinementUseCaseTest.kt
â”œâ”€â”€ PolishDraftUseCaseTest.kt
â””â”€â”€ GenerateReplyUseCaseTest.kt

androidTest/
â””â”€â”€ GenerateReplyUseCaseIntegrationTest.kt
```

### æµ‹è¯•ç­–ç•¥
- **å•å…ƒæµ‹è¯•**: æ¯ä¸ªUseCaseçš„æ ¸å¿ƒé€»è¾‘æµ‹è¯•
- **é›†æˆæµ‹è¯•**: è·¨Repositoryçš„ç«¯åˆ°ç«¯æµ‹è¯•
- **Mockç­–ç•¥**: ä½¿ç”¨MockKéš”ç¦»å¤–éƒ¨ä¾èµ–

---

## ğŸ”— ä¾èµ–å…³ç³»

### ä¾èµ–çš„Repositoryæ¥å£
```kotlin
// ä¸šåŠ¡æ•°æ®ä¾èµ–
ContactRepository          // è”ç³»äººæ•°æ®
BrainTagRepository         // æ ‡ç­¾æ•°æ®
AiRepository              // AIæœåŠ¡
ConversationRepository     // å¯¹è¯è®°å½•
PrivacyRepository         // éšç§é…ç½®
SettingsRepository        // åº”ç”¨è®¾ç½®
AiProviderRepository      // AIæœåŠ¡å•†é…ç½®
```

### ä¾èµ–çš„DomainæœåŠ¡
```kotlin
// æ ¸å¿ƒæœåŠ¡ä¾èµ–
PrivacyEngine             // éšç§è„±æ•å¼•æ“
PromptBuilder            // æç¤ºè¯æ„å»ºå™¨
ConversationContextBuilder // å¯¹è¯ä¸Šä¸‹æ–‡æ„å»ºå™¨
SessionContextService     // ä¼šè¯ä¸Šä¸‹æ–‡æœåŠ¡
IdentityPrefixHelper      // èº«ä»½å‰ç¼€åŠ©æ‰‹
```

---

## ğŸš€ è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ

### 1. å•ä¸€èŒè´£åŸåˆ™
æ¯ä¸ªUseCaseåªè´Ÿè´£ä¸€ä¸ªå…·ä½“çš„ä¸šåŠ¡åœºæ™¯ï¼ŒèŒè´£è¾¹ç•Œæ¸…æ™°ã€‚

### 2. ä¾èµ–å€’ç½®åŸåˆ™
æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æ¥å£ï¼Œé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ï¼Œä¾¿äºæµ‹è¯•å’Œæ›¿æ¢ã€‚

### 3. Resultç±»å‹å°è£…
ç»Ÿä¸€ä½¿ç”¨Kotlinçš„`Result<T>`ç±»å‹å¤„ç†æˆåŠŸ/å¤±è´¥åœºæ™¯ã€‚

### 4. åç¨‹å¼‚æ­¥è®¾è®¡
æ‰€æœ‰UseCaseéƒ½æ˜¯`suspend`å‡½æ•°ï¼Œæ”¯æŒåç¨‹å¼‚æ­¥è°ƒç”¨ã€‚

### 5. å®¹é”™è®¾è®¡
- **ä¼˜é›…é™çº§**: AIæœåŠ¡å¤±è´¥æ—¶æä¾›æœ¬åœ°æ›¿ä»£æ–¹æ¡ˆ
- **æ•°æ®ä¸€è‡´æ€§**: å³ä½¿éƒ¨åˆ†æ“ä½œå¤±è´¥ä¹Ÿä¿è¯æ ¸å¿ƒæ•°æ®ä¿å­˜
- **é”™è¯¯æ¢å¤**: æä¾›é‡è¯•æœºåˆ¶å’Œé”™è¯¯æ¢å¤ç­–ç•¥

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶è¡Œæ•°æ®åŠ è½½
```kotlin
// ä½¿ç”¨coroutineå¹¶è¡ŒåŠ è½½æ•°æ®
val profile = contactRepository.getProfile(contactId)
val brainTags = brainTagRepository.getTagsForContact(contactId)
val privacyMapping = privacyRepository.getPrivacyMapping()
```

### 2. æ•°æ®åˆ†æ‰¹å¤„ç†
å¤§æ•°æ®é‡åœºæ™¯ä¸‹é‡‡ç”¨åˆ†æ‰¹å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡ºã€‚

### 3. ç¼“å­˜ç­–ç•¥
åœ¨Repositoryå±‚å®ç°å¤šçº§ç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®—ã€‚

---

## ğŸ”’ å®‰å…¨è®¾è®¡

### 1. æ•°æ®è„±æ•
é›†æˆPrivacyEngineï¼Œç¡®ä¿æ•æ„Ÿæ•°æ®åœ¨å‘é€AIå‰å®Œæˆè„±æ•ã€‚

### 2. èº«ä»½éªŒè¯
ç¡®ä¿AIæœåŠ¡è°ƒç”¨å‰å®ŒæˆAPI KeyéªŒè¯ã€‚

### 3. æƒé™æ§åˆ¶
é€šè¿‡Repositoryå±‚æ§åˆ¶æ•°æ®è®¿é—®æƒé™ã€‚

---

## ğŸ“ å¼€å‘æŒ‡å—

### æ–°å¢UseCaseçš„æ ‡å‡†æ¨¡æ¿

```kotlin
class NewFeatureUseCase @Inject constructor(
    private val repository1: Repository1,
    private val repository2: Repository2,
    private val service: DomainService
) {
    suspend operator fun invoke(
        param1: String,
        param2: Int
    ): Result<ReturnType> {
        return try {
            // 1. å‰ç½®æ£€æŸ¥
            // 2. æ•°æ®åŠ è½½
            // 3. ä¸šåŠ¡é€»è¾‘å¤„ç†
            // 4. ç»“æœè¿”å›
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

### æµ‹è¯•æ¨¡æ¿

```kotlin
@Test
fun `æ–°å¢ç”¨ä¾‹ - æ­£å¸¸åœºæ™¯ - åº”è¯¥æˆåŠŸ`() = runTest {
    // Given
    // When
    // Then
}
```

---

## ğŸ› å·²çŸ¥é—®é¢˜ä¸æ”¹è¿›è®¡åˆ’

### å½“å‰æŠ€æœ¯å€ºåŠ¡
1. **TD-00008**: è¾“å…¥å†…å®¹èº«ä»½è¯†åˆ«ä¸åŒå‘å¯¹è¯å†å² (77.8%å®Œæˆ)
2. **æµ‹è¯•è¦†ç›–**: éƒ¨åˆ†UseCaseç¼ºå°‘å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹
3. **æ€§èƒ½ç›‘æ§**: éœ€è¦æ·»åŠ è¯¦ç»†çš„æ€§èƒ½ç›‘æ§æŒ‡æ ‡

### æ”¹è¿›æ–¹å‘
1. **é”™è¯¯å¤„ç†å¢å¼º**: æä¾›æ›´ç»†ç²’åº¦çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†
2. **æ€§èƒ½ä¼˜åŒ–**: å¼•å…¥æ›´æ™ºèƒ½çš„ç¼“å­˜å’Œæ‰¹å¤„ç†ç­–ç•¥
3. **ç›‘æ§å®Œå–„**: æ·»åŠ ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§å’Œå‘Šè­¦

---

**æœ€åæ›´æ–°**: 2025-12-19
**æ¨¡å—è´Ÿè´£äºº**: Domain Team
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0