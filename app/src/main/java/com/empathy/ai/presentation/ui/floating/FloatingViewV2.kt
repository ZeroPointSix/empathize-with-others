package com.empathy.ai.presentation.ui.floating

import android.content.Context
import android.view.LayoutInflater
import android.view.View
import android.view.WindowManager
import android.widget.ArrayAdapter
import android.widget.AutoCompleteTextView
import android.widget.FrameLayout
import android.widget.LinearLayout
import android.widget.TextView
import com.empathy.ai.R
import com.empathy.ai.domain.model.ActionType
import com.empathy.ai.domain.model.AiResult
import com.empathy.ai.domain.model.ContactProfile
import com.empathy.ai.domain.model.FloatingWindowUiState
import com.google.android.material.button.MaterialButton
import com.google.android.material.progressindicator.CircularProgressIndicator
import com.google.android.material.textfield.TextInputEditText
import com.google.android.material.textfield.TextInputLayout

/**
 * æ‚¬æµ®çª—è§†å›¾V2 - é‡æ„ç‰ˆæœ¬
 *
 * æ”¯æŒä¸‰Tabåˆ‡æ¢ï¼ˆåˆ†æ/æ¶¦è‰²/å›å¤ï¼‰ã€ç»“æœå±•ç¤ºã€å¾®è°ƒåŠŸèƒ½
 *
 * ä¸»è¦æ”¹è¿›ï¼š
 * - ä½¿ç”¨TabSwitcherç»„ä»¶å®ç°Tabåˆ‡æ¢
 * - ä½¿ç”¨ResultCardç»„ä»¶å±•ç¤ºAIç»“æœ
 * - ä½¿ç”¨RefinementOverlayå®ç°å¾®è°ƒå¯¹è¯æ¡†
 * - æ”¯æŒçŠ¶æ€ä¿å­˜å’Œæ¢å¤
 *
 * @see PRD-00009 æ‚¬æµ®çª—åŠŸèƒ½é‡æ„éœ€æ±‚
 * @see TDD-00009 æ‚¬æµ®çª—åŠŸèƒ½é‡æ„æŠ€æœ¯è®¾è®¡
 */
class FloatingViewV2(
    context: Context,
    private val windowManager: WindowManager
) : FrameLayout(context) {

    // Tabåˆ‡æ¢ç»„ä»¶
    private var tabSwitcher: TabSwitcher? = null

    // Tabå†…å®¹åŒºåŸŸ
    private var tabContentContainer: FrameLayout? = null
    private var contactSelectorLayout: TextInputLayout? = null
    private var contactSelector: AutoCompleteTextView? = null
    private var inputLayout: TextInputLayout? = null
    private var inputText: TextInputEditText? = null
    private var btnSubmit: MaterialButton? = null
    private var loadingContainer: LinearLayout? = null
    private var loadingIndicator: CircularProgressIndicator? = null
    private var loadingText: TextView? = null
    private var errorContainer: LinearLayout? = null
    private var errorText: TextView? = null
    private var btnRetry: MaterialButton? = null

    // ç»“æœå¡ç‰‡ç»„ä»¶
    private var resultCard: ResultCard? = null

    // å¾®è°ƒè¦†ç›–å±‚
    private var refinementOverlay: RefinementOverlay? = null

    // å½“å‰çŠ¶æ€
    private var currentState = FloatingWindowUiState()
    private var contacts: List<ContactProfile> = emptyList()
    
    // ã€TD-00016ã€‘å½“å‰ä¸»é¢˜å†…å®¹ï¼ˆç”¨äºæ˜¾ç¤ºä¸»é¢˜å¾½ç« ï¼‰
    private var currentTopicContent: String? = null
    
    // ä¸»é¢˜ç›¸å…³UIç»„ä»¶
    private var topicBadge: TextView? = null
    private var btnTopic: TextView? = null

    // å›è°ƒ
    private var onTabChangedListener: ((ActionType) -> Unit)? = null
    private var onContactSelectedListener: ((String) -> Unit)? = null
    private var onSubmitListener: ((ActionType, String, String) -> Unit)? = null
    private var onCopyListener: ((String) -> Unit)? = null
    private var onRegenerateListener: ((ActionType, String?) -> Unit)? = null
    private var onMinimizeListener: (() -> Unit)? = null
    private var onTopicClickListener: (() -> Unit)? = null

    init {
        initViews()
        setupListeners()
    }

    private fun initViews() {
        // BUG-00020ä¿®å¤ï¼šç§»é™¤å¤–å±‚ScrollViewï¼Œæ”¹ç”¨ResultCardå†…éƒ¨çš„MaxHeightScrollViewå®ç°æ»‘æ¡†å¼è®¾è®¡
        // è¿™æ ·å¯ä»¥é¿å…åµŒå¥—æ»šåŠ¨å†²çªï¼ŒåŒæ—¶ç¡®ä¿æŒ‰é’®å›ºå®šåœ¨åº•éƒ¨
        
        // åˆ›å»ºä¸»å¸ƒå±€
        val mainLayout = LinearLayout(context).apply {
            orientation = LinearLayout.VERTICAL
            layoutParams = LayoutParams(
                LayoutParams.MATCH_PARENT,
                LayoutParams.WRAP_CONTENT
            )
            setBackgroundResource(R.color.floating_background)
            elevation = 8f
        }

        // æ·»åŠ é¡¶éƒ¨å·¥å…·æ ï¼ˆåªæœ‰æœ€å°åŒ–æŒ‰é’®ï¼‰
        // BUG-00013: ç§»é™¤å…³é—­æŒ‰é’®ï¼Œåªä¿ç•™æœ€å°åŒ–æŒ‰é’®
        // TD-00016: æ·»åŠ ä¸»é¢˜è®¾ç½®æŒ‰é’®
        val toolbar = LinearLayout(context).apply {
            orientation = LinearLayout.HORIZONTAL
            layoutParams = LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
            )
            setPadding(12, 8, 12, 0)
            gravity = android.view.Gravity.END
        }
        
        // ã€TD-00016ã€‘ä¸»é¢˜å¾½ç«  - æ˜¾ç¤ºå½“å‰ä¸»é¢˜é¢„è§ˆ
        val density = context.resources.displayMetrics.density
        topicBadge = TextView(context).apply {
            layoutParams = LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.WRAP_CONTENT,
                (32 * density).toInt()
            ).apply {
                marginEnd = (8 * density).toInt()
                gravity = android.view.Gravity.CENTER_VERTICAL
            }
            maxWidth = (150 * density).toInt()
            maxLines = 1
            ellipsize = android.text.TextUtils.TruncateAt.END
            textSize = 12f
            setTextColor(android.graphics.Color.parseColor("#666666"))
            setPadding((8 * density).toInt(), (4 * density).toInt(), (8 * density).toInt(), (4 * density).toInt())
            background = android.graphics.drawable.GradientDrawable().apply {
                cornerRadius = 12 * density
                setColor(android.graphics.Color.parseColor("#E8F5E9")) // æµ…ç»¿è‰²èƒŒæ™¯
            }
            visibility = View.GONE // é»˜è®¤éšè—ï¼Œæœ‰ä¸»é¢˜æ—¶æ˜¾ç¤º
        }
        toolbar.addView(topicBadge)
        
        // ã€TD-00016ã€‘ä¸»é¢˜è®¾ç½®æŒ‰é’®
        val topicButtonSize = (40 * density).toInt()
        val topicBackgroundDrawable = android.graphics.drawable.GradientDrawable().apply {
            shape = android.graphics.drawable.GradientDrawable.OVAL
            setColor(android.graphics.Color.parseColor("#E3F2FD")) // æµ…è“è‰²èƒŒæ™¯
        }
        
        btnTopic = TextView(context).apply {
            layoutParams = LinearLayout.LayoutParams(topicButtonSize, topicButtonSize).apply {
                marginEnd = (8 * density).toInt()
            }
            text = "ğŸ“" // ä¸»é¢˜å›¾æ ‡
            textSize = 18f
            gravity = android.view.Gravity.CENTER
            background = topicBackgroundDrawable
            isClickable = true
            isFocusable = true
            setOnClickListener {
                android.util.Log.d(TAG, "ä¸»é¢˜æŒ‰é’®è¢«ç‚¹å‡»")
                onTopicClickListener?.invoke()
            }
        }
        toolbar.addView(btnTopic)

        // æœ€å°åŒ–æŒ‰é’® - ä½¿ç”¨æ›´é†’ç›®çš„æ ·å¼
        // BUG-00013: åªä¿ç•™æœ€å°åŒ–æŒ‰é’®ï¼Œç§»é™¤å…³é—­æŒ‰é’®
        // BUG-00017: ä¿®å¤æŒ‰é’®ä¸å¯è§é—®é¢˜ - å¢å¤§å°ºå¯¸ã€æ·»åŠ èƒŒæ™¯è‰²ã€ä½¿ç”¨æ›´é†’ç›®çš„å›¾æ ‡
        val buttonSize = (48 * density).toInt() // 48dpè½¬æ¢ä¸ºpx
        
        // åˆ›å»ºåœ†å½¢èƒŒæ™¯
        val backgroundDrawable = android.graphics.drawable.GradientDrawable().apply {
            shape = android.graphics.drawable.GradientDrawable.OVAL
            setColor(android.graphics.Color.parseColor("#E0E0E0")) // æµ…ç°è‰²èƒŒæ™¯
        }
        
        val btnMinimize = TextView(context).apply {
            layoutParams = LinearLayout.LayoutParams(buttonSize, buttonSize)
            text = "â–¼" // ä½¿ç”¨å‘ä¸‹ç®­å¤´è¡¨ç¤ºæœ€å°åŒ–ï¼Œæ¯”å‡å·æ›´é†’ç›®
            textSize = 20f
            gravity = android.view.Gravity.CENTER
            setTextColor(android.graphics.Color.parseColor("#424242")) // æ·±ç°è‰²ï¼Œå¯¹æ¯”åº¦æ›´é«˜
            background = backgroundDrawable
            isClickable = true
            isFocusable = true
            setOnClickListener {
                android.util.Log.d(TAG, "æœ€å°åŒ–æŒ‰é’®è¢«ç‚¹å‡», listener=${onMinimizeListener != null}")
                onMinimizeListener?.invoke()
            }
        }
        toolbar.addView(btnMinimize)

        mainLayout.addView(toolbar)

        // æ·»åŠ Tabåˆ‡æ¢å™¨
        tabSwitcher = TabSwitcher(context).apply {
            layoutParams = LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
            )
        }
        mainLayout.addView(tabSwitcher)

        // æ·»åŠ Tabå†…å®¹åŒºåŸŸ
        tabContentContainer = FrameLayout(context).apply {
            layoutParams = LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
            )
        }

        // åŠ è½½Tabå†…å®¹å¸ƒå±€
        val tabContent = LayoutInflater.from(context)
            .inflate(R.layout.floating_tab_content, tabContentContainer, false)
        tabContentContainer?.addView(tabContent)

        // åˆå§‹åŒ–Tabå†…å®¹ç»„ä»¶
        contactSelectorLayout = tabContent.findViewById(R.id.contact_selector_layout)
        contactSelector = tabContent.findViewById(R.id.contact_selector)
        inputLayout = tabContent.findViewById(R.id.input_layout)
        inputText = tabContent.findViewById(R.id.input_text)
        btnSubmit = tabContent.findViewById(R.id.btn_submit)
        loadingContainer = tabContent.findViewById(R.id.loading_container)
        loadingIndicator = tabContent.findViewById(R.id.loading_indicator)
        loadingText = tabContent.findViewById(R.id.loading_text)
        errorContainer = tabContent.findViewById(R.id.error_container)
        errorText = tabContent.findViewById(R.id.error_text)
        btnRetry = tabContent.findViewById(R.id.btn_retry)

        mainLayout.addView(tabContentContainer)

        // æ·»åŠ ç»“æœå¡ç‰‡
        resultCard = ResultCard(context).apply {
            layoutParams = LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
            )
            visibility = View.GONE
        }
        mainLayout.addView(resultCard)

        // BUG-00020ä¿®å¤ï¼šç›´æ¥æ·»åŠ ä¸»å¸ƒå±€ï¼Œä¸ä½¿ç”¨å¤–å±‚ScrollView
        // æ»šåŠ¨åŠŸèƒ½ç”±ResultCardå†…éƒ¨çš„MaxHeightScrollViewå®ç°
        addView(mainLayout)

        // åˆ›å»ºå¾®è°ƒè¦†ç›–å±‚ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰
        refinementOverlay = RefinementOverlay(context, windowManager)
    }

    private fun setupListeners() {
        // Tabåˆ‡æ¢ç›‘å¬
        tabSwitcher?.setOnTabSelectedListener { tab ->
            currentState = currentState.copy(selectedTab = tab)
            updateInputHint(tab)
            onTabChangedListener?.invoke(tab)
        }

        // è”ç³»äººé€‰æ‹©ç›‘å¬
        contactSelector?.setOnItemClickListener { _, _, position, _ ->
            val contactId = contacts.getOrNull(position)?.id?.toString()
            if (contactId != null) {
                currentState = currentState.copy(selectedContactId = contactId)
                onContactSelectedListener?.invoke(contactId)
            }
        }

        // å‘é€æŒ‰é’®ç›‘å¬
        btnSubmit?.setOnClickListener {
            val text = inputText?.text?.toString()?.trim() ?: ""
            val contactId = currentState.selectedContactId
            if (text.isNotBlank() && contactId != null) {
                onSubmitListener?.invoke(currentState.selectedTab, contactId, text)
            }
        }

        // é‡è¯•æŒ‰é’®ç›‘å¬
        btnRetry?.setOnClickListener {
            hideError()
            val text = inputText?.text?.toString()?.trim() ?: ""
            val contactId = currentState.selectedContactId
            if (text.isNotBlank() && contactId != null) {
                onSubmitListener?.invoke(currentState.selectedTab, contactId, text)
            }
        }

        // ç»“æœå¡ç‰‡ç›‘å¬
        resultCard?.setOnCopyClickListener { text ->
            onCopyListener?.invoke(text)
        }

        resultCard?.setOnRegenerateClickListener {
            showRefinementDialog()
        }

        // å¾®è°ƒè¦†ç›–å±‚ç›‘å¬
        refinementOverlay?.setOnDirectRegenerateListener {
            onRegenerateListener?.invoke(currentState.selectedTab, null)
        }

        refinementOverlay?.setOnRegenerateWithInstructionListener { instruction ->
            onRegenerateListener?.invoke(currentState.selectedTab, instruction)
        }
    }

    // ==================== å…¬å¼€æ–¹æ³• ====================

    /**
     * è®¾ç½®è”ç³»äººåˆ—è¡¨
     */
    fun setContacts(contactList: List<ContactProfile>) {
        contacts = contactList
        val names = contactList.map { it.name }
        val adapter = ArrayAdapter(context, android.R.layout.simple_dropdown_item_1line, names)
        contactSelector?.setAdapter(adapter)

        // å¦‚æœæœ‰ä¿å­˜çš„è”ç³»äººIDï¼Œè‡ªåŠ¨é€‰ä¸­
        currentState.selectedContactId?.let { savedId ->
            val index = contactList.indexOfFirst { it.id.toString() == savedId }
            if (index >= 0) {
                contactSelector?.setText(contactList[index].name, false)
            }
        }
    }

    /**
     * æ¢å¤çŠ¶æ€
     * 
     * BUG-00020ä¿®å¤ï¼šæ¢å¤ç»“æœæ—¶ä¹Ÿéœ€è¦åŠ¨æ€è°ƒæ•´é«˜åº¦
     */
    fun restoreState(state: FloatingWindowUiState) {
        currentState = state

        // æ¢å¤Tab
        tabSwitcher?.setSelectedTab(state.selectedTab)
        updateInputHint(state.selectedTab)

        // æ¢å¤è¾“å…¥å†…å®¹
        inputText?.setText(state.inputText)

        // æ¢å¤è”ç³»äººé€‰æ‹©
        state.selectedContactId?.let { contactId ->
            val contact = contacts.find { it.id.toString() == contactId }
            contact?.let { contactSelector?.setText(it.name, false) }
        }

        // æ¢å¤ç»“æœï¼ˆshowResultå†…éƒ¨ä¼šè°ƒæ•´é«˜åº¦ï¼‰
        state.lastResult?.let { showResult(it) }

        // æ¢å¤åŠ è½½çŠ¶æ€
        if (state.isLoading) {
            showLoading()
        }

        // æ¢å¤é”™è¯¯çŠ¶æ€
        state.errorMessage?.let { showError(it) }
    }

    /**
     * è·å–å½“å‰çŠ¶æ€
     */
    fun getCurrentState(): FloatingWindowUiState {
        return currentState.copy(
            inputText = inputText?.text?.toString() ?: ""
        )
    }

    /**
     * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     */
    fun showLoading(message: String = "AIæ­£åœ¨æ€è€ƒ...") {
        currentState = currentState.copy(isLoading = true)
        loadingContainer?.visibility = View.VISIBLE
        loadingText?.text = message
        btnSubmit?.isEnabled = false
        errorContainer?.visibility = View.GONE
    }

    /**
     * éšè—åŠ è½½çŠ¶æ€
     */
    fun hideLoading() {
        currentState = currentState.copy(isLoading = false)
        loadingContainer?.visibility = View.GONE
        btnSubmit?.isEnabled = true
    }

    /**
     * æ˜¾ç¤ºé”™è¯¯
     */
    fun showError(message: String) {
        currentState = currentState.copy(errorMessage = message)
        errorContainer?.visibility = View.VISIBLE
        errorText?.text = message
        hideLoading()
    }

    /**
     * éšè—é”™è¯¯
     */
    fun hideError() {
        currentState = currentState.copy(errorMessage = null)
        errorContainer?.visibility = View.GONE
    }

    /**
     * æ˜¾ç¤ºç»“æœ
     * 
     * BUG-00024æœ€ç»ˆä¿®å¤ï¼š
     * - å†…å®¹åŒºåŸŸå›ºå®šæœ€å¤§é«˜åº¦120dpï¼ˆåœ¨XMLä¸­è®¾ç½®ï¼‰
     * - ä¿ç•™è¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·å¯ä»¥ç»§ç»­è¾“å…¥å¯¹è¯
     * - å†…å®¹è¶…å‡º120dpæ—¶é€šè¿‡æ»šåŠ¨æŸ¥çœ‹
     * - æŒ‰é’®å›ºå®šåœ¨åº•éƒ¨ï¼Œå§‹ç»ˆå¯è§ä¸”æœ‰å……è¶³ç©ºé—´
     * 
     * ä¿®å¤é¡ºåºï¼š
     * 1. å…ˆè®¾ç½®æœ€å¤§é«˜åº¦
     * 2. å†æ˜¾ç¤ºç»“æœå†…å®¹
     * 3. æœ€åè®¾ç½®å¯è§æ€§
     */
    fun showResult(result: AiResult) {
        currentState = currentState.copy(lastResult = result)

        // BUG-00024ä¿®å¤ï¼šåŠ¨æ€è®¡ç®—å¹¶è®¾ç½®æœ€å¤§é«˜åº¦
        // ç¡®ä¿ç»“æœåŒºåŸŸä¸ä¼šå æ»¡å±å¹•ï¼Œç»™è¾“å…¥æ¡†å’ŒæŒ‰é’®ç•™å‡ºå……è¶³ç©ºé—´
        val displayMetrics = context.resources.displayMetrics
        val screenHeight = displayMetrics.heightPixels
        val density = displayMetrics.density
        
        // ä½¿ç”¨å›ºå®šçš„120dpä½œä¸ºæœ€å¤§é«˜åº¦ï¼Œä¸XMLä¸­çš„è®¾ç½®ä¿æŒä¸€è‡´
        // è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨æ‰€æœ‰è®¾å¤‡ä¸ŠæŒ‰é’®éƒ½èƒ½å®Œæ•´æ˜¾ç¤º
        val maxHeightDp = 120
        val maxAllowedHeight = (maxHeightDp * density).toInt()

        android.util.Log.d(TAG, "showResult: å‡†å¤‡æ˜¾ç¤ºç»“æœï¼Œè®¾ç½®æœ€å¤§é«˜åº¦ä¸º${maxAllowedHeight}px (${maxHeightDp}dp), å±å¹•é«˜åº¦${screenHeight}px")
        
        // 1. å…ˆè®¾ç½®æœ€å¤§é«˜åº¦
        resultCard?.setMaxHeight(maxAllowedHeight)
        
        // 2. å†æ˜¾ç¤ºç»“æœå†…å®¹
        resultCard?.showResult(result)
        
        // 3. æœ€åè®¾ç½®å¯è§æ€§
        resultCard?.visibility = View.VISIBLE
        
        hideLoading()
        hideError()

        android.util.Log.d(TAG, "showResult: ç»“æœå·²æ˜¾ç¤ºå®Œæˆ")
    }

    /**
     * æ¸…ç©ºç»“æœ
     */
    fun clearResult() {
        currentState = currentState.copy(lastResult = null)
        resultCard?.clearResult()
        resultCard?.visibility = View.GONE
    }

    /**
     * æ˜¾ç¤ºå¾®è°ƒå¯¹è¯æ¡†
     */
    fun showRefinementDialog() {
        refinementOverlay?.show()
    }

    /**
     * éšè—å¾®è°ƒå¯¹è¯æ¡†
     */
    fun hideRefinementDialog() {
        refinementOverlay?.dismiss()
    }

    /**
     * é‡ç½®è§†å›¾ï¼ˆä¿ç•™Tabå’Œè”ç³»äººè®°å¿†ï¼‰
     */
    fun resetKeepingMemory() {
        currentState = currentState.resetKeepingMemory()
        inputText?.setText("")
        clearResult()
        hideLoading()
        hideError()
    }

    /**
     * å®Œå…¨é‡ç½®è§†å›¾
     */
    fun resetAll() {
        currentState = currentState.resetAll()
        tabSwitcher?.setSelectedTab(ActionType.ANALYZE)
        inputText?.setText("")
        contactSelector?.setText("", false)
        clearResult()
        hideLoading()
        hideError()
    }

    // ==================== å›è°ƒè®¾ç½® ====================

    fun setOnTabChangedListener(listener: (ActionType) -> Unit) {
        onTabChangedListener = listener
    }

    fun setOnContactSelectedListener(listener: (String) -> Unit) {
        onContactSelectedListener = listener
    }

    fun setOnSubmitListener(listener: (ActionType, String, String) -> Unit) {
        onSubmitListener = listener
    }

    fun setOnCopyListener(listener: (String) -> Unit) {
        onCopyListener = listener
    }

    fun setOnRegenerateListener(listener: (ActionType, String?) -> Unit) {
        onRegenerateListener = listener
    }

    fun setOnMinimizeListener(listener: () -> Unit) {
        onMinimizeListener = listener
    }
    
    /**
     * ã€TD-00016ã€‘è®¾ç½®ä¸»é¢˜ç‚¹å‡»ç›‘å¬å™¨
     */
    fun setOnTopicClickListener(listener: () -> Unit) {
        onTopicClickListener = listener
    }
    
    /**
     * ã€TD-00016ã€‘æ›´æ–°ä¸»é¢˜æ˜¾ç¤º
     * 
     * @param topicContent ä¸»é¢˜å†…å®¹ï¼Œä¸ºnullæˆ–ç©ºæ—¶éšè—ä¸»é¢˜å¾½ç« 
     */
    fun updateTopicDisplay(topicContent: String?) {
        currentTopicContent = topicContent
        if (topicContent.isNullOrBlank()) {
            topicBadge?.visibility = View.GONE
            btnTopic?.text = "ğŸ“" // æ— ä¸»é¢˜æ—¶æ˜¾ç¤ºæ™®é€šå›¾æ ‡
        } else {
            topicBadge?.visibility = View.VISIBLE
            topicBadge?.text = "ğŸ¯ ${topicContent.take(15)}${if (topicContent.length > 15) "..." else ""}"
            btnTopic?.text = "âœï¸" // æœ‰ä¸»é¢˜æ—¶æ˜¾ç¤ºç¼–è¾‘å›¾æ ‡
        }
    }
    
    /**
     * ã€TD-00016ã€‘è·å–å½“å‰ä¸»é¢˜å†…å®¹
     */
    fun getCurrentTopicContent(): String? = currentTopicContent

    // ==================== ç§æœ‰æ–¹æ³• ====================

    private fun updateInputHint(tab: ActionType) {
        val hint = when (tab) {
            ActionType.ANALYZE -> "ç²˜è´´å¯¹æ–¹å‘æ¥çš„æ¶ˆæ¯..."
            ActionType.POLISH -> "è¾“å…¥ä½ æƒ³è¯´çš„è¯ï¼ŒAIå¸®ä½ æ¶¦è‰²..."
            ActionType.REPLY -> "ç²˜è´´å¯¹æ–¹å‘æ¥çš„æ¶ˆæ¯ï¼ŒAIå¸®ä½ å›å¤..."
            else -> "è¾“å…¥å†…å®¹..."
        }
        inputLayout?.hint = hint

        val buttonText = when (tab) {
            ActionType.ANALYZE -> "åˆ†æ"
            ActionType.POLISH -> "æ¶¦è‰²"
            ActionType.REPLY -> "ç”Ÿæˆå›å¤"
            else -> "å‘é€"
        }
        btnSubmit?.text = buttonText
    }

    companion object {
        private const val TAG = "FloatingViewV2"
    }
}
