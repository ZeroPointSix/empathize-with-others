### 1. DI 容器配置 (Hilt Modules)

我们需要在 `di` 包下创建三个 Module，分别负责不同的职责。

#### A. 网络模块 (`NetworkModule`)
**核心任务**：配置 HTTP 客户端的行为。
**关键决策点**：
* **超时控制 (Timeouts)**：
    * LLM 的 Token 生成速度很慢。普通的 API 请求 10秒超时就挂了，但 AI 可能需要 30秒甚至更久。
    * **配置**：`connectTimeout` = 30s, `readTimeout` = 60s, `writeTimeout` = 30s。
* **日志拦截 (Logging)**：
    * 只在 `BuildConfig.DEBUG` 模式下注入 `HttpLoggingInterceptor`。生产环境必须关闭，否则会泄露用户隐私到 Logcat。
* **单例 (Singleton)**：
    * `OkHttpClient` 和 `Retrofit` 创建成本极高，全 App 必须只有一个实例。

#### B. 数据模块 (`DataModule`)
**核心任务**：提供持久化存储的单例。
**关键决策点**：
* **Room 实例**：使用 `Room.databaseBuilder` 创建。
* **EncryptedSharedPreferences**：
    * 这里是创建主密钥 (`MasterKey`) 和加密实例的地方。
    * 注意：创建加密实例可能会因为某些国产手机的 ROM 问题抛出异常，虽然 Hilt Module 里不好做 `try-catch`，但在实际生产代码中要留意这一点（MVP 先按标准写）。

#### C. 仓库模块 (`RepositoryModule`)
**核心任务**：接口绑定 (Interface Binding)。
**关键决策点**：
* **@Binds 注解**：
    * 这是 Hilt 的黑魔法。它告诉框架：“当业务层（UseCase）请求 `ContactRepository` 接口时，请给它 `ContactRepositoryImpl` 的实例。”
    * 这实现了 **依赖倒置原则 (DIP)** 的最后一步闭环。

---

### 2. 最终仓库实现 (`AiRepositoryImpl`)

这是整个 Data Layer 逻辑最复杂的类，也是连接所有模块的 **“大总管”**。

**位置**：`data/repository/AiRepositoryImpl.kt`

**逻辑流程 (The Pipeline)**：

1.  **鉴权与路由 (Auth & Routing)**：
    * 调用 `settingsRepo.getAiProvider()`。
    * *逻辑分支*：
        * 如果是 `OPENAI` -> URL = `"https://api.openai.com/v1/chat/completions"`
        * 如果是 `DEEPSEEK` -> URL = `"https://api.deepseek.com/chat/completions"`
    * 调用 `settingsRepo.getApiKey()`。如果为空，抛出自定义异常 `ApiKeyMissingException`。

2.  **数据封包 (DTO Mapping)**：
    * **System Prompt**: 将 Domain 层的 `profile` (画像) 和 `tags` (策略) 格式化为一段 String，封装进 `MessageDto(role="system")`。
    * **User Context**: 将 Domain 层的 `context` (聊天记录) 封装进 `MessageDto(role="user")`。
    * **Request**: 创建 `ChatRequestDto`，填入 `temperature=0.7` 等参数。

3.  **网络调用 (Network Call)**：
    * 执行 `api.chatCompletion(url, headers, request)`。
    * **异常捕获**：这里必须用 `try-catch` 包裹。
        * 捕获 `HttpException`: 比如 401 (Key 错了), 429 (超额了), 500 (服务器挂了)。
        * 捕获 `IOException`: 比如断网, 超时。
        * **关键**：将这些底层网络异常，转换为 Domain 层能理解的 `Result.Failure`。

4.  **解包与交付 (Unpacking)**：
    * 从 `response.choices[0].message.content` 获取 AI 的原始 JSON 字符串。
    * 尝试解析这个 JSON（因为我们 Prompt 里要求 AI 返回 JSON）。
    * 构建 `AnalysisResult` (Domain Model) 并返回。

---

### 3. 总结与执行

这一步（模块四）是 Data Layer 的**收官之战**。完成后，你的 App 就真正打通了任督二脉。

**待生成的 AI 任务清单**：
1.  **Task 9**: 编写 `di/NetworkModule.kt` (超时配置是关键)。
2.  **Task 10**: 编写 `di/DataModule.kt` (数据库与加密SP)。
3.  **Task 11**: 编写 `data/repository/AiRepositoryImpl.kt` (核心胶水逻辑) 和 `di/RepositoryModule.kt` (接口绑定)。
