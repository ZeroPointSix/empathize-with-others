# 依赖配置说明

## 概述

本文档说明共情AI助手项目的依赖配置,所有依赖使用 Gradle Version Catalog (libs.versions.toml) 统一管理。

**最后更新**: 2025-12-01

---

## 配置文件结构

```
项目根目录/
├── gradle/
│   └── libs.versions.toml    # 版本目录 (Version Catalog)
├── build.gradle.kts           # 根级构建配置
└── app/
    └── build.gradle.kts       # 应用模块构建配置
```

---

## 核心依赖清单

### 1. Android & Kotlin 核心

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| Android Gradle Plugin | 8.7.3 | Android 项目构建工具 |
| Kotlin | 2.0.21 | Kotlin 语言支持 |
| AndroidX Core KTX | 1.15.0 | Android 核心扩展 |
| AppCompat | 1.7.0 | 向下兼容支持 |

### 2. Jetpack Compose (UI框架)

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| Compose BOM | 2024.12.01 | Compose 版本统一管理 |
| Material3 | 1.3.1 | Material Design 3 组件 |
| Navigation Compose | 2.8.5 | 导航组件 |
| Activity Compose | 1.9.3 | Activity 集成 |

**说明**: 使用 BOM (Bill of Materials) 统一管理 Compose 依赖版本,避免版本冲突。

### 3. Hilt (依赖注入)

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| Hilt Android | 2.52 | 依赖注入框架 |
| Hilt Navigation Compose | 1.2.0 | Compose 导航集成 |

**配置要点**:
- 使用 KSP (Kotlin Symbol Processing) 替代 KAPT,提升编译速度
- 需要在 `app/build.gradle.kts` 中添加 `kapt { correctErrorTypes = true }`

### 4. Room (本地数据库)

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| Room Runtime | 2.6.1 | 数据库运行时 |
| Room KTX | 2.6.1 | Kotlin 扩展和协程支持 |
| Room Compiler | 2.6.1 | 编译时注解处理器 |

**使用场景**:
- 存储联系人画像 (ContactProfile)
- 存储核心雷区和策略标签 (BrainTag)

### 5. Retrofit & OkHttp (网络请求)

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| Retrofit | 2.11.0 | REST API 客户端 |
| Retrofit Converter Moshi | 2.11.0 | JSON 转换器 |
| OkHttp | 4.12.0 | HTTP 客户端 |
| OkHttp Logging Interceptor | 4.12.0 | 网络请求日志 |

**配置特点**:
- 支持动态 BaseURL (通过 `@Url` 注解)
- 支持多 AI 服务商 (OpenAI, DeepSeek, Google)

### 6. Moshi (JSON 解析)

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| Moshi | 1.15.1 | JSON 解析库 |
| Moshi Kotlin | 1.15.1 | Kotlin 支持 |
| Moshi Codegen | 1.15.1 | 代码生成器 |

**优势**: 相比 Gson,Moshi 对 Kotlin 支持更好,性能更优。

### 7. Coroutines (协程)

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| Kotlinx Coroutines Core | 1.9.0 | 协程核心库 |
| Kotlinx Coroutines Android | 1.9.0 | Android 协程支持 |

**使用场景**:
- 异步网络请求
- 数据库操作
- UI 状态管理

### 8. Security (安全)

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| Security Crypto | 1.1.0-alpha06 | 加密存储 |

**关键用途**:
- 使用 `EncryptedSharedPreferences` 存储 API Key
- 硬件级加密,保障隐私安全

### 9. FFmpeg Kit (音视频处理)

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| FFmpeg Kit Full | 6.0-2 | 音视频编解码 |

**功能**:
- 音频提取 (从 MP4 提取音频)
- 视频拆帧 (用于 OCR 分析)
- 支持 ASR 转录准备

### 10. Lifecycle (生命周期)

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| Lifecycle Runtime KTX | 2.8.7 | 生命周期运行时 |
| Lifecycle ViewModel KTX | 2.8.7 | ViewModel 支持 |
| Lifecycle Service | 2.8.7 | Service 生命周期管理 |

**关键组件**: `LifecycleService` 用于 FloatingWindowService。

---

## 插件配置

### 应用的插件 (app/build.gradle.kts)

```kotlin
plugins {
    alias(libs.plugins.android.application)  // Android 应用插件
    alias(libs.plugins.kotlin.android)       // Kotlin Android 插件
    alias(libs.plugins.kotlin.compose)       // Compose 编译器插件
    alias(libs.plugins.hilt)                 // Hilt 依赖注入
    alias(libs.plugins.ksp)                  // Kotlin Symbol Processing
}
```

### 插件说明

1. **kotlin-compose**: Kotlin 2.0+ 的 Compose 编译器插件,替代旧版 `compose` 配置
2. **ksp**: 替代 KAPT,更快的注解处理速度
3. **hilt**: Hilt 依赖注入插件

---

## 编译配置要点

### Java 版本

```kotlin
compileOptions {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

kotlinOptions {
    jvmTarget = "17"
}
```

**原因**: Kotlin 2.0+ 和 Compose 需要 Java 17 支持。

### Compose 配置

```kotlin
buildFeatures {
    compose = true
    buildConfig = true
}
```

### ProGuard 配置

```kotlin
buildTypes {
    release {
        isMinifyEnabled = true
        isShrinkResources = true
        proguardFiles(
            getDefaultProguardFile("proguard-android-optimize.txt"),
            "proguard-rules.pro"
        )
    }
}
```

**说明**: Release 版本启用代码混淆和资源压缩。

---

## 依赖版本管理策略

### 1. 使用 Version Catalog

所有依赖版本统一在 `gradle/libs.versions.toml` 中定义:

```toml
[versions]
hilt = "2.52"

[libraries]
hilt-android = { group = "com.google.dagger", name = "hilt-android", version.ref = "hilt" }
```

### 2. 使用 BOM 管理 Compose

```kotlin
val composeBom = platform(libs.androidx.compose.bom)
implementation(composeBom)
```

**优势**: 统一版本,避免冲突。

### 3. KSP 优先于 KAPT

对于 Room 和 Hilt,优先使用 KSP:

```kotlin
ksp(libs.hilt.compiler)
ksp(libs.androidx.room.compiler)
```

---

## 常见问题排查

### 1. Compose 编译错误

**问题**: `@Composable invocations can only happen from the context of a @Composable function`

**解决**: 确保 `kotlin-compose` 插件已添加。

### 2. Hilt 编译失败

**问题**: `Hilt classes are not generated`

**解决**: 确保添加了 `kapt { correctErrorTypes = true }` 配置。

### 3. Room 数据库未生成

**问题**: DAO 接口报错

**解决**: 检查 `ksp(libs.androidx.room.compiler)` 是否正确配置。

### 4. FFmpeg 库过大

**问题**: APK 体积过大

**解决**: 可选择使用 `ffmpeg-kit-min` 替代 `ffmpeg-kit-full`,仅包含所需编解码器。

---

## 依赖更新策略

### 定期更新

建议每 2-3 个月检查依赖更新:

```bash
./gradlew dependencyUpdates
```

### 重点关注

1. **安全更新**: Security Crypto, OkHttp
2. **稳定性更新**: Compose BOM, Hilt
3. **性能更新**: Room, Retrofit

### 更新原则

- 优先更新补丁版本 (x.x.X)
- 谨慎更新次版本 (x.X.x)
- 充分测试后更新主版本 (X.x.x)

---

## 参考资源

- [Jetpack Compose BOM](https://developer.android.com/jetpack/compose/bom)
- [Hilt 官方文档](https://dagger.dev/hilt/)
- [Room 官方文档](https://developer.android.com/training/data-storage/room)
- [Retrofit 官方文档](https://square.github.io/retrofit/)
- [FFmpeg Kit Android](https://github.com/arthenica/ffmpeg-kit)

---

**维护者**: hushaokang
**创建日期**: 2025-12-01
