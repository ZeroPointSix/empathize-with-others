# 数据层待修复问题清单

> 创建时间: 2025-12-04  
> 来源: 数据层测试诊断报告  
> 状态: 待修复

---

## 🔴 高优先级问题

### 问题1: BrainTagRepositoryImpl缺少异常处理

**问题描述**:  
在BrainTagEntity转换为Domain对象时,`TagType.valueOf(this.type)`可能抛出`IllegalArgumentException`,导致应用崩溃。

**影响范围**:
- 文件: `BrainTagRepositoryImpl.kt`
- 方法: `private fun BrainTagEntity.toDomain()`
- 行号: 107

**触发条件**:
1. 数据库中存储了无效的TagType字符串(如旧版本枚举值)
2. 数据损坏导致type字段包含非法值
3. 调用`getTagsForContact()`或`getAllRedFlags()`时

**影响**:
- 应用崩溃
- 用户数据无法读取
- 功能完全不可用

**修复方案**:
添加try-catch捕获IllegalArgumentException,返回安全默认值STRATEGY_GREEN,与RoomTypeConverters的处理方式保持一致。

**预计工作量**: 5分钟

**验证方法**:
1. 创建单元测试模拟无效枚举值
2. 确认不会抛出异常
3. 确认返回默认值STRATEGY_GREEN

---

## 🟡 中优先级问题

### 问题2: ContactRepositoryImpl性能问题 - Moshi实例重复创建

**问题描述**:  
在`toDomain()`和`toEntity()`方法中重复创建Moshi实例,而类级别已有可复用的实例。

**影响范围**:
- 文件: `ContactRepositoryImpl.kt`
- 方法: `private fun ContactProfileEntity.toDomain()` (行160-162)
- 方法: `private fun ContactProfile.toEntity()` (行189-190)

**性能影响**:
- 每次查询联系人都创建新的Moshi实例
- 查询100个联系人 = 创建100次Moshi Builder
- 不必要的内存分配和GC压力

**当前问题**:
类的第30行已经创建了moshi实例,第31行创建了mapType,但在toDomain()和toEntity()方法中又重新创建了这些实例。

**修复方案**:
在toDomain()和toEntity()方法中直接使用类级别的moshi和mapType实例,避免重复创建。

**预计工作量**: 10分钟

**验证方法**:
1. 运行现有的ContactRepositoryImplTest
2. 使用性能分析工具对比修复前后的对象创建数量
3. 确保所有测试通过

---

## 🟢 低优先级优化

### 问题3: 测试覆盖度可以提升

**建议增加的测试用例**:

#### 3.1 RoomTypeConverters性能测试
测试超大JSON(1000+键值对)的处理性能,确保在合理时间内完成。

#### 3.2 特殊字符处理测试
测试emoji、引号、换行符、反斜杠等特殊字符的正确处理。

#### 3.3 并发测试
测试多线程同时调用TypeConverter时的线程安全性。

**预计工作量**: 30分钟

---

## 📊 修复优先级建议

### 第一批修复 (本周内)
1. ✅ **问题1** - BrainTagRepositoryImpl异常处理 (5分钟)
   - 风险: 高
   - 影响: 崩溃
   - 优先级: P0

### 第二批修复 (下周)
2. ✅ **问题2** - ContactRepositoryImpl性能优化 (10分钟)
   - 风险: 中
   - 影响: 性能
   - 优先级: P1

### 第三批优化 (有时间时)
3. 📝 **问题3** - 测试用例补充 (30分钟)
   - 风险: 低
   - 影响: 测试覆盖度
   - 优先级: P2

---

## ✅ 修复检查清单

修复完成后,请逐项检查:

- [ ] 问题1: BrainTagRepositoryImpl已添加try-catch
- [ ] 问题1: 单元测试验证异常处理
- [ ] 问题1: 默认值与RoomTypeConverters一致
- [ ] 问题2: toDomain()使用类级别moshi实例
- [ ] 问题2: toEntity()使用类级别moshi实例
- [ ] 问题2: 所有Repository测试通过
- [ ] 问题3: 性能测试用例已添加
- [ ] 问题3: 特殊字符测试用例已添加
- [ ] 问题3: 并发测试用例已添加
- [ ] 所有修改已提交并记录

---

## 📝 修复记录

| 日期 | 问题编号 | 修复人 | 状态 | 备注 |
|------|---------|--------|------|------|
| - | 问题1 | - | ⏳ 待修复 | - |
| - | 问题2 | - | ⏳ 待修复 | - |
| - | 问题3 | - | ⏳ 待修复 | - |

---

## 🔗 相关文档

- [数据层测试诊断报告](./数据层测试诊断报告.md)
- [数据层开发规范](../01-架构设计/数据层/数据层开发规范.md)
- [单元测试总结](./单元测试总结.md)