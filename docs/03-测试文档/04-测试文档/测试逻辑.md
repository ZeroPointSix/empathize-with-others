---
date_modified: 2025-12-02 19:38:58
---

### 第一阶段：白盒测试 (Unit Testing - Domain Layer)

目标： 确保你的“业务大脑”逻辑正确。这是你最熟悉的领域（纯 Kotlin，不依赖 Android 模拟器）。

工具： JUnit 4/5 + Mockk (类似于 Python 的 unittest.mock)。

#### 1. 测试 `AnalyzeChatUseCase` (RAG 逻辑)

- **测试场景：**
    
    1. **正常流程：** 给定画像、雷区、聊天记录 -> 验证 Prompt 是否正确拼装了 Facts 和 RedTags -> 验证是否调用了 `AiRepo`。
        
    2. **隐私脱敏：** 输入 "张三 13800138000" -> 验证传给 `AiRepo` 的是不是 `[Target] [Phone]`。
        
    3. **空数据处理：** 如果没有 Facts 或 Tags，Prompt 是否还能正常生成（不崩溃）。
        
- **伪代码思路：**
    
    Kotlin
    
    ```C++
    @Test
    fun `analyze flow builds prompt correctly`() = runTest {
        // Prepare Mocks
        every { profileRepo.getProfile("1") } returns ContactProfile(facts = mapOf("爱好" to "钓鱼"))
        every { tagRepo.getTags("1") } returns listOf(BrainTag("别提钱", RISK_RED))
    
        // Execute
        useCase("1", listOf("你好"))
    
        // Verify (Assert)
        verify { 
            aiRepo.analyze(
                match { it.contains("爱好: 钓鱼") && it.contains("别提钱") }, // 验证 Prompt 包含 RAG 数据
                any() 
            ) 
        }
    }
    ```

#### 2. 测试 `CheckDraftUseCase` (风控逻辑)

- **测试场景：**
    
    1. **命中雷区：** Tag="借钱", Input="能不能借钱" -> 必须返回 `DANGER`。
        
    2. **安全通过：** Tag="借钱", Input="吃饭了吗" -> 必须返回 `SAFE`。
        
    3. **忽略大小写：** Tag="Money", Input="i need money" -> 必须返回 `DANGER`。

---

### 第二阶段：黑盒/集成测试 (Manual Walkthrough)

目标： 确保“手” (Fetcher) 能抓到东西，“脑” (Logic) 能转动，“嘴” (UI) 能显示。

工具： 真机 (推荐) + Logcat。

#### 准备工作 (Setup)

1. **安装应用：** 确保是 Debug 包。
    
2. **授权三件套：**
    
    - 去“设置 -> 辅助功能”开启服务。
        
    - 去“设置 -> 应用管理”开启悬浮窗权限。
        
    - (重要) 开启“后台弹出界面”权限（小米/OV 手机特有）。
        
3. **基础设施：** 在 App 设置页填入你的 OpenAI/DeepSeek API Key。

#### 流程一：数据喂养 (Data Feeding)

- **动作：**
    
    1. 进入 App 首页，新建联系人“测试员A”。
        
    2. 点击 `[+] 导入`，粘贴文本：“他叫李四，住在朝阳区，不喜欢吃香菜。”
        
    3. 点击“AI 提取”。
        
- **验收标准：**
    
    - UI 弹窗显示待确认列表。
        
    - Facts 列表里出现 `{"住址": "朝阳区"}`。
        
    - Tags 列表里出现 `[RED] 不吃香菜`。
        
    - 点击确认后，数据库 (`App Inspection` -> `Databases`) 里能查到这些记录。

#### 流程二：主动风控 (Draft Check)

- **动作：**
    
    1. 打开微信，进入“文件传输助手”（模拟聊天）。
        
    2. 在输入框打字：“今晚吃香菜吗”。
        
    3. 点击悬浮窗上的 **`[🛡️ 检查]`** 按钮。
        
- **验收标准：**
    
    - 悬浮窗**立即**变红或弹出警告框。
        
    - 提示文案包含：“命中雷区：不吃香菜”。
        
    - **关键点：** 测试输入框为空时，是否提示“内容为空”。

#### 流程三：主动分析 (RAG Analysis)

- **动作：**
    
    1. 在微信里发送几条消息构造上下文（自己发“你好”，对方发“心情不好”）。
        
    2. 点击悬浮窗上的 **`[💡 分析]`** 按钮。
        
- **验收标准 (查看 Logcat)：**
    
    - `ScreenFetcher`: 看到 log 打印出 `Captured: ["你好", "心情不好"]` (证明抓取成功)。
        
    - `PrivacyEngine`: 看到 log `Masked: [MASKED_TEXT]` (证明脱敏生效)。
        
    - `AiRepository`: 看到 `Request: ... "爱好: 钓鱼" ...` (证明 RAG 拼装成功)。
        
- **验收标准 (UI)：**
    
    - 悬浮窗展开，显示“分析卡片”。
        
    - 卡片能显示“情绪分析”和“建议回复”。
        
    - 点击“建议回复”的 `[填充]` 按钮，微信输入框里自动填入文字。

---

### 第三阶段：边缘与异常测试 (Edge Cases)

作为后台开发者，你知道系统挂掉通常是因为这些边界情况。

1. **无权限测试：**
    
    - 把无障碍权限关了，点击悬浮窗按钮。
        
    - _预期：_ App 提示“请先开启辅助服务”，而不是直接 Crash。
        
2. **断网/超时测试：**
    
    - 把手机开飞行模式，点击 `[💡 分析]`。
        
    - _预期：_ UI 显示“网络连接失败”或“AI 响应超时”，不能卡死。
        
3. **Key 失效测试：**
    
    - 在设置里乱填一个 API Key。
        
    - _预期：_ AI 接口返回 401 错误，App 弹窗提示“API Key 无效”。
        
4. **UI 滚动测试 (如果做了滚动抓取)：**
    
    - 找一个聊天记录很多的页面，点击分析。
        
    - _预期：_ 屏幕是否会出现自动滚动的动作？抓取的文本是否重复？

---

### 总结：你的测试 Checklist

|**测试阶段**|**测试内容**|**关键工具**|**优先级**|
|---|---|---|---|
|**Unit Test**|`AnalyzeChatUseCase` (拼 Prompt, 脱敏)|JUnit, Mockk|**P0 (必须)**|
|**Unit Test**|`CheckDraftUseCase` (本地字符串匹配)|JUnit|**P0 (必须)**|
|**Manual**|权限授权与 API Key 保存|真机|**P0 (必须)**|
|**Manual**|微信内抓取文本 (Logcat 确认)|Logcat|**P0 (必须)**|
|**Manual**|悬浮窗渲染与填充文本|真机|**P1**|
|**Edge**|断网、Key 错误处理|真机|**P1**|
