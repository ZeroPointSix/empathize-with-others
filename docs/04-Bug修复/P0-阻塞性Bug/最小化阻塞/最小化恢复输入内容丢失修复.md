# 最小化恢复后 UI 显示问题修复

## 问题描述

### 问题 1：输入内容丢失
用户发送消息后最小化悬浮窗，等待 AI 回复完成后再恢复界面时，发现：
- 输入框内容丢失（显示空白）
- AI 分析结果正常显示

### 问题 2：AI 结果显示时输入区域未折叠
当 AI 分析结果显示时：
- 联系人选择器和输入框仍然显示（应该隐藏）
- 关闭按钮点击无效

## 根因分析

### 问题 1 根因
1. **数据模型不一致**：`MinimizedRequestInfo` 没有保存输入内容字段
2. **最小化时未保存输入状态**
3. **恢复时未恢复输入状态**

### 问题 2 根因
1. **布局问题**：输入区域的标签没有 ID，无法在代码中控制可见性
2. **只隐藏了部分组件**：`showAnalysisResult` 只隐藏了 `inputText`、`charCount`、`contactSpinner`，但标签仍然显示
3. **关闭按钮监听器问题**：监听器设置可能被覆盖或未正确绑定

## 修复方案

### 1. 更新 MinimizedRequestInfo 数据模型

添加新字段：
- `contactId`: 联系人ID
- `inputText`: 用户输入的文本内容
- `selectedContactIndex`: 选中的联系人索引

### 2. 修改布局文件

**文件**: `app/src/main/res/layout/floating_input_dialog.xml`

将输入区域（联系人选择器、输入框、字符计数）包装在一个 `LinearLayout` 容器中：
```xml
<LinearLayout
    android:id="@+id/input_section_container"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="vertical">
    <!-- 联系人选择器标签 -->
    <!-- 联系人选择器 -->
    <!-- 输入框标签 -->
    <!-- 输入框 -->
    <!-- 字符计数 -->
</LinearLayout>
```

### 3. 修改 FloatingView.kt

1. **添加输入区域容器引用**：
   ```kotlin
   private var inputSectionContainer: LinearLayout? = null
   ```

2. **修改 `showAnalysisResult` 和 `showSafetyResult`**：
   - 隐藏整个 `inputSectionContainer`（而不是单独隐藏各个组件）
   - 隐藏取消按钮
   - 添加专门的 `closeResultDialog()` 方法处理关闭逻辑

3. **修改 `resetInputState` 和 `clearInputDialogState`**：
   - 恢复 `inputSectionContainer` 可见性
   - 恢复取消按钮可见性

### 4. 新增 closeResultDialog 方法

专门用于关闭结果对话框，确保：
- 重置结果区域
- 恢复输入区域容器可见性
- 恢复取消按钮
- 恢复确认按钮文本
- 清除请求信息
- 关闭对话框

## 修改的文件

1. `app/src/main/java/com/empathy/ai/domain/model/MinimizedRequestInfo.kt`
2. `app/src/main/res/layout/floating_input_dialog.xml`
3. `app/src/main/java/com/empathy/ai/domain/util/FloatingView.kt`
4. `app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt`

## 预期效果

### AI 结果显示时
- 只显示 AI 分析结果区域
- 联系人选择器和输入框完全隐藏
- 只显示"关闭"按钮（取消按钮隐藏）
- 点击"关闭"按钮可以正常关闭对话框

### 最小化恢复时
- 输入框内容保留
- 选中的联系人保留

---

**修复日期**: 2025-12-09
**修复人**: Kiro
