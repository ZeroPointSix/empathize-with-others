---
name: debugging
description: 系统化调试 - 根因分析、问题定位、日志分析、修复验证。在遇到 Bug、性能问题或异常行为时使用。
---

# 系统化调试

## 激活时机

当满足以下条件时自动激活此技能：
- 程序出现 Bug 或异常
- 功能不符合预期
- 性能问题需要诊断
- 需要分析错误日志
- 验证修复是否有效

## 调试流程

### 五步调试法

```
┌─────────────────────────────────────┐
│  1. 定义问题                         │
│     复现问题、收集症状、明确预期      │
└───────────────┬─────────────────────┘
                ↓
┌─────────────────────────────────────┐
│  2. 收集信息                         │
│     查看日志、堆栈、环境状态          │
└───────────────┬─────────────────────┘
                ↓
┌─────────────────────────────────────┐
│  3. 定位根因                         │
│     缩小范围、假设验证、找到源头      │
└───────────────┬─────────────────────┘
                ↓
┌─────────────────────────────────────┐
│  4. 实施修复                         │
│     最小改动、针对性修复              │
└───────────────┬─────────────────────┘
                ↓
┌─────────────────────────────────────┐
│  5. 验证确认                         │
│     确认修复、回归测试、总结经验      │
└─────────────────────────────────────┘
```

## 第一步：定义问题

### 问题描述模板
```
什么: [具体现象]
何时: [发生时间/频率]
何处: [发生的模块/位置]
如何: [如何复现]
影响: [影响范围/严重程度]
```

### 复现步骤
```
1. 记录精确的操作步骤
2. 确定稳定的复现路径
3. 识别必要的条件
4. 记录异常状态
```

## 第二步：收集信息

### 检查清单

```markdown
### 错误信息
- [ ] 完整的错误消息
- [ ] 堆栈跟踪
- [ ] 错误代码

### 环境状态
- [ ] 运行环境（开发/测试/生产）
- [ ] 相关配置
- [ ] 依赖版本
- [ ] 系统资源（CPU/内存/网络）

### 日志信息
- [ ] 应用日志
- [ ] 访问日志
- [ ] 错误日志
- [ ] 性能日志

### 时间线
- [ ] 问题首次出现时间
- [ ] 相关变更（代码/配置/部署）
- [ ] 异常发生前后的事件
```

### 日志分析要点
```
关键信息：
- 错误级别（ERROR/WARN）
- 请求ID/追踪ID
- 时间戳和顺序
- 相关的用户/会话信息
- 上下游服务调用

分析技巧：
- 按时间排序，找触发点
- 按请求ID关联，找调用链
- 按错误级别，找关键问题
- 对比正常/异常日志，找差异
```

## 第三步：定位根因

### 缩小范围策略

```
1. 二分法
   - 注释掉一半代码，问题是否仍存在
   - 逐步缩小问题范围

2. 控制变量法
   - 改变一个条件，保持其他不变
   - 确定关键因素

3. 最小化复现
   - 移除不必要的步骤
   - 简化输入数据
   - 创造最小复现案例

4. 增量调试
   - 从简单场景开始
   - 逐步增加复杂度
   - 定位问题触发点
```

### 常见根因类型

| 类型 | 说明 | 检查点 |
|------|------|--------|
| **逻辑错误** | 条件判断、循环边界 | 业务逻辑分支 |
| **状态错误** | 变量值、状态转换 | 变量生命周期 |
| **并发问题** | 竞态条件、死锁 | 共享资源、锁 |
| **资源泄漏** | 内存、连接、句柄 | 资源释放点 |
| **配置错误** | 环境变量、配置文件 | 配置加载 |
| **依赖问题** | 版本冲突、接口变更 | 依赖版本 |
| **数据问题** | 脏数据、格式错误 | 数据库/缓存 |
| **边界问题** | 空值、极值、溢出 | 输入验证 |

### 假设验证

```
假设驱动调试：
1. 基于信息提出假设
2. 设计验证方法
3. 执行验证
4. 确认或修正假设

假设示例：
"问题可能是数据库连接池耗尽"

验证方法：
- 检查连接池当前使用数
- 查看连接超时设置
- 观察慢查询日志
- 查看数据库连接数
```

## 第四步：实施修复

### 修复原则
```
✅ 最小改动原则 - 只修改必要代码
✅ 针对性修复 - 直接解决根因
✅ 保留上下文 - 添加注释说明
✅ 防御性编程 - 增加边界检查
```

### 修复优先级
```
P0 - 紧急修复
  - 服务崩溃/不可用
  - 数据安全风险
  - 资源严重泄漏

P1 - 高优先级
  - 核心功能不可用
  - 严重影响用户体验

P2 - 中优先级
  - 非核心功能异常
  - 降级方案可用

P3 - 低优先级
  - 优化类问题
  - 边缘场景
```

### 修复验证
```
单元测试：验证修复点
集成测试：验证关联功能
回归测试：确保无新问题
压力测试：验证稳定性
```

## 第五步：验证确认

### 验证清单
```markdown
### 功能验证
- [ ] 原问题已解决
- [ ] 正常场景仍正常
- [ ] 边缘情况已覆盖
- [ ] 无新问题引入

### 性能验证
- [ ] 响应时间正常
- [ ] 资源使用合理
- [ ] 无内存泄漏
- [ ] 无性能退化

### 日志验证
- [ ] 错误日志正常
- [ ] 关键操作有日志
- [ ] 日志级别正确
- [ ] 敏感信息已脱敏

### 文档更新
- [ ] 更新代码注释
- [ ] 更新 API 文档（如有）
- [ ] 记录已知问题（如有）
- [ ] 更新运维手册（如有）
```

## 常用调试技巧

### 1. 日志调试
```typescript
// 结构化日志
console.log('[DEBUG] Step 1: input =', data);
console.log('[DEBUG] Step 2: processed =', result);
console.log('[DEBUG] Step 3: output =', response);

// 使用日志库
logger.debug('Processing user', { userId, action });
logger.error('Failed to save', { error, userId });
```

### 2. 断点调试
```
设置断点位置：
- 函数入口/出口
- 条件分支前
- 循环内部
- 异常抛出点

调试检查：
- 变量当前值
- 调用栈
- 表达式求值
- 内存状态
```

### 3. 排除法
```typescript
// 注释掉怀疑代码
// async function process() {
//   const result1 = await step1();  // 注释
//   const result2 = await step2();
//   return result2;
// }

// 简化复杂逻辑
function complexLogic(x, y, z) {
  // return elaborateCalculation(x, y, z);
  return x + y;  // 简化版本测试
}
```

### 4. 对比法
```
对比内容：
- 正常 vs 异常环境
- 成功 vs 失败请求
- 旧版本 vs 新版本
- 不同用户的操作

工具：
- git diff 查看代码变更
- 日志对比工具
- 数据库记录对比
```

## 调试工具箱

### 后端调试工具
```
- 日志分析：ELK, Loki, Splunk
- 性能分析：pprof, flamegraph
- 内存分析：heapdump, memwatch
- 数据库：EXPLAIN, slow query log
- 网络：tcpdump, wireshark
```

### 前端调试工具
```
- 浏览器 DevTools
- React DevTools / Vue DevTools
- 网络面板
- Performance 面板
- Console 日志
```

### 移动端调试工具
```
- Android Studio Profiler
- Xcode Instruments
- Flipper
- Chrome Remote Debugging
```

## 调试验证模板

```markdown
## Bug 修复报告

### 问题描述
- **现象**: ...
- **影响**: ...
- **复现步骤**: ...

### 根因分析
- **根因**: ...
- **定位过程**: ...
- **相关证据**: ...

### 修复方案
- **修复内容**: ...
- **改动文件**: ...
- **代码diff**: ...

### 验证结果
- [ ] 问题已修复
- [ ] 回归测试通过
- [ ] 性能正常
- [ ] 日志正常

### 后续行动
- [ ] 监控观察
- [ ] 文档更新
- [ ] 经验总结
```

## 相关资源

- `resources/root-cause-analysis.md` - 根因分析方法
- `resources/log-analysis.md` - 日志分析技巧
- `resources/performance-debugging.md` - 性能调试指南

---

**技能状态**: 完成 ✅
**适用场景**: 所有 Bug 调试、问题诊断
