# P1-2 é—®é¢˜ä¿®å¤è¡ŒåŠ¨è®¡åˆ’

> **åˆ›å»ºæ—¥æœŸ**: 2025-12-05  
> **ä¼˜å…ˆçº§**: ğŸ”´ é«˜  
> **é¢„è®¡å·¥æ—¶**: 4-6å°æ—¶  
> **è´Ÿè´£äºº**: å¾…åˆ†é…

---

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**é—®é¢˜**: 3ä¸ªViewModelç›´æ¥ä¾èµ–Repositoryï¼Œè¿åClean ArchitectureåŸåˆ™

**å½±å“èŒƒå›´**:
- [`ChatViewModel.kt`](../app/src/main/java/com/empathy/ai/presentation/viewmodel/ChatViewModel.kt)
- [`ContactDetailViewModel.kt`](../app/src/main/java/com/empathy/ai/presentation/viewmodel/ContactDetailViewModel.kt)
- [`ContactListViewModel.kt`](../app/src/main/java/com/empathy/ai/presentation/viewmodel/ContactListViewModel.kt)

**è¿è§„æ•°é‡**: 8å¤„ç›´æ¥è°ƒç”¨Repository

---

## ğŸ¯ ä¿®å¤ç›®æ ‡

### åŸåˆ™
âœ… ViewModel â†’ UseCase â†’ Repository  
âŒ ViewModel â†’ Repository (ç›´æ¥è°ƒç”¨)

### ç›®æ ‡
1. åˆ›å»º7ä¸ªç¼ºå¤±çš„UseCase
2. é‡æ„3ä¸ªViewModelï¼Œç§»é™¤Repositoryä¾èµ–
3. ç¡®ä¿æ‰€æœ‰ä¸šåŠ¡é€»è¾‘åœ¨UseCaseä¸­
4. ä¿æŒåŠŸèƒ½ä¸å˜

---

## ğŸ“ è¯¦ç»†ä¿®å¤æ­¥éª¤

### Step 1: åˆ›å»ºGetContactUseCase (30åˆ†é’Ÿ)

**æ–‡ä»¶**: `app/src/main/java/com/empathy/ai/domain/usecase/GetContactUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.model.ContactProfile
import com.empathy.ai.domain.repository.ContactRepository
import javax.inject.Inject

/**
 * è·å–å•ä¸ªè”ç³»äººç”¨ä¾‹
 */
class GetContactUseCase @Inject constructor(
    private val contactRepository: ContactRepository
) {
    suspend operator fun invoke(contactId: String): Result<ContactProfile?> {
        return try {
            contactRepository.getProfile(contactId)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

**æµ‹è¯•æ–‡ä»¶**: `app/src/test/java/com/empathy/ai/domain/usecase/GetContactUseCaseTest.kt`

---

### Step 2: åˆ›å»ºGetAllContactsUseCase (30åˆ†é’Ÿ)

**æ–‡ä»¶**: `app/src/main/java/com/empathy/ai/domain/usecase/GetAllContactsUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.model.ContactProfile
import com.empathy.ai.domain.repository.ContactRepository
import kotlinx.coroutines.flow.Flow
import javax.inject.Inject

/**
 * è·å–æ‰€æœ‰è”ç³»äººåˆ—è¡¨ç”¨ä¾‹
 */
class GetAllContactsUseCase @Inject constructor(
    private val contactRepository: ContactRepository
) {
    operator fun invoke(): Flow<List<ContactProfile>> {
        return contactRepository.getAllProfiles()
    }
}
```

---

### Step 3: åˆ›å»ºDeleteContactUseCase (30åˆ†é’Ÿ)

**æ–‡ä»¶**: `app/src/main/java/com/empathy/ai/domain/usecase/DeleteContactUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.repository.ContactRepository
import javax.inject.Inject

/**
 * åˆ é™¤è”ç³»äººç”¨ä¾‹
 */
class DeleteContactUseCase @Inject constructor(
    private val contactRepository: ContactRepository
) {
    suspend operator fun invoke(contactId: String): Result<Unit> {
        return try {
            contactRepository.deleteProfile(contactId)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

---

### Step 4: åˆ›å»ºBrainTagç›¸å…³UseCase (1å°æ—¶)

#### GetBrainTagsUseCase
```kotlin
class GetBrainTagsUseCase @Inject constructor(
    private val brainTagRepository: BrainTagRepository
) {
    operator fun invoke(contactId: String): Flow<List<BrainTag>> {
        return brainTagRepository.getTagsForContact(contactId)
    }
}
```

#### SaveBrainTagUseCase
```kotlin
class SaveBrainTagUseCase @Inject constructor(
    private val brainTagRepository: BrainTagRepository
) {
    suspend operator fun invoke(tag: BrainTag): Result<Long> {
        return try {
            brainTagRepository.saveTag(tag)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

#### DeleteBrainTagUseCase
```kotlin
class DeleteBrainTagUseCase @Inject constructor(
    private val brainTagRepository: BrainTagRepository
) {
    suspend operator fun invoke(tagId: Long): Result<Unit> {
        return try {
            brainTagRepository.deleteTag(tagId)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

---

### Step 5: é‡æ„ChatViewModel (30åˆ†é’Ÿ)

**ä¿®æ”¹æ–‡ä»¶**: `ChatViewModel.kt`

```kotlin
// ä¿®æ”¹å‰
@HiltViewModel
class ChatViewModel @Inject constructor(
    private val analyzeChatUseCase: AnalyzeChatUseCase,
    private val checkDraftUseCase: CheckDraftUseCase,
    private val contactRepository: ContactRepository  // âŒ åˆ é™¤
)

// ä¿®æ”¹å
@HiltViewModel
class ChatViewModel @Inject constructor(
    private val analyzeChatUseCase: AnalyzeChatUseCase,
    private val checkDraftUseCase: CheckDraftUseCase,
    private val getContactUseCase: GetContactUseCase  // âœ… æ·»åŠ 
)

// ä¿®æ”¹loadChatæ–¹æ³•
private fun loadChat(contactId: String) {
    viewModelScope.launch {
        // ä¿®æ”¹å‰
        val profile = contactRepository.getProfile(contactId).getOrNull()  // âŒ
        
        // ä¿®æ”¹å
        val profile = getContactUseCase(contactId).getOrNull()  // âœ…
    }
}
```

---

### Step 6: é‡æ„ContactDetailViewModel (1å°æ—¶)

**ä¿®æ”¹æ–‡ä»¶**: `ContactDetailViewModel.kt`

```kotlin
// ä¿®æ”¹å‰
@HiltViewModel
class ContactDetailViewModel @Inject constructor(
    private val contactRepository: ContactRepository,      // âŒ åˆ é™¤
    private val brainTagRepository: BrainTagRepository,    // âŒ åˆ é™¤
    private val saveProfileUseCase: SaveProfileUseCase
)

// ä¿®æ”¹å
@HiltViewModel
class ContactDetailViewModel @Inject constructor(
    private val getContactUseCase: GetContactUseCase,          // âœ… æ·»åŠ 
    private val deleteContactUseCase: DeleteContactUseCase,    // âœ… æ·»åŠ 
    private val getBrainTagsUseCase: GetBrainTagsUseCase,      // âœ… æ·»åŠ 
    private val saveBrainTagUseCase: SaveBrainTagUseCase,      // âœ… æ·»åŠ 
    private val deleteBrainTagUseCase: DeleteBrainTagUseCase,  // âœ… æ·»åŠ 
    private val saveProfileUseCase: SaveProfileUseCase
)
```

**éœ€è¦ä¿®æ”¹çš„æ–¹æ³•**:
1. `loadContact()` - ç¬¬138è¡Œ
2. `deleteContact()` - ç¬¬269è¡Œ
3. `loadBrainTags()` - ç¬¬420è¡Œ
4. `addBrainTag()` - ç¬¬456è¡Œ
5. `deleteBrainTag()` - ç¬¬474è¡Œ

---

### Step 7: é‡æ„ContactListViewModel (30åˆ†é’Ÿ)

**ä¿®æ”¹æ–‡ä»¶**: `ContactListViewModel.kt`

```kotlin
// ä¿®æ”¹å‰
@HiltViewModel
class ContactListViewModel @Inject constructor(
    private val contactRepository: ContactRepository  // âŒ åˆ é™¤
)

// ä¿®æ”¹å
@HiltViewModel
class ContactListViewModel @Inject constructor(
    private val getAllContactsUseCase: GetAllContactsUseCase,  // âœ… æ·»åŠ 
    private val deleteContactUseCase: DeleteContactUseCase     // âœ… æ·»åŠ 
)
```

**éœ€è¦ä¿®æ”¹çš„æ–¹æ³•**:
1. `loadContacts()` - ç¬¬109è¡Œ
2. `deleteContact()` - ç¬¬311è¡Œ
3. `deleteSelectedContacts()` - ç¬¬337è¡Œ

---

### Step 8: ç¼–å†™å•å…ƒæµ‹è¯• (1.5å°æ—¶)

ä¸ºæ¯ä¸ªæ–°å»ºçš„UseCaseç¼–å†™æµ‹è¯•:
1. GetContactUseCaseTest
2. GetAllContactsUseCaseTest
3. DeleteContactUseCaseTest
4. GetBrainTagsUseCaseTest
5. SaveBrainTagUseCaseTest
6. DeleteBrainTagUseCaseTest

**æµ‹è¯•æ¨¡æ¿**:
```kotlin
class GetContactUseCaseTest {
    
    private lateinit var contactRepository: ContactRepository
    private lateinit var useCase: GetContactUseCase
    
    @Before
    fun setup() {
        contactRepository = mockk()
        useCase = GetContactUseCase(contactRepository)
    }
    
    @Test
    fun `should return contact when repository succeeds`() = runTest {
        // Given
        val expectedContact = ContactProfile(...)
        coEvery { contactRepository.getProfile(any()) } returns 
            Result.success(expectedContact)
        
        // When
        val result = useCase("contact_1")
        
        // Then
        assertTrue(result.isSuccess)
        assertEquals(expectedContact, result.getOrNull())
    }
    
    @Test
    fun `should return failure when repository fails`() = runTest {
        // Given
        coEvery { contactRepository.getProfile(any()) } returns 
            Result.failure(Exception("Not found"))
        
        // When
        val result = useCase("contact_1")
        
        // Then
        assertTrue(result.isFailure)
    }
}
```

---

### Step 9: éªŒè¯ä¸æµ‹è¯• (30åˆ†é’Ÿ)

#### æ£€æŸ¥æ¸…å•
- [ ] æ‰€æœ‰7ä¸ªUseCaseå·²åˆ›å»º
- [ ] æ‰€æœ‰7ä¸ªæµ‹è¯•æ–‡ä»¶å·²åˆ›å»º
- [ ] 3ä¸ªViewModelå·²é‡æ„
- [ ] æ‰€æœ‰Repositoryç›´æ¥è°ƒç”¨å·²ç§»é™¤
- [ ] ç¼–è¯‘é€šè¿‡
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] åŠŸèƒ½æµ‹è¯•æ­£å¸¸

#### éªŒè¯å‘½ä»¤
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./gradlew test

# æ£€æŸ¥ä»£ç è§„èŒƒ
./gradlew ktlintCheck

# ç¼–è¯‘é¡¹ç›®
./gradlew assembleDebug
```

---

## ğŸ“Š å·¥ä½œé‡ä¼°ç®—

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|--------|
| Step 1-3: Contactç›¸å…³UseCase | 1.5å°æ—¶ | P0 |
| Step 4: BrainTagç›¸å…³UseCase | 1å°æ—¶ | P0 |
| Step 5: é‡æ„ChatViewModel | 0.5å°æ—¶ | P0 |
| Step 6: é‡æ„ContactDetailViewModel | 1å°æ—¶ | P0 |
| Step 7: é‡æ„ContactListViewModel | 0.5å°æ—¶ | P0 |
| Step 8: ç¼–å†™å•å…ƒæµ‹è¯• | 1.5å°æ—¶ | P1 |
| Step 9: éªŒè¯ä¸æµ‹è¯• | 0.5å°æ—¶ | P1 |
| **æ€»è®¡** | **6.5å°æ—¶** | - |

---

## âœ… éªŒæ”¶æ ‡å‡†

### ä»£ç è´¨é‡
- [ ] æ‰€æœ‰ViewModelä¸å†ç›´æ¥ä¾èµ–Repository
- [ ] æ‰€æœ‰ä¸šåŠ¡é€»è¾‘åœ¨UseCaseä¸­
- [ ] ä»£ç ç¬¦åˆClean ArchitectureåŸåˆ™
- [ ] éµå¾ªé¡¹ç›®ç¼–ç è§„èŒƒ

### æµ‹è¯•è¦†ç›–
- [ ] 7ä¸ªæ–°UseCaseéƒ½æœ‰å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡

### åŠŸèƒ½éªŒè¯
- [ ] è”ç³»äººåˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
- [ ] è”ç³»äººè¯¦æƒ…æ­£å¸¸ç¼–è¾‘
- [ ] èŠå¤©åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] æ ‡ç­¾ç®¡ç†åŠŸèƒ½æ­£å¸¸
- [ ] æ— å›å½’é—®é¢˜

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

### 1. ä¿æŒåŠŸèƒ½ä¸€è‡´æ€§
- é‡æ„è¿‡ç¨‹ä¸­ä¸è¦æ”¹å˜ç°æœ‰åŠŸèƒ½
- ç¡®ä¿æ‰€æœ‰APIè°ƒç”¨ä¿æŒä¸å˜
- UIè¡Œä¸ºä¿æŒä¸€è‡´

### 2. é”™è¯¯å¤„ç†
- æ‰€æœ‰UseCaseéƒ½è¦æœ‰å¼‚å¸¸å¤„ç†
- ä½¿ç”¨Resultç±»å‹ç»Ÿä¸€è¿”å›
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### 3. æµ‹è¯•è¦æ±‚
- æ¯ä¸ªUseCaseè‡³å°‘2ä¸ªæµ‹è¯•ç”¨ä¾‹(æˆåŠŸ+å¤±è´¥)
- ä½¿ç”¨MockKè¿›è¡ŒMock
- æµ‹è¯•å‘½åæ¸…æ™°

### 4. ä»£ç å®¡æŸ¥
- å®Œæˆåè¿›è¡Œä»£ç å®¡æŸ¥
- ç¡®ä¿ç¬¦åˆé¡¹ç›®è§„èŒƒ
- æ£€æŸ¥æ˜¯å¦æœ‰é—æ¼

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

å®ŒæˆP1-2ä¿®å¤å,å»ºè®®è¿›è¡Œä»¥ä¸‹ä¼˜åŒ–:

### çŸ­æœŸ (1å‘¨å†…)
1. ä¸º3ä¸ªViewModelç¼–å†™å•å…ƒæµ‹è¯•
2. å®Œå–„UseCaseçš„å¼‚å¸¸å¤„ç†
3. æ·»åŠ æ—¥å¿—è®°å½•

### ä¸­æœŸ (1æœˆå†…)
1. æ·»åŠ æ€§èƒ½ç›‘æ§
2. ä¼˜åŒ–UseCaseçš„ç¼“å­˜ç­–ç•¥
3. å®ç°ç¦»çº¿åŠŸèƒ½æ”¯æŒ

### é•¿æœŸ
1. è€ƒè™‘å¼•å…¥å¤šæ¨¡å—æ¶æ„
2. å®ç°CQRSæ¨¡å¼
3. æ·»åŠ æ›´å¤šåˆ†ææŒ‡æ ‡

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜,è¯·è”ç³»:
- é¡¹ç›®è´Ÿè´£äºº: hushaokang
- æ¶æ„å¸ˆ: [å¾…æŒ‡å®š]
- æŠ€æœ¯æ”¯æŒ: å¼€å‘å›¢é˜Ÿ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-12-05  
**çŠ¶æ€**: å¾…æ‰§è¡Œ