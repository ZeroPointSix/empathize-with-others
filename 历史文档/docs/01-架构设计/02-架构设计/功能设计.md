---
标题: 功能设计
版本: v2.0
创建日期: 2025-12-08
最后更新: 2025-12-08
更新人: AI Assistant
状态: 活跃
标签: [架构设计, 功能设计, MVP]
相关文档: [整体架构.md, 领域层设计/README.md, 表现层设计/README.md]
---

# 功能设计

---

## 📋 核心设计哲学

### 1. "多渠道喂养，结构化记忆"
用户通过导入文本、音频、视频等多模态数据，AI 在后台将其清洗为**"客观事实 (Facts)"**和**"主观策略 (Tags)"**两类数据，存入本地大脑。

### 2. "本地优先，云端增强"
- **高频操作（实时检查）**优先走本地规则，零延迟、零成本
- **低频操作（深度分析）**走云端大模型，高智能

### 3. "辅助而非替代"
AI 提供策略卡片和草稿润色，但最终发送权永远在用户手中。

---

## 🧠 模块一：核心大脑 (The Brain) - 学习与记忆

**目标：** 构建一个属于该联系人的专属知识库，解决"记不住"和"不懂他"的问题。

### 1.1 数据喂养机制 (The Feeder)

用户在联系人详情页点击 `[+] 数据喂养`，触发以下流程：

#### A. `[✍️ 手动记录]` (最高权重)

- **输入：** 用户直接添加标签（如"雷区：不要提钱"）或事实（如"事实：他有一只猫"）
- **逻辑：** 标记来源为 `MANUAL`，AI 在后续分析中**绝对遵从**，不可覆盖

#### B. `[📄 导入聊天记录]` (文本分析)

- **输入：** 粘贴文本 或 导入 `.txt` / `.csv`
- **逻辑：**
    1. **脱敏：** 本地正则替换敏感信息
    2. **分析：** 发送给 LLM，指令："提取性格特征、潜在雷区、和新出现的事实信息"
    3. **入库：** 生成 `AI_INFERRED` 标签，需用户在"新发现"列表中**[确认]**后生效

#### C. `[🎬/🎧 媒体文件分析]` (多模态)

- **输入：** `.mp3` (语音) 或 `.mp4` (视频)
- **逻辑：**
    1. **本地预判：** 检查文件是否包含音轨
    2. **分流处理：**
        - _有声：_ 提取音频 -> 云端 STT (语音转文字) -> 文本分析流程
        - _无声/录屏：_ 提取关键帧 (每5秒一张) -> 云端 Vision (视觉分析) -> 文本分析流程
    3. **结果：** 提取出的信息归档入库，原始大文件处理后**即刻丢弃**，不占用存储

### 1.2 记忆存储结构 (The Schema)

数据库层面分为两类存储，解决逻辑冲突问题：

#### 1. 客观画像 (ContactProfile - Facts Map)

- 存储不可变或客观的事实
- _示例：_ `{"电话": "138...", "住址": "朝阳区", "爱好": "钓鱼", "性格": "吃软不吃硬"}`
- _更新逻辑：_ 新事实追加，冲突事实需用户确认

#### 2. 策略锦囊 (BrainTags)

- 存储用于决策的红绿灯规则
- **`[🔴 RISK_RED]` (雷区):** 绝对禁止的话题 (e.g., "前任", "借钱")
- **`[🟢 STRATEGY_GREEN]` (策略):** 建议切入点 (e.g., "夸衣品", "聊猫")

---

## 🛡️ 模块二：实时辅助 (The Service) - 交互与应用

### 2.1 "被动守护"模式 (防踩雷 / Gatekeeper)

**修订重点：** 放弃"实时云端监测"，改为"双层漏斗"机制，确保流畅性与隐私。

#### 触发机制
- 用户在输入框输入文本时

#### Layer 1: 本地极速拦截 (Local Fast Match)

- **机制：** 监听输入内容，实时匹配本地 `RISK_RED` 标签库
- **延迟：** < 10ms (零网络消耗)
- **反馈：** 若命中关键词（如"借钱"），悬浮球变红并震动，提示"命中雷区：不要提钱"

#### Layer 2: 云端语义复核 (Cloud Semantic Check) - _可选/按需_

- **机制：** 仅当用户**停留超过 1.5秒** 或 **手动点击"检查"** 时触发
- **逻辑：** 将草稿发送给 AI，判断语义风险（如"手头紧" = "借钱"）
- **反馈：** 若 AI 判定有风险，弹出黄色警告卡

### 2.2 "主动求助"模式 (AI 军师 / Analyst)

#### 触发机制
- 用户点击悬浮窗 `[💡 帮我分析]`

#### 核心流程 (RAG)

1. **抓取：** 读取屏幕最近 `N` 条上下文（滚动抓取）
2. **组装：** 拼接 `[脱敏上下文]` + `[Facts事实]` + `[Tags策略]`
3. **推理：** 调用大模型生成 JSON 结果

#### UI 展示 (AI 策略卡)

- **状态分析：** 对方当前情绪（焦虑/开心/防御）
- **核心洞察：** "他正在试探你的底线。"
- **回复建议：** 提供 A/B 两套话术（保守型 vs 进取型）

### 2.3 交互细节：填充与润色

解决"覆盖冲突"问题：

#### 场景
- 用户点击建议回复的 `[↗️ 填充]` 按钮

#### 逻辑

1. **检测：** 检查原生输入框是否为空
2. **Case A (为空):** 直接插入文本，光标置于末尾
3. **Case B (不为空):**
    - 弹出微交互菜单：`[覆盖]` 或 `[追加]`
    - 或者：仅复制到剪贴板并 Toast 提示"已复制，请手动粘贴以防覆盖草稿"

---

## 📋 模块三：非功能性需求 (NFR)

### 1. 隐私脱敏 (Privacy)

- 所有发送给云端 AI 的文本（无论是分析还是训练），必须先经过 **PrivacyEngine** 处理
- 正则屏蔽：手机号、身份证、邮箱
- 字典屏蔽：将联系人真实姓名替换为占位符 (e.g., `[Target_User]`)

### 2. 网络与成本 (Performance)

- **被动模式** 必须 99% 依赖本地逻辑
- **主动模式** 的 API 请求超时设为 5秒，超时自动降级提示"网络波动"

---

## 🎯 核心功能流程

### 1️⃣ 主动分析 (AI 军师)

**功能**: 点击 [💡 帮我分析] 按钮，AI 根据聊天上下文和联系人画像提供策略建议

**输入**:
- 当前聊天记录（自动抓取）
- 联系人画像（事实、雷区、策略）
- 用户的长期目标

**输出**:
```
💭 AI 军师分析

【对方状态】
情绪: 略显沮丧
原因: 钓鱼没有收获

【关键洞察】
• 对方热爱钓鱼（匹配画像）
• 避免提及金钱话题（雷区）

【建议回复】
"没事的，钓鱼本来就看运气。
你今天穿的这身衣服真不错！"

[复制] [填充]
```

### 2️⃣ 主动风控 (防踩雷)

**功能**: 点击 [🛡️ 帮我检查] 按钮，实时检测输入内容是否触发雷区

**检测机制**:
- **Layer 1**: 本地关键词匹配（< 500ms）
- **Layer 2**: 云端语义检查（可选，< 3s）

**示例**:

输入: "今晚能借钱吗？"
```
⚠️ 检测到风险！

命中雷区: 不要提钱

建议: 删除敏感内容
```

输入: "今晚一起吃饭？"
```
✅ 检查通过！
未发现风险内容
```

### 3️⃣ 数据喂养 (智能提取)

**功能**: 从文本或媒体文件中自动提取联系人信息

**支持格式**:
- 📝 文本: 直接粘贴聊天记录
- 🎵 音频: .mp3 (ASR 转录)
- 🎬 视频: .mp4 (音频提取 + OCR)

**提取内容**:
- 📋 事实信息: 姓名、住址、爱好等
- 🔴 雷区: 不喜欢的话题
- 🟢 策略: 沟通建议

**示例**:

输入文本:
```
他叫李四，住朝阳区，爱好钓鱼。
不喜欢吃香菜，不要提钱。
多夸他衣品好。
```

AI 提取:
```
【事实】住址: 朝阳区, 爱好: 钓鱼
【雷区】不吃香菜, 不要提钱
【策略】多夸他衣品好
```

---

## 🔧 技术实现要点

### 1. 屏幕抓取技术

**挑战**: 如何获取屏幕外（历史）聊天记录？

**解决方案**:
1. 使用 AccessibilityService 遍历当前窗口节点
2. 提取所有 TextView 内容及坐标
3. 若条数不足，寻找可滚动节点执行滚动操作
4. 根据文本内容和坐标进行去重合并

### 2. 悬浮窗与 Compose 集成

**挑战**: Compose 通常依赖 Activity，但悬浮窗需在 Service 中运行

**解决方案**:
1. 使用 ComposeView 桥接 WindowManager
2. 手动管理生命周期
3. 设置 `DisposeOnViewTreeLifecycleDestroyed` 防止内存泄漏

### 3. 多模态数据处理

**音频处理**:
```bash
ffmpeg -i input.mp4 -vn -acodec libmp3lame output.mp3
```

**关键帧提取**:
```bash
ffmpeg -i input.mp4 -vf fps=1/5 frame_%03d.jpg
```

---

## 📊 性能指标

### 响应时间目标

| 操作 | 目标时间 | 说明 |
|------|----------|------|
| 本地雷区检测 | < 10ms | 关键词匹配 |
| 云端语义检查 | < 3s | AI 分析 |
| 聊天上下文抓取 | < 2s | 滚动抓取 |
| AI 军师分析 | < 10s | 完整流程 |
| 媒体文件处理 | < 30s | 取决于文件大小 |

### 资源使用目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 内存占用 | < 200MB | 正常使用状态 |
| CPU 使用 | < 20% | 空闲状态 |
| 网络流量 | < 1MB/天 | 仅 AI 请求 |
| 存储空间 | < 100MB | 本地数据缓存 |

---

## 🔄 数据流架构

### RAG (Retrieval-Augmented Generation) 流程

```
联系人画像 (Profile)
    ↓
雷区 & 策略 (BrainTags)
    ↓
聊天上下文 (Messages)
    ↓
Prompt 拼装
    ↓
隐私脱敏
    ↓
AI 推理
    ↓
结构化输出 (AnalysisResult)
```

### 数据存储结构

```kotlin
// 联系人画像
@Entity(tableName = "profiles")
data class ContactProfile(
    @PrimaryKey val id: String, 
    val name: String, 
    val targetGoal: String, // 长期目标
    val facts: Map<String, String> = emptyMap(), // 事实信息
    val contextDepth: Int = 10 
)

// 策略与雷区
@Entity(tableName = "brain_tags")
data class BrainTag(
    @PrimaryKey(autoGenerate = true) val id: Long = 0,
    val contactId: String,
    val type: String, // "RED"(雷区), "GREEN"(策略)
    val content: String, // e.g., "不喜欢被问薪资"
    val source: String, // "MANUAL" or "AI_AUTO"
    val confidence: Float = 1.0f, // 置信度
    val createdAt: Long = System.currentTimeMillis()
)
```

---

## 🎨 UI/UX 设计原则

### 1. 无干扰设计

- 悬浮窗在非激活状态下最小化
- 检测到风险时使用非侵入式提示
- 避免频繁弹窗打断用户

### 2. 快速响应

- 本地操作零延迟
- 云端操作提供进度指示
- 支持离线基础功能

### 3. 隐私透明

- 明确显示哪些数据会被发送
- 提供数据脱敏预览
- 支持一键清除敏感数据

---

## 🔮 未来扩展规划

### 短期优化 (1-3个月)

- 智能标签推荐算法优化
- 多语言支持
- 更多 AI 模型集成

### 中期规划 (3-6个月)

- 群聊场景支持
- 情绪分析增强
- 个性化推荐系统

### 长期愿景 (6-12个月)

- 跨平台支持
- 知识图谱构建
- 智能对话生成

---

## 📝 设计决策记录

### ADR-001: 双层风险检测机制

**状态**: 已接受
**日期**: 2025-12-02

**问题**: 如何平衡实时性和隐私性进行风险检测？

**决策**: 采用双层检测机制
- Layer 1: 本地关键词匹配（零延迟）
- Layer 2: 云端语义分析（按需触发）

**后果**: 
- ✅ 保证了实时响应
- ✅ 减少了网络请求
- ✅ 保护了用户隐私
- ⚠️ 可能遗漏语义层面的风险

### ADR-002: 数据来源权重

**状态**: 已接受
**日期**: 2025-12-02

**问题**: 如何处理手动输入和 AI 推断的冲突？

**决策**: 手动输入具有最高优先级，AI 推断需要用户确认

**后果**:
- ✅ 确保了用户意图的准确性
- ✅ 避免了 AI 误判的影响
- ⚠️ 增加了用户的确认成本

---

**最后更新**: 2025-12-08  
**维护者**: 产品团队  
**版本**: v2.0