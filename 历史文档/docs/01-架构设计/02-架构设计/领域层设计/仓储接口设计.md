---
æ ‡é¢˜: ä»“å‚¨æ¥å£è®¾è®¡
ç‰ˆæœ¬: v2.0
åˆ›å»ºæ—¥æœŸ: 2025-12-08
æœ€åæ›´æ–°: 2025-12-08
æ›´æ–°äºº: AI Assistant
çŠ¶æ€: æ´»è·ƒ
æ ‡ç­¾: [é¢†åŸŸå±‚è®¾è®¡, ä»“å‚¨æ¥å£, Repository]
ç›¸å…³æ–‡æ¡£: [å®ä½“è®¾è®¡.md, ä¸šåŠ¡é€»è¾‘è®¾è®¡.md, ../æ•°æ®å±‚è®¾è®¡/README.md]
---

# ä»“å‚¨æ¥å£è®¾è®¡

---

## ğŸ“‹ è®¾è®¡åŸåˆ™

### 1. ç»Ÿä¸€é”™è¯¯å¤„ç†
æ‰€æœ‰ I/O æ“ä½œï¼ˆæ•°æ®åº“ã€ç½‘ç»œï¼‰çš„è¿”å›å€¼åŒ…è£¹åœ¨ `Result<T>` ä¸­ï¼Œä»¥ä¾¿ ViewModel å±‚å¤„ç†å¼‚å¸¸ã€‚

### 2. ç»†åŒ–é£æ§æ¥å£
`checkDraftSafety` ä¸å†åªè¿”å› Booleanï¼Œè€Œæ˜¯è¿”å›åŒ…å«å…·ä½“è§¦å‘å…³é”®è¯çš„è¯¦ç»†å¯¹è±¡ï¼Œä»¥æ”¯æŒ UI çš„"çº¢æ¡†+éœ‡åŠ¨"å…·ä½“åé¦ˆã€‚

### 3. ä¼˜åŒ–äº‹å®æ›´æ–°
åœ¨ `ContactRepository` ä¸­å¢åŠ äº†å•ç‹¬æ›´æ–° Facts çš„æ¥å£ï¼Œæ–¹ä¾¿"æ•°æ®å–‚å…»"æ¨¡å—é«˜æ•ˆå†™å…¥ã€‚

### 4. å¢å¼ºé…ç½®çµæ´»æ€§
`SettingsRepository` å¢åŠ äº† Header è·å–æ¥å£ï¼Œä»¥é€‚åº”ä¸åŒ AI æœåŠ¡å•†çš„é‰´æƒå·®å¼‚ã€‚

---

## ğŸ”Œ ç¬¬ä¸€ç»„ï¼šæ ¸å¿ƒä¸šåŠ¡æ•°æ®æ¥å£ (Business Data)

æ­¤ç±»æ¥å£ç›´æ¥æ“ä½œ Room æ•°æ®åº“ (DAO)ï¼Œç®¡ç†æ ¸å¿ƒå®ä½“ã€‚

### 1. `ContactRepository` (è§’è‰²å¡ä»“åº“)

**æœåŠ¡å¯¹è±¡ï¼š** è”ç³»äººåˆ—è¡¨ã€ç”»åƒè¯¦æƒ…ã€RAG ä¸Šä¸‹æ–‡æ„å»ºã€‚

**ä¼˜åŒ–ç‚¹ï¼š** å¢åŠ äº† `updateContactFacts`ï¼Œé¿å…åœ¨"è‡ªåŠ¨æå–æ ‡ç­¾"åœºæ™¯ä¸‹å¿…é¡»è¯»å–å®Œæ•´å¯¹è±¡æ‰èƒ½æ›´æ–°çš„ä½æ•ˆæ“ä½œã€‚

```kotlin
interface ContactRepository {
    // [UIç”¨] é¦–é¡µåˆ—è¡¨æ¸²æŸ“ã€‚Flow ä¿è¯æ•°æ®åº“å˜åŠ¨å³åˆ·æ–° UI
    fun getAllProfiles(): Flow<List<ContactProfile>>

    // [ä¸šåŠ¡ç”¨] æ‹¼ Prompt æ—¶è¯»å–å•ä¸ªç”»åƒ
    suspend fun getProfile(id: String): Result<ContactProfile?>

    // [ä¸šåŠ¡ç”¨] åˆ›å»ºæˆ–å®Œå…¨è¦†ç›–ä¸€ä¸ªç”»åƒ
    suspend fun saveProfile(profile: ContactProfile): Result<Unit>

    // [æ•°æ®å–‚å…»ç”¨] ä»…è¿½åŠ æˆ–æ›´æ–°äº‹å®å­—æ®µ (å¢é‡æ›´æ–°)
    // åœºæ™¯ï¼šAI ä»èŠå¤©è®°å½•ä¸­åˆ†æå‡ºäº†æ–°çˆ±å¥½ï¼Œåªéœ€å­˜å…¥ {"çˆ±å¥½": "æ»‘é›ª"}
    suspend fun updateContactFacts(contactId: String, newFacts: Map<String, String>): Result<Unit>

    // [ç®¡ç†ç”¨] åˆ é™¤è”ç³»äºº
    suspend fun deleteProfile(id: String): Result<Unit>

    // [æœç´¢ç”¨] æ ¹æ®åç§°æœç´¢è”ç³»äºº
    suspend fun searchProfiles(query: String): Result<List<ContactProfile>>

    // [ç»Ÿè®¡ç”¨] è·å–è”ç³»äººæ•°é‡
    suspend fun getProfileCount(): Result<Int>
}
```

#### æ–¹æ³•è¯´æ˜

| æ–¹æ³• | ç”¨é€” | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|------|----------|------|
| `getAllProfiles()` | è·å–æ‰€æœ‰è”ç³»äºº | `Flow<List<ContactProfile>>` | å“åº”å¼æ•°æ®æµï¼ŒUI è‡ªåŠ¨æ›´æ–° |
| `getProfile(id)` | è·å–å•ä¸ªè”ç³»äºº | `Result<ContactProfile?>` | ç”¨äºè¯¦ç»†é¡µé¢å’Œåˆ†æ |
| `saveProfile(profile)` | ä¿å­˜è”ç³»äºº | `Result<Unit>` | åˆ›å»ºæˆ–æ›´æ–°å®Œæ•´ç”»åƒ |
| `updateContactFacts()` | æ›´æ–°äº‹å®ä¿¡æ¯ | `Result<Unit>` | å¢é‡æ›´æ–°ï¼Œé«˜æ•ˆæ“ä½œ |
| `deleteProfile(id)` | åˆ é™¤è”ç³»äºº | `Result<Unit>` | çº§è”åˆ é™¤ç›¸å…³æ•°æ® |
| `searchProfiles(query)` | æœç´¢è”ç³»äºº | `Result<List<ContactProfile>>` | æ”¯æŒæ¨¡ç³Šæœç´¢ |
| `getProfileCount()` | è·å–æ•°é‡ | `Result<Int>` | ç”¨äºç»Ÿè®¡å’Œåˆ†é¡µ |

---

### 2. `BrainTagRepository` (å†›å¸ˆç­–ç•¥ä»“åº“)

**æœåŠ¡å¯¹è±¡ï¼š** å®æ—¶é£æ§æ£€æµ‹ã€ç­–ç•¥åˆ†æã€‚

```kotlin
interface BrainTagRepository {
    // [ä¸šåŠ¡ç”¨] RAG æ ¸å¿ƒï¼šè·å–æŸäººçš„æ‰€æœ‰"é”¦å›Š" (Flow å®æ—¶ç›‘å¬)
    fun getTagsForContact(contactId: String): Flow<List<BrainTag>>

    // [é£æ§ç”¨] è·å–å…¨åº“çš„é›·åŒºï¼ˆç”¨äºå…¨å±€é£æ§ï¼Œæˆ–è€…æ— ç‰¹å®šè”ç³»äººæ—¶çš„é€šç”¨æ£€æµ‹ï¼‰
    suspend fun getAllRedFlags(): Result<List<BrainTag>>

    // [æ•°æ®å–‚å…»] AI åˆ†æå‡ºæ–°ç­–ç•¥/ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ 
    suspend fun saveTag(tag: BrainTag): Result<Long> // è¿”å›æ–°æ’å…¥çš„ ID

    // [UIç”¨] ç”¨æˆ·æ‰‹åŠ¨åˆ æ‰ä¸å‡†çš„æ ‡ç­¾
    suspend fun deleteTag(id: Long): Result<Unit>

    // [æ›´æ–°ç”¨] ä¿®æ”¹æ ‡ç­¾å†…å®¹æˆ–ç½®ä¿¡åº¦
    suspend fun updateTag(tag: BrainTag): Result<Unit>

    // [æ‰¹é‡ç”¨] æ‰¹é‡ä¿å­˜æ ‡ç­¾ï¼ˆAI åˆ†æç»“æœï¼‰
    suspend fun saveTags(tags: List<BrainTag>): Result<List<Long>>

    // [æŸ¥è¯¢ç”¨] æ ¹æ®ç±»å‹è·å–æ ‡ç­¾
    suspend fun getTagsByType(contactId: String, type: TagType): Result<List<BrainTag>>
}
```

#### æ–¹æ³•è¯´æ˜

| æ–¹æ³• | ç”¨é€” | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|------|----------|------|
| `getTagsForContact()` | è·å–è”ç³»äººæ ‡ç­¾ | `Flow<List<BrainTag>>` | å“åº”å¼æ•°æ®æµ |
| `getAllRedFlags()` | è·å–æ‰€æœ‰é›·åŒº | `Result<List<BrainTag>>` | ç”¨äºå…¨å±€é£æ§ |
| `saveTag(tag)` | ä¿å­˜å•ä¸ªæ ‡ç­¾ | `Result<Long>` | è¿”å›æ–° ID |
| `deleteTag(id)` | åˆ é™¤æ ‡ç­¾ | `Result<Unit>` | ç”¨æˆ·åˆ é™¤ä¸å‡†ç¡®æ ‡ç­¾ |
| `updateTag(tag)` | æ›´æ–°æ ‡ç­¾ | `Result<Unit>` | ä¿®æ”¹å†…å®¹æˆ–ç½®ä¿¡åº¦ |
| `saveTags(tags)` | æ‰¹é‡ä¿å­˜ | `Result<List<Long>>` | AI åˆ†æç»“æœæ‰¹é‡å…¥åº“ |
| `getTagsByType()` | æŒ‰ç±»å‹æŸ¥è¯¢ | `Result<List<BrainTag>>` | è·å–ç‰¹å®šç±»å‹æ ‡ç­¾ |

---

## ğŸ”§ ç¬¬äºŒç»„ï¼šåŸºç¡€è®¾æ–½æ¥å£ (Infrastructure)

æ­¤ç±»æ¥å£ç®¡ç†åº”ç”¨é…ç½®ã€éšç§å­—å…¸ï¼Œé€šå¸¸å¯¹æ¥ `EncryptedSharedPreferences` æˆ–æœ¬åœ°æ–‡ä»¶ã€‚

### 3. `SettingsRepository` (å…¨å±€é…ç½®ä»“åº“)

**æœåŠ¡å¯¹è±¡ï¼š** ç½‘ç»œæ¨¡å— (NetworkModule)ã€è®¾ç½®é¡µé¢ã€‚

**ä¼˜åŒ–ç‚¹ï¼š** å¢åŠ  `getProviderHeaders` ä»¥æ”¯æŒ BYOK æ¨¡å¼ä¸‹ä¸åŒå‚å•†çš„ç‰¹æ®Š Header éœ€æ±‚ã€‚

```kotlin
interface SettingsRepository {
    // è·å–/ä¿å­˜ API Key (åŠ å¯†å­˜å‚¨)
    suspend fun getApiKey(): Result<String?>
    suspend fun saveApiKey(key: String): Result<Unit>

    // åˆ‡æ¢æ¨¡å‹æœåŠ¡å•† (OpenAI / DeepSeek / Claude)
    suspend fun getAiProvider(): Result<String>
    suspend fun saveAiProvider(provider: String): Result<Unit>

    // è·å– BaseUrl (ç”¨äº Retrofit åŠ¨æ€æ³¨å…¥)
    suspend fun getBaseUrl(): Result<String>

    // [æ–°] è·å–ç‰¹å®šæœåŠ¡å•†éœ€è¦çš„ Headers (e.g. {"Authorization": "Bearer...", "HTTP-Referer": "..."})
    suspend fun getProviderHeaders(): Result<Map<String, String>>

    // è·å–/ä¿å­˜ç”¨æˆ·åå¥½è®¾ç½®
    suspend fun getPreferences(): Result<Map<String, Any>>
    suspend fun savePreferences(prefs: Map<String, Any>): Result<Unit>

    // è·å–/ä¿å­˜åº”ç”¨é…ç½®
    suspend fun getAppConfig(): Result<AppConfig>
    suspend fun saveAppConfig(config: AppConfig): Result<Unit>
}
```

#### æ–¹æ³•è¯´æ˜

| æ–¹æ³• | ç”¨é€” | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|------|----------|------|
| `getApiKey()` | è·å– API Key | `Result<String?>` | åŠ å¯†å­˜å‚¨çš„å¯†é’¥ |
| `saveApiKey(key)` | ä¿å­˜ API Key | `Result<Unit>` | ç¡¬ä»¶çº§åŠ å¯† |
| `getAiProvider()` | è·å– AI æœåŠ¡å•† | `Result<String>` | OpenAI/DeepSeek ç­‰ |
| `saveAiProvider()` | ä¿å­˜ AI æœåŠ¡å•† | `Result<Unit>` | åˆ‡æ¢æœåŠ¡å•† |
| `getBaseUrl()` | è·å–åŸºç¡€ URL | `Result<String>` | åŠ¨æ€ç½‘ç»œé…ç½® |
| `getProviderHeaders()` | è·å–è¯·æ±‚å¤´ | `Result<Map<String, String>>` | æœåŠ¡å•†ç‰¹å®šé…ç½® |
| `getPreferences()` | è·å–ç”¨æˆ·åå¥½ | `Result<Map<String, Any>>` | ç”¨æˆ·ä¸ªæ€§åŒ–è®¾ç½® |
| `savePreferences()` | ä¿å­˜ç”¨æˆ·åå¥½ | `Result<Unit>` | æŒä¹…åŒ–åå¥½ |
| `getAppConfig()` | è·å–åº”ç”¨é…ç½® | `Result<AppConfig>` | åº”ç”¨çº§é…ç½® |
| `saveAppConfig()` | ä¿å­˜åº”ç”¨é…ç½® | `Result<Unit>` | æ›´æ–°é…ç½® |

---

### 4. `PrivacyRepository` (éšç§è§„åˆ™ä»“åº“)

**æœåŠ¡å¯¹è±¡ï¼š** `PrivacyEngine` (è„±æ•å¼•æ“)ã€‚

```kotlin
interface PrivacyRepository {
    // è·å–æ‰€æœ‰æ˜ å°„è§„åˆ™ (ç”¨äºæ„é€ æ­£åˆ™æ›¿æ¢å™¨)
    // Map: {"çœŸå®å§“å" : "[NAME_01]", "æ‰‹æœºå·" : "[PHONE_01]"}
    suspend fun getPrivacyMapping(): Result<Map<String, String>>

    // æ·»åŠ æ–°è§„åˆ™ (ç”¨æˆ·æ‰‹åŠ¨æ ‡è®°æˆ–è‡ªåŠ¨è¯†åˆ«)
    suspend fun addRule(original: String, mask: String): Result<Unit>

    // ç§»é™¤è§„åˆ™
    suspend fun removeRule(original: String): Result<Unit>

    // è·å–æ‰€æœ‰éšç§è§„åˆ™
    suspend fun getAllRules(): Result<List<PrivacyRule>>

    // æ‰¹é‡æ·»åŠ è§„åˆ™
    suspend fun addRules(rules: Map<String, String>): Result<Unit>

    // æ¸…ç©ºæ‰€æœ‰è§„åˆ™
    suspend fun clearAllRules(): Result<Unit>
}
```

#### æ–¹æ³•è¯´æ˜

| æ–¹æ³• | ç”¨é€” | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|------|----------|------|
| `getPrivacyMapping()` | è·å–æ˜ å°„è§„åˆ™ | `Result<Map<String, String>>` | ç”¨äºè„±æ•å¼•æ“ |
| `addRule()` | æ·»åŠ å•æ¡è§„åˆ™ | `Result<Unit>` | ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ  |
| `removeRule()` | åˆ é™¤å•æ¡è§„åˆ™ | `Result<Unit>` | ç§»é™¤ä¸éœ€è¦çš„è§„åˆ™ |
| `getAllRules()` | è·å–æ‰€æœ‰è§„åˆ™ | `Result<List<PrivacyRule>>` | è§„åˆ™åˆ—è¡¨å±•ç¤º |
| `addRules()` | æ‰¹é‡æ·»åŠ è§„åˆ™ | `Result<Unit>` | AI åˆ†æç»“æœæ‰¹é‡å¯¼å…¥ |
| `clearAllRules()` | æ¸…ç©ºæ‰€æœ‰è§„åˆ™ | `Result<Unit>` | é‡ç½®éšç§é…ç½® |

---

## ğŸŒ ç¬¬ä¸‰ç»„ï¼šå¤–éƒ¨æœåŠ¡æ¥å£ (External Services)

æ­¤ç±»æ¥å£å¯¹æ¥ç½‘ç»œè¯·æ±‚æˆ–è€—æ—¶çš„æœ¬åœ° AI è¿ç®—ï¼Œæ˜¯ App çš„"å¤§è„‘è¿æ¥å™¨"ã€‚

### 5. `AiRepository` (å¤§è„‘è¿æ¥å™¨)

**æœåŠ¡å¯¹è±¡ï¼š** `AnalyzeChatUseCase`, `CheckDraftUseCase`, `ImportMediaUseCase`.

**ä¼˜åŒ–ç‚¹ï¼š** è¿”å›å€¼æ›´åŠ ç»“æ„åŒ–ï¼Œæ”¯æŒè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œé£æ§è¯¦æƒ…ã€‚

```kotlin
interface AiRepository {
    // [åŠŸèƒ½ A] å¸®æˆ‘åˆ†æ (é‡è¾…åŠ©)
    // å…¥å‚ï¼šæ„å»ºå¥½çš„ Prompt (å·²åŒ…å«è„±æ•åçš„ä¸Šä¸‹æ–‡ + ç›®æ ‡ + ç”»åƒ)
    // è¿”å›ï¼šåŒ…å«å»ºè®®å›å¤ã€å¿ƒç†åˆ†æã€é£é™©ç­‰çº§çš„ç»“æ„ä½“
    suspend fun analyzeChat(
        promptContext: String,
        systemInstruction: String 
    ): Result<AnalysisResult>

    // [åŠŸèƒ½ B] å¸®æˆ‘æ£€æŸ¥ (è½»è¾…åŠ©/é˜²è¸©é›·)
    // å…¥å‚ï¼šç”¨æˆ·æ­£åœ¨è¾“å…¥çš„è‰ç¨¿ + ç›¸å…³çš„é›·åŒºæ ‡ç­¾åˆ—è¡¨(æ–‡æœ¬å½¢å¼)
    // è¿”å›ï¼šè¯¦ç»†çš„å®‰å…¨æ£€æŸ¥ç»“æœ (è§ä¸‹æ–‡ SafetyCheckResult å®šä¹‰)
    suspend fun checkDraftSafety(
        draft: String,
        riskRules: List<String> 
    ): Result<SafetyCheckResult>

    // [åŠŸèƒ½ C] å¤šæ¨¡æ€è½¬æ–‡å­— (STT / OCR)
    // å…¥å‚ï¼šåª’ä½“æ–‡ä»¶è·¯å¾„
    // è¿”å›ï¼šè½¬å½•åçš„çº¯æ–‡æœ¬
    suspend fun transcribeMedia(mediaFilePath: String): Result<String>

    // [åŠŸèƒ½ D] æ–‡æœ¬ä¿¡æ¯æå–
    // å…¥å‚ï¼šåŸå§‹æ–‡æœ¬å†…å®¹
    // è¿”å›ï¼šæå–çš„äº‹å®ã€é›·åŒºã€ç­–ç•¥
    suspend fun extractInfoFromText(text: String): Result<ExtractionResult>

    // [åŠŸèƒ½ E] å¥åº·æ£€æŸ¥
    // æ£€æŸ¥ API è¿æ¥çŠ¶æ€å’Œé…ç½®
    suspend fun healthCheck(): Result<HealthStatus>
}
```

#### æ–¹æ³•è¯´æ˜

| æ–¹æ³• | ç”¨é€” | è¿”å›ç±»å‹ | è¯´æ˜ |
|------|------|----------|------|
| `analyzeChat()` | èŠå¤©åˆ†æ | `Result<AnalysisResult>` | AI å†›å¸ˆæ ¸å¿ƒåŠŸèƒ½ |
| `checkDraftSafety()` | è‰ç¨¿å®‰å…¨æ£€æŸ¥ | `Result<SafetyCheckResult>` | å®æ—¶é£æ§æ£€æµ‹ |
| `transcribeMedia()` | åª’ä½“è½¬å½• | `Result<String>` | è¯­éŸ³/è§†é¢‘è½¬æ–‡å­— |
| `extractInfoFromText()` | æ–‡æœ¬ä¿¡æ¯æå– | `Result<ExtractionResult>` | æ•°æ®å–‚å…»æ ¸å¿ƒ |
| `healthCheck()` | å¥åº·æ£€æŸ¥ | `Result<HealthStatus>` | æœåŠ¡çŠ¶æ€æ£€æŸ¥ |

---

## ğŸ“Š ç¬¬å››ç»„ï¼šè¾…åŠ©æ•°æ®æ¥å£ (Auxiliary Data)

### 6. `ChatHistoryRepository` (èŠå¤©å†å²ä»“åº“)

**æœåŠ¡å¯¹è±¡ï¼š** ä¸Šä¸‹æ–‡æ„å»ºã€å†å²è®°å½•ç®¡ç†ã€‚

```kotlin
interface ChatHistoryRepository {
    // ä¿å­˜èŠå¤©æ¶ˆæ¯
    suspend fun saveMessage(message: ChatMessage): Result<Long>

    // è·å–è”ç³»äººçš„æœ€è¿‘æ¶ˆæ¯
    suspend fun getRecentMessages(contactId: String, limit: Int = 10): Result<List<ChatMessage>>

    // è·å–æ¶ˆæ¯æµ (å®æ—¶ç›‘å¬)
    fun getMessageStream(contactId: String): Flow<List<ChatMessage>>

    // åˆ é™¤è¿‡æœŸæ¶ˆæ¯
    suspend fun deleteOldMessages(beforeTimestamp: Long): Result<Int>

    // æ¸…ç©ºè”ç³»äººæ¶ˆæ¯
    suspend fun clearMessagesForContact(contactId: String): Result<Unit>

    // æœç´¢æ¶ˆæ¯
    suspend fun searchMessages(contactId: String, query: String): Result<List<ChatMessage>>
}
```

---

## ğŸ“ é™„å½•ï¼šæ–°å¢/ä¿®æ”¹çš„æ•°æ®æ¨¡å‹ (DTOs)

ä¸ºäº†é…åˆä¸Šè¿°æ¥å£ä¼˜åŒ–ï¼Œéœ€è¦å®šä¹‰ä»¥ä¸‹è¾…åŠ©æ•°æ®ç±»ï¼š

### 1. å®‰å…¨æ£€æŸ¥ç»“æœ

```kotlin
// ç”¨äº AiRepository.checkDraftSafety çš„è¿”å›å€¼
data class SafetyCheckResult(
    // æ˜¯å¦é€šè¿‡æ£€æŸ¥ (UI æ ¹æ®æ­¤å­—æ®µå†³å®šæ˜¯å¦å˜çº¢æ¡†)
    val isSafe: Boolean,

    // è§¦å‘äº†å“ªäº›å…·ä½“çš„é›·åŒºè§„åˆ™ (ç”¨äº UI Toast æç¤ºï¼š"æ£€æµ‹åˆ°æ‚¨æåˆ°äº†'å‰ä»»'")
    val triggeredRisks: List<String> = emptyList(),

    // ç®€çŸ­çš„ä¿®æ­£å»ºè®® (å¯é€‰)
    val suggestion: String? = null,

    // æ£€æŸ¥è€—æ—¶ (æ¯«ç§’)
    val processingTimeMs: Long = 0L,

    // æ£€æŸ¥æ—¶é—´æˆ³
    val timestamp: Long = System.currentTimeMillis()
)
```

### 2. ä¿¡æ¯æå–ç»“æœ

```kotlin
// ç”¨äº AiRepository.extractInfoFromText çš„è¿”å›å€¼
data class ExtractionResult(
    // æå–çš„äº‹å®ä¿¡æ¯
    val facts: Map<String, String> = emptyMap(),

    // æå–çš„é›·åŒºæ ‡ç­¾
    val redFlags: List<String> = emptyList(),

    // æå–çš„ç­–ç•¥å»ºè®®
    val strategies: List<String> = emptyList(),

    // æå–çš„ç½®ä¿¡åº¦
    val confidence: Float = 0.0f,

    // å¤„ç†è€—æ—¶ (æ¯«ç§’)
    val processingTimeMs: Long = 0L,

    // æå–æ—¶é—´æˆ³
    val timestamp: Long = System.currentTimeMillis()
)
```

### 3. åº”ç”¨é…ç½®

```kotlin
// åº”ç”¨é…ç½®æ•°æ®ç±»
data class AppConfig(
    // é»˜è®¤ä¸Šä¸‹æ–‡æ·±åº¦
    val defaultContextDepth: Int = 10,

    // è‡ªåŠ¨ä¿å­˜é—´éš” (ç§’)
    val autoSaveInterval: Int = 300,

    // æœ€å¤§å†å²æ¶ˆæ¯æ•°
    val maxHistoryMessages: Int = 1000,

    // å¯ç”¨è°ƒè¯•æ¨¡å¼
    val debugMode: Boolean = false,

    // å¯ç”¨æ·±åº¦æ£€æŸ¥
    val enableDeepCheck: Boolean = true,

    // API è¶…æ—¶æ—¶é—´ (ç§’)
    val apiTimeoutSeconds: Int = 30
)
```

### 4. éšç§è§„åˆ™

```kotlin
// éšç§è§„åˆ™æ•°æ®ç±»
data class PrivacyRule(
    // åŸå§‹å†…å®¹
    val original: String,

    // æ›¿æ¢å†…å®¹
    val mask: String,

    // è§„åˆ™ç±»å‹
    val type: PrivacyRuleType,

    // æ˜¯å¦å¯ç”¨
    val isEnabled: Boolean = true,

    // åˆ›å»ºæ—¶é—´æˆ³
    val createdAt: Long = System.currentTimeMillis()
)

enum class PrivacyRuleType {
    PHONE_NUMBER,    // æ‰‹æœºå·
    EMAIL_ADDRESS,   // é‚®ç®±åœ°å€
    ID_CARD,        // èº«ä»½è¯å·
    REAL_NAME,      // çœŸå®å§“å
    ADDRESS,        // åœ°å€
    CUSTOM          // è‡ªå®šä¹‰è§„åˆ™
}
```

### 5. å¥åº·çŠ¶æ€

```kotlin
// æœåŠ¡å¥åº·çŠ¶æ€
data class HealthStatus(
    // API è¿æ¥çŠ¶æ€
    val isApiConnected: Boolean,

    // å“åº”æ—¶é—´ (æ¯«ç§’)
    val responseTimeMs: Long,

    // é”™è¯¯ä¿¡æ¯ (å¦‚æœæœ‰)
    val errorMessage: String? = null,

    // æ£€æŸ¥æ—¶é—´æˆ³
    val timestamp: Long = System.currentTimeMillis()
)
```

---

## ğŸ”§ å®ç°æ³¨æ„äº‹é¡¹

### 1. é”™è¯¯å¤„ç†

æ‰€æœ‰ Repository æ–¹æ³•éƒ½åº”è¯¥è¿”å› `Result<T>` ç±»å‹ï¼Œç¡®ä¿ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ï¼š

```kotlin
// æˆåŠŸæƒ…å†µ
Result.success(data)

// å¤±è´¥æƒ…å†µ
Result.failure(exception)
```

### 2. åç¨‹æ”¯æŒ

æ‰€æœ‰ I/O æ“ä½œéƒ½åº”è¯¥æ˜¯ `suspend` å‡½æ•°ï¼Œæ”¯æŒåç¨‹å¼‚æ­¥å¤„ç†ã€‚

### 3. å“åº”å¼æ•°æ®

å¯¹äºéœ€è¦å®æ—¶æ›´æ–°çš„æ•°æ®ï¼Œä½¿ç”¨ `Flow<T>` ç±»å‹ï¼š
- `ContactRepository.getAllProfiles()`
- `BrainTagRepository.getTagsForContact()`
- `ChatHistoryRepository.getMessageStream()`

### 4. äº‹åŠ¡æ”¯æŒ

å¯¹äºæ¶‰åŠå¤šä¸ªè¡¨çš„æ“ä½œï¼Œç¡®ä¿äº‹åŠ¡æ€§ï¼š
- ä¿å­˜è”ç³»äººå’Œæ ‡ç­¾æ—¶
- æ‰¹é‡æ“ä½œæ—¶
- çº§è”åˆ é™¤æ—¶

---

**æœ€åæ›´æ–°**: 2025-12-08  
**ç»´æŠ¤è€…**: æ•°æ®è®¿é—®å±‚å›¢é˜Ÿ  
**ç‰ˆæœ¬**: v2.0