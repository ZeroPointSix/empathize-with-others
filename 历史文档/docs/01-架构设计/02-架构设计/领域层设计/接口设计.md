---
date_modified: 2025-12-02 19:05:22
---

# 接口设计文档 (v2.0 - Optimized)

**变更摘要：**

1. **统一错误处理：** 所有 I/O 操作（数据库、网络）的返回值包裹在 `Result<T>` 中，以便 ViewModel 层处理异常。
    
2. **细化风控接口：** `checkDraftSafety` 不再只返回 Boolean，而是返回包含具体触发关键词的详细对象，以支持 UI 的“红框+震动”具体反馈。
    
3. **优化事实更新：** 在 `ContactRepository` 中增加了单独更新 Facts 的接口，方便“数据喂养”模块高效写入。
    
4. **增强配置灵活性：** `SettingsRepository` 增加了 Header 获取接口，以适应不同 AI 服务商的鉴权差异。
    

---

### 第一组：核心业务数据接口 (Business Data)

此类接口直接操作 Room 数据库 (DAO)，管理核心实体。

#### 1. `ContactRepository` (角色卡仓库)

- **服务对象：** 联系人列表、画像详情、RAG 上下文构建。
    
- **优化点：** 增加了 `updateContactFacts`，避免在“自动提取标签”场景下必须读取完整对象才能更新的低效操作。
    

Kotlin

```
interface ContactRepository {
    // [UI用] 首页列表渲染。Flow 保证数据库变动即刷新 UI
    fun getAllProfiles(): Flow<List<ContactProfile>>

    // [业务用] 拼 Prompt 时读取单个画像
    suspend fun getProfile(id: String): Result<ContactProfile?>

    // [业务用] 创建或完全覆盖一个画像
    suspend fun saveProfile(profile: ContactProfile): Result<Unit>

    // [数据喂养用] 仅追加或更新事实字段 (增量更新)
    // 场景：AI 从聊天记录中分析出了新爱好，只需存入 {"爱好": "滑雪"}
    suspend fun updateContactFacts(contactId: String, newFacts: Map<String, String>): Result<Unit>

    // [管理用] 删除联系人
    suspend fun deleteProfile(id: String): Result<Unit>
}
```

#### 2. `BrainTagRepository` (军师策略仓库)

- **服务对象：** 实时风控检测、策略分析。
    

Kotlin

```
interface BrainTagRepository {
    // [业务用] RAG 核心：获取某人的所有“锦囊” (Flow 实时监听)
    fun getTagsForContact(contactId: String): Flow<List<BrainTag>>

    // [风控用] 获取全库的雷区（用于全局风控，或者无特定联系人时的通用检测）
    suspend fun getAllRedFlags(): Result<List<BrainTag>>

    // [数据喂养] AI 分析出新策略/用户手动添加
    suspend fun saveTag(tag: BrainTag): Result<Long> // 返回新插入的 ID

    // [UI用] 用户手动删掉不准的标签
    suspend fun deleteTag(id: Long): Result<Unit>
}
```

---

### 第二组：基础设施接口 (Infrastructure)

此类接口管理应用配置、隐私字典，通常对接 `EncryptedSharedPreferences` 或本地文件。

#### 3. `SettingsRepository` (全局配置仓库)

- **服务对象：** 网络模块 (NetworkModule)、设置页面。
    
- **优化点：** 增加 `getProviderHeaders` 以支持 BYOK 模式下不同厂商的特殊 Header 需求。
    

Kotlin

```
interface SettingsRepository {
    // 获取/保存 API Key (加密存储)
    suspend fun getApiKey(): Result<String?>
    suspend fun saveApiKey(key: String): Result<Unit>

    // 切换模型服务商 (OpenAI / DeepSeek / Claude)
    suspend fun getAiProvider(): Result<String>
    suspend fun saveAiProvider(provider: String): Result<Unit>

    // 获取 BaseUrl (用于 Retrofit 动态注入)
    suspend fun getBaseUrl(): Result<String>

    // [新] 获取特定服务商需要的 Headers (e.g. {"Authorization": "Bearer...", "HTTP-Referer": "..."})
    suspend fun getProviderHeaders(): Result<Map<String, String>>
}
```

#### 4. `PrivacyRepository` (隐私规则仓库)

- **服务对象：** `PrivacyEngine` (脱敏引擎)。
    

Kotlin

```
interface PrivacyRepository {
    // 获取所有映射规则 (用于构造正则替换器)
    // Map: {"真实姓名" : "[NAME_01]", "手机号" : "[PHONE_01]"}
    suspend fun getPrivacyMapping(): Result<Map<String, String>>

    // 添加新规则 (用户手动标记或自动识别)
    suspend fun addRule(original: String, mask: String): Result<Unit>

    // 移除规则
    suspend fun removeRule(original: String): Result<Unit>
}
```

---

### 第三组：外部服务接口 (External Services)

此类接口对接网络请求或耗时的本地 AI 运算，是 App 的“大脑连接器”。

#### 5. `AiRepository` (大脑连接器)

- **服务对象：** `AnalyzeChatUseCase`, `CheckDraftUseCase`, `ImportMediaUseCase`.
    
- **优化点：** 返回值更加结构化，支持详细的错误信息和风控详情。
    

Kotlin

```
interface AiRepository {
    // [功能 A] 帮我分析 (重辅助)
    // 入参：构建好的 Prompt (已包含脱敏后的上下文 + 目标 + 画像)
    // 返回：包含建议回复、心理分析、风险等级的结构体
    suspend fun analyzeChat(
        promptContext: String,
        systemInstruction: String 
    ): Result<AnalysisResult>

    // [功能 B] 帮我检查 (轻辅助/防踩雷)
    // 入参：用户正在输入的草稿 + 相关的雷区标签列表(文本形式)
    // 返回：详细的安全检查结果 (见下文 SafetyCheckResult 定义)
    suspend fun checkDraftSafety(
        draft: String,
        riskRules: List<String> 
    ): Result<SafetyCheckResult>

    // [功能 C] 多模态转文字 (STT / OCR)
    // 入参：媒体文件路径
    // 返回：转录后的纯文本
    suspend fun transcribeMedia(mediaFilePath: String): Result<String>
}
```

---

### 附录：新增/修改的数据模型 (DTOs)

为了配合上述接口优化，需要定义以下辅助数据类：

Kotlin

```
// 用于 AiRepository.checkDraftSafety 的返回值
data class SafetyCheckResult(
    // 是否通过检查 (UI 根据此字段决定是否变红框)
    val isSafe: Boolean,

    // 触发了哪些具体的雷区规则 (用于 UI Toast 提示：“检测到您提到了‘前任’”)
    val triggeredRisks: List<String> = emptyList(),

    // 简短的修正建议 (可选)
    val suggestion: String? = null
)
```

