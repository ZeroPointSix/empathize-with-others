---
date_modified: 2025-12-02 19:35:34
---

### 1. 核心数据资产 (The Data Schema)

在 MVP 阶段，业务层只维护两张“表”的数据逻辑：

- **表 A：联系人画像 (`ContactProfile`)**
    
    - **核心字段：** `id`, `name`, `targetGoal` (攻略目标)。
        
    - **事实槽 (`facts: Map<String, String>`)：** 这是一个扁平的 KV 结构。
        
        - _存什么：_ `{"生日": "12.21", "禁忌": "不吃蒜", "宠物": "布偶猫"}`。
            
        - _逻辑：_ 它是 RAG 的**“世界观”**，告诉 AI 这个人是谁。
            
- **表 B：策略锦囊 (`BrainTag`)**
    
    - **核心字段：** `content` (内容), `type` (类型)。
        
    - **逻辑：**
        
        - `RISK_RED` (红灯)：用于**阻断**（风控）和**警告**（AI 指令）。
            
        - `STRATEGY_GREEN` (绿灯)：仅用于**引导**（AI 指令）。
            

---

### 2. 业务流一：主动分析 (AnalyzeChatUseCase)

这是本项目的**核心卖点 (Killer Feature)**。

- **触发场景：** 用户点击悬浮窗的 `[💡 帮我分析]` 按钮。
    
- **输入 (Inputs)：**
    
    - `contactId`: 当前正在和谁聊天。
        
    - `rawScreenContext`: 从屏幕抓取到的原始文本列表（List<String>）。
        
- **处理流程 (Processing)：**
    
    1. **数据并行加载 (IO)：**
        
        - 读取 `Profile` (为了拿到 `Target` 和 `Facts`)。
            
        - 读取 `BrainTags` (为了拿到所有红/绿策略)。
            
        - 读取 `PrivacyDict` (为了拿到脱敏规则)。
            
    2. **数据清洗 (Logic)：**
        
        - **去重与排序：** 对 `rawScreenContext` 进行去重（基于文本内容），保留最近 10-15 条。
            
        - **安全脱敏：** 执行 `PrivacyEngine.mask(context)`，替换真名和手机号。
            
    3. **Prompt 组装 (Logic)：**
        
        - 将 `Facts` 拼接为 "Known Information"。
            
        - 将 `Tags` 拼接为 "Critical Rules"。
            
        - 将 `MaskedContext` 拼接为 "Conversation History"。
            
    4. **AI 推理 (Network)：**
        
        - 调用 `AiRepository.analyze()`。
            
- **输出 (Outputs)：**
    
    - `AnalysisResult`: 包含心理分析 + 建议回复（UI 直接渲染卡片）。
        

---

### 3. 业务流二：主动风控 (CheckDraftUseCase) —— _重大变更_

这是**安全防线**。我们放弃了后台监听，改为用户主动发起的“快照检查”。

- **触发场景：** 用户打完字心里没底，点击悬浮窗的 `[🛡️ 帮我检查]` 按钮。
    
- **输入 (Inputs)：**
    
    - `contactId`: 当前对象。
        
    - `draftSnapshot`: **主动获取**当前输入框焦点的文本内容。
        
- **处理流程 (Processing)：**
    
    1. **极速加载 (IO)：**
        
        - 仅读取该联系人的 `RISK_RED` (雷区) 标签列表。
            
    2. **本地匹配 (Logic - Layer 1)：**
        
        - 遍历雷区标签，执行 `draftSnapshot.contains(tag)`。
            
        - **决策点：** 如果命中（如包含“借钱”），**立即返回 DANGER**。
            
    3. **云端语义 (Network - Layer 2 - MVP可选)：**
        
        - 如果本地匹配通过，且用户开启了“深度检查”。
            
        - 先**脱敏** `draftSnapshot`。
            
        - 调用 `AiRepository.checkRisk()` 询问 AI 是否有语义风险。
            
- **输出 (Outputs)：**
    
    - `CheckResult`: Safe (绿) / Warning (黄) / Danger (红 + 命中词)。
        

---

### 4. 业务流三：文本喂养 (FeedTextUseCase)

这是**数据录入**的唯一入口。

- **触发场景：** 用户在 App 内点击 `[+] 导入数据` 并粘贴了一段文字。
    
- **输入 (Inputs)：**
    
    - `contactId`。
        
    - `rawText`: 用户粘贴的文本（可能是聊天记录，也可以是介绍）。
        
- **处理流程 (Processing)：**
    
    1. **前置脱敏 (Logic)：**
        
        - 在发给 AI 之前，必须先对 `rawText` 进行脱敏。
            
    2. **AI 萃取 (Network)：**
        
        - 调用 `AiRepository.extractInfo()`。
            
        - _指令：_ "请从这段文本中提取：1. 客观事实(Facts), 2. 潜在雷区(RedTags), 3. 应对策略(GreenTags)。请以 JSON 格式返回。"
            
    3. **人机确认 (UI Logic)：**
        
        - **关键：** 业务层**不直接保存**结果。
            
        - 业务层将 AI 返回的 JSON 解析为 `PendingData` 对象，返回给 UI。
            
        - UI 弹窗让用户勾选确认。
            
    4. **最终入库 (IO)：**
        
        - 用户点击“确认”后，调用 `ContactRepo.saveProfile` (更新 Facts) 和 `BrainTagRepo.saveTag` (插入 Tags)。
            

---

### 5. 基础设施约束 (Infrastructure Rules)

这些是写在 UseCase 基类或拦截器里的通用逻辑：

- **Token 检查：** 任何 UseCase 执行前，检查 `SettingsRepo.hasApiKey()`。没有则抛出异常，中断流程。
    
- **隐私拦截：** 任何发往 `AiRepo` 的字符串参数，必须先经过 `PrivacyEngine` 处理。
    

---

### 总结：你的开发清单

现在，你的业务层开发任务非常清晰，只需要写 **3 个核心类**：

1. `AnalyzeChatUseCase.kt`: 负责 RAG 拼装和分析。
    
2. `CheckDraftUseCase.kt`: 负责主动拉取快照并进行本地字符串匹配。
    
3. `FeedTextUseCase.kt`: 负责文本脱敏、AI 提取、以及数据的解析。
    