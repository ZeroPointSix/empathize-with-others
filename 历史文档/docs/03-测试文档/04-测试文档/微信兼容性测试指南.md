# 微信兼容性测试指南

**文档版本**: v1.0  
**创建日期**: 2025-12-07  
**测试目标**: 验证悬浮窗服务在微信中的兼容性和稳定性  
**对应任务**: 任务 11 - 微信兼容性测试和优化

## 测试概述

本文档提供微信兼容性测试的详细步骤和检查清单。测试目标是确保悬浮窗服务在微信环境中正常工作，满足以下需求：

- **需求 8.1**: 在微信聊天界面正常显示悬浮按钮
- **需求 8.2**: 在微信中点击悬浮按钮正常展开功能菜单
- **需求 8.3**: 从微信复制聊天内容后可以粘贴到输入框
- **需求 8.4**: 微信切换到后台时保持悬浮按钮显示
- **需求 8.5**: 微信版本更新时保持基本功能可用

## 测试环境准备

### 1. 设备要求

- **Android 版本**: Android 8.0 (API 26) 或更高
- **内存**: 至少 4GB RAM
- **存储**: 至少 2GB 可用空间
- **网络**: 稳定的网络连接（用于 AI 请求）

### 2. 应用安装

#### 安装共情 AI 助手

```bash
# 构建 Debug APK
./gradlew assembleDebug

# 安装到设备
./gradlew installDebug

# 或者手动安装
adb install app/build/outputs/apk/debug/app-debug.apk
```

#### 安装微信

测试需要安装以下微信版本：


1. **微信 8.0.48** (最新版本)
2. **微信 8.0.47** (上一个版本)
3. **微信 8.0.46** (再上一个版本)

可以从以下渠道获取：
- 微信官网: https://weixin.qq.com/
- 应用商店: Google Play Store / 各大应用市场
- APK 下载站: APKMirror, APKPure 等

### 3. 权限配置

在开始测试前，确保已授予以下权限：

#### 共情 AI 助手权限

1. **悬浮窗权限**
   - 设置 → 应用 → 共情 AI 助手 → 权限 → 显示在其他应用上层
   - 或在应用内设置页面点击"启用悬浮窗"按钮

2. **网络权限**
   - 默认已授予，无需手动设置

3. **前台服务权限**
   - 默认已授予，无需手动设置

#### 微信权限

确保微信有以下权限（用于测试复制粘贴功能）：
- 存储权限（读写）
- 网络权限

### 4. 测试数据准备

#### 创建测试联系人

在共情 AI 助手中创建至少一个测试联系人：

1. 打开共情 AI 助手
2. 进入"联系人"页面
3. 点击"添加联系人"按钮
4. 填写以下信息：
   - 姓名: "测试联系人"
   - 目标: "测试微信兼容性"
   - 事实: 添加一些测试数据
5. 保存联系人

#### 配置 AI 服务


1. 打开共情 AI 助手
2. 进入"设置"页面
3. 选择 AI 服务商（OpenAI / DeepSeek / Google）
4. 输入有效的 API Key
5. 保存设置

## 测试用例

### 测试用例 1: 悬浮按钮显示测试

**测试目标**: 验证悬浮按钮在微信中正常显示  
**对应需求**: 8.1

#### 测试步骤

1. **启动悬浮窗服务**
   - 打开共情 AI 助手
   - 进入"设置"页面
   - 打开"启用悬浮窗"开关
   - 确认通知栏显示"悬浮窗服务运行中"

2. **切换到微信**
   - 按 Home 键或使用多任务切换
   - 打开微信应用
   - 进入任意聊天界面

3. **检查悬浮按钮**
   - [ ] 悬浮按钮是否显示在屏幕上
   - [ ] 悬浮按钮是否清晰可见（不被遮挡）
   - [ ] 悬浮按钮图标是否正确显示
   - [ ] 悬浮按钮位置是否合理（不遮挡重要内容）

#### 预期结果

- ✅ 悬浮按钮正常显示在微信界面上
- ✅ 悬浮按钮图标清晰可见
- ✅ 悬浮按钮不遮挡微信的重要功能区域

#### 常见问题

**问题 1**: 悬浮按钮不显示
- **原因**: 权限未授予或服务未启动
- **解决**: 检查悬浮窗权限，重新启动服务

**问题 2**: 悬浮按钮被微信界面遮挡
- **原因**: Z-order 层级问题
- **解决**: 确认使用 TYPE_APPLICATION_OVERLAY 窗口类型

**问题 3**: 悬浮按钮显示异常（闪烁、残影）
- **原因**: 硬件加速问题
- **解决**: 检查 FloatingView 的硬件加速设置

---

### 测试用例 2: 拖动和点击测试

**测试目标**: 验证悬浮按钮的拖动和点击功能  
**对应需求**: 8.2

#### 测试步骤


1. **测试拖动功能**
   - 长按悬浮按钮
   - 拖动到屏幕不同位置（左上、右上、左下、右下、中间）
   - 松手后观察按钮行为

2. **测试边缘吸附**
   - 拖动按钮到屏幕左侧
   - 松手后观察是否自动吸附到左边缘
   - 拖动按钮到屏幕右侧
   - 松手后观察是否自动吸附到右边缘

3. **测试点击功能**
   - 轻触悬浮按钮（不拖动）
   - 观察菜单是否展开
   - 再次点击悬浮按钮或点击菜单外部
   - 观察菜单是否收起

4. **测试菜单按钮**
   - 点击悬浮按钮展开菜单
   - 点击"💡 帮我分析"按钮
   - 观察是否打开输入对话框
   - 关闭对话框
   - 再次展开菜单
   - 点击"🛡️ 帮我检查"按钮
   - 观察是否打开输入对话框

#### 检查清单

- [ ] 悬浮按钮可以流畅拖动（无卡顿）
- [ ] 拖动时按钮跟随手指移动
- [ ] 松手后按钮自动吸附到最近的边缘
- [ ] 点击按钮能正常展开菜单（响应时间 < 300ms）
- [ ] 菜单展开时显示两个按钮："帮我分析"和"帮我检查"
- [ ] 点击菜单按钮能正常打开输入对话框
- [ ] 点击菜单外部能正常收起菜单
- [ ] 拖动和点击操作不会影响微信的正常使用

#### 预期结果

- ✅ 拖动流畅，无卡顿（60 FPS）
- ✅ 边缘吸附正常工作
- ✅ 点击响应迅速（< 300ms）
- ✅ 菜单展开/收起动画流畅
- ✅ 不干扰微信的正常操作

#### 常见问题

**问题 1**: 拖动时卡顿
- **原因**: 硬件加速未启用或性能问题
- **解决**: 检查 enableHardwareAcceleration() 调用

**问题 2**: 点击无响应
- **原因**: 触摸事件被拦截
- **解决**: 检查 WindowManager.LayoutParams 的 flags 设置

**问题 3**: 边缘吸附不准确
- **原因**: 屏幕尺寸计算错误
- **解决**: 检查 snapToEdge() 方法的实现

---

### 测试用例 3: 复制粘贴功能测试

**测试目标**: 验证从微信复制内容后可以粘贴到输入框  
**对应需求**: 8.3


#### 测试步骤

1. **准备测试数据**
   - 在微信中找到一个聊天对话
   - 选择一条或多条消息

2. **复制微信消息**
   - 长按消息气泡
   - 选择"复制"选项
   - 确认消息已复制到剪贴板

3. **打开输入对话框**
   - 点击悬浮按钮展开菜单
   - 点击"💡 帮我分析"或"🛡️ 帮我检查"
   - 等待输入对话框显示

4. **粘贴内容**
   - 在输入框中长按
   - 选择"粘贴"选项
   - 观察内容是否正确粘贴

5. **验证内容**
   - 检查粘贴的内容是否完整
   - 检查格式是否正确（换行、特殊字符等）
   - 检查字符计数是否正确更新

6. **提交测试**
   - 选择一个联系人
   - 点击"确认"按钮
   - 观察是否正常提交

#### 检查清单

- [ ] 可以从微信复制文本消息
- [ ] 可以在输入框中粘贴复制的内容
- [ ] 粘贴的内容完整无误
- [ ] 支持多行文本粘贴
- [ ] 支持特殊字符（emoji、标点符号等）
- [ ] 字符计数正确更新
- [ ] 超过 5000 字符时显示警告
- [ ] 粘贴后可以正常提交

#### 预期结果

- ✅ 复制粘贴功能正常工作
- ✅ 内容完整准确
- ✅ 格式保持正确
- ✅ 字符计数准确

#### 常见问题

**问题 1**: 无法粘贴内容
- **原因**: 输入框未获得焦点或权限问题
- **解决**: 检查输入框的 focusable 属性

**问题 2**: 粘贴内容不完整
- **原因**: 剪贴板内容过大或格式问题
- **解决**: 检查字符限制和格式处理

**问题 3**: 特殊字符显示异常
- **原因**: 编码问题
- **解决**: 确保使用 UTF-8 编码

---

### 测试用例 4: 后台切换测试

**测试目标**: 验证微信切换到后台时悬浮按钮保持显示  
**对应需求**: 8.4

#### 测试步骤


1. **微信在前台时**
   - 打开微信应用
   - 确认悬浮按钮正常显示
   - 记录悬浮按钮的位置

2. **切换到后台**
   - 按 Home 键返回桌面
   - 观察悬浮按钮是否仍然显示
   - 打开其他应用（如浏览器、设置等）
   - 观察悬浮按钮是否仍然显示

3. **切换回微信**
   - 使用多任务切换或点击微信图标
   - 返回微信应用
   - 观察悬浮按钮是否仍然显示
   - 检查悬浮按钮位置是否保持不变

4. **锁屏测试**
   - 在微信界面按电源键锁屏
   - 等待 5 秒
   - 解锁设备
   - 观察悬浮按钮是否仍然显示

5. **长时间后台测试**
   - 将微信切换到后台
   - 等待 5 分钟
   - 切换回微信
   - 观察悬浮按钮是否仍然显示

#### 检查清单

- [ ] 微信切换到后台时悬浮按钮保持显示
- [ ] 切换回微信时悬浮按钮仍然显示
- [ ] 悬浮按钮位置保持不变
- [ ] 锁屏后解锁悬浮按钮仍然显示
- [ ] 长时间后台后悬浮按钮仍然显示
- [ ] 通知栏显示"悬浮窗服务运行中"
- [ ] 服务未被系统杀死

#### 预期结果

- ✅ 悬浮按钮在所有场景下保持显示
- ✅ 前台服务保持运行
- ✅ 位置状态正确保存和恢复

#### 常见问题

**问题 1**: 后台切换后悬浮按钮消失
- **原因**: 服务被系统杀死
- **解决**: 确认使用前台服务（Foreground Service）

**问题 2**: 悬浮按钮位置改变
- **原因**: 位置未正确保存
- **解决**: 检查 FloatingWindowPreferences 的保存逻辑

**问题 3**: 锁屏后悬浮按钮消失
- **原因**: 窗口类型不正确
- **解决**: 确认使用 TYPE_APPLICATION_OVERLAY

---

### 测试用例 5: 多版本兼容性测试

**测试目标**: 验证在不同微信版本中的兼容性  
**对应需求**: 8.5

#### 测试步骤

对每个微信版本重复以下测试：


1. **安装目标微信版本**
   - 卸载当前微信版本
   - 安装目标版本（8.0.48 / 8.0.47 / 8.0.46）
   - 登录微信账号

2. **执行基础功能测试**
   - 测试用例 1: 悬浮按钮显示
   - 测试用例 2: 拖动和点击
   - 测试用例 3: 复制粘贴
   - 测试用例 4: 后台切换

3. **记录测试结果**
   - 记录每个测试用例的通过/失败状态
   - 记录发现的问题和异常
   - 截图保存问题现场

4. **切换到下一个版本**
   - 重复步骤 1-3

#### 测试矩阵

| 测试用例 | 微信 8.0.48 | 微信 8.0.47 | 微信 8.0.46 |
|---------|------------|------------|------------|
| 悬浮按钮显示 | [ ] 通过 / [ ] 失败 | [ ] 通过 / [ ] 失败 | [ ] 通过 / [ ] 失败 |
| 拖动和点击 | [ ] 通过 / [ ] 失败 | [ ] 通过 / [ ] 失败 | [ ] 通过 / [ ] 失败 |
| 复制粘贴 | [ ] 通过 / [ ] 失败 | [ ] 通过 / [ ] 失败 | [ ] 通过 / [ ] 失败 |
| 后台切换 | [ ] 通过 / [ ] 失败 | [ ] 通过 / [ ] 失败 | [ ] 通过 / [ ] 失败 |

#### 预期结果

- ✅ 所有测试用例在三个微信版本中都通过
- ✅ 基本功能保持可用
- ✅ 无严重兼容性问题

#### 常见问题

**问题 1**: 某个版本中悬浮按钮不显示
- **原因**: 微信版本特定的窗口管理变化
- **解决**: 检查该版本的特殊处理需求

**问题 2**: 不同版本表现不一致
- **原因**: 微信内部实现差异
- **解决**: 使用标准 Android API，避免依赖微信特定行为

---

## 性能测试

### 测试用例 6: 响应时间测试

**测试目标**: 验证操作响应时间符合性能要求

#### 测试步骤

1. **点击响应时间**
   - 使用秒表或录屏工具
   - 点击悬浮按钮
   - 测量从点击到菜单展开的时间
   - 重复测试 10 次，取平均值

2. **拖动流畅度**
   - 开启开发者选项中的"显示 GPU 渲染模式分析"
   - 拖动悬浮按钮
   - 观察 GPU 渲染图表
   - 确认帧率保持在 60 FPS

3. **内存占用**
   - 使用 Android Studio Profiler 或 adb 命令
   - 监控服务运行时的内存占用
   - 记录峰值和平均值


#### 性能指标

| 指标 | 目标值 | 实际值 | 通过/失败 |
|------|--------|--------|----------|
| 点击响应时间 | < 300ms | _____ ms | [ ] |
| 拖动帧率 | 60 FPS | _____ FPS | [ ] |
| 内存占用 | < 150MB | _____ MB | [ ] |

#### 测量命令

```bash
# 查看内存占用
adb shell dumpsys meminfo com.empathy.ai

# 查看 CPU 使用率
adb shell top -n 1 | grep com.empathy.ai

# 录制性能数据
adb shell screenrecord /sdcard/test.mp4
```

---

## 可选功能测试

### 测试用例 7: 微信运行检测（可选）

**测试目标**: 验证微信运行检测功能（如果实现）

#### 测试步骤

1. **微信未运行时**
   - 确保微信未运行
   - 启动悬浮窗服务
   - 检查是否有提示信息

2. **微信运行时**
   - 启动微信应用
   - 观察悬浮按钮行为
   - 检查是否有特殊优化

3. **微信退出时**
   - 关闭微信应用
   - 观察悬浮按钮是否仍然显示
   - 检查服务状态

#### 检查清单

- [ ] 能检测到微信是否运行
- [ ] 微信运行时有相应提示或优化
- [ ] 微信退出时服务保持运行

---

## 问题记录模板

### 问题报告格式

```markdown
**问题编号**: WX-001
**严重程度**: 高 / 中 / 低
**测试用例**: 测试用例 X
**微信版本**: 8.0.48
**Android 版本**: Android 12
**设备型号**: Pixel 5

**问题描述**:
[详细描述问题现象]

**复现步骤**:
1. [步骤 1]
2. [步骤 2]
3. [步骤 3]

**预期结果**:
[应该发生什么]

**实际结果**:
[实际发生了什么]

**截图/录屏**:
[附加截图或录屏链接]

**日志**:
```
[粘贴相关日志]
```

**可能原因**:
[初步分析]

**建议解决方案**:
[可能的修复方案]
```

---

## 测试报告模板

### 测试总结报告

```markdown
# 微信兼容性测试报告

**测试日期**: 2025-12-XX
**测试人员**: [姓名]
**测试版本**: v1.0.0

## 测试环境

- **设备**: [设备型号]
- **Android 版本**: [版本号]
- **微信版本**: 8.0.48, 8.0.47, 8.0.46

## 测试结果汇总

| 测试用例 | 通过 | 失败 | 跳过 |
|---------|------|------|------|
| 悬浮按钮显示 | X | - | - |
| 拖动和点击 | X | - | - |
| 复制粘贴 | X | - | - |
| 后台切换 | X | - | - |
| 多版本兼容性 | X | - | - |
| 性能测试 | X | - | - |

**总计**: X 通过, X 失败, X 跳过

## 发现的问题

### 高优先级问题

1. [问题描述]
2. [问题描述]

### 中优先级问题

1. [问题描述]
2. [问题描述]

### 低优先级问题

1. [问题描述]
2. [问题描述]

## 性能数据

- **点击响应时间**: XXX ms (目标: < 300ms)
- **拖动帧率**: XX FPS (目标: 60 FPS)
- **内存占用**: XXX MB (目标: < 150MB)

## 结论

[总体评价和建议]

## 下一步行动

1. [行动项 1]
2. [行动项 2]
3. [行动项 3]
```

---

## 附录

### A. 常用 ADB 命令

```bash
# 查看已连接设备
adb devices

# 安装 APK
adb install app-debug.apk

# 卸载应用
adb uninstall com.empathy.ai

# 查看日志
adb logcat | grep FloatingWindow

# 清除应用数据
adb shell pm clear com.empathy.ai

# 授予悬浮窗权限（需要 root）
adb shell appops set com.empathy.ai SYSTEM_ALERT_WINDOW allow

# 启动服务
adb shell am startservice com.empathy.ai/.domain.service.FloatingWindowService

# 停止服务
adb shell am stopservice com.empathy.ai/.domain.service.FloatingWindowService

# 查看服务状态
adb shell dumpsys activity services com.empathy.ai
```

### B. 调试技巧

1. **启用详细日志**
   - 在 FloatingWindowService 中添加详细的日志输出
   - 使用 `Log.d()`, `Log.i()`, `Log.w()`, `Log.e()` 记录关键事件

2. **使用 Android Studio Profiler**
   - 监控内存使用情况
   - 分析 CPU 使用率
   - 检查网络请求

3. **录制屏幕**
   - 使用 `adb shell screenrecord` 录制测试过程
   - 便于分析问题和分享给团队

4. **使用布局检查器**
   - Android Studio → Tools → Layout Inspector
   - 查看悬浮窗的视图层级

### C. 厂商 ROM 适配说明

不同厂商的 ROM 可能对悬浮窗有特殊限制：

#### 小米 MIUI
- 需要在"安全中心"中授予悬浮窗权限
- 可能需要关闭"省电优化"

#### 华为 EMUI
- 需要在"权限管理"中授予悬浮窗权限
- 可能需要添加到"受保护应用"列表

#### OPPO ColorOS
- 需要在"应用权限"中授予悬浮窗权限
- 可能需要关闭"应用冻结"

#### VIVO FuntouchOS
- 需要在"i管家"中授予悬浮窗权限
- 可能需要关闭"后台高耗电"限制

---

**文档维护**: 请在测试过程中及时更新本文档，记录新发现的问题和解决方案。

**最后更新**: 2025-12-07
**维护者**: hushaokang
