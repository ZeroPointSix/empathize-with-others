# 悬浮窗最小化Bug修复测试文档

**文档版本**: v1.1.0  
**创建日期**: 2025-12-09  
**最后更新**: 2025-12-09  
**关联Bug**: 悬浮窗最小化功能恶性Bug  
**修复版本**: v1.0.3

## 1. 测试概述

### 1.1 测试目的

验证悬浮窗最小化功能恶性Bug的修复效果，确保：
1. **无请求时点击最小化** → 直接返回悬浮按钮状态，不显示旋转指示器
2. **有请求时点击最小化** → 显示旋转指示器，等待AI响应
3. **AI响应完成后点击最小化** → 直接返回悬浮按钮状态，不显示旋转指示器
4. 再次打开对话框所有按钮正常工作
5. 取消按钮能够正常关闭对话框
6. 字符计数功能正常工作
7. 不影响原有功能的正常使用

### 1.2 测试范围

| 测试类型 | 范围 | 优先级 |
|---------|------|--------|
| 单元测试 | 监听器设置逻辑 | P0 |
| 功能测试 | 最小化/恢复流程 | P0 |
| 回归测试 | 原有功能 | P1 |
| 边界测试 | 异常场景 | P2 |

### 1.3 测试环境

| 项目 | 要求 |
|------|------|
| Android 版本 | 7.0 - 14 (API 24-34) |
| 设备类型 | 手机/平板 |
| 网络环境 | 有网络/无网络 |

## 2. 单元测试

### 2.1 测试文件

`app/src/test/java/com/empathy/ai/domain/util/FloatingViewUpdateDialogListenersTest.kt`

### 2.2 测试用例

| 用例ID | 用例名称 | 测试内容 | 预期结果 |
|--------|---------|---------|---------|
| UT-001 | 更新对话框设置取消按钮监听器 | 验证取消按钮监听器被设置 | 监听器列表包含btnCancel |
| UT-002 | 更新对话框设置TextWatcher | 验证TextWatcher被设置 | TextWatcher已设置 |
| UT-003 | 无请求最小化后重新打开流程 | 验证完整流程 | 流程正常完成 |
| UT-004 | 监听器清除与重建对称性 | 验证清除的监听器都被重建 | 关键监听器都被重建 |
| UT-005 | 首次创建对话框不受影响 | 验证首次创建流程 | 首次创建正常 |

### 2.3 运行命令

```bash
# 运行单个测试文件
./gradlew test --tests "com.empathy.ai.domain.util.FloatingViewUpdateDialogListenersTest"

# 运行所有单元测试
./gradlew testDebugUnitTest
```

## 3. 功能测试

### 3.1 核心场景测试

#### TC-001: 无请求最小化 - 不显示旋转指示器

**前置条件**:
- 应用已安装并授予悬浮窗权限
- 至少有一个联系人

**测试步骤**:
1. 点击悬浮按钮
2. 选择"分析"或"检查"功能
3. 对话框显示后，**不输入任何内容**
4. 点击最小化按钮（—）

**预期结果**:
- ✅ 对话框关闭
- ✅ 直接返回悬浮按钮状态
- ✅ **不显示旋转指示器**
- ✅ 悬浮按钮外观正常（不是旋转状态）

**实际结果**: 待测试

---

#### TC-001b: 无请求最小化后再次打开对话框

**前置条件**:
- 完成 TC-001

**测试步骤**:
1. 再次点击悬浮按钮
2. 选择"分析"或"检查"功能
3. 验证对话框显示

**预期结果**:
- ✅ 对话框正常显示
- ✅ 所有按钮可点击
- ✅ 界面无卡死现象
- ✅ 可以正常选择联系人
- ✅ 可以正常输入文本

**实际结果**: 待测试

---

#### TC-002: 无请求最小化后取消按钮功能

**前置条件**:
- 完成 TC-001 步骤 1-8

**测试步骤**:
1. 在对话框中点击"取消"按钮

**预期结果**:
- 对话框正常关闭
- 返回悬浮按钮状态

**实际结果**: 待测试

---

#### TC-003: 无请求最小化后字符计数功能

**前置条件**:
- 完成 TC-001 步骤 1-8

**测试步骤**:
1. 在输入框中输入文本
2. 观察字符计数显示

**预期结果**:
- 字符计数实时更新
- 显示格式为 "X/5000"
- 超过5000字符时显示红色

**实际结果**: 待测试

---

#### TC-004: 无请求最小化后确认按钮功能

**前置条件**:
- 完成 TC-001 步骤 1-8
- 已配置有效的 API Key

**测试步骤**:
1. 选择联系人
2. 输入文本内容
3. 点击"确认"按钮

**预期结果**:
- 显示加载状态
- 正常发送请求
- 显示分析/检查结果

**实际结果**: 待测试

---

#### TC-005: 有请求最小化 - 显示旋转指示器

**前置条件**:
- 应用已安装并授予悬浮窗权限
- 至少有一个联系人
- 已配置有效的 API Key

**测试步骤**:
1. 点击悬浮按钮
2. 选择"分析"功能
3. 选择联系人，输入文本
4. 点击"确认"按钮
5. **在加载过程中**（AI正在处理时）点击最小化按钮

**预期结果**:
- ✅ 对话框关闭
- ✅ **显示旋转指示器**（因为有正在处理的请求）
- ✅ 指示器显示加载动画

**实际结果**: 待测试

---

#### TC-005b: 有请求最小化后恢复对话框

**前置条件**:
- 完成 TC-005

**测试步骤**:
1. 等待请求完成（指示器变为成功/失败状态）
2. 点击指示器恢复对话框

**预期结果**:
- ✅ 对话框正常恢复
- ✅ 显示分析结果
- ✅ 所有按钮正常工作

**实际结果**: 待测试

---

#### TC-005c: AI响应完成后点击最小化

**前置条件**:
- 应用已安装并授予悬浮窗权限
- 至少有一个联系人
- 已配置有效的 API Key

**测试步骤**:
1. 点击悬浮按钮
2. 选择"分析"功能
3. 选择联系人，输入文本
4. 点击"确认"按钮
5. **等待AI响应完成**，结果显示在对话框中
6. 点击最小化按钮

**预期结果**:
- ✅ 对话框关闭
- ✅ 直接返回悬浮按钮状态
- ✅ **不显示旋转指示器**（因为请求已完成）

**实际结果**: 待测试

### 3.2 边界场景测试

#### TC-006: 连续多次最小化/打开

**测试步骤**:
1. 打开对话框
2. 点击最小化（无请求）
3. 再次打开对话框
4. 点击最小化（无请求）
5. 再次打开对话框
6. 重复 3-5 步骤 5 次

**预期结果**:
- 每次打开对话框都正常工作
- 无内存泄漏
- 无界面卡顿

**实际结果**: 待测试

---

#### TC-007: 快速点击最小化按钮

**测试步骤**:
1. 打开对话框
2. 快速连续点击最小化按钮 3 次

**预期结果**:
- 对话框正常关闭
- 无崩溃
- 无异常状态

**实际结果**: 待测试

## 4. 回归测试

### 4.1 原有功能验证

| 用例ID | 功能点 | 测试内容 | 预期结果 | 实际结果 |
|--------|--------|---------|---------|---------|
| RT-001 | 悬浮按钮显示 | 启动服务后悬浮按钮显示 | 正常显示 | 待测试 |
| RT-002 | 悬浮按钮拖动 | 拖动悬浮按钮到任意位置 | 可自由拖动 | 待测试 |
| RT-003 | 菜单展开 | 点击悬浮按钮展开菜单 | 菜单正常展开 | 待测试 |
| RT-004 | 分析功能 | 完整的分析流程 | 正常分析 | 待测试 |
| RT-005 | 检查功能 | 完整的检查流程 | 正常检查 | 待测试 |
| RT-006 | 最小化功能（有请求） | 有请求时最小化 | 显示指示器 | 待测试 |
| RT-007 | 恢复功能 | 从最小化恢复 | 正常恢复 | 待测试 |
| RT-008 | 通知功能 | 请求完成后发送通知 | 正常发送 | 待测试 |

## 5. 测试执行记录

### 5.1 测试环境信息

| 项目 | 值 |
|------|-----|
| 测试日期 | |
| 测试人员 | |
| 设备型号 | |
| Android 版本 | |
| 应用版本 | |

### 5.2 测试结果汇总

| 测试类型 | 总数 | 通过 | 失败 | 阻塞 | 通过率 |
|---------|------|------|------|------|--------|
| 单元测试 | 5 | | | | |
| 功能测试 | 7 | | | | |
| 回归测试 | 8 | | | | |
| **总计** | **20** | | | | |

### 5.3 缺陷记录

| 缺陷ID | 用例ID | 描述 | 严重程度 | 状态 |
|--------|--------|------|---------|------|
| | | | | |

## 6. 测试结论

### 6.1 测试总结

（待测试完成后填写）

### 6.2 风险评估

| 风险项 | 风险等级 | 说明 |
|--------|---------|------|
| 功能风险 | | |
| 性能风险 | | |
| 兼容性风险 | | |

### 6.3 发布建议

（待测试完成后填写）

---

**测试负责人**: 待指定  
**审核人**: 待指定  
**批准人**: 待指定
