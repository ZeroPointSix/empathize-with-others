# 最小化按钮逻辑优化

## 问题描述

原始实现中，当用户在输入对话框中还没有发送请求给AI时点击最小化按钮，系统会尝试进入最小化状态，但由于没有正在进行的请求，这会导致逻辑错误。

## 解决方案

优化最小化按钮的行为，根据是否有正在处理的AI请求来决定不同的操作：

### 场景 A：用户还没发送请求

**触发条件：**
- 用户打开了输入对话框
- 用户还没有点击"确认"按钮
- `currentRequestInfo` 为 `null`

**行为：**
- 点击最小化按钮 → 直接关闭对话框
- 返回到悬浮按钮状态
- 相当于点击"取消"按钮的效果

**实现：**
```kotlin
fun minimizeDialog() {
    // 检查是否有正在处理的请求
    val requestInfo = currentRequestInfo
    if (requestInfo == null) {
        // 没有请求，直接关闭对话框
        floatingView?.hideInputDialog()
        return
    }
    
    // 有请求，执行最小化逻辑...
}
```

### 场景 B：AI正在处理请求

**触发条件：**
- 用户已经点击"确认"按钮
- AI正在后台处理请求
- `currentRequestInfo` 不为 `null`

**行为：**
- 点击最小化按钮 → 对话框收起为小型加载指示器
- AI继续在后台处理
- 保存请求信息到持久化存储
- 显示加载动画

**实现：**
```kotlin
fun minimizeDialog() {
    val requestInfo = currentRequestInfo
    if (requestInfo == null) {
        floatingView?.hideInputDialog()
        return
    }
    
    // 保存请求信息
    floatingWindowPreferences.saveRequestInfo(requestInfo)
    
    // 显示最小化指示器
    floatingView?.minimizeDialog()
}
```

## 用户体验改进

### 优点

1. **符合常规软件习惯**
   - 最小化按钮在任何时候都可以使用
   - 没有请求时相当于"关闭"功能
   - 有请求时才是真正的"最小化"功能

2. **避免逻辑错误**
   - 不会在没有请求时尝试创建指示器
   - 不会显示错误提示打断用户操作

3. **操作更灵活**
   - 用户可以随时关闭对话框
   - 不需要区分"取消"和"最小化"按钮

### 注意事项

1. **不保存草稿**
   - 当前实现不保存用户输入的文本
   - 关闭对话框后，输入内容会丢失
   - 如果需要保存草稿功能，需要额外实现

2. **视觉反馈**
   - 最小化按钮始终显示相同的图标（"—"）
   - 不区分"关闭"和"最小化"两种模式
   - 用户通过上下文理解按钮的实际行为

## 测试覆盖

### 单元测试

创建了 `FloatingWindowServiceMinimizeLogicTest.kt`，包含以下测试用例：

1. **没有请求时点击最小化应关闭对话框**
   - 验证没有保存请求信息
   - 验证对话框被关闭

2. **有请求时点击最小化应显示指示器**
   - 验证保存了请求信息
   - 验证显示了加载指示器

3. **验证最小化逻辑不会抛出异常**
   - 测试边界情况
   - 确保健壮性

4. **验证日志记录**
   - 确保记录了适当的日志信息
   - 便于调试和问题追踪

### UI测试

更新了 `FloatingViewMinimizeButtonTest.kt`，添加了说明：
- 回调会根据是否有请求来决定行为
- 测试验证回调被正确触发

## 代码变更

### 修改的文件

1. **FloatingWindowService.kt**
   - 修改 `minimizeDialog()` 方法
   - 添加请求状态检查
   - 根据状态执行不同操作

### 新增的文件

1. **FloatingWindowServiceMinimizeLogicTest.kt**
   - 测试最小化按钮的两种场景
   - 验证逻辑正确性

## 未来改进

如果需要保存草稿功能，可以考虑：

1. **在 FloatingWindowPreferences 中添加方法**
   ```kotlin
   fun saveDraftText(text: String)
   fun getDraftText(): String?
   fun clearDraftText()
   ```

2. **在关闭对话框前保存文本**
   ```kotlin
   if (requestInfo == null) {
       // 保存草稿
       val draftText = floatingView?.getInputText()
       if (!draftText.isNullOrEmpty()) {
           floatingWindowPreferences.saveDraftText(draftText)
       }
       floatingView?.hideInputDialog()
       return
   }
   ```

3. **在显示对话框时恢复文本**
   ```kotlin
   fun showInputDialog(...) {
       // 恢复草稿
       val draftText = floatingWindowPreferences.getDraftText()
       if (!draftText.isNullOrEmpty()) {
           inputText?.setText(draftText)
       }
   }
   ```

但考虑到实现复杂度和用户需求，当前版本暂不实现草稿保存功能。

## 总结

通过这次优化，最小化按钮的行为更加符合用户预期：
- ✅ 任何时候都可以使用
- ✅ 没有请求时相当于"关闭"
- ✅ 有请求时才是"最小化"
- ✅ 避免了逻辑错误
- ✅ 提升了用户体验

---

**修改日期**: 2025-12-09  
**修改人**: AI Assistant  
**相关需求**: 需求 1.1 - 最小化交互
