# 最小化问题日志分析指南

## 测试步骤

请按照以下步骤测试最小化功能，并收集日志输出：

### 1. 准备测试环境

1. 安装包含调试日志的APK
2. 连接ADB，启用日志过滤：
   ```bash
   adb logcat -s FloatingView FloatingViewDebug FloatingWindowService
   ```

### 2. 复现问题

1. 启动应用，显示悬浮窗
2. 点击悬浮按钮，选择"帮我分析"或"帮我检查"
3. 在输入对话框中**不输入任何文本**
4. 点击最小化按钮（"—"）
5. 等待对话框消失，观察是否显示指示器
6. 再次点击悬浮按钮
7. 观察是否正常显示菜单，还是无响应

### 3. 收集关键日志

请特别关注以下日志标签和内容：

#### FloatingViewDebug 标签
- `状态转换`: 记录模式变化
- `视图状态`: 记录输入框、按钮、指示器的可见性
- `资源清理`: 记录监听器清理情况
- `监听器清理`: 记录每种监听器的清理数量
- `用户操作`: 记录用户点击操作
- `最小化流程`: 记录最小化过程的每个步骤
- `原子性操作`: 记录原子性操作的执行情况

#### FloatingWindowService 标签
- `开始最小化对话框`
- `无正在处理的请求，安全关闭对话框`
- `关闭前模式` / `关闭后模式`
- `hideInputDialog() 调用成功` 或 `hideInputDialog() 调用失败`

#### FloatingView 标签
- `开始隐藏输入对话框，当前模式`
- `视图可见性已更新`
- `执行点击操作，当前模式`

## 日志分析判断标准

### 判断标准1：状态与视图不一致

如果看到以下日志模式，则确认状态与视图不一致：

```
FloatingView: 开始隐藏输入对话框，当前模式: INPUT
FloatingViewDebug: 状态转换: INPUT -> BUTTON, 操作: hideInputDialog
FloatingViewDebug: 视图状态[视图更新]: 输入框=false, 按钮=true, 指示器=false
FloatingView: 执行点击操作，当前模式: BUTTON
FloatingViewDebug: 用户操作[performClick]: 当前模式=BUTTON
```

但如果后续看到：
```
FloatingView: 执行点击操作，当前模式: INPUT  // 状态没有正确更新
```

### 判断标准2：资源清理不完整

如果看到以下日志模式，则确认资源清理不完整：

```
FloatingView: 开始清除所有监听器
FloatingViewDebug: 监听器清理[确认按钮]: 清理了1个, 状态: 成功
FloatingViewDebug: 监听器清理[取消按钮]: 清理了1个, 状态: 成功
FloatingViewDebug: 监听器清理[最小化按钮]: 清理了1个, 状态: 成功
FloatingViewDebug: 监听器清理[复制按钮]: 清理了1个, 状态: 成功
FloatingViewDebug: 监听器清理[Spinner]: 清理了1个, 状态: 成功
```

但如果看到：
```
FloatingViewDebug: 监听器清理[TextWatcher]: 清理了0个, 状态: 失败  // 清理失败
```

### 判断标准3：异常处理问题

如果看到以下日志模式，则确认异常处理问题：

```
FloatingView: 更新视图可见性失败
FloatingViewDebug: 异常[更新视图可见性]: 具体异常信息
```

## 预期结果

### 正常情况下的日志流程

1. **无请求最小化**：
   ```
   FloatingWindowService: 无正在处理的请求，安全关闭对话框
   FloatingViewDebug: 最小化流程[无请求处理]: 有请求=false, 详情: 调用safeCloseInputDialog
   FloatingView: 开始隐藏输入对话框，当前模式: INPUT
   FloatingViewDebug: 状态转换: INPUT -> BUTTON, 操作: hideInputDialog
   FloatingViewDebug: 视图状态[视图更新]: 输入框=false, 按钮=true, 指示器=false
   FloatingView: 执行点击操作，当前模式: BUTTON
   FloatingViewDebug: 用户操作[performClick]: 当前模式=BUTTON
   ```

2. **有请求最小化**：
   ```
   FloatingWindowDebug: 最小化流程[检查请求状态]: 有请求=true, 详情: 请求ID: xxx, 类型: ANALYZE
   FloatingViewDebug: 最小化流程[有请求处理]: 有请求=true, 详情: 保存请求信息并显示指示器
   ```

## 问题确认

根据收集到的日志，我们可以确认：

1. **如果是状态与视图不一致**：
   - 看到状态转换成功但用户操作时状态错误
   - 确认根本原因1：状态与视图不一致导致的死锁

2. **如果是资源清理不完整**：
   - 看到监听器清理失败或数量不正确
   - 确认根本原因2：资源清理不完整导致的事件监听器残留

3. **如果是异常处理问题**：
   - 看到异常被抛出但没有正确处理
   - 确认需要改进异常处理机制

请运行测试并提供完整的日志输出，我们将根据实际日志确认根本原因并提供针对性的修复方案。