# 悬浮窗最小化Bug调试指南

**日期**: 2025-12-09  
**状态**: 🔍 调试中

## 1. 问题描述

用户报告：无请求时点击最小化按钮，程序显示旋转指示器（不应该），且再次点击后无法正常使用。

## 2. 调试步骤

### 2.1 连接设备并查看日志

```bash
# 连接设备
adb devices

# 清除旧日志
adb logcat -c

# 开始监控日志（过滤关键标签）
adb logcat -s FloatingWindowService:D FloatingView:D
```

### 2.2 复现问题

1. 启动应用
2. 点击悬浮按钮
3. 选择"分析"或"检查"功能
4. **不输入任何内容**
5. 点击最小化按钮（—）
6. 观察日志输出

### 2.3 预期日志输出

如果代码正确执行，应该看到以下日志：

```
D/FloatingWindowService: ========== 开始最小化对话框 ==========
D/FloatingWindowService: currentRequestInfo 状态: 无请求 (null)
I/FloatingWindowService: ========== 【无请求】开始处理 ==========
I/FloatingWindowService: 【无请求】安全关闭对话框，不显示指示器
I/FloatingWindowService: 【无请求】将调用 hideInputDialog() 而非 minimizeDialog()
D/FloatingWindowService: 【无请求】关闭前模式: INPUT
D/FloatingWindowService: 【无请求】正在调用 floatingView.hideInputDialog()...
D/FloatingView: ========== hideInputDialog 开始 ==========
D/FloatingView: 当前模式: INPUT
D/FloatingView: floatingButton 可见性: 8 (GONE)
D/FloatingView: inputDialogView 可见性: 0 (VISIBLE)
D/FloatingView: minimizedIndicator 可见性: 8 (GONE) 或 null
... (中间的清理日志)
D/FloatingView: ========== hideInputDialog 完成 ==========
D/FloatingView: 最终 floatingButton 可见性: 0 (VISIBLE)
D/FloatingView: 最终 inputDialogView 可见性: 8 (GONE)
D/FloatingView: 最终 minimizedIndicator 可见性: 8 (GONE)
D/FloatingView: 最终模式: BUTTON
D/FloatingWindowService: 【无请求】floatingView.hideInputDialog() 调用完成
D/FloatingWindowService: 【无请求】关闭后模式: BUTTON
I/FloatingWindowService: 【无请求】成功返回按钮模式
D/FloatingWindowService: ========== 无请求最小化完成 ==========
```

### 2.4 异常日志分析

如果看到以下日志，说明有问题：

1. **如果看到 `currentRequestInfo 状态: 有请求`**
   - 说明 `currentRequestInfo` 没有被正确清除
   - 需要检查之前的操作是否有未清除的请求

2. **如果看到 `【有请求】执行真正的最小化`**
   - 说明代码走了错误的分支
   - 需要检查 `currentRequestInfo` 的值

3. **如果 `hideInputDialog` 没有被调用**
   - 说明代码在 `minimizeDialog()` 中出现了异常
   - 需要检查异常日志

4. **如果 `hideInputDialog` 被调用但状态不正确**
   - 说明 `hideInputDialog()` 内部有问题
   - 需要检查视图可见性和模式设置

## 3. 可见性值说明

Android View 可见性常量：
- `0` = `View.VISIBLE` - 可见
- `4` = `View.INVISIBLE` - 不可见但占用空间
- `8` = `View.GONE` - 不可见且不占用空间

## 4. 请提供的信息

请在测试后提供以下信息：

1. 完整的 Logcat 日志（从点击最小化按钮开始）
2. 实际观察到的 UI 行为
3. 是否看到旋转指示器
4. 再次点击后的行为

## 5. 联系方式

如有问题，请在 Issue 中提供详细的日志信息。

---

**创建人**: Kiro AI  
**创建日期**: 2025-12-09
