# BUG-00001 修复总结

## 问题描述

应用首次启动时，即使悬浮窗开关状态为"开启"，悬浮窗也不会自动显示。必须进入设置页面后才会显示。

## 根本原因

**生命周期不匹配**：悬浮窗服务的恢复逻辑放在了 `SettingsViewModel` 中，只有当用户进入设置页面时才会执行。

```
错误的流程：
应用启动 → 用户可能去任何页面 → 只有进入设置页面 → ViewModel 创建 → 服务恢复 ❌

正确的流程：
应用启动 → Application.onCreate() → 立即检查并恢复服务 ✅
```

## 修复方案

在 `EmpathyApplication.onCreate()` 中添加服务恢复逻辑：

```kotlin
@HiltAndroidApp
class EmpathyApplication : Application() {
    
    @Inject
    lateinit var floatingWindowPreferences: FloatingWindowPreferences
    
    private val applicationScope = CoroutineScope(SupervisorJob() + Dispatchers.Main)
    
    override fun onCreate() {
        super.onCreate()
        restoreFloatingWindowService()
    }
    
    private fun restoreFloatingWindowService() {
        applicationScope.launch {
            val state = floatingWindowPreferences.loadState()
            if (state.isEnabled) {
                val permissionResult = FloatingWindowManager.hasPermission(this@EmpathyApplication)
                if (permissionResult is FloatingWindowManager.PermissionResult.Granted) {
                    FloatingWindowManager.startService(this@EmpathyApplication)
                } else {
                    floatingWindowPreferences.saveEnabled(false)
                }
            }
        }
    }
}
```

## 修复效果

- ✅ 应用启动时立即恢复悬浮窗（如果之前已启用）
- ✅ 不依赖用户进入设置页面
- ✅ 权限丢失时自动重置状态
- ✅ 异步执行，不阻塞应用启动

## 关键教训

**应用级服务应该在应用级别管理**：
- 应用级服务 → `Application.onCreate()`
- Activity 级服务 → `Activity.onCreate()`
- ViewModel 级服务 → `ViewModel.init`

## 修改文件

- `app/src/main/java/com/empathy/ai/app/EmpathyApplication.kt`

## 相关文档

- [BUG-00001-悬浮窗首次启动不显示问题分析.md](./BUG-00001-悬浮窗首次启动不显示问题分析.md) - 完整分析
