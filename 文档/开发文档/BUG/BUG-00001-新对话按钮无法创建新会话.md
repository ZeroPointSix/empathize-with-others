# BUG-00001: 新对话按钮无法创建新会话

## 基本信息

| 项目 | 内容 |
|------|------|
| Bug 编号 | BUG-00001 |
| 优先级 | P0 - 阻断 |
| 状态 | 待修复 |
| 发现日期 | 2026-01-08 |
| 影响功能 | AI军师 - 新建会话 |

## 问题描述

点击"新对话"按钮后，无法正常创建新会话。页面跳转到上一个对话界面，而非创建新对话并跳转到新会话页面。

## 预期行为

1. 点击"新对话"按钮
2. 系统创建新的会话（使用 `CreateAdvisorSessionUseCase`）
3. 获取新创建的会话ID
4. 跳转到聊天界面，显示新会话内容

## 实际行为

点击"新对话"按钮后，直接跳转到上一个对话页面，没有创建新会话。

## 复现步骤

1. 打开 AI军师功能
2. 进入会话历史页面（`/advisor/sessions/{contactId}`）
3. 点击"新建"按钮
4. 观察跳转结果

## 发生频率

- [x] 每次必现
- [ ] 偶发
- [ ] 特定条件下触发

## 问题根因

### 根因分析

**位置**: `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NavGraph.kt:264-291`

**问题1: `onCreateNewSession` 只导航不创建会话**

```kotlin
onCreateNewSession = {
    // 创建新会话并返回对话界面
    navController.navigate(NavRoutes.aiAdvisorChat(contactId)) {
        popUpTo(NavRoutes.AI_ADVISOR_SESSIONS) { inclusive = true }
    }
}
```

- **问题**: `onCreateNewSession` 回调中只有导航代码，没有调用 ViewModel 创建新会话
- **影响**: 创建会话逻辑完全缺失

**问题2: `onNavigateToChat` 参数使用错误**

```kotlin
onNavigateToChat = { sessionId ->
    // 加载指定会话并返回对话界面
    navController.navigate(NavRoutes.aiAdvisorChat(contactId)) {  // 错误: 使用了 contactId
        popUpTo(NavRoutes.AI_ADVISOR_SESSIONS) { inclusive = true }
    }
}
```

- **问题**: 接收 `sessionId` 参数但实际使用 `contactId`
- **影响**: 无论点击哪个会话，都会跳转到相同的页面（基于 contactId）

### 正确实现参考

**`AiAdvisorChatViewModel.createNewSession()`** 已存在且正确实现：

```kotlin
fun createNewSession(forContactId: String = contactId) {
    viewModelScope.launch {
        createAdvisorSessionUseCase(forContactId).onSuccess { session ->
            _uiState.update { currentState ->
                currentState.copy(
                    sessions = listOf(session) + currentState.sessions,
                    currentSessionId = session.id,
                    isLoading = false
                )
            }
            loadConversations(session.id)
        }.onFailure { error ->
            _uiState.update {
                it.copy(error = error.message ?: "创建会话失败")
            }
        }
    }
}
```

## 影响范围

### 功能影响
- 用户无法创建新的 AI军师会话
- 会话历史页面"新建"按钮功能失效
- 用户体验严重受损

### 关联文件

| 文件路径 | 问题 |
|---------|------|
| `presentation/navigation/NavGraph.kt:264-291` | 问题代码位置 |
| `presentation/ui/screen/advisor/SessionHistoryScreen.kt` | 触发"新对话"按钮 |
| `presentation/viewmodel/SessionHistoryViewModel.kt` | 需要添加创建会话逻辑 |
| `domain/usecase/CreateAdvisorSessionUseCase.kt` | 创建会话用例（已存在） |
| `presentation/viewmodel/AiAdvisorChatViewModel.kt:754-771` | 创建会话方法（已存在） |

## 修复方案

### 方案A: 在 ViewModel 中处理创建和导航（推荐）

1. `SessionHistoryViewModel` 添加 `createAndNavigateToNewSession()` 方法
2. 方法内部调用 `createAdvisorSessionUseCase` 创建会话
3. 创建成功后使用 `session.id` 进行导航
4. `NavGraph` 中调用 ViewModel 的方法

### 方案B: 回调中处理

1. 将 `onCreateNewSession` 改为 `suspend` 函数或返回 `Flow`
2. 在回调中执行创建会话逻辑
3. 获取新会话ID后导航

## 验证标准

- [ ] 点击"新建"按钮后创建新会话
- [ ] 新会话出现在会话列表顶部
- [ ] 页面跳转到新会话的聊天界面
- [ ] 点击会话历史中的任意会话能正确跳转到对应会话
- [ ] 单元测试覆盖新逻辑

## 测试用例

见: `测试用例/TC-00001-新对话功能测试.md`

## 备注

相关需求文档:
- PRD-00029: AI军师UI优化 - 三页面导航实现
- TD-00026: AI军师功能
