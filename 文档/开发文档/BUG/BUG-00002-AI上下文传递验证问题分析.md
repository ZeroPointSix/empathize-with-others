# BUG-00002: AI上下文传递验证问题分析

## ✅ 状态：已修复 (2025-12-15)

## 问题描述
无法验证AI是否将联系人的事实(Facts)作为上下文进行传递。需要添加更详细的提示词日志来测试AI上下文传递机制。

## 1. 机制分析

### 框架运行机制
```
用户请求分析 → ContextBuilder.buildContext() → 构建提示词
             → 包含: 联系人信息 + Facts + BrainTags + 历史对话
             → AiRepository.analyzeChat() → 发送到AI API
```

### 正常流程
1. `AnalyzeChatUseCase` 被调用
2. `ContextBuilder` 构建完整上下文：
   - 联系人基本信息（姓名、目标）
   - Facts列表（事实记录）
   - BrainTags（雷区/策略标签）
   - 最近对话历史
3. 将上下文组装成提示词
4. 发送给AI API
5. 返回分析结果

### 当前问题
- 没有日志输出实际发送给AI的提示词内容
- 无法确认Facts是否被正确包含在上下文中
- 调试困难，无法验证记忆系统是否生效

## 2. 潜在根因树（Root Cause Tree）

### 框架机制层
- [ ] `ContextBuilder` 可能没有正确读取Facts
- [ ] Facts到提示词的转换逻辑可能有问题
- [ ] 提示词模板可能没有包含Facts占位符

### 模块行为层
- [ ] `ContactRepository.getProfile()` 返回的Facts可能为空
- [ ] Facts的序列化格式可能不正确
- [ ] 日志级别设置导致关键信息未输出

### 使用方式层
- [ ] 调用链中某个环节没有传递contactId
- [ ] Facts加载时机不对（异步问题）

### 环境层
- [ ] 日志被过滤或禁用
- [ ] Release版本日志被移除

## 3. 排查路径

### 第一步：检查ContextBuilder实现
```kotlin
// 文件: domain/util/ContextBuilder.kt
// 查看buildContext方法如何组装Facts
```

### 第二步：检查PromptTemplates
```kotlin
// 文件: domain/util/PromptTemplates.kt
// 查看提示词模板是否包含Facts
```

### 第三步：检查AnalyzeChatUseCase调用链
```kotlin
// 文件: domain/usecase/AnalyzeChatUseCase.kt
// 查看如何调用ContextBuilder
```

### 第四步：添加日志验证
```kotlin
// 在关键节点添加Log输出
Log.d("AI_CONTEXT", "发送给AI的完整提示词: $prompt")
```

## 4. 最可能的根因

### 根因1：缺少调试日志（最可能）
**推理过程**：
- 代码可能正确实现了上下文传递
- 但没有日志输出，无法验证
- 需要在关键节点添加日志

### 根因2：ContextBuilder未被正确调用
**推理过程**：
- 可能存在多个调用路径
- 某些路径绑过了ContextBuilder
- 导致Facts未被包含

## 5. 稳定修复方案

### 方案：添加详细的提示词日志

#### 5.1 在ContextBuilder中添加日志
```kotlin
// ContextBuilder.kt
fun buildContext(
    contactProfile: ContactProfile,
    chatHistory: List<ConversationLog>,
    currentInput: String
): String {
    Log.d("AI_CONTEXT", "========== 构建AI上下文 ==========")
    Log.d("AI_CONTEXT", "联系人: ${contactProfile.name}")
    Log.d("AI_CONTEXT", "目标: ${contactProfile.targetGoal}")
    Log.d("AI_CONTEXT", "Facts数量: ${contactProfile.facts.size}")
    contactProfile.facts.forEach { fact ->
        Log.d("AI_CONTEXT", "  - ${fact.key}: ${fact.value}")
    }
    Log.d("AI_CONTEXT", "历史对话数量: ${chatHistory.size}")
    
    val prompt = buildPrompt(...)
    Log.d("AI_CONTEXT", "完整提示词:\n$prompt")
    Log.d("AI_CONTEXT", "========== 上下文构建完成 ==========")
    
    return prompt
}
```

#### 5.2 在AiRepositoryImpl中添加日志
```kotlin
// AiRepositoryImpl.kt
override suspend fun analyzeChat(...): Result<AnalysisResult> {
    Log.d("AI_REQUEST", "发送AI请求，提示词长度: ${prompt.length}")
    Log.d("AI_REQUEST", "提示词内容:\n$prompt")
    // ... API调用
}
```

### 机制解释
通过在关键节点添加日志：
1. 可以验证Facts是否被正确加载
2. 可以查看完整的提示词内容
3. 便于调试和问题定位
4. 不影响正常功能

## 6. 待验证项
- [ ] 查看ContextBuilder当前实现
- [ ] 确认PromptTemplates模板内容
- [ ] 添加日志后验证Facts传递
- [ ] 测试不同场景下的上下文构建
