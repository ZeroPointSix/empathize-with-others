# BUG-00003: 用户添加事实不可见问题分析

## ✅ 状态：已修复 (2025-12-15)

## 问题描述
用户通过事实流界面添加的事实(Facts)无法在界面上看到。添加操作可能成功执行，但UI没有更新显示新添加的事实。

## 修复方案
修改`ContactDetailTabViewModel.addFactToStream()`方法，添加`saveProfileUseCase`持久化调用。

### 修改的文件
- `app/src/main/java/com/empathy/ai/presentation/viewmodel/ContactDetailTabViewModel.kt`
  - 添加`SaveProfileUseCase`注入
  - 修改`addFactToStream()`方法，调用`saveProfileUseCase`保存更新后的联系人

## 1. 机制分析

### 框架运行机制
```
用户点击添加 → AddFactToStreamDialog → onConfirm回调
             → ContactDetailUiEvent.AddFactToStream
             → ContactDetailTabViewModel.addFactToStream()
             → 更新UiState.facts → UI重组显示
```

### 正常流程
1. 用户在事实流点击"+"按钮
2. 弹出AddFactToStreamDialog
3. 用户输入事实类型和内容
4. 点击确认，触发AddFactToStream事件
5. ViewModel处理事件，更新facts列表
6. UiState变化触发Compose重组
7. 新事实显示在时间线中

### 当前问题
- 添加事实后，UI没有显示新添加的内容
- 可能是数据未保存，或UI未刷新

## 2. 潜在根因树（Root Cause Tree）

### 框架机制层
- [ ] Compose状态管理：StateFlow更新未触发重组
- [ ] 数据流断裂：事件处理链中某环节失败
- [ ] 时间线构建：Facts未被转换为TimelineItem

### 模块行为层
- [ ] `addFactToStream()` 方法只更新了内存状态，未持久化
- [ ] `loadContactDetail()` 刷新时覆盖了新添加的Facts
- [ ] Facts未被包含在timelineItems构建逻辑中

### 使用方式层
- [ ] 事件未正确传递到ViewModel
- [ ] Dialog的onConfirm回调未被调用

### 环境层
- [ ] 数据库写入失败但未报错

## 3. 排查路径

### 第一步：检查addFactToStream实现
```kotlin
// 文件: ContactDetailTabViewModel.kt
// 查看addFactToStream方法的完整逻辑
```

### 第二步：检查Facts是否被持久化
```kotlin
// 查看是否调用了ContactRepository保存Facts
// Facts应该保存到ContactProfile中
```

### 第三步：检查时间线构建逻辑
```kotlin
// 文件: ContactDetailTabViewModel.kt
// 查看buildTimelineItems方法
// Facts是否被转换为TimelineItem显示
```

### 第四步：检查UI绑定
```kotlin
// 文件: FactStreamTab.kt
// 查看items参数来源
```

## 4. 最可能的根因

### 根因1：Facts未被持久化到数据库（最可能）
**推理过程**：
- 当前`addFactToStream`方法只更新了内存中的`_uiState`
- 没有调用`ContactRepository`保存到数据库
- 刷新页面后数据丢失
- 且`loadContactDetail`会从数据库重新加载，覆盖内存数据

### 根因2：Facts未被转换为TimelineItem
**推理过程**：
- 时间线只显示Conversation、AiSummary、Milestone类型
- Facts可能没有对应的TimelineItem类型
- 导致添加的Facts不会出现在时间线中

### 根因3：刷新逻辑覆盖了新数据
**推理过程**：
- `addFactToStream`最后调用了`loadContactDetail`
- 这会从数据库重新加载数据
- 如果Facts未保存，就会被覆盖

## 5. 稳定修复方案

### 方案：完整实现Facts持久化和显示

#### 5.1 修改addFactToStream方法
```kotlin
private fun addFactToStream(key: String, value: String) {
    if (key.isBlank() || value.isBlank()) return
    
    viewModelScope.launch {
        try {
            val currentState = _uiState.value
            val contact = currentState.contact ?: return@launch
            
            // 创建新的Fact
            val newFact = Fact(
                key = key,
                value = value,
                timestamp = System.currentTimeMillis(),
                source = FactSource.MANUAL
            )
            
            // 更新联系人的facts列表
            val updatedFacts = contact.facts + newFact
            val updatedContact = contact.copy(facts = updatedFacts)
            
            // 持久化到数据库（关键！）
            saveProfileUseCase(updatedContact).onSuccess {
                _uiState.update {
                    it.copy(
                        contact = updatedContact,
                        facts = updatedFacts,
                        showAddFactToStreamDialog = false,
                        successMessage = "事实已添加"
                    )
                }
                // 重新构建时间线
                rebuildTimeline()
            }.onFailure { error ->
                _uiState.update {
                    it.copy(error = "保存失败: ${error.message}")
                }
            }
        } catch (e: Exception) {
            _uiState.update {
                it.copy(error = e.message ?: "添加事实失败")
            }
        }
    }
}
```

#### 5.2 添加Facts到时间线显示（可选）
如果需要在时间线中显示Facts，需要：
1. 在TimelineItem中添加Fact类型
2. 在buildTimelineItems中包含Facts转换

### 机制解释
1. 必须调用Repository保存到数据库，否则数据只在内存中
2. 保存成功后更新UiState，触发UI重组
3. 不要在保存后立即调用loadContactDetail，避免覆盖

## 6. 待验证项
- [ ] 检查addFactToStream当前实现
- [ ] 确认是否注入了SaveProfileUseCase
- [ ] 验证Facts保存后是否持久化
- [ ] 确认时间线是否需要显示Facts
