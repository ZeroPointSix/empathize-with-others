# BUG-00009: 新建联系人标签类型不一致问题分析

## 问题概述

**报告日期**: 2025-12-16  
**严重程度**: 高  
**影响范围**: 新建联系人功能、联系人画像系统  
**状态**: ✅ 已修复

### 问题描述

新建联系人界面添加的"标签"（BrainTag）与联系人画像系统中的"事实"（Fact）是两种完全不同的数据类型，导致：
1. 新建联系人时添加的标签不会显示在联系人画像中
2. 两套系统数据不互通

---

## 1. 【机制分析】

### 1.1 两套完全不同的数据系统

| 特性 | `Fact`（事实） | `BrainTag`（标签） |
|------|---------------|-------------------|
| **用途** | 客观事实信息（key-value） | 主观策略/警告（雷区/策略） |
| **存储位置** | `ContactProfile.facts` | 独立的 `brain_tags` 表 |
| **类型选项** | 预设类型（性格特点、兴趣爱好等） | 雷区(RISK_RED) / 策略(STRATEGY_GREEN) |
| **使用场景** | 事实流中添加、联系人画像 | 旧的新建联系人界面 |
| **UI组件** | `AddFactToStreamDialog` | `AddTagDialog` |
| **数据模型** | `Fact(key, value, timestamp, source)` | `BrainTag(id, contactId, content, type, source)` |

### 1.2 数据流对比

**事实流系统（新UI）**:
```
AddFactToStreamDialog 
  → ContactDetailUiEvent.AddFactToStream(key, value)
  → addFactToStream() 
  → 创建 Fact 对象
  → 保存到 ContactProfile.facts
  → 显示在事实流时间线
```

**标签系统（旧UI）**:
```
AddTagDialog 
  → ContactDetailUiEvent.ConfirmAddTag
  → confirmAddTag() → addBrainTag()
  → 创建 BrainTag 对象
  → 保存到 brain_tags 表
  → 显示在旧UI的标签列表
```

### 1.3 问题根源

新建联系人界面使用的是 `AddTagDialog`（添加 BrainTag），但联系人画像系统使用的是 `Fact`。这两个是完全不同的数据模型，数据不互通。

---

## 2. 【潜在根因树】

```
新建联系人标签不显示在画像中
├── 框架机制层
│   ├── [确定] Fact 和 BrainTag 是两种不同的数据模型
│   ├── [确定] Fact 存储在 ContactProfile.facts
│   └── [确定] BrainTag 存储在独立的 brain_tags 表
│
├── 模块行为层
│   ├── [确定] 新建联系人界面使用 AddTagDialog（添加 BrainTag）
│   ├── [确定] 事实流使用 AddFactToStreamDialog（添加 Fact）
│   └── [确定] 联系人画像只显示 Fact，不显示 BrainTag
│
├── 使用方式层
│   └── [确定] 用户期望在新建联系人时添加的信息能在画像中显示
│
└── 设计层
    └── [确定] 两套系统设计时没有统一数据模型
```

---

## 3. 【排查路径】

### 3.1 排查清单

- [x] 确认新建联系人界面使用的对话框 → `AddTagDialog`
- [x] 确认事实流使用的对话框 → `AddFactToStreamDialog`
- [x] 确认 `AddTagDialog` 添加的数据类型 → `BrainTag`
- [x] 确认 `AddFactToStreamDialog` 添加的数据类型 → `Fact`
- [x] 确认联系人画像显示的数据类型 → `Fact`
- [x] 确认两种数据的存储位置不同

---

## 4. 【最可能的根因】

### 根因：数据模型不统一

**推理过程**:

1. 新建联系人界面（`ContactDetailScreen`）使用 `AddTagDialog`
2. `AddTagDialog` 添加的是 `BrainTag`（雷区/策略类型）
3. 联系人画像系统（`ContactDetailTabScreen`）显示的是 `Fact`
4. `Fact` 和 `BrainTag` 是两种完全不同的数据模型
5. 因此，新建联系人时添加的 `BrainTag` 不会显示在联系人画像中

---

## 5. 【稳定修复方案】

### 方案选择

有两种修复方案：

**方案A：统一使用 Fact（推荐）**
- 将新建联系人界面的标签添加改为添加 `Fact`
- 使用 `AddFactToStreamDialog` 替换 `AddTagDialog`
- 优点：数据统一，用户体验一致
- 缺点：需要修改新建联系人界面的逻辑

**方案B：保持两套系统并存**
- 在联系人画像中同时显示 `Fact` 和 `BrainTag`
- 优点：不需要修改现有逻辑
- 缺点：数据模型复杂，维护成本高

### 推荐方案A的实现

1. 修改 `ContactDetailScreen.kt`：
   - 将 `AddTagDialog` 替换为 `AddFactToStreamDialog`
   - 修改相关事件处理

2. 修改 `ContactDetailViewModel.kt`：
   - 添加 `addFactToProfile()` 方法
   - 将事实添加到 `editedProfile.facts`

3. 修改 `ContactDetailUiState.kt`：
   - 移除或保留 `showAddTagDialog` 相关状态
   - 添加 `showAddFactDialog` 相关状态（如果需要）

---

## 6. 【修改的文件】

| 文件 | 修改内容 |
|------|----------|
| `ContactDetailScreen.kt` | 将 `AddTagDialog` 替换为 `AddFactToStreamDialog` |
| `ContactDetailViewModel.kt` | 添加 `addFactToProfile()` 方法 |
| `ContactDetailUiEvent.kt` | 添加新的事件类型（如需要） |

---

## 7. 【测试验证】

### 手动测试步骤

1. 打开应用，进入联系人列表
2. 点击"添加联系人"按钮
3. 点击"添加事实"（原来的"添加标签"）
4. 选择事实类型（如"性格特点"），输入内容
5. 点击添加
6. 填写联系人姓名和目标
7. 点击保存
8. 进入联系人画像（事实流标签页）
9. **预期结果**: 刚才添加的事实应该显示在事实流中

---

## 8. 【相关文件】

- `app/src/main/java/com/empathy/ai/presentation/ui/screen/contact/ContactDetailScreen.kt`
- `app/src/main/java/com/empathy/ai/presentation/viewmodel/ContactDetailViewModel.kt`
- `app/src/main/java/com/empathy/ai/presentation/ui/component/dialog/AddTagDialog.kt`
- `app/src/main/java/com/empathy/ai/presentation/ui/component/dialog/AddFactToStreamDialog.kt`
- `app/src/main/java/com/empathy/ai/domain/model/Fact.kt`
- `app/src/main/java/com/empathy/ai/domain/model/BrainTag.kt`
