# BUG-00010: 自定义提示词未生效问题分析

## 文档信息

**文档编号**: BUG-00010  
**版本**: 1.0  
**创建日期**: 2025-12-16  
**状态**: ✅ 已修复  
**严重程度**: 🔴 高  
**影响范围**: 所有使用Function Calling策略的AI分析功能

---

## 问题描述

用户在提示词编辑界面设置了自定义提示词后，AI分析结果没有体现用户的自定义指令。

### 用户反馈

用户报告自定义提示词没有生效，AI回复仍然使用默认的分析风格。

### 日志分析

从API请求日志中发现，system prompt是硬编码的默认值 `SYSTEM_ANALYZE_FC`，用户自定义提示词未被注入到API请求中。

---

## 根因分析

### 问题定位

文件: `app/src/main/java/com/empathy/ai/data/repository/AiRepositoryImpl.kt`

在 `analyzeChat()` 方法中，当使用 **Function Calling** 策略时，代码直接使用了硬编码的 `SYSTEM_ANALYZE_FC`，**完全忽略了传入的 `systemInstruction` 参数**。

### 问题代码（修复前）

```kotlin
val request = when (strategy) {
    ProviderCompatibility.StructuredOutputStrategy.FUNCTION_CALLING -> {
        // 使用 Function Calling（最可靠）
        val messages = listOf(
            MessageDto(role = "system", content = SYSTEM_ANALYZE_FC),  // ← 问题：硬编码！
            MessageDto(role = "user", content = promptContext)
        )
        // ...
    }
    ProviderCompatibility.StructuredOutputStrategy.RESPONSE_FORMAT -> {
        // 使用 response_format
        val baseMessages = listOf(
            MessageDto(role = "system", content = systemInstruction.ifEmpty { SYSTEM_ANALYZE }),  // ✅ 正确
            // ...
        )
        // ...
    }
    ProviderCompatibility.StructuredOutputStrategy.PROMPT_ONLY -> {
        // 仅使用提示词约束
        val messages = listOf(
            MessageDto(role = "system", content = systemInstruction.ifEmpty { SYSTEM_ANALYZE }),  // ✅ 正确
            // ...
        )
        // ...
    }
}
```

### 调用链分析

1. `AnalyzeChatUseCase.invoke()` 调用 `promptBuilder.buildSystemInstruction()` 构建自定义指令
2. 构建好的 `systemInstruction` 传递给 `aiRepository.analyzeChat()`
3. 但 `AiRepositoryImpl.analyzeChat()` 在 Function Calling 模式下**忽略了这个参数**

---

## 修复方案

### 修复代码

将用户自定义提示词与 Function Calling 的基础指令合并：

```kotlin
ProviderCompatibility.StructuredOutputStrategy.FUNCTION_CALLING -> {
    // 使用 Function Calling（最可靠）
    // 合并用户自定义指令与Function Calling基础指令
    val effectiveSystemInstruction = if (systemInstruction.isNotBlank()) {
        "$SYSTEM_ANALYZE_FC\n\n$systemInstruction"
    } else {
        SYSTEM_ANALYZE_FC
    }
    android.util.Log.d("AiRepositoryImpl", "SystemInstruction长度: ${effectiveSystemInstruction.length} 字符")
    android.util.Log.d("AiRepositoryImpl", "SystemInstruction预览(前500字符): ${effectiveSystemInstruction.take(500)}")
    
    val messages = listOf(
        MessageDto(role = "system", content = effectiveSystemInstruction),
        MessageDto(role = "user", content = promptContext)
    )
    // ...
}
```

### 修复说明

1. **保留Function Calling基础指令**: `SYSTEM_ANALYZE_FC` 包含了调用 `generate_analysis_result` 函数的必要说明
2. **追加用户自定义指令**: 在基础指令后追加用户的自定义提示词
3. **添加调试日志**: 方便后续排查问题

---

## 影响评估

### 修复后的行为

- Function Calling 策略现在会正确使用用户自定义提示词
- 用户在设置页面配置的全局提示词会生效
- 用户为特定联系人配置的专属提示词会生效

### 兼容性

- 不影响 `RESPONSE_FORMAT` 和 `PROMPT_ONLY` 策略（它们本来就正确）
- 不影响未配置自定义提示词的用户（使用默认指令）

---

## 测试验证

### 验证步骤

1. 在设置页面编辑"分析场景"的全局提示词
2. 进入聊天界面，点击"帮我分析"
3. 检查日志中的 `SystemInstruction预览` 是否包含用户自定义内容
4. 验证AI回复是否体现了自定义指令的要求

### 预期结果

- 日志显示合并后的系统指令
- AI回复风格符合用户自定义要求

---

## 相关文件

| 文件 | 修改类型 | 说明 |
|------|---------|------|
| `app/src/main/java/com/empathy/ai/data/repository/AiRepositoryImpl.kt` | 修改 | 修复Function Calling分支忽略systemInstruction的问题 |

---

## 相关文档

- [TD-00006-提示词编辑界面任务清单](../TD/TD-00006-提示词编辑界面任务清单.md)
- [TDD-00005-提示词管理系统技术设计](../TDD/TDD-00005-提示词管理系统技术设计.md)
