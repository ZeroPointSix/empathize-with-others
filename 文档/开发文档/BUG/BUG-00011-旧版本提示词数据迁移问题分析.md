# BUG-00011: 旧版本提示词数据迁移问题分析

## 问题描述

用户设备上仍然显示旧的带变量占位符的提示词内容，如：
```
请分析与「{contact_name}」的聊天内容，提供沟通建议。
当前关系状态：{{relationship_status}}
已知雷区：{risk_tags}
有效策略：{{strategy_tags}}
```

## 根因分析

### 1. 机制分析

提示词系统的数据读取流程：
```
PromptRepositoryImpl.getGlobalPrompt(scene)
  → PromptFileStorage.readGlobalConfig()
    → 检查缓存 → 读取 global_prompts.json 文件
  → config.prompts[scene]?.userPrompt ?: DefaultPrompts.getDefault(scene)
```

**关键点**：只有当文件中没有数据时，才会使用 `DefaultPrompts.getDefault(scene)` 返回默认值。

### 2. 问题根因

1. **代码修改**：`DefaultPrompts.kt` 已修改为返回空字符串（正确）
2. **数据持久化**：用户设备上已存在 `global_prompts.json` 文件，保存了旧的带变量的提示词
3. **读取逻辑**：因为文件中有数据，所以返回的是旧数据，而不是新的默认值

### 3. 潜在根因树

```
用户看到旧提示词
├── 框架机制层
│   └── 数据持久化优先于默认值（设计如此）
├── 模块行为层
│   ├── PromptFileStorage 没有版本迁移逻辑
│   └── 旧版本数据格式与新版本不兼容
├── 使用方式层
│   └── 用户已保存旧版本提示词到本地文件
└── 环境层
    └── 用户设备上存在 global_prompts.json 文件
```

## 解决方案

### 方案选择

| 方案 | 优点 | 缺点 |
|------|------|------|
| A. 自动迁移 | 用户无感知，一次性解决 | 需要修改存储层代码 |
| B. 手动恢复默认 | 实现简单 | 需要用户操作，可能不知道如何操作 |

**选择方案A**：在 `PromptFileStorage` 中添加版本迁移逻辑

### 实现细节

#### 1. 版本号管理

```kotlin
companion object {
    /**
     * 当前配置版本号
     *
     * 版本历史：
     * - v1: 初始版本，用户提示词包含变量占位符
     * - v2: 三层分离架构，用户提示词不再包含变量占位符
     */
    private const val CURRENT_CONFIG_VERSION = 2

    /**
     * 旧版本提示词中的变量占位符模式
     */
    private val LEGACY_VARIABLE_PATTERN = Regex("""\{+\w+\}+""")
}
```

#### 2. 迁移逻辑

在 `parseConfig()` 方法中添加迁移检测：

```kotlin
// 检测是否需要迁移（旧版本数据）
val needsMigration = version < CURRENT_CONFIG_VERSION

// 迁移逻辑：如果是旧版本且包含变量占位符，清空用户提示词
if (needsMigration && containsLegacyVariables(userPrompt)) {
    userPrompt = ""
}

// 返回迁移后的配置（使用新版本号）
GlobalPromptConfig(
    version = if (needsMigration) CURRENT_CONFIG_VERSION else version,
    ...
)
```

#### 3. 自动持久化

在 `readGlobalConfig()` 中检测迁移并自动保存：

```kotlin
// 检查是否发生了迁移（版本号变化）
val originalVersion = extractVersionFromJson(json)
if (originalVersion < CURRENT_CONFIG_VERSION) {
    // 迁移后自动保存，确保下次读取时不需要再次迁移
    writeGlobalConfigInternal(config)
}
```

## 修改文件

1. `app/src/main/java/com/empathy/ai/data/local/PromptFileStorage.kt`
   - 添加版本号常量 `CURRENT_CONFIG_VERSION = 2`
   - 添加变量检测正则 `LEGACY_VARIABLE_PATTERN`
   - 在 `parseConfig()` 中添加迁移逻辑
   - 在 `readGlobalConfig()` 中添加自动保存逻辑
   - 添加 `containsLegacyVariables()` 和 `extractVersionFromJson()` 辅助方法

2. `app/src/test/java/com/empathy/ai/data/local/PromptFileStorageTest.kt`
   - 添加迁移测试用例

## 测试用例

1. `readGlobalConfig should migrate v1 config with legacy variables` - 验证v1配置自动迁移
2. `readGlobalConfig should not migrate v2 config` - 验证v2配置不受影响
3. `readGlobalConfig should detect various legacy variable patterns` - 验证各种变量模式检测
4. `readGlobalConfig should persist migrated config` - 验证迁移后自动保存

## 迁移行为

| 场景 | 原始内容 | 迁移后内容 |
|------|----------|------------|
| 包含 `{contact_name}` | 旧提示词 | 空字符串 |
| 包含 `{{risk_tags}}` | 旧提示词 | 空字符串 |
| 不包含变量 | 用户自定义内容 | 保持不变 |
| v2版本配置 | 任何内容 | 保持不变 |

## 状态

- [x] 根因分析完成
- [x] 解决方案设计
- [x] 代码实现
- [x] 单元测试
- [ ] 集成测试（需要Android设备）

## 相关文档

- [TDD-00007-提示词系统三层分离架构设计](../TDD/TDD-00007-提示词系统三层分离架构设计.md)
- [BUG-00010-自定义提示词未生效问题分析](./BUG-00010-自定义提示词未生效问题分析.md)
