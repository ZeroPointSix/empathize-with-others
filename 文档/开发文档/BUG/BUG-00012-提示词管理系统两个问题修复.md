# BUG-00012: 提示词管理系统两个问题修复

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档编号 | BUG-00012 |
| 创建日期 | 2025-12-17 |
| 状态 | ✅ 已修复 |
| 关联文档 | PRD-00005, PRD-00006, TDD-00005, TDD-00006 |

---

## 1. 问题描述

### 问题1：全局和私有提示词同时起作用

**现象**：用户设置了联系人专属提示词后，全局提示词仍然会被包含在最终的AI指令中。

**用户期望**：当联系人存在专属提示词时，全局提示词不应该起作用（覆盖语义）。

### 问题2：删除全部内容后无法保存

**现象**：用户将全局提示词内容全部删除后，点击保存时提示"提示词不能为空"，无法保存。

**用户期望**：可以清空自定义提示词，恢复到"无自定义"状态（使用系统默认）。

---

## 2. 根因分析

### 问题1根因

**位置**：`PromptBuilder.buildSystemInstruction()`

**原代码逻辑**：
```kotlin
// 2. 用户全局指令（用户可编辑）
val globalPrompt = getGlobalPromptSafely(scene)
if (globalPrompt.isNotBlank()) {
    appendLine(USER_PROMPT_TITLE)
    ...
}

// 3. 联系人专属指令（用户可编辑）
if (contactId != null) {
    val contactPrompt = getContactPromptSafely(contactId)
    if (!contactPrompt.isNullOrBlank()) {
        appendLine(CONTACT_PROMPT_TITLE)
        ...
    }
}
```

**问题**：代码逻辑是**顺序追加**，不是条件互斥。全局指令和联系人指令会同时出现在最终指令中。

### 问题2根因

**位置**：`PromptValidator.validate()`

**原代码逻辑**：
```kotlin
// 1. 检查空值
if (prompt.isBlank()) {
    return PromptValidationResult.Error(
        message = "提示词不能为空",
        errorType = PromptValidationResult.ErrorType.EMPTY_PROMPT
    )
}
```

**问题**：验证器将空值视为错误，但业务场景中空值是合法的（表示"不使用自定义指令，使用系统默认"）。

---

## 3. 修复方案

### 问题1修复：实现覆盖语义

**修改文件**：`app/src/main/java/com/empathy/ai/domain/util/PromptBuilder.kt`

**修改内容**：
```kotlin
// 2. 用户指令层（联系人专属指令优先）
// 先获取联系人专属指令
val contactPrompt = if (contactId != null) {
    getContactPromptSafely(contactId)
} else null

if (!contactPrompt.isNullOrBlank()) {
    // 联系人专属指令存在，只使用联系人指令（覆盖全局）
    appendLine(CONTACT_PROMPT_TITLE)
    val resolvedPrompt = variableResolver.resolve(contactPrompt, context)
    appendLine(resolvedPrompt)
    appendLine()
} else {
    // 联系人指令不存在，使用全局指令
    val globalPrompt = getGlobalPromptSafely(scene)
    if (globalPrompt.isNotBlank()) {
        appendLine(USER_PROMPT_TITLE)
        val resolvedPrompt = variableResolver.resolve(globalPrompt, context)
        appendLine(resolvedPrompt)
        appendLine()
    }
}
```

**修复原理**：
- 先检查联系人专属指令是否存在
- 存在则只使用联系人指令，跳过全局指令
- 不存在则使用全局指令
- 符合用户心智模型："我给这个联系人设置了专属指令，就不要用全局的了"

### 问题2修复：允许空值

**修改文件**：`app/src/main/java/com/empathy/ai/domain/util/PromptValidator.kt`

**修改内容**：
```kotlin
fun validate(
    prompt: String,
    scene: PromptScene,
    allowEmpty: Boolean = true  // 新增参数，默认允许空值
): PromptValidationResult {
    // 1. 检查空值（仅在不允许空值时报错）
    if (prompt.isBlank()) {
        return if (allowEmpty) {
            // 空值合法，表示使用系统默认或清除自定义指令
            PromptValidationResult.Success
        } else {
            PromptValidationResult.Error(
                message = "提示词不能为空",
                errorType = PromptValidationResult.ErrorType.EMPTY_PROMPT
            )
        }
    }
    // ... 其他验证逻辑不变
}
```

**修复原理**：
- 新增`allowEmpty`参数，默认为`true`
- 空值时根据参数决定是返回Success还是Error
- 保持向后兼容，现有调用不受影响

**修改文件**：`app/src/main/java/com/empathy/ai/data/repository/PromptRepositoryImpl.kt`

**修改内容**：
```kotlin
override suspend fun saveGlobalPrompt(scene: PromptScene, prompt: String): Result<Unit> {
    // 1. 验证长度和变量（允许空值，空值表示使用系统默认）
    val validationResult = validator.validate(prompt, scene, allowEmpty = true)
    // ...
    
    // 2. 安全性检查（仅非空时检查）
    if (prompt.isNotBlank()) {
        val sanitizeResult = PromptSanitizer.detectDangerousContent(prompt)
        // ...
    }
    // ...
}
```

---

## 4. 修改文件清单

| 文件 | 修改类型 | 说明 |
|------|---------|------|
| `domain/util/PromptBuilder.kt` | 修改 | 实现联系人指令覆盖全局指令的语义 |
| `domain/util/PromptValidator.kt` | 修改 | 新增allowEmpty参数，允许空值 |
| `data/repository/PromptRepositoryImpl.kt` | 修改 | 调用验证器时传入allowEmpty=true |

---

## 5. 测试验证

### 已更新的测试用例

**PromptValidatorTest.kt**：
- `validate should return Success for empty prompt when allowEmpty is true`
- `validate should return Error for empty prompt when allowEmpty is false`
- `validateAll should validate all scenes with allowEmpty true by default`
- `validateAll should reject empty prompts when allowEmpty is false`

**PromptBuilderTest.kt**：
- `buildSystemInstruction should use contact prompt and skip global when contact prompt exists`
- `buildSystemInstruction should use global prompt when contact prompt is null`
- `buildSystemInstruction should use global prompt when contact prompt is blank`
- `getUserInstructionOnly should use contact instruction and skip global when contact exists`

---

## 6. 验收标准

- [x] 联系人专属提示词存在时，全局提示词不出现在最终指令中
- [x] 联系人专属提示词为空时，使用全局提示词
- [x] 全局提示词可以保存为空值
- [x] 联系人提示词可以保存为空值（清除专属指令）
- [x] 相关单元测试通过
- [x] 主代码无编译错误

---

## 7. 相关文档

- [PRD-00005-提示词管理系统需求](../PRD/PRD-00005-提示词管理系统需求.md)
- [PRD-00006-提示词编辑界面需求](../PRD/PRD-00006-提示词编辑界面需求.md)
- [TDD-00005-提示词管理系统技术设计](../TDD/TDD-00005-提示词管理系统技术设计.md)
- [提示词系统三层分离架构设计](../../特殊要求/提示词系统三层分离架构设计.md)
