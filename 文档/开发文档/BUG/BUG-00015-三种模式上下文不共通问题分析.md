# BUG-00015 三种模式上下文不共通问题分析

> 创建日期: 2024-12-18
> 状态: ✅ 已修复
> 优先级: 高
> 修复日期: 2024-12-18

## 问题描述

悬浮窗的三种模式（分析/润色/回复）之间上下文不共通。例如：
- 用户在"分析"Tab输入对方消息并获得分析结果
- 切换到"回复"Tab时，AI不知道之前分析的内容
- 切换到"润色"Tab时，AI也不知道之前的对话上下文

## 根因分析

### 1. 框架机制层

| UseCase | 是否读取历史对话 | 是否保存对话 | 上下文来源 |
|---------|-----------------|-------------|-----------|
| AnalyzeChatUseCase | ✅ 是 | ✅ 是 | 历史 + 当前输入 |
| PolishDraftUseCase | ❌ 否 | ❌ 否 | 仅当前草稿 |
| GenerateReplyUseCase | ❌ 否 | ✅ 是 | 仅当前消息 |

### 2. 根本原因

1. **UseCase设计缺陷**：`PolishDraftUseCase` 和 `GenerateReplyUseCase` 在 TD-00009 中新增，未继承 TD-00007 的历史上下文能力
2. **历史上下文未统一抽象**：`ConversationContextBuilder` 仅在 `AnalyzeChatUseCase` 中使用
3. **会话状态管理缺失**：`FloatingWindowService` 未维护跨Tab的会话上下文

### 3. 代码证据

**AnalyzeChatUseCase（有历史上下文）**：
```kotlin
// 5. 【对话上下文连续性】先查询历史
val historyContext = if (historyCount > 0) {
    buildHistoryContext(contactId, historyCount)  // ✅ 读取历史
} else { "" }
```

**PolishDraftUseCase（无历史上下文）**：
```kotlin
private fun buildRuntimeData(draft: String, redTags: List<BrainTag>): String {
    return buildString {
        appendLine("【用户草稿】")
        appendLine(draft)
        // ❌ 没有历史对话
    }
}
```

**GenerateReplyUseCase（无历史上下文）**：
```kotlin
private fun buildRuntimeData(...): String {
    return buildString {
        appendLine("【对方消息】")
        appendLine(message)
        // ❌ 没有历史对话
    }
}
```

## 修复方案

### 方案：统一历史上下文服务

将历史上下文构建逻辑抽象为独立服务 `SessionContextService`，所有UseCase共享。

#### 新增文件

1. `domain/service/SessionContextService.kt` - 会话上下文服务

#### 修改文件

1. `PolishDraftUseCase.kt` - 注入 SessionContextService，添加历史上下文
2. `GenerateReplyUseCase.kt` - 注入 SessionContextService，添加历史上下文
3. `di/MemoryModule.kt` - 提供 SessionContextService

### 实施步骤

1. **阶段1**：创建 `SessionContextService`，从 `AnalyzeChatUseCase` 提取历史上下文逻辑
2. **阶段2**：修改 `PolishDraftUseCase`，注入并使用 `SessionContextService`
3. **阶段3**：修改 `GenerateReplyUseCase`，注入并使用 `SessionContextService`
4. **阶段4**：集成测试，验证跨Tab上下文共享

## 测试用例

### 单元测试

1. `SessionContextServiceTest` - 测试历史上下文构建
2. `PolishDraftUseCaseTest` - 验证润色时包含历史上下文
3. `GenerateReplyUseCaseTest` - 验证回复时包含历史上下文

### 集成测试

1. 验证跨Tab上下文共享
2. 验证历史对话正确传递给AI

## 相关文档

- PRD-00009 悬浮窗功能重构需求
- TDD-00007 对话上下文连续性增强技术设计
- TDD-00009 悬浮窗功能重构技术设计


---

## 修复记录

### 修复内容

1. **新增 `SessionContextService`** (`domain/service/SessionContextService.kt`)
   - 统一管理历史对话上下文的构建
   - 所有UseCase共享使用
   - 支持配置化的历史条数

2. **修改 `PolishDraftUseCase`**
   - 注入 `SessionContextService`
   - 在 `buildRuntimeData()` 中添加历史上下文
   - 历史对话放在最前面，让AI先了解背景

3. **修改 `GenerateReplyUseCase`**
   - 注入 `SessionContextService`
   - 在保存当前输入之前获取历史上下文（避免把当前输入也当作历史）
   - 在 `buildRuntimeData()` 中添加历史上下文

4. **更新 `FloatingWindowModule`**
   - 为 `PolishDraftUseCase` 和 `GenerateReplyUseCase` 添加 `SessionContextService` 依赖注入

### 新增测试

1. `SessionContextServiceTest` - 12个测试用例
   - 正常获取历史上下文
   - 历史条数为0时返回空
   - 没有历史记录时返回空
   - 异常处理和降级
   - 自定义历史条数
   - 检查是否有历史对话

2. `PolishDraftUseCaseTest` - 新增3个测试用例
   - 验证历史上下文被包含在运行时数据中
   - 验证调用了SessionContextService
   - 验证空历史时正常工作

3. `GenerateReplyUseCaseTest` - 新增3个测试用例
   - 验证历史上下文被包含在运行时数据中
   - 验证在保存当前输入之前获取历史
   - 验证空历史时正常工作

### 修复效果

修复后，三种模式（分析/润色/回复）共享同一个历史对话上下文：
- 用户在"分析"Tab输入对方消息 → 保存到对话记录
- 切换到"回复"Tab → AI能看到之前分析的内容
- 切换到"润色"Tab → AI也能看到整个对话上下文

### 文件变更清单

| 文件 | 变更类型 | 说明 |
|-----|---------|------|
| `domain/service/SessionContextService.kt` | 新增 | 会话上下文服务 |
| `domain/usecase/PolishDraftUseCase.kt` | 修改 | 添加历史上下文支持 |
| `domain/usecase/GenerateReplyUseCase.kt` | 修改 | 添加历史上下文支持 |
| `di/FloatingWindowModule.kt` | 修改 | 更新依赖注入 |
| `test/.../SessionContextServiceTest.kt` | 新增 | 单元测试 |
| `test/.../PolishDraftUseCaseTest.kt` | 修改 | 添加历史上下文测试 |
| `test/.../GenerateReplyUseCaseTest.kt` | 修改 | 添加历史上下文测试 |
