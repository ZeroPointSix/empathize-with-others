# BUG-00018 åˆ†ææ¨¡å¼å¤åˆ¶/é‡æ–°ç”ŸæˆæŒ‰é’®ä¸å¯è§é—®é¢˜åˆ†æ

> åˆ›å»ºæ—¥æœŸ: 2025-12-18
> çŠ¶æ€: âœ… å·²ä¿®å¤
> ä¼˜å…ˆçº§: é«˜
> å…³è”é—®é¢˜: BUG-00017
> ä¿®å¤æ—¥æœŸ: 2025-12-18

---

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼š
- **åˆ†ææŒ‰é’®**çš„ç»“æœæ²¡æœ‰æ˜¾ç¤º"å¤åˆ¶"å’Œ"é‡æ–°ç”Ÿæˆ"ä¸¤ä¸ªé€‰é¡¹
- **æ¶¦è‰²å’Œå›å¤æŒ‰é’®**çš„ç»“æœæ­£å¸¸æ˜¾ç¤ºè¿™ä¸¤ä¸ªé€‰é¡¹
- æ€€ç–‘æ˜¯åˆ†æçš„æ–‡å­—æ¯”è¾ƒå¤šï¼Œå¯¼è‡´æŒ‰é’®æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥

---

## ä¸€ã€æœºåˆ¶åˆ†æ

### 1.1 æ‚¬æµ®çª—ç»“æœå±•ç¤ºæœºåˆ¶

**æ­£å¸¸æµç¨‹ï¼š**
```
ç”¨æˆ·ç‚¹å‡»"åˆ†æ/æ¶¦è‰²/å›å¤"æŒ‰é’®
  â†’ FloatingWindowServiceå¤„ç†è¯·æ±‚
  â†’ è°ƒç”¨å¯¹åº”UseCaseï¼ˆAnalyzeChatUseCase/PolishDraftUseCase/GenerateReplyUseCaseï¼‰
  â†’ AIè¿”å›ç»“æœ
  â†’ FloatingViewV2.showResult(AiResult)
  â†’ ResultCard.showResult(result)
    â†’ æ ¹æ®ç»“æœç±»å‹è°ƒç”¨showAnalysisResult/showPolishResult/showReplyResult
    â†’ è®¾ç½®å†…å®¹æ–‡æœ¬
    â†’ è°ƒç”¨ensureButtonsVisible()ç¡®ä¿æŒ‰é’®å¯è§
  â†’ ç”¨æˆ·çœ‹åˆ°ç»“æœå’Œæ“ä½œæŒ‰é’®
```

### 1.2 ResultCardå¸ƒå±€ç»“æ„

```
MaterialCardView (result_card)
â””â”€â”€ LinearLayout (VERTICAL, padding=12dp)
    â”œâ”€â”€ LinearLayout (æ ‡é¢˜æ ï¼Œå›ºå®šé«˜åº¦)
    â”‚   â”œâ”€â”€ TextView (result_title) - "ğŸ” åˆ†æç»“æœ"
    â”‚   â””â”€â”€ TextView (risk_badge) - é£é™©ç­‰çº§æ ‡ç­¾
    â”‚
    â”œâ”€â”€ ScrollView (result_scroll, maxHeight=220dp) â† å…³é”®çº¦æŸ
    â”‚   â””â”€â”€ LinearLayout
    â”‚       â”œâ”€â”€ TextView (result_content) - ç»“æœå†…å®¹
    â”‚       â”œâ”€â”€ LinearLayout (risk_warning_container) - é£é™©æç¤º
    â”‚       â””â”€â”€ TextView (strategy_note) - ç­–ç•¥è¯´æ˜
    â”‚
    â””â”€â”€ LinearLayout (æŒ‰é’®æ ï¼Œå›ºå®šåœ¨åº•éƒ¨)
        â”œâ”€â”€ MaterialButton (btn_copy) - å¤åˆ¶
        â””â”€â”€ MaterialButton (btn_regenerate) - é‡æ–°ç”Ÿæˆ
```

### 1.3 ä¸‰ç§ç»“æœç±»å‹çš„å†…å®¹å·®å¼‚

| ç±»å‹ | å†…å®¹é•¿åº¦ | é¢å¤–å…ƒç´  |
|------|----------|----------|
| åˆ†æ(ANALYZE) | **æœ€é•¿** - åŒ…å«å†›å¸ˆåˆ†æ+è¯æœ¯å»ºè®® | é£é™©ç­‰çº§æ ‡ç­¾(riskBadge) |
| æ¶¦è‰²(POLISH) | ä¸­ç­‰ - æ¶¦è‰²åçš„æ–‡æœ¬ | é£é™©æç¤º(riskWarningContainer) |
| å›å¤(REPLY) | ä¸­ç­‰ - å»ºè®®å›å¤ | ç­–ç•¥è¯´æ˜(strategyNote) |

**åˆ†æç»“æœå†…å®¹æ ¼å¼ï¼š**
```
ã€å†›å¸ˆåˆ†æã€‘
{strategyAnalysis} â† é€šå¸¸è¾ƒé•¿

ã€è¯æœ¯å»ºè®®ã€‘
{replySuggestion} â† é€šå¸¸è¾ƒé•¿
```

### 1.4 BUG-00017å·²ä¿®å¤çš„å†…å®¹

æ ¹æ®BUG-00017æ–‡æ¡£ï¼Œå·²ç»åšäº†ä»¥ä¸‹ä¿®å¤ï¼š
1. å°†é£é™©æç¤ºå’Œç­–ç•¥è¯´æ˜ç§»å…¥ScrollView
2. ScrollViewè®¾ç½®maxHeight=220dp
3. æŒ‰é’®æ å›ºå®šåœ¨ScrollViewå¤–éƒ¨åº•éƒ¨
4. æ·»åŠ ensureButtonsVisible()æ–¹æ³•æ˜¾å¼è®¾ç½®æŒ‰é’®å¯è§

---

## äºŒã€æ½œåœ¨æ ¹å› æ ‘ï¼ˆRoot Cause Treeï¼‰

```
åˆ†ææ¨¡å¼æŒ‰é’®ä¸å¯è§é—®é¢˜
â”œâ”€â”€ æ¡†æ¶æœºåˆ¶å±‚
â”‚   â”œâ”€â”€ Android Viewæµ‹é‡æœºåˆ¶
â”‚   â”‚   â”œâ”€â”€ âš ï¸ ScrollView maxHeightåœ¨æŸäº›æƒ…å†µä¸‹ä¸ç”Ÿæ•ˆ
â”‚   â”‚   â””â”€â”€ âš ï¸ WRAP_CONTENTå¯èƒ½å¯¼è‡´çˆ¶å®¹å™¨è¶…å‡ºå±å¹•
â”‚   â”œâ”€â”€ WindowManageræ‚¬æµ®çª—é™åˆ¶
â”‚   â”‚   â””â”€â”€ âš ï¸ æ‚¬æµ®çª—æ•´ä½“é«˜åº¦å¯èƒ½è¶…å‡ºå±å¹•
â”‚   â””â”€â”€ View visibilityæœºåˆ¶
â”‚       â””â”€â”€ âš ï¸ æŒ‰é’®å¯èƒ½è¢«å…¶ä»–Viewé®æŒ¡
â”‚
â”œâ”€â”€ æ¨¡å—è¡Œä¸ºå±‚
â”‚   â”œâ”€â”€ ResultCardå¸ƒå±€é—®é¢˜
â”‚   â”‚   â”œâ”€â”€ âš ï¸ ScrollView maxHeight=220dpå¯èƒ½ä¸è¶³
â”‚   â”‚   â”œâ”€â”€ âš ï¸ æŒ‰é’®æ å¯èƒ½è¢«æ¨å‡ºå¯è§†åŒºåŸŸ
â”‚   â”‚   â””â”€â”€ âš ï¸ æ•´ä½“å¸ƒå±€æ— maxHeightçº¦æŸ
â”‚   â”œâ”€â”€ FloatingViewV2å¸ƒå±€é—®é¢˜
â”‚   â”‚   â”œâ”€â”€ âš ï¸ ä¸»å¸ƒå±€ä½¿ç”¨WRAP_CONTENTæ— ä¸Šé™
â”‚   â”‚   â””â”€â”€ âš ï¸ æœªå¯¹ResultCardé«˜åº¦åšé™åˆ¶
â”‚   â”œâ”€â”€ åˆ†æç»“æœå†…å®¹ç‰¹æ®Šæ€§
â”‚   â”‚   â”œâ”€â”€ âš ï¸ åˆ†æç»“æœåŒ…å«ä¸¤æ®µé•¿æ–‡æœ¬
â”‚   â”‚   â””â”€â”€ âš ï¸ å†…å®¹æ ¼å¼åŒ–åè¡Œæ•°æ›´å¤š
â”‚   â””â”€â”€ ensureButtonsVisible()å¯èƒ½å¤±æ•ˆ
â”‚       â”œâ”€â”€ âš ï¸ æŒ‰é’®visibility=VISIBLEä½†åœ¨å±å¹•å¤–
â”‚       â””â”€â”€ âš ï¸ æŒ‰é’®è¢«å…¶ä»–å…ƒç´ é®æŒ¡
â”‚
â”œâ”€â”€ ä½¿ç”¨æ–¹å¼å±‚
â”‚   â”œâ”€â”€ AIè¿”å›è¶…é•¿åˆ†æå†…å®¹
â”‚   â””â”€â”€ ç”¨æˆ·è®¾å¤‡å±å¹•è¾ƒå°
â”‚
â””â”€â”€ ç¯å¢ƒå±‚
    â”œâ”€â”€ ä¸åŒå±å¹•å°ºå¯¸
    â”œâ”€â”€ ä¸åŒAndroidç‰ˆæœ¬
    â””â”€â”€ ä¸åŒè®¾å¤‡DPI
```

---

## ä¸‰ã€æ’æŸ¥è·¯å¾„ï¼ˆä»æ¡†æ¶åˆ°åº”ç”¨å±‚ï¼‰

### 3.1 é€å±‚æ’æŸ¥æ¸…å•

| åºå· | æ’æŸ¥é¡¹ | éªŒè¯æ–¹æ³• | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|------|--------|----------|----------|----------|
| 1 | ScrollView maxHeightæ˜¯å¦ç”Ÿæ•ˆ | æ£€æŸ¥å¸ƒå±€XML | maxHeight=220dp | âœ… å·²è®¾ç½® |
| 2 | æŒ‰é’®æ æ˜¯å¦åœ¨ScrollViewå¤–éƒ¨ | æ£€æŸ¥å¸ƒå±€XML | æŒ‰é’®åœ¨ScrollViewåé¢ | âœ… å·²ä¿®å¤ |
| 3 | ensureButtonsVisible()æ˜¯å¦è¢«è°ƒç”¨ | æ£€æŸ¥ä»£ç  | æ¯æ¬¡showResultéƒ½è°ƒç”¨ | âœ… å·²è°ƒç”¨ |
| 4 | æŒ‰é’®visibilityçŠ¶æ€ | æ·»åŠ æ—¥å¿— | VISIBLE | å¾…éªŒè¯ |
| 5 | æŒ‰é’®æ˜¯å¦åœ¨å±å¹•å¯è§†åŒºåŸŸ | æ·»åŠ æ—¥å¿— | åœ¨å±å¹•å†… | å¾…éªŒè¯ |
| 6 | FloatingViewV2æ•´ä½“é«˜åº¦ | æ·»åŠ æ—¥å¿— | ä¸è¶…è¿‡å±å¹• | å¾…éªŒè¯ |
| 7 | åˆ†æç»“æœå†…å®¹é•¿åº¦ | æ·»åŠ æ—¥å¿— | æŸ¥çœ‹å®é™…é•¿åº¦ | å¾…éªŒè¯ |

### 3.2 å…³é”®ä»£ç æ£€æŸ¥ç‚¹

**æ£€æŸ¥ç‚¹1ï¼šResultCard.showAnalysisResult()**
```kotlin
fun showAnalysisResult(result: AnalysisResult) {
    currentResult = AiResult.Analysis(result)
    resultTitle?.text = "ğŸ” åˆ†æç»“æœ"
    resultContent?.text = buildString {
        appendLine("ã€å†›å¸ˆåˆ†æã€‘")
        appendLine(result.strategyAnalysis)  // â† å¯èƒ½å¾ˆé•¿
        appendLine()
        appendLine("ã€è¯æœ¯å»ºè®®ã€‘")
        append(result.replySuggestion)  // â† å¯èƒ½å¾ˆé•¿
    }
    
    showRiskBadge(result.riskLevel)
    riskWarningContainer?.visibility = View.GONE
    strategyNote?.visibility = View.GONE
    
    ensureButtonsVisible()  // â† å·²è°ƒç”¨
    visibility = View.VISIBLE
}
```

**æ£€æŸ¥ç‚¹2ï¼šfloating_result_card.xml ScrollView**
```xml
<ScrollView
    android:id="@+id/result_scroll"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:maxHeight="220dp"  <!-- â† å…³é”®çº¦æŸ -->
    ...>
```

**æ£€æŸ¥ç‚¹3ï¼šensureButtonsVisible()**
```kotlin
private fun ensureButtonsVisible() {
    btnCopy?.visibility = View.VISIBLE
    btnRegenerate?.visibility = View.VISIBLE
    
    android.util.Log.d(TAG, "ensureButtonsVisible: btnCopy=${btnCopy != null}, btnRegenerate=${btnRegenerate != null}")
}
```

---

## å››ã€æœ€å¯èƒ½çš„æ ¹å› ï¼ˆåŸºäºæœºåˆ¶æ¨ç†ï¼‰

### ğŸ”´ æ ¹å› ç¡®è®¤ï¼šScrollViewçš„maxHeightå±æ€§ä¸æ˜¯åŸç”Ÿæ”¯æŒçš„ï¼

**å…³é”®å‘ç°ï¼š**
Androidæ ‡å‡†çš„`ScrollView`ç»„ä»¶**ä¸æ”¯æŒ**`android:maxHeight`å±æ€§ï¼

è¿™æ˜¯BUG-00017ä¿®å¤æ–¹æ¡ˆçš„ä¸€ä¸ªé‡å¤§ç–æ¼ã€‚è™½ç„¶åœ¨XMLä¸­è®¾ç½®äº†`android:maxHeight="220dp"`ï¼Œä½†è¿™ä¸ªå±æ€§å¯¹æ ‡å‡†ScrollView**å®Œå…¨æ— æ•ˆ**ï¼ŒScrollViewä¼šç»§ç»­ä½¿ç”¨`wrap_content`çš„è¡Œä¸ºï¼Œå¯¼è‡´å†…å®¹è¿‡é•¿æ—¶å°†æŒ‰é’®æ æ¨å‡ºå±å¹•ã€‚

**éªŒè¯æ–¹æ³•ï¼š**
1. æŸ¥çœ‹Androidå®˜æ–¹æ–‡æ¡£ï¼ŒScrollViewä¸æ”¯æŒmaxHeight
2. é¡¹ç›®ä¸­æ²¡æœ‰è‡ªå®šä¹‰çš„MaxHeightScrollViewå®ç°
3. è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆåˆ†æç»“æœï¼ˆå†…å®¹æœ€é•¿ï¼‰çš„æŒ‰é’®ä¸å¯è§ï¼Œè€Œæ¶¦è‰²å’Œå›å¤ï¼ˆå†…å®¹è¾ƒçŸ­ï¼‰çš„æŒ‰é’®å¯è§

### æ ¹å› 1ï¼šScrollView maxHeightåœ¨wrap_contentçˆ¶å®¹å™¨ä¸­å¯èƒ½ä¸ç”Ÿæ•ˆ

**æ¨ç†è¿‡ç¨‹ï¼š**
1. ScrollViewè®¾ç½®äº†`android:maxHeight="220dp"`
2. ä½†ScrollViewçš„`layout_height="wrap_content"`
3. åœ¨æŸäº›Androidç‰ˆæœ¬æˆ–è®¾å¤‡ä¸Šï¼ŒmaxHeightå±æ€§å¯èƒ½ä¸è¢«æ­£ç¡®å¤„ç†
4. å¯¼è‡´ScrollViewå®é™…é«˜åº¦è¶…è¿‡220dpï¼Œå°†æŒ‰é’®æ æ¨å‡ºå±å¹•

**éªŒè¯æ–¹æ³•ï¼š**
```kotlin
// åœ¨showAnalysisResultåæ·»åŠ æ—¥å¿—
resultScroll?.post {
    Log.d(TAG, "ScrollView height: ${resultScroll?.height}, maxHeight: 220dp")
    Log.d(TAG, "ResultCard height: ${this.height}")
    
    val location = IntArray(2)
    btnCopy?.getLocationOnScreen(location)
    Log.d(TAG, "btnCopy location: y=${location[1]}, screenHeight=${context.resources.displayMetrics.heightPixels}")
}
```

### æ ¹å› 2ï¼šFloatingViewV2æ•´ä½“å¸ƒå±€æ— é«˜åº¦çº¦æŸ

**æ¨ç†è¿‡ç¨‹ï¼š**
1. FloatingViewV2çš„ä¸»å¸ƒå±€ä½¿ç”¨`WRAP_CONTENT`
2. å½“ResultCardå†…å®¹å¾ˆé•¿æ—¶ï¼Œæ•´ä¸ªæ‚¬æµ®çª—é«˜åº¦å¯èƒ½è¶…è¿‡å±å¹•
3. æŒ‰é’®æ è™½ç„¶åœ¨ResultCardå†…éƒ¨åº•éƒ¨ï¼Œä½†æ•´ä¸ªResultCardå¯èƒ½è¢«æ¨å‡ºå±å¹•

**éªŒè¯æ–¹æ³•ï¼š**
```kotlin
// åœ¨FloatingViewV2ä¸­æ·»åŠ æ—¥å¿—
mainLayout.post {
    Log.d(TAG, "MainLayout height: ${mainLayout.height}")
    Log.d(TAG, "Screen height: ${context.resources.displayMetrics.heightPixels}")
}
```

### æ ¹å› 3ï¼šåˆ†æç»“æœå†…å®¹æ ¼å¼åŒ–åè¡Œæ•°è¿‡å¤š

**æ¨ç†è¿‡ç¨‹ï¼š**
1. åˆ†æç»“æœåŒ…å«ä¸¤æ®µå†…å®¹ï¼šå†›å¸ˆåˆ†æ + è¯æœ¯å»ºè®®
2. ä½¿ç”¨`appendLine()`æ ¼å¼åŒ–ï¼Œå¢åŠ äº†é¢å¤–çš„æ¢è¡Œ
3. ç›¸æ¯”æ¶¦è‰²å’Œå›å¤ï¼Œåˆ†æç»“æœçš„è¡Œæ•°æ›´å¤š
4. å³ä½¿ScrollViewæœ‰maxHeightï¼Œå†…å®¹åŒºåŸŸä»ç„¶æ›´é«˜

**éªŒè¯æ–¹æ³•ï¼š**
```kotlin
// åœ¨showAnalysisResultä¸­æ·»åŠ æ—¥å¿—
val content = buildString {
    appendLine("ã€å†›å¸ˆåˆ†æã€‘")
    appendLine(result.strategyAnalysis)
    appendLine()
    appendLine("ã€è¯æœ¯å»ºè®®ã€‘")
    append(result.replySuggestion)
}
Log.d(TAG, "Analysis content length: ${content.length}, lines: ${content.lines().size}")
```

---

## äº”ã€ç¨³å®šä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šå¼ºåˆ¶é™åˆ¶ResultCardæ•´ä½“é«˜åº¦ï¼ˆæ¨èï¼‰

**ä¿®æ”¹æ–‡ä»¶ï¼š** `floating_result_card.xml`

```xml
<com.google.android.material.card.MaterialCardView
    ...
    android:layout_height="wrap_content"
    android:maxHeight="350dp">  <!-- æ·»åŠ æ•´ä½“é«˜åº¦é™åˆ¶ -->
```

**åŸç†ï¼š** ä»æ ¹æœ¬ä¸Šé™åˆ¶ResultCardçš„æœ€å¤§é«˜åº¦ï¼Œç¡®ä¿æŒ‰é’®æ å§‹ç»ˆåœ¨å¯è§†åŒºåŸŸå†…ã€‚

### æ–¹æ¡ˆBï¼šä½¿ç”¨ConstraintLayouté‡æ„å¸ƒå±€

**ä¿®æ”¹æ–‡ä»¶ï¼š** `floating_result_card.xml`

```xml
<com.google.android.material.card.MaterialCardView ...>
    <androidx.constraintlayout.widget.ConstraintLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:maxHeight="350dp">
        
        <!-- æ ‡é¢˜æ  -->
        <LinearLayout
            android:id="@+id/title_bar"
            app:layout_constraintTop_toTopOf="parent"
            ... />
        
        <!-- æŒ‰é’®æ ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰ -->
        <LinearLayout
            android:id="@+id/button_bar"
            app:layout_constraintBottom_toBottomOf="parent"
            ... />
        
        <!-- å†…å®¹åŒºåŸŸï¼ˆå¡«å……ä¸­é—´ç©ºé—´ï¼‰ -->
        <ScrollView
            android:id="@+id/result_scroll"
            app:layout_constraintTop_toBottomOf="@id/title_bar"
            app:layout_constraintBottom_toTopOf="@id/button_bar"
            android:layout_height="0dp"
            ... />
            
    </androidx.constraintlayout.widget.ConstraintLayout>
</com.google.android.material.card.MaterialCardView>
```

**åŸç†ï¼š** ä½¿ç”¨ConstraintLayoutçš„çº¦æŸæœºåˆ¶ï¼Œç¡®ä¿æŒ‰é’®æ å§‹ç»ˆå›ºå®šåœ¨åº•éƒ¨ï¼Œå†…å®¹åŒºåŸŸè‡ªé€‚åº”å¡«å……ã€‚

### æ–¹æ¡ˆCï¼šåœ¨ä»£ç ä¸­åŠ¨æ€è®¡ç®—é«˜åº¦

**ä¿®æ”¹æ–‡ä»¶ï¼š** `ResultCard.kt`

```kotlin
private fun ensureButtonsVisible() {
    btnCopy?.visibility = View.VISIBLE
    btnRegenerate?.visibility = View.VISIBLE
    
    // åŠ¨æ€è®¡ç®—å¹¶é™åˆ¶ScrollViewé«˜åº¦
    post {
        val screenHeight = context.resources.displayMetrics.heightPixels
        val maxCardHeight = (screenHeight * 0.5).toInt() // æœ€å¤§å å±å¹•50%
        val titleHeight = resultTitle?.height ?: 0
        val buttonHeight = btnCopy?.height ?: 0
        val padding = 24.dpToPx() // ä¸Šä¸‹padding
        
        val maxScrollHeight = maxCardHeight - titleHeight - buttonHeight - padding
        
        resultScroll?.layoutParams?.height = minOf(
            resultScroll?.height ?: 0,
            maxScrollHeight
        )
        resultScroll?.requestLayout()
    }
}

private fun Int.dpToPx(): Int {
    return (this * context.resources.displayMetrics.density).toInt()
}
```

**åŸç†ï¼š** æ ¹æ®å±å¹•é«˜åº¦åŠ¨æ€è®¡ç®—ScrollViewçš„æœ€å¤§é«˜åº¦ï¼Œç¡®ä¿æŒ‰é’®æ å§‹ç»ˆå¯è§ã€‚

### æ–¹æ¡ˆDï¼šå¢å¼ºæ—¥å¿—è¯Šæ–­ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

**ä¿®æ”¹æ–‡ä»¶ï¼š** `ResultCard.kt`

```kotlin
private fun ensureButtonsVisible() {
    btnCopy?.visibility = View.VISIBLE
    btnRegenerate?.visibility = View.VISIBLE
    
    // å¢å¼ºæ—¥å¿—ï¼Œå¸®åŠ©å®šä½é—®é¢˜
    post {
        val screenHeight = context.resources.displayMetrics.heightPixels
        val cardHeight = this.height
        val scrollHeight = findViewById<ScrollView>(R.id.result_scroll)?.height ?: 0
        
        val btnLocation = IntArray(2)
        btnCopy?.getLocationOnScreen(btnLocation)
        
        Log.d(TAG, """
            |=== ResultCard Layout Debug ===
            |Screen height: $screenHeight
            |Card height: $cardHeight
            |Scroll height: $scrollHeight
            |Button Y position: ${btnLocation[1]}
            |Button visible on screen: ${btnLocation[1] < screenHeight}
            |==============================
        """.trimMargin())
        
        // å¦‚æœæŒ‰é’®ä¸åœ¨å±å¹•å†…ï¼Œå¼ºåˆ¶è°ƒæ•´
        if (btnLocation[1] >= screenHeight) {
            Log.w(TAG, "Button is off screen! Forcing scroll height adjustment")
            // è§¦å‘å¼ºåˆ¶è°ƒæ•´é€»è¾‘
        }
    }
}
```

---

## å…­ã€æµ‹è¯•ç”¨ä¾‹

### 6.1 å•å…ƒæµ‹è¯•

```kotlin
@Test
fun `åˆ†æç»“æœæ˜¾ç¤ºæ—¶æŒ‰é’®åº”è¯¥å¯è§`() {
    // Given
    val resultCard = ResultCard(context)
    val longAnalysis = "A".repeat(500) // è¶…é•¿åˆ†æå†…å®¹
    val longSuggestion = "B".repeat(500) // è¶…é•¿å»ºè®®å†…å®¹
    
    // When
    resultCard.showAnalysisResult(AnalysisResult(
        strategyAnalysis = longAnalysis,
        replySuggestion = longSuggestion,
        riskLevel = RiskLevel.SAFE
    ))
    
    // Then
    val btnCopy = resultCard.findViewById<MaterialButton>(R.id.btn_copy)
    val btnRegenerate = resultCard.findViewById<MaterialButton>(R.id.btn_regenerate)
    
    assertEquals(View.VISIBLE, btnCopy.visibility)
    assertEquals(View.VISIBLE, btnRegenerate.visibility)
}

@Test
fun `åˆ†æç»“æœæŒ‰é’®åº”è¯¥åœ¨å±å¹•å¯è§†åŒºåŸŸå†…`() {
    // Given
    val resultCard = ResultCard(context)
    val longAnalysis = "A".repeat(1000)
    val longSuggestion = "B".repeat(1000)
    
    // When
    resultCard.showAnalysisResult(AnalysisResult(
        strategyAnalysis = longAnalysis,
        replySuggestion = longSuggestion,
        riskLevel = RiskLevel.SAFE
    ))
    
    // Then - ç­‰å¾…å¸ƒå±€å®Œæˆ
    resultCard.post {
        val screenHeight = context.resources.displayMetrics.heightPixels
        val btnCopy = resultCard.findViewById<MaterialButton>(R.id.btn_copy)
        
        val location = IntArray(2)
        btnCopy.getLocationOnScreen(location)
        
        assertTrue("Button should be visible on screen", location[1] < screenHeight)
    }
}

@Test
fun `ä¸‰ç§ç»“æœç±»å‹çš„æŒ‰é’®éƒ½åº”è¯¥å¯è§`() {
    // Given
    val resultCard = ResultCard(context)
    
    // Test Analysis
    resultCard.showAnalysisResult(AnalysisResult(
        strategyAnalysis = "Long analysis...",
        replySuggestion = "Long suggestion...",
        riskLevel = RiskLevel.SAFE
    ))
    assertEquals(View.VISIBLE, resultCard.findViewById<View>(R.id.btn_copy).visibility)
    
    // Test Polish
    resultCard.showPolishResult(PolishResult(
        polishedText = "Long polished text...",
        hasRisk = false,
        riskWarning = null
    ))
    assertEquals(View.VISIBLE, resultCard.findViewById<View>(R.id.btn_copy).visibility)
    
    // Test Reply
    resultCard.showReplyResult(ReplyResult(
        suggestedReply = "Long reply...",
        strategyNote = "Long note..."
    ))
    assertEquals(View.VISIBLE, resultCard.findViewById<View>(R.id.btn_copy).visibility)
}
```

### 6.2 é›†æˆæµ‹è¯•

```kotlin
@Test
fun `FloatingViewV2æ˜¾ç¤ºé•¿åˆ†æç»“æœæ—¶æŒ‰é’®åº”è¯¥å¯è§`() {
    // Given
    val floatingView = FloatingViewV2(context, windowManager)
    val longResult = AiResult.Analysis(AnalysisResult(
        strategyAnalysis = "A".repeat(1000),
        replySuggestion = "B".repeat(1000),
        riskLevel = RiskLevel.SAFE
    ))
    
    // When
    floatingView.showResult(longResult)
    
    // Then
    val resultCard = floatingView.findViewById<ResultCard>(R.id.result_card)
    val btnCopy = resultCard.findViewById<MaterialButton>(R.id.btn_copy)
    
    assertEquals(View.VISIBLE, btnCopy.visibility)
    
    // éªŒè¯æŒ‰é’®åœ¨å±å¹•å†…
    resultCard.post {
        val location = IntArray(2)
        btnCopy.getLocationOnScreen(location)
        val screenHeight = context.resources.displayMetrics.heightPixels
        assertTrue(location[1] < screenHeight)
    }
}
```

---

## ä¸ƒã€å®æ–½è®¡åˆ’

### é˜¶æ®µä¸€ï¼šè¯Šæ–­ç¡®è®¤ âœ… å·²å®Œæˆ
1. âœ… åˆ†æä»£ç ç»“æ„å’Œå¸ƒå±€
2. âœ… ç¡®è®¤æ ¹å› ï¼šAndroidæ ‡å‡†ScrollViewä¸æ”¯æŒmaxHeightå±æ€§
3. âœ… éªŒè¯BUG-00017ä¿®å¤æ–¹æ¡ˆå­˜åœ¨ç¼ºé™·

### é˜¶æ®µäºŒï¼šç¼–å†™æµ‹è¯• âœ… å·²å®Œæˆ
1. âœ… åˆ›å»º `ResultCardAnalysisButtonTest.kt` - 14ä¸ªæµ‹è¯•ç”¨ä¾‹
2. âœ… åˆ›å»º `MaxHeightScrollViewTest.kt` - 9ä¸ªæµ‹è¯•ç”¨ä¾‹
3. âœ… æ·»åŠ é•¿å†…å®¹åœºæ™¯æµ‹è¯•
4. âœ… æ·»åŠ æŒ‰é’®å¯è§æ€§æµ‹è¯•

### é˜¶æ®µä¸‰ï¼šå®æ–½ä¿®å¤ âœ… å·²å®Œæˆ
1. âœ… åˆ›å»ºè‡ªå®šä¹‰ `MaxHeightScrollView` ç»„ä»¶
2. âœ… åˆ›å»º `attrs.xml` å®šä¹‰è‡ªå®šä¹‰å±æ€§
3. âœ… æ›´æ–° `floating_result_card.xml` ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶
4. âœ… ä»£ç è¯Šæ–­æ— é”™è¯¯

### é˜¶æ®µå››ï¼šå›å½’æµ‹è¯•
1. â³ æµ‹è¯•ä¸‰ç§ç»“æœç±»å‹
2. â³ æµ‹è¯•ä¸åŒå†…å®¹é•¿åº¦
3. â³ æµ‹è¯•ä¸åŒå±å¹•å°ºå¯¸

---

## å…«ã€ä¿®å¤è®°å½•

### ä¿®å¤æ—¶é—´
2025-12-18

### æ ¹å› ç¡®è®¤
**Androidæ ‡å‡†ScrollViewä¸æ”¯æŒmaxHeightå±æ€§ï¼**

BUG-00017çš„ä¿®å¤æ–¹æ¡ˆåœ¨XMLä¸­è®¾ç½®äº†`android:maxHeight="220dp"`ï¼Œä½†è¿™ä¸ªå±æ€§å¯¹æ ‡å‡†ScrollViewå®Œå…¨æ— æ•ˆã€‚ScrollViewä¼šç»§ç»­ä½¿ç”¨`wrap_content`çš„è¡Œä¸ºï¼Œå¯¼è‡´å†…å®¹è¿‡é•¿æ—¶å°†æŒ‰é’®æ æ¨å‡ºå±å¹•ã€‚

### ä¿®å¤å†…å®¹

#### 1. åˆ›å»ºè‡ªå®šä¹‰MaxHeightScrollViewç»„ä»¶
- **æ–‡ä»¶**: `app/src/main/java/com/empathy/ai/presentation/ui/component/MaxHeightScrollView.kt`
- **åŠŸèƒ½**: é€šè¿‡é‡å†™`onMeasure`æ–¹æ³•ï¼Œæ­£ç¡®å®ç°maxHeightçº¦æŸ
- **ç‰¹æ€§**:
  - æ”¯æŒXMLå±æ€§ `app:maxHeight`
  - æ”¯æŒä»£ç åŠ¨æ€è®¾ç½® `setMaxHeight(px)` / `setMaxHeightDp(dp)`
  - æ­£ç¡®å¤„ç†ä¸‰ç§MeasureSpecæ¨¡å¼ï¼ˆUNSPECIFIEDã€AT_MOSTã€EXACTLYï¼‰

#### 2. åˆ›å»ºè‡ªå®šä¹‰å±æ€§å®šä¹‰
- **æ–‡ä»¶**: `app/src/main/res/values/attrs.xml`
- **å†…å®¹**: å®šä¹‰ `MaxHeightScrollView` çš„ `maxHeight` å±æ€§

#### 3. æ›´æ–°å¸ƒå±€æ–‡ä»¶
- **æ–‡ä»¶**: `app/src/main/res/layout/floating_result_card.xml`
- **ä¿®æ”¹**: å°†æ ‡å‡† `ScrollView` æ›¿æ¢ä¸ºè‡ªå®šä¹‰ `MaxHeightScrollView`

#### 4. æµ‹è¯•æ–‡ä»¶
- `ResultCardAnalysisButtonTest.kt` - 14ä¸ªæµ‹è¯•ç”¨ä¾‹
- `MaxHeightScrollViewTest.kt` - 9ä¸ªæµ‹è¯•ç”¨ä¾‹

### ä¿®å¤åŸç†
```kotlin
override fun onMeasure(widthMeasureSpec: Int, heightMeasureSpec: Int) {
    var newHeightMeasureSpec = heightMeasureSpec

    if (maxHeightPx != Int.MAX_VALUE) {
        val mode = MeasureSpec.getMode(heightMeasureSpec)
        val size = MeasureSpec.getSize(heightMeasureSpec)

        when (mode) {
            MeasureSpec.UNSPECIFIED -> {
                // æ— çº¦æŸæ—¶ï¼Œä½¿ç”¨maxHeightä½œä¸ºAT_MOSTçº¦æŸ
                newHeightMeasureSpec = MeasureSpec.makeMeasureSpec(maxHeightPx, MeasureSpec.AT_MOST)
            }
            MeasureSpec.AT_MOST -> {
                // å·²æœ‰AT_MOSTçº¦æŸæ—¶ï¼Œå–è¾ƒå°å€¼
                newHeightMeasureSpec = MeasureSpec.makeMeasureSpec(
                    minOf(size, maxHeightPx), MeasureSpec.AT_MOST
                )
            }
            MeasureSpec.EXACTLY -> {
                // ç²¾ç¡®çº¦æŸæ—¶ï¼Œå–è¾ƒå°å€¼
                newHeightMeasureSpec = MeasureSpec.makeMeasureSpec(
                    minOf(size, maxHeightPx), MeasureSpec.EXACTLY
                )
            }
        }
    }

    super.onMeasure(widthMeasureSpec, newHeightMeasureSpec)
}
```

---

## ä¹ã€ç›¸å…³æ–‡æ¡£

- [BUG-00017-ä¸‰ä¸ªUIäº¤äº’é—®é¢˜ç³»ç»Ÿæ€§åˆ†æ.md](./BUG-00017-ä¸‰ä¸ªUIäº¤äº’é—®é¢˜ç³»ç»Ÿæ€§åˆ†æ.md)
- [MaxHeightScrollView.kt](../../../app/src/main/java/com/empathy/ai/presentation/ui/component/MaxHeightScrollView.kt) - ğŸ†• è‡ªå®šä¹‰ç»„ä»¶
- [ResultCard.kt](../../../app/src/main/java/com/empathy/ai/presentation/ui/floating/ResultCard.kt)
- [FloatingViewV2.kt](../../../app/src/main/java/com/empathy/ai/presentation/ui/floating/FloatingViewV2.kt)
- [floating_result_card.xml](../../../app/src/main/res/layout/floating_result_card.xml)
- [attrs.xml](../../../app/src/main/res/values/attrs.xml) - ğŸ†• è‡ªå®šä¹‰å±æ€§
- [TDD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„æŠ€æœ¯è®¾è®¡.md](../TDD/TDD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„æŠ€æœ¯è®¾è®¡.md)
