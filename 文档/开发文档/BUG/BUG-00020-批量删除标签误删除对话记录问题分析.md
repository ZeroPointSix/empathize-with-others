# BUG-00020: 批量删除标签误删除对话记录问题分析

## 问题描述

用户报告"删除所有标签"的逻辑会删除所有对话记录和标签事实。

## 问题分析

### 1. 批量删除标签的代码流程

正常流程应该是：
1. 用户在PersonaTabV2界面选择要删除的标签
2. 点击删除按钮，显示确认对话框
3. 确认后调用`ContactDetailTabViewModel.confirmBatchDelete()`
4. 调用`BatchDeleteFactsUseCase`删除指定ID的Facts
5. 调用`ContactRepositoryImpl.updateFacts()`更新facts_json字段
6. 刷新界面数据

### 2. 数据库外键约束分析

关键发现：
- `ConversationLogEntity`和`DailySummaryEntity`都有外键约束指向`ContactProfileEntity`
- 设置了`onDelete = ForeignKey.CASCADE`
- 这意味着如果删除`ContactProfileEntity`，所有关联的对话记录和总结会被级联删除

### 3. 可能的问题源

经过代码分析，我识别出以下几个可能的问题源：

#### 可能性1：误调用deleteProfile方法
- 在某些异常情况下，可能意外调用了`ContactRepositoryImpl.deleteProfile()`
- 这会触发级联删除，删除所有关联的对话记录和总结
- 批量删除Facts应该只调用`updateFacts()`，不应该调用`deleteProfile()`

#### 可能性2：loadContactDetail方法中的问题
- `confirmBatchDelete()`成功后会调用`loadContactDetail(contact.id)`刷新数据
- 如果在加载过程中发生异常，可能导致数据不一致

#### 可能性3：selectAllFacts方法的问题
- `selectAllFacts()`可能选中了不应该选中的内容
- 如果选中了所有Facts，可能导致某些边界情况下的异常行为

#### 可能性4：BatchDeleteFactsUseCase的边界情况
- 当删除所有Facts时，可能触发了某些意外的代码路径
- 空Facts列表可能导致联系人被误删除

#### 可能性5：数据库事务问题
- 在并发操作情况下，可能存在事务隔离问题
- 一个操作可能意外影响了另一个操作

### 4. 最可能的原因

基于代码分析，我认为最可能的原因是：

1. **误调用deleteProfile方法**：在某些异常或边界情况下，代码可能意外调用了`deleteProfile()`而不是`updateFacts()`

2. **selectAllFacts选中了所有标签**：用户可能点击了"全选"按钮，选中了所有标签，然后在删除所有标签时触发了某种边界情况

## 调试验证方案

为了验证假设，我创建了以下调试工具：

1. **BatchDeleteDebugLogger**：记录批量删除操作的详细日志
2. **ContactDetailTabViewModelWithDebug**：在关键位置添加调试日志
3. **ContactRepositoryImplWithDebug**：特别监控`deleteProfile()`的调用

### 关键调试点

1. 监控`deleteProfile()`是否被意外调用
2. 记录批量删除前后的Facts数量
3. 追踪`loadContactDetail`的调用时机
4. 检查`selectAllFacts`选中的标签ID列表

## 临时解决方案

在问题解决前，建议用户：

1. 避免使用"全选"功能
2. 分批删除标签，而不是一次性删除所有
3. 在删除前备份重要数据

## 下一步行动

1. 部署调试版本到测试环境
2. 重现问题并收集日志
3. 根据日志确认根本原因
4. 修复问题并测试验证

## 相关文件

- `app/src/main/java/com/empathy/ai/domain/usecase/BatchDeleteFactsUseCase.kt`
- `app/src/main/java/com/empathy/ai/presentation/viewmodel/ContactDetailTabViewModel.kt`
- `app/src/main/java/com/empathy/ai/data/repository/ContactRepositoryImpl.kt`
- `app/src/main/java/com/empathy/ai/data/local/entity/ConversationLogEntity.kt`
- `app/src/main/java/com/empathy/ai/data/local/entity/DailySummaryEntity.kt`
- `app/src/main/java/com/empathy/ai/data/local/dao/ContactDao.kt`

## 调试文件

- `app/src/main/java/com/empathy/ai/presentation/viewmodel/ContactDetailTabViewModelDebug.kt`
- `app/src/main/java/com/empathy/ai/presentation/viewmodel/ContactDetailTabViewModelWithDebug.kt`
- `app/src/main/java/com/empathy/ai/data/repository/ContactRepositoryImplWithDebug.kt`