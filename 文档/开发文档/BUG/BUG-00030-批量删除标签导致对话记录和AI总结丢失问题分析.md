# BUG-00030 批量删除标签导致对话记录和AI总结丢失问题分析

> 创建日期: 2025-12-22
> 严重程度: 🔴 严重（数据丢失）
> 状态: ⏸️ 暂停（无法稳定复现）
> 优先级: P1

---

## 问题描述

### 现象
用户在标签画像界面长按选择全部标签后删除，会导致：
1. 联系人本身依然存在
2. **事实流里的对话记录全部消失**
3. **只有在存在分析对话的时候才会出现这个问题**

### 复现条件（不稳定）
1. 打开一个有AI分析对话记录的联系人
2. 切换到"标签画像"标签页
3. 长按进入编辑模式
4. 选择全部标签
5. 点击删除确认
6. 切换到"事实流"标签页查看

### 影响范围
- 对话记录（conversation_logs表）
- AI总结（daily_summaries表）
- 用户数据完整性

---

## 技术分析

### 已检查的代码路径

#### 1. BatchDeleteFactsUseCase.kt
```kotlin
// 逻辑正确，只删除指定的Facts
val remainingFacts = profile.facts.filter { it.id !in factIdsToDelete }
contactRepository.updateFacts(contactId, remainingFacts)
```
**结论**: 只更新`facts_json`字段，不涉及对话记录删除

#### 2. ContactDao.kt
```kotlin
@Query("UPDATE profiles SET facts_json = :factsJson WHERE id = :id")
suspend fun updateFacts(id: String, factsJson: String)
```
**结论**: 只更新`facts_json`列，不触发级联删除

#### 3. 外键约束分析
```kotlin
// ConversationLogEntity.kt
ForeignKey(
    entity = ContactProfileEntity::class,
    parentColumns = ["id"],
    childColumns = ["contact_id"],
    onDelete = ForeignKey.CASCADE  // ⚠️ 级联删除
)

// DailySummaryEntity.kt
ForeignKey(
    entity = ContactProfileEntity::class,
    parentColumns = ["id"],
    childColumns = ["contact_id"],
    onDelete = ForeignKey.CASCADE  // ⚠️ 级联删除
)
```
**结论**: 如果`ContactProfileEntity`被删除，会级联删除所有关联数据。但`updateFacts`不应该触发这个。

### 可能的问题方向

1. **竞态条件**: `confirmBatchDelete`中`loadContactDetail`是异步操作，可能存在状态更新竞争
2. **UI状态问题**: 对话记录可能没有被真正删除，只是UI没有正确显示
3. **数据库触发器**: 可能存在未知的数据库触发器或约束
4. **内存状态不一致**: ViewModel状态与数据库状态不同步

---

## 已添加的调试日志

### ContactDetailTabViewModel.kt
```kotlin
// confirmBatchDelete方法
Log.d(TAG, "========== confirmBatchDelete开始 ==========")
Log.d(TAG, "删除前timelineItems数量=${currentState.timelineItems.size}")
Log.d(TAG, "删除前对话记录数量=${...}")
Log.d(TAG, "刷新前数据库对话记录数量=${...}")

// loadContactDetail方法
Log.d(TAG, "对话记录数量: ${conversations.size}")
conversations.forEachIndexed { index, conv ->
    Log.d(TAG, "  [$index] id=${conv.id}, userInput=${conv.userInput.take(50)}...")
}
```

### BatchDeleteFactsUseCase.kt
```kotlin
Log.d(TAG, "========== 批量删除Facts开始 ==========")
Log.d(TAG, "要删除的factIds数量=${factIds.size}")
Log.d(TAG, "当前联系人facts数量=${profile.facts.size}")
```

### 日志过滤器
- `tag:ContactDetailTabVM`
- `tag:BatchDeleteFactsUseCase`

---

## 下次复现时的调查步骤

1. **查看Logcat日志**
   - 确认删除前后的对话记录数量
   - 确认数据库中的对话记录是否真的被删除

2. **检查数据库**
   - 使用Database Inspector查看`conversation_logs`表
   - 确认`contact_id`是否正确

3. **检查UI状态**
   - 确认`timelineItems`中是否包含对话记录
   - 确认`FilterType`是否影响显示

4. **检查调用栈**
   - 确认是否有其他代码路径触发了`deleteByContactId`

---

## 相关文件

| 文件 | 说明 |
|------|------|
| `ContactDetailTabViewModel.kt` | 主要ViewModel，已添加调试日志 |
| `BatchDeleteFactsUseCase.kt` | 批量删除用例，已添加调试日志 |
| `ConversationLogEntity.kt` | 对话记录实体，有CASCADE外键 |
| `DailySummaryEntity.kt` | AI总结实体，有CASCADE外键 |
| `ConversationRepositoryImpl.kt` | 对话记录仓库实现 |
| `ContactRepositoryImpl.kt` | 联系人仓库实现 |

---

## 临时缓解措施

暂无。建议用户在删除标签前备份重要数据。

---

## 后续计划

1. 等待问题稳定复现
2. 收集完整的Logcat日志
3. 根据日志定位问题根源
4. 实施修复方案

---

## 更新记录

| 日期 | 更新内容 |
|------|----------|
| 2025-12-22 | 创建文档，记录问题现象和初步分析 |
| 2025-12-22 | 添加调试日志到相关代码 |
| 2025-12-22 | 状态改为暂停（无法稳定复现） |
