# BUG-00033: 提示词编辑器UI与设计稿不一致问题

> 创建日期: 2025-12-25
> 状态: ✅ 已修复
> 优先级: P1 (功能完整性+视觉一致性)
> 关联文档: TD-00019, RESEARCH-00044, 文档/开发文档/UI-原型/empathy-prompt-editor-v2.html

---

## 1. 问题概述

### 1.1 问题描述

提示词编辑器页面（PromptEditorScreen）的UI与设计稿（empathy-prompt-editor-v2.html）存在多处不一致：

1. **场景Tab缺少图标** - 设计稿中每个Tab有对应图标（search、edit_note、chat、summarize）
2. **底部工具栏样式不对** - 设计稿是"AI优化"按钮（带图标+文字），当前是两个小图标
3. **工具栏位置不对** - 设计稿在输入框底部有分隔线，当前没有
4. **整体布局细节** - 圆角、间距、颜色等细节差异

### 1.2 影响范围

- **影响用户**: 使用提示词编辑功能的用户
- **影响功能**: 提示词编辑体验完整性和视觉一致性
- **严重程度**: P1 功能完整性+视觉一致性

### 1.3 设计对比

**设计稿** (`文档/开发文档/UI-原型/empathy-prompt-editor-v2.html`):

```
┌─────────────────────────────────────┐
│  取消        编辑提示词        完成   │  ← iOS导航栏
├─────────────────────────────────────┤
│ [🔍分析] [📝润色] [💬回复] [📋总结]  │  ← 带图标的Tab
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │                                 │ │
│ │     提示词输入区域              │ │
│ │                                 │ │
│ ├─────────────────────────────────┤ │  ← 分隔线
│ │ [✨ AI优化]           156/2000  │ │  ← 工具栏
│ └─────────────────────────────────┘ │
│                                     │
│ 提示词将帮助AI更好地理解...          │  ← 提示文字
├─────────────────────────────────────┤
│ [  恢复默认  ]  [    保存    ]      │  ← 底部按钮
└─────────────────────────────────────┘
```

**当前实现**:
- Tab没有图标
- 工具栏是两个小图标（format_list_bulleted + auto_awesome）
- 缺少分隔线
- 样式细节不一致

---

## 2. 机制分析

### 2.1 HTML设计意图

根据HTML设计稿，工具栏的设计意图是：
1. **位置**: 输入框内部底部
2. **布局**: 左侧工具图标 + 右侧字符计数
3. **功能**:
   - `format_list_bulleted`: 列表格式化（将文本转换为列表格式）
   - `auto_awesome`: AI润色（调用AI优化提示词表达）

### 2.2 功能定义

**列表格式图标** (`format_list_bulleted`):
- 点击后将选中文本或当前行转换为列表格式
- 例如: "分析情绪" → "· 分析情绪"
- 当前阶段: 仅添加图标，功能后续实现

**AI润色图标** (`auto_awesome`):
- 点击后调用AI优化当前提示词
- 使提示词表达更清晰、更专业
- 当前阶段: 仅添加图标，功能后续实现

---

## 3. 根因分析

### 3.1 潜在根因树（Root Cause Tree）

```
提示词编辑器功能缺失
├── 框架机制层
│   └── Compose组件组合机制
├── 模块行为层
│   ├── PromptSceneTab已实现Tab切换 ✅
│   └── 底部工具栏缺少图标 ← 问题点
├── 使用方式层
│   ├── HTML设计未完全实现 ← 根因
│   └── 功能优先级调整
└── 环境层
    └── 设计与实现同步问题
```

### 3.2 根因定位

**根因**: 开发过程中优先实现了核心编辑功能，工具栏图标作为辅助功能被遗漏

**证据**: 
- Tab切换功能已完整实现（PromptSceneTab组件）
- 字符计数功能已实现（CharacterCounter组件）
- 仅缺少工具栏图标

---

## 4. 修复方案

### 4.1 修复代码

**文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/prompt/PromptEditorScreen.kt`

**修改前**:
```kotlin
Spacer(modifier = Modifier.height(8.dp))

CharacterCounter(
    charCount = uiState.charCount,
    maxLength = PromptEditorUiState.MAX_PROMPT_LENGTH,
    isOverLimit = uiState.isOverLimit,
    isNearLimit = uiState.isNearLimit,
    modifier = Modifier.align(Alignment.End)
)
```

**修改后**:
```kotlin
Spacer(modifier = Modifier.height(12.dp))

// 工具栏：左侧图标 + 右侧字符计数
Row(
    modifier = Modifier.fillMaxWidth(),
    horizontalArrangement = Arrangement.SpaceBetween,
    verticalAlignment = Alignment.CenterVertically
) {
    // 左侧工具图标
    Row(
        horizontalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        // 列表格式图标
        Icon(
            imageVector = Icons.Default.FormatListBulleted,
            contentDescription = "列表格式",
            tint = iOSTextSecondary,
            modifier = Modifier
                .size(20.dp)
                .clickable(
                    interactionSource = remember { MutableInteractionSource() },
                    indication = null
                ) {
                    // TODO: 列表格式功能
                }
        )
        // AI润色图标
        Icon(
            imageVector = Icons.Default.AutoAwesome,
            contentDescription = "AI润色",
            tint = iOSTextSecondary,
            modifier = Modifier
                .size(20.dp)
                .clickable(
                    interactionSource = remember { MutableInteractionSource() },
                    indication = null
                ) {
                    // TODO: AI润色功能
                }
        )
    }

    // 右侧字符计数
    CharacterCounter(
        charCount = uiState.charCount,
        maxLength = PromptEditorUiState.MAX_PROMPT_LENGTH,
        isOverLimit = uiState.isOverLimit,
        isNearLimit = uiState.isNearLimit
    )
}
```

### 4.2 新增导入

```kotlin
import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.material.icons.filled.AutoAwesome
import androidx.compose.material.icons.filled.FormatListBulleted
import androidx.compose.runtime.remember
```

### 4.3 修复原理

1. **布局调整**: 将字符计数器从单独一行改为Row布局的右侧
2. **添加工具图标**: 左侧添加两个Material Icons图标
3. **点击事件预留**: 使用clickable修饰符，功能后续实现
4. **无涟漪效果**: 使用空indication保持iOS风格

---

## 5. 后续功能规划

### 5.1 列表格式功能（TODO）

**功能描述**: 将选中文本或当前行转换为列表格式

**实现思路**:
```kotlin
fun formatAsList(text: String): String {
    return text.lines()
        .filter { it.isNotBlank() }
        .joinToString("\n") { "· $it" }
}
```

**触发方式**: 点击`format_list_bulleted`图标

### 5.2 AI润色功能（TODO）

**功能描述**: 调用AI优化提示词表达

**实现思路**:
1. 获取当前提示词内容
2. 调用AI服务进行润色
3. 显示润色结果供用户确认
4. 用户确认后替换原内容

**触发方式**: 点击`auto_awesome`图标

**UI流程**:
```
点击AI润色图标
    ↓
显示加载状态
    ↓
调用AI服务
    ↓
显示润色结果对话框
    ↓
用户确认/取消
    ↓
替换/保持原内容
```

---

## 6. 测试验证

### 6.1 视觉验证

| 验证项 | 预期效果 |
|--------|----------|
| 图标位置 | 输入框内部底部左侧 |
| 图标大小 | 20dp × 20dp |
| 图标颜色 | iOSTextSecondary (#8E8E93) |
| 图标间距 | 12dp |
| 与字符计数对齐 | 垂直居中对齐 |

### 6.2 交互验证

| 验证项 | 预期效果 |
|--------|----------|
| 图标点击 | 有点击响应（当前为空实现） |
| 无涟漪效果 | 点击时无Material涟漪 |
| 与HTML设计一致 | 布局与HTML设计稿一致 |

---

## 7. 相关文档

- [RESEARCH-00044-TD00019-BUG深度调研报告](../RE/RESEARCH-00044-TD00019-BUG深度调研报告.md)
- [HTML/修改提示词界面.html](../../../HTML/修改提示词界面.html)
- [PromptEditorScreen.kt](../../../presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/prompt/PromptEditorScreen.kt)
- [TD-00019-UI视觉美观化改造任务清单](../TD/TD-00019-UI视觉美观化改造任务清单.md)

---

## 8. 修复记录

| 日期 | 修改内容 | 修改人 |
|------|----------|--------|
| 2025-12-25 | 创建BUG文档，分析问题 | Kiro |
| 2025-12-25 | 重写PromptSceneTab组件，添加图标支持 | Kiro |
| 2025-12-25 | 更新PromptEditorScreen工具栏为"AI优化"按钮样式 | Kiro |
| 2025-12-25 | 添加分隔线和边框，完善布局细节 | Kiro |
| 2025-12-25 | 添加clip导入，修复编译问题 | Kiro |
| 2025-12-25 | 验证修复完成，标记为已修复 | Kiro |

---

## 9. 修复验证

### 9.1 已完成的修改

| 修改项 | 文件 | 状态 |
|--------|------|------|
| 场景Tab添加图标 | PromptSceneTab.kt | ✅ 完成 |
| Tab样式改为圆角胶囊 | PromptSceneTab.kt | ✅ 完成 |
| 工具栏改为"AI优化"按钮 | PromptEditorScreen.kt | ✅ 完成 |
| 添加分隔线 | PromptEditorScreen.kt | ✅ 完成 |
| 编辑区域添加边框 | PromptEditorScreen.kt | ✅ 完成 |
| 添加clip导入 | PromptEditorScreen.kt | ✅ 完成 |

### 9.2 与设计稿对比

| 设计稿要求 | 实现状态 |
|------------|----------|
| 场景Tab带图标（search、edit_note、chat、summarize） | ✅ 已实现 |
| Tab样式为圆角胶囊按钮 | ✅ 已实现 |
| 编辑区域白色圆角卡片带边框 | ✅ 已实现 |
| 底部工具栏为"AI优化"按钮（带图标+文字） | ✅ 已实现 |
| 工具栏有分隔线 | ✅ 已实现 |
| 字数统计在右侧 | ✅ 已实现 |

---

**文档版本**: 1.1
**最后更新**: 2025-12-25
