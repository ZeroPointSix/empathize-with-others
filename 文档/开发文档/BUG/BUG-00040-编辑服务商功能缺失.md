# BUG-00040: ç¼–è¾‘æœåŠ¡å•†åŠŸèƒ½ç¼ºå¤±

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç¼–å· | BUG-00040 |
| åˆ›å»ºæ—¥æœŸ | 2026-01-02 |
| æŠ¥å‘Šäºº | ç”¨æˆ· |
| çŠ¶æ€ | âœ… å·²ä¿®å¤ |
| ä¼˜å…ˆçº§ | P1 - é«˜ |
| å½±å“èŒƒå›´ | AIé…ç½®åŠŸèƒ½ |

---

## 1. é—®é¢˜æè¿°

### 1.1 ç°è±¡
1. **ç¼–è¾‘æœåŠ¡å•†ç•Œé¢æ— æ³•ç¼–è¾‘Temperatureå’Œæœ€å¤§Tokenæ•°** - ç¼–è¾‘æ—¶æ˜¾ç¤ºé»˜è®¤å€¼è€Œéå®é™…ä¿å­˜çš„å€¼
2. **AIé…ç½®ä¸»ç•Œé¢æ˜¾ç¤ºä¸éœ€è¦çš„è®¾ç½®é¡¹** - "é«˜çº§è®¾ç½®"åˆ†ç»„ä¸­çš„"æœ€å¤§Tokenæ•°"ä¸åº”è¯¥åœ¨å…¨å±€é…ç½®ç•Œé¢æ˜¾ç¤º
3. **è¯·æ±‚è¶…æ—¶è®¾ç½®æœªå®ç°** - ç‚¹å‡»æ— å“åº”ï¼Œåªæœ‰TODOå ä½ç¬¦
4. **ğŸ†• EditProviderScreenä½¿ç”¨æ—§UI** - Temperatureå’ŒMaxTokensæ˜¾ç¤ºä¸ºIOSSettingsItemç¡¬ç¼–ç å€¼ï¼Œæ¨¡å‹åˆ—è¡¨ä½¿ç”¨ä¸Šä¸‹ç®­å¤´è€Œéæ‹–æ‹½æ’åº

### 1.2 å¤ç°æ­¥éª¤
1. æ·»åŠ ä¸€ä¸ªæœåŠ¡å•†ï¼Œè®¾ç½®Temperatureä¸º1.5ï¼Œæœ€å¤§Tokenæ•°ä¸º8192
2. ä¿å­˜åé‡æ–°ç¼–è¾‘è¯¥æœåŠ¡å•†
3. è§‚å¯ŸTemperatureå’Œæœ€å¤§Tokenæ•°æ˜¾ç¤ºçš„æ˜¯é»˜è®¤å€¼ï¼ˆ0.7å’Œ4096ï¼‰

### 1.3 é¢„æœŸè¡Œä¸º
- ç¼–è¾‘æœåŠ¡å•†æ—¶åº”æ˜¾ç¤ºä¹‹å‰ä¿å­˜çš„Temperatureå’Œæœ€å¤§Tokenæ•°
- AIé…ç½®ä¸»ç•Œé¢ä¸åº”æ˜¾ç¤ºæœåŠ¡å•†çº§åˆ«çš„è®¾ç½®é¡¹

---

## 2. æ ¹å› åˆ†æ

### 2.1 æ ¹å› æ ‘

```
æ ¹å› ï¼šç¼–è¾‘æœåŠ¡å•†åŠŸèƒ½ç¼ºå¤±
â”‚
â”œâ”€â”€ é—®é¢˜1ï¼šç¼–è¾‘æ—¶æœªåŠ è½½é«˜çº§é€‰é¡¹
â”‚   â”œâ”€â”€ showEditDialog() æœªåŠ è½½ formTemperature å’Œ formMaxTokens
â”‚   â””â”€â”€ loadProviderForEdit() æœªåŠ è½½ formTemperature å’Œ formMaxTokens
â”‚
â”œâ”€â”€ é—®é¢˜2ï¼šä¿å­˜æ—¶æœªä¿å­˜é«˜çº§é€‰é¡¹
â”‚   â””â”€â”€ saveProvider() æ„å»º AiProvider æ—¶æœªåŒ…å« temperature å’Œ maxTokens
â”‚
â”œâ”€â”€ é—®é¢˜3ï¼šUIè®¾è®¡æ··æ·†
â”‚   â””â”€â”€ AiConfigScreen é«˜çº§è®¾ç½®åˆ†ç»„åŒ…å«äº†æœåŠ¡å•†çº§åˆ«çš„è®¾ç½®é¡¹
â”‚
â””â”€â”€ é—®é¢˜4ï¼šè¯·æ±‚è¶…æ—¶æœªå®ç°
    â””â”€â”€ onClick = { /* TODO: å®ç°è¯·æ±‚è¶…æ—¶è®¾ç½® */ }
```

### 2.2 ä»£ç å®šä½

| æ–‡ä»¶ | é—®é¢˜ | è¡Œå· |
|------|------|------|
| `AiConfigViewModel.kt` | `showEditDialog()` æœªåŠ è½½é«˜çº§é€‰é¡¹ | ~220 |
| `AiConfigViewModel.kt` | `loadProviderForEdit()` æœªåŠ è½½é«˜çº§é€‰é¡¹ | ~530 |
| `AiConfigViewModel.kt` | `saveProvider()` æœªä¿å­˜é«˜çº§é€‰é¡¹ | ~400 |
| `AiConfigScreen.kt` | é«˜çº§è®¾ç½®åˆ†ç»„è®¾è®¡ä¸å½“ | ~200 |

---

## 3. ä¿®å¤æ–¹æ¡ˆ

### 3.1 ä¿®å¤ showEditDialog()

```kotlin
private fun showEditDialog(provider: AiProvider) {
    _uiState.update {
        it.copy(
            showFormDialog = true,
            editingProvider = provider,
            formName = provider.name,
            formBaseUrl = provider.baseUrl,
            formApiKey = provider.apiKey,
            formModels = provider.models.map { model ->
                FormModel(id = model.id, displayName = model.displayName ?: "")
            },
            formDefaultModelId = provider.defaultModelId,
            // ğŸ†• æ·»åŠ é«˜çº§é€‰é¡¹åŠ è½½
            formTemperature = provider.temperature,
            formMaxTokens = provider.maxTokens,
            formNameError = null,
            formBaseUrlError = null,
            formApiKeyError = null,
            formModelsError = null,
            testConnectionResult = null
        )
    }
}
```

### 3.2 ä¿®å¤ loadProviderForEdit()

```kotlin
_uiState.update {
    it.copy(
        isLoading = false,
        showFormDialog = false,
        editingProvider = loadedProvider,
        formName = loadedProvider.name,
        formBaseUrl = loadedProvider.baseUrl,
        formApiKey = loadedProvider.apiKey,
        formModels = loadedProvider.models.map { model ->
            FormModel(id = model.id, displayName = model.displayName ?: "")
        },
        formDefaultModelId = loadedProvider.defaultModelId,
        // ğŸ†• æ·»åŠ é«˜çº§é€‰é¡¹åŠ è½½
        formTemperature = loadedProvider.temperature,
        formMaxTokens = loadedProvider.maxTokens,
        formNameError = null,
        formBaseUrlError = null,
        formApiKeyError = null,
        formModelsError = null,
        testConnectionResult = null
    )
}
```

### 3.3 ä¿®å¤ saveProvider()

```kotlin
val provider = AiProvider(
    id = currentState.editingProvider?.id ?: UUID.randomUUID().toString(),
    name = currentState.formName.trim(),
    baseUrl = currentState.formBaseUrl.trim(),
    apiKey = currentState.formApiKey.trim(),
    models = currentState.formModels.map { formModel ->
        AiModel(
            id = formModel.id,
            displayName = formModel.displayName.ifBlank { null }
        )
    },
    defaultModelId = currentState.formDefaultModelId,
    isDefault = currentState.editingProvider?.isDefault ?: false,
    // ğŸ†• æ·»åŠ é«˜çº§é€‰é¡¹ä¿å­˜
    temperature = currentState.formTemperature,
    maxTokens = currentState.formMaxTokens,
    createdAt = currentState.editingProvider?.createdAt ?: System.currentTimeMillis()
)
```

### 3.4 ä¿®å¤ AiConfigScreen é«˜çº§è®¾ç½®

ç§»é™¤"æœ€å¤§Tokenæ•°"è®¾ç½®é¡¹ï¼Œåªä¿ç•™"è¯·æ±‚è¶…æ—¶"ï¼ˆå…¨å±€é…ç½®ï¼‰ï¼š

```kotlin
// é«˜çº§è®¾ç½®åˆ†ç»„
item {
    IOSSettingsSection(title = "é«˜çº§è®¾ç½®") {
        IOSSettingsItem(
            icon = Icons.Default.Timer,
            iconBackgroundColor = iOSPurple,
            title = "è¯·æ±‚è¶…æ—¶",
            value = "${uiState.requestTimeout}ç§’",
            showDivider = false,
            onClick = { onEvent(AiConfigUiEvent.ShowTimeoutDialog) }
        )
        // ç§»é™¤æœ€å¤§Tokenæ•°è®¾ç½®é¡¹ï¼ˆè¿™æ˜¯æœåŠ¡å•†çº§åˆ«é…ç½®ï¼‰
    }
}
```

---

## 4. ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ID | æè¿° | çŠ¶æ€ |
|--------|------|------|
| T1 | ä¿®å¤ showEditDialog() åŠ è½½é«˜çº§é€‰é¡¹ | âœ… å·²å®Œæˆ |
| T2 | ä¿®å¤ loadProviderForEdit() åŠ è½½é«˜çº§é€‰é¡¹ | âœ… å·²å®Œæˆ |
| T3 | ä¿®å¤ saveProvider() ä¿å­˜é«˜çº§é€‰é¡¹ | âœ… å·²å®Œæˆ |
| T4 | ç§»é™¤ AiConfigScreen ä¸­çš„"æœ€å¤§Tokenæ•°"è®¾ç½®é¡¹ | âœ… å·²å®Œæˆ |
| T5 | å®ç°è¯·æ±‚è¶…æ—¶è®¾ç½®å¯¹è¯æ¡†ï¼ˆå¯é€‰ï¼‰ | â¬œ å¾…å®Œæˆï¼ˆåç»­ç‰ˆæœ¬ï¼‰ |
| T6 | æ„å»ºéªŒè¯ | âœ… å·²å®Œæˆ |
| T7 | å®‰è£…æµ‹è¯• | âœ… å·²å®Œæˆ |
| T8 | ğŸ†• å‡çº§EditProviderScreen UIï¼ˆæ–¹æ¡ˆCï¼šå¤ç”¨AddProviderScreenï¼‰ | âœ… å·²å®Œæˆ |

---

## 5. UIå‡çº§ä¿®å¤ï¼ˆPhase 2ï¼‰

### 5.1 é—®é¢˜åˆ†æ

EditProviderScreen ä½¿ç”¨æ—§UIç»„ä»¶ï¼š
- Temperature: `IOSSettingsItem` ç¡¬ç¼–ç  "0.7"
- MaxTokens: `IOSSettingsItem` ç¡¬ç¼–ç  "4096"  
- æ¨¡å‹åˆ—è¡¨: `IOSModelListItem` (ä¸Šä¸‹ç®­å¤´æ’åº)

AddProviderScreen ä½¿ç”¨æ–°UIç»„ä»¶ï¼ˆTD-00025ï¼‰ï¼š
- Temperature: `TemperatureSlider` æ»‘å—ç»„ä»¶
- MaxTokens: `TokenLimitInput` è¾“å…¥ç»„ä»¶
- æ¨¡å‹åˆ—è¡¨: `DraggableModelList` (é•¿æŒ‰æ‹–æ‹½æ’åº)

### 5.2 è§£å†³æ–¹æ¡ˆ

é‡‡ç”¨**æ–¹æ¡ˆCï¼šåˆå¹¶å¤ç”¨**ï¼Œå°†ç¼–è¾‘è·¯ç”±æŒ‡å‘AddProviderScreenï¼š

1. ä¿®æ”¹ `NavGraph.kt`ï¼šç¼–è¾‘è·¯ç”±ä½¿ç”¨ `AddProviderScreen`
2. ä¿®æ”¹ `AddProviderScreen.kt`ï¼šæ”¯æŒ `providerId` å‚æ•°ï¼Œç¼–è¾‘æ¨¡å¼æ—¶åŠ è½½æ•°æ®

### 5.3 ä»£ç ä¿®æ”¹

**NavGraph.kt**:
```kotlin
// ç¼–è¾‘æœåŠ¡å•†é¡µé¢ï¼ˆiOSé£æ ¼ï¼‰
// BUG-00040ä¿®å¤ï¼šå¤ç”¨AddProviderScreenï¼Œç¡®ä¿UIä¸€è‡´æ€§
composable(
    route = NavRoutes.EDIT_PROVIDER,
    arguments = listOf(...)
) { backStackEntry ->
    val providerId = backStackEntry.arguments?.getString(NavRoutes.EDIT_PROVIDER_ARG_ID) ?: ""
    com.empathy.ai.presentation.ui.screen.aiconfig.AddProviderScreen(
        providerId = providerId,
        onNavigateBack = { navController.navigateUp() }
    )
}
```

**AddProviderScreen.kt**:
```kotlin
@Composable
fun AddProviderScreen(
    onNavigateBack: () -> Unit,
    viewModel: AiConfigViewModel = hiltViewModel(),
    modifier: Modifier = Modifier,
    providerId: String? = null
) {
    // BUG-00040ä¿®å¤ï¼šç¼–è¾‘æ¨¡å¼æ—¶åŠ è½½æœåŠ¡å•†æ•°æ®
    LaunchedEffect(providerId) {
        if (!providerId.isNullOrEmpty()) {
            viewModel.onEvent(AiConfigUiEvent.LoadProviderForEdit(providerId))
        }
    }
    // ...
}
```

---

## 5. ç›¸å…³æ–‡æ¡£

- TD-00025: AIé…ç½®åŠŸèƒ½å®Œå–„ä»»åŠ¡æ¸…å•
- CN-00006: TD-00025ä¼šè¯äº¤æ¥æ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-02
