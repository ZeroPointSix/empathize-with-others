# BUG-00042: 新建AI服务商未自动设为默认

## 基本信息

| 属性 | 值 |
|------|-----|
| **BUG编号** | BUG-00042 |
| **标题** | 新建AI服务商未自动设为默认导致"没有AI配置"错误 |
| **严重程度** | P1 - 严重 |
| **状态** | ✅ 已修复 |
| **发现日期** | 2026-01-03 |
| **修复日期** | 2026-01-03 |
| **影响版本** | 所有版本 |
| **修复版本** | 当前开发版本 |

## 问题描述

### 现象
用户首次配置AI服务商后，使用悬浮窗发送AI请求时，应用显示"没有AI配置"（请先配置AI服务商）错误，即使AI服务商已经成功创建。

### 根本原因
在 `AiConfigViewModel.saveProvider()` 方法中，创建新服务商时 `isDefault` 字段始终被设置为 `false`：

```kotlin
// 问题代码
isDefault = currentState.editingProvider?.isDefault ?: false
```

当 `editingProvider` 为 `null`（新建模式）时，`isDefault` 总是 `false`，导致：
1. 第一个创建的AI服务商不会被设为默认
2. `getDefaultProvider()` 返回 `null`
3. UseCase（PolishDraftUseCase、GenerateReplyUseCase、AnalyzeChatUseCase）检查默认服务商失败
4. 抛出 `FloatingWindowError.NoProviderConfigured` 错误

### 影响范围
- 所有首次配置AI服务商的用户
- 悬浮窗的分析、润色、回复功能全部无法使用
- 用户体验严重受损

## 技术分析

### 调用链路
```
用户创建服务商 
→ AiConfigViewModel.saveProvider() 
→ AiProvider(isDefault=false)  // ❌ 问题点
→ AiProviderRepositoryImpl.saveProvider() 
→ AiProviderDao.insertOrUpdate() 
→ Database (is_default = 0)

悬浮窗AI请求 
→ PolishDraftUseCase/GenerateReplyUseCase/AnalyzeChatUseCase 
→ aiProviderRepository.getDefaultProvider() 
→ Returns null  // ❌ 没有默认服务商
→ FloatingWindowError.NoProviderConfigured 
→ "请先配置AI服务商" 错误
```

### 相关文件
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiConfigViewModel.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/usecase/PolishDraftUseCase.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/usecase/GenerateReplyUseCase.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/usecase/AnalyzeChatUseCase.kt`
- `data/src/main/kotlin/com/empathy/ai/data/repository/AiProviderRepositoryImpl.kt`

## 修复方案

### 修改文件
`presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiConfigViewModel.kt`

### 修改内容
在 `saveProvider()` 方法中添加逻辑：新建服务商时，如果是第一个服务商，自动设置为默认。

```kotlin
// BUG-00042修复：新建服务商时，如果是第一个服务商，自动设置为默认
// 判断是否为新建模式（editingProvider 为 null）
val isNewProvider = currentState.editingProvider == null
// 如果是新建且当前没有任何服务商，则自动设为默认
val shouldBeDefault = if (isNewProvider) {
    currentState.providers.isEmpty()
} else {
    currentState.editingProvider?.isDefault ?: false
}

// 构建 AiProvider 对象
val provider = AiProvider(
    // ... 其他字段
    isDefault = shouldBeDefault,  // BUG-00042: 使用计算后的默认值
    // ...
)
```

### 修复逻辑说明
1. 判断是否为新建模式（`editingProvider == null`）
2. 如果是新建且当前服务商列表为空，则自动设为默认
3. 如果是编辑模式，保持原有的 `isDefault` 值
4. 这样确保第一个创建的服务商自动成为默认服务商

## 测试验证

### 测试步骤
1. 卸载应用或清除应用数据
2. 重新安装应用
3. 进入设置 → AI配置 → 添加服务商
4. 填写服务商信息并保存
5. 返回主界面，打开悬浮窗
6. 输入文本，点击润色/回复/分析按钮
7. 验证AI请求是否正常执行

### 预期结果
- 第一个创建的服务商自动成为默认服务商
- 悬浮窗AI请求正常工作
- 不再显示"没有AI配置"错误

### 实际结果
- ✅ 修复后测试通过

## 相关BUG
- BUG-00041: 悬浮窗发送AI请求时应用崩溃（通知图标问题）

## 备注
此BUG与BUG-00041同时发现，两个BUG共同导致悬浮窗AI功能完全无法使用。BUG-00041是崩溃问题，BUG-00042是功能逻辑问题。
