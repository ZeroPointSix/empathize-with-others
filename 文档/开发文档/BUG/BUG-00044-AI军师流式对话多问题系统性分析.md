# BUG-00044: AIå†›å¸ˆæµå¼å¯¹è¯å¤šé—®é¢˜ç³»ç»Ÿæ€§åˆ†æ

**åˆ›å»ºæ—¥æœŸ**: 2026-01-04
**å…³è”ä»»åŠ¡**: FD-00028 AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸¥é‡
**çŠ¶æ€**: âœ… å·²ä¿®å¤ï¼ˆ11/13æ ¸å¿ƒé—®é¢˜ï¼‰
**æœ€åæ›´æ–°**: 2026-01-04

---

## 1. é—®é¢˜æ¦‚è¿°

FD-00028 AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§åŠŸèƒ½åœ¨äººå·¥æµ‹è¯•ä¸­å‘ç°å¤šä¸ªä¸¥é‡é—®é¢˜ï¼Œå½±å“æ ¸å¿ƒåŠŸèƒ½çš„æ­£å¸¸ä½¿ç”¨ã€‚æœ¬æ–‡æ¡£å¯¹æ‰€æœ‰é—®é¢˜è¿›è¡Œç³»ç»Ÿæ€§åˆ†æï¼Œå¹¶æä¾›ä¿®å¤æ–¹æ¡ˆã€‚

---

## ä¿®å¤è¿›åº¦æ€»è§ˆ

| ä¼˜å…ˆçº§ | å®Œæˆæ•° | æ€»æ•° | å®Œæˆç‡ |
|--------|--------|------|--------|
| P0 | 5 | 5 | âœ… 100% |
| P1 | 5 | 6 | 83.3% |
| P2 | 1 | 2 | 50% |
| **æ€»è®¡** | **11** | **13** | **84.6%** |

---

## 2. é—®é¢˜æ¸…å•

### 2.1 P0çº§é—®é¢˜ï¼ˆä¸¥é‡ï¼Œé˜»å¡æ ¸å¿ƒåŠŸèƒ½ï¼‰

#### BUG-044-P0-001: AIå›å¤å®Œæˆåæ˜¾ç¤ºä¸‰ä¸ªçœç•¥å· âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**: 
AIæµå¼å›å¤å®Œæˆåï¼ŒUIåˆ·æ–°ï¼ŒåŸæœ‰å†…å®¹æ¶ˆå¤±ï¼Œåªæ˜¾ç¤º"..."ä¸‰ä¸ªçœç•¥å·ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: åœ¨AiAdvisorChatScreen.ktä¸­æ·»åŠ æ›´ä¸¥æ ¼çš„æµå¼æ¶ˆæ¯æ¸²æŸ“æ¡ä»¶
```kotlin
// BUG-044-P0-001/P0-005ä¿®å¤ï¼šæ·»åŠ æ›´ä¸¥æ ¼çš„æ¸²æŸ“æ¡ä»¶
if (uiState.isStreaming && uiState.currentStreamingMessageId != null)
```

**å¤ç°æ­¥éª¤**:
1. è¿›å…¥AIå†›å¸ˆå¯¹è¯ç•Œé¢
2. å‘é€ä»»æ„é—®é¢˜
3. ç­‰å¾…AIæµå¼å›å¤å®Œæˆ
4. è§‚å¯ŸAIæ¶ˆæ¯æ˜¾ç¤º

**é¢„æœŸç»“æœ**: æ˜¾ç¤ºå®Œæ•´çš„AIå›å¤å†…å®¹
**å®é™…ç»“æœ**: åªæ˜¾ç¤º"..."

**æ ¹æœ¬åŸå› åˆ†æ**:
```kotlin
// StreamingMessageBubble.kt - MainTextBubble ç»„ä»¶
// å½“å‰é€»è¾‘å­˜åœ¨ç¼ºé™·
if (content.isEmpty() && isStreaming) {
    // æ˜¾ç¤º"æ­£åœ¨ç”Ÿæˆ"å ä½ç¬¦
} else {
    // æ˜¾ç¤ºå†…å®¹
}
// é—®é¢˜ï¼šå½“ isStreaming=false ä¸” content="" æ—¶ï¼Œä»ä¼šæ¸²æŸ“ç©ºå†…å®¹
```

æµå¼å®Œæˆåï¼Œ`StreamingState.Completed` è§¦å‘çŠ¶æ€æ›´æ–°ï¼š
```kotlin
is StreamingState.Completed -> {
    _uiState.update {
        it.copy(
            isStreaming = false,
            streamingContent = "",  // æ¸…ç©ºäº†å†…å®¹ï¼
            thinkingContent = "",
            // ...
        )
    }
}
```

é—®é¢˜åœ¨äºï¼š
1. `streamingContent` è¢«æ¸…ç©º
2. ä½† `conversations` åˆ—è¡¨ä¸­çš„æ¶ˆæ¯å¯èƒ½è¿˜æœªæ›´æ–°
3. UIæ¸²æŸ“æ—¶ä½¿ç”¨äº†ç©ºçš„ `streamingContent`

**ä¿®å¤æ–¹æ¡ˆ**:

æ–¹æ¡ˆAï¼šä¿®æ”¹çŠ¶æ€æ›´æ–°é€»è¾‘
```kotlin
// AiAdvisorChatViewModel.kt
is StreamingState.Completed -> {
    // ä¸è¦æ¸…ç©º streamingContentï¼Œè®©å®ƒä¿æŒæœ€åçš„å†…å®¹
    // ç›´åˆ° conversations åˆ—è¡¨æ›´æ–°åå†æ¸…ç©º
    _uiState.update {
        it.copy(
            isStreaming = false,
            // streamingContent = "",  // ç§»é™¤è¿™è¡Œ
            thinkingContent = "",
            thinkingElapsedMs = 0,
            currentStreamingMessageId = null,
            lastTokenUsage = state.usage
        )
    }
}
```

æ–¹æ¡ˆBï¼šä¿®æ”¹UIæ¸²æŸ“é€»è¾‘
```kotlin
// AiAdvisorChatScreen.kt
// æµå¼å“åº”ä¸­çš„æ¶ˆæ¯ - åªåœ¨æœ‰å†…å®¹æ—¶æ˜¾ç¤º
if (uiState.isStreaming || uiState.streamingContent.isNotEmpty()) {
    item(key = "streaming_message") {
        StreamingMessageBubbleSimple(
            content = uiState.streamingContent,
            // ...
        )
    }
}
```

**æ¨èæ–¹æ¡ˆ**: æ–¹æ¡ˆBï¼Œæ›´å®‰å…¨ï¼Œä¸å½±å“å…¶ä»–é€»è¾‘

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

#### BUG-044-P0-002: é‡æ–°ç”ŸæˆæŒ‰é’®ç‚¹å‡»æ— ååº”

**é—®é¢˜æè¿°**: 
ç‚¹å‡»AIæ¶ˆæ¯ä¸‹æ–¹çš„"é‡æ–°ç”Ÿæˆ"æŒ‰é’®æ²¡æœ‰ä»»ä½•ååº”ã€‚

**å¤ç°æ­¥éª¤**:
1. å®Œæˆä¸€æ¬¡AIå¯¹è¯
2. ç‚¹å‡»æœ€åä¸€æ¡AIæ¶ˆæ¯ä¸‹æ–¹çš„"é‡æ–°ç”Ÿæˆ"æŒ‰é’®
3. è§‚å¯Ÿå“åº”

**é¢„æœŸç»“æœ**: åˆ é™¤å½“å‰AIå›å¤ï¼Œé‡æ–°å‘é€è¯·æ±‚
**å®é™…ç»“æœ**: æ— ä»»ä½•ååº”

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `StreamingMessageBubble.kt` ä¸­çš„ `ActionButtons` ç»„ä»¶ï¼š
```kotlin
@Composable
private fun ActionButtons(
    isStreaming: Boolean,
    onStopGeneration: () -> Unit,
    onRegenerate: () -> Unit
) {
    Row(...) {
        if (isStreaming) {
            StopGenerationButton(onClick = onStopGeneration)
        } else {
            RegenerateButton(onClick = onRegenerate)  // è¿™é‡Œåº”è¯¥æ­£ç¡®
        }
    }
}
```

é—®é¢˜å¯èƒ½åœ¨äºï¼š
1. `RegenerateButton` ç»„ä»¶æœªæ­£ç¡®å®ç°
2. æˆ–è€… `onRegenerate` å›è°ƒæœªæ­£ç¡®ä¼ é€’

æ£€æŸ¥ `AiAdvisorChatScreen.kt` ä¸­çš„è°ƒç”¨ï¼š
```kotlin
StreamingMessageBubbleSimple(
    // ...
    onRegenerate = { viewModel.regenerateLastMessage() }
)
```

æ£€æŸ¥ `regenerateLastMessage()` å®ç°ï¼š
```kotlin
fun regenerateLastMessage() {
    val conversations = _uiState.value.conversations
    val lastAiMessage = conversations.lastOrNull { it.messageType == MessageType.AI }
    val lastUserMessage = conversations.lastOrNull { it.messageType == MessageType.USER }

    if (lastAiMessage != null && lastUserMessage != null) {
        viewModelScope.launch {
            deleteAdvisorConversationUseCase(lastAiMessage.id)
            _uiState.update { it.copy(inputText = lastUserMessage.content) }
            sendMessage()
        }
    }
}
```

**å¯èƒ½çš„é—®é¢˜**:
1. `RegenerateButton` ç»„ä»¶å¯èƒ½æœªå®ç°æˆ–æœªæ­£ç¡®å¯¼å…¥
2. æŒ‰é’®å¯èƒ½è¢«å…¶ä»–å…ƒç´ é®æŒ¡
3. `conversations` åˆ—è¡¨å¯èƒ½ä¸ºç©º

**ä¿®å¤æ–¹æ¡ˆ**:

1. ç¡®ä¿ `RegenerateButton` ç»„ä»¶å­˜åœ¨å¹¶æ­£ç¡®å®ç°ï¼š
```kotlin
@Composable
fun RegenerateButton(onClick: () -> Unit) {
    Row(
        modifier = Modifier.clickable(onClick = onClick),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Icon(
            imageVector = Icons.Default.Refresh,
            contentDescription = null,
            tint = iOSBlue,
            modifier = Modifier.size(14.dp)
        )
        Spacer(modifier = Modifier.width(4.dp))
        Text("é‡æ–°ç”Ÿæˆ", fontSize = 12.sp, color = iOSBlue)
    }
}
```

2. æ·»åŠ æ—¥å¿—éªŒè¯æ‰§è¡Œï¼š
```kotlin
fun regenerateLastMessage() {
    Log.d(TAG, "regenerateLastMessage called")
    val conversations = _uiState.value.conversations
    Log.d(TAG, "conversations size: ${conversations.size}")
    // ...
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/component/StreamingMessageBubble.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

#### BUG-044-P0-003: å·²åˆ›å»ºå¯¹è¯ä¸­é‡æ–°è¾“å…¥æ— ååº”

**é—®é¢˜æè¿°**: 
åœ¨å·²æœ‰å¯¹è¯çš„ä¼šè¯ä¸­å‘é€æ–°æ¶ˆæ¯ï¼Œå¡åœ¨"æ­£åœ¨ç”Ÿæˆ"çŠ¶æ€ï¼Œæ— å“åº”ã€‚

**å¤ç°æ­¥éª¤**:
1. å®Œæˆä¸€æ¬¡AIå¯¹è¯
2. åœ¨åŒä¸€ä¼šè¯ä¸­è¾“å…¥æ–°é—®é¢˜
3. ç‚¹å‡»å‘é€
4. è§‚å¯Ÿå“åº”

**é¢„æœŸç»“æœ**: æ­£å¸¸å‘é€å¹¶è·å–AIå›å¤
**å®é™…ç»“æœ**: å¡åœ¨"æ­£åœ¨ç”Ÿæˆ"çŠ¶æ€

**æ ¹æœ¬åŸå› åˆ†æ**:

å¯èƒ½åŸå› ï¼š
1. å‰ä¸€ä¸ªæµå¼è¯·æ±‚æœªå®Œå…¨å–æ¶ˆ
2. `streamingJob` ä»åœ¨è¿è¡Œ
3. çŠ¶æ€æœªæ­£ç¡®é‡ç½®

æ£€æŸ¥ `sendMessageStreaming()`:
```kotlin
private fun sendMessageStreaming(message: String, sessionId: String) {
    _uiState.update {
        it.copy(
            isStreaming = true,
            // ...
        )
    }

    streamingJob = viewModelScope.launch {
        // å¦‚æœå‰ä¸€ä¸ª streamingJob è¿˜åœ¨è¿è¡Œï¼Œè¿™é‡Œä¼šåˆ›å»ºæ–°çš„
        // ä½†æ—§çš„å¯èƒ½è¿˜åœ¨å ç”¨èµ„æº
    }
}
```

**ä¿®å¤æ–¹æ¡ˆ**:

åœ¨å¼€å§‹æ–°çš„æµå¼è¯·æ±‚å‰ï¼Œç¡®ä¿æ¸…ç†æ—§çš„ï¼š
```kotlin
private fun sendMessageStreaming(message: String, sessionId: String) {
    // å…ˆå–æ¶ˆæ—§çš„æµå¼è¯·æ±‚
    streamingJob?.cancel()
    streamingJob = null
    
    _uiState.update {
        it.copy(
            isStreaming = true,
            isSending = false,
            inputText = "",
            error = null,
            streamingContent = "",
            thinkingContent = "",
            thinkingElapsedMs = 0,
            currentStreamingMessageId = null
        )
    }

    streamingJob = viewModelScope.launch {
        // ...
    }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

#### BUG-044-P0-004: æ»šåŠ¨æ—¶è‡ªåŠ¨è·³å›é¡¶éƒ¨

**é—®é¢˜æè¿°**: 
å¯¹è¯å†…å®¹è¾ƒå¤šæ—¶ï¼Œç”¨æˆ·å‘ä¸‹æ»šåŠ¨æŸ¥çœ‹å†å²ï¼Œä¼šè‡ªåŠ¨è·³å›é¡¶éƒ¨ã€‚

**å¤ç°æ­¥éª¤**:
1. è¿›è¡Œå¤šè½®å¯¹è¯ï¼Œäº§ç”Ÿè¾ƒé•¿çš„å¯¹è¯å†å²
2. å‘ä¸Šæ»šåŠ¨æŸ¥çœ‹å†å²æ¶ˆæ¯
3. è§‚å¯Ÿæ»šåŠ¨è¡Œä¸º

**é¢„æœŸç»“æœ**: ä¿æŒç”¨æˆ·æ»šåŠ¨ä½ç½®
**å®é™…ç»“æœ**: è‡ªåŠ¨è·³å›é¡¶éƒ¨æˆ–åº•éƒ¨

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `AiAdvisorChatScreen.kt` ä¸­çš„æ»šåŠ¨é€»è¾‘ï¼š
```kotlin
// Scroll to bottom when new message arrives or streaming content updates
LaunchedEffect(uiState.conversations.size, uiState.streamingContent) {
    if (uiState.conversations.isNotEmpty() || uiState.isStreaming) {
        val targetIndex = if (uiState.isStreaming) {
            uiState.conversations.size
        } else {
            uiState.conversations.size - 1
        }
        if (targetIndex >= 0) {
            listState.animateScrollToItem(targetIndex.coerceAtLeast(0))
        }
    }
}
```

é—®é¢˜ï¼šæ¯æ¬¡ `streamingContent` æ›´æ–°éƒ½ä¼šè§¦å‘æ»šåŠ¨ï¼Œæ‰“æ–­ç”¨æˆ·æ“ä½œã€‚

**ä¿®å¤æ–¹æ¡ˆ**:

åªåœ¨ç”¨æˆ·å·²åœ¨åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨ï¼š
```kotlin
LaunchedEffect(uiState.conversations.size, uiState.streamingContent) {
    if (uiState.conversations.isNotEmpty() || uiState.isStreaming) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨åº•éƒ¨é™„è¿‘
        val lastVisibleIndex = listState.layoutInfo.visibleItemsInfo.lastOrNull()?.index ?: 0
        val totalItems = uiState.conversations.size + (if (uiState.isStreaming) 1 else 0)
        val isNearBottom = lastVisibleIndex >= totalItems - 2
        
        if (isNearBottom) {
            val targetIndex = if (uiState.isStreaming) {
                uiState.conversations.size
            } else {
                uiState.conversations.size - 1
            }
            if (targetIndex >= 0) {
                listState.animateScrollToItem(targetIndex.coerceAtLeast(0))
            }
        }
    }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

---

#### BUG-044-P0-005: è¾“å…¥æ—¶è‡ªåŠ¨å¼¹å‡ºä¸‰ä¸ªçœç•¥å·

**é—®é¢˜æè¿°**: 
è¾“å…¥æ¶ˆæ¯æ—¶ä¼šè‡ªåŠ¨å¼¹å‡º"..."ï¼Œè¡¨ç¤ºé‡æ–°ç”Ÿæˆã€‚

**å¤ç°æ­¥éª¤**:
1. è¿›å…¥AIå†›å¸ˆå¯¹è¯ç•Œé¢
2. åœ¨è¾“å…¥æ¡†è¾“å…¥æ–‡å­—
3. è§‚å¯Ÿå¯¹è¯åˆ—è¡¨

**é¢„æœŸç»“æœ**: å¯¹è¯åˆ—è¡¨ä¸å˜
**å®é™…ç»“æœ**: å‡ºç°"..."æ¶ˆæ¯

**æ ¹æœ¬åŸå› åˆ†æ**:

å¯èƒ½æ˜¯ `StreamingMessageBubbleSimple` çš„æ¸²æŸ“æ¡ä»¶æœ‰é—®é¢˜ï¼š
```kotlin
// AiAdvisorChatScreen.kt
if (uiState.isStreaming) {
    item(key = "streaming_message") {
        StreamingMessageBubbleSimple(...)
    }
}
```

æ£€æŸ¥ `isStreaming` çŠ¶æ€æ˜¯å¦åœ¨ä¸åº”è¯¥ä¸º `true` æ—¶å˜æˆäº† `true`ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:

æ·»åŠ æ›´ä¸¥æ ¼çš„æ¸²æŸ“æ¡ä»¶ï¼š
```kotlin
// åªåœ¨çœŸæ­£æµå¼å“åº”æ—¶æ˜¾ç¤º
if (uiState.isStreaming && uiState.currentStreamingMessageId != null) {
    item(key = "streaming_message") {
        StreamingMessageBubbleSimple(...)
    }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

---

### 2.2 P1çº§é—®é¢˜ï¼ˆé‡è¦ï¼Œå½±å“ç”¨æˆ·ä½“éªŒï¼‰

#### BUG-044-P1-001: é‡è¯•æŒ‰é’®ç‚¹å‡»æ— ååº”

**é—®é¢˜æè¿°**: 
ç‚¹å‡»å¤±è´¥æ¶ˆæ¯çš„"é‡è¯•"æŒ‰é’®æ²¡æœ‰ååº”ã€‚

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `ChatBubble` ä¸­çš„é‡è¯•æŒ‰é’®ï¼š
```kotlin
if (isFailed || isCancelled) {
    Row(...) {
        Row(
            modifier = Modifier.clickable(onClick = onRetry),
            // ...
        ) {
            Text("é‡è¯•", ...)
        }
    }
}
```

æ£€æŸ¥ `retryMessage()` å®ç°ï¼š
```kotlin
fun retryMessage(conversation: AiAdvisorConversation) {
    if (conversation.sendStatus != SendStatus.FAILED) return  // å¯èƒ½è¿™é‡Œè¿”å›äº†

    viewModelScope.launch {
        deleteAdvisorConversationUseCase(conversation.id)
        _uiState.update { it.copy(inputText = conversation.content) }
        sendMessage()
    }
}
```

**ä¿®å¤æ–¹æ¡ˆ**:

1. æ‰©å±•é‡è¯•æ¡ä»¶ï¼ŒåŒ…æ‹¬ `CANCELLED` çŠ¶æ€ï¼š
```kotlin
fun retryMessage(conversation: AiAdvisorConversation) {
    if (conversation.sendStatus != SendStatus.FAILED && 
        conversation.sendStatus != SendStatus.CANCELLED) return

    viewModelScope.launch {
        deleteAdvisorConversationUseCase(conversation.id)
        _uiState.update { it.copy(inputText = conversation.content) }
        sendMessage()
    }
}
```

2. æ·»åŠ æ—¥å¿—éªŒè¯æ‰§è¡Œ

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

#### BUG-044-P1-002: åœæ­¢ç”Ÿæˆåæ˜¾ç¤ºä¸‰ä¸ªçœç•¥å·

**é—®é¢˜æè¿°**: 
ç”¨æˆ·ç‚¹å‡»åœæ­¢æŒ‰é’®åï¼ŒUIæ˜¾ç¤ºä¸€æ¡åªæœ‰"..."çš„æ¶ˆæ¯ã€‚

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `stopGeneration()`:
```kotlin
fun stopGeneration() {
    streamingJob?.cancel()
    streamingJob = null

    val messageId = _uiState.value.currentStreamingMessageId
    _uiState.update {
        it.copy(
            isStreaming = false,
            streamingContent = "",  // æ¸…ç©ºå†…å®¹
            thinkingContent = "",
            currentStreamingMessageId = null
        )
    }

    messageId?.let { id ->
        viewModelScope.launch {
            aiAdvisorRepository.updateMessageStatus(id, SendStatus.CANCELLED)
        }
    }
}
```

é—®é¢˜ï¼šæ¶ˆæ¯çŠ¶æ€æ›´æ–°ä¸º `CANCELLED`ï¼Œä½†å†…å®¹å¯èƒ½ä¸ºç©ºæˆ–ä¸å®Œæ•´ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:

åœ¨åœæ­¢æ—¶ä¿å­˜å½“å‰å†…å®¹ï¼š
```kotlin
fun stopGeneration() {
    streamingJob?.cancel()
    streamingJob = null

    val messageId = _uiState.value.currentStreamingMessageId
    val currentContent = _uiState.value.streamingContent
    
    _uiState.update {
        it.copy(
            isStreaming = false,
            streamingContent = "",
            thinkingContent = "",
            currentStreamingMessageId = null
        )
    }

    messageId?.let { id ->
        viewModelScope.launch {
            // å¦‚æœæœ‰å†…å®¹ï¼Œä¿å­˜å†…å®¹å¹¶æ ‡è®°ä¸ºå–æ¶ˆ
            if (currentContent.isNotEmpty()) {
                aiAdvisorRepository.updateMessageContentAndStatus(
                    id, 
                    currentContent + "\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]",
                    SendStatus.CANCELLED
                )
            } else {
                // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œåˆ é™¤æ¶ˆæ¯
                aiAdvisorRepository.deleteMessage(id)
            }
        }
    }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/repository/AiAdvisorRepository.kt`

---

#### BUG-044-P1-003: æ–­ç½‘æ—¶å¡åœ¨æ€è€ƒç•Œé¢æ— ååº”

**é—®é¢˜æè¿°**: 
ç½‘ç»œæ–­å¼€æ—¶ï¼Œåº”ç”¨å¡åœ¨"æ€è€ƒä¸­..."ç•Œé¢ï¼Œæ— é”™è¯¯æç¤ºã€‚

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `SseStreamReader.onFailure()`:
```kotlin
override fun onFailure(
    eventSource: EventSource,
    t: Throwable?,
    response: Response?
) {
    consecutiveFailures++
    val error = t ?: IOException("SSE connection failed: ${response?.code}")
    // ...
    trySend(AiStreamChunk.Error(error))
    channel.close()
}
```

é—®é¢˜å¯èƒ½åœ¨äºï¼š
1. ç½‘ç»œè¶…æ—¶æ—¶é—´è¿‡é•¿
2. é”™è¯¯æœªæ­£ç¡®ä¼ æ’­åˆ°UI

**ä¿®å¤æ–¹æ¡ˆ**:

1. é…ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼š
```kotlin
// NetworkModule.kt
@Provides
@Named("sse")
fun provideSseOkHttpClient(): OkHttpClient {
    return OkHttpClient.Builder()
        .connectTimeout(10, TimeUnit.SECONDS)
        .readTimeout(30, TimeUnit.SECONDS)
        .writeTimeout(10, TimeUnit.SECONDS)
        .build()
}
```

2. åœ¨ViewModelä¸­å¤„ç†è¶…æ—¶ï¼š
```kotlin
streamingJob = viewModelScope.launch {
    withTimeout(60_000) { // 60ç§’æ€»è¶…æ—¶
        sendAdvisorMessageStreamingUseCase(...)
            .collect { state ->
                // ...
            }
    }
}.also { job ->
    job.invokeOnCompletion { throwable ->
        if (throwable is TimeoutCancellationException) {
            _uiState.update {
                it.copy(
                    isStreaming = false,
                    error = "è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
                )
            }
        }
    }
}
```

**å½±å“æ–‡ä»¶**:
- `data/src/main/kotlin/com/empathy/ai/data/di/NetworkModule.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

#### BUG-044-P1-004: APIé”™è¯¯æç¤ºä¸å‹å¥½

**é—®é¢˜æè¿°**: 
APIå¯†é’¥æ— æ•ˆæ—¶ï¼Œåªæ˜¾ç¤º"SSE HTTP connection L401"ï¼Œæ²¡æœ‰å‘Šè¯‰ç”¨æˆ·æ£€æŸ¥APIå¯†é’¥ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:

åœ¨ `SseStreamReader` ä¸­æ·»åŠ é”™è¯¯ç è¯†åˆ«ï¼š
```kotlin
override fun onFailure(
    eventSource: EventSource,
    t: Throwable?,
    response: Response?
) {
    consecutiveFailures++
    val errorMessage = parseErrorMessage(response, t)
    val error = IOException(errorMessage)
    
    trySend(AiStreamChunk.Error(error))
    channel.close()
}

private fun parseErrorMessage(response: Response?, throwable: Throwable?): String {
    return when {
        response?.code == 401 -> "APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·åœ¨è®¾ç½®ä¸­æ£€æŸ¥APIå¯†é’¥é…ç½®"
        response?.code == 403 -> "APIè®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥æƒé™"
        response?.code == 429 -> "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"
        response?.code == 500 -> "AIæœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•"
        response?.code == 502 || response?.code == 503 -> "AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•"
        throwable is java.net.UnknownHostException -> "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®"
        throwable is java.net.SocketTimeoutException -> "è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
        else -> "è¿æ¥å¤±è´¥: ${response?.code ?: throwable?.message ?: "æœªçŸ¥é”™è¯¯"}"
    }
}
```

**å½±å“æ–‡ä»¶**:
- `data/src/main/kotlin/com/empathy/ai/data/remote/SseStreamReader.kt`

---

#### BUG-044-P1-005: ä¼šè¯åˆ‡æ¢æ—¶è¯·æ±‚è¢«è¿ç§»

**é—®é¢˜æè¿°**: 
åœ¨ä¼šè¯Aä¸­å‘é€è¯·æ±‚ï¼Œåˆ‡æ¢åˆ°ä¼šè¯Bï¼Œä¼šè¯Açš„è¯·æ±‚ä»ç„¶ç»§ç»­æ‰§è¡Œã€‚

**ä¿®å¤æ–¹æ¡ˆ**:

åœ¨ `switchSession()` ä¸­åœæ­¢å½“å‰æµå¼å“åº”ï¼š
```kotlin
fun switchSession(sessionId: String) {
    // å…ˆåœæ­¢å½“å‰æµå¼å“åº”
    stopGeneration()
    
    _uiState.update { 
        it.copy(
            currentSessionId = sessionId,
            streamingContent = "",
            thinkingContent = "",
            error = null
        ) 
    }
    loadConversations(sessionId)
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

#### BUG-044-P1-006: æ²¡æœ‰åˆ é™¤å¤±è´¥æ¶ˆæ¯çš„æŒ‰é’®

**é—®é¢˜æè¿°**: 
å¤±è´¥æ¶ˆæ¯æ²¡æœ‰åˆ é™¤æŒ‰é’®ã€‚

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `ChatBubble` ä¸­çš„ä»£ç ï¼Œå‘ç°åˆ é™¤æŒ‰é’®å·²å­˜åœ¨ï¼š
```kotlin
if (isFailed || isCancelled) {
    Row(...) {
        // é‡è¯•æŒ‰é’®
        Row(modifier = Modifier.clickable(onClick = onRetry)) { ... }
        // åˆ é™¤æŒ‰é’®
        Row(modifier = Modifier.clickable(onClick = onDelete)) { ... }
    }
}
```

å¯èƒ½æ˜¯æŒ‰é’®æœªæ­£ç¡®æ˜¾ç¤ºæˆ–å›è°ƒæœªæ­£ç¡®ä¼ é€’ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:

ç¡®ä¿åˆ é™¤æŒ‰é’®æ­£ç¡®æ˜¾ç¤ºå’Œå›è°ƒæ­£ç¡®ä¼ é€’ã€‚

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

---

### 2.3 P2çº§é—®é¢˜ï¼ˆä¼˜åŒ–ï¼Œæ”¹è¿›ä½“éªŒï¼‰

#### BUG-044-P2-001: æµå¼å…‰æ ‡åŠ¨ç”»æœªæ˜¾ç¤º

**é—®é¢˜æè¿°**: 
æµå¼å“åº”æ—¶ï¼Œåº”è¯¥æ˜¾ç¤ºé—ªçƒçš„å…‰æ ‡ï¼ˆâ–Œï¼‰ï¼Œä½†å®é™…æ²¡æœ‰æ˜¾ç¤ºã€‚

**ä¿®å¤æ–¹æ¡ˆ**:

ç¡®ä¿ `StreamingCursor` ç»„ä»¶æ­£ç¡®å®ç°ï¼š
```kotlin
@Composable
fun StreamingCursor() {
    val infiniteTransition = rememberInfiniteTransition(label = "cursor")
    val alpha by infiniteTransition.animateFloat(
        initialValue = 1f,
        targetValue = 0f,
        animationSpec = infiniteRepeatable(
            animation = tween(500, easing = LinearEasing),
            repeatMode = RepeatMode.Reverse
        ),
        label = "cursorAlpha"
    )
    
    Text(
        text = "â–Œ",
        color = iOSBlue.copy(alpha = alpha),
        fontSize = 16.sp
    )
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/component/StreamingMessageBubble.kt`

---

#### BUG-044-P2-002: è¾“å‡ºå†…å®¹æºå¸¦å¤§é‡MDæ ¼å¼å­—ç¬¦æœªæ¸²æŸ“

**é—®é¢˜æè¿°**: 
AIå›å¤åŒ…å«Markdownæ ¼å¼ï¼ˆå¦‚ `**ç²—ä½“**`ã€`# æ ‡é¢˜`ï¼‰ï¼Œä½†æœªæ¸²æŸ“ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹å­—ç¬¦ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:

è€ƒè™‘é›†æˆMarkdownæ¸²æŸ“åº“ï¼Œå¦‚ `compose-markdown`ï¼š
```kotlin
// build.gradle.kts
implementation("com.github.jeziellago:compose-markdown:0.3.4")

// ä½¿ç”¨
Markdown(
    content = aiResponse,
    modifier = Modifier.padding(16.dp)
)
```

æˆ–è€…ç®€å•å¤„ç†å¸¸è§æ ¼å¼ï¼š
```kotlin
fun formatMarkdown(text: String): AnnotatedString {
    return buildAnnotatedString {
        // å¤„ç†ç²—ä½“
        val boldPattern = "\\*\\*(.*?)\\*\\*".toRegex()
        // å¤„ç†æ–œä½“
        val italicPattern = "\\*(.*?)\\*".toRegex()
        // ...
    }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/component/StreamingMessageBubble.kt`
- `build.gradle.kts` (å¦‚æœæ·»åŠ ä¾èµ–)

---

## 3. ä¿®å¤ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | é—®é¢˜ç¼–å· | é¢„è®¡å·¥æ—¶ | ä¿®å¤éš¾åº¦ |
|--------|----------|----------|----------|
| P0 | P0-001 | 0.5h | ä½ |
| P0 | P0-002 | 1h | ä¸­ |
| P0 | P0-003 | 0.5h | ä½ |
| P0 | P0-004 | 1h | ä¸­ |
| P0 | P0-005 | 0.5h | ä½ |
| P1 | P1-001 | 0.5h | ä½ |
| P1 | P1-002 | 1h | ä¸­ |
| P1 | P1-003 | 1h | ä¸­ |
| P1 | P1-004 | 0.5h | ä½ |
| P1 | P1-005 | 0.5h | ä½ |
| P1 | P1-006 | 0.5h | ä½ |
| P2 | P2-001 | 0.5h | ä½ |
| P2 | P2-002 | 2h | ä¸­ |

**æ€»é¢„è®¡å·¥æ—¶**: 10å°æ—¶

---

## 4. æµ‹è¯•éªŒè¯

ä¿®å¤å®Œæˆåï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹éªŒè¯ï¼š

1. **æµå¼å“åº”å®Œæ•´æ€§æµ‹è¯•**
   - å‘é€é—®é¢˜ï¼ŒéªŒè¯AIå›å¤å®Œæ•´æ˜¾ç¤º
   - éªŒè¯æµå¼å…‰æ ‡æ­£ç¡®æ˜¾ç¤ºå’Œæ¶ˆå¤±

2. **é‡æ–°ç”ŸæˆåŠŸèƒ½æµ‹è¯•**
   - ç‚¹å‡»é‡æ–°ç”Ÿæˆï¼ŒéªŒè¯åŠŸèƒ½æ­£å¸¸

3. **ä¼šè¯ç®¡ç†æµ‹è¯•**
   - åˆ‡æ¢ä¼šè¯ï¼ŒéªŒè¯çŠ¶æ€æ­£ç¡®æ¸…ç†
   - åœ¨å·²æœ‰ä¼šè¯ä¸­å‘é€æ–°æ¶ˆæ¯ï¼ŒéªŒè¯æ­£å¸¸å“åº”

4. **é”™è¯¯å¤„ç†æµ‹è¯•**
   - æ–­ç½‘æµ‹è¯•ï¼ŒéªŒè¯é”™è¯¯æç¤º
   - æ— æ•ˆAPIå¯†é’¥æµ‹è¯•ï¼ŒéªŒè¯é”™è¯¯æç¤º

5. **æ»šåŠ¨è¡Œä¸ºæµ‹è¯•**
   - é•¿å¯¹è¯æ»šåŠ¨ï¼ŒéªŒè¯ä¸ä¼šè‡ªåŠ¨è·³å›

---

## 5. ç›¸å…³æ–‡æ¡£

- [FD-00028åŠŸèƒ½è®¾è®¡æ–‡æ¡£](../FD/FD-00028-AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§åŠŸèƒ½è®¾è®¡.md)
- [TDD-00028æŠ€æœ¯è®¾è®¡æ–‡æ¡£](../TDD/TDD-00028-AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§æŠ€æœ¯è®¾è®¡.md)
- [TE-00028æµ‹è¯•æ€»ç»“æŠ¥å‘Š](../TE/TE-00028-æµ‹è¯•æ€»ç»“æŠ¥å‘Š.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-01-04
**æœ€åæ›´æ–°**: 2026-01-04
