# BUG-00045: AIå†›å¸ˆæµå¼å¯¹è¯äºŒæ¬¡æµ‹è¯•é—®é¢˜åˆ†æ

**åˆ›å»ºæ—¥æœŸ**: 2026-01-05
**å…³è”ä»»åŠ¡**: FD-00028 AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§
**å…³è”BUG**: BUG-00044
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸¥é‡
**çŠ¶æ€**: âœ… å·²ä¿®å¤
**æµ‹è¯•æ–‡æ¡£**: TE-00028-äººå·¥å…¨é¢æµ‹è¯•AIå†›å¸ˆåŠŸèƒ½é—®é¢˜.md
**æœ€åæ›´æ–°**: 2026-01-05

---

## 1. é—®é¢˜æ¦‚è¿°

åœ¨BUG-00044ä¿®å¤åçš„äºŒæ¬¡äººå·¥æµ‹è¯•ä¸­ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ä»ç„¶å­˜åœ¨æˆ–å‡ºç°æ–°é—®é¢˜ï¼š

### é—®é¢˜æ¸…å•

| ç¼–å· | é—®é¢˜æè¿° | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ |
|------|----------|----------|------|
| P0-NEW-001 | AIæ­£å¼å›å¤å®Œæˆåå†…å®¹ç›´æ¥æ¶ˆå¤± | ğŸ”´ P0 | âœ… å·²ä¿®å¤ |
| P0-NEW-002 | é‡æ–°ç”Ÿæˆæ—¶ä¼šé‡æ–°å‘é€ç”¨æˆ·æ¶ˆæ¯ | ğŸ”´ P0 | âœ… å·²ä¿®å¤ |
| P0-NEW-003 | æ¯æ¬¡å¯¹è¯è‡ªåŠ¨å¼¹å‡º"..."å ä½æ¶ˆæ¯ | ğŸ”´ P0 | âœ… å·²ä¿®å¤ |
| P0-NEW-004 | æœªå®é™…æ¥å…¥AIæœåŠ¡ï¼Œè¿”å›é»˜è®¤é”™è¯¯ | ğŸ”´ P0 | å¾…éªŒè¯ |

---

## 2. ä¿®å¤è®°å½•

### 2.1 P0-NEW-001: AIæ­£å¼å›å¤å®Œæˆåå†…å®¹ç›´æ¥æ¶ˆå¤± âœ… å·²ä¿®å¤

**ä¿®å¤æ–¹æ¡ˆ**: 
1. ä¿®æ”¹ `AiAdvisorChatViewModel.kt` ä¸­çš„ `StreamingState.Completed` å¤„ç†é€»è¾‘
2. å®Œæˆåä¿æŒ `streamingContent` å’Œ `currentStreamingMessageId`ï¼Œå»¶è¿Ÿ800msåå†æ¸…ç©º
3. ä¿®æ”¹ `AiAdvisorChatScreen.kt` ä¸­çš„æµå¼æ¶ˆæ¯æ¸²æŸ“æ¡ä»¶ï¼Œæ”¯æŒå®Œæˆåç»§ç»­æ˜¾ç¤º

**ä¿®æ”¹æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

**å…³é”®ä»£ç å˜æ›´**:
```kotlin
// AiAdvisorChatViewModel.kt - StreamingState.Completedå¤„ç†
is StreamingState.Completed -> {
    _uiState.update {
        it.copy(
            isStreaming = false,
            streamingContent = state.fullText,  // ä¿æŒå†…å®¹
            thinkingContent = "",
            thinkingElapsedMs = 0,
            // ä¿æŒcurrentStreamingMessageId
            lastTokenUsage = state.usage
        )
    }
    
    // å»¶è¿Ÿæ¸…ç©º
    viewModelScope.launch {
        kotlinx.coroutines.delay(800)
        _uiState.update {
            it.copy(
                streamingContent = "",
                currentStreamingMessageId = null
            )
        }
    }
}
```

---

### 2.2 P0-NEW-002: é‡æ–°ç”Ÿæˆæ—¶ä¼šé‡æ–°å‘é€ç”¨æˆ·æ¶ˆæ¯ âœ… å·²ä¿®å¤

**ä¿®å¤æ–¹æ¡ˆ**:
1. ä¿®æ”¹ `regenerateLastMessage()` æ–¹æ³•ï¼Œä¸å†è°ƒç”¨ `sendMessage()`
2. æ–°å¢ `regenerateStreaming()` ç§æœ‰æ–¹æ³•ï¼Œä¸“é—¨ç”¨äºé‡æ–°ç”Ÿæˆåœºæ™¯
3. ä¿®æ”¹ `SendAdvisorMessageStreamingUseCase` æ·»åŠ  `skipUserMessage` å‚æ•°

**ä¿®æ”¹æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/usecase/SendAdvisorMessageStreamingUseCase.kt`

**å…³é”®ä»£ç å˜æ›´**:
```kotlin
// SendAdvisorMessageStreamingUseCase.kt
operator fun invoke(
    contactId: String,
    sessionId: String,
    userMessage: String,
    skipUserMessage: Boolean = false  // æ–°å¢å‚æ•°
): Flow<StreamingState> = flow {
    if (!skipUserMessage) {
        // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
        val userConversation = AiAdvisorConversation(...)
        aiAdvisorRepository.saveMessage(userConversation)
    }
    // åç»­é€»è¾‘ä¸å˜...
}
```

---

### 2.3 P0-NEW-003: æ¯æ¬¡å¯¹è¯è‡ªåŠ¨å¼¹å‡º"..."å ä½æ¶ˆæ¯ âœ… å·²ä¿®å¤

**ä¿®å¤æ–¹æ¡ˆ**:
1. ä¿®æ”¹ `ChatBubble` ç»„ä»¶ï¼Œä¸æ¸²æŸ“ç©ºå†…å®¹çš„PENDINGçŠ¶æ€AIæ¶ˆæ¯
2. ç§»é™¤ `conversation.content.ifEmpty { "..." }` é€»è¾‘

**ä¿®æ”¹æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

**å…³é”®ä»£ç å˜æ›´**:
```kotlin
// ChatBubbleç»„ä»¶
// ä¸æ¸²æŸ“ç©ºå†…å®¹çš„PENDINGçŠ¶æ€AIæ¶ˆæ¯
if (!isUser && conversation.content.isEmpty() && isPending) {
    return
}

// ç§»é™¤ç©ºå†…å®¹æ˜¾ç¤º"..."çš„é€»è¾‘
Text(
    text = conversation.content,  // ä¸å†ä½¿ç”¨ .ifEmpty { "..." }
    // ...
)
```

---

### 2.4 P0-NEW-004: æœªå®é™…æ¥å…¥AIæœåŠ¡ âš ï¸ å¾…éªŒè¯

**çŠ¶æ€**: éœ€è¦äººå·¥éªŒè¯

**è°ƒè¯•æ­¥éª¤**:
1. æ£€æŸ¥AIæœåŠ¡å•†é…ç½®æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ
3. ä½¿ç”¨ `scripts\ai-debug.bat` æŸ¥çœ‹AIè¯·æ±‚æ—¥å¿—
4. æ£€æŸ¥ç½‘ç»œè¿æ¥

---

## 3. ç¼–è¯‘éªŒè¯

âœ… ç¼–è¯‘é€šè¿‡ï¼Œæ— è¯­æ³•é”™è¯¯

```bash
.\gradlew :presentation:compileDebugKotlin :domain:compileKotlin --no-daemon -q
# Exit Code: 0
```

---

## 2. è¯¦ç»†é—®é¢˜åˆ†æ

### 2.1 P0-NEW-001: AIæ­£å¼å›å¤å®Œæˆåå†…å®¹ç›´æ¥æ¶ˆå¤±

**é—®é¢˜æè¿°**:
AIæµå¼å“åº”ç»“æŸåï¼Œå®Œæ•´çš„AIå›å¤å†…å®¹ç›´æ¥æ¶ˆå¤±ï¼Œç”¨æˆ·æ— æ³•çœ‹åˆ°AIçš„å›ç­”ã€‚

**å¤ç°æ­¥éª¤**:
1. è¿›å…¥AIå†›å¸ˆå¯¹è¯ç•Œé¢
2. å‘é€ä»»æ„é—®é¢˜
3. ç­‰å¾…AIæµå¼å›å¤å®Œæˆ
4. è§‚å¯ŸAIæ¶ˆæ¯æ˜¾ç¤º

**é¢„æœŸç»“æœ**: æ˜¾ç¤ºå®Œæ•´çš„AIå›å¤å†…å®¹ï¼Œæ¶ˆæ¯ä¿ç•™åœ¨å¯¹è¯åˆ—è¡¨ä¸­
**å®é™…ç»“æœ**: AIå›å¤å†…å®¹æ¶ˆå¤±ï¼Œå¯¹è¯åˆ—è¡¨ä¸­çœ‹ä¸åˆ°AIçš„å›ç­”

**æ ¹æœ¬åŸå› åˆ†æ**:

ç»è¿‡ä»£ç åˆ†æï¼Œé—®é¢˜å‡ºåœ¨ `AiAdvisorChatViewModel.kt` çš„ `StreamingState.Completed` å¤„ç†é€»è¾‘ï¼š

```kotlin
// å½“å‰ä»£ç  (ç¬¬220-235è¡Œ)
is StreamingState.Completed -> {
    _uiState.update {
        it.copy(
            isStreaming = false,
            streamingContent = "",      // âŒ é—®é¢˜1: æ¸…ç©ºäº†æµå¼å†…å®¹
            thinkingContent = "",
            thinkingElapsedMs = 0,
            currentStreamingMessageId = null,  // âŒ é—®é¢˜2: æ¸…ç©ºäº†æ¶ˆæ¯ID
            lastTokenUsage = state.usage
        )
    }
}
```

**é—®é¢˜æ ¹æº**:
1. `streamingContent` è¢«æ¸…ç©ºä¸º `""`
2. `currentStreamingMessageId` è¢«è®¾ä¸º `null`
3. æ­¤æ—¶UIçš„ `StreamingMessageBubbleSimple` ç»„ä»¶å› ä¸ºæ¡ä»¶ä¸æ»¡è¶³è€Œä¸æ¸²æŸ“
4. è™½ç„¶æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“ï¼Œä½† `conversations` åˆ—è¡¨çš„Flowæ›´æ–°å¯èƒ½æœ‰å»¶è¿Ÿ
5. å¯¼è‡´UIå‡ºç°"ç©ºç™½æœŸ"ï¼Œç”¨æˆ·çœ‹åˆ°æ¶ˆæ¯æ¶ˆå¤±

**ä¿®å¤æ–¹æ¡ˆ**:

æ–¹æ¡ˆAï¼ˆæ¨èï¼‰ï¼šå®Œæˆåä¿æŒå†…å®¹ç›´åˆ°conversationsæ›´æ–°
```kotlin
is StreamingState.Completed -> {
    // ä¸ç«‹å³æ¸…ç©ºstreamingContentï¼Œç­‰å¾…conversationsåˆ—è¡¨æ›´æ–°
    _uiState.update {
        it.copy(
            isStreaming = false,
            // ä¿æŒstreamingContentï¼Œè®©UIç»§ç»­æ˜¾ç¤º
            // streamingContent = "",  // ç§»é™¤è¿™è¡Œ
            thinkingContent = "",
            thinkingElapsedMs = 0,
            // ä¿æŒcurrentStreamingMessageIdï¼Œè®©UIçŸ¥é“æ˜¾ç¤ºå“ªæ¡æ¶ˆæ¯
            // currentStreamingMessageId = null,  // ç§»é™¤è¿™è¡Œ
            lastTokenUsage = state.usage
        )
    }
    
    // å»¶è¿Ÿæ¸…ç©ºï¼Œç­‰å¾…conversationsåˆ—è¡¨æ›´æ–°
    viewModelScope.launch {
        delay(500) // ç»™Flowæ›´æ–°ç•™å‡ºæ—¶é—´
        _uiState.update {
            it.copy(
                streamingContent = "",
                currentStreamingMessageId = null
            )
        }
    }
}
```

æ–¹æ¡ˆBï¼šä¿®æ”¹UIæ¸²æŸ“æ¡ä»¶
```kotlin
// AiAdvisorChatScreen.kt
// ä¿®æ”¹æµå¼æ¶ˆæ¯çš„æ¸²æŸ“æ¡ä»¶
if (uiState.isStreaming && uiState.currentStreamingMessageId != null) {
    // æµå¼è¿›è¡Œä¸­
    item(key = "streaming_message") { ... }
} else if (uiState.streamingContent.isNotEmpty() && uiState.currentStreamingMessageId != null) {
    // æµå¼å®Œæˆä½†å†…å®¹è¿˜æœªæ¸…ç©ºï¼Œç»§ç»­æ˜¾ç¤º
    item(key = "completed_streaming_message") { ... }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

---

### 2.2 P0-NEW-002: é‡æ–°ç”Ÿæˆæ—¶ä¼šé‡æ–°å‘é€ç”¨æˆ·æ¶ˆæ¯

**é—®é¢˜æè¿°**:
ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"æŒ‰é’®æ—¶ï¼Œä¸æ˜¯åŸåœ°åˆ·æ–°AIå›å¤ï¼Œè€Œæ˜¯åœ¨UIä¸­é‡æ–°å‘é€äº†ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼Œå¯¼è‡´æ¶ˆæ¯åˆ—è¡¨ä¸­å‡ºç°é‡å¤çš„ç”¨æˆ·æ¶ˆæ¯ã€‚

**å¤ç°æ­¥éª¤**:
1. å®Œæˆä¸€æ¬¡AIå¯¹è¯
2. ç‚¹å‡»æœ€åä¸€æ¡AIæ¶ˆæ¯ä¸‹æ–¹çš„"é‡æ–°ç”Ÿæˆ"æŒ‰é’®
3. è§‚å¯Ÿæ¶ˆæ¯åˆ—è¡¨

**é¢„æœŸç»“æœ**: åˆ é™¤å½“å‰AIå›å¤ï¼ŒåŸåœ°æ˜¾ç¤ºæ–°çš„æµå¼å“åº”ï¼Œç”¨æˆ·æ¶ˆæ¯ä¸å˜
**å®é™…ç»“æœ**: æ¶ˆæ¯åˆ—è¡¨ä¸­å‡ºç°é‡å¤çš„ç”¨æˆ·æ¶ˆæ¯

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `regenerateLastMessage()` å®ç°ï¼ˆç¬¬280-295è¡Œï¼‰ï¼š

```kotlin
fun regenerateLastMessage() {
    val conversations = _uiState.value.conversations
    val lastAiMessage = conversations.lastOrNull { it.messageType == MessageType.AI }
    val lastUserMessage = conversations.lastOrNull { it.messageType == MessageType.USER }

    if (lastAiMessage != null && lastUserMessage != null) {
        viewModelScope.launch {
            // åˆ é™¤æœ€åä¸€æ¡AIæ¶ˆæ¯
            deleteAdvisorConversationUseCase(lastAiMessage.id)
            // âŒ é—®é¢˜: é‡æ–°è®¾ç½®è¾“å…¥æ¡†å¹¶è°ƒç”¨sendMessage()
            _uiState.update { it.copy(inputText = lastUserMessage.content) }
            sendMessage()  // è¿™ä¼šåˆ›å»ºæ–°çš„ç”¨æˆ·æ¶ˆæ¯ï¼
        }
    }
}
```

**é—®é¢˜æ ¹æº**:
1. `sendMessage()` å†…éƒ¨ä¼šè°ƒç”¨ `sendMessageStreaming()`
2. `sendMessageStreaming()` ä¼šåˆ›å»ºæ–°çš„ç”¨æˆ·æ¶ˆæ¯å¹¶ä¿å­˜åˆ°æ•°æ®åº“
3. å¯¼è‡´æ¶ˆæ¯åˆ—è¡¨ä¸­å‡ºç°é‡å¤çš„ç”¨æˆ·æ¶ˆæ¯

**ä¿®å¤æ–¹æ¡ˆ**:

åˆ›å»ºä¸“é—¨çš„é‡æ–°ç”Ÿæˆæ–¹æ³•ï¼Œä¸åˆ›å»ºæ–°çš„ç”¨æˆ·æ¶ˆæ¯ï¼š

```kotlin
fun regenerateLastMessage() {
    val conversations = _uiState.value.conversations
    val lastAiMessage = conversations.lastOrNull { it.messageType == MessageType.AI }
    val lastUserMessage = conversations.lastOrNull { it.messageType == MessageType.USER }
    val sessionId = _uiState.value.currentSessionId ?: return

    if (lastAiMessage != null && lastUserMessage != null) {
        viewModelScope.launch {
            // 1. åˆ é™¤æœ€åä¸€æ¡AIæ¶ˆæ¯
            deleteAdvisorConversationUseCase(lastAiMessage.id)
            
            // 2. ç›´æ¥è°ƒç”¨æµå¼APIé‡æ–°ç”Ÿæˆï¼Œä¸åˆ›å»ºæ–°çš„ç”¨æˆ·æ¶ˆæ¯
            regenerateStreaming(lastUserMessage.content, sessionId)
        }
    }
}

/**
 * é‡æ–°ç”ŸæˆAIå›å¤ï¼ˆä¸åˆ›å»ºæ–°çš„ç”¨æˆ·æ¶ˆæ¯ï¼‰
 */
private fun regenerateStreaming(userMessage: String, sessionId: String) {
    streamingJob?.cancel()
    streamingJob = null

    _uiState.update {
        it.copy(
            isStreaming = true,
            isSending = false,
            error = null,
            streamingContent = "",
            thinkingContent = "",
            thinkingElapsedMs = 0,
            currentStreamingMessageId = null
        )
    }

    streamingJob = viewModelScope.launch {
        // ä½¿ç”¨ä¸“é—¨çš„é‡æ–°ç”ŸæˆUseCaseï¼Œæˆ–ä¿®æ”¹ç°æœ‰UseCaseæ”¯æŒè·³è¿‡ç”¨æˆ·æ¶ˆæ¯ä¿å­˜
        regenerateAdvisorMessageStreamingUseCase(contactId, sessionId, userMessage)
            .collect { state ->
                // å¤„ç†æµå¼çŠ¶æ€...
            }
    }
}
```

æˆ–è€…ä¿®æ”¹ `SendAdvisorMessageStreamingUseCase` æ·»åŠ å‚æ•°æ§åˆ¶æ˜¯å¦ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ï¼š

```kotlin
operator fun invoke(
    contactId: String,
    sessionId: String,
    userMessage: String,
    saveUserMessage: Boolean = true  // æ–°å¢å‚æ•°
): Flow<StreamingState> = flow {
    if (saveUserMessage) {
        // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
        val userConversation = AiAdvisorConversation(...)
        aiAdvisorRepository.saveMessage(userConversation)
    }
    // åç»­é€»è¾‘ä¸å˜...
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/usecase/SendAdvisorMessageStreamingUseCase.kt`

---

### 2.3 P0-NEW-003: æ¯æ¬¡å¯¹è¯è‡ªåŠ¨å¼¹å‡º"..."å ä½æ¶ˆæ¯

**é—®é¢˜æè¿°**:
æ¯æ¬¡å‘é€æ¶ˆæ¯æˆ–è¿›è¡Œå¯¹è¯æ—¶ï¼Œä¼šè‡ªåŠ¨å¼¹å‡ºä¸€ä¸ªåªæ˜¾ç¤º"..."çš„å ä½æ¶ˆæ¯ã€‚

**å¤ç°æ­¥éª¤**:
1. è¿›å…¥AIå†›å¸ˆå¯¹è¯ç•Œé¢
2. å‘é€ä»»æ„æ¶ˆæ¯
3. è§‚å¯Ÿå¯¹è¯åˆ—è¡¨

**é¢„æœŸç»“æœ**: åªæ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤
**å®é™…ç»“æœ**: å‡ºç°é¢å¤–çš„"..."å ä½æ¶ˆæ¯

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `StreamingMessageBubbleSimple` ç»„ä»¶çš„ `MainTextBubble`ï¼š

```kotlin
@Composable
private fun MainTextBubble(
    content: String,
    isStreaming: Boolean
) {
    Surface(...) {
        Box(...) {
            if (content.isEmpty() && isStreaming) {
                // ç­‰å¾…å†…å®¹æ—¶æ˜¾ç¤ºå ä½
                Row(verticalAlignment = Alignment.CenterVertically) {
                    Text(
                        text = "æ­£åœ¨ç”Ÿæˆ",  // è¿™é‡Œæ˜¾ç¤º"æ­£åœ¨ç”Ÿæˆ"è€Œä¸æ˜¯"..."
                        fontSize = 16.sp,
                        color = iOSTextPrimary.copy(alpha = 0.5f)
                    )
                    StreamingCursor()
                }
            } else {
                Row {
                    Text(text = content, ...)  // âŒ å½“contentä¸ºç©ºæ—¶æ˜¾ç¤ºç©ºæ–‡æœ¬
                    if (isStreaming) {
                        StreamingCursor()
                    }
                }
            }
        }
    }
}
```

æ£€æŸ¥ `ChatBubble` ç»„ä»¶ï¼š

```kotlin
Text(
    text = conversation.content.ifEmpty { "..." },  // âŒ è¿™é‡Œï¼ç©ºå†…å®¹æ˜¾ç¤º"..."
    modifier = Modifier.padding(horizontal = 14.dp, vertical = 10.dp),
    // ...
)
```

**é—®é¢˜æ ¹æº**:
1. å½“AIæ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®åº“æ—¶ï¼Œåˆå§‹å†…å®¹ä¸ºç©ºå­—ç¬¦ä¸²
2. `ChatBubble` ç»„ä»¶å¯¹ç©ºå†…å®¹æ˜¾ç¤º `"..."`
3. æµå¼å®Œæˆåï¼Œå¦‚æœå†…å®¹æ›´æ–°æœ‰å»¶è¿Ÿï¼Œä¼šçŸ­æš‚æ˜¾ç¤º `"..."`

**ä¿®å¤æ–¹æ¡ˆ**:

æ–¹æ¡ˆAï¼šä¿®æ”¹ChatBubbleï¼Œä¸æ˜¾ç¤ºç©ºå†…å®¹çš„æ¶ˆæ¯
```kotlin
// åœ¨æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨æ—¶è¿‡æ»¤æ‰ç©ºå†…å®¹çš„AIæ¶ˆæ¯
items(
    items = uiState.conversations.filter { 
        it.messageType == MessageType.USER || it.content.isNotEmpty() 
    },
    key = { it.id }
) { conversation ->
    ChatBubble(...)
}
```

æ–¹æ¡ˆBï¼šä¿®æ”¹ChatBubbleçš„ç©ºå†…å®¹å¤„ç†
```kotlin
// å¯¹äºAIæ¶ˆæ¯ï¼Œå¦‚æœå†…å®¹ä¸ºç©ºä¸”çŠ¶æ€ä¸ºPENDINGï¼Œä¸æ˜¾ç¤º
if (conversation.content.isEmpty() && 
    conversation.messageType == MessageType.AI && 
    conversation.sendStatus == SendStatus.PENDING) {
    // ä¸æ¸²æŸ“ï¼Œç­‰å¾…æµå¼ç»„ä»¶æ˜¾ç¤º
    return
}

Text(
    text = conversation.content,  // ç§»é™¤ .ifEmpty { "..." }
    // ...
)
```

æ–¹æ¡ˆCï¼šåœ¨UseCaseä¸­ä¸ä¿å­˜ç©ºå†…å®¹çš„AIæ¶ˆæ¯å ä½
```kotlin
// SendAdvisorMessageStreamingUseCase.kt
// ä¸åœ¨å¼€å§‹æ—¶åˆ›å»ºç©ºçš„AIæ¶ˆæ¯ï¼Œè€Œæ˜¯åœ¨æ”¶åˆ°ç¬¬ä¸€ä¸ªå†…å®¹åå†åˆ›å»º
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

---

### 2.4 P0-NEW-004: æœªå®é™…æ¥å…¥AIæœåŠ¡

**é—®é¢˜æè¿°**:
å‘é€æ¶ˆæ¯åï¼ŒAIå›å¤æ˜¯é»˜è®¤çš„"æ— æ³•ç†è§£ä½ çš„è¯·æ±‚"ï¼Œä¼¼ä¹æ²¡æœ‰å®é™…è°ƒç”¨AIæœåŠ¡ã€‚

**å¤ç°æ­¥éª¤**:
1. é…ç½®AIæœåŠ¡å•†ï¼ˆå¦‚DeepSeekï¼‰
2. è¿›å…¥AIå†›å¸ˆå¯¹è¯ç•Œé¢
3. å‘é€ä»»æ„é—®é¢˜
4. è§‚å¯ŸAIå›å¤

**é¢„æœŸç»“æœ**: æ”¶åˆ°AIæœåŠ¡çš„çœŸå®å›å¤
**å®é™…ç»“æœ**: æ”¶åˆ°é»˜è®¤é”™è¯¯æ¶ˆæ¯"æ— æ³•ç†è§£ä½ çš„è¯·æ±‚"

**å¯èƒ½åŸå› **:
1. AIæœåŠ¡å•†é…ç½®ä¸æ­£ç¡®
2. APIå¯†é’¥æ— æ•ˆæˆ–è¿‡æœŸ
3. ç½‘ç»œè¿æ¥é—®é¢˜
4. SSEæµå¼è¯·æ±‚å¤±è´¥
5. é”™è¯¯å¤„ç†ä¸­çš„é™çº§é€»è¾‘è¿”å›äº†é»˜è®¤æ¶ˆæ¯

**è°ƒè¯•æ­¥éª¤**:

1. æ£€æŸ¥AIæœåŠ¡å•†é…ç½®ï¼š
```bash
# ä½¿ç”¨AIè°ƒè¯•è„šæœ¬æŸ¥çœ‹è¯·æ±‚æ—¥å¿—
scripts\ai-debug.bat -h
```

2. æ£€æŸ¥logcatä¸­çš„SSEç›¸å…³æ—¥å¿—ï¼š
```bash
adb logcat | findstr "SseStreamReader\|AiRepository\|SendAdvisorMessage"
```

3. éªŒè¯APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ

4. æ£€æŸ¥ç½‘ç»œè¿æ¥

**ä¿®å¤æ–¹æ¡ˆ**:

å¾…ç¡®è®¤å…·ä½“åŸå› åæä¾›ä¿®å¤æ–¹æ¡ˆã€‚

**å½±å“æ–‡ä»¶**:
- å¾…ç¡®è®¤

---

## 3. ä¿®å¤ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | é—®é¢˜ç¼–å· | é¢„è®¡å·¥æ—¶ | ä¿®å¤éš¾åº¦ |
|--------|----------|----------|----------|
| P0 | P0-NEW-001 | 1h | ä¸­ |
| P0 | P0-NEW-002 | 1.5h | ä¸­ |
| P0 | P0-NEW-003 | 0.5h | ä½ |
| P0 | P0-NEW-004 | 2h | é«˜ï¼ˆéœ€è°ƒè¯•ï¼‰ |

**æ€»é¢„è®¡å·¥æ—¶**: 5å°æ—¶

---

## 4. ä¿®å¤é¡ºåºå»ºè®®

1. **P0-NEW-004** - å…ˆç¡®è®¤AIæœåŠ¡æ˜¯å¦æ­£å¸¸æ¥å…¥
2. **P0-NEW-001** - ä¿®å¤æ¶ˆæ¯æ¶ˆå¤±é—®é¢˜
3. **P0-NEW-002** - ä¿®å¤é‡æ–°ç”Ÿæˆé€»è¾‘
4. **P0-NEW-003** - ä¿®å¤å ä½æ¶ˆæ¯é—®é¢˜

---

## 5. æµ‹è¯•éªŒè¯æ¸…å•

ä¿®å¤å®Œæˆåï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

- [ ] å‘é€æ¶ˆæ¯ï¼ŒéªŒè¯AIå›å¤å®Œæ•´æ˜¾ç¤ºä¸”ä¸æ¶ˆå¤±
- [ ] ç‚¹å‡»é‡æ–°ç”Ÿæˆï¼ŒéªŒè¯ä¸ä¼šåˆ›å»ºé‡å¤çš„ç”¨æˆ·æ¶ˆæ¯
- [ ] éªŒè¯å¯¹è¯åˆ—è¡¨ä¸­ä¸ä¼šå‡ºç°"..."å ä½æ¶ˆæ¯
- [ ] éªŒè¯AIæœåŠ¡æ­£å¸¸æ¥å…¥ï¼Œè¿”å›çœŸå®å›å¤
- [ ] éªŒè¯æµå¼å“åº”è¿‡ç¨‹ä¸­çš„å…‰æ ‡åŠ¨ç”»
- [ ] éªŒè¯åœæ­¢ç”ŸæˆåŠŸèƒ½æ­£å¸¸
- [ ] éªŒè¯ä¼šè¯åˆ‡æ¢åŠŸèƒ½æ­£å¸¸
- [ ] éªŒè¯é”™è¯¯æç¤ºå‹å¥½

---

## 6. ç›¸å…³æ–‡æ¡£

- [BUG-00044-AIå†›å¸ˆæµå¼å¯¹è¯å¤šé—®é¢˜ç³»ç»Ÿæ€§åˆ†æ](./BUG-00044-AIå†›å¸ˆæµå¼å¯¹è¯å¤šé—®é¢˜ç³»ç»Ÿæ€§åˆ†æ.md)
- [TE-00028-äººå·¥å…¨é¢æµ‹è¯•AIå†›å¸ˆåŠŸèƒ½é—®é¢˜](../TE/TE-00028-äººå·¥å…¨é¢æµ‹è¯•AIå†›å¸ˆåŠŸèƒ½é—®é¢˜.md)
- [TE-00028-V2-AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§äººå·¥æµ‹è¯•æŒ‡å—](../TE/TE-00028-V2-AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§äººå·¥æµ‹è¯•æŒ‡å—.md)
- [FD-00028åŠŸèƒ½è®¾è®¡æ–‡æ¡£](../FD/FD-00028-AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§åŠŸèƒ½è®¾è®¡.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-01-05
**æœ€åæ›´æ–°**: 2026-01-05
