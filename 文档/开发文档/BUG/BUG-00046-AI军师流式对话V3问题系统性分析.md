# BUG-00046: AIå†›å¸ˆæµå¼å¯¹è¯V3é—®é¢˜ç³»ç»Ÿæ€§åˆ†æ

**åˆ›å»ºæ—¥æœŸ**: 2026-01-05
**å…³è”ä»»åŠ¡**: FD-00028 AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§
**å…³è”BUG**: BUG-00044, BUG-00045
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸¥é‡
**çŠ¶æ€**: âœ… å·²ä¿®å¤
**æµ‹è¯•æ–‡æ¡£**: TE-00028-V4-BUG-00045äººå·¥æµ‹è¯•æŒ‡å—.md, TE-00028-äººå·¥ç»“æœv2.md
**æœ€åæ›´æ–°**: 2026-01-05
**ä¿®å¤ç‰ˆæœ¬**: v1.0.0-BUG046

---

## 1. é—®é¢˜æ¦‚è¿°

åœ¨BUG-00044å’ŒBUG-00045ä¿®å¤åçš„ç¬¬ä¸‰æ¬¡äººå·¥æµ‹è¯•ä¸­ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ä»ç„¶å­˜åœ¨æˆ–å‡ºç°æ–°é—®é¢˜ã€‚æœ¬æ–‡æ¡£åŸºäºTE-00028æµ‹è¯•æ–‡æ¡£è¿›è¡Œç³»ç»Ÿæ€§åˆ†æã€‚

### é—®é¢˜æ¸…å•æ€»è§ˆ

| ç¼–å· | é—®é¢˜æè¿° | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ | å½±å“èŒƒå›´ |
|------|----------|----------|------|----------|
| P0-V3-001 | AIå›å¤å®Œæˆåå†…å®¹æ¶ˆå¤±ï¼ˆè·³è½¬åˆ°ç¬¬ä¸€ä¸ªä¼šè¯ï¼‰ | ğŸ”´ P0 | âœ… å·²ä¿®å¤ | æ ¸å¿ƒåŠŸèƒ½ |
| P0-V3-002 | é‡æ–°ç”Ÿæˆæ—¶å‡ºç°ä¸¤ä¸ªAIå¯¹è¯æ¡†ï¼ˆç¬¬ä¸€ä¸ªç©ºç™½ï¼‰ | ğŸ”´ P0 | âœ… å·²ä¿®å¤ | æ ¸å¿ƒåŠŸèƒ½ |
| P0-V3-003 | å‘é€æ¶ˆæ¯åè‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€ä¸ªä¼šè¯ | ğŸ”´ P0 | âœ… å·²ä¿®å¤ | ä¼šè¯ç®¡ç† |
| P1-V3-001 | æ»šåŠ¨æ—¶è‡ªåŠ¨è·³å›é¡¶éƒ¨ | ğŸŸ¡ P1 | âœ… å·²ä¿®å¤ | ç”¨æˆ·ä½“éªŒ |
| P1-V3-002 | åœæ­¢ç”Ÿæˆåæ˜¾ç¤º"..."å ä½æ¶ˆæ¯ | ğŸŸ¡ P1 | âœ… å·²ä¿®å¤ | ç”¨æˆ·ä½“éªŒ |
| P1-V3-003 | é‡æ–°ç”ŸæˆæŒ‰é’®ç‚¹å‡»æ— ååº” | ğŸŸ¡ P1 | âœ… å·²ä¿®å¤ | åŠŸèƒ½å¯ç”¨æ€§ |
| P2-V3-001 | è¾“å‡ºå†…å®¹æºå¸¦MDæ ¼å¼å­—ç¬¦æœªæ¸²æŸ“ | ğŸŸ¢ P2 | ğŸ”„ å¾…å¤„ç† | æ˜¾ç¤ºä¼˜åŒ– |

---

## 2. è¯¦ç»†é—®é¢˜åˆ†æ

### 2.1 P0-V3-001: AIå›å¤å®Œæˆåå†…å®¹æ¶ˆå¤±ï¼ˆè·³è½¬åˆ°ç¬¬ä¸€ä¸ªä¼šè¯ï¼‰

**é—®é¢˜æè¿°**:
æ ¹æ®TE-00028-äººå·¥ç»“æœv2.mdçš„æè¿°ï¼š
> "å½“æˆ‘ä»¬çš„AIçš„æ¢å¤æ¢å¤å®Œäº†ä¹‹åï¼Œæˆ‘ä»¬å°±ä¼šç›´æ¥çš„è·³è½¬åˆ°æˆ‘ä»¬ä¹‹å‰çš„ä¸€ä¸ªç¬¬ä¸€ä¸ªç¬¬ä¸€ä¸ªå¯¹è¯å½“ä¸­ï¼Œç„¶åä¼šå»æ‰¾é‚£ä¸ªå¯¹è¯AIçš„æ¢å¤å·²ç»æ¶ˆå¤±äº†"

**å¤ç°æ­¥éª¤**:
1. åˆ›å»ºå¤šä¸ªä¼šè¯ï¼ˆä¼šè¯Aã€ä¼šè¯Bï¼‰
2. åœ¨ä¼šè¯Bä¸­å‘é€æ¶ˆæ¯
3. ç­‰å¾…AIæµå¼å›å¤å®Œæˆ
4. è§‚å¯ŸUIè¡Œä¸º

**é¢„æœŸç»“æœ**: 
- åœç•™åœ¨ä¼šè¯B
- AIå›å¤å†…å®¹å®Œæ•´æ˜¾ç¤ºåœ¨ä¼šè¯Bä¸­

**å®é™…ç»“æœ**: 
- è‡ªåŠ¨è·³è½¬åˆ°ä¼šè¯Aï¼ˆç¬¬ä¸€ä¸ªä¼šè¯ï¼‰
- AIå›å¤å†…å®¹æ¶ˆå¤±
- ä¼šè¯Bä¸­ç•™ä¸‹ä¸€ä¸ªç©ºç™½çš„æ¶ˆæ¯æ¡†

**æ ¹æœ¬åŸå› åˆ†æ**:

ç»è¿‡ä»£ç åˆ†æï¼Œé—®é¢˜å‡ºåœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. **ä¼šè¯IDçŠ¶æ€ç®¡ç†é—®é¢˜** (`AiAdvisorChatViewModel.kt`):
```kotlin
// ç¬¬243-266è¡Œ StreamingState.Completedå¤„ç†
is StreamingState.Completed -> {
    _uiState.update {
        it.copy(
            isStreaming = false,
            streamingContent = state.fullText,
            thinkingContent = "",
            thinkingElapsedMs = 0,
            lastTokenUsage = state.usage
        )
    }
    
    // å»¶è¿Ÿ800msåæ¸…ç©º
    viewModelScope.launch {
        kotlinx.coroutines.delay(800)
        _uiState.update {
            it.copy(
                streamingContent = "",
                currentStreamingMessageId = null
            )
        }
    }
}
```

2. **conversations Flowæ”¶é›†é—®é¢˜** (`loadConversations`æ–¹æ³•):
```kotlin
private fun loadConversations(sessionId: String) {
    viewModelScope.launch {
        getAdvisorConversationsUseCase(sessionId).collect { conversations ->
            _uiState.update { it.copy(conversations = conversations) }
        }
    }
}
```

**é—®é¢˜æ ¹æº**:
- å½“æµå¼å®Œæˆåï¼Œ`conversations` Flowå¯èƒ½è§¦å‘äº†é‡æ–°æ”¶é›†
- å¦‚æœæ­¤æ—¶æœ‰å¤šä¸ªFlowåœ¨æ”¶é›†ä¸åŒä¼šè¯çš„æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´çŠ¶æ€æ··ä¹±
- å»¶è¿Ÿæ¸…ç©º`streamingContent`çš„800msçª—å£æœŸå†…ï¼Œå¦‚æœ`conversations`æ›´æ–°ï¼Œå¯èƒ½å¯¼è‡´UIè·³è½¬

**ä¿®å¤æ–¹æ¡ˆ**:

```kotlin
// æ–¹æ¡ˆ1: åœ¨æµå¼å®Œæˆæ—¶é”å®šå½“å‰ä¼šè¯ID
is StreamingState.Completed -> {
    val currentSessionId = _uiState.value.currentSessionId
    
    _uiState.update {
        it.copy(
            isStreaming = false,
            streamingContent = state.fullText,
            thinkingContent = "",
            thinkingElapsedMs = 0,
            lastTokenUsage = state.usage
        )
    }
    
    viewModelScope.launch {
        kotlinx.coroutines.delay(800)
        // åªæœ‰å½“ä¼šè¯IDæœªå˜åŒ–æ—¶æ‰æ¸…ç©º
        if (_uiState.value.currentSessionId == currentSessionId) {
            _uiState.update {
                it.copy(
                    streamingContent = "",
                    currentStreamingMessageId = null
                )
            }
        }
    }
}

// æ–¹æ¡ˆ2: ä½¿ç”¨å•ä¸€Flowæ”¶é›†å™¨ï¼Œé¿å…å¤šä¸ªæ”¶é›†å™¨å†²çª
private var conversationsJob: Job? = null

private fun loadConversations(sessionId: String) {
    conversationsJob?.cancel()
    conversationsJob = viewModelScope.launch {
        getAdvisorConversationsUseCase(sessionId).collect { conversations ->
            // éªŒè¯sessionIdåŒ¹é…
            if (_uiState.value.currentSessionId == sessionId) {
                _uiState.update { it.copy(conversations = conversations) }
            }
        }
    }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

### 2.2 P0-V3-002: é‡æ–°ç”Ÿæˆæ—¶å‡ºç°ä¸¤ä¸ªAIå¯¹è¯æ¡†

**é—®é¢˜æè¿°**:
æ ¹æ®TE-00028-äººå·¥ç»“æœv2.mdçš„æè¿°ï¼š
> "æˆ‘ä»¬åœ¨é‡æ–°ç”Ÿæˆçš„æ—¶å€™ä¼šæœ‰ä¸¤ä¸ªAIçš„å¯¹è¯æ¡†ã€‚ç¬¬ä¸€ä¸ªå¯¹è¯æ¡†ç°åœ¨æ˜¯æ²¡æœ‰è¯†åˆ«å¥½çš„ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸ªæ¡†åœ¨é‚£å„¿"

**å¤ç°æ­¥éª¤**:
1. å®Œæˆä¸€æ¬¡AIå¯¹è¯
2. ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"æŒ‰é’®
3. è§‚å¯Ÿæ¶ˆæ¯åˆ—è¡¨

**é¢„æœŸç»“æœ**: 
- åˆ é™¤åŸAIå›å¤
- æ˜¾ç¤ºæ–°çš„æµå¼å“åº”
- åªæœ‰ä¸€ä¸ªAIæ¶ˆæ¯æ¡†

**å®é™…ç»“æœ**: 
- å‡ºç°ä¸¤ä¸ªAIæ¶ˆæ¯æ¡†
- ç¬¬ä¸€ä¸ªæ¡†æ˜¯ç©ºç™½çš„
- ç¬¬äºŒä¸ªæ¡†æ˜¾ç¤ºæ–°çš„æµå¼å†…å®¹

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `regenerateLastMessage()` å’Œ `regenerateStreaming()` æ–¹æ³•ï¼š

```kotlin
// ç¬¬330-360è¡Œ
fun regenerateLastMessage() {
    val conversations = _uiState.value.conversations
    val lastAiMessage = conversations.lastOrNull { it.messageType == MessageType.AI }
    val lastUserMessage = conversations.lastOrNull { it.messageType == MessageType.USER }
    val sessionId = _uiState.value.currentSessionId ?: return

    if (lastAiMessage != null && lastUserMessage != null) {
        viewModelScope.launch {
            // åˆ é™¤æœ€åä¸€æ¡AIæ¶ˆæ¯
            deleteAdvisorConversationUseCase(lastAiMessage.id)
            // ç›´æ¥è°ƒç”¨æµå¼é‡æ–°ç”Ÿæˆ
            regenerateStreaming(lastUserMessage.content, sessionId)
        }
    }
}
```

**é—®é¢˜æ ¹æº**:
1. `deleteAdvisorConversationUseCase` æ˜¯å¼‚æ­¥æ“ä½œ
2. åœ¨åˆ é™¤å®Œæˆå‰ï¼Œ`regenerateStreaming` å¯èƒ½å·²ç»å¼€å§‹
3. `SendAdvisorMessageStreamingUseCase` å¯èƒ½åˆ›å»ºäº†æ–°çš„AIæ¶ˆæ¯å ä½
4. å¯¼è‡´æ—§æ¶ˆæ¯å’Œæ–°æ¶ˆæ¯åŒæ—¶å­˜åœ¨

**ä¿®å¤æ–¹æ¡ˆ**:

```kotlin
fun regenerateLastMessage() {
    val conversations = _uiState.value.conversations
    val lastAiMessage = conversations.lastOrNull { it.messageType == MessageType.AI }
    val lastUserMessage = conversations.lastOrNull { it.messageType == MessageType.USER }
    val sessionId = _uiState.value.currentSessionId ?: return

    if (lastAiMessage != null && lastUserMessage != null) {
        viewModelScope.launch {
            // 1. å…ˆåˆ é™¤æœ€åä¸€æ¡AIæ¶ˆæ¯å¹¶ç­‰å¾…å®Œæˆ
            val deleteResult = deleteAdvisorConversationUseCase(lastAiMessage.id)
            
            // 2. ç¡®ä¿åˆ é™¤æˆåŠŸåå†é‡æ–°ç”Ÿæˆ
            if (deleteResult.isSuccess) {
                // ç»™æ•°æ®åº“å’ŒFlowä¸€ç‚¹æ—¶é—´æ›´æ–°
                kotlinx.coroutines.delay(100)
                regenerateStreaming(lastUserMessage.content, sessionId)
            } else {
                _uiState.update { it.copy(error = "åˆ é™¤æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•") }
            }
        }
    }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

### 2.3 P0-V3-003: å‘é€æ¶ˆæ¯åè‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€ä¸ªä¼šè¯

**é—®é¢˜æè¿°**:
æ ¹æ®TE-00028-äººå·¥ç»“æœv2.mdçš„æè¿°ï¼š
> "å¦‚æœè¯´æˆ‘ä»¬å‘é€äº†ä¿¡æ¯ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨çš„è°ƒå›æˆ‘ä»¬ç¬¬ä¸€ä¸ªè§„åˆ’é‡Œé¢çš„ï¼Œå¹¶ä¸”ä¼šä¿ç•™ä¸€ä¸ªç™½è‰²çš„æ¡†åœ¨å“ªé‡Œ"

**å¤ç°æ­¥éª¤**:
1. åˆ›å»ºå¤šä¸ªä¼šè¯
2. åˆ‡æ¢åˆ°éç¬¬ä¸€ä¸ªä¼šè¯
3. å‘é€æ¶ˆæ¯
4. è§‚å¯ŸUIè¡Œä¸º

**é¢„æœŸç»“æœ**: åœç•™åœ¨å½“å‰ä¼šè¯
**å®é™…ç»“æœ**: è‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€ä¸ªä¼šè¯

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `loadSessions()` æ–¹æ³•ï¼š

```kotlin
private suspend fun loadSessions(contactId: String) {
    getAdvisorSessionsUseCase(contactId).onSuccess { sessions ->
        if (sessions.isEmpty()) {
            createNewSession(contactId)
        } else {
            val activeSession = sessions.first()  // âŒ é—®é¢˜ï¼šæ€»æ˜¯é€‰æ‹©ç¬¬ä¸€ä¸ªä¼šè¯
            _uiState.update {
                it.copy(
                    sessions = sessions,
                    currentSessionId = activeSession.id,  // è¦†ç›–äº†å½“å‰ä¼šè¯ID
                    isLoading = false
                )
            }
            loadConversations(activeSession.id)
        }
    }
}
```

**é—®é¢˜æ ¹æº**:
- `loadSessions` è¢«è°ƒç”¨æ—¶ï¼Œæ€»æ˜¯å°† `currentSessionId` è®¾ç½®ä¸ºç¬¬ä¸€ä¸ªä¼šè¯
- å¦‚æœåœ¨æµå¼å“åº”è¿‡ç¨‹ä¸­è§¦å‘äº† `loadSessions`ï¼Œä¼šå¯¼è‡´ä¼šè¯è·³è½¬

**ä¿®å¤æ–¹æ¡ˆ**:

```kotlin
private suspend fun loadSessions(contactId: String, preserveCurrentSession: Boolean = false) {
    getAdvisorSessionsUseCase(contactId).onSuccess { sessions ->
        if (sessions.isEmpty()) {
            createNewSession(contactId)
        } else {
            val currentSessionId = _uiState.value.currentSessionId
            val activeSession = if (preserveCurrentSession && currentSessionId != null) {
                // ä¿æŒå½“å‰ä¼šè¯ï¼Œå¦‚æœå­˜åœ¨çš„è¯
                sessions.find { it.id == currentSessionId } ?: sessions.first()
            } else {
                sessions.first()
            }
            
            _uiState.update {
                it.copy(
                    sessions = sessions,
                    currentSessionId = activeSession.id,
                    isLoading = false
                )
            }
            loadConversations(activeSession.id)
        }
    }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

### 2.4 P1-V3-001: æ»šåŠ¨æ—¶è‡ªåŠ¨è·³å›é¡¶éƒ¨

**é—®é¢˜æè¿°**:
æ ¹æ®TE-00028-äººå·¥ç»“æœ.mdçš„æè¿°ï¼š
> "å½“æˆ‘ä»¬çš„AIè¾“å‡ºå†…å®¹æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œä½ é€šè¿‡æ»šè½®å¾€ä¸‹æ‹‰çš„æ—¶å€™ï¼Œå®ƒä¼šè‡ªåŠ¨è·³åˆ°æœ€ä¸Šé¢"

**å¤ç°æ­¥éª¤**:
1. è¿›è¡Œå¤šè½®å¯¹è¯ï¼Œäº§ç”Ÿè¾ƒé•¿çš„å¯¹è¯å†å²
2. å‘ä¸Šæ»šåŠ¨æŸ¥çœ‹å†å²æ¶ˆæ¯
3. è§‚å¯Ÿæ»šåŠ¨è¡Œä¸º

**é¢„æœŸç»“æœ**: ä¿æŒç”¨æˆ·æ»šåŠ¨ä½ç½®
**å®é™…ç»“æœ**: è‡ªåŠ¨è·³å›é¡¶éƒ¨

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `AiAdvisorChatScreen.kt` ä¸­çš„æ»šåŠ¨é€»è¾‘ï¼ˆç¬¬157-175è¡Œï¼‰ï¼š

```kotlin
LaunchedEffect(uiState.conversations.size, uiState.streamingContent) {
    if (uiState.conversations.isNotEmpty() || uiState.isStreaming) {
        val lastVisibleIndex = listState.layoutInfo.visibleItemsInfo.lastOrNull()?.index ?: 0
        val totalItems = uiState.conversations.size + (if (uiState.isStreaming) 1 else 0)
        val isNearBottom = lastVisibleIndex >= totalItems - 2

        if (isNearBottom) {
            val targetIndex = if (uiState.isStreaming) {
                uiState.conversations.size
            } else {
                uiState.conversations.size - 1
            }
            if (targetIndex >= 0) {
                listState.animateScrollToItem(targetIndex.coerceAtLeast(0))
            }
        }
    }
}
```

**é—®é¢˜æ ¹æº**:
- `LaunchedEffect` ä¾èµ– `uiState.streamingContent` å˜åŒ–
- æµå¼å“åº”æ—¶ï¼Œ`streamingContent` é¢‘ç¹æ›´æ–°
- æ¯æ¬¡æ›´æ–°éƒ½ä¼šè§¦å‘æ»šåŠ¨é€»è¾‘
- `isNearBottom` åˆ¤æ–­å¯èƒ½ä¸å‡†ç¡®

**ä¿®å¤æ–¹æ¡ˆ**:

```kotlin
// ä½¿ç”¨æ›´ç²¾ç¡®çš„åº•éƒ¨æ£€æµ‹
LaunchedEffect(uiState.conversations.size) {
    // åªåœ¨æ¶ˆæ¯æ•°é‡å˜åŒ–æ—¶è§¦å‘ï¼Œä¸ä¾èµ–streamingContent
    if (uiState.conversations.isNotEmpty()) {
        val lastVisibleIndex = listState.layoutInfo.visibleItemsInfo.lastOrNull()?.index ?: 0
        val totalItems = uiState.conversations.size
        
        // æ›´ä¸¥æ ¼çš„åº•éƒ¨åˆ¤æ–­ï¼šå¿…é¡»åœ¨æœ€å2æ¡æ¶ˆæ¯èŒƒå›´å†…
        val isAtBottom = lastVisibleIndex >= totalItems - 2
        
        if (isAtBottom) {
            listState.animateScrollToItem((totalItems - 1).coerceAtLeast(0))
        }
    }
}

// æµå¼å†…å®¹æ›´æ–°æ—¶çš„æ»šåŠ¨é€»è¾‘å•ç‹¬å¤„ç†
LaunchedEffect(uiState.isStreaming) {
    if (uiState.isStreaming) {
        // æµå¼å¼€å§‹æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
        val targetIndex = uiState.conversations.size
        listState.animateScrollToItem(targetIndex.coerceAtLeast(0))
    }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

---

### 2.5 P1-V3-002: åœæ­¢ç”Ÿæˆåæ˜¾ç¤º"..."å ä½æ¶ˆæ¯

**é—®é¢˜æè¿°**:
æ ¹æ®TE-00028-äººå·¥ç»“æœ.mdçš„æè¿°ï¼š
> "å½“æˆ‘ä»¬ç»ˆæ­¢äº†AIçš„ç»´åº¦è¿‡åï¼Œå¥½åƒåˆå›ºå®šåˆ·æ–°äº†ä¸€æ¡ä¿¡æ¯ï¼Œç„¶åæ˜¯ä¸‰ä¸ªçœç•¥å·"

**å¤ç°æ­¥éª¤**:
1. å‘é€æ¶ˆæ¯ï¼Œå¼€å§‹AIæµå¼å“åº”
2. åœ¨å“åº”è¿‡ç¨‹ä¸­ç‚¹å‡»"åœæ­¢"æŒ‰é’®
3. è§‚å¯Ÿæ¶ˆæ¯åˆ—è¡¨

**é¢„æœŸç»“æœ**: 
- æ˜¾ç¤ºå·²ç”Ÿæˆçš„å†…å®¹ + "[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
- æˆ–è€…å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œåˆ é™¤è¯¥æ¶ˆæ¯

**å®é™…ç»“æœ**: æ˜¾ç¤º"..."å ä½æ¶ˆæ¯

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `stopGeneration()` æ–¹æ³•ï¼ˆç¬¬295-325è¡Œï¼‰ï¼š

```kotlin
fun stopGeneration() {
    streamingJob?.cancel()
    streamingJob = null

    val messageId = _uiState.value.currentStreamingMessageId
    val currentContent = _uiState.value.streamingContent

    _uiState.update {
        it.copy(
            isStreaming = false,
            streamingContent = "",
            thinkingContent = "",
            thinkingElapsedMs = 0,
            currentStreamingMessageId = null
        )
    }

    messageId?.let { id ->
        viewModelScope.launch {
            if (currentContent.isNotEmpty()) {
                aiAdvisorRepository.updateMessageContentAndStatus(
                    id,
                    currentContent + "\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]",
                    SendStatus.CANCELLED
                )
            } else {
                aiAdvisorRepository.deleteMessage(id)
            }
        }
    }
}
```

**é—®é¢˜æ ¹æº**:
- `aiAdvisorRepository.deleteMessage(id)` å¯èƒ½æ‰§è¡Œå¤±è´¥
- æˆ–è€…æ¶ˆæ¯åˆ é™¤åï¼ŒFlowæ›´æ–°æœ‰å»¶è¿Ÿ
- å¯¼è‡´UIä»ç„¶æ˜¾ç¤ºç©ºå†…å®¹çš„æ¶ˆæ¯ï¼ˆæ¸²æŸ“ä¸º"..."ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:

```kotlin
fun stopGeneration() {
    streamingJob?.cancel()
    streamingJob = null

    val messageId = _uiState.value.currentStreamingMessageId
    val currentContent = _uiState.value.streamingContent

    _uiState.update {
        it.copy(
            isStreaming = false,
            streamingContent = "",
            thinkingContent = "",
            thinkingElapsedMs = 0,
            currentStreamingMessageId = null
        )
    }

    messageId?.let { id ->
        viewModelScope.launch {
            try {
                if (currentContent.isNotEmpty()) {
                    val result = aiAdvisorRepository.updateMessageContentAndStatus(
                        id,
                        currentContent + "\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]",
                        SendStatus.CANCELLED
                    )
                    if (result.isFailure) {
                        // æ›´æ–°å¤±è´¥ï¼Œå°è¯•åˆ é™¤
                        aiAdvisorRepository.deleteMessage(id)
                    }
                } else {
                    // æ²¡æœ‰å†…å®¹ï¼Œåˆ é™¤æ¶ˆæ¯
                    val deleteResult = aiAdvisorRepository.deleteMessage(id)
                    if (deleteResult.isFailure) {
                        _uiState.update { it.copy(error = "æ¸…ç†æ¶ˆæ¯å¤±è´¥") }
                    }
                }
            } catch (e: Exception) {
                _uiState.update { it.copy(error = "æ“ä½œå¤±è´¥: ${e.message}") }
            }
        }
    }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

### 2.6 P1-V3-003: é‡æ–°ç”ŸæˆæŒ‰é’®ç‚¹å‡»æ— ååº”

**é—®é¢˜æè¿°**:
æ ¹æ®TE-00028-äººå·¥ç»“æœ.mdçš„æè¿°ï¼š
> "é‡è¯•åŠŸèƒ½æŒ‰ä¸‹äº†ä¼šæ²¡æœ‰ååº”"

**å¤ç°æ­¥éª¤**:
1. å®Œæˆä¸€æ¬¡AIå¯¹è¯
2. ç‚¹å‡»AIæ¶ˆæ¯ä¸‹æ–¹çš„"é‡æ–°ç”Ÿæˆ"æŒ‰é’®
3. è§‚å¯Ÿå“åº”

**é¢„æœŸç»“æœ**: åˆ é™¤å½“å‰AIå›å¤ï¼Œé‡æ–°å‘é€è¯·æ±‚
**å®é™…ç»“æœ**: æ— ä»»ä½•ååº”

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥ `ChatBubble` ç»„ä»¶ä¸­çš„é‡æ–°ç”ŸæˆæŒ‰é’®ï¼š

```kotlin
// AIæ¶ˆæ¯çš„é‡æ–°ç”ŸæˆæŒ‰é’®ï¼ˆä»…æœ€åä¸€æ¡AIæ¶ˆæ¯æ˜¾ç¤ºï¼‰
if (!isUser && !isFailed && !isCancelled && isLastAiMessage) {
    Row(
        modifier = Modifier
            .padding(top = 4.dp)
            .clickable(onClick = onRegenerate),  // å›è°ƒæ˜¯å¦æ­£ç¡®ä¼ é€’ï¼Ÿ
        verticalAlignment = Alignment.CenterVertically
    ) {
        Icon(...)
        Text("é‡æ–°ç”Ÿæˆ", ...)
    }
}
```

æ£€æŸ¥è°ƒç”¨å¤„ï¼š

```kotlin
ChatBubble(
    conversation = conversation,
    onRetry = { viewModel.retryMessage(conversation) },
    onDelete = { viewModel.deleteMessage(conversation.id) },
    onRegenerate = { viewModel.regenerateLastMessage() },  // âœ… å›è°ƒæ­£ç¡®ä¼ é€’
    isLastAiMessage = conversation == uiState.conversations.lastOrNull { it.messageType == MessageType.AI }
)
```

**é—®é¢˜æ ¹æº**:
- `isLastAiMessage` åˆ¤æ–­å¯èƒ½ä¸å‡†ç¡®
- æˆ–è€… `regenerateLastMessage()` å†…éƒ¨æ¡ä»¶ä¸æ»¡è¶³

**ä¿®å¤æ–¹æ¡ˆ**:

æ·»åŠ æ—¥å¿—éªŒè¯ï¼š

```kotlin
fun regenerateLastMessage() {
    Log.d(TAG, "regenerateLastMessage called")
    val conversations = _uiState.value.conversations
    Log.d(TAG, "conversations size: ${conversations.size}")
    
    val lastAiMessage = conversations.lastOrNull { it.messageType == MessageType.AI }
    val lastUserMessage = conversations.lastOrNull { it.messageType == MessageType.USER }
    val sessionId = _uiState.value.currentSessionId
    
    Log.d(TAG, "lastAiMessage: $lastAiMessage")
    Log.d(TAG, "lastUserMessage: $lastUserMessage")
    Log.d(TAG, "sessionId: $sessionId")

    if (lastAiMessage == null) {
        Log.w(TAG, "No AI message found")
        return
    }
    if (lastUserMessage == null) {
        Log.w(TAG, "No user message found")
        return
    }
    if (sessionId == null) {
        Log.w(TAG, "No session ID")
        return
    }

    viewModelScope.launch {
        Log.d(TAG, "Deleting AI message: ${lastAiMessage.id}")
        deleteAdvisorConversationUseCase(lastAiMessage.id)
        Log.d(TAG, "Starting regenerate")
        regenerateStreaming(lastUserMessage.content, sessionId)
    }
}
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

### 2.7 P2-V3-001: è¾“å‡ºå†…å®¹æºå¸¦MDæ ¼å¼å­—ç¬¦æœªæ¸²æŸ“

**é—®é¢˜æè¿°**:
æ ¹æ®TE-00028-äººå·¥ç»“æœ.mdçš„æè¿°ï¼š
> "è¾“å‡ºå†…å®¹çš„æ ¼å¼é—®é¢˜,ä¼šæºå¸¦å¤§é‡çš„mdçš„æ ¼å¼ï¼Œå®ƒä¸ä¼šæ¸²æŸ“å‡ºæ¥ï¼Œå®ƒä¼šæŠŠé‚£äº›æ ¼å¼å­—ç¬¦ä¹Ÿè¡¨ç°å‡ºæ¥"

**å¤ç°æ­¥éª¤**:
1. å‘é€éœ€è¦æ ¼å¼åŒ–å›å¤çš„é—®é¢˜
2. è§‚å¯ŸAIå›å¤å†…å®¹

**é¢„æœŸç»“æœ**: Markdownæ ¼å¼æ­£ç¡®æ¸²æŸ“ï¼ˆç²—ä½“ã€æ ‡é¢˜ç­‰ï¼‰
**å®é™…ç»“æœ**: æ˜¾ç¤ºåŸå§‹Markdownå­—ç¬¦

**ä¿®å¤æ–¹æ¡ˆ**:

è€ƒè™‘é›†æˆMarkdownæ¸²æŸ“åº“æˆ–ç®€å•å¤„ç†å¸¸è§æ ¼å¼ã€‚æ­¤é—®é¢˜ä¼˜å…ˆçº§è¾ƒä½ï¼Œå¯åç»­å¤„ç†ã€‚

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/component/StreamingMessageBubble.kt`

---

## 3. ä¿®å¤ä¼˜å…ˆçº§å’Œå·¥æ—¶ä¼°ç®—

| ä¼˜å…ˆçº§ | é—®é¢˜ç¼–å· | é¢„è®¡å·¥æ—¶ | ä¿®å¤éš¾åº¦ | ä¾èµ–å…³ç³» |
|--------|----------|----------|----------|----------|
| P0 | P0-V3-001 | 2h | é«˜ | æ—  |
| P0 | P0-V3-002 | 1h | ä¸­ | P0-V3-001 |
| P0 | P0-V3-003 | 1h | ä¸­ | P0-V3-001 |
| P1 | P1-V3-001 | 1h | ä¸­ | æ—  |
| P1 | P1-V3-002 | 0.5h | ä½ | æ—  |
| P1 | P1-V3-003 | 0.5h | ä½ | æ—  |
| P2 | P2-V3-001 | 2h | ä¸­ | æ—  |

**æ€»é¢„è®¡å·¥æ—¶**: 8å°æ—¶

---

## 4. ä¿®å¤é¡ºåºå»ºè®®

1. **P0-V3-001** - ä¼šè¯çŠ¶æ€ç®¡ç†é—®é¢˜ï¼ˆæ ¹æœ¬åŸå› ï¼‰
2. **P0-V3-003** - å‘é€æ¶ˆæ¯åè·³è½¬é—®é¢˜ï¼ˆä¸P0-V3-001ç›¸å…³ï¼‰
3. **P0-V3-002** - é‡æ–°ç”ŸæˆåŒæ¡†é—®é¢˜
4. **P1-V3-001** - æ»šåŠ¨é—®é¢˜
5. **P1-V3-002** - åœæ­¢ç”Ÿæˆå ä½æ¶ˆæ¯
6. **P1-V3-003** - é‡æ–°ç”ŸæˆæŒ‰é’®æ— ååº”
7. **P2-V3-001** - Markdownæ¸²æŸ“ï¼ˆå¯é€‰ï¼‰

---

## 5. æµ‹è¯•éªŒè¯æ¸…å•

ä¿®å¤å®Œæˆåï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### P0çº§æµ‹è¯•
- [ ] æµ‹è¯•1: AIå›å¤å®Œæˆåå†…å®¹ä¿æŒæ˜¾ç¤ºï¼Œä¸æ¶ˆå¤±
- [ ] æµ‹è¯•2: å¤šä¼šè¯åœºæ™¯ä¸‹ï¼Œå‘é€æ¶ˆæ¯ååœç•™åœ¨å½“å‰ä¼šè¯
- [ ] æµ‹è¯•3: é‡æ–°ç”Ÿæˆæ—¶åªæœ‰ä¸€ä¸ªAIæ¶ˆæ¯æ¡†
- [ ] æµ‹è¯•4: é‡æ–°ç”Ÿæˆä¸åˆ›å»ºé‡å¤çš„ç”¨æˆ·æ¶ˆæ¯

### P1çº§æµ‹è¯•
- [ ] æµ‹è¯•5: æ»šåŠ¨æŸ¥çœ‹å†å²æ—¶ä¸è‡ªåŠ¨è·³å›
- [ ] æµ‹è¯•6: åœæ­¢ç”Ÿæˆåæ˜¾ç¤ºå·²ç”Ÿæˆå†…å®¹æˆ–åˆ é™¤ç©ºæ¶ˆæ¯
- [ ] æµ‹è¯•7: é‡æ–°ç”ŸæˆæŒ‰é’®ç‚¹å‡»æœ‰å“åº”

### å›å½’æµ‹è¯•
- [ ] æµ‹è¯•8: æµå¼å“åº”è¿‡ç¨‹ä¸­å…‰æ ‡åŠ¨ç”»æ­£å¸¸
- [ ] æµ‹è¯•9: ä¼šè¯åˆ‡æ¢åŠŸèƒ½æ­£å¸¸
- [ ] æµ‹è¯•10: é”™è¯¯æç¤ºå‹å¥½

---

## 6. ç›¸å…³æ–‡æ¡£

- [BUG-00044-AIå†›å¸ˆæµå¼å¯¹è¯å¤šé—®é¢˜ç³»ç»Ÿæ€§åˆ†æ](./BUG-00044-AIå†›å¸ˆæµå¼å¯¹è¯å¤šé—®é¢˜ç³»ç»Ÿæ€§åˆ†æ.md)
- [BUG-00045-AIå†›å¸ˆæµå¼å¯¹è¯äºŒæ¬¡æµ‹è¯•é—®é¢˜åˆ†æ](./BUG-00045-AIå†›å¸ˆæµå¼å¯¹è¯äºŒæ¬¡æµ‹è¯•é—®é¢˜åˆ†æ.md)
- [TE-00028-V4-BUG-00045äººå·¥æµ‹è¯•æŒ‡å—](../TE/TE-00028-V4-BUG-00045äººå·¥æµ‹è¯•æŒ‡å—.md)
- [TE-00028-äººå·¥ç»“æœv2](../TE/TE-00028-äººå·¥ç»“æœv2.md)
- [FD-00028åŠŸèƒ½è®¾è®¡æ–‡æ¡£](../FD/FD-00028-AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§åŠŸèƒ½è®¾è®¡.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-01-05
**æœ€åæ›´æ–°**: 2026-01-05


---

## 7. ä¿®å¤å®ç°è®°å½•

### 7.1 ä¿®å¤æ—¥æœŸ
2026-01-05

### 7.2 ä¿®å¤å†…å®¹æ€»ç»“

| é—®é¢˜ç¼–å· | ä¿®å¤æ–¹æ¡ˆ | ä¿®æ”¹æ–‡ä»¶ |
|----------|----------|----------|
| P0-V3-001 | ä½¿ç”¨å•ä¸€Flowæ”¶é›†å™¨ + å»¶è¿Ÿæ¸…ç©ºæ—¶éªŒè¯ä¼šè¯ID | AiAdvisorChatViewModel.kt |
| P0-V3-002 | ç­‰å¾…åˆ é™¤å®Œæˆåå†é‡æ–°ç”Ÿæˆ + isRegeneratingçŠ¶æ€ | AiAdvisorChatViewModel.kt |
| P0-V3-003 | loadSessionsä¿æŒå½“å‰ä¼šè¯ID | AiAdvisorChatViewModel.kt |
| P1-V3-001 | åˆ†ç¦»æ»šåŠ¨é€»è¾‘ï¼Œä¸ä¾èµ–streamingContent | AiAdvisorChatScreen.kt |
| P1-V3-002 | å¢å¼ºstopGenerationé”™è¯¯å¤„ç† | AiAdvisorChatViewModel.kt |
| P1-V3-003 | ä¸P0-V3-002ä¸€èµ·ä¿®å¤ | AiAdvisorChatViewModel.kt |

### 7.3 å…³é”®ä»£ç å˜æ›´

#### 7.3.1 ä¼šè¯çŠ¶æ€ç®¡ç† (P0-V3-001, P0-V3-003)

```kotlin
// æ–°å¢å­—æ®µ
private var conversationsJob: Job? = null

// loadConversationsä¿®æ”¹
private fun loadConversations(sessionId: String) {
    conversationsJob?.cancel()
    conversationsJob = viewModelScope.launch {
        getAdvisorConversationsUseCase(sessionId).collect { conversations ->
            if (_uiState.value.currentSessionId == sessionId) {
                _uiState.update { it.copy(conversations = conversations) }
            }
        }
    }
}

// loadSessionsä¿®æ”¹ - ä¿æŒå½“å‰ä¼šè¯
val currentSessionId = _uiState.value.currentSessionId
val activeSession = if (currentSessionId != null) {
    sessions.find { it.id == currentSessionId } ?: sessions.first()
} else {
    sessions.first()
}
```

#### 7.3.2 æµå¼å®Œæˆå¤„ç† (P0-V3-001)

```kotlin
is StreamingState.Completed -> {
    val completedSessionId = _uiState.value.currentSessionId
    val completedMessageId = _uiState.value.currentStreamingMessageId
    
    // ... æ›´æ–°çŠ¶æ€
    
    viewModelScope.launch {
        kotlinx.coroutines.delay(800)
        val currentState = _uiState.value
        if (currentState.currentSessionId == completedSessionId &&
            currentState.currentStreamingMessageId == completedMessageId) {
            _uiState.update {
                it.copy(streamingContent = "", currentStreamingMessageId = null)
            }
        }
    }
}
```

#### 7.3.3 é‡æ–°ç”Ÿæˆé€»è¾‘ (P0-V3-002)

```kotlin
fun regenerateLastMessage() {
    viewModelScope.launch {
        _uiState.update { it.copy(isRegenerating = true) }
        
        val deleteResult = deleteAdvisorConversationUseCase(lastAiMessage.id)
        
        if (deleteResult.isSuccess) {
            kotlinx.coroutines.delay(150)
            regenerateStreaming(lastUserMessage.content, sessionId)
        } else {
            _uiState.update { it.copy(isRegenerating = false, error = "åˆ é™¤æ¶ˆæ¯å¤±è´¥") }
        }
    }
}
```

#### 7.3.4 æ»šåŠ¨ä¼˜åŒ– (P1-V3-001)

```kotlin
// åˆ†ç¦»ä¸ºä¸¤ä¸ªLaunchedEffect
LaunchedEffect(uiState.conversations.size) {
    // åªåœ¨æ¶ˆæ¯æ•°é‡å˜åŒ–æ—¶è§¦å‘
}

LaunchedEffect(uiState.isStreaming) {
    // æµå¼å¼€å§‹æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
}
```

### 7.4 ç¼–è¯‘çŠ¶æ€

```
âœ… :presentation:compileDebugKotlin - æˆåŠŸ
âœ… assembleDebug - æˆåŠŸ
```

### 7.5 å¾…äººå·¥éªŒè¯

è¯·æŒ‰ç…§TE-00028æµ‹è¯•æŒ‡å—è¿›è¡Œäººå·¥éªŒè¯ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1
**æœ€åæ›´æ–°**: 2026-01-05
