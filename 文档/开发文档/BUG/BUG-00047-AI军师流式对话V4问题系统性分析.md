# BUG-00047: AIå†›å¸ˆæµå¼å¯¹è¯V4é—®é¢˜ç³»ç»Ÿæ€§åˆ†æ

**åˆ›å»ºæ—¥æœŸ**: 2026-01-05
**å…³è”ä»»åŠ¡**: FD-00028 AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§
**å…³è”BUG**: BUG-00044, BUG-00045, BUG-00046
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸¥é‡
**çŠ¶æ€**: âœ… å·²ä¿®å¤
**æµ‹è¯•æ–‡æ¡£**: TE-00028-V4-BUG-00045äººå·¥æµ‹è¯•æŒ‡å—.md, TE-00028-äººå·¥ç»“æœv3.md
**æœ€åæ›´æ–°**: 2026-01-05
**ä¿®å¤ç‰ˆæœ¬**: V5

---

## 1. é—®é¢˜æ¦‚è¿°

åœ¨BUG-00046ä¿®å¤åçš„ç¬¬å››æ¬¡äººå·¥æµ‹è¯•ä¸­ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ä»ç„¶å­˜åœ¨ï¼š

### é—®é¢˜æ¸…å•æ€»è§ˆ

| ç¼–å· | é—®é¢˜æè¿° | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ | å½±å“èŒƒå›´ |
|------|----------|----------|------|----------|
| P0-V4-001 | AIå›å¤å®Œæˆåå†…å®¹å˜æˆç©ºç™½æ¡†ï¼ˆå°ç™½æ¡†ï¼‰ | ğŸ”´ P0 | âœ… å·²ä¿®å¤ | æ ¸å¿ƒåŠŸèƒ½ |
| P0-V4-002 | åœæ­¢ç”Ÿæˆåé‡æ–°ç”Ÿæˆï¼Œè¢«åœæ­¢çš„å†…å®¹è¢«å½“æˆç”¨æˆ·æ¶ˆæ¯ | ğŸ”´ P0 | âœ… å·²ä¿®å¤ | æ•°æ®å®Œæ•´æ€§ |

---

## 2. ã€æœºåˆ¶åˆ†æã€‘æ¡†æ¶è¿è¡Œæœºåˆ¶

### 2.1 æ­£å¸¸æµç¨‹ï¼ˆè®¾è®¡é¢„æœŸï¼‰

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
sendMessageStreaming() å¯åŠ¨
    â”œâ”€ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°DB (MessageType.USER, SendStatus.SUCCESS)
    â”œâ”€ åˆ›å»ºAIæ¶ˆæ¯å ä½ (MessageType.AI, content="", SendStatus.PENDING)
    â”œâ”€ åˆ›å»ºMainTextBlock (status=STREAMING)
    â””â”€ å¯åŠ¨streamingJobæ”¶é›†æµå¼å“åº”
        â†“
StreamingState.Started
    â””â”€ æ›´æ–° currentStreamingMessageId
        â†“
StreamingState.TextUpdate (å¤šæ¬¡)
    â””â”€ æ›´æ–° streamingContent (ç´¯ç§¯å†…å®¹)
        â†“
StreamingState.Completed
    â”œâ”€ æ›´æ–°DB: Block.content = fullText, Block.status = SUCCESS
    â”œâ”€ æ›´æ–°DB: Message.status = SUCCESS
    â”œâ”€ æ›´æ–°UI: isStreaming = false, streamingContent = fullText
    â””â”€ å»¶è¿Ÿ800msåæ¸…ç©º streamingContent
        â†“
conversations Flow æ›´æ–°
    â””â”€ ä»DBè¯»å–æœ€æ–°æ¶ˆæ¯åˆ—è¡¨ï¼ŒUIæ˜¾ç¤ºå®Œæ•´æ¶ˆæ¯
```

### 2.2 å…³é”®æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ViewModelå±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  UiState                                                        â”‚
â”‚  â”œâ”€ conversations: List<Conversation>  â† Flow from DB           â”‚
â”‚  â”œâ”€ streamingContent: String           â† æµå¼å†…å®¹ç¼“å­˜            â”‚
â”‚  â”œâ”€ currentStreamingMessageId: String? â† å½“å‰æµå¼æ¶ˆæ¯ID          â”‚
â”‚  â””â”€ isStreaming: Boolean               â† æµå¼çŠ¶æ€æ ‡å¿—            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Jobs                                                           â”‚
â”‚  â”œâ”€ streamingJob: Job?                 â† æµå¼å“åº”æ”¶é›†å™¨          â”‚
â”‚  â””â”€ conversationsJob: Job?             â† conversations Flowæ”¶é›†å™¨â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UseCaseå±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SendAdvisorMessageStreamingUseCase                             â”‚
â”‚  â”œâ”€ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ (if !skipUserMessage)                          â”‚
â”‚  â”œâ”€ åˆ›å»ºAIæ¶ˆæ¯å ä½                                               â”‚
â”‚  â”œâ”€ åˆ›å»ºBlock                                                   â”‚
â”‚  â””â”€ è°ƒç”¨aiRepository.generateTextStream()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Repositoryå±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AiAdvisorRepository                                            â”‚
â”‚  â”œâ”€ saveMessage()           â†’ ä¿å­˜æ¶ˆæ¯åˆ°DB                       â”‚
â”‚  â”œâ”€ updateMessageStatus()   â†’ æ›´æ–°æ¶ˆæ¯çŠ¶æ€                       â”‚
â”‚  â”œâ”€ getConversationsFlow()  â†’ è¿”å›Flow<List<Conversation>>      â”‚
â”‚  â””â”€ deleteMessage()         â†’ åˆ é™¤æ¶ˆæ¯                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 UIå±‚æ¸²æŸ“é€»è¾‘

```kotlin
// AiAdvisorChatScreen.kt æ¶ˆæ¯æ˜¾ç¤ºé€»è¾‘
LazyColumn {
    // 1. æ˜¾ç¤ºå·²å®Œæˆçš„å¯¹è¯æ¶ˆæ¯ï¼ˆä»conversationsåˆ—è¡¨ï¼‰
    items(conversations) { conversation ->
        ChatBubble(conversation)
    }
    
    // 2. æ˜¾ç¤ºæµå¼å“åº”ä¸­çš„æ¶ˆæ¯ï¼ˆä»streamingContentï¼‰
    if (shouldShowStreamingBubble) {
        item {
            StreamingMessageBubbleSimple(
                content = streamingContent,
                ...
            )
        }
    }
}

// shouldShowStreamingBubble æ¡ä»¶
val shouldShowStreamingBubble = 
    (isStreaming && currentStreamingMessageId != null) ||
    (streamingContent.isNotEmpty() && currentStreamingMessageId != null)
```

---

## 3. ã€æ½œåœ¨æ ¹å› æ ‘ã€‘Root Cause Tree

### 3.1 é—®é¢˜1ï¼šAIå›å¤å®Œæˆåå†…å®¹å˜æˆç©ºç™½æ¡†

```
P0-V4-001: å†…å®¹æ¶ˆå¤±
â”œâ”€â”€ æ¡†æ¶æœºåˆ¶å±‚
â”‚   â”œâ”€â”€ Flowæ”¶é›†å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â”‚   â”œâ”€ conversationsJobæœªæ­£ç¡®å–æ¶ˆ
â”‚   â”‚   â””â”€ å¤šä¸ªFlowæ”¶é›†å™¨åŒæ—¶è¿è¡Œå¯¼è‡´çŠ¶æ€å†²çª
â”‚   â”œâ”€â”€ çŠ¶æ€åŒæ­¥æ—¶åºé—®é¢˜
â”‚   â”‚   â”œâ”€ DBæ›´æ–°ä¸Flowé€šçŸ¥ä¹‹é—´çš„å»¶è¿Ÿ
â”‚   â”‚   â””â”€ streamingContentæ¸…ç©ºæ—¶æœºä¸conversationsæ›´æ–°ä¸åŒæ­¥
â”‚   â””â”€â”€ å»¶è¿Ÿæ¸…ç©ºæœºåˆ¶ç¼ºé™·
â”‚       â”œâ”€ 800mså»¶è¿Ÿä¸è¶³ä»¥ç­‰å¾…DBæ›´æ–°
â”‚       â””â”€ ä¼šè¯IDéªŒè¯é€»è¾‘ä¸å®Œæ•´
â”‚
â”œâ”€â”€ æ¨¡å—è¡Œä¸ºå±‚
â”‚   â”œâ”€â”€ UseCaseå±‚
â”‚   â”‚   â”œâ”€ updateMessageStatus()è°ƒç”¨æ—¶æœº
â”‚   â”‚   â””â”€ Blockå†…å®¹æ›´æ–°ä¸MessageçŠ¶æ€æ›´æ–°é¡ºåº
â”‚   â”œâ”€â”€ Repositoryå±‚
â”‚   â”‚   â”œâ”€ Room Flowé€šçŸ¥å»¶è¿Ÿ
â”‚   â”‚   â””â”€ äº‹åŠ¡è¾¹ç•Œé—®é¢˜
â”‚   â””â”€â”€ ViewModelå±‚
â”‚       â”œâ”€ streamingContentä¸conversationsçš„åŒæ­¥
â”‚       â””â”€ currentStreamingMessageIdæ¸…ç©ºæ—¶æœº
â”‚
â”œâ”€â”€ ä½¿ç”¨æ–¹å¼å±‚
â”‚   â”œâ”€â”€ UIå±‚æ¸²æŸ“æ¡ä»¶
â”‚   â”‚   â”œâ”€ shouldShowStreamingBubbleæ¡ä»¶ä¸å®Œæ•´
â”‚   â”‚   â””â”€ conversationsåˆ—è¡¨ä¸­æ¶ˆæ¯contentä¸ºç©º
â”‚   â””â”€â”€ çŠ¶æ€æ›´æ–°é¡ºåº
â”‚       â””â”€ isStreaming=falseå…ˆäºconversationsæ›´æ–°
â”‚
â””â”€â”€ ç¯å¢ƒå±‚
    â”œâ”€â”€ Roomæ•°æ®åº“IOå»¶è¿Ÿ
    â””â”€â”€ åç¨‹è°ƒåº¦å™¨åˆ‡æ¢å¼€é”€
```

### 3.2 é—®é¢˜2ï¼šåœæ­¢åé‡æ–°ç”Ÿæˆï¼Œå†…å®¹è¢«å½“æˆç”¨æˆ·æ¶ˆæ¯

```
P0-V4-002: æ¶ˆæ¯ç±»å‹é”™è¯¯
â”œâ”€â”€ æ¡†æ¶æœºåˆ¶å±‚
â”‚   â”œâ”€â”€ æ¶ˆæ¯åˆ é™¤ä¸é‡æ–°ç”Ÿæˆçš„ç«æ€æ¡ä»¶
â”‚   â”‚   â”œâ”€ deleteMessage()æ˜¯å¼‚æ­¥æ“ä½œ
â”‚   â”‚   â””â”€ regenerateStreaming()åœ¨åˆ é™¤å®Œæˆå‰å¯åŠ¨
â”‚   â””â”€â”€ Flowæ›´æ–°å»¶è¿Ÿ
â”‚       â””â”€ conversationsåˆ—è¡¨æœªåŠæ—¶åæ˜ åˆ é™¤ç»“æœ
â”‚
â”œâ”€â”€ æ¨¡å—è¡Œä¸ºå±‚
â”‚   â”œâ”€â”€ stopGeneration()
â”‚   â”‚   â”œâ”€ updateMessageContentAndStatus()å¯èƒ½å¤±è´¥
â”‚   â”‚   â””â”€ å¤±è´¥åçš„deleteMessage()ä¹Ÿå¯èƒ½å¤±è´¥
â”‚   â”œâ”€â”€ regenerateLastMessage()
â”‚   â”‚   â”œâ”€ è·å–lastAiMessageæ—¶æ•°æ®å¯èƒ½è¿‡æ—¶
â”‚   â”‚   â””â”€ 150mså»¶è¿Ÿä¸è¶³ä»¥ç­‰å¾…Flowæ›´æ–°
â”‚   â””â”€â”€ SendAdvisorMessageStreamingUseCase
â”‚       â”œâ”€ skipUserMessageå‚æ•°ä¼ é€’é—®é¢˜
â”‚       â””â”€ AIæ¶ˆæ¯å ä½åˆ›å»ºé€»è¾‘
â”‚
â”œâ”€â”€ ä½¿ç”¨æ–¹å¼å±‚
â”‚   â”œâ”€â”€ ç”¨æˆ·æ“ä½œåºåˆ—
â”‚   â”‚   â”œâ”€ å¿«é€Ÿç‚¹å‡»åœæ­¢â†’é‡æ–°ç”Ÿæˆ
â”‚   â”‚   â””â”€ å¤šæ¬¡é‡å¤æ“ä½œ
â”‚   â””â”€â”€ UIçŠ¶æ€æ˜¾ç¤º
â”‚       â””â”€ æ¶ˆæ¯ç±»å‹åˆ¤æ–­é€»è¾‘
â”‚
â””â”€â”€ ç¯å¢ƒå±‚
    â”œâ”€â”€ æ•°æ®åº“äº‹åŠ¡éš”ç¦»çº§åˆ«
    â””â”€ ç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„çŠ¶æ€ä¸ä¸€è‡´
```

---

## 4. ã€æ’æŸ¥è·¯å¾„ã€‘é€å±‚æ’æŸ¥æ¸…å•

### 4.1 ä¼˜å…ˆæ’æŸ¥é¡¹ï¼ˆä»æ¡†æ¶åˆ°åº”ç”¨å±‚ï¼‰

#### ç¬¬ä¸€å±‚ï¼šæ•°æ®åº“å±‚ï¼ˆæœ€åº•å±‚ï¼‰

```markdown
â–¡ æ£€æŸ¥1: Room Flowé€šçŸ¥æœºåˆ¶
  - éªŒè¯æ–¹æ³•: åœ¨DAOçš„Flowè¿”å›å¤„æ·»åŠ æ—¥å¿—
  - é¢„æœŸ: æ¶ˆæ¯ä¿å­˜åï¼ŒFlowåº”ç«‹å³é€šçŸ¥
  - å®é™…: [å¾…éªŒè¯]

â–¡ æ£€æŸ¥2: æ¶ˆæ¯ä¿å­˜å®Œæ•´æ€§
  - éªŒè¯æ–¹æ³•: æŸ¥çœ‹æ•°æ®åº“ä¸­çš„æ¶ˆæ¯è®°å½•
  - é¢„æœŸ: AIæ¶ˆæ¯çš„contentå­—æ®µåº”æœ‰å®Œæ•´å†…å®¹
  - å®é™…: [å¾…éªŒè¯]

â–¡ æ£€æŸ¥3: æ¶ˆæ¯çŠ¶æ€æ›´æ–°
  - éªŒè¯æ–¹æ³•: æ£€æŸ¥SendStatuså­—æ®µ
  - é¢„æœŸ: å®Œæˆååº”ä¸ºSUCCESS
  - å®é™…: [å¾…éªŒè¯]
```

#### ç¬¬äºŒå±‚ï¼šRepositoryå±‚

```markdown
â–¡ æ£€æŸ¥4: updateBlockContent()æ‰§è¡Œç»“æœ
  - éªŒè¯æ–¹æ³•: æ·»åŠ æ—¥å¿—è®°å½•è¿”å›å€¼
  - é¢„æœŸ: è¿”å›æˆåŠŸ
  - å®é™…: [å¾…éªŒè¯]

â–¡ æ£€æŸ¥5: updateMessageStatus()æ‰§è¡Œç»“æœ
  - éªŒè¯æ–¹æ³•: æ·»åŠ æ—¥å¿—è®°å½•è¿”å›å€¼
  - é¢„æœŸ: è¿”å›æˆåŠŸ
  - å®é™…: [å¾…éªŒè¯]

â–¡ æ£€æŸ¥6: getConversationsFlow()æ•°æ®å®Œæ•´æ€§
  - éªŒè¯æ–¹æ³•: åœ¨Flowæ”¶é›†å¤„æ‰“å°æ¶ˆæ¯å†…å®¹
  - é¢„æœŸ: æ¶ˆæ¯contentåº”æœ‰å€¼
  - å®é™…: [å¾…éªŒè¯]
```

#### ç¬¬ä¸‰å±‚ï¼šUseCaseå±‚

```markdown
â–¡ æ£€æŸ¥7: StreamingState.Completedå‘å°„æ—¶æœº
  - éªŒè¯æ–¹æ³•: æ·»åŠ æ—¥å¿—è®°å½•fullTextå†…å®¹
  - é¢„æœŸ: fullTextåº”æœ‰å®Œæ•´å†…å®¹
  - å®é™…: [å¾…éªŒè¯]

â–¡ æ£€æŸ¥8: skipUserMessageå‚æ•°ä¼ é€’
  - éªŒè¯æ–¹æ³•: åœ¨UseCaseå…¥å£æ‰“å°å‚æ•°å€¼
  - é¢„æœŸ: é‡æ–°ç”Ÿæˆæ—¶åº”ä¸ºtrue
  - å®é™…: [å¾…éªŒè¯]
```

#### ç¬¬å››å±‚ï¼šViewModelå±‚

```markdown
â–¡ æ£€æŸ¥9: streamingContentæ›´æ–°
  - éªŒè¯æ–¹æ³•: åœ¨TextUpdateå¤„ç†ä¸­æ‰“å°å†…å®¹
  - é¢„æœŸ: å†…å®¹åº”é€æ­¥ç´¯ç§¯
  - å®é™…: [å¾…éªŒè¯]

â–¡ æ£€æŸ¥10: Completedå¤„ç†åçš„çŠ¶æ€
  - éªŒè¯æ–¹æ³•: æ‰“å°å®Œæˆåçš„UiState
  - é¢„æœŸ: streamingContentåº”æœ‰å®Œæ•´å†…å®¹
  - å®é™…: [å¾…éªŒè¯]

â–¡ æ£€æŸ¥11: å»¶è¿Ÿæ¸…ç©ºæ—¶çš„çŠ¶æ€éªŒè¯
  - éªŒè¯æ–¹æ³•: æ‰“å°800msåçš„çŠ¶æ€
  - é¢„æœŸ: conversationsåº”å·²æ›´æ–°
  - å®é™…: [å¾…éªŒè¯]

â–¡ æ£€æŸ¥12: conversationsJobç®¡ç†
  - éªŒè¯æ–¹æ³•: æ‰“å°Jobçš„åˆ›å»ºå’Œå–æ¶ˆ
  - é¢„æœŸ: åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæ´»è·ƒJob
  - å®é™…: [å¾…éªŒè¯]
```

#### ç¬¬äº”å±‚ï¼šUIå±‚

```markdown
â–¡ æ£€æŸ¥13: shouldShowStreamingBubbleæ¡ä»¶
  - éªŒè¯æ–¹æ³•: æ‰“å°æ¡ä»¶åˆ¤æ–­ç»“æœ
  - é¢„æœŸ: å®Œæˆååº”ä¸ºfalse
  - å®é™…: [å¾…éªŒè¯]

â–¡ æ£€æŸ¥14: conversationsåˆ—è¡¨æ¸²æŸ“
  - éªŒè¯æ–¹æ³•: æ‰“å°æ¸²æŸ“çš„æ¶ˆæ¯å†…å®¹
  - é¢„æœŸ: AIæ¶ˆæ¯åº”æœ‰å†…å®¹
  - å®é™…: [å¾…éªŒè¯]
```

### 4.2 éªŒè¯è„šæœ¬

```bash
# æŸ¥çœ‹AIå†›å¸ˆç›¸å…³æ—¥å¿—
adb -s 192.0.2.1:7555 logcat | findstr "AiAdvisor\|Streaming\|SendAdvisor"

# æŸ¥çœ‹æ•°æ®åº“æ“ä½œæ—¥å¿—
adb -s 192.0.2.1:7555 logcat | findstr "Room\|DAO\|Database"

# æŸ¥çœ‹Flowç›¸å…³æ—¥å¿—
adb -s 192.0.2.1:7555 logcat | findstr "Flow\|collect\|emit"
```

---

## 5. ã€æœ€å¯èƒ½çš„æ ¹å› ã€‘åŸºäºæœºåˆ¶æ¨ç†

### 5.1 æ ¹å› 1ï¼šæ¶ˆæ¯å†…å®¹æœªæ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆæ¦‚ç‡ï¼š60%ï¼‰

**æ¨ç†è¿‡ç¨‹ï¼š**

1. è§‚å¯Ÿç°è±¡ï¼šAIå›å¤å®Œæˆåæ˜¾ç¤ºç©ºç™½æ¡†
2. ç©ºç™½æ¡†æ„å‘³ç€ï¼š`conversations`åˆ—è¡¨ä¸­çš„AIæ¶ˆæ¯`content`å­—æ®µä¸ºç©º
3. `conversations`æ¥è‡ªæ•°æ®åº“Flow
4. å› æ­¤é—®é¢˜å¯èƒ½åœ¨ï¼š
   - UseCaseå±‚ï¼š`updateBlockContent()`æœªæ­£ç¡®æ‰§è¡Œ
   - æˆ–è€…ï¼šæ¶ˆæ¯çš„`content`å­—æ®µæœªä»BlockåŒæ­¥

**å…³é”®ä»£ç åˆ†æï¼š**

```kotlin
// SendAdvisorMessageStreamingUseCase.kt
is AiStreamChunk.Complete -> {
    val finalContent = chunk.fullText.ifEmpty { contentBuilder.toString() }
    
    // é—®é¢˜ç‚¹1: åªæ›´æ–°äº†Blockçš„contentï¼Œæ²¡æœ‰æ›´æ–°Messageçš„content
    aiAdvisorRepository.updateBlockContent(
        blockId = mainTextBlock.id,
        content = finalContent,
        status = MessageBlockStatus.SUCCESS
    )
    
    // é—®é¢˜ç‚¹2: åªæ›´æ–°äº†çŠ¶æ€ï¼Œæ²¡æœ‰æ›´æ–°content
    aiAdvisorRepository.updateMessageStatus(aiMessageId, SendStatus.SUCCESS)
    
    emit(StreamingState.Completed(finalContent, chunk.usage))
}
```

**é—®é¢˜æ ¹æºï¼š**
- `AiAdvisorConversation`çš„`content`å­—æ®µåœ¨åˆ›å»ºæ—¶ä¸ºç©ºå­—ç¬¦ä¸²
- æµå¼å®Œæˆååªæ›´æ–°äº†`Block`çš„å†…å®¹å’Œ`Message`çš„çŠ¶æ€
- **æ²¡æœ‰æ›´æ–°`Message`çš„`content`å­—æ®µï¼**
- `getConversationsFlow()`è¿”å›çš„æ˜¯`Message`ï¼Œä¸æ˜¯`Block`
- å› æ­¤UIæ˜¾ç¤ºçš„`conversation.content`å§‹ç»ˆä¸ºç©º

### 5.2 æ ¹å› 2ï¼šæ¶ˆæ¯å†…å®¹æ›´æ–°æ–¹æ³•ç¼ºå¤±ï¼ˆæ¦‚ç‡ï¼š30%ï¼‰

**æ¨ç†è¿‡ç¨‹ï¼š**

æ£€æŸ¥`AiAdvisorRepository`æ¥å£ï¼š

```kotlin
interface AiAdvisorRepository {
    suspend fun saveMessage(message: AiAdvisorConversation): Result<Unit>
    suspend fun updateMessageStatus(messageId: String, status: SendStatus): Result<Unit>
    suspend fun updateMessageContentAndStatus(messageId: String, content: String, status: SendStatus): Result<Unit>
    // ...
}
```

å­˜åœ¨`updateMessageContentAndStatus()`æ–¹æ³•ï¼Œä½†åœ¨`StreamingState.Completed`å¤„ç†ä¸­æ²¡æœ‰è°ƒç”¨ï¼

### 5.3 æ ¹å› 3ï¼šåœæ­¢åé‡æ–°ç”Ÿæˆçš„æ¶ˆæ¯ç±»å‹æ··æ·†ï¼ˆæ¦‚ç‡ï¼š10%ï¼‰

**æ¨ç†è¿‡ç¨‹ï¼š**

ç”¨æˆ·åé¦ˆï¼š"åœæ­¢ç”Ÿæˆåé‡æ–°ç”Ÿæˆï¼Œè¢«åœæ­¢çš„å†…å®¹è¢«å½“æˆç”¨æˆ·æ¶ˆæ¯"

å¯èƒ½åŸå› ï¼š
1. `stopGeneration()`ä¸­çš„`updateMessageContentAndStatus()`å¤±è´¥
2. å¤±è´¥åè°ƒç”¨`deleteMessage()`ä¹Ÿå¤±è´¥
3. å¯¼è‡´è¢«åœæ­¢çš„AIæ¶ˆæ¯ä»ç„¶å­˜åœ¨ï¼Œä½†çŠ¶æ€å¼‚å¸¸
4. é‡æ–°ç”Ÿæˆæ—¶ï¼Œè¿™æ¡å¼‚å¸¸æ¶ˆæ¯å¯èƒ½è¢«è¯¯åˆ¤

ä½†è¿™ä¸ªé—®é¢˜çš„æè¿°ä¸å¤ªæ¸…æ™°ï¼Œéœ€è¦è¿›ä¸€æ­¥éªŒè¯ã€‚

---

## 6. ã€ç¨³å®šä¿®å¤æ–¹æ¡ˆã€‘ä»æ¡†æ¶åŸç†å‡ºå‘

### 6.1 ä¿®å¤æ–¹æ¡ˆ1ï¼šåœ¨æµå¼å®Œæˆæ—¶æ›´æ–°æ¶ˆæ¯å†…å®¹

**ä¿®æ”¹æ–‡ä»¶ï¼š** `SendAdvisorMessageStreamingUseCase.kt`

**ä¿®æ”¹å†…å®¹ï¼š**

```kotlin
is AiStreamChunk.Complete -> {
    val finalContent = chunk.fullText.ifEmpty { contentBuilder.toString() }
    
    // 1. æ›´æ–°Blockå†…å®¹
    aiAdvisorRepository.updateBlockContent(
        blockId = mainTextBlock.id,
        content = finalContent,
        status = MessageBlockStatus.SUCCESS
    )
    
    // 2. ã€å…³é”®ä¿®å¤ã€‘æ›´æ–°Messageçš„contentå’Œstatus
    aiAdvisorRepository.updateMessageContentAndStatus(
        messageId = aiMessageId,
        content = finalContent,
        status = SendStatus.SUCCESS
    )
    
    emit(StreamingState.Completed(finalContent, chunk.usage))
}
```

**åŸç†è§£é‡Šï¼š**
- `getConversationsFlow()`è¿”å›çš„æ˜¯`AiAdvisorConversation`åˆ—è¡¨
- UIæ¸²æŸ“æ—¶ä½¿ç”¨çš„æ˜¯`conversation.content`
- å¿…é¡»åœ¨æµå¼å®Œæˆæ—¶æ›´æ–°`Message`çš„`content`å­—æ®µ
- è¿™æ ·`conversations` Flowæ›´æ–°åï¼ŒUIæ‰èƒ½æ˜¾ç¤ºæ­£ç¡®å†…å®¹

### 6.2 ä¿®å¤æ–¹æ¡ˆ2ï¼šå¢å¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—

**ä¿®æ”¹æ–‡ä»¶ï¼š** `SendAdvisorMessageStreamingUseCase.kt`

**ä¿®æ”¹å†…å®¹ï¼š**

```kotlin
is AiStreamChunk.Complete -> {
    val finalContent = chunk.fullText.ifEmpty { contentBuilder.toString() }
    
    // æ·»åŠ æ—¥å¿—
    Log.d(TAG, "Streaming completed, content length: ${finalContent.length}")
    
    // æ›´æ–°Block
    val blockResult = aiAdvisorRepository.updateBlockContent(
        blockId = mainTextBlock.id,
        content = finalContent,
        status = MessageBlockStatus.SUCCESS
    )
    Log.d(TAG, "Block update result: ${blockResult.isSuccess}")
    
    // æ›´æ–°Messageï¼ˆå…³é”®ä¿®å¤ï¼‰
    val messageResult = aiAdvisorRepository.updateMessageContentAndStatus(
        messageId = aiMessageId,
        content = finalContent,
        status = SendStatus.SUCCESS
    )
    Log.d(TAG, "Message update result: ${messageResult.isSuccess}")
    
    if (messageResult.isFailure) {
        Log.e(TAG, "Failed to update message content", messageResult.exceptionOrNull())
    }
    
    emit(StreamingState.Completed(finalContent, chunk.usage))
}
```

### 6.3 ä¿®å¤æ–¹æ¡ˆ3ï¼šä¼˜åŒ–ViewModelçš„å»¶è¿Ÿæ¸…ç©ºé€»è¾‘

**ä¿®æ”¹æ–‡ä»¶ï¼š** `AiAdvisorChatViewModel.kt`

**ä¿®æ”¹å†…å®¹ï¼š**

```kotlin
is StreamingState.Completed -> {
    val completedSessionId = _uiState.value.currentSessionId
    val completedMessageId = _uiState.value.currentStreamingMessageId
    
    _uiState.update {
        it.copy(
            isStreaming = false,
            streamingContent = state.fullText,
            thinkingContent = "",
            thinkingElapsedMs = 0,
            lastTokenUsage = state.usage
        )
    }
    
    // ä¼˜åŒ–ï¼šä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿï¼Œå¹¶æ·»åŠ é‡è¯•æœºåˆ¶
    viewModelScope.launch {
        // ç­‰å¾…DBæ›´æ–°å’ŒFlowé€šçŸ¥
        kotlinx.coroutines.delay(1000)  // å¢åŠ åˆ°1000ms
        
        val currentState = _uiState.value
        
        // éªŒè¯conversationsæ˜¯å¦å·²åŒ…å«å®Œæˆçš„æ¶ˆæ¯
        val messageInList = currentState.conversations.any { 
            it.id == completedMessageId && it.content.isNotEmpty() 
        }
        
        if (messageInList) {
            // æ¶ˆæ¯å·²åœ¨åˆ—è¡¨ä¸­ï¼Œå¯ä»¥å®‰å…¨æ¸…ç©º
            if (currentState.currentSessionId == completedSessionId &&
                currentState.currentStreamingMessageId == completedMessageId) {
                _uiState.update {
                    it.copy(
                        streamingContent = "",
                        currentStreamingMessageId = null
                    )
                }
            }
        } else {
            // æ¶ˆæ¯æœªåœ¨åˆ—è¡¨ä¸­ï¼Œä¿æŒstreamingContentæ˜¾ç¤º
            Log.w(TAG, "Message not found in conversations, keeping streamingContent")
        }
    }
}
```

---

## 7. ä¿®å¤ä¼˜å…ˆçº§å’Œå·¥æ—¶ä¼°ç®—

| ä¼˜å…ˆçº§ | é—®é¢˜ç¼–å· | ä¿®å¤æ–¹æ¡ˆ | é¢„è®¡å·¥æ—¶ | ä¿®å¤éš¾åº¦ |
|--------|----------|----------|----------|----------|
| P0 | P0-V4-001 | æ–¹æ¡ˆ1+æ–¹æ¡ˆ2 | 1h | ä¸­ |
| P0 | P0-V4-002 | éœ€è¿›ä¸€æ­¥åˆ†æ | 1h | ä¸­ |

**æ€»é¢„è®¡å·¥æ—¶**: 2å°æ—¶

---

## 8. æµ‹è¯•éªŒè¯æ¸…å•

ä¿®å¤å®Œæˆåï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### P0çº§æµ‹è¯•
- [ ] æµ‹è¯•1: AIå›å¤å®Œæˆåå†…å®¹ä¿æŒæ˜¾ç¤ºï¼Œä¸å˜æˆç©ºç™½æ¡†
- [ ] æµ‹è¯•2: åœæ­¢ç”Ÿæˆåï¼Œæ¶ˆæ¯æ­£ç¡®æ˜¾ç¤ºæˆ–åˆ é™¤
- [ ] æµ‹è¯•3: é‡æ–°ç”Ÿæˆæ—¶ï¼Œä¸å‡ºç°æ¶ˆæ¯ç±»å‹æ··æ·†
- [ ] æµ‹è¯•4: å¤šæ¬¡å‘é€æ¶ˆæ¯ï¼Œæ¯æ¡éƒ½èƒ½æ­£ç¡®æ˜¾ç¤º

### å›å½’æµ‹è¯•
- [ ] æµ‹è¯•5: æµå¼å“åº”è¿‡ç¨‹ä¸­å…‰æ ‡åŠ¨ç”»æ­£å¸¸
- [ ] æµ‹è¯•6: ä¼šè¯åˆ‡æ¢åŠŸèƒ½æ­£å¸¸
- [ ] æµ‹è¯•7: é”™è¯¯æç¤ºå‹å¥½

---

## 9. ç›¸å…³æ–‡æ¡£

- [BUG-00044-AIå†›å¸ˆæµå¼å¯¹è¯å¤šé—®é¢˜ç³»ç»Ÿæ€§åˆ†æ](./BUG-00044-AIå†›å¸ˆæµå¼å¯¹è¯å¤šé—®é¢˜ç³»ç»Ÿæ€§åˆ†æ.md)
- [BUG-00045-AIå†›å¸ˆæµå¼å¯¹è¯äºŒæ¬¡æµ‹è¯•é—®é¢˜åˆ†æ](./BUG-00045-AIå†›å¸ˆæµå¼å¯¹è¯äºŒæ¬¡æµ‹è¯•é—®é¢˜åˆ†æ.md)
- [BUG-00046-AIå†›å¸ˆæµå¼å¯¹è¯V3é—®é¢˜ç³»ç»Ÿæ€§åˆ†æ](./BUG-00046-AIå†›å¸ˆæµå¼å¯¹è¯V3é—®é¢˜ç³»ç»Ÿæ€§åˆ†æ.md)
- [TE-00028-V4-BUG-00045äººå·¥æµ‹è¯•æŒ‡å—](../TE/TE-00028-V4-BUG-00045äººå·¥æµ‹è¯•æŒ‡å—.md)
- [TE-00028-äººå·¥ç»“æœv3](../TE/TE-00028-äººå·¥ç»“æœv3.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-01-05
**æœ€åæ›´æ–°**: 2026-01-05
