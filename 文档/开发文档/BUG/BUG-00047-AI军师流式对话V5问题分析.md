# BUG-00047: AIå†›å¸ˆæµå¼å¯¹è¯V5é—®é¢˜åˆ†æ

**åˆ›å»ºæ—¥æœŸ**: 2026-01-05
**å…³è”ä»»åŠ¡**: FD-00028 AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§
**å…³è”BUG**: BUG-00044, BUG-00045, BUG-00046
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸¥é‡
**çŠ¶æ€**: âœ… å·²ä¿®å¤
**æµ‹è¯•æ–‡æ¡£**: TD-00028-V5-äººå·¥ç»“æœ.md, TE-00028-V6-BUG-00047æµ‹è¯•ç”¨ä¾‹.md
**æœ€åæ›´æ–°**: 2026-01-05
**ä¿®å¤ç‰ˆæœ¬**: v1.0.0-BUG047

---

## 1. é—®é¢˜æ¦‚è¿°

åœ¨BUG-00046ä¿®å¤åçš„ç¬¬äº”æ¬¡äººå·¥æµ‹è¯•ä¸­ï¼Œå‘ç°ä»¥ä¸‹ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ä»ç„¶å­˜åœ¨ã€‚æœ¬æ–‡æ¡£åŸºäºTD-00028-V5æµ‹è¯•ç»“æœè¿›è¡Œç³»ç»Ÿæ€§åˆ†æã€‚

### é—®é¢˜æ¸…å•æ€»è§ˆ

| ç¼–å· | é—®é¢˜æè¿° | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ | å½±å“èŒƒå›´ |
|------|----------|----------|------|----------|
| P0-V5-001 | AIç”Ÿæˆå›å¤æ—¶çŸ­æš‚å‡ºç°ä¸¤ä¸ªAIå›å¤æ¡† | ğŸ”´ P0 | âœ… å·²ä¿®å¤ | æ ¸å¿ƒåŠŸèƒ½ |
| P0-V5-002 | åœæ­¢ç”Ÿæˆåæ¶ˆæ¯ç›´æ¥æ¶ˆå¤±ï¼Œæ— é‡æ–°ç”ŸæˆæŒ‰é’® | ğŸ”´ P0 | âœ… å·²ä¿®å¤ | æ ¸å¿ƒåŠŸèƒ½ |

---

## 2. è¯¦ç»†é—®é¢˜åˆ†æ

### 2.1 P0-V5-001: AIç”Ÿæˆå›å¤æ—¶çŸ­æš‚å‡ºç°ä¸¤ä¸ªAIå›å¤æ¡†

**é—®é¢˜æè¿°**:
æ ¹æ®TD-00028-V5-äººå·¥ç»“æœ.mdçš„æè¿°ï¼š
> "å½“AIç”Ÿæˆå›å¤çš„æ—¶å€™ï¼Œä½ ä¼šçŸ­æš‚çš„å†’å‡ºä¸¤ä¸ªAIçš„å›å¤ç»“æœã€‚ç„¶åç¬¬äºŒä¸ªå›å¤ç»“æœè¿…é€Ÿçš„æ¶ˆå¤±"

**å¤ç°æ­¥éª¤**:
1. è¿›å…¥AIå†›å¸ˆå¯¹è¯ç•Œé¢
2. å‘é€ä¸€æ¡æ¶ˆæ¯
3. è§‚å¯ŸAIå›å¤ç”Ÿæˆè¿‡ç¨‹

**é¢„æœŸç»“æœ**: 
- åªæ˜¾ç¤ºä¸€ä¸ªAIæ¶ˆæ¯æ°”æ³¡
- æµå¼å†…å®¹åœ¨è¯¥æ°”æ³¡ä¸­å®æ—¶æ›´æ–°

**å®é™…ç»“æœ**: 
- çŸ­æš‚å‡ºç°ä¸¤ä¸ªAIæ¶ˆæ¯æ°”æ³¡
- ç¬¬äºŒä¸ªæ°”æ³¡è¿…é€Ÿæ¶ˆå¤±
- ç”¨æˆ·ä½“éªŒä¸ä½³

**æ ¹æœ¬åŸå› åˆ†æ**:

ç»è¿‡ä»£ç åˆ†æï¼Œé—®é¢˜å‡ºåœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

#### åŸå› 1: æµå¼æ¶ˆæ¯å’Œæ•°æ®åº“æ¶ˆæ¯åŒæ—¶æ¸²æŸ“

åœ¨`AiAdvisorChatScreen.kt`ä¸­ï¼Œæ¶ˆæ¯åˆ—è¡¨çš„æ¸²æŸ“é€»è¾‘å¦‚ä¸‹ï¼š

```kotlin
// ç¬¬220-245è¡Œ
// å·²å®Œæˆçš„å¯¹è¯æ¶ˆæ¯
items(
    items = uiState.conversations,
    key = { it.id }
) { conversation ->
    ChatBubble(...)
}

// æµå¼å“åº”ä¸­çš„æ¶ˆæ¯
val shouldShowStreamingBubble = (uiState.isStreaming && uiState.currentStreamingMessageId != null) ||
    (uiState.streamingContent.isNotEmpty() && uiState.currentStreamingMessageId != null)

if (shouldShowStreamingBubble) {
    item(key = "streaming_message") {
        StreamingMessageBubbleSimple(...)
    }
}
```

**é—®é¢˜æ ¹æº**:
1. `SendAdvisorMessageStreamingUseCase`åœ¨æµå¼å¼€å§‹æ—¶åˆ›å»ºAIæ¶ˆæ¯å ä½ï¼ˆPENDINGçŠ¶æ€ï¼Œç©ºå†…å®¹ï¼‰
2. è¿™ä¸ªå ä½æ¶ˆæ¯ä¼šé€šè¿‡`getConversationsFlow()`è¿›å…¥`conversations`åˆ—è¡¨
3. åŒæ—¶ï¼Œ`StreamingMessageBubbleSimple`ä¹Ÿåœ¨æ¸²æŸ“æµå¼å†…å®¹
4. è™½ç„¶`ChatBubble`æœ‰è¿‡æ»¤é€»è¾‘ï¼ˆç¬¬460è¡Œï¼‰ï¼Œä½†å­˜åœ¨æ—¶åºé—®é¢˜

```kotlin
// ChatBubbleä¸­çš„è¿‡æ»¤é€»è¾‘ï¼ˆç¬¬460-463è¡Œï¼‰
if (!isUser && conversation.content.isEmpty() && isPending) {
    return  // ä¸æ¸²æŸ“ç©ºå†…å®¹çš„PENDINGçŠ¶æ€AIæ¶ˆæ¯
}
```

**æ—¶åºé—®é¢˜**:
- å½“æµå¼å®Œæˆæ—¶ï¼Œ`SendAdvisorMessageStreamingUseCase`æ›´æ–°æ¶ˆæ¯å†…å®¹å’ŒçŠ¶æ€
- ä½†`conversations` Flowçš„æ›´æ–°å’Œ`streamingContent`çš„æ¸…ç©ºå­˜åœ¨æ—¶é—´å·®
- åœ¨è¿™ä¸ªæ—¶é—´çª—å£å†…ï¼Œä¸¤ä¸ªæ°”æ³¡å¯èƒ½åŒæ—¶æ˜¾ç¤º

#### åŸå› 2: æ¶ˆæ¯IDåŒ¹é…é€»è¾‘ä¸å®Œå–„

å½“å‰çš„æ¸²æŸ“æ¡ä»¶æ²¡æœ‰æ£€æŸ¥`conversations`åˆ—è¡¨ä¸­æ˜¯å¦å·²å­˜åœ¨ç›¸åŒIDçš„æ¶ˆæ¯ï¼š

```kotlin
// å½“å‰é€»è¾‘
val shouldShowStreamingBubble = (uiState.isStreaming && uiState.currentStreamingMessageId != null) ||
    (uiState.streamingContent.isNotEmpty() && uiState.currentStreamingMessageId != null)
```

**åº”è¯¥å¢åŠ çš„æ£€æŸ¥**:
```kotlin
// æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²åœ¨conversationsåˆ—è¡¨ä¸­ä¸”æœ‰å†…å®¹
val messageAlreadyInList = uiState.conversations.any { 
    it.id == uiState.currentStreamingMessageId && it.content.isNotEmpty() 
}

val shouldShowStreamingBubble = !messageAlreadyInList && (
    (uiState.isStreaming && uiState.currentStreamingMessageId != null) ||
    (uiState.streamingContent.isNotEmpty() && uiState.currentStreamingMessageId != null)
)
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

---

### 2.2 P0-V5-002: åœæ­¢ç”Ÿæˆåæ¶ˆæ¯ç›´æ¥æ¶ˆå¤±ï¼Œæ— é‡æ–°ç”ŸæˆæŒ‰é’®

**é—®é¢˜æè¿°**:
æ ¹æ®TD-00028-V5-äººå·¥ç»“æœ.mdçš„æè¿°ï¼š
> "å½“æˆ‘ä»¬åœæ­¢ç”Ÿæˆæˆ‘ä»¬çš„AIå›å¤çš„æ—¶å€™ï¼Œå®ƒå¹¶ä¸ä¼šç›´æ¥çš„ç»ˆæ­¢ï¼Œè€Œæ˜¯è¯´å®ƒä¼šç›´æ¥æ¶ˆå¤±ã€‚æŒ‰ç…§æ­£å¸¸çš„æ¥è¯´ï¼Œæˆ‘ä»¬åº”è¯¥æ˜¯å®ƒåœæ­¢äº†ï¼Œç„¶åæœ€åº•ä¸‹è¿˜ç•™äº†ä¸€ä¸ªé‡æ–°ç”Ÿæˆçš„æŒ‰é’®"

**å¤ç°æ­¥éª¤**:
1. å‘é€æ¶ˆæ¯ï¼Œå¼€å§‹AIæµå¼å“åº”
2. åœ¨å“åº”è¿‡ç¨‹ä¸­ç‚¹å‡»"åœæ­¢"æŒ‰é’®
3. è§‚å¯Ÿæ¶ˆæ¯åˆ—è¡¨

**é¢„æœŸç»“æœ**: 
- æ˜¾ç¤ºå·²ç”Ÿæˆçš„å†…å®¹ + "[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
- åº•éƒ¨æ˜¾ç¤º"é‡æ–°ç”Ÿæˆ"æŒ‰é’®
- ç”¨æˆ·å¯ä»¥é€‰æ‹©é‡æ–°ç”Ÿæˆ

**å®é™…ç»“æœ**: 
- æ¶ˆæ¯ç›´æ¥æ¶ˆå¤±
- æ²¡æœ‰é‡æ–°ç”ŸæˆæŒ‰é’®
- ç”¨æˆ·æ— æ³•æ¢å¤

**æ ¹æœ¬åŸå› åˆ†æ**:

æ£€æŸ¥`stopGeneration()`æ–¹æ³•ï¼ˆç¬¬360-400è¡Œï¼‰ï¼š

```kotlin
fun stopGeneration() {
    streamingJob?.cancel()
    streamingJob = null

    val messageId = _uiState.value.currentStreamingMessageId
    val currentContent = _uiState.value.streamingContent

    _uiState.update {
        it.copy(
            isStreaming = false,
            isRegenerating = false,
            streamingContent = "",  // âŒ é—®é¢˜1: ç«‹å³æ¸…ç©ºstreamingContent
            thinkingContent = "",
            thinkingElapsedMs = 0,
            currentStreamingMessageId = null  // âŒ é—®é¢˜2: ç«‹å³æ¸…ç©ºmessageId
        )
    }

    messageId?.let { id ->
        viewModelScope.launch {
            try {
                if (currentContent.isNotEmpty()) {
                    val result = aiAdvisorRepository.updateMessageContentAndStatus(
                        id,
                        currentContent + "\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]",
                        SendStatus.CANCELLED
                    )
                    if (result.isFailure) {
                        aiAdvisorRepository.deleteMessage(id)
                    }
                } else {
                    aiAdvisorRepository.deleteMessage(id)  // âŒ é—®é¢˜3: æ²¡æœ‰å†…å®¹æ—¶ç›´æ¥åˆ é™¤
                }
            } catch (e: Exception) {
                // é™é»˜å¤„ç†é”™è¯¯
            }
        }
    }
}
```

**é—®é¢˜æ ¹æº**:

1. **ç«‹å³æ¸…ç©ºUIçŠ¶æ€**: `streamingContent`å’Œ`currentStreamingMessageId`è¢«ç«‹å³æ¸…ç©ºï¼Œå¯¼è‡´`StreamingMessageBubbleSimple`ç«‹å³æ¶ˆå¤±

2. **æ•°æ®åº“æ›´æ–°å»¶è¿Ÿ**: `updateMessageContentAndStatus`æ˜¯å¼‚æ­¥æ“ä½œï¼Œåœ¨æ•°æ®åº“æ›´æ–°å®Œæˆå‰ï¼ŒUIå·²ç»æ¸…ç©º

3. **Flowæ›´æ–°å»¶è¿Ÿ**: å³ä½¿æ•°æ®åº“æ›´æ–°æˆåŠŸï¼Œ`conversations` Flowçš„æ›´æ–°ä¹Ÿéœ€è¦æ—¶é—´ï¼Œå¯¼è‡´UIå‡ºç°ç©ºç™½æœŸ

4. **æ²¡æœ‰å†…å®¹æ—¶ç›´æ¥åˆ é™¤**: å¦‚æœç”¨æˆ·åœ¨AIè¿˜æ²¡è¾“å‡ºä»»ä½•å†…å®¹æ—¶å°±åœæ­¢ï¼Œæ¶ˆæ¯ä¼šè¢«ç›´æ¥åˆ é™¤ï¼Œæ²¡æœ‰ä»»ä½•æç¤º

**æ—¶åºé—®é¢˜å›¾ç¤º**:
```
ç”¨æˆ·ç‚¹å‡»åœæ­¢
    â†“
stopGeneration() ç«‹å³æ¸…ç©º streamingContent å’Œ currentStreamingMessageId
    â†“
StreamingMessageBubbleSimple ç«‹å³æ¶ˆå¤±ï¼ˆå› ä¸º shouldShowStreamingBubble = falseï¼‰
    â†“
å¼‚æ­¥æ›´æ–°æ•°æ®åº“ï¼ˆupdateMessageContentAndStatusï¼‰
    â†“
conversations Flow æ›´æ–°ï¼ˆå»¶è¿Ÿï¼‰
    â†“
ChatBubble æ˜¾ç¤ºæ›´æ–°åçš„æ¶ˆæ¯ï¼ˆä½†æ­¤æ—¶ç”¨æˆ·å·²ç»çœ‹åˆ°ç©ºç™½ï¼‰
```

**å½±å“æ–‡ä»¶**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

---

## 3. ä¿®å¤æ–¹æ¡ˆ

### 3.1 P0-V5-001ä¿®å¤æ–¹æ¡ˆ: é˜²æ­¢åŒæ°”æ³¡æ˜¾ç¤º

**æ–¹æ¡ˆA: åœ¨UIå±‚å¢åŠ æ¶ˆæ¯IDæ£€æŸ¥**

```kotlin
// AiAdvisorChatScreen.kt ç¬¬235-245è¡Œ
// æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²åœ¨conversationsåˆ—è¡¨ä¸­ä¸”æœ‰å†…å®¹
val messageAlreadyInList = uiState.currentStreamingMessageId?.let { messageId ->
    uiState.conversations.any { it.id == messageId && it.content.isNotEmpty() }
} ?: false

val shouldShowStreamingBubble = !messageAlreadyInList && (
    (uiState.isStreaming && uiState.currentStreamingMessageId != null) ||
    (uiState.streamingContent.isNotEmpty() && uiState.currentStreamingMessageId != null)
)
```

**æ–¹æ¡ˆB: åœ¨ChatBubbleä¸­å¢åŠ IDè¿‡æ»¤**

```kotlin
// ChatBubbleç»„ä»¶ä¸­
// å¦‚æœå½“å‰æ¶ˆæ¯IDç­‰äºæ­£åœ¨æµå¼çš„æ¶ˆæ¯IDï¼Œä¸”æ­£åœ¨æµå¼ä¸­ï¼Œåˆ™ä¸æ¸²æŸ“
if (conversation.id == currentStreamingMessageId && isStreaming) {
    return
}
```

**æ¨èæ–¹æ¡ˆ**: æ–¹æ¡ˆAï¼Œåœ¨æ¸²æŸ“æµå¼æ°”æ³¡å‰æ£€æŸ¥ï¼Œæ›´åŠ æ¸…æ™°

### 3.2 P0-V5-002ä¿®å¤æ–¹æ¡ˆ: åœæ­¢ç”Ÿæˆåä¿æŒæ˜¾ç¤º

**æ–¹æ¡ˆ: å»¶è¿Ÿæ¸…ç©ºUIçŠ¶æ€ï¼Œç­‰å¾…æ•°æ®åº“æ›´æ–°å®Œæˆ**

```kotlin
fun stopGeneration() {
    streamingJob?.cancel()
    streamingJob = null

    val messageId = _uiState.value.currentStreamingMessageId
    val currentContent = _uiState.value.streamingContent

    // å…ˆæ ‡è®°ä¸ºéæµå¼çŠ¶æ€ï¼Œä½†ä¿æŒå†…å®¹æ˜¾ç¤º
    _uiState.update {
        it.copy(
            isStreaming = false,
            isRegenerating = false,
            // ä¿æŒ streamingContent å’Œ currentStreamingMessageIdï¼Œè®©UIç»§ç»­æ˜¾ç¤º
            thinkingContent = "",
            thinkingElapsedMs = 0
        )
    }

    messageId?.let { id ->
        viewModelScope.launch {
            try {
                val finalContent = if (currentContent.isNotEmpty()) {
                    currentContent + "\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
                } else {
                    "[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"  // å³ä½¿æ²¡æœ‰å†…å®¹ä¹Ÿä¿ç•™æ¶ˆæ¯
                }
                
                val result = aiAdvisorRepository.updateMessageContentAndStatus(
                    id,
                    finalContent,
                    SendStatus.CANCELLED
                )
                
                if (result.isSuccess) {
                    // ç­‰å¾…Flowæ›´æ–°
                    kotlinx.coroutines.delay(300)
                    
                    // éªŒè¯æ¶ˆæ¯å·²åœ¨åˆ—è¡¨ä¸­
                    val messageInList = _uiState.value.conversations.any { 
                        it.id == id && it.content.isNotEmpty() 
                    }
                    
                    if (messageInList) {
                        // æ¶ˆæ¯å·²æ­£ç¡®æ˜¾ç¤ºï¼Œæ¸…ç©ºæµå¼çŠ¶æ€
                        _uiState.update {
                            it.copy(
                                streamingContent = "",
                                currentStreamingMessageId = null
                            )
                        }
                    }
                } else {
                    // æ›´æ–°å¤±è´¥ï¼Œæ¸…ç©ºçŠ¶æ€å¹¶æ˜¾ç¤ºé”™è¯¯
                    _uiState.update {
                        it.copy(
                            streamingContent = "",
                            currentStreamingMessageId = null,
                            error = "ä¿å­˜æ¶ˆæ¯å¤±è´¥"
                        )
                    }
                }
            } catch (e: Exception) {
                _uiState.update {
                    it.copy(
                        streamingContent = "",
                        currentStreamingMessageId = null,
                        error = "æ“ä½œå¤±è´¥: ${e.message}"
                    )
                }
            }
        }
    }
}
```

---

## 4. ä¿®å¤ä¼˜å…ˆçº§å’Œå·¥æ—¶ä¼°ç®—

| ä¼˜å…ˆçº§ | é—®é¢˜ç¼–å· | é¢„è®¡å·¥æ—¶ | ä¿®å¤éš¾åº¦ | ä¾èµ–å…³ç³» |
|--------|----------|----------|----------|----------|
| P0 | P0-V5-001 | 1h | ä¸­ | æ—  |
| P0 | P0-V5-002 | 2h | é«˜ | æ—  |

**æ€»é¢„è®¡å·¥æ—¶**: 3å°æ—¶

---

## 5. ä¿®å¤é¡ºåºå»ºè®®

1. **P0-V5-001** - åŒæ°”æ³¡é—®é¢˜ï¼ˆUIå±‚ä¿®å¤ï¼Œé£é™©è¾ƒä½ï¼‰
2. **P0-V5-002** - åœæ­¢ç”Ÿæˆæ¶ˆå¤±é—®é¢˜ï¼ˆæ¶‰åŠçŠ¶æ€ç®¡ç†ï¼Œéœ€è¦ä»”ç»†æµ‹è¯•ï¼‰

---

## 6. æµ‹è¯•éªŒè¯æ¸…å•

ä¿®å¤å®Œæˆåï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### P0çº§æµ‹è¯•
- [ ] æµ‹è¯•1: AIå›å¤ç”Ÿæˆè¿‡ç¨‹ä¸­åªæ˜¾ç¤ºä¸€ä¸ªæ°”æ³¡
- [ ] æµ‹è¯•2: AIå›å¤å®Œæˆåï¼Œæµå¼æ°”æ³¡å¹³æ»‘è¿‡æ¸¡åˆ°æ™®é€šæ°”æ³¡
- [ ] æµ‹è¯•3: åœæ­¢ç”Ÿæˆåï¼Œæ¶ˆæ¯ä¿æŒæ˜¾ç¤ºï¼ˆå¸¦"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"æ ‡è®°ï¼‰
- [ ] æµ‹è¯•4: åœæ­¢ç”Ÿæˆåï¼Œæ˜¾ç¤º"é‡æ–°ç”Ÿæˆ"æŒ‰é’®
- [ ] æµ‹è¯•5: ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"æŒ‰é’®èƒ½æ­£å¸¸å·¥ä½œ

### å›å½’æµ‹è¯•
- [ ] æµ‹è¯•6: æ­£å¸¸æµå¼å“åº”åŠŸèƒ½ä¸å—å½±å“
- [ ] æµ‹è¯•7: ä¼šè¯åˆ‡æ¢åŠŸèƒ½æ­£å¸¸
- [ ] æµ‹è¯•8: å¤šä¼šè¯åœºæ™¯ä¸‹çŠ¶æ€éš”ç¦»æ­£ç¡®
- [ ] æµ‹è¯•9: é”™è¯¯æç¤ºå‹å¥½

---

## 7. ç›¸å…³æ–‡æ¡£

- [BUG-00044-AIå†›å¸ˆæµå¼å¯¹è¯å¤šé—®é¢˜ç³»ç»Ÿæ€§åˆ†æ](./BUG-00044-AIå†›å¸ˆæµå¼å¯¹è¯å¤šé—®é¢˜ç³»ç»Ÿæ€§åˆ†æ.md)
- [BUG-00045-AIå†›å¸ˆæµå¼å¯¹è¯äºŒæ¬¡æµ‹è¯•é—®é¢˜åˆ†æ](./BUG-00045-AIå†›å¸ˆæµå¼å¯¹è¯äºŒæ¬¡æµ‹è¯•é—®é¢˜åˆ†æ.md)
- [BUG-00046-AIå†›å¸ˆæµå¼å¯¹è¯V3é—®é¢˜ç³»ç»Ÿæ€§åˆ†æ](./BUG-00046-AIå†›å¸ˆæµå¼å¯¹è¯V3é—®é¢˜ç³»ç»Ÿæ€§åˆ†æ.md)
- [TD-00028-V5-äººå·¥ç»“æœ](../TE/TD-00028-V5-äººå·¥ç»“æœ.md)
- [FD-00028åŠŸèƒ½è®¾è®¡æ–‡æ¡£](../FD/FD-00028-AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§åŠŸèƒ½è®¾è®¡.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-01-05
**æœ€åæ›´æ–°**: 2026-01-05


---

## 8. ä¿®å¤å®ç°è®°å½•

### 8.1 ä¿®å¤æ—¥æœŸ
2026-01-05

### 8.2 ä¿®å¤å†…å®¹æ€»ç»“

| é—®é¢˜ç¼–å· | ä¿®å¤æ–¹æ¡ˆ | ä¿®æ”¹æ–‡ä»¶ |
|----------|----------|----------|
| P0-V5-001 | åœ¨UIå±‚å¢åŠ æ¶ˆæ¯IDæ£€æŸ¥ï¼Œé¿å…æµå¼æ°”æ³¡å’Œæ•°æ®åº“æ¶ˆæ¯åŒæ—¶æ˜¾ç¤º | AiAdvisorChatScreen.kt |
| P0-V5-002 | å»¶è¿Ÿæ¸…ç©ºUIçŠ¶æ€ï¼Œç­‰å¾…æ•°æ®åº“æ›´æ–°å®Œæˆï¼›å³ä½¿æ— å†…å®¹ä¹Ÿä¿ç•™æ¶ˆæ¯ | AiAdvisorChatViewModel.kt |

### 8.3 å…³é”®ä»£ç å˜æ›´

#### 8.3.1 P0-V5-001ä¿®å¤ï¼šé˜²æ­¢åŒæ°”æ³¡æ˜¾ç¤º

**æ–‡ä»¶**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

```kotlin
// BUG-047-P0-V5-001ä¿®å¤ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²åœ¨conversationsåˆ—è¡¨ä¸­ä¸”æœ‰å†…å®¹ï¼Œé¿å…åŒæ°”æ³¡
val messageAlreadyInList = uiState.currentStreamingMessageId?.let { messageId ->
    uiState.conversations.any { it.id == messageId && it.content.isNotEmpty() }
} ?: false

val shouldShowStreamingBubble = !messageAlreadyInList && (
    (uiState.isStreaming && uiState.currentStreamingMessageId != null) ||
    (uiState.streamingContent.isNotEmpty() && uiState.currentStreamingMessageId != null)
)
```

**ä¿®å¤åŸç†**:
- åœ¨æ¸²æŸ“æµå¼æ°”æ³¡å‰ï¼Œæ£€æŸ¥å½“å‰æµå¼æ¶ˆæ¯IDæ˜¯å¦å·²å­˜åœ¨äºconversationsåˆ—è¡¨ä¸­
- å¦‚æœæ¶ˆæ¯å·²åœ¨åˆ—è¡¨ä¸­ä¸”æœ‰å†…å®¹ï¼Œè¯´æ˜æ•°æ®åº“å·²æ›´æ–°ï¼Œä¸å†éœ€è¦æ˜¾ç¤ºæµå¼æ°”æ³¡
- è¿™æ ·å¯ä»¥é¿å…æµå¼æ°”æ³¡å’Œæ•°æ®åº“æ¶ˆæ¯åŒæ—¶æ˜¾ç¤ºçš„é—®é¢˜

#### 8.3.2 P0-V5-002ä¿®å¤ï¼šåœæ­¢ç”Ÿæˆåä¿æŒæ˜¾ç¤º

**æ–‡ä»¶**: `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

```kotlin
fun stopGeneration() {
    streamingJob?.cancel()
    streamingJob = null

    val messageId = _uiState.value.currentStreamingMessageId
    val currentContent = _uiState.value.streamingContent

    // BUG-047-P0-V5-002ä¿®å¤ï¼šå…ˆæ ‡è®°ä¸ºéæµå¼çŠ¶æ€ï¼Œä½†ä¿æŒå†…å®¹æ˜¾ç¤º
    _uiState.update {
        it.copy(
            isStreaming = false,
            isRegenerating = false,
            // ä¿æŒ streamingContent å’Œ currentStreamingMessageIdï¼Œè®©UIç»§ç»­æ˜¾ç¤º
            thinkingContent = "",
            thinkingElapsedMs = 0
        )
    }

    messageId?.let { id ->
        viewModelScope.launch {
            try {
                // å³ä½¿æ²¡æœ‰å†…å®¹ä¹Ÿä¿ç•™æ¶ˆæ¯ï¼Œæ˜¾ç¤º"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
                val finalContent = if (currentContent.isNotEmpty()) {
                    currentContent + "\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
                } else {
                    "[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
                }
                
                val result = aiAdvisorRepository.updateMessageContentAndStatus(
                    id,
                    finalContent,
                    SendStatus.CANCELLED
                )
                
                if (result.isSuccess) {
                    // ç­‰å¾…Flowæ›´æ–°ï¼Œç¡®ä¿æ¶ˆæ¯å·²åœ¨åˆ—è¡¨ä¸­
                    kotlinx.coroutines.delay(300)
                    
                    // éªŒè¯æ¶ˆæ¯å·²åœ¨åˆ—è¡¨ä¸­åå†æ¸…ç©ºæµå¼çŠ¶æ€
                    val messageInList = _uiState.value.conversations.any { 
                        it.id == id && it.content.isNotEmpty() 
                    }
                    
                    if (messageInList) {
                        _uiState.update {
                            it.copy(
                                streamingContent = "",
                                currentStreamingMessageId = null
                            )
                        }
                    }
                }
                // ... é”™è¯¯å¤„ç†
            }
        }
    }
}
```

**ä¿®å¤åŸç†**:
1. ä¸å†ç«‹å³æ¸…ç©º`streamingContent`å’Œ`currentStreamingMessageId`ï¼Œè®©UIç»§ç»­æ˜¾ç¤ºæµå¼æ°”æ³¡
2. å³ä½¿æ²¡æœ‰å†…å®¹ä¹Ÿä¿ç•™æ¶ˆæ¯ï¼Œæ˜¾ç¤º"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"æ ‡è®°
3. ç­‰å¾…æ•°æ®åº“æ›´æ–°å®Œæˆï¼ˆ300mså»¶è¿Ÿï¼‰åï¼ŒéªŒè¯æ¶ˆæ¯å·²åœ¨åˆ—è¡¨ä¸­
4. åªæœ‰å½“æ¶ˆæ¯æ­£ç¡®æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­åï¼Œæ‰æ¸…ç©ºæµå¼çŠ¶æ€

### 8.4 ç¼–è¯‘çŠ¶æ€

```
âœ… getDiagnostics - æ— è¯­æ³•é”™è¯¯
âœ… AiAdvisorChatScreen.kt - æ— è¯Šæ–­é—®é¢˜
âœ… AiAdvisorChatViewModel.kt - æ— è¯Šæ–­é—®é¢˜
```

### 8.5 å¾…äººå·¥éªŒè¯

è¯·æŒ‰ç…§TE-00028-V6æµ‹è¯•ç”¨ä¾‹è¿›è¡Œäººå·¥éªŒè¯ï¼Œé‡ç‚¹æµ‹è¯•ï¼š
1. TC-001~TC-003: åŒæ°”æ³¡é—®é¢˜æµ‹è¯•
2. TC-004~TC-006: åœæ­¢ç”Ÿæˆé—®é¢˜æµ‹è¯•
3. TC-007~TC-009: å›å½’æµ‹è¯•

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1
**æœ€åæ›´æ–°**: 2026-01-05
