# BUG-00048-V4-ç»ˆæ­¢åé‡æ–°ç”Ÿæˆæ¶ˆæ¯è§’è‰²é”™è¯¯æ·±åº¦åˆ†æ

## ğŸš¨ æ¶æ„å¸ˆåˆ†ææŠ¥å‘Š

---

## 1. ä¸Šä¸‹æ–‡æ”¶é›†

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£ç¼–å·** | BUG-00048-V4 |
| **åˆ›å»ºæ—¥æœŸ** | 2026-01-05 |
| **é—®é¢˜æ¥æº** | TD-00028-V6-äººå·¥ç»“æœ.md |
| **ä¼˜å…ˆçº§** | P0 (ä¸¥é‡) |
| **çŠ¶æ€** | ğŸ”´ æ·±åº¦åˆ†æä¸­ |
| **å…³è”ä»»åŠ¡** | TD-00028 AIå†›å¸ˆæµå¼å¯¹è¯åŠŸèƒ½ |
| **å…³è”PRD** | PRD-00026 AIå†›å¸ˆå¯¹è¯åŠŸèƒ½éœ€æ±‚ |
| **å…³è”TDD** | TDD-00026 AIå†›å¸ˆå¯¹è¯åŠŸèƒ½æŠ€æœ¯è®¾è®¡ |
| **è°ƒç”¨æŠ€èƒ½** | debugging-strategies, code-quality-analyzer, code-pattern-detector |

---

## 2. é—®é¢˜ç°è±¡ï¼ˆæ¥è‡ªTD-00028-V6äººå·¥æµ‹è¯•ï¼‰

### 2.1 ç”¨æˆ·åé¦ˆåŸæ–‡
> "å½“æˆ‘ä»¬ç»ˆæ­¢äº†AIçš„å›å¤è¿‡åï¼Œå†ç‚¹é‡æ–°ç”Ÿæˆçš„æ—¶å€™ï¼Œä»–ä¼šæŠŠç»ˆæ­¢çš„å†…å®¹å½“åšç”¨æˆ·çš„å‘é€çš„ä¿¡æ¯ï¼Œæ˜¾ç¤ºæˆUI"

### 2.2 æˆªå›¾åˆ†æ

ä»æˆªå›¾å¯ä»¥è§‚å¯Ÿåˆ°ï¼š
- **å³ä¾§è“è‰²æ°”æ³¡**ï¼šæ˜¾ç¤º"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]" - è¿™æ˜¯**ç”¨æˆ·æ¶ˆæ¯æ ·å¼**
- **å·¦ä¾§ç™½è‰²æ°”æ³¡**ï¼šæ˜¾ç¤º"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]" - è¿™æ˜¯**AIæ¶ˆæ¯æ ·å¼**

**å…³é”®å‘ç°**ï¼šåŒä¸€å†…å®¹"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"è¢«æ˜¾ç¤ºäº†ä¸¤æ¬¡ï¼Œä¸€æ¬¡ä½œä¸ºç”¨æˆ·æ¶ˆæ¯ï¼Œä¸€æ¬¡ä½œä¸ºAIæ¶ˆæ¯ã€‚

### 2.3 é¢„æœŸè¡Œä¸º
1. ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"åï¼Œåº”è¯¥åˆ é™¤è¢«åœæ­¢çš„AIæ¶ˆæ¯
2. ä½¿ç”¨**åŸå§‹ç”¨æˆ·è¾“å…¥**é‡æ–°ç”ŸæˆAIå›å¤
3. **ä¸åº”è¯¥å‡ºç°ä»»ä½•æ–°çš„ç”¨æˆ·æ¶ˆæ¯**

### 2.4 å®é™…è¡Œä¸º
1. è¢«åœæ­¢çš„AIæ¶ˆæ¯å†…å®¹"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"è¢«é”™è¯¯åœ°å½“ä½œç”¨æˆ·æ¶ˆæ¯å‘é€
2. å‡ºç°äº†ä¸¤ä¸ªæ°”æ³¡ï¼šä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯ï¼ˆè“è‰²ï¼‰ï¼Œä¸€ä¸ªAIæ¶ˆæ¯ï¼ˆç™½è‰²ï¼‰

---

## 3. æœºåˆ¶å¤ç›˜

### 3.1 æ­£å¸¸æµç¨‹æ—¶åºå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚     â”‚  ViewModel   â”‚     â”‚  UseCase    â”‚     â”‚ Database â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                    â”‚                 â”‚
     â”‚ 1. å‘é€æ¶ˆæ¯     â”‚                    â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                 â”‚
     â”‚                 â”‚ lastUserInput=msg  â”‚                 â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                 â”‚
     â”‚                 â”‚                    â”‚ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯    â”‚
     â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚                    â”‚ åˆ›å»ºAIå ä½æ¶ˆæ¯  â”‚
     â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚                    â”‚                 â”‚
     â”‚ 2. ç‚¹å‡»åœæ­¢     â”‚                    â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                 â”‚
     â”‚                 â”‚ æ›´æ–°AIæ¶ˆæ¯å†…å®¹     â”‚                 â”‚
     â”‚                 â”‚ "[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]" â”‚                 â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚                    â”‚                 â”‚
     â”‚ 3. ç‚¹å‡»é‡æ–°ç”Ÿæˆ â”‚                    â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                 â”‚
     â”‚                 â”‚ è·å–lastUserInput  â”‚                 â”‚
     â”‚                 â”‚ (åº”è¯¥æ˜¯åŸå§‹æ¶ˆæ¯)   â”‚                 â”‚
     â”‚                 â”‚ åˆ é™¤AIæ¶ˆæ¯         â”‚                 â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚ è°ƒç”¨regenerateStreaming             â”‚
     â”‚                 â”‚ (skipUserMessage=true)              â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                 â”‚
     â”‚                 â”‚                    â”‚ åªåˆ›å»ºAIæ¶ˆæ¯    â”‚
     â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
```

### 3.2 é—®é¢˜æµç¨‹åˆ†æ

**é—®é¢˜å‘ç”Ÿåœ¨æ­¥éª¤3**ï¼šå½“`lastUserInput`ä¸ºç©ºæˆ–è·å–å¤±è´¥æ—¶ï¼Œä»£ç ä¼šå›é€€åˆ°ä»`conversations`åˆ—è¡¨æŸ¥æ‰¾ç”¨æˆ·æ¶ˆæ¯ã€‚

```kotlin
val userInputToUse = _uiState.value.lastUserInput.ifEmpty {
    conversations
        .filter { 
            it.messageType == MessageType.USER && 
            it.sendStatus == SendStatus.SUCCESS &&
            it.timestamp < lastAiMessage.timestamp
        }
        .maxByOrNull { it.timestamp }
        ?.content ?: ""
}
```

### 3.3 V3ä¿®å¤çš„å±€é™æ€§

V3ä¿®å¤æ·»åŠ äº†æ—¶é—´æˆ³çº¦æŸï¼Œä½†**æ²¡æœ‰è§£å†³æ ¹æœ¬é—®é¢˜**ï¼š

1. **Flowæ›´æ–°å»¶è¿Ÿ**ï¼šåˆ é™¤AIæ¶ˆæ¯åï¼Œ`conversations`åˆ—è¡¨å¯èƒ½è¿˜æ²¡æœ‰æ›´æ–°
2. **lastUserInputä¸¢å¤±åœºæ™¯**ï¼š
   - åº”ç”¨é‡å¯å`lastUserInput`ä¸ºç©º
   - ViewModelé‡å»ºå`lastUserInput`ä¸ºç©º
   - æŸäº›è¾¹ç¼˜æƒ…å†µä¸‹çŠ¶æ€è¢«é‡ç½®

---

## 4. æ ¹å› æ¨å¯¼ï¼ˆRoot Cause Treeï¼‰

```
é—®é¢˜ï¼šé‡æ–°ç”Ÿæˆæ—¶æ¶ˆæ¯è§’è‰²é”™è¯¯
â”‚
â”œâ”€â”€ æ¡†æ¶æœºåˆ¶å±‚
â”‚   â”œâ”€â”€ Flowæ›´æ–°å»¶è¿Ÿï¼ˆRoom Flowé€šçŸ¥æœ‰å»¶è¿Ÿï¼‰
â”‚   â””â”€â”€ StateFlowçŠ¶æ€ç®¡ç†ï¼ˆlastUserInputæœªæŒä¹…åŒ–ï¼‰
â”‚
â”œâ”€â”€ æ¨¡å—äº¤äº’å±‚
â”‚   â”œâ”€â”€ ViewModelä¸Repositoryçš„å¼‚æ­¥é€šä¿¡
â”‚   â””â”€â”€ åˆ é™¤æ“ä½œä¸æŸ¥è¯¢æ“ä½œçš„æ—¶åºé—®é¢˜
â”‚
â”œâ”€â”€ è¾¹ç•Œæ¡ä»¶å±‚
â”‚   â”œâ”€â”€ lastUserInputä¸ºç©ºçš„åœºæ™¯
â”‚   â”‚   â”œâ”€â”€ åº”ç”¨é‡å¯
â”‚   â”‚   â”œâ”€â”€ ViewModelé‡å»º
â”‚   â”‚   â””â”€â”€ çŠ¶æ€æ„å¤–é‡ç½®
â”‚   â””â”€â”€ conversationsåˆ—è¡¨æœªåŠæ—¶æ›´æ–°
â”‚
â”œâ”€â”€ å¼‚å¸¸è·¯å¾„å±‚
â”‚   â”œâ”€â”€ å¿«é€Ÿè¿ç»­æ“ä½œï¼ˆåœæ­¢â†’ç«‹å³é‡æ–°ç”Ÿæˆï¼‰
â”‚   â””â”€â”€ ç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„çŠ¶æ€ä¸ä¸€è‡´
â”‚
â””â”€â”€ ç¯å¢ƒå› ç´ å±‚
    â””â”€â”€ è®¾å¤‡æ€§èƒ½å·®å¼‚å¯¼è‡´çš„æ—¶åºé—®é¢˜
```

### 4.1 æ ¸å¿ƒæ ¹å› ï¼ˆV4ç»“è®ºï¼‰

**æ ¹å› 1ï¼š`lastUserInput`æœªæŒä¹…åŒ–**
- `lastUserInput`åªå­˜å‚¨åœ¨å†…å­˜ä¸­çš„`UiState`
- åº”ç”¨é‡å¯ã€ViewModelé‡å»ºåä¼šä¸¢å¤±
- è¿™æ˜¯V3ä¿®å¤æœªèƒ½è§£å†³çš„æ ¹æœ¬é—®é¢˜

**æ ¹å› 2ï¼šå›é€€æŸ¥è¯¢é€»è¾‘å­˜åœ¨ç¼ºé™·**
- å½“`lastUserInput`ä¸ºç©ºæ—¶ï¼Œä»`conversations`æŸ¥æ‰¾
- ä½†å¦‚æœ`conversations`åˆ—è¡¨è¿˜æ²¡æœ‰æ›´æ–°ï¼ˆFlowå»¶è¿Ÿï¼‰ï¼Œå¯èƒ½æŸ¥æ‰¾åˆ°é”™è¯¯çš„æ¶ˆæ¯
- æˆ–è€…æ ¹æœ¬æ‰¾ä¸åˆ°ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·æ¶ˆæ¯

**æ ¹å› 3ï¼šæ—¶åºé—®é¢˜**
- åˆ é™¤AIæ¶ˆæ¯åï¼Œéœ€è¦ç­‰å¾…Flowæ›´æ–°
- 200msçš„å»¶è¿Ÿå¯èƒ½ä¸å¤Ÿ
- åœ¨é«˜è´Ÿè½½æˆ–ä½æ€§èƒ½è®¾å¤‡ä¸Šé—®é¢˜æ›´æ˜æ˜¾

---

## 5. è§£å†³æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ Aï¼ˆä¿å®ˆï¼‰ï¼šå¢åŠ å»¶è¿Ÿæ—¶é—´ + é‡è¯•æœºåˆ¶

**å†…å®¹**ï¼š
```kotlin
fun regenerateLastMessage() {
    viewModelScope.launch {
        // åˆ é™¤AIæ¶ˆæ¯
        deleteAdvisorConversationUseCase(lastAiMessage.id)
        
        // å¢åŠ å»¶è¿Ÿåˆ°500ms
        kotlinx.coroutines.delay(500)
        
        // é‡æ–°è·å–conversations
        val updatedConversations = _uiState.value.conversations
        
        // éªŒè¯AIæ¶ˆæ¯å·²è¢«åˆ é™¤
        val aiMessageStillExists = updatedConversations.any { it.id == lastAiMessage.id }
        if (aiMessageStillExists) {
            // é‡è¯•
            kotlinx.coroutines.delay(300)
        }
        
        regenerateStreaming(userInputToUse, sessionId)
    }
}
```

**ä¼˜ç‚¹**ï¼š
- ä¿®æ”¹é‡å°
- é£é™©ä½

**âŒ åé©³**ï¼š
- æ²»æ ‡ä¸æ²»æœ¬ï¼Œå»¶è¿Ÿæ—¶é—´æ˜¯"é­”æ³•æ•°å­—"
- åœ¨ä½æ€§èƒ½è®¾å¤‡ä¸Šå¯èƒ½ä»ç„¶å¤±è´¥
- ç”¨æˆ·ä½“éªŒå·®ï¼ˆç­‰å¾…æ—¶é—´é•¿ï¼‰
- æ²¡æœ‰è§£å†³`lastUserInput`ä¸¢å¤±çš„æ ¹æœ¬é—®é¢˜

---

### æ–¹æ¡ˆ Bï¼ˆæ¨èï¼‰ï¼šæŒä¹…åŒ–ç”¨æˆ·è¾“å…¥ + æ¶ˆæ¯å…³è”

**å†…å®¹**ï¼š

1. **åœ¨AIæ¶ˆæ¯ä¸­å­˜å‚¨åŸå§‹ç”¨æˆ·è¾“å…¥**ï¼š
```kotlin
// ä¿®æ”¹AiAdvisorConversationæ¨¡å‹ï¼Œæ·»åŠ metadataå­—æ®µ
data class AiAdvisorConversation(
    // ... ç°æœ‰å­—æ®µ
    val metadata: String = "" // JSONæ ¼å¼ï¼Œå­˜å‚¨originalUserInputç­‰
)
```

2. **åœ¨stopGenerationæ—¶ä¿å­˜åŸå§‹ç”¨æˆ·è¾“å…¥**ï¼š
```kotlin
fun stopGeneration() {
    val currentContent = _uiState.value.streamingContent
    val originalUserInput = _uiState.value.lastUserInput
    
    messageId?.let { id ->
        val metadata = """{"originalUserInput":"$originalUserInput"}"""
        aiAdvisorRepository.updateAiMessageWithMetadata(
            id, finalContent, SendStatus.CANCELLED, metadata
        )
    }
}
```

3. **åœ¨regenerateLastMessageæ—¶ä»metadataè·å–**ï¼š
```kotlin
fun regenerateLastMessage() {
    val lastAiMessage = conversations
        .filter { it.messageType == MessageType.AI }
        .maxByOrNull { it.timestamp }
    
    // ä¼˜å…ˆä»metadataè·å–åŸå§‹ç”¨æˆ·è¾“å…¥
    val userInputToUse = parseOriginalUserInput(lastAiMessage?.metadata)
        .ifEmpty { _uiState.value.lastUserInput }
        .ifEmpty { findLastUserMessageContent() }
    
    // ...
}
```

**ä¼˜åŠ¿**ï¼š
- ä»æ ¹æœ¬ä¸Šè§£å†³`lastUserInput`ä¸¢å¤±é—®é¢˜
- åŸå§‹ç”¨æˆ·è¾“å…¥ä¸AIæ¶ˆæ¯å…³è”ï¼Œä¸ä¼šä¸¢å¤±
- å³ä½¿åº”ç”¨é‡å¯ä¹Ÿèƒ½æ­£ç¡®é‡æ–°ç”Ÿæˆ
- ä¸ä¾èµ–æ—¶åºå’Œå»¶è¿Ÿ

**Trade-off**ï¼š
- éœ€è¦ä¿®æ”¹æ•°æ®æ¨¡å‹ï¼ˆæ·»åŠ metadataå­—æ®µï¼‰
- éœ€è¦æ•°æ®åº“è¿ç§»
- ä¿®æ”¹é‡è¾ƒå¤§

---

### æ–¹æ¡ˆ Cï¼ˆæŠ˜ä¸­æ¨èï¼‰ï¼šåŒé‡ä¿éšœæœºåˆ¶

**å†…å®¹**ï¼š

1. **åœ¨AIæ¶ˆæ¯åˆ›å»ºæ—¶ï¼ŒåŒæ—¶ä¿å­˜å…³è”çš„ç”¨æˆ·æ¶ˆæ¯ID**ï¼š
```kotlin
// åœ¨SendAdvisorMessageStreamingUseCaseä¸­
val aiMessage = AiAdvisorConversation(
    id = aiMessageId,
    // ... å…¶ä»–å­—æ®µ
    relatedUserMessageId = userMessageId // æ–°å¢å­—æ®µ
)
```

2. **åœ¨regenerateLastMessageæ—¶ï¼Œé€šè¿‡å…³è”IDæŸ¥æ‰¾ç”¨æˆ·æ¶ˆæ¯**ï¼š
```kotlin
fun regenerateLastMessage() {
    val lastAiMessage = findLastAiMessage()
    
    // æ–¹å¼1ï¼šä¼˜å…ˆä½¿ç”¨lastUserInput
    // æ–¹å¼2ï¼šé€šè¿‡relatedUserMessageIdæŸ¥æ‰¾
    // æ–¹å¼3ï¼šæ—¶é—´æˆ³å›é€€æŸ¥æ‰¾
    val userInputToUse = _uiState.value.lastUserInput.ifEmpty {
        lastAiMessage?.relatedUserMessageId?.let { userId ->
            conversations.find { it.id == userId }?.content
        } ?: findLastUserMessageByTimestamp()
    }
}
```

**ä¼˜åŠ¿**ï¼š
- ä¸éœ€è¦å¤æ‚çš„metadataè§£æ
- é€šè¿‡IDå…³è”ï¼ŒæŸ¥æ‰¾æ›´å¯é 
- ä¿®æ”¹é‡é€‚ä¸­

**Trade-off**ï¼š
- éœ€è¦æ·»åŠ æ–°å­—æ®µ
- éœ€è¦æ•°æ®åº“è¿ç§»

---

## 6. âœ… æœ€ç»ˆæ¨è: æ–¹æ¡ˆ Cï¼ˆåŒé‡ä¿éšœæœºåˆ¶ï¼‰

### 6.1 æ¨èç†ç”±

1. **å¯é æ€§é«˜**ï¼šé€šè¿‡IDå…³è”ï¼Œä¸ä¾èµ–æ—¶åº
2. **ä¿®æ”¹é‡é€‚ä¸­**ï¼šåªéœ€æ·»åŠ ä¸€ä¸ªå­—æ®µ
3. **å‘åå…¼å®¹**ï¼šæ—§æ•°æ®å¯ä»¥å›é€€åˆ°æ—¶é—´æˆ³æŸ¥æ‰¾
4. **æ€§èƒ½å¥½**ï¼šIDæŸ¥æ‰¾æ¯”æ—¶é—´æˆ³è¿‡æ»¤æ›´å¿«

### 6.2 å®æ–½æ­¥éª¤

#### æ­¥éª¤1ï¼šä¿®æ”¹æ•°æ®æ¨¡å‹

```kotlin
// domain/model/AiAdvisorConversation.kt
data class AiAdvisorConversation(
    val id: String,
    val contactId: String,
    val sessionId: String,
    val messageType: MessageType,
    val content: String,
    val timestamp: Long,
    val sendStatus: SendStatus,
    val createdAt: Long = timestamp,
    val relatedUserMessageId: String? = null // æ–°å¢ï¼šå…³è”çš„ç”¨æˆ·æ¶ˆæ¯ID
)
```

#### æ­¥éª¤2ï¼šä¿®æ”¹æ•°æ®åº“Entity

```kotlin
// data/local/entity/AiAdvisorConversationEntity.kt
@ColumnInfo(name = "related_user_message_id", defaultValue = "")
val relatedUserMessageId: String = ""
```

#### æ­¥éª¤3ï¼šæ·»åŠ æ•°æ®åº“è¿ç§»

```kotlin
// Migration_12_13
val MIGRATION_12_13 = object : Migration(12, 13) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL(
            "ALTER TABLE ai_advisor_conversations ADD COLUMN related_user_message_id TEXT DEFAULT ''"
        )
    }
}
```

#### æ­¥éª¤4ï¼šä¿®æ”¹UseCase

```kotlin
// SendAdvisorMessageStreamingUseCase.kt
operator fun invoke(...): Flow<StreamingState> = flow {
    // 1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
    val userMessageId = UUID.randomUUID().toString()
    if (!skipUserMessage) {
        val userConversation = AiAdvisorConversation(
            id = userMessageId,
            // ...
        )
        aiAdvisorRepository.saveMessage(userConversation)
    }
    
    // 2. åˆ›å»ºAIæ¶ˆæ¯ï¼Œå…³è”ç”¨æˆ·æ¶ˆæ¯ID
    val aiMessage = AiAdvisorConversation(
        id = aiMessageId,
        // ...
        relatedUserMessageId = if (!skipUserMessage) userMessageId else null
    )
}
```

#### æ­¥éª¤5ï¼šä¿®æ”¹ViewModel

```kotlin
// AiAdvisorChatViewModel.kt
fun regenerateLastMessage() {
    val lastAiMessage = findLastAiMessage() ?: return
    
    // ä¸‰é‡ä¿éšœè·å–ç”¨æˆ·è¾“å…¥
    val userInputToUse = getUserInputForRegenerate(lastAiMessage)
    
    if (userInputToUse.isEmpty()) {
        _uiState.update { it.copy(error = "æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç”¨æˆ·æ¶ˆæ¯") }
        return
    }
    
    // åˆ é™¤å¹¶é‡æ–°ç”Ÿæˆ
    viewModelScope.launch {
        deleteAndRegenerate(lastAiMessage.id, userInputToUse, sessionId)
    }
}

private fun getUserInputForRegenerate(lastAiMessage: AiAdvisorConversation): String {
    // ä¼˜å…ˆçº§1ï¼šä½¿ç”¨å†…å­˜ä¸­çš„lastUserInput
    val fromMemory = _uiState.value.lastUserInput
    if (fromMemory.isNotEmpty()) return fromMemory
    
    // ä¼˜å…ˆçº§2ï¼šé€šè¿‡å…³è”IDæŸ¥æ‰¾
    val fromRelatedId = lastAiMessage.relatedUserMessageId?.let { userId ->
        _uiState.value.conversations.find { it.id == userId }?.content
    }
    if (!fromRelatedId.isNullOrEmpty()) return fromRelatedId
    
    // ä¼˜å…ˆçº§3ï¼šæ—¶é—´æˆ³å›é€€æŸ¥æ‰¾
    return _uiState.value.conversations
        .filter { 
            it.messageType == MessageType.USER && 
            it.sendStatus == SendStatus.SUCCESS &&
            it.timestamp < lastAiMessage.timestamp
        }
        .maxByOrNull { it.timestamp }
        ?.content ?: ""
}
```

---

## 7. ä¸“å®¶å»ºè®®

### 7.1 è§„èŒƒæ£€æŸ¥

| è§„èŒƒ | æ£€æŸ¥ç»“æœ |
|------|----------|
| Clean Architecture | âœ… ä¿®æ”¹ç¬¦åˆåˆ†å±‚åŸåˆ™ |
| SOLIDåŸåˆ™ | âœ… å•ä¸€èŒè´£ï¼Œæ¥å£éš”ç¦» |
| Roomæœ€ä½³å®è·µ | âœ… ä½¿ç”¨Migrationï¼Œä¸ç ´åæ•°æ® |
| Kotlinæƒ¯ç”¨æ³• | âœ… ä½¿ç”¨ç©ºå®‰å…¨å’Œæ‰©å±•å‡½æ•° |

### 7.2 å½±å“è¯„ä¼°

| å½±å“èŒƒå›´ | é£é™©ç­‰çº§ | è¯´æ˜ |
|----------|----------|------|
| æ•°æ®åº“è¿ç§» | ä¸­ | éœ€è¦æ·»åŠ æ–°å­—æ®µï¼Œä½†æœ‰é»˜è®¤å€¼ |
| ç°æœ‰æ•°æ® | ä½ | æ—§æ•°æ®relatedUserMessageIdä¸ºç©ºï¼Œå›é€€åˆ°æ—¶é—´æˆ³æŸ¥æ‰¾ |
| æ€§èƒ½ | ä½ | IDæŸ¥æ‰¾æ¯”æ—¶é—´æˆ³è¿‡æ»¤æ›´å¿« |
| æµ‹è¯• | ä¸­ | éœ€è¦æ›´æ–°ç°æœ‰æµ‹è¯•ï¼Œæ·»åŠ æ–°æµ‹è¯• |

### 7.3 é—®é¢˜è®°å½•æ–‡æ¡£è‰ç¨¿

```markdown
## é—®é¢˜è®°å½•
- **ç°è±¡**: ç»ˆæ­¢AIç”Ÿæˆåç‚¹å‡»é‡æ–°ç”Ÿæˆï¼Œè¢«åœæ­¢çš„å†…å®¹è¢«é”™è¯¯åœ°æ˜¾ç¤ºä¸ºç”¨æˆ·æ¶ˆæ¯
- **æ ¹å› **: lastUserInputæœªæŒä¹…åŒ–ï¼Œå›é€€æŸ¥è¯¢é€»è¾‘å­˜åœ¨æ—¶åºé—®é¢˜
- **æ–¹æ¡ˆA**: å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼ˆæ²»æ ‡ä¸æ²»æœ¬ï¼‰
- **æ–¹æ¡ˆB**: æŒä¹…åŒ–ç”¨æˆ·è¾“å…¥åˆ°metadataï¼ˆä¿®æ”¹é‡å¤§ï¼‰
- **æ–¹æ¡ˆC**: æ·»åŠ relatedUserMessageIdå…³è”ï¼ˆæ¨èï¼‰
- **ç»“è®º**: é‡‡ç”¨æ–¹æ¡ˆCï¼Œé€šè¿‡IDå…³è”ç¡®ä¿å¯é è·å–åŸå§‹ç”¨æˆ·è¾“å…¥
- **å…³è”æ–‡æ¡£**: PRD-00026, TDD-00026, TD-00028
```

---

## 8. æµ‹è¯•ç”¨ä¾‹è®¾è®¡

### 8.1 å•å…ƒæµ‹è¯•

| æµ‹è¯•ID | æµ‹è¯•åœºæ™¯ | é¢„æœŸç»“æœ |
|--------|----------|----------|
| TC-V4-001 | lastUserInputæœ‰å€¼æ—¶é‡æ–°ç”Ÿæˆ | ä½¿ç”¨lastUserInput |
| TC-V4-002 | lastUserInputä¸ºç©ºï¼ŒrelatedUserMessageIdæœ‰å€¼ | é€šè¿‡IDæŸ¥æ‰¾ç”¨æˆ·æ¶ˆæ¯ |
| TC-V4-003 | ä¸¤è€…éƒ½ä¸ºç©ºï¼Œæ—¶é—´æˆ³å›é€€ | ä½¿ç”¨æ—¶é—´æˆ³æŸ¥æ‰¾ |
| TC-V4-004 | ä¸‰è€…éƒ½ä¸ºç©º | æ˜¾ç¤ºé”™è¯¯æç¤º |
| TC-V4-005 | åº”ç”¨é‡å¯åé‡æ–°ç”Ÿæˆ | é€šè¿‡relatedUserMessageIdæ­£ç¡®è·å– |
| TC-V4-006 | å¿«é€Ÿåœæ­¢åç«‹å³é‡æ–°ç”Ÿæˆ | æ­£ç¡®ä½¿ç”¨åŸå§‹ç”¨æˆ·è¾“å…¥ |
| TC-V4-007 | å¤šè½®å¯¹è¯åé‡æ–°ç”Ÿæˆ | ä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·æ¶ˆæ¯ |

### 8.2 äººå·¥æµ‹è¯•

| æµ‹è¯•ID | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ |
|--------|----------|----------|
| MT-V4-001 | å‘é€æ¶ˆæ¯â†’åœæ­¢â†’é‡æ–°ç”Ÿæˆ | ä½¿ç”¨åŸå§‹æ¶ˆæ¯é‡æ–°ç”Ÿæˆï¼Œæ— æ–°ç”¨æˆ·æ¶ˆæ¯ |
| MT-V4-002 | å‘é€æ¶ˆæ¯â†’åœæ­¢â†’é‡å¯åº”ç”¨â†’é‡æ–°ç”Ÿæˆ | æ­£ç¡®é‡æ–°ç”Ÿæˆ |
| MT-V4-003 | å¿«é€Ÿè¿ç»­æ“ä½œ | ä¸å‡ºç°æ¶ˆæ¯è§’è‰²é”™è¯¯ |

---

## 9. å®æ–½è®¡åˆ’

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|----------|
| 1 | ç¼–å†™æµ‹è¯•ç”¨ä¾‹ | 30åˆ†é’Ÿ |
| 2 | ä¿®æ”¹æ•°æ®æ¨¡å‹ | 15åˆ†é’Ÿ |
| 3 | æ·»åŠ æ•°æ®åº“è¿ç§» | 15åˆ†é’Ÿ |
| 4 | ä¿®æ”¹UseCase | 30åˆ†é’Ÿ |
| 5 | ä¿®æ”¹ViewModel | 30åˆ†é’Ÿ |
| 6 | è¿è¡Œæµ‹è¯•éªŒè¯ | 15åˆ†é’Ÿ |
| 7 | æ„å»ºAPKæµ‹è¯• | 15åˆ†é’Ÿ |

**æ€»è®¡**: çº¦2.5å°æ—¶

---

**æ–‡æ¡£ç‰ˆæœ¬**: 4.0
**æœ€åæ›´æ–°**: 2026-01-05
**ä¿®å¤çŠ¶æ€**: ğŸŸ¢ ä»£ç ä¿®æ”¹å·²å®Œæˆï¼Œå¾…æ„å»ºéªŒè¯

## 10. ä»£ç ä¿®æ”¹è®°å½•

### 10.1 å·²å®Œæˆçš„ä¿®æ”¹

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|------|----------|------|
| `domain/model/AiAdvisorConversation.kt` | æ·»åŠ `relatedUserMessageId`å­—æ®µ | âœ… å®Œæˆ |
| `data/local/entity/AiAdvisorConversationEntity.kt` | æ·»åŠ `related_user_message_id`åˆ— | âœ… å®Œæˆ |
| `data/di/DatabaseModule.kt` | æ·»åŠ MIGRATION_14_15è¿ç§»è„šæœ¬ | âœ… å®Œæˆ |
| `data/local/AppDatabase.kt` | ç‰ˆæœ¬å·ä»14å‡çº§åˆ°15 | âœ… å®Œæˆ |
| `domain/usecase/SendAdvisorMessageStreamingUseCase.kt` | æ·»åŠ relatedUserMessageIdå‚æ•°å’Œè®¾ç½®é€»è¾‘ | âœ… å®Œæˆ |
| `presentation/viewmodel/AiAdvisorChatViewModel.kt` | æ·»åŠ getUserInputForRegenerateæ–¹æ³•ï¼Œä¿®æ”¹regenerateLastMessageå’ŒregenerateStreaming | âœ… å®Œæˆ |
| `presentation/test/.../RegenerateLastMessageV4Test.kt` | åˆ›å»º10ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹ | âœ… å®Œæˆ |

### 10.2 ä¿®æ”¹è¯¦æƒ…

#### æ•°æ®åº“è¿ç§» (MIGRATION_14_15)
```kotlin
internal val MIGRATION_14_15 = object : Migration(14, 15) {
    override fun migrate(db: SupportSQLiteDatabase) {
        db.execSQL(
            "ALTER TABLE ai_advisor_conversations ADD COLUMN related_user_message_id TEXT DEFAULT ''"
        )
    }
}
```

#### ä¸‰é‡ä¿éšœè·å–ç”¨æˆ·è¾“å…¥é€»è¾‘
```kotlin
private fun getUserInputForRegenerate(
    lastAiMessage: AiAdvisorConversation,
    conversations: List<AiAdvisorConversation>
): Pair<String, String?> {
    // ä¼˜å…ˆçº§1ï¼šä½¿ç”¨å†…å­˜ä¸­çš„lastUserInput
    // ä¼˜å…ˆçº§2ï¼šé€šè¿‡relatedUserMessageIdæŸ¥æ‰¾
    // ä¼˜å…ˆçº§3ï¼šæ—¶é—´æˆ³å›é€€æŸ¥æ‰¾ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
}
```
