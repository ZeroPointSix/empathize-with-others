# BUG-00048-V4-ç»ˆæ­¢åé‡æ–°ç”Ÿæˆæ¶ˆæ¯è§’è‰²é”™è¯¯é—®é¢˜æ·±åº¦åˆ†æ

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç¼–å· | BUG-00048-V4 |
| åˆ›å»ºæ—¥æœŸ | 2026-01-06 |
| é—®é¢˜æ¥æº | TD-00028-V5-äººå·¥ç»“æœ.md |
| ä¼˜å…ˆçº§ | P0 (ä¸¥é‡) |
| çŠ¶æ€ | âœ… ä¿®å¤å®Œæˆï¼ˆV4ï¼‰ |
| å…³è”ä»»åŠ¡ | TD-00028 AIå†›å¸ˆæµå¼å¯¹è¯åŠŸèƒ½ |

---

## 1. é—®é¢˜æè¿°

### 1.1 ç”¨æˆ·åé¦ˆåŸæ–‡ï¼ˆTD-00028-V5ï¼‰

> "ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯è¯´å½“ä½ å½“AIç”Ÿæˆå›å¤çš„æ—¶å€™ï¼Œä½ ä¼šçŸ­æš‚çš„å†’å‡ºä¸¤ä¸ªAIå›å¤ç»“æœã€‚ç„¶åç¬¬äºŒä¸ªå›å¤ç»“æœè¿…é€Ÿçš„æ¶ˆå¤±ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚è¿˜æœ‰ç¬¬äºŒä¸ªé—®é¢˜ã€‚ç¬¬äºŒä¸ªé—®é¢˜å°±æ˜¯è¯´å½“æˆ‘ä»¬åœæ­¢ç”Ÿæˆæˆ‘ä»¬çš„AIå›å¤çš„æ—¶å€™ï¼Œå®ƒå¹¶ä¸ä¼šç›´æ¥çš„ç»ˆæ­¢ï¼Œè€Œæ˜¯è¯´å®ƒä¼šç›´æ¥æ¶ˆå¤±ï¼ŒæŒ‰ç…§æ­£å¸¸çš„æ¥è¯´ï¼Œæˆ‘ä»¬åº”è¯¥æ˜¯å®ƒåœæ­¢äº†ã€‚ç„¶åæœ€åº•ä¸‹è¿˜ç•™äº†ä¸€ä¸ªé‡æ–°ç”Ÿæˆçš„æŒ‰é’®ï¼Œä¸åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚"

### 1.2 é—®é¢˜æ‹†è§£

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | ä¸¥é‡ç¨‹åº¦ |
|----------|----------|----------|
| **P1** | AIç”Ÿæˆå›å¤æ—¶çŸ­æš‚å†’å‡ºä¸¤ä¸ªAIå›å¤æ°”æ³¡ï¼Œç„¶åç¬¬äºŒä¸ªæ¶ˆå¤± | ğŸŸ¡ ä¸­ç­‰ |
| **P2** | åœæ­¢ç”Ÿæˆåæ¶ˆæ¯ç›´æ¥æ¶ˆå¤±ï¼Œè€Œä¸æ˜¯ä¿ç•™"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"å¹¶æ˜¾ç¤ºé‡æ–°ç”ŸæˆæŒ‰é’® | ğŸ”´ ä¸¥é‡ |

### 1.3 é¢„æœŸè¡Œä¸º

**P1é¢„æœŸ**ï¼š
- AIç”Ÿæˆå›å¤æ—¶ï¼Œåªæ˜¾ç¤ºä¸€ä¸ªæµå¼æ¶ˆæ¯æ°”æ³¡
- æµå¼å®Œæˆåï¼Œæ°”æ³¡å¹³æ»‘è¿‡æ¸¡åˆ°conversationsåˆ—è¡¨ä¸­çš„æ¶ˆæ¯

**P2é¢„æœŸ**ï¼š
- ç‚¹å‡»åœæ­¢ç”Ÿæˆåï¼Œæ¶ˆæ¯å†…å®¹ä¿ç•™ï¼ˆå¦‚æœæœ‰å†…å®¹åˆ™æ˜¾ç¤ºå†…å®¹+[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]ï¼Œå¦åˆ™åªæ˜¾ç¤º[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]ï¼‰
- æ¶ˆæ¯æ˜¾ç¤ºä¸ºçº¢è‰²æ°”æ³¡ï¼ˆCANCELLEDçŠ¶æ€ï¼‰
- æ¶ˆæ¯ä¸‹æ–¹æ˜¾ç¤º"é‡è¯•"å’Œ"åˆ é™¤"æŒ‰é’®

---

## 2. ä»£ç åˆ†æ

### 2.1 å…³é”®ä»£ç è·¯å¾„

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
  â†“
sendMessageStreaming()
  - è®¾ç½® isStreaming = true
  - è®¾ç½® currentStreamingMessageId = null
  - æ¸…ç©º streamingContent
  â†“
StreamingState.Started
  - è®¾ç½® currentStreamingMessageId = state.messageId
  â†“
StreamingState.TextUpdate
  - æ›´æ–° streamingContent
  â†“
ç”¨æˆ·ç‚¹å‡»åœæ­¢
  â†“
stopGeneration()
  - å–æ¶ˆ streamingJob
  - è®¾ç½® isStreaming = false
  - ä¿æŒ streamingContent å’Œ currentStreamingMessageId
  - å¼‚æ­¥æ›´æ–°æ•°æ®åº“
  â†“
æ•°æ®åº“æ›´æ–°å®Œæˆ
  - Flowé€šçŸ¥ conversations æ›´æ–°
  - æ¸…ç©º streamingContent å’Œ currentStreamingMessageId
```

### 2.2 é—®é¢˜P1åˆ†æï¼šåŒæ°”æ³¡é—®é¢˜

**å…³é”®ä»£ç ä½ç½®**ï¼š`AiAdvisorChatScreen.kt` ç¬¬235-260è¡Œ

```kotlin
// BUG-047-P0-V5-001ä¿®å¤ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²åœ¨conversationsåˆ—è¡¨ä¸­ä¸”æœ‰å†…å®¹ï¼Œé¿å…åŒæ°”æ³¡
val messageAlreadyInList = uiState.currentStreamingMessageId?.let { messageId ->
    uiState.conversations.any { it.id == messageId && it.content.isNotEmpty() }
} ?: false

val shouldShowStreamingBubble = !messageAlreadyInList && (
    (uiState.isStreaming && uiState.currentStreamingMessageId != null) ||
    (uiState.streamingContent.isNotEmpty() && uiState.currentStreamingMessageId != null)
)
```

**é—®é¢˜æ ¹å› **ï¼š
1. å½“`StreamingState.Completed`è§¦å‘æ—¶ï¼Œ`isStreaming`è¢«è®¾ç½®ä¸º`false`
2. ä½†`streamingContent`ä¿æŒä¸å˜ï¼ˆç­‰å¾…1200msåæ¸…ç©ºï¼‰
3. åŒæ—¶ï¼Œæ•°æ®åº“æ›´æ–°è§¦å‘Flowï¼Œ`conversations`åˆ—è¡¨æ›´æ–°
4. åœ¨è¿™ä¸ªæ—¶é—´çª—å£å†…ï¼š
   - `messageAlreadyInList`å¯èƒ½ä¸º`false`ï¼ˆå› ä¸ºFlowæ›´æ–°æœ‰å»¶è¿Ÿï¼‰
   - `shouldShowStreamingBubble`ä¸º`true`ï¼ˆå› ä¸º`streamingContent`ä¸ä¸ºç©ºï¼‰
   - åŒæ—¶`conversations`åˆ—è¡¨ä¸­ä¹Ÿæœ‰è¿™æ¡æ¶ˆæ¯
5. ç»“æœï¼šå‡ºç°ä¸¤ä¸ªæ°”æ³¡

**æ—¶åºå›¾**ï¼š
```
æ—¶é—´çº¿ â†’
|-------|-------|-------|-------|-------|
   T0      T1      T2      T3      T4
   
T0: Completedè§¦å‘
    - isStreaming = false
    - streamingContent = "å®Œæ•´å†…å®¹"
    - conversations è¿˜æ²¡æ›´æ–°
    
T1: Flowæ›´æ–°è§¦å‘
    - conversations åŒ…å«æ–°æ¶ˆæ¯
    - streamingContent è¿˜æ²¡æ¸…ç©º
    - ã€åŒæ°”æ³¡å‡ºç°ã€‘
    
T2: 1200mså»¶è¿Ÿå
    - streamingContent = ""
    - ã€ç¬¬äºŒä¸ªæ°”æ³¡æ¶ˆå¤±ã€‘
```

### 2.3 é—®é¢˜P2åˆ†æï¼šåœæ­¢åæ¶ˆæ¯æ¶ˆå¤±

**å…³é”®ä»£ç ä½ç½®**ï¼š`AiAdvisorChatViewModel.kt` `stopGeneration()`æ–¹æ³•

```kotlin
fun stopGeneration() {
    streamingJob?.cancel()
    streamingJob = null

    val messageId = _uiState.value.currentStreamingMessageId
    val currentContent = _uiState.value.streamingContent

    // å…ˆæ ‡è®°ä¸ºéæµå¼çŠ¶æ€ï¼Œä½†ä¿æŒå†…å®¹æ˜¾ç¤º
    _uiState.update {
        it.copy(
            isStreaming = false,
            isRegenerating = false,
            // ä¿æŒ streamingContent å’Œ currentStreamingMessageId
            thinkingContent = "",
            thinkingElapsedMs = 0
        )
    }

    messageId?.let { id ->
        viewModelScope.launch {
            try {
                val finalContent = if (currentContent.isNotEmpty()) {
                    currentContent + "\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
                } else {
                    "[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
                }
                
                val result = aiAdvisorRepository.updateAiMessageContentAndStatus(
                    id,
                    finalContent,
                    SendStatus.CANCELLED
                )
                
                if (result.isSuccess && result.getOrNull() == true) {
                    kotlinx.coroutines.delay(300)
                    
                    val messageInList = _uiState.value.conversations.any { 
                        it.id == id && it.content.isNotEmpty() 
                    }
                    
                    if (messageInList) {
                        _uiState.update {
                            it.copy(
                                streamingContent = "",
                                currentStreamingMessageId = null
                            )
                        }
                    }
                } else if (result.isSuccess && result.getOrNull() == false) {
                    // æ¶ˆæ¯ä¸æ˜¯AIç±»å‹
                    _uiState.update {
                        it.copy(
                            streamingContent = "",
                            currentStreamingMessageId = null,
                            error = "åœæ­¢ç”Ÿæˆå¤±è´¥ï¼šæ¶ˆæ¯ç±»å‹ä¸åŒ¹é…"
                        )
                    }
                } else {
                    // æ›´æ–°å¤±è´¥
                    _uiState.update {
                        it.copy(
                            streamingContent = "",
                            currentStreamingMessageId = null,
                            error = "ä¿å­˜æ¶ˆæ¯å¤±è´¥"
                        )
                    }
                }
            } catch (e: Exception) {
                _uiState.update {
                    it.copy(
                        streamingContent = "",
                        currentStreamingMessageId = null,
                        error = "æ“ä½œå¤±è´¥: ${e.message}"
                    )
                }
            }
        }
    } ?: run {
        // æ²¡æœ‰messageIdæ—¶ç›´æ¥æ¸…ç©ºçŠ¶æ€
        _uiState.update {
            it.copy(
                streamingContent = "",
                currentStreamingMessageId = null
            )
        }
    }
}
```

**é—®é¢˜æ ¹å› **ï¼š

1. **messageIdå¯èƒ½ä¸ºnull**ï¼š
   - å¦‚æœç”¨æˆ·åœ¨`StreamingState.Started`ä¹‹å‰å°±ç‚¹å‡»åœæ­¢ï¼Œ`currentStreamingMessageId`è¿˜æ˜¯`null`
   - æ­¤æ—¶ç›´æ¥è¿›å…¥`?: run`åˆ†æ”¯ï¼Œæ¸…ç©ºæ‰€æœ‰çŠ¶æ€ï¼Œæ¶ˆæ¯æ¶ˆå¤±

2. **æ•°æ®åº“æ›´æ–°å¯èƒ½å¤±è´¥**ï¼š
   - `updateAiMessageContentAndStatus`è¿”å›`false`æˆ–æŠ›å‡ºå¼‚å¸¸
   - æ­¤æ—¶æ¸…ç©ºUIçŠ¶æ€ï¼Œä½†æ•°æ®åº“ä¸­æ²¡æœ‰ä¿å­˜æ¶ˆæ¯

3. **Flowæ›´æ–°å»¶è¿Ÿ**ï¼š
   - å³ä½¿æ•°æ®åº“æ›´æ–°æˆåŠŸï¼Œ`conversations`åˆ—è¡¨çš„Flowæ›´æ–°å¯èƒ½æœ‰å»¶è¿Ÿ
   - åœ¨å»¶è¿ŸæœŸé—´ï¼Œ`messageInList`æ£€æŸ¥å¯èƒ½è¿”å›`false`
   - å¯¼è‡´æ¶ˆæ¯åœ¨UIä¸Šæ¶ˆå¤±

4. **UIæ¸²æŸ“æ¡ä»¶é—®é¢˜**ï¼š
   - `shouldShowStreamingBubble`çš„æ¡ä»¶æ˜¯ï¼š
     ```kotlin
     !messageAlreadyInList && (
         (uiState.isStreaming && uiState.currentStreamingMessageId != null) ||
         (uiState.streamingContent.isNotEmpty() && uiState.currentStreamingMessageId != null)
     )
     ```
   - åœæ­¢å`isStreaming = false`ï¼Œå¦‚æœ`streamingContent`è¢«æ¸…ç©ºï¼Œæ°”æ³¡å°±ä¸æ˜¾ç¤ºäº†
   - ä½†æ­¤æ—¶`conversations`åˆ—è¡¨å¯èƒ½è¿˜æ²¡æ›´æ–°ï¼Œå¯¼è‡´æ¶ˆæ¯å®Œå…¨æ¶ˆå¤±

---

## 3. æ ¹æœ¬åŸå› æ€»ç»“

### 3.1 P1åŒæ°”æ³¡é—®é¢˜

**æ ¹æœ¬åŸå› **ï¼š`StreamingState.Completed`åçš„çŠ¶æ€æ¸…ç†å»¶è¿Ÿï¼ˆ1200msï¼‰ä¸Flowæ›´æ–°ä¹‹é—´çš„æ—¶åºç«äº‰

**é—®é¢˜é“¾**ï¼š
```
Completed â†’ isStreaming=false â†’ Flowæ›´æ–°conversations â†’ 
streamingContentè¿˜æ²¡æ¸…ç©º â†’ ä¸¤ä¸ªåœ°æ–¹éƒ½æ˜¾ç¤ºæ¶ˆæ¯ â†’ åŒæ°”æ³¡
```

### 3.2 P2æ¶ˆæ¯æ¶ˆå¤±é—®é¢˜

**æ ¹æœ¬åŸå› **ï¼šåœæ­¢ç”Ÿæˆæ—¶çš„çŠ¶æ€ç®¡ç†ä¸å®Œå–„ï¼Œå­˜åœ¨å¤šä¸ªå¯¼è‡´æ¶ˆæ¯æ¶ˆå¤±çš„è·¯å¾„

**é—®é¢˜é“¾**ï¼š
```
stopGeneration() â†’ 
  è·¯å¾„1: messageIdä¸ºnull â†’ ç›´æ¥æ¸…ç©ºçŠ¶æ€ â†’ æ¶ˆæ¯æ¶ˆå¤±
  è·¯å¾„2: æ•°æ®åº“æ›´æ–°å¤±è´¥ â†’ æ¸…ç©ºçŠ¶æ€ â†’ æ¶ˆæ¯æ¶ˆå¤±
  è·¯å¾„3: Flowæ›´æ–°å»¶è¿Ÿ â†’ messageInList=false â†’ æ¸…ç©ºçŠ¶æ€ â†’ æ¶ˆæ¯æ¶ˆå¤±
```

---

## 4. ä¿®å¤æ–¹æ¡ˆ

### 4.1 P1ä¿®å¤ï¼šä¼˜åŒ–åŒæ°”æ³¡æ£€æµ‹é€»è¾‘

**æ–¹æ¡ˆ**ï¼šå¢å¼º`messageAlreadyInList`çš„æ£€æµ‹ï¼Œä½¿ç”¨æ›´å¯é çš„æ—¶åºæ§åˆ¶

**ä¿®æ”¹æ–‡ä»¶**ï¼š`AiAdvisorChatScreen.kt`

```kotlin
// æ”¹è¿›åçš„æ£€æµ‹é€»è¾‘
val messageAlreadyInList = uiState.currentStreamingMessageId?.let { messageId ->
    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åœ¨åˆ—è¡¨ä¸­ï¼Œä¸”çŠ¶æ€ä¸æ˜¯PENDING
    uiState.conversations.any { 
        it.id == messageId && 
        (it.content.isNotEmpty() || it.sendStatus != SendStatus.PENDING)
    }
} ?: false

// åªæœ‰åœ¨æµå¼è¿›è¡Œä¸­æˆ–è€…æ¶ˆæ¯è¿˜æ²¡è¿›å…¥åˆ—è¡¨æ—¶æ‰æ˜¾ç¤ºæµå¼æ°”æ³¡
val shouldShowStreamingBubble = !messageAlreadyInList && (
    uiState.isStreaming || 
    (uiState.streamingContent.isNotEmpty() && uiState.currentStreamingMessageId != null)
)
```

### 4.2 P2ä¿®å¤ï¼šå¢å¼ºåœæ­¢ç”Ÿæˆçš„çŠ¶æ€ç®¡ç†

**æ–¹æ¡ˆ**ï¼šç¡®ä¿åœæ­¢ç”Ÿæˆæ—¶æ¶ˆæ¯ä¸ä¼šæ¶ˆå¤±

**ä¿®æ”¹æ–‡ä»¶**ï¼š`AiAdvisorChatViewModel.kt`

```kotlin
fun stopGeneration() {
    streamingJob?.cancel()
    streamingJob = null

    val messageId = _uiState.value.currentStreamingMessageId
    val currentContent = _uiState.value.streamingContent

    // å¦‚æœæ²¡æœ‰messageIdï¼Œè¯´æ˜æµå¼è¿˜æ²¡å¼€å§‹ï¼Œç›´æ¥è¿”å›
    if (messageId == null) {
        _uiState.update {
            it.copy(
                isStreaming = false,
                isRegenerating = false,
                streamingContent = "",
                thinkingContent = "",
                thinkingElapsedMs = 0
            )
        }
        return
    }

    // å…ˆæ›´æ–°UIçŠ¶æ€ï¼Œä¿æŒå†…å®¹æ˜¾ç¤º
    _uiState.update {
        it.copy(
            isStreaming = false,
            isRegenerating = false,
            // å…³é”®ï¼šä¿æŒstreamingContentå’ŒcurrentStreamingMessageIdï¼Œç›´åˆ°æ•°æ®åº“æ›´æ–°æˆåŠŸ
            thinkingContent = "",
            thinkingElapsedMs = 0
        )
    }

    viewModelScope.launch {
        try {
            val finalContent = if (currentContent.isNotEmpty()) {
                currentContent + "\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
            } else {
                "[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
            }
            
            val result = aiAdvisorRepository.updateAiMessageContentAndStatus(
                messageId,
                finalContent,
                SendStatus.CANCELLED
            )
            
            if (result.isSuccess && result.getOrNull() == true) {
                // ç­‰å¾…æ›´é•¿æ—¶é—´ï¼Œç¡®ä¿Flowæ›´æ–°å®Œæˆ
                kotlinx.coroutines.delay(500)
                
                // å¾ªç¯æ£€æŸ¥ï¼Œæœ€å¤šç­‰å¾…2ç§’
                var retryCount = 0
                while (retryCount < 4) {
                    val messageInList = _uiState.value.conversations.any { 
                        it.id == messageId && it.content.isNotEmpty() 
                    }
                    
                    if (messageInList) {
                        _uiState.update {
                            it.copy(
                                streamingContent = "",
                                currentStreamingMessageId = null
                            )
                        }
                        return@launch
                    }
                    
                    kotlinx.coroutines.delay(500)
                    retryCount++
                }
                
                // è¶…æ—¶åä»ç„¶æ¸…ç©ºï¼Œä½†è®°å½•è­¦å‘Š
                _uiState.update {
                    it.copy(
                        streamingContent = "",
                        currentStreamingMessageId = null
                    )
                }
            } else {
                // æ›´æ–°å¤±è´¥ï¼Œä¿æŒstreamingContentæ˜¾ç¤ºï¼Œè®©ç”¨æˆ·çœ‹åˆ°å†…å®¹
                // ä¸æ¸…ç©ºçŠ¶æ€ï¼Œè®©ç”¨æˆ·å¯ä»¥é‡è¯•
                _uiState.update {
                    it.copy(
                        error = "ä¿å­˜æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•"
                    )
                }
            }
        } catch (e: Exception) {
            // å¼‚å¸¸æ—¶ä¹Ÿä¿æŒå†…å®¹æ˜¾ç¤º
            _uiState.update {
                it.copy(
                    error = "æ“ä½œå¤±è´¥: ${e.message}"
                )
            }
        }
    }
}
```

### 4.3 é¢å¤–ä¿®å¤ï¼šStreamingMessageBubbleSimpleæ˜¾ç¤ºCANCELLEDçŠ¶æ€

**é—®é¢˜**ï¼šå½“æ¶ˆæ¯çŠ¶æ€ä¸ºCANCELLEDæ—¶ï¼Œåº”è¯¥æ˜¾ç¤º"é‡è¯•"å’Œ"åˆ é™¤"æŒ‰é’®ï¼Œè€Œä¸æ˜¯"é‡æ–°ç”Ÿæˆ"æŒ‰é’®

**ä¿®æ”¹æ–‡ä»¶**ï¼š`StreamingMessageBubble.kt`

éœ€è¦åœ¨`StreamingMessageBubbleSimple`ä¸­æ·»åŠ å¯¹CANCELLEDçŠ¶æ€çš„å¤„ç†ã€‚

---

## 5. æµ‹è¯•ç”¨ä¾‹

### 5.1 P1æµ‹è¯•ï¼šåŒæ°”æ³¡é—®é¢˜

| æµ‹è¯•ID | æµ‹è¯•åœºæ™¯ | é¢„æœŸç»“æœ |
|--------|----------|----------|
| TC-P1-001 | æ­£å¸¸å‘é€æ¶ˆæ¯ï¼ŒAIå®Œæ•´å›å¤ | å§‹ç»ˆåªæ˜¾ç¤ºä¸€ä¸ªæ°”æ³¡ |
| TC-P1-002 | å¿«é€Ÿå‘é€å¤šæ¡æ¶ˆæ¯ | æ¯æ¡æ¶ˆæ¯åªæ˜¾ç¤ºä¸€ä¸ªæ°”æ³¡ |
| TC-P1-003 | AIå›å¤å®Œæˆç¬é—´è§‚å¯Ÿ | ä¸å‡ºç°åŒæ°”æ³¡é—ªçƒ |

### 5.2 P2æµ‹è¯•ï¼šåœæ­¢ç”Ÿæˆé—®é¢˜

| æµ‹è¯•ID | æµ‹è¯•åœºæ™¯ | é¢„æœŸç»“æœ |
|--------|----------|----------|
| TC-P2-001 | AIå¼€å§‹å›å¤åç«‹å³åœæ­¢ | æ˜¾ç¤º"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"ï¼Œçº¢è‰²æ°”æ³¡ |
| TC-P2-002 | AIå›å¤ä¸€åŠæ—¶åœæ­¢ | æ˜¾ç¤º"éƒ¨åˆ†å†…å®¹\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"ï¼Œçº¢è‰²æ°”æ³¡ |
| TC-P2-003 | åœæ­¢åæ£€æŸ¥æŒ‰é’® | æ˜¾ç¤º"é‡è¯•"å’Œ"åˆ é™¤"æŒ‰é’® |
| TC-P2-004 | åœæ­¢åç‚¹å‡»é‡è¯• | ä½¿ç”¨åŸå§‹ç”¨æˆ·è¾“å…¥é‡æ–°ç”Ÿæˆ |
| TC-P2-005 | å¿«é€Ÿç‚¹å‡»åœæ­¢ï¼ˆæµå¼åˆšå¼€å§‹ï¼‰ | æ¶ˆæ¯ä¸æ¶ˆå¤±ï¼Œæ˜¾ç¤ºåœæ­¢çŠ¶æ€ |

---

## 6. éªŒè¯æ¸…å•

- [ ] P1: AIå›å¤å®Œæˆæ—¶ä¸å‡ºç°åŒæ°”æ³¡
- [ ] P1: å¿«é€Ÿå‘é€å¤šæ¡æ¶ˆæ¯æ—¶ä¸å‡ºç°åŒæ°”æ³¡
- [ ] P2: åœæ­¢ç”Ÿæˆåæ¶ˆæ¯ä¸æ¶ˆå¤±
- [ ] P2: åœæ­¢åæ˜¾ç¤º"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
- [ ] P2: åœæ­¢åæ¶ˆæ¯ä¸ºçº¢è‰²æ°”æ³¡
- [ ] P2: åœæ­¢åæ˜¾ç¤º"é‡è¯•"å’Œ"åˆ é™¤"æŒ‰é’®
- [ ] P2: ç‚¹å‡»é‡è¯•èƒ½æ­£ç¡®é‡æ–°ç”Ÿæˆ
- [ ] P2: å¿«é€Ÿåœæ­¢ï¼ˆæµå¼åˆšå¼€å§‹ï¼‰æ¶ˆæ¯ä¸æ¶ˆå¤±

---

## 7. å†å²ç‰ˆæœ¬

| ç‰ˆæœ¬ | æ—¥æœŸ | å†…å®¹ |
|------|------|------|
| V1 | 2026-01-05 | åˆå§‹åˆ†æï¼šDAOæ–¹æ³•ç¼ºå°‘ç±»å‹éªŒè¯ |
| V2 | 2026-01-05 | æ·»åŠ updateAiMessageContentAndStatusæ–¹æ³• |
| V3 | 2026-01-05 | æ”¹è¿›æ¶ˆæ¯æŸ¥è¯¢é€»è¾‘ï¼Œæ·»åŠ æ—¶é—´æˆ³çº¦æŸ |
| V4 | 2026-01-06 | æ·±åº¦åˆ†æåŒæ°”æ³¡å’Œæ¶ˆæ¯æ¶ˆå¤±é—®é¢˜çš„æ ¹æœ¬åŸå›  |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 4.0
**æœ€åæ›´æ–°**: 2026-01-06
**ä¿®å¤çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆï¼ˆV4ï¼‰

---

## 8. ä¿®å¤å®æ–½è®°å½•

### 8.1 ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|----------|----------|------|
| `presentation/.../AiAdvisorChatScreen.kt` | ä¿®æ”¹ | å¢å¼º`messageAlreadyInList`æ£€æµ‹é€»è¾‘ï¼Œæ£€æŸ¥æ¶ˆæ¯çŠ¶æ€ä¸æ˜¯PENDINGæˆ–æœ‰å†…å®¹ |
| `presentation/.../AiAdvisorChatViewModel.kt` | ä¿®æ”¹ | å¢å¼º`stopGeneration()`æ–¹æ³•ï¼Œæ·»åŠ é‡è¯•æœºåˆ¶ï¼Œç¡®ä¿æ¶ˆæ¯ä¸æ¶ˆå¤± |
| `presentation/.../StopGenerationTest.kt` | æ–°å¢ | åœæ­¢ç”ŸæˆåŠŸèƒ½å•å…ƒæµ‹è¯•ï¼ˆ4ä¸ªç”¨ä¾‹ï¼‰ |
| `presentation/.../DoubleBubblePreventionTest.kt` | æ–°å¢ | åŒæ°”æ³¡é¢„é˜²å•å…ƒæµ‹è¯•ï¼ˆ6ä¸ªç”¨ä¾‹ï¼‰ |

### 8.2 å…³é”®ä¿®æ”¹ç‚¹

**AiAdvisorChatScreen.kt**ï¼š
```kotlin
// V4å¢å¼ºï¼šæ£€æŸ¥æ¶ˆæ¯çŠ¶æ€ä¸æ˜¯PENDINGæˆ–æœ‰å†…å®¹
val messageAlreadyInList = uiState.currentStreamingMessageId?.let { messageId ->
    uiState.conversations.any { conv ->
        conv.id == messageId && 
        (conv.content.isNotEmpty() || conv.sendStatus != SendStatus.PENDING)
    }
} ?: false
```

**AiAdvisorChatViewModel.kt**ï¼š
```kotlin
// V4å¢å¼ºï¼šä½¿ç”¨é‡è¯•æœºåˆ¶ç­‰å¾…Flowæ›´æ–°
var retryCount = 0
val maxRetries = 4
val retryDelay = 500L

while (retryCount < maxRetries) {
    kotlinx.coroutines.delay(retryDelay)
    val messageInList = _uiState.value.conversations.any { 
        it.id == messageId && it.content.isNotEmpty() 
    }
    if (messageInList) {
        // æ¸…ç©ºæµå¼çŠ¶æ€
        break
    }
    retryCount++
}
```

### 8.3 æµ‹è¯•ç»“æœ

| æµ‹è¯•ç±» | ç”¨ä¾‹æ•° | é€šè¿‡ | å¤±è´¥ |
|--------|--------|------|------|
| StopGenerationTest | 4 | 4 | 0 |
| DoubleBubblePreventionTest | 6 | 6 | 0 |
| **æ€»è®¡** | **10** | **10** | **0** |

### 8.4 ç¼–è¯‘éªŒè¯

- âœ… `:presentation:compileDebugKotlin` ç¼–è¯‘æˆåŠŸ
- âœ… å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- â¬œ äººå·¥æµ‹è¯•å¾…æ‰§è¡Œ

