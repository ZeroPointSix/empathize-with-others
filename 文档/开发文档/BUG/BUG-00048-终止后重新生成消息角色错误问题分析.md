# BUG-00048-ç»ˆæ­¢åé‡æ–°ç”Ÿæˆæ¶ˆæ¯è§’è‰²é”™è¯¯é—®é¢˜åˆ†æ

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç¼–å· | BUG-00048 |
| åˆ›å»ºæ—¥æœŸ | 2026-01-05 |
| é—®é¢˜æ¥æº | TD-00028-V6-äººå·¥ç»“æœ.md |
| ä¼˜å…ˆçº§ | P0 (ä¸¥é‡) |
| çŠ¶æ€ | ğŸ”„ ä¿®å¤ä¸­ï¼ˆV3ï¼‰ |
| å…³è”ä»»åŠ¡ | TD-00028 AIå†›å¸ˆæµå¼å¯¹è¯åŠŸèƒ½ |

---

## 1. é—®é¢˜æè¿°

### 1.1 ç°è±¡ï¼ˆV3æ›´æ–° - æ¥è‡ªTD-00028-V6äººå·¥ç»“æœï¼‰

æ ¹æ®ç”¨æˆ·åé¦ˆï¼ˆTD-00028-V6-äººå·¥ç»“æœ.mdï¼‰ï¼š
> "å½“æˆ‘ä»¬ç»ˆæ­¢äº†AIçš„å›å¤è¿‡åï¼Œå†ç‚¹é‡æ–°ç”Ÿæˆçš„æ—¶å€™ï¼Œä»–ä¼šæŠŠç»ˆæ­¢çš„å†…å®¹å½“åšç”¨æˆ·çš„å‘é€çš„ä¿¡æ¯ï¼Œæ˜¾ç¤ºæˆUI"

**å…·ä½“è¡¨ç°**ï¼š
1. ç”¨æˆ·å‘é€æ¶ˆæ¯åï¼ŒAIå¼€å§‹æµå¼å›å¤
2. ç”¨æˆ·ç‚¹å‡»"åœæ­¢ç”Ÿæˆ"ç»ˆæ­¢AIå›å¤ï¼Œæ˜¾ç¤º"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
3. ç”¨æˆ·ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"æŒ‰é’®
4. **é—®é¢˜**ï¼šè¢«åœæ­¢çš„å†…å®¹"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"è¢«é”™è¯¯åœ°æ˜¾ç¤ºä¸ºç”¨æˆ·æ¶ˆæ¯ï¼ˆè“è‰²æ°”æ³¡ï¼Œå³ä¾§ï¼‰

### 1.2 é¢„æœŸè¡Œä¸º
- ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"åï¼Œåº”è¯¥åˆ é™¤è¢«åœæ­¢çš„AIæ¶ˆæ¯
- ä½¿ç”¨åŸå§‹ç”¨æˆ·è¾“å…¥é‡æ–°ç”ŸæˆAIå›å¤
- ä¸åº”è¯¥å‡ºç°ä»»ä½•æ–°çš„ç”¨æˆ·æ¶ˆæ¯

### 1.3 å®é™…è¡Œä¸º
- è¢«åœæ­¢çš„AIæ¶ˆæ¯å†…å®¹è¢«é”™è¯¯åœ°å½“ä½œç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤º
- å¯èƒ½æ˜¯å› ä¸ºé‡æ–°ç”Ÿæˆæ—¶ä½¿ç”¨äº†é”™è¯¯çš„æ¶ˆæ¯å†…å®¹

---

## 2. æ ¹å› åˆ†æï¼ˆV3æ·±åº¦åˆ†æï¼‰

### 2.1 é—®é¢˜é“¾è·¯è¿½è¸ª

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
  â†“
sendMessageStreaming() 
  - è®°å½• lastUserInput = message âœ…
  - åˆ›å»ºç”¨æˆ·æ¶ˆæ¯ï¼ˆUSERç±»å‹ï¼‰
  - åˆ›å»ºAIæ¶ˆæ¯å ä½ï¼ˆAIç±»å‹ï¼ŒPENDINGçŠ¶æ€ï¼‰
  â†“
ç”¨æˆ·ç‚¹å‡»åœæ­¢
  â†“
stopGeneration()
  - æ›´æ–°AIæ¶ˆæ¯å†…å®¹ä¸º "[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
  - æ›´æ–°AIæ¶ˆæ¯çŠ¶æ€ä¸º CANCELLED
  â†“
ç”¨æˆ·ç‚¹å‡»é‡æ–°ç”Ÿæˆ
  â†“
regenerateLastMessage()
  - æŸ¥æ‰¾ lastAiMessageï¼ˆæœ€åä¸€æ¡AIæ¶ˆæ¯ï¼‰
  - è·å– userInputToUseï¼š
    1. ä¼˜å…ˆä½¿ç”¨ lastUserInput âœ…
    2. å¦‚æœä¸ºç©ºï¼Œä»conversationsæŸ¥æ‰¾æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
  - åˆ é™¤ lastAiMessage
  - è°ƒç”¨ regenerateStreaming(userInputToUse, sessionId)
```

### 2.2 é—®é¢˜å®šä½

é€šè¿‡ä»£ç åˆ†æï¼Œå‘ç°é—®é¢˜å¯èƒ½å‡ºç°åœ¨ä»¥ä¸‹ç¯èŠ‚ï¼š

#### 2.2.1 lastUserInputå¯èƒ½è¢«æ¸…ç©º

**æ–‡ä»¶**: `AiAdvisorChatViewModel.kt`

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ`lastUserInput`å¯èƒ½ä¸ºç©ºï¼š
1. åº”ç”¨é‡å¯åï¼Œ`lastUserInput`ä¼šè¢«é‡ç½®ä¸ºç©ºå­—ç¬¦ä¸²
2. åˆ‡æ¢ä¼šè¯åï¼Œ`lastUserInput`å¯èƒ½æœªè¢«æ­£ç¡®ä¿ç•™

å½“`lastUserInput`ä¸ºç©ºæ—¶ï¼Œä»£ç ä¼šå›é€€åˆ°ä»`conversations`æŸ¥æ‰¾ï¼š

```kotlin
val userInputToUse = _uiState.value.lastUserInput.ifEmpty {
    conversations.lastOrNull { 
        it.messageType == MessageType.USER && 
        it.sendStatus == SendStatus.SUCCESS 
    }?.content ?: ""
}
```

#### 2.2.2 æ¶ˆæ¯æŸ¥è¯¢é€»è¾‘å¯èƒ½æœ‰é—®é¢˜

å½“ä»`conversations`æŸ¥æ‰¾ç”¨æˆ·æ¶ˆæ¯æ—¶ï¼š
- æ¡ä»¶æ˜¯ `messageType == MessageType.USER && sendStatus == SendStatus.SUCCESS`
- ä½†å¦‚æœæ•°æ®åº“ä¸­çš„æ¶ˆæ¯ç±»å‹è¢«é”™è¯¯è®¾ç½®ï¼Œå¯èƒ½ä¼šè¿”å›é”™è¯¯çš„æ¶ˆæ¯

#### 2.2.3 å¯èƒ½çš„æ—¶åºé—®é¢˜

1. **åœæ­¢ç”Ÿæˆæ—¶**ï¼š`updateAiMessageContentAndStatus`æ–¹æ³•å·²æ·»åŠ ç±»å‹éªŒè¯ï¼ˆV2ä¿®å¤ï¼‰
2. **é‡æ–°ç”Ÿæˆæ—¶**ï¼šåˆ é™¤AIæ¶ˆæ¯åï¼Œå¦‚æœFlowæ›´æ–°å»¶è¿Ÿï¼Œå¯èƒ½å¯¼è‡´æŸ¥è¯¢åˆ°æ—§æ•°æ®

### 2.3 æ ¹æœ¬åŸå› ï¼ˆV3ç»“è®ºï¼‰

ç»è¿‡æ·±å…¥åˆ†æï¼Œé—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ï¼š

**é—®é¢˜1ï¼šlastUserInputåœ¨æŸäº›åœºæ™¯ä¸‹ä¸ºç©º**
- åº”ç”¨é‡å¯ã€ä¼šè¯åˆ‡æ¢ç­‰åœºæ™¯ä¸‹ï¼Œ`lastUserInput`ä¼šä¸¢å¤±
- æ­¤æ—¶å›é€€åˆ°ä»`conversations`æŸ¥æ‰¾ï¼Œå¯èƒ½æŸ¥æ‰¾åˆ°é”™è¯¯çš„æ¶ˆæ¯

**é—®é¢˜2ï¼šregenerateStreamingå¯èƒ½ä½¿ç”¨äº†é”™è¯¯çš„è¾“å…¥**
- å¦‚æœ`userInputToUse`è·å–é”™è¯¯ï¼Œä¼šå¯¼è‡´é‡æ–°ç”Ÿæˆæ—¶ä½¿ç”¨é”™è¯¯çš„å†…å®¹
- è¿™å¯èƒ½å¯¼è‡´UIæ˜¾ç¤ºæ··ä¹±

**é—®é¢˜3ï¼šæ¶ˆæ¯åˆ é™¤å’Œé‡æ–°ç”Ÿæˆçš„æ—¶åºé—®é¢˜**
- åˆ é™¤AIæ¶ˆæ¯åï¼ŒFlowæ›´æ–°å¯èƒ½æœ‰å»¶è¿Ÿ
- åœ¨å»¶è¿ŸæœŸé—´ï¼ŒUIå¯èƒ½æ˜¾ç¤ºä¸ä¸€è‡´çš„çŠ¶æ€

---

## 3. ä¿®å¤æ–¹æ¡ˆï¼ˆV3å®æ–½ï¼‰

### 3.1 æ–¹æ¡ˆAï¼šå¢å¼ºlastUserInputçš„æŒä¹…åŒ–

å°†`lastUserInput`æŒä¹…åŒ–åˆ°æ•°æ®åº“æˆ–SharedPreferencesï¼Œç¡®ä¿åœ¨ä»»ä½•åœºæ™¯ä¸‹éƒ½èƒ½æ­£ç¡®è·å–ã€‚

**ä¿®æ”¹æ–‡ä»¶**: `AiAdvisorChatViewModel.kt`

```kotlin
// åœ¨sendMessageStreamingä¸­ä¿å­˜åˆ°æ•°æ®åº“
private fun sendMessageStreaming(message: String, sessionId: String) {
    // ä¿å­˜ç”¨æˆ·è¾“å…¥åˆ°æ•°æ®åº“ï¼ˆç”¨äºé‡æ–°ç”Ÿæˆï¼‰
    viewModelScope.launch {
        aiAdvisorRepository.saveLastUserInput(sessionId, message)
    }
    // ... å…¶ä»–ä»£ç 
}

// åœ¨regenerateLastMessageä¸­ä»æ•°æ®åº“è·å–
fun regenerateLastMessage() {
    val sessionId = _uiState.value.currentSessionId ?: return
    
    viewModelScope.launch {
        // ä¼˜å…ˆä»æ•°æ®åº“è·å–lastUserInput
        val savedInput = aiAdvisorRepository.getLastUserInput(sessionId)
        val userInputToUse = savedInput.ifEmpty {
            _uiState.value.lastUserInput.ifEmpty {
                // æœ€åå›é€€åˆ°conversationsæŸ¥æ‰¾
                findLastUserMessage()?.content ?: ""
            }
        }
        // ... å…¶ä»–ä»£ç 
    }
}
```

### 3.2 æ–¹æ¡ˆBï¼šæ”¹è¿›æ¶ˆæ¯æŸ¥è¯¢é€»è¾‘ï¼ˆæ¨èï¼‰

åœ¨`regenerateLastMessage`ä¸­ï¼Œä½¿ç”¨æ›´å¯é çš„æŸ¥è¯¢é€»è¾‘ï¼š

**ä¿®æ”¹æ–‡ä»¶**: `AiAdvisorChatViewModel.kt`

```kotlin
fun regenerateLastMessage() {
    val conversations = _uiState.value.conversations
    val sessionId = _uiState.value.currentSessionId ?: return
    
    // 1. æ‰¾åˆ°æœ€åä¸€æ¡AIæ¶ˆæ¯ï¼ˆåŒ…æ‹¬CANCELLEDçŠ¶æ€ï¼‰
    val lastAiMessage = conversations
        .filter { it.messageType == MessageType.AI }
        .maxByOrNull { it.timestamp }
    
    if (lastAiMessage == null) {
        _uiState.update { it.copy(error = "æœªæ‰¾åˆ°AIæ¶ˆæ¯ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ") }
        return
    }
    
    // 2. æ‰¾åˆ°è¯¥AIæ¶ˆæ¯ä¹‹å‰çš„æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
    val lastUserMessage = conversations
        .filter { 
            it.messageType == MessageType.USER && 
            it.sendStatus == SendStatus.SUCCESS &&
            it.timestamp < lastAiMessage.timestamp  // å…³é”®ï¼šå¿…é¡»åœ¨AIæ¶ˆæ¯ä¹‹å‰
        }
        .maxByOrNull { it.timestamp }
    
    // 3. ä¼˜å…ˆä½¿ç”¨lastUserInputï¼Œå…¶æ¬¡ä½¿ç”¨æŸ¥æ‰¾åˆ°çš„ç”¨æˆ·æ¶ˆæ¯
    val userInputToUse = _uiState.value.lastUserInput.ifEmpty {
        lastUserMessage?.content ?: ""
    }
    
    if (userInputToUse.isEmpty()) {
        _uiState.update { it.copy(error = "æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç”¨æˆ·æ¶ˆæ¯ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ") }
        return
    }
    
    // 4. åˆ é™¤AIæ¶ˆæ¯å¹¶é‡æ–°ç”Ÿæˆ
    viewModelScope.launch {
        _uiState.update { it.copy(isRegenerating = true) }
        
        val deleteResult = deleteAdvisorConversationUseCase(lastAiMessage.id)
        
        if (deleteResult.isSuccess) {
            kotlinx.coroutines.delay(200) // ç­‰å¾…Flowæ›´æ–°
            regenerateStreaming(userInputToUse, sessionId)
        } else {
            _uiState.update { 
                it.copy(isRegenerating = false, error = "åˆ é™¤æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•") 
            }
        }
    }
}
```

### 3.3 æ–¹æ¡ˆCï¼šåœ¨åœæ­¢ç”Ÿæˆæ—¶è®°å½•åŸå§‹ç”¨æˆ·è¾“å…¥

åœ¨`stopGeneration`æ—¶ï¼Œå°†åŸå§‹ç”¨æˆ·è¾“å…¥ä¿å­˜åˆ°è¢«åœæ­¢çš„AIæ¶ˆæ¯çš„metadataä¸­ã€‚

**ä¿®æ”¹æ–‡ä»¶**: `AiAdvisorDao.kt`

```kotlin
@Query("""
    UPDATE ai_advisor_conversations 
    SET content = :content, send_status = :status, metadata = :metadata
    WHERE id = :conversationId AND message_type = 'AI'
""")
suspend fun updateAiMessageWithMetadata(
    conversationId: String, 
    content: String, 
    status: String,
    metadata: String  // JSONæ ¼å¼ï¼ŒåŒ…å«originalUserInput
): Int
```

---

## 4. æ¨èä¿®å¤æ–¹æ¡ˆ

**æ¨èæ–¹æ¡ˆB**ï¼ŒåŸå› ï¼š
1. ä¸éœ€è¦ä¿®æ”¹æ•°æ®åº“ç»“æ„
2. é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
3. é€šè¿‡æ—¶é—´æˆ³ç¡®ä¿æŸ¥æ‰¾åˆ°æ­£ç¡®çš„ç”¨æˆ·æ¶ˆæ¯

### 4.1 ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|----------|----------|------|
| `presentation/.../AiAdvisorChatViewModel.kt` | ä¿®æ”¹ | æ”¹è¿›`regenerateLastMessage()`çš„æ¶ˆæ¯æŸ¥è¯¢é€»è¾‘ |

### 4.2 å…³é”®ä¿®æ”¹ç‚¹

1. **ä½¿ç”¨æ—¶é—´æˆ³æ’åº**ï¼šç¡®ä¿æ‰¾åˆ°çš„æ˜¯æœ€åä¸€æ¡æ¶ˆæ¯
2. **æ·»åŠ æ—¶é—´æˆ³çº¦æŸ**ï¼šç”¨æˆ·æ¶ˆæ¯å¿…é¡»åœ¨AIæ¶ˆæ¯ä¹‹å‰
3. **å¢åŠ å»¶è¿Ÿæ—¶é—´**ï¼šç­‰å¾…Flowæ›´æ–°å®Œæˆ

---

## 5. æµ‹è¯•ç”¨ä¾‹

### 5.1 æ­£å¸¸æµç¨‹æµ‹è¯•
1. å‘é€æ¶ˆæ¯ â†’ AIå›å¤å®Œæˆ â†’ ç‚¹å‡»é‡æ–°ç”Ÿæˆ â†’ éªŒè¯ä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·è¾“å…¥

### 5.2 ç»ˆæ­¢åé‡æ–°ç”Ÿæˆæµ‹è¯•ï¼ˆæ ¸å¿ƒåœºæ™¯ï¼‰
1. å‘é€æ¶ˆæ¯ â†’ AIå¼€å§‹å›å¤ â†’ ç‚¹å‡»åœæ­¢ â†’ ç‚¹å‡»é‡æ–°ç”Ÿæˆ
2. **éªŒè¯**ï¼š
   - è¢«åœæ­¢çš„AIæ¶ˆæ¯è¢«åˆ é™¤
   - ä½¿ç”¨åŸå§‹ç”¨æˆ·è¾“å…¥é‡æ–°ç”Ÿæˆ
   - ä¸å‡ºç°æ–°çš„ç”¨æˆ·æ¶ˆæ¯
   - æ–°çš„AIå›å¤æ­£å¸¸æ˜¾ç¤º

### 5.3 åº”ç”¨é‡å¯åé‡æ–°ç”Ÿæˆæµ‹è¯•
1. å‘é€æ¶ˆæ¯ â†’ AIå¼€å§‹å›å¤ â†’ ç‚¹å‡»åœæ­¢ â†’ é‡å¯åº”ç”¨ â†’ ç‚¹å‡»é‡æ–°ç”Ÿæˆ
2. **éªŒè¯**ï¼šå³ä½¿lastUserInputä¸¢å¤±ï¼Œä¹Ÿèƒ½æ­£ç¡®æ‰¾åˆ°ç”¨æˆ·æ¶ˆæ¯

### 5.4 å¿«é€Ÿæ“ä½œæµ‹è¯•
1. å‘é€æ¶ˆæ¯ â†’ ç«‹å³ç‚¹å‡»åœæ­¢ â†’ ç«‹å³ç‚¹å‡»é‡æ–°ç”Ÿæˆ
2. **éªŒè¯**ï¼šä¸ä¼šå‡ºç°çŠ¶æ€æ··ä¹±

### 5.5 å¤šè½®å¯¹è¯åé‡æ–°ç”Ÿæˆæµ‹è¯•
1. å‘é€æ¶ˆæ¯1 â†’ AIå›å¤1 â†’ å‘é€æ¶ˆæ¯2 â†’ AIå¼€å§‹å›å¤2 â†’ åœæ­¢ â†’ é‡æ–°ç”Ÿæˆ
2. **éªŒè¯**ï¼šä½¿ç”¨æ¶ˆæ¯2çš„å†…å®¹é‡æ–°ç”Ÿæˆï¼Œè€Œä¸æ˜¯æ¶ˆæ¯1

---

## 6. éªŒè¯æ¸…å•

- [ ] æ­£å¸¸å‘é€æ¶ˆæ¯åæ¶ˆæ¯ç±»å‹æ­£ç¡®
- [ ] ç»ˆæ­¢AIå›å¤ååªæœ‰ä¸€æ¡"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"æ¶ˆæ¯
- [ ] è¯¥æ¶ˆæ¯æ˜¾ç¤ºä¸ºAIæ¶ˆæ¯ï¼ˆç™½è‰²æ°”æ³¡ï¼Œå·¦ä¾§ï¼‰
- [ ] ç‚¹å‡»é‡æ–°ç”Ÿæˆåï¼Œä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·è¾“å…¥
- [ ] é‡æ–°ç”Ÿæˆåä¸å‡ºç°æ–°çš„ç”¨æˆ·æ¶ˆæ¯
- [ ] åº”ç”¨é‡å¯åé‡æ–°ç”Ÿæˆä»ç„¶æ­£å¸¸
- [ ] å¤šè½®å¯¹è¯åé‡æ–°ç”Ÿæˆä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·è¾“å…¥
- [ ] å¿«é€Ÿæ“ä½œä¸ä¼šå¯¼è‡´çŠ¶æ€æ··ä¹±

---

## 7. å†å²ç‰ˆæœ¬

### V1 (2026-01-05)
- åˆå§‹åˆ†æï¼šDAOæ–¹æ³•ç¼ºå°‘ç±»å‹éªŒè¯

### V2 (2026-01-05)
- æ·»åŠ `updateAiMessageContentAndStatus`æ–¹æ³•
- å¢å¼ºç±»å‹éªŒè¯

### V3 (2026-01-05)
- æ·±å…¥åˆ†æé‡æ–°ç”Ÿæˆæ—¶çš„æ¶ˆæ¯æŸ¥è¯¢é€»è¾‘
- å‘ç°`lastUserInput`å¯èƒ½ä¸ºç©ºçš„é—®é¢˜
- æå‡ºæ”¹è¿›æ¶ˆæ¯æŸ¥è¯¢é€»è¾‘çš„æ–¹æ¡ˆ

---

**æ–‡æ¡£ç‰ˆæœ¬**: 3.0
**æœ€åæ›´æ–°**: 2026-01-05
**ä¿®å¤çŠ¶æ€**: ğŸ”„ ä¿®å¤ä¸­ï¼ˆV3ï¼‰
