# BUG-00050 开发者模式状态持久化问题

## 📋 基本信息

| 属性 | 值 |
|------|-----|
| **Bug ID** | BUG-00050 |
| **标题** | 开发者模式状态持久化问题 |
| **优先级** | 🔴 高 |
| **状态** | ✅ 已修复 |
| **发现日期** | 2026-01-08 |
| **修复日期** | 2026-01-08 |
| **报告人** | 用户 |
| **影响版本** | 当前版本 |

---

## 🐛 问题描述

### 现象
当用户进入开发者模式后，如果点击联系人或AI军师界面退出设置页面，开发者模式会自动退出。

### 期望行为
开发者模式应该在应用重启后才退出，而不是离开设置页面就退出。

### 复现步骤
1. 打开应用，进入设置页面
2. 连续点击版本号7次，进入开发者模式
3. 确认开发者模式已激活（显示系统提示词管理等开发者选项）
4. 点击底部导航栏的"联系人"或"AI军师"
5. 再次点击"设置"返回设置页面
6. **观察**：开发者模式已退出，开发者选项不再显示

### 实际结果
- 开发者模式在导航离开设置页面后自动退出
- 需要重新点击7次版本号才能再次进入开发者模式

### 期望结果
- 开发者模式在导航离开设置页面后应保持激活状态
- 只有在应用完全重启后才退出开发者模式

---

## 🔍 根本原因分析

### 问题1：DeveloperModeViewModel 状态不持久化

**文件**：`presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/DeveloperModeViewModel.kt`

**问题代码**：
```kotlin
@HiltViewModel
class DeveloperModeViewModel @Inject constructor() : ViewModel() {
    private val _isDeveloperMode = MutableStateFlow(false)
    val isDeveloperMode: StateFlow<Boolean> = _isDeveloperMode.asStateFlow()
    
    // 注意：状态不持久化，每次启动App需重新解锁
}
```

**根本原因**：
1. DeveloperModeViewModel 使用 `@HiltViewModel` 注解，作用域是 Activity 级别
2. 状态存储在内存中（MutableStateFlow），没有持久化
3. 当导航离开设置页面时，ViewModel 可能被重新创建或状态被重置
4. 没有使用 Preferences 持久化开发者模式状态

### 问题2：缺少持久化存储

**缺失的实现**：
- 项目中有多个 Preferences 类用于持久化状态
- 但没有 `DeveloperModePreferences.kt`
- 开发者模式状态完全依赖内存，没有持久化备份

---

## 🎯 影响范围

| 场景 | 影响 | 严重程度 |
|------|------|---------|
| 导航到联系人列表 | 开发者模式退出 | 🔴 高 |
| 导航到AI军师 | 开发者模式退出 | 🔴 高 |
| 导航到其他页面 | 开发者模式退出 | 🔴 高 |
| 应用后台被杀死 | 开发者模式退出 | 🟡 中（可接受） |
| 屏幕旋转 | 可能退出 | 🟡 中 |
| 应用重启 | 开发者模式退出 | ✅ 符合预期 |

---

## 💡 解决方案

### 方案：添加 DeveloperModePreferences 持久化

**步骤1**：创建 `DeveloperModePreferences.kt`
- 位置：`data/src/main/kotlin/com/empathy/ai/data/local/DeveloperModePreferences.kt`
- 功能：持久化开发者模式解锁状态

**步骤2**：修改 `DeveloperModeViewModel.kt`
- 注入 DeveloperModePreferences
- 在解锁时持久化状态
- 在初始化时读取持久化状态

**步骤3**：确保应用重启时重置状态
- 在 Application 启动时清除开发者模式状态
- 或者使用 Session 级别的标记

---

## 📊 技术设计

### 新增文件

#### DeveloperModePreferences.kt
```kotlin
@Singleton
class DeveloperModePreferences @Inject constructor(
    @ApplicationContext private val context: Context
) {
    private val prefs: SharedPreferences = context.getSharedPreferences(
        PREFS_NAME,
        Context.MODE_PRIVATE
    )

    fun isDeveloperModeUnlocked(): Boolean
    fun setDeveloperModeUnlocked(unlocked: Boolean)
    fun getSessionId(): String?
    fun setSessionId(sessionId: String)
    fun reset()

    companion object {
        private const val PREFS_NAME = "developer_mode_prefs"
        private const val KEY_DEVELOPER_MODE_UNLOCKED = "developer_mode_unlocked"
        private const val KEY_SESSION_ID = "session_id"
    }
}
```

### 修改文件

#### DeveloperModeViewModel.kt
- 添加 DeveloperModePreferences 依赖注入
- 在 onVersionClick() 中持久化状态
- 在 exitDeveloperMode() 中清除持久化状态
- 在初始化时检查 Session ID 并恢复状态

---

## 🧪 测试计划

### 单元测试
1. `DeveloperModePreferencesTest` - 测试持久化功能
2. `DeveloperModeViewModelTest` - 测试状态管理

### 集成测试
1. 导航到联系人后返回，开发者模式保持激活
2. 导航到AI军师后返回，开发者模式保持激活
3. 应用重启后，开发者模式退出

### UI测试
1. 完整的开发者模式激活和导航流程测试

---

## ✅ 验收标准

- [x] 导航到其他页面后返回，开发者模式保持激活
- [x] 应用重启后，开发者模式退出
- [x] 所有单元测试通过
- [x] 代码编译通过
- [ ] 在真实设备上验证通过（待人工验收）

---

## 📝 实现任务

| 任务 | 状态 | 预估时间 |
|------|------|---------|
| 创建 DeveloperModeRepository.kt (domain层接口) | ✅ 已完成 | 10分钟 |
| 创建 DeveloperModePreferences.kt (data层) | ✅ 已完成 | 30分钟 |
| 创建 DeveloperModeRepositoryImpl.kt (data层) | ✅ 已完成 | 10分钟 |
| 修改 DeveloperModeViewModel.kt | ✅ 已完成 | 20分钟 |
| 更新 RepositoryModule.kt (DI绑定) | ✅ 已完成 | 5分钟 |
| 编写单元测试 | ✅ 已完成 | 30分钟 |
| 验证编译通过 | ✅ 已完成 | 10分钟 |

**总计**：约2小时

---

## 🔗 相关文件

| 文件 | 路径 | 操作 |
|------|------|------|
| DeveloperModeRepository | `domain/src/main/kotlin/.../DeveloperModeRepository.kt` | ✅ 新增 |
| DeveloperModePreferences | `data/src/main/kotlin/.../DeveloperModePreferences.kt` | ✅ 新增 |
| DeveloperModeRepositoryImpl | `data/src/main/kotlin/.../DeveloperModeRepositoryImpl.kt` | ✅ 新增 |
| DeveloperModeViewModel | `presentation/src/main/kotlin/.../DeveloperModeViewModel.kt` | ✅ 修改 |
| RepositoryModule | `data/src/main/kotlin/.../RepositoryModule.kt` | ✅ 修改 |
| DeveloperModeViewModelTest | `presentation/src/test/.../DeveloperModeViewModelTest.kt` | ✅ 新增 |

---

**文档版本**: 1.0
**最后更新**: 2026-01-08
