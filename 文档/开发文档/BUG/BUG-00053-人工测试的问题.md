# BUG-00053-人工测试的问题

> **状态**: ✅ 问题1和问题2已修复，问题3为新功能需求
> **详细文档**: [BUG-00053-用户画像标签管理三项问题.md](./BUG-00053-用户画像标签管理三项问题.md)

## 问题描述

### 问题1：删除标签后悬浮窗不关闭
- 用户点击删除标签后，UI上标签已删除，但悬浮窗（编辑对话框）没有关闭
- 用户需要点击"取消"或"保存"才能关闭悬浮窗

### 问题2：展开/关闭箭头不起作用
- 点击维度卡片的箭头时，展开/关闭行为异常
- 表现：点击第3个维度时，前2个维度被开关，维度3没有变化
- Bug时好时坏，不是100%复现

### 问题3：长按多选和批量删除功能缺失
- 需要添加长按多选功能
- 需要添加批量删除功能

---

## 诊断分析

### 问题1诊断结果

**根因**：`UserProfileViewModel.localDeleteTag()` 方法没有关闭 `showEditTagDialog` 状态

**代码位置**：`presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/UserProfileViewModel.kt:592-624`

**问题代码**：
```kotlin
private fun localDeleteTag(dimensionKey: String, tag: String) {
    // ... 省略
    _uiState.update { 
        it.copy(
            pendingChanges = newPendingChanges,
            hasUnsavedChanges = true,
            showDeleteConfirmDialog = false,  // 只关闭删除确认框
            // 缺少：showEditTagDialog = false
            // 缺少：currentEditTag = null
            currentEditDimension = null,
            pendingDeleteTag = null
        )
    }
}
```

**对比**：`localAddTag` 和 `localEditTag` 都正确关闭了对话框，只有 `localDeleteTag` 遗漏了关闭 `showEditTagDialog`

**修复方案**：在 `localDeleteTag` 中添加：
```kotlin
showEditTagDialog = false,
currentEditTag = null,
```

---

### 问题2诊断结果

**根因**：Kotlin闭包捕获问题 + 默认展开逻辑缺陷

**代码位置**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/userprofile/UserProfileScreen.kt`

**问题1：闭包捕获问题**（第421行、第504行）
```kotlin
onToggleExpand = { onToggleExpand(dimension.name) },
```
在 `forEach` 循环中，lambda 捕获的是 `dimension` 变量引用，而非当前迭代值。
在某些重组场景下，可能导致回调使用错误的维度名称，
表现为点击维度3的箭头，实际切换的是维度1或维度2。

**问题2：默认展开逻辑缺陷**（第420行、第503行）
```kotlin
isExpanded = dimension.name in expandedDimensions || expandedDimensions.isEmpty(),
```
当 `expandedDimensions` 为空时，**所有维度都默认展开**，
这不符合用户对"独立控制每个维度"的预期。

**修复方案**：

1. 修复闭包问题（推荐使用 `let` 捕获当前值）：
```kotlin
onToggleExpand = let { 
    val currentName = dimension.name 
    { onToggleExpand(currentName) } 
},
```

2. 修复默认展开逻辑：
```kotlin
isExpanded = dimension.name in expandedDimensions
// 移除 expandedDimensions.isEmpty() 的默认展开行为
```

3. 使用 `rememberSaveable` 持久化状态：
```kotlin
var expandedDimensions by rememberSaveable { mutableStateOf(setOf<String>()) }
```

---

### 问题3诊断结果

**根因**：新功能需求，当前实现未包含此功能

**受影响组件**：`EditableTag` 组件只支持单击编辑

**文件位置**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/EditableTag.kt`

**需要实现**：
1. 长按手势检测
2. 多选状态管理
3. 批量删除UI和逻辑

---

## 待处理

- [x] 修复问题1：localDeleteTag 关闭对话框 ✅ 2026-01-09
- [x] 修复问题2：闭包问题和默认展开逻辑 ✅ 2026-01-09
- [ ] 修复问题3：添加长按多选和批量删除功能（新功能需求，需单独任务）
- [ ] 验证修复效果（待人工验收）

---

## 附件

![测试截图](cf6d3370664c036a3689f35c22126054.jpg)
