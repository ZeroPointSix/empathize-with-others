# BUG-00053 用户画像标签管理三项问题

## 基本信息

| 属性 | 值 |
|------|-----|
| **BUG编号** | BUG-00053 |
| **标题** | 用户画像标签管理三项问题 |
| **严重程度** | P2（中等） |
| **影响范围** | 用户画像模块 |
| **发现日期** | 2026-01-09 |
| **发现者** | 人工测试 |
| **状态** | 待修复 |

---

## 问题概述

用户画像界面存在三个问题：
1. **P1** 删除标签后编辑对话框不关闭
2. **P2** 维度卡片展开/关闭箭头行为异常
3. **P3** 缺少长按多选和批量删除功能

---

## 问题1：删除标签后编辑对话框不关闭

### 问题描述
用户在编辑标签对话框中点击删除按钮后，标签被成功删除，但编辑对话框没有自动关闭，用户需要手动点击"取消"或"保存"才能关闭对话框。

### 复现步骤
1. 进入用户画像界面
2. 点击任意已有标签，打开编辑对话框
3. 点击"删除"按钮
4. 确认删除
5. **预期**：对话框关闭，标签被删除
6. **实际**：标签被删除，但对话框仍然显示

### 根因分析

**问题代码位置**：`presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/UserProfileViewModel.kt`

**localDeleteTag方法（第592-624行）缺少关闭对话框的状态更新**：

```kotlin
private fun localDeleteTag(dimensionKey: String, tag: String) {
    if (isBaseDimension(dimensionKey)) {
        // 基础维度
        val currentTags = _uiState.value.getTagsForDimension(dimensionKey).toMutableList()
        currentTags.remove(tag)
        val newPendingChanges = _uiState.value.pendingChanges.toMutableMap()
        newPendingChanges[dimensionKey] = currentTags
        _uiState.update { 
            it.copy(
                pendingChanges = newPendingChanges,
                hasUnsavedChanges = true,
                showDeleteConfirmDialog = false,  // ✓ 关闭删除确认框
                // ✗ 缺少：showEditTagDialog = false
                // ✗ 缺少：currentEditTag = null
                currentEditDimension = null,
                pendingDeleteTag = null
            )
        }
    } else {
        // 自定义维度 - 同样缺少关闭编辑对话框的逻辑
    }
}
```

**对比参考**：
- `localAddTag` 方法：正确关闭 `showAddTagDialog = false`
- `localEditTag` 方法：正确关闭 `showEditTagDialog = false` 和 `currentEditTag = null`

### 修复方案

在 `localDeleteTag` 方法的两个分支中都添加：
```kotlin
showEditTagDialog = false,
currentEditTag = null,
```

---

## 问题2：维度卡片展开/关闭箭头行为异常

### 问题描述
点击维度卡片的展开/关闭箭头时，行为异常：
- 点击第3个维度时，前2个维度被切换，维度3没有变化
- Bug时好时坏，不是100%复现

### 复现步骤
1. 进入用户画像界面
2. 观察所有维度卡片（默认全部展开）
3. 点击第3个维度的箭头
4. **预期**：第3个维度收起
5. **实际**：第1、2个维度被切换，第3个维度无变化（间歇性）

### 根因分析

**问题代码位置**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/userprofile/UserProfileScreen.kt`

**问题1：Kotlin闭包捕获问题（第421行、第504行）**

```kotlin
UserProfileDimension.entries.forEach { dimension ->
    // ...
    onToggleExpand = { onToggleExpand(dimension.name) },  // ✗ 闭包捕获问题
}
```

在 `forEach` 循环中，lambda 捕获的是 `dimension` 变量引用而非当前迭代值。在某些重组场景下，可能导致回调使用错误的维度名称。

**问题2：默认展开逻辑缺陷（第420行、第503行）**

```kotlin
isExpanded = dimension.name in expandedDimensions || expandedDimensions.isEmpty(),
```

当 `expandedDimensions` 为空时，所有维度都默认展开。这导致：
- 初始状态下所有维度展开
- 用户点击某个维度收起时，`expandedDimensions` 从空变为包含其他维度
- 逻辑混乱，不符合用户预期

### 修复方案

**方案1：修复闭包捕获问题**
```kotlin
UserProfileDimension.entries.forEach { dimension ->
    val currentDimensionName = dimension.name  // 捕获当前值
    DimensionCard(
        // ...
        onToggleExpand = { onToggleExpand(currentDimensionName) },
    )
}
```

**方案2：修复默认展开逻辑**
```kotlin
// 移除 expandedDimensions.isEmpty() 的默认展开行为
isExpanded = dimension.name in expandedDimensions
```

**方案3：初始化展开状态**
```kotlin
// 在UserProfileScreenContent中初始化所有维度为展开状态
var expandedDimensions by remember { 
    mutableStateOf(UserProfileDimension.entries.map { it.name }.toSet()) 
}
```

---

## 问题3：长按多选和批量删除功能缺失

### 问题描述
当前标签只支持单击编辑，缺少：
- 长按进入多选模式
- 批量选择标签
- 批量删除功能

### 当前实现分析

**文件位置**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/EditableTag.kt`

```kotlin
@Composable
fun EditableTag(
    text: String,
    onClick: () -> Unit,  // 只支持单击
    modifier: Modifier = Modifier
) {
    Row(
        modifier = modifier
            .clickable(onClick = onClick)  // 只有clickable，没有长按
            // ...
    )
}
```

### 需要实现的功能

1. **长按手势检测**：使用 `combinedClickable` 替代 `clickable`
2. **多选状态管理**：在 `UserProfileUiState` 中添加选中标签集合
3. **批量删除UI**：添加批量操作工具栏
4. **批量删除逻辑**：在 `UserProfileViewModel` 中添加批量删除方法

### 修复方案

**步骤1：修改EditableTag组件**
```kotlin
@Composable
fun EditableTag(
    text: String,
    onClick: () -> Unit,
    onLongClick: () -> Unit = {},  // 新增长按回调
    isSelected: Boolean = false,   // 新增选中状态
    modifier: Modifier = Modifier
) {
    Row(
        modifier = modifier
            .combinedClickable(
                onClick = onClick,
                onLongClick = onLongClick
            )
            .background(if (isSelected) iOSBlue.copy(alpha = 0.2f) else iOSBackground)
    )
}
```

**步骤2：添加UiState字段**
```kotlin
data class UserProfileUiState(
    // ... 现有字段
    val isMultiSelectMode: Boolean = false,
    val selectedTags: Set<Pair<String, String>> = emptySet(),  // (dimensionKey, tag)
)
```

**步骤3：添加UiEvent**
```kotlin
sealed class UserProfileUiEvent {
    // ... 现有事件
    data class ToggleTagSelection(val dimensionKey: String, val tag: String) : UserProfileUiEvent()
    data object EnterMultiSelectMode : UserProfileUiEvent()
    data object ExitMultiSelectMode : UserProfileUiEvent()
    data object DeleteSelectedTags : UserProfileUiEvent()
}
```

---

## 修复优先级

| 问题 | 优先级 | 复杂度 | 预计工时 |
|------|--------|--------|----------|
| 问题1：删除标签后对话框不关闭 | P1 | 低 | 0.5h |
| 问题2：展开/关闭箭头异常 | P2 | 中 | 1h |
| 问题3：长按多选功能缺失 | P3 | 高 | 4h |

---

## 受影响文件

### 问题1
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/UserProfileViewModel.kt`

### 问题2
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/userprofile/UserProfileScreen.kt`

### 问题3
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/EditableTag.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/userprofile/UserProfileUiState.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/userprofile/UserProfileUiEvent.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/UserProfileViewModel.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/DimensionCard.kt`

---

## 测试用例

### 问题1测试用例
```kotlin
@Test
fun `localDeleteTag should close edit dialog`() {
    // Given: 编辑对话框已打开
    viewModel.onEvent(UserProfileUiEvent.ShowEditTagDialog("PERSONALITY_TRAITS", "外向"))
    
    // When: 删除标签
    viewModel.onEvent(UserProfileUiEvent.LocalDeleteTag("PERSONALITY_TRAITS", "外向"))
    
    // Then: 编辑对话框应关闭
    assertFalse(viewModel.uiState.value.showEditTagDialog)
    assertNull(viewModel.uiState.value.currentEditTag)
}
```

### 问题2测试用例
```kotlin
@Test
fun `toggle expand should only affect clicked dimension`() {
    // Given: 初始状态所有维度展开
    val initialExpanded = setOf("PERSONALITY_TRAITS", "VALUES", "INTERESTS")
    
    // When: 点击第3个维度
    onToggleExpand("INTERESTS")
    
    // Then: 只有第3个维度收起
    assertTrue("PERSONALITY_TRAITS" in expandedDimensions)
    assertTrue("VALUES" in expandedDimensions)
    assertFalse("INTERESTS" in expandedDimensions)
}
```

### 问题3测试用例
```kotlin
@Test
fun `long press should enter multi-select mode`() {
    // Given: 正常模式
    assertFalse(viewModel.uiState.value.isMultiSelectMode)
    
    // When: 长按标签
    viewModel.onEvent(UserProfileUiEvent.EnterMultiSelectMode)
    viewModel.onEvent(UserProfileUiEvent.ToggleTagSelection("PERSONALITY_TRAITS", "外向"))
    
    // Then: 进入多选模式，标签被选中
    assertTrue(viewModel.uiState.value.isMultiSelectMode)
    assertTrue(("PERSONALITY_TRAITS" to "外向") in viewModel.uiState.value.selectedTags)
}
```

---

## 修复记录

| 日期 | 修复内容 | 修复者 |
|------|----------|--------|
| 2026-01-09 | 问题1：在localDeleteTag方法中添加showEditTagDialog=false和currentEditTag=null | Kiro |
| 2026-01-09 | 问题2：修复闭包捕获问题，初始化expandedDimensions为所有维度展开，移除isEmpty()默认展开逻辑 | Kiro |

---

## 修复详情

### 问题1修复（已完成）

**修改文件**：`presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/UserProfileViewModel.kt`

**修改内容**：在`localDeleteTag`方法的两个分支中添加：
```kotlin
showEditTagDialog = false,  // BUG-00053: 关闭编辑对话框
currentEditTag = null,      // BUG-00053: 清除当前编辑标签
```

### 问题2修复（已完成）

**修改文件**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/userprofile/UserProfileScreen.kt`

**修改内容**：
1. 初始化`expandedDimensions`为所有基础维度展开：
```kotlin
var expandedDimensions by remember { 
    mutableStateOf(UserProfileDimension.entries.map { it.name }.toSet()) 
}
```

2. 在`IOSBaseDimensionsContent`和`IOSCustomDimensionsContent`中：
   - 捕获当前迭代值避免闭包问题：`val currentDimensionName = dimension.name`
   - 移除`expandedDimensions.isEmpty()`的默认展开逻辑
   - 使用捕获的当前值传递给回调

### 问题3状态（待实现）

问题3是新功能需求（长按多选和批量删除），需要单独创建任务文档进行实现。

---

## 相关文档

- [BUG-00037-用户画像编辑模式](./BUG-00037-用户画像编辑模式.md)
- [BUG-00038-用户画像自定义维度](./BUG-00038-用户画像自定义维度.md)
- [PRD-00021-设置界面UI优化](../PRD/PRD-00021-设置界面UI优化.md)
