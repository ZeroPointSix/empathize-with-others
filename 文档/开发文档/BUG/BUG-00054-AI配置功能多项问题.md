# BUG-00054 AIé…ç½®åŠŸèƒ½å¤šé¡¹é—®é¢˜

> **åˆ›å»ºæ—¶é—´**: 2026-01-09  
> **ä¸¥é‡ç¨‹åº¦**: P0 (æ ¸å¿ƒåŠŸèƒ½å¤±æ•ˆ)  
> **å½±å“èŒƒå›´**: AIé…ç½®ã€æ‚¬æµ®çª—å‘é€ã€è¶…æ—¶è®¾ç½®  
> **çŠ¶æ€**: ğŸ”„ ä¿®å¤ä¸­ï¼ˆç¬¬äºŒè½®ï¼‰
> **ç¬¬ä¸€è½®ä¿®å¤**: 2026-01-09 - éƒ¨åˆ†ä¿®å¤ï¼Œå®é™…æµ‹è¯•ä»å­˜åœ¨é—®é¢˜
> **ç¬¬äºŒè½®åˆ†æ**: 2026-01-09 - å‘ç°çœŸæ­£æ ¹å› 

---

## ğŸ“‹ é—®é¢˜æè¿°

### ç”¨æˆ·åé¦ˆåŸæ–‡
```
æˆ‘ä»¬åœ¨æ‰‹åŠ¨æ¨¡å‹æ·»åŠ é…ç½®çš„æ—¶å€™æ²¡æœ‰ä½œç”¨
å¹¶ä¸”æˆ‘ä»¬æ‰‹åŠ¨æ·»åŠ çš„åŠŸèƒ½æ²¡æœ‰ä½œç”¨ã€‚æ·»åŠ æ¨¡å‹é…ç½®
å¹¶ä¸”æˆ‘ä»¬çš„è®¾ç½®è¶…æ—¶æ—¶é—´æ²¡æœ‰ä½œç”¨åœ¨ä¸‡èƒ½çš„AIé…ç½®å½“ä¸­
æ‚¬æµ®çª—å¿«é€Ÿå‘é€é…ç½®æ˜¾ç¤ºå¤±è´¥
è¿˜æœ‰å­—ä½“é¢œè‰²çš„è®¾è®¡ä¸ºä»€ä¹ˆè¿™ä¹ˆåˆ«æ‰­
```

### é—®é¢˜æ‹†è§£

| ç¼–å· | é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ |
|------|------|---------|------|
| P1 | æ‰‹åŠ¨æ·»åŠ æ¨¡å‹é…ç½®æ²¡æœ‰ä½œç”¨ | P0 | âœ… å·²ä¿®å¤ |
| P2 | æ‚¬æµ®çª—å¿«é€Ÿå‘é€æ˜¾ç¤ºå¤±è´¥ | P0 | âœ… å·²ä¿®å¤ |
| P3 | è¶…æ—¶è®¾ç½®æ²¡æœ‰ä½œç”¨ | P1 | ğŸ”„ ä¿®å¤ä¸­ï¼ˆå‘ç°çœŸæ­£æ ¹å› ï¼‰ |
| P4 | å­—ä½“é¢œè‰²è®¾è®¡é—®é¢˜ | P2 | å¦å¼€BUG-00055 |

---

## ğŸ”´ ç¬¬äºŒè½®æ·±åº¦åˆ†æï¼ˆ2026-01-09ï¼‰

### ä¸ºä»€ä¹ˆç¬¬ä¸€è½®ä¿®å¤æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ

ç»è¿‡æ·±åº¦ä»£ç åˆ†æï¼Œå‘ç°ç¬¬ä¸€è½®ä¿®å¤å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

#### P3é—®é¢˜çš„çœŸæ­£æ ¹å› 

**ç¬¬ä¸€è½®ä¿®å¤çš„é—®é¢˜**ï¼š
- âœ… åœ¨ `AiProviderRepositoryImpl.testConnection()` ä¸­ä½¿ç”¨äº† `provider.timeoutMs`
- âœ… åœ¨ `AiProviderRepositoryImpl.fetchAvailableModels()` ä¸­ä½¿ç”¨äº† `provider.timeoutMs`
- âŒ ä½†è¿™åªå½±å“è¿æ¥æµ‹è¯•å’Œæ¨¡å‹è·å–ï¼Œ**ä¸å½±å“å®é™…çš„AIè°ƒç”¨**ï¼

**çœŸæ­£çš„æ ¹å› é“¾**ï¼š

```
ç”¨æˆ·è®¾ç½®è¶…æ—¶ â†’ updateRequestTimeout() â†’ uiState.requestTimeout
                                              â†“
                                    âŒ æ²¡æœ‰ä¿å­˜åˆ° Provider
                                              â†“
saveProvider() â†’ æ„å»º AiProvider â†’ âŒ æ²¡æœ‰è®¾ç½® timeoutMs å­—æ®µ
                                              â†“
                              ä½¿ç”¨é»˜è®¤å€¼ 30000ms
                                              â†“
å®é™…AIè°ƒç”¨ â†’ AiRepositoryImpl â†’ Retrofit api â†’ OkHttpClient
                                              â†“
                              âŒ ä½¿ç”¨å…¨å±€è¶…æ—¶é…ç½®ï¼ˆ45ç§’ï¼‰
                              âŒ ä¸ä½¿ç”¨ Provider çš„ timeoutMs
```

**é—®é¢˜1ï¼šAiConfigViewModel.saveProvider() æ²¡æœ‰è®¾ç½® timeoutMs**

ä½ç½®ï¼š`AiConfigViewModel.kt:420-440`

```kotlin
val provider = AiProvider(
    id = currentState.editingProvider?.id ?: UUID.randomUUID().toString(),
    name = currentState.formName.trim(),
    baseUrl = currentState.formBaseUrl.trim(),
    apiKey = currentState.formApiKey.trim(),
    models = currentState.formModels.map { ... },
    defaultModelId = currentState.formDefaultModelId,
    isDefault = shouldBeDefault,
    temperature = currentState.formTemperature,
    maxTokens = currentState.formMaxTokens,
    createdAt = currentState.editingProvider?.createdAt ?: System.currentTimeMillis()
    // âŒ æ²¡æœ‰è®¾ç½® timeoutMsï¼ä½¿ç”¨é»˜è®¤å€¼ 30000ms
)
```

**é—®é¢˜2ï¼šAiConfigUiState æ²¡æœ‰ formTimeoutMs å­—æ®µ**

ä½ç½®ï¼š`AiConfigUiState.kt`

```kotlin
data class AiConfigUiState(
    // ... å…¶ä»–å­—æ®µ
    val requestTimeout: Int = 30,  // å…¨å±€è®¾ç½®ï¼Œå•ä½æ˜¯ç§’
    // âŒ æ²¡æœ‰ formTimeoutMs å­—æ®µç”¨äºè¡¨å•
)
```

**é—®é¢˜3ï¼šå®é™…AIè°ƒç”¨ä¸ä½¿ç”¨Providerçš„timeoutMs**

ä½ç½®ï¼š`AiRepositoryImpl.kt`

```kotlin
// AIè°ƒç”¨ä½¿ç”¨ Retrofit çš„ api å¯¹è±¡
val response = withRetry { api.chatCompletion(url, headers, request) }
// api å¯¹è±¡çš„è¶…æ—¶æ˜¯å…¨å±€é…ç½®çš„ï¼ˆOkHttpClientFactory: 45ç§’è¯»å–è¶…æ—¶ï¼‰
// Provider çš„ timeoutMs æ²¡æœ‰è¢«ä½¿ç”¨ï¼
```

---

## ğŸ” æ ¹å› åˆ†æ

### é—®é¢˜P1ï¼šæ‰‹åŠ¨æ·»åŠ æ¨¡å‹é…ç½®æ²¡æœ‰ä½œç”¨

#### ç—‡çŠ¶
ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ æ¨¡å‹åï¼Œä¿å­˜æ“ä½œçœ‹ä¼¼æˆåŠŸï¼Œä½†å®é™…é…ç½®æ²¡æœ‰ç”Ÿæ•ˆã€‚

#### æ ¹å› å®šä½
ç»è¿‡ä»£ç åˆ†æï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜é“¾ï¼š

**1. formDefaultModelId éªŒè¯å¤±è´¥ï¼ˆä¸»å› ï¼‰**

ä½ç½®ï¼š`SaveProviderUseCase.kt:59-66`

```kotlin
// éªŒè¯é»˜è®¤æ¨¡å‹
if (provider.models.none { it.id == provider.defaultModelId }) {
    return Result.failure(ValidationException("é»˜è®¤æ¨¡å‹å¿…é¡»åœ¨æ¨¡å‹åˆ—è¡¨ä¸­"))
}
```

**é—®é¢˜**ï¼š
- å½“ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ æ¨¡å‹æ—¶ï¼Œ`addFormModel()` æ–¹æ³•å·²ç»æ­£ç¡®è®¾ç½®äº† `formDefaultModelId`
- ä½†å¦‚æœç”¨æˆ·åˆ é™¤äº†é»˜è®¤æ¨¡å‹ååˆæ·»åŠ æ–°æ¨¡å‹ï¼Œ`formDefaultModelId` å¯èƒ½æŒ‡å‘å·²åˆ é™¤çš„æ¨¡å‹
- éªŒè¯å¤±è´¥åï¼Œ`Result.failure` è¢«è¿”å›ï¼Œä½†UIå±‚å¯èƒ½æ²¡æœ‰æ­£ç¡®æ˜¾ç¤ºé”™è¯¯

**2. é”™è¯¯å¤„ç†ä¸å®Œæ•´**

ä½ç½®ï¼š`AiConfigViewModel.kt:450-460`

```kotlin
performOperation(
    operation = { saveProviderUseCase(provider) },
    onSuccess = { ... },
    onError = { errorMessage ->
        _uiState.update {
            it.copy(
                error = errorMessage,  // é”™è¯¯è¢«è®¾ç½®ï¼Œä½†å¯èƒ½æ²¡æœ‰æ˜¾ç¤ºç»™ç”¨æˆ·
                isSaving = false
            )
        }
    }
)
```

**é—®é¢˜**ï¼šé”™è¯¯æ¶ˆæ¯è¢«è®¾ç½®åˆ° `uiState.error`ï¼Œä½†UIå¯èƒ½æ²¡æœ‰æ˜¾ç¤ºè¿™ä¸ªé”™è¯¯ã€‚

### é—®é¢˜P2ï¼šæ‚¬æµ®çª—å¿«é€Ÿå‘é€æ˜¾ç¤ºå¤±è´¥

#### ç—‡çŠ¶
ç”¨æˆ·åœ¨æ‚¬æµ®çª—ä¸­ç‚¹å‡»å‘é€ï¼Œç›´æ¥æ˜¾ç¤ºå¤±è´¥ï¼Œæ²¡æœ‰è°ƒç”¨AIã€‚

#### æ ¹å› å®šä½

**1. æ— é»˜è®¤ä¾›åº”å•†æ—¶ç›´æ¥è¿”å›é”™è¯¯**

ä½ç½®ï¼š`GenerateReplyUseCase.kt`ã€`PolishDraftUseCase.kt`ã€`AnalyzeChatUseCase.kt`

```kotlin
val defaultProvider = aiProviderRepository.getDefaultProvider().getOrNull()
    ?: return Result.failure(FloatingWindowError.NoProviderConfigured)
```

**é—®é¢˜**ï¼š
- å¦‚æœç”¨æˆ·æ·»åŠ äº†ä¾›åº”å•†ä½†æ²¡æœ‰è®¾ç½®ä¸ºé»˜è®¤ï¼Œ`getDefaultProvider()` è¿”å› null
- æ²¡æœ‰è‡ªåŠ¨é€‰æ‹©é€»è¾‘ï¼ˆåº”è¯¥é€‰æ‹©ç¬¬ä¸€ä¸ªä¾›åº”å•†ä½œä¸ºé™çº§ï¼‰

**2. getDefaultProvider å®ç°**

ä½ç½®ï¼š`AiProviderRepositoryImpl.kt:82-89`

```kotlin
override suspend fun getDefaultProvider(): Result<AiProvider?> {
    return try {
        val entity = dao.getDefaultProvider().first()
        Result.success(entity?.let { entityToDomain(it) })
    } catch (e: Exception) {
        Result.failure(e)
    }
}
```

**é—®é¢˜**ï¼šå½“æ²¡æœ‰é»˜è®¤ä¾›åº”å•†æ—¶ï¼Œç›´æ¥è¿”å› `null`ï¼Œæ²¡æœ‰é™çº§é€»è¾‘ã€‚

### é—®é¢˜P3ï¼šè¶…æ—¶è®¾ç½®æ²¡æœ‰ä½œç”¨

#### ç—‡çŠ¶
ç”¨æˆ·åœ¨AIé…ç½®é¡µé¢è®¾ç½®çš„è¶…æ—¶æ—¶é—´æ²¡æœ‰åº”ç”¨åˆ°å®é™…çš„APIè¯·æ±‚ä¸­ã€‚

#### æ ¹å› å®šä½

**1. UIå±‚è¶…æ—¶è®¾ç½®åªæ›´æ–°çŠ¶æ€ï¼Œæ²¡æœ‰æŒä¹…åŒ–**

ä½ç½®ï¼š`AiConfigViewModel.kt:145-147`

```kotlin
private fun updateRequestTimeout(timeout: Int) {
    _uiState.update { it.copy(requestTimeout = timeout) }
    // æ²¡æœ‰è°ƒç”¨ä»»ä½•æŒä¹…åŒ–æ–¹æ³•ï¼
}
```

**2. OkHttpå®¢æˆ·ç«¯è¶…æ—¶ç¡¬ç¼–ç **

ä½ç½®ï¼š`AiProviderRepositoryImpl.kt:157-160`

```kotlin
val client = OkHttpClient.Builder()
    .connectTimeout(10, TimeUnit.SECONDS)  // ç¡¬ç¼–ç 10ç§’
    .readTimeout(10, TimeUnit.SECONDS)     // ç¡¬ç¼–ç 10ç§’
    .build()
```

**é—®é¢˜**ï¼š
- `AiProvider` æ¨¡å‹ä¸­æœ‰ `timeoutMs` å­—æ®µ
- ä½† `testConnection()` å’Œ `fetchAvailableModels()` éƒ½æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªå­—æ®µ
- è¶…æ—¶å€¼è¢«ç¡¬ç¼–ç ä¸º10ç§’

---

## ğŸ¯ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤P1ï¼šæ‰‹åŠ¨æ·»åŠ æ¨¡å‹é…ç½®

#### æ–¹æ¡ˆ1ï¼šå¢å¼ºé”™è¯¯æç¤ºï¼ˆæ¨èï¼‰

åœ¨ `AiConfigScreen.kt` ä¸­æ·»åŠ é”™è¯¯æç¤ºæ˜¾ç¤ºï¼š

```kotlin
// æ˜¾ç¤ºä¿å­˜é”™è¯¯
if (uiState.error != null) {
    Snackbar(
        modifier = Modifier.padding(16.dp),
        action = {
            TextButton(onClick = { viewModel.onEvent(AiConfigUiEvent.ClearError) }) {
                Text("å…³é—­")
            }
        }
    ) {
        Text(uiState.error!!)
    }
}
```

#### æ–¹æ¡ˆ2ï¼šè‡ªåŠ¨ä¿®å¤ formDefaultModelId

åœ¨ `removeFormModel()` ä¸­ï¼Œå½“åˆ é™¤é»˜è®¤æ¨¡å‹æ—¶è‡ªåŠ¨é€‰æ‹©æ–°çš„é»˜è®¤ï¼š

```kotlin
private fun removeFormModel(modelId: String) {
    val currentState = _uiState.value
    val updatedModels = currentState.formModels.filter { it.id != modelId }

    _uiState.update {
        it.copy(
            formModels = updatedModels,
            // å¦‚æœåˆ é™¤çš„æ˜¯é»˜è®¤æ¨¡å‹ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª
            formDefaultModelId = if (currentState.formDefaultModelId == modelId) {
                updatedModels.firstOrNull()?.id ?: ""
            } else {
                currentState.formDefaultModelId
            },
            formModelsError = if (updatedModels.isEmpty()) "è‡³å°‘éœ€è¦ä¸€ä¸ªæ¨¡å‹" else null
        )
    }
}
```

**æ³¨æ„**ï¼šä»£ç å®¡æŸ¥å‘ç°è¿™ä¸ªé€»è¾‘å·²ç»å­˜åœ¨ï¼é—®é¢˜å¯èƒ½åœ¨å…¶ä»–åœ°æ–¹ã€‚

### ä¿®å¤P2ï¼šæ‚¬æµ®çª—å¿«é€Ÿå‘é€å¤±è´¥

#### æ–¹æ¡ˆï¼šæ·»åŠ é»˜è®¤ä¾›åº”å•†é™çº§é€»è¾‘

ä¿®æ”¹ `AiProviderRepositoryImpl.getDefaultProvider()`ï¼š

```kotlin
override suspend fun getDefaultProvider(): Result<AiProvider?> {
    return try {
        // é¦–å…ˆå°è¯•è·å–æ ‡è®°ä¸ºé»˜è®¤çš„ä¾›åº”å•†
        val defaultEntity = dao.getDefaultProvider().first()
        if (defaultEntity != null) {
            return Result.success(entityToDomain(defaultEntity))
        }
        
        // é™çº§ï¼šå¦‚æœæ²¡æœ‰é»˜è®¤ä¾›åº”å•†ï¼Œè¿”å›ç¬¬ä¸€ä¸ªä¾›åº”å•†
        val firstProvider = dao.getAllProviders().first().firstOrNull()
        Result.success(firstProvider?.let { entityToDomain(it) })
    } catch (e: Exception) {
        Result.failure(e)
    }
}
```

### ä¿®å¤P3ï¼šè¶…æ—¶è®¾ç½®æ²¡æœ‰ä½œç”¨

#### æ–¹æ¡ˆ1ï¼šä½¿ç”¨ Provider çš„ timeoutMs å­—æ®µ

ä¿®æ”¹ `AiProviderRepositoryImpl.testConnection()`ï¼š

```kotlin
override suspend fun testConnection(provider: AiProvider): Result<ConnectionTestResult> {
    // ...
    val timeoutSeconds = (provider.timeoutMs / 1000).coerceIn(5, 120)
    
    val client = OkHttpClient.Builder()
        .connectTimeout(timeoutSeconds.toLong(), TimeUnit.SECONDS)
        .readTimeout(timeoutSeconds.toLong(), TimeUnit.SECONDS)
        .build()
    // ...
}
```

#### æ–¹æ¡ˆ2ï¼šæŒä¹…åŒ–å…¨å±€è¶…æ—¶è®¾ç½®

å¦‚æœéœ€è¦å…¨å±€è¶…æ—¶è®¾ç½®ï¼Œéœ€è¦ï¼š
1. åˆ›å»º `AiConfigPreferences` ç±»å­˜å‚¨å…¨å±€è®¾ç½®
2. åœ¨ `updateRequestTimeout()` ä¸­è°ƒç”¨æŒä¹…åŒ–
3. åœ¨åˆ›å»º OkHttpClient æ—¶è¯»å–å…¨å±€è®¾ç½®

---

## ğŸ“Š å½±å“èŒƒå›´è¯„ä¼°

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | å½±å“ |
|------|---------|------|
| `AiProviderRepositoryImpl.kt` | ä¿®æ”¹ | æ·»åŠ é™çº§é€»è¾‘ã€åº”ç”¨è¶…æ—¶é…ç½® |
| `AiConfigViewModel.kt` | å¯èƒ½ä¿®æ”¹ | å¢å¼ºé”™è¯¯å¤„ç† |
| `AiConfigScreen.kt` | å¯èƒ½ä¿®æ”¹ | æ˜¾ç¤ºé”™è¯¯æç¤º |

---

## âœ… éªŒæ”¶æ ‡å‡†

### P1ï¼šæ‰‹åŠ¨æ·»åŠ æ¨¡å‹é…ç½®
- [ ] ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ æ¨¡å‹åï¼Œä¿å­˜æˆåŠŸ
- [ ] ä¿å­˜å¤±è´¥æ—¶æ˜¾ç¤ºæ˜ç¡®çš„é”™è¯¯æç¤º
- [ ] åˆ é™¤é»˜è®¤æ¨¡å‹åï¼Œè‡ªåŠ¨é€‰æ‹©æ–°çš„é»˜è®¤æ¨¡å‹

### P2ï¼šæ‚¬æµ®çª—å¿«é€Ÿå‘é€
- [ ] å³ä½¿æ²¡æœ‰è®¾ç½®é»˜è®¤ä¾›åº”å•†ï¼Œä¹Ÿèƒ½ä½¿ç”¨ç¬¬ä¸€ä¸ªä¾›åº”å•†
- [ ] æ²¡æœ‰ä»»ä½•ä¾›åº”å•†æ—¶ï¼Œæ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º

### P3ï¼šè¶…æ—¶è®¾ç½®
- [ ] ç”¨æˆ·è®¾ç½®çš„è¶…æ—¶æ—¶é—´åº”ç”¨åˆ°APIè¯·æ±‚
- [ ] è¶…æ—¶è®¾ç½®è¢«æ­£ç¡®æŒä¹…åŒ–

---

## ğŸ“ æµ‹è¯•ç”¨ä¾‹

### å•å…ƒæµ‹è¯•

1. `AiProviderRepositoryImplTest`
   - `getDefaultProvider_whenNoDefault_returnsFirstProvider()`
   - `testConnection_usesProviderTimeout()`

2. `SaveProviderUseCaseTest`
   - `invoke_whenDefaultModelNotInList_returnsFailure()`
   - `invoke_whenValidProvider_savesSuccessfully()`

3. `AiConfigViewModelTest`
   - `removeFormModel_whenRemovingDefault_selectsNewDefault()`
   - `saveProvider_whenValidationFails_showsError()`

### é›†æˆæµ‹è¯•

1. æ‰‹åŠ¨æ·»åŠ æ¨¡å‹ â†’ ä¿å­˜ â†’ éªŒè¯æ•°æ®åº“
2. æ‚¬æµ®çª—å‘é€ â†’ æ— é»˜è®¤ä¾›åº”å•† â†’ ä½¿ç”¨ç¬¬ä¸€ä¸ªä¾›åº”å•†
3. è®¾ç½®è¶…æ—¶ â†’ å‘é€è¯·æ±‚ â†’ éªŒè¯è¶…æ—¶ç”Ÿæ•ˆ

---

## ğŸ“… ä¿®å¤è®¡åˆ’

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|---------|
| 1 | ç¼–å†™å•å…ƒæµ‹è¯• | 30åˆ†é’Ÿ |
| 2 | ä¿®å¤P2ï¼ˆæ‚¬æµ®çª—å‘é€ï¼‰ | 15åˆ†é’Ÿ |
| 3 | ä¿®å¤P3ï¼ˆè¶…æ—¶è®¾ç½®ï¼‰ | 20åˆ†é’Ÿ |
| 4 | ä¿®å¤P1ï¼ˆé”™è¯¯æç¤ºï¼‰ | 15åˆ†é’Ÿ |
| 5 | è¿è¡Œæµ‹è¯•éªŒè¯ | 10åˆ†é’Ÿ |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [BUG-00054-æ·±åº¦åˆ†ææŠ¥å‘Š.md](./BUG-00054-æ·±åº¦åˆ†ææŠ¥å‘Š.md)
- [BUG-00054-äººå·¥æµ‹è¯•é—®é¢˜.md](./BUG-00054-äººå·¥æµ‹è¯•é—®é¢˜.md)
- [BUG-00055-å…¨å±€å­—ä½“ç¡¬ç¼–ç é—®é¢˜.md](./BUG-00055-å…¨å±€å­—ä½“ç¡¬ç¼–ç é—®é¢˜.md)


---

## âœ… ä¿®å¤è®°å½•

### ä¿®å¤æ—¶é—´
2026-01-09

### ä¿®å¤å†…å®¹

#### 1. P2ä¿®å¤ï¼šæ‚¬æµ®çª—å¿«é€Ÿå‘é€å¤±è´¥ - æ·»åŠ é»˜è®¤ä¾›åº”å•†é™çº§é€»è¾‘

**æ–‡ä»¶**: `data/src/main/kotlin/com/empathy/ai/data/repository/AiProviderRepositoryImpl.kt`

**ä¿®æ”¹å†…å®¹**:
- åœ¨ `getDefaultProvider()` æ–¹æ³•ä¸­æ·»åŠ é™çº§é€»è¾‘
- å½“æ²¡æœ‰æ ‡è®°ä¸ºé»˜è®¤çš„ä¾›åº”å•†æ—¶ï¼Œè‡ªåŠ¨è¿”å›ç¬¬ä¸€ä¸ªå¯ç”¨çš„ä¾›åº”å•†
- åªæœ‰åœ¨å®Œå…¨æ²¡æœ‰ä¾›åº”å•†æ—¶æ‰è¿”å› null

```kotlin
override suspend fun getDefaultProvider(): Result<AiProvider?> {
    return try {
        // é¦–å…ˆå°è¯•è·å–æ ‡è®°ä¸ºé»˜è®¤çš„ä¾›åº”å•†
        val defaultEntity = dao.getDefaultProvider().first()
        if (defaultEntity != null) {
            return Result.success(entityToDomain(defaultEntity))
        }
        
        // BUG-00054é™çº§é€»è¾‘ï¼šå¦‚æœæ²¡æœ‰é»˜è®¤ä¾›åº”å•†ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå¯ç”¨çš„ä¾›åº”å•†
        val allProviders = dao.getAllProviders().first()
        val firstProvider = allProviders.firstOrNull()
        Result.success(firstProvider?.let { entityToDomain(it) })
    } catch (e: Exception) {
        Result.failure(e)
    }
}
```

#### 2. P3ä¿®å¤ï¼šè¶…æ—¶è®¾ç½®æ²¡æœ‰ä½œç”¨ - åº”ç”¨providerçš„è¶…æ—¶é…ç½®

**æ–‡ä»¶**: `data/src/main/kotlin/com/empathy/ai/data/repository/AiProviderRepositoryImpl.kt`

**ä¿®æ”¹å†…å®¹**:
- åœ¨ `testConnection()` æ–¹æ³•ä¸­ä½¿ç”¨ `provider.timeoutMs` è€Œä¸æ˜¯ç¡¬ç¼–ç çš„10ç§’
- åœ¨ `fetchAvailableModels()` æ–¹æ³•ä¸­åŒæ ·åº”ç”¨è¶…æ—¶é…ç½®
- è¶…æ—¶å€¼èŒƒå›´é™åˆ¶åœ¨5-120ç§’ä¹‹é—´

```kotlin
// BUG-00054ä¿®å¤ï¼šä½¿ç”¨providerçš„è¶…æ—¶é…ç½®ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç 
val timeoutSeconds = (provider.timeoutMs / 1000).coerceIn(5, 120).toLong()

val client = OkHttpClient.Builder()
    .connectTimeout(timeoutSeconds, TimeUnit.SECONDS)
    .readTimeout(timeoutSeconds, TimeUnit.SECONDS)
    .build()
```

#### 3. P1å¢å¼ºï¼šæ·»åŠ è¯¦ç»†æ—¥å¿—ä¾¿äºè°ƒè¯•

**æ–‡ä»¶**: `data/src/main/kotlin/com/empathy/ai/data/repository/AiProviderRepositoryImpl.kt`

**ä¿®æ”¹å†…å®¹**:
- åœ¨ `saveProvider()` æ–¹æ³•ä¸­æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- è®°å½•ä¾›åº”å•†IDã€åç§°ã€æ¨¡å‹æ•°é‡ã€é»˜è®¤æ¨¡å‹IDã€è¶…æ—¶é…ç½®ç­‰å…³é”®ä¿¡æ¯
- ä¾¿äºåç»­è°ƒè¯•å’Œé—®é¢˜æ’æŸ¥

### æ–°å¢æµ‹è¯•æ–‡ä»¶

1. `data/src/test/kotlin/com/empathy/ai/data/repository/AiProviderRepositoryBug00054Test.kt`
   - æµ‹è¯• getDefaultProvider é™çº§é€»è¾‘
   - æµ‹è¯• testConnection è¶…æ—¶é…ç½®
   - æµ‹è¯• saveProvider é”™è¯¯å¤„ç†

2. `presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/AiConfigViewModelBug00054Test.kt`
   - æµ‹è¯•æ·»åŠ æ¨¡å‹æ—¶è‡ªåŠ¨è®¾ç½®é»˜è®¤æ¨¡å‹
   - æµ‹è¯•åˆ é™¤é»˜è®¤æ¨¡å‹æ—¶è‡ªåŠ¨é€‰æ‹©æ–°é»˜è®¤
   - æµ‹è¯•ä¿å­˜å¤±è´¥æ—¶æ­£ç¡®æ˜¾ç¤ºé”™è¯¯

### æ„å»ºéªŒè¯
- âœ… `./gradlew :data:assembleDebug` æ„å»ºæˆåŠŸ
- âœ… `./gradlew assembleDebug` å®Œæ•´åº”ç”¨æ„å»ºæˆåŠŸ

---

## ğŸ“ éªŒæ”¶è¯´æ˜

è¯·ç”¨æˆ·è¿›è¡Œä»¥ä¸‹æµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœï¼š

### æµ‹è¯•P2ï¼šæ‚¬æµ®çª—å‘é€
1. æ·»åŠ ä¸€ä¸ªAIæœåŠ¡å•†ï¼Œä½†ä¸è®¾ç½®ä¸ºé»˜è®¤
2. æ‰“å¼€æ‚¬æµ®çª—ï¼Œå°è¯•å‘é€æ¶ˆæ¯
3. **é¢„æœŸç»“æœ**: åº”è¯¥èƒ½å¤Ÿæ­£å¸¸å‘é€ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å•†

### æµ‹è¯•P3ï¼šè¶…æ—¶è®¾ç½®
1. åœ¨AIé…ç½®é¡µé¢è®¾ç½®è¾ƒé•¿çš„è¶…æ—¶æ—¶é—´ï¼ˆå¦‚60ç§’ï¼‰
2. æµ‹è¯•è¿æ¥æˆ–è·å–æ¨¡å‹åˆ—è¡¨
3. **é¢„æœŸç»“æœ**: è¶…æ—¶æ—¶é—´åº”è¯¥ç”Ÿæ•ˆ

### æµ‹è¯•P1ï¼šæ¨¡å‹é…ç½®
1. æ‰‹åŠ¨æ·»åŠ æ¨¡å‹é…ç½®
2. ä¿å­˜æœåŠ¡å•†
3. **é¢„æœŸç»“æœ**: é…ç½®åº”è¯¥æ­£ç¡®ä¿å­˜ï¼Œå¦‚æœ‰é”™è¯¯ä¼šæ˜¾ç¤ºæç¤º

### æ—¥å¿—æŸ¥çœ‹
å¦‚æœä»æœ‰é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
adb logcat -s AiProviderRepository:D
```


---

## ğŸ”§ ç¬¬äºŒè½®ä¿®å¤æ–¹æ¡ˆï¼ˆ2026-01-09ï¼‰

### ä¿®å¤P3ï¼šè¶…æ—¶è®¾ç½®æ²¡æœ‰ä½œç”¨ï¼ˆå®Œæ•´ä¿®å¤ï¼‰

#### ä¿®å¤1ï¼šAiConfigUiState æ·»åŠ  formTimeoutMs å­—æ®µ

```kotlin
data class AiConfigUiState(
    // ... ç°æœ‰å­—æ®µ
    
    // ç¬¬äºŒè½®ä¿®å¤ï¼šæ·»åŠ è¡¨å•è¶…æ—¶è®¾ç½®ï¼ˆæ¯«ç§’ï¼‰
    val formTimeoutMs: Long = 30000L,
)
```

#### ä¿®å¤2ï¼šAiConfigUiEvent æ·»åŠ  UpdateFormTimeoutMs äº‹ä»¶

```kotlin
sealed class AiConfigUiEvent {
    // ... ç°æœ‰äº‹ä»¶
    
    // ç¬¬äºŒè½®ä¿®å¤ï¼šè¶…æ—¶è®¾ç½®äº‹ä»¶
    data class UpdateFormTimeoutMs(val timeoutMs: Long) : AiConfigUiEvent()
}
```

#### ä¿®å¤3ï¼šAiConfigViewModel æ·»åŠ è¶…æ—¶æ›´æ–°æ–¹æ³•

```kotlin
private fun updateFormTimeoutMs(timeoutMs: Long) {
    val safeTimeout = timeoutMs.coerceIn(5000L, 120000L)
    _uiState.update { it.copy(formTimeoutMs = safeTimeout) }
}
```

#### ä¿®å¤4ï¼šAiConfigViewModel.saveProvider() ä½¿ç”¨ formTimeoutMs

```kotlin
val provider = AiProvider(
    // ... ç°æœ‰å­—æ®µ
    timeoutMs = currentState.formTimeoutMs,  // æ–°å¢ï¼šä½¿ç”¨è¡¨å•è¶…æ—¶å€¼
)
```

#### ä¿®å¤5ï¼šAiConfigViewModel.showEditDialog() åŠ è½½ timeoutMs

```kotlin
private fun showEditDialog(provider: AiProvider) {
    _uiState.update {
        it.copy(
            // ... ç°æœ‰å­—æ®µ
            formTimeoutMs = provider.timeoutMs,  // æ–°å¢ï¼šåŠ è½½è¶…æ—¶å€¼
        )
    }
}
```

#### ä¿®å¤6ï¼šAiRepositoryImpl æ·»åŠ åç¨‹è¶…æ—¶æ§åˆ¶

```kotlin
// åœ¨ analyzeChatã€polishDraftã€generateReply ç­‰æ–¹æ³•ä¸­æ·»åŠ 
val timeoutMs = provider.timeoutMs.coerceIn(5000L, 120000L)
val response = withTimeout(timeoutMs) {
    withRetry { api.chatCompletion(url, headers, request) }
}
```

---

## ğŸ“ ç¬¬äºŒè½®æµ‹è¯•ç”¨ä¾‹

### æ–°å¢æµ‹è¯•æ–‡ä»¶

1. `AiConfigViewModelBug00054V2Test.kt`
   - `saveProvider_shouldUseFormTimeoutMs()`
   - `showEditDialog_shouldLoadTimeoutMs()`
   - `updateFormTimeoutMs_shouldUpdateState()`

2. `AiRepositoryImplBug00054Test.kt`
   - `analyzeChat_shouldRespectProviderTimeout()`
   - `polishDraft_shouldRespectProviderTimeout()`
   - `generateReply_shouldRespectProviderTimeout()`

---

## âœ… ç¬¬äºŒè½®éªŒæ”¶æ ‡å‡†

### P3ï¼šè¶…æ—¶è®¾ç½®ï¼ˆå®Œæ•´éªŒæ”¶ï¼‰
- [ ] ç”¨æˆ·åœ¨è¡¨å•ä¸­è®¾ç½®çš„è¶…æ—¶æ—¶é—´è¢«æ­£ç¡®ä¿å­˜åˆ° Provider
- [ ] ç¼–è¾‘ Provider æ—¶ï¼Œè¶…æ—¶æ—¶é—´è¢«æ­£ç¡®åŠ è½½åˆ°è¡¨å•
- [ ] å®é™… AI è°ƒç”¨ä½¿ç”¨ Provider çš„è¶…æ—¶é…ç½®
- [ ] è¶…æ—¶å€¼è¢«é™åˆ¶åœ¨ 5-120 ç§’èŒƒå›´å†…

---

## ğŸ“… ç¬¬äºŒè½®ä¿®å¤è®¡åˆ’

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|---------|
| 1 | æ›´æ–° AiConfigUiState | 5åˆ†é’Ÿ |
| 2 | æ›´æ–° AiConfigUiEvent | 5åˆ†é’Ÿ |
| 3 | æ›´æ–° AiConfigViewModel | 15åˆ†é’Ÿ |
| 4 | æ›´æ–° AiRepositoryImpl | 20åˆ†é’Ÿ |
| 5 | ç¼–å†™æµ‹è¯•ç”¨ä¾‹ | 20åˆ†é’Ÿ |
| 6 | è¿è¡Œæµ‹è¯•éªŒè¯ | 10åˆ†é’Ÿ |
| 7 | æ„å»ºAPK | 5åˆ†é’Ÿ |

