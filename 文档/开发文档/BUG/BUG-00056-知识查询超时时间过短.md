# BUG-00056 知识查询超时时间过短

> **创建时间**: 2026-01-09  
> **严重程度**: P0 (核心功能失效)  
> **影响范围**: 悬浮窗知识查询功能  
> **状态**: ✅ 已修复

---

## 📋 问题描述

### 用户反馈
用户在悬浮窗中使用"问答功能"时，总是报错"请求超时，请重试"。

### 日志证据
```
E AiRepositoryImpl: 知识查询失败 (queryKnowledge)
E AiRepositoryImpl: kotlinx.coroutines.TimeoutCancellationException: Timed out waiting for 2000 ms
E FloatingWindowService: AI请求失败: Timed out waiting for 2000 ms
E FloatingWindowService: 知识查询超时
```

---

## 🔍 根因分析

### 问题定位

**位置**: `app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt:3210`

```kotlin
/**
 * 知识查询超时时间（毫秒）
 *
 * 业务规则 (PRD-00031/6.3):
 * - 本地AI响应: ≤ 2秒
 */
private const val KNOWLEDGE_QUERY_TIMEOUT_MS = 2000L
```

### 根因说明

1. **PRD-00031 的设计假设错误**：PRD-00031 假设使用"本地AI"，响应时间应 ≤ 2秒
2. **实际情况**：用户使用的是云端AI服务（如DeepSeek、OpenAI），网络延迟 + API处理时间通常需要 5-30秒
3. **超时设置过短**：2秒的超时时间对于云端AI API来说完全不够

### 调用链分析

```
handleKnowledgeV2()
  └── withTimeout(2000ms)  // ❌ 超时时间过短
        └── queryKnowledgeUseCase()
              └── aiRepository.queryKnowledge()
                    └── api.chatCompletion()  // 云端API调用，通常需要5-30秒
```

---

## 🎯 修复方案

### 方案：使用Provider配置的超时时间

修改 `getKnowledgeTimeout()` 方法，使用用户配置的超时时间而不是硬编码的2秒。

**修改前**:
```kotlin
private fun getKnowledgeTimeout(): Long {
    return KNOWLEDGE_QUERY_TIMEOUT_MS  // 硬编码2秒
}
```

**修改后**:
```kotlin
private fun getKnowledgeTimeout(): Long {
    // BUG-00056修复：使用Provider配置的超时时间，而不是硬编码的2秒
    // PRD-00031的2秒假设是基于本地AI，但实际使用云端AI需要更长时间
    return runBlocking {
        try {
            val provider = aiProviderRepository.getDefaultProvider().getOrNull()
            provider?.timeoutMs?.toLong() ?: DEFAULT_AI_TIMEOUT_MS
        } catch (e: Exception) {
            DEFAULT_AI_TIMEOUT_MS
        }
    }
}
```

### 备选方案：增加默认超时时间

如果不想每次都查询Provider配置，可以直接增加默认超时时间：

```kotlin
// 将2秒改为30秒
private const val KNOWLEDGE_QUERY_TIMEOUT_MS = 30000L
```

---

## 📊 影响范围评估

| 文件 | 修改类型 | 影响 |
|------|---------|------|
| `FloatingWindowService.kt` | 修改 | 修改 `getKnowledgeTimeout()` 方法 |

---

## ✅ 验收标准

- [ ] 知识查询功能正常工作，不再超时
- [ ] 超时时间使用用户配置的值
- [ ] 日志中不再出现 "Timed out waiting for 2000 ms" 错误

---

## 📝 测试用例

### 手动测试
1. 打开悬浮窗
2. 切换到"问答"Tab
3. 输入查询内容，点击发送
4. **预期结果**: AI正常返回结果，不再超时

### 单元测试
- `getKnowledgeTimeout_shouldUseProviderTimeout()`
- `handleKnowledgeV2_shouldNotTimeoutWithCloudAI()`

---

## 🔗 相关文档

- [PRD-00031 悬浮窗快速知识回答功能需求](../PRD/PRD-00031-悬浮窗快速知识回答功能需求.md)
- [BUG-00054 AI配置功能多项问题](./BUG-00054-AI配置功能多项问题.md)


---

## ✅ 修复记录

### 修复时间
2026-01-09

### 修复内容

**文件**: `app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt`

**修改前**:
```kotlin
private fun getKnowledgeTimeout(): Long {
    return KNOWLEDGE_QUERY_TIMEOUT_MS  // 硬编码2秒
}
```

**修改后**:
```kotlin
private suspend fun getKnowledgeTimeout(): Long {
    // BUG-00056: 使用与其他AI操作相同的超时逻辑
    return getAiTimeout()  // 使用Provider配置的超时时间
}
```

### 修复说明
- 将 `getKnowledgeTimeout()` 改为 `suspend` 函数
- 调用 `getAiTimeout()` 获取Provider配置的超时时间
- 超时时间 = Provider.timeoutMs + 缓冲时间（默认约50秒）
- 不再使用硬编码的2秒超时

### 构建验证
- ✅ `./gradlew :app:assembleDebug` 构建成功
- ✅ APK已安装到OPPO设备

### 测试说明
请用户在悬浮窗中测试"问答"功能：
1. 打开悬浮窗
2. 切换到"问答"Tab
3. 输入查询内容，点击发送
4. **预期结果**: AI正常返回结果，不再出现"请求超时"错误
