# BUG-00057: AI军师对话界面可读性问题

## 📋 问题概述

### 问题描述
AI军师对话界面的文字**颜色对比度太低**（灰色太浅）以及**排版太挤**，导致用户阅读时眼睛非常吃力。

### 用户反馈
> "主要问题不在于字体样式本身，而在于颜色对比度太低（灰色太浅）以及排版太挤。这让用户阅读时眼睛非常吃力。"

### 影响范围
- AI军师对话界面（AiAdvisorChatScreen）
- 流式消息气泡组件（StreamingMessageBubble）
- 思考过程组件（ThinkingSection）
- 所有使用 `iOSTextSecondary` 和 `iOSTextTertiary` 的组件

### 优先级
- **P0（最高优先级）**：严重影响用户阅读体验

---

## 🔍 深度诊断

### 根本原因分析

#### 1. 颜色对比度问题（最关键）

**当前颜色定义**（Color.kt 第155-157行）：
```kotlin
val iOSTextPrimary = Color(0xFF000000)      // 纯黑色
val iOSTextSecondary = Color(0xFF8E8E93)    // 灰色 ⚠️ 对比度不足
val iOSTextTertiary = Color(0xFFC7C7CC)     // 浅灰色 ⚠️ 对比度严重不足
```

**对比度分析**（白色背景 #FFFFFF）：
| 颜色 | 十六进制 | RGB | 对比度 | WCAG AA标准 |
|------|---------|-----|--------|------------|
| iOSTextPrimary | #000000 | (0,0,0) | 21:1 | ✅ 通过 |
| iOSTextSecondary | #8E8E93 | (142,142,147) | 4.54:1 | ⚠️ 勉强通过 |
| iOSTextTertiary | #C7C7CC | (199,199,204) | 2.93:1 | ❌ 不通过 |

**用户建议的颜色**：
- 正文颜色：`#333333` (深灰色) 或 `#1F1F1F` (接近黑色的灰)
- 辅助文字颜色：`#888888` 或 `#999999`


#### 2. 排版太挤（行高不足）

**当前行高设置**：
| 组件 | 字体大小 | 行高 | 行高比例 | 问题 |
|------|---------|------|---------|------|
| 思考内容 | 14sp | 20sp | 1.43x | ⚠️ 太挤 |
| 流式消息占位 | 16sp | 22sp | 1.375x | ⚠️ 太挤 |
| 用户消息 | 16sp | 22sp | 1.375x | ⚠️ 太挤 |

**用户建议**：
- 行高应为 **1.5倍** 或 **1.6倍**
- 让文字"透气"，增加"呼吸感"

#### 3. 字号偏小

**当前字号**：
- 正文：14sp（太费眼）
- 用户建议：**16sp**（Android标准阅读字号）

---

## ✅ 解决方案

### 方案概述

根据用户建议，只需调整三个参数：
1. **颜色（Color）** - 最关键
2. **字号（Size）** - 16sp标准
3. **行高（Line Height）** - 1.5倍

### 具体修改

#### 修改1：更新Color.kt中的文字颜色

**文件**：`presentation/src/main/kotlin/com/empathy/ai/presentation/theme/Color.kt`

```kotlin
// 修改前（第155-157行）
val iOSTextPrimary = Color(0xFF000000)
val iOSTextSecondary = Color(0xFF8E8E93)
val iOSTextTertiary = Color(0xFFC7C7CC)

// 修改后
val iOSTextPrimary = Color(0xFF1F1F1F)      // 接近黑色的深灰，柔和不刺眼
val iOSTextSecondary = Color(0xFF666666)    // 深灰色，对比度充足
val iOSTextTertiary = Color(0xFF999999)     // 中灰色，辅助文字可读
```

**颜色对比度验证**（白色背景 #FFFFFF）：
| 颜色 | 十六进制 | 对比度 | WCAG AA |
|------|---------|--------|---------|
| iOSTextPrimary | #1F1F1F | 16.1:1 | ✅ 优秀 |
| iOSTextSecondary | #666666 | 5.74:1 | ✅ 通过 |
| iOSTextTertiary | #999999 | 3.54:1 | ⚠️ 大文本通过 |

#### 修改2：更新ThinkingSection.kt的字号和行高

**文件**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/component/ThinkingSection.kt`

```kotlin
// 修改前（第141-144行）
Text(
    text = content,
    fontSize = 14.sp,
    lineHeight = 20.sp,
    color = iOSTextSecondary
)

// 修改后
Text(
    text = content,
    fontSize = dimensions.fontSizeSubtitle,  // 16sp
    lineHeight = dimensions.fontSizeSubtitle * 1.5f,  // 24sp (1.5倍行高)
    color = iOSTextSecondary
)
```

#### 修改3：更新StreamingMessageBubble.kt

**文件**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/component/StreamingMessageBubble.kt`

```kotlin
// 修改前（第159-162行）
Text(
    text = "正在生成",
    fontSize = 16.sp,
    lineHeight = 22.sp,
    color = iOSTextPrimary.copy(alpha = 0.5f)  // 透明度50%，对比度更低
)

// 修改后
Text(
    text = "正在生成",
    fontSize = dimensions.fontSizeSubtitle,  // 16sp
    lineHeight = dimensions.fontSizeSubtitle * 1.5f,  // 24sp (1.5倍行高)
    color = iOSTextSecondary  // 使用辅助文字颜色，不用透明度
)
```


#### 修改4：更新AiAdvisorChatScreen.kt的行高

**文件**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

```kotlin
// 修改前（第555-558行）
Text(
    text = conversation.content,
    modifier = Modifier.padding(horizontal = 14.dp, vertical = 10.dp),
    color = Color.White,
    fontSize = dimensions.fontSizeSubtitle,
    lineHeight = dimensions.fontSizeSubtitle * 1.375f  // 1.375倍行高
)

// 修改后
Text(
    text = conversation.content,
    modifier = Modifier.padding(horizontal = 14.dp, vertical = 10.dp),
    color = Color.White,
    fontSize = dimensions.fontSizeSubtitle,  // 16sp
    lineHeight = dimensions.fontSizeSubtitle * 1.5f  // 24sp (1.5倍行高)
)
```

#### 修改5：为RichText/Markdown配置颜色和行高

**文件**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

```kotlin
// 修改前（第560-565行）
RichText(
    modifier = Modifier.padding(horizontal = 14.dp, vertical = 10.dp)
) {
    Markdown(content = conversation.content)
}

// 修改后 - 使用ProvideTextStyle配置默认样式
ProvideTextStyle(
    value = TextStyle(
        color = iOSTextPrimary,  // 使用深色文字
        fontSize = dimensions.fontSizeSubtitle,  // 16sp
        lineHeight = dimensions.fontSizeSubtitle * 1.5f,  // 24sp (1.5倍行高)
        fontFamily = FontFamily.Default
    )
) {
    RichText(
        modifier = Modifier.padding(horizontal = 14.dp, vertical = 10.dp)
    ) {
        Markdown(content = conversation.content)
    }
}
```

---

## 📁 受影响文件清单

| 优先级 | 文件路径 | 修改内容 |
|--------|---------|---------|
| P0 | `presentation/.../theme/Color.kt` | 更新iOSTextPrimary/Secondary/Tertiary颜色值 |
| P0 | `presentation/.../advisor/component/ThinkingSection.kt` | 更新字号和行高 |
| P0 | `presentation/.../advisor/component/StreamingMessageBubble.kt` | 更新颜色和行高 |
| P0 | `presentation/.../advisor/AiAdvisorChatScreen.kt` | 更新行高，配置RichText样式 |
| P1 | `presentation/.../prompt/component/PromptInputField.kt` | 更新输入框文字颜色和行高 |
| P1 | `presentation/.../prompt/component/CharacterCounter.kt` | 更新字符计数颜色 |

---

## 📝 实施计划

### 任务清单

| 任务ID | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| T1 | 更新BUG文档 | P0 | ✅ 已完成 |
| T2 | 编写单元测试 | P0 | ✅ 已完成 |
| T3 | 修改Color.kt颜色定义 | P0 | ✅ 已完成 |
| T4 | 修改ThinkingSection.kt | P0 | ✅ 已完成 |
| T5 | 修改StreamingMessageBubble.kt | P0 | ✅ 已完成 |
| T6 | 修改AiAdvisorChatScreen.kt | P0 | ✅ 已完成 |
| T7 | 修改PromptInputField.kt（提示词编辑器） | P1 | ✅ 已完成 |
| T8 | 修改CharacterCounter.kt（字符计数） | P1 | ✅ 已完成 |
| T9 | 构建验证 | P0 | ✅ 已完成 |
| T10 | 用户人工验收 | P0 | ⬜ 待验收 |

---

## 🧪 测试用例

### 测试文件位置
`presentation/src/test/kotlin/com/empathy/ai/presentation/theme/ColorContrastBug00057Test.kt`

### 测试用例设计

```kotlin
class ColorContrastBug00057Test {

    @Test
    fun `iOSTextPrimary应该是深灰色而非纯黑`() {
        // 验证颜色值为 #1F1F1F
        assertEquals(Color(0xFF1F1F1F), iOSTextPrimary)
    }

    @Test
    fun `iOSTextSecondary应该有足够的对比度`() {
        // 验证颜色值为 #666666
        assertEquals(Color(0xFF666666), iOSTextSecondary)
    }

    @Test
    fun `iOSTextTertiary应该比之前更深`() {
        // 验证颜色值为 #999999
        assertEquals(Color(0xFF999999), iOSTextTertiary)
    }

    @Test
    fun `iOSTextPrimary在白色背景上对比度应大于7比1`() {
        val contrastRatio = calculateContrastRatio(iOSTextPrimary, Color.White)
        assertTrue(contrastRatio >= 7.0)
    }

    @Test
    fun `iOSTextSecondary在白色背景上对比度应大于4点5比1`() {
        val contrastRatio = calculateContrastRatio(iOSTextSecondary, Color.White)
        assertTrue(contrastRatio >= 4.5)
    }
}
```

---

## 🎯 验收标准

### 视觉验收
- [ ] 正文文字颜色为深灰色（#1F1F1F），清晰可读
- [ ] 辅助文字颜色为中灰色（#666666），对比度充足
- [ ] 行高为1.5倍，文字有"呼吸感"
- [ ] 字号为16sp，阅读不费眼

### 技术验收
- [ ] 所有单元测试通过
- [ ] Debug APK构建成功
- [ ] 无编译警告

### 用户验收
- [ ] 用户确认"白纸黑字、原生、好看、不费劲"

---

## 📝 关联文档

- [BUG-00052-AI军师界面头顶问题](./BUG-00052-我们的军师界面头顶问题.md)
- [BUG-00055-全局字体硬编码问题](./BUG-00055-全局字体硬编码问题.md)
- [Color.kt](../../../presentation/src/main/kotlin/com/empathy/ai/presentation/theme/Color.kt)
- [AdaptiveDimensions.kt](../../../presentation/src/main/kotlin/com/empathy/ai/presentation/theme/AdaptiveDimensions.kt)

---

## 📅 时间线

- **创建日期**: 2026-01-09
- **预计完成**: 2026-01-09
- **代码修改完成**: 2026-01-09
- **待用户验收**: 是

---

## 📊 修改参数总结

### 颜色修改

| 变量名 | 修改前 | 修改后 | 说明 |
|--------|--------|--------|------|
| iOSTextPrimary | #000000 | #1F1F1F | 接近黑色的深灰，柔和不刺眼 |
| iOSTextSecondary | #8E8E93 | #666666 | 深灰色，对比度充足 |
| iOSTextTertiary | #C7C7CC | #999999 | 中灰色，辅助文字可读 |

### 行高修改

| 组件 | 修改前 | 修改后 | 说明 |
|------|--------|--------|------|
| 思考内容 | 1.43x (20sp/14sp) | 1.5x (24sp/16sp) | 增加呼吸感 |
| 流式消息占位 | 1.375x (22sp/16sp) | 1.5x (24sp/16sp) | 统一行高 |
| 用户消息 | 1.375x | 1.5x | 统一行高 |
| AI消息(Markdown) | 未配置 | 1.5x | 新增配置 |

### 字号修改

| 组件 | 修改前 | 修改后 | 说明 |
|------|--------|--------|------|
| 思考内容 | 14sp | 16sp | Android标准阅读字号 |
