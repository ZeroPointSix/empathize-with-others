# BUG-00058 修复总结

| 属性 | 值 |
| --- | --- |
| BUG编号 | BUG-00058 |
| 标题 | AI军师打断重生成消息混淆问题 |
| 严重级别 | Critical |
| 状态 | 已修复 |
| 负责人 | Codex |
| 日期 | 2026-01-11 |

## 1. 问题现象

在 AI 军师对话中出现以下异常：

- AI 流式回复中途点击“停止生成”，随后点击“重新生成”
- 对话列表可能出现消息混淆：旧的半截回复被错误当作用户消息或出现重复气泡
- 流式回复的上下文错乱，影响后续对话连贯性

## 2. 根因分析

核心问题出现在停止后立即重生成的时序窗口：

- `stopGeneration()` 触发时，流式消息可能还未被写入 `conversations` 列表
- `regenerateLastMessage()` 旧逻辑用“最后一条 AI 消息”作为删除目标
- 此时最后一条 AI 可能是历史消息，而不是当前流式消息
- 结果导致删除错误对象，触发对话列表混淆

## 3. 修复思路

修复目标：

- 重新生成时必须删除“当前流式消息”而非“历史最后一条 AI 消息”
- 用户输入优先使用内存中的 `lastUserInput`，避免依赖未更新的列表
- 保障停止 -> 立刻重生成的时序安全

关键策略：

1. 优先使用 `currentStreamingMessageId` 作为删除目标
2. 优先使用 `lastUserInput` 作为重新生成的输入来源
3. 若上述缺失再回退到历史列表（原有逻辑）

## 4. 代码修改

### 4.1 ViewModel 修复

文件：`presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

- `regenerateLastMessage()`
  - 优先删除 `currentStreamingMessageId`
  - 优先使用 `lastUserInput`
  - 仅在兜底场景使用历史列表

### 4.2 测试补充

文件：`presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModelBug58Test.kt`

新增测试场景：

- 停止后立刻重生成（列表尚未更新）
- 断言删除的是当前流式消息，而不是历史最后一条 AI

## 5. 验证结果

- `:app:testDebugUnitTest` 通过
- `:app:assembleDebug` 通过
- APK 已安装到 `127.0.0.1:7555`

## 6. 风险与回归点

- 若 UI 或数据库更新延迟过大，仍需依赖 `currentStreamingMessageId` 做时序隔离
- 确保 `lastUserInput` 在停止/重生成链路中不被意外清空

## 7. 经验总结

- 流式消息场景不能依赖 “最后一条消息” 的静态判断，必须绑定当前流式消息 ID
- 停止与重生成属于高风险时序窗口，应优先使用内存态状态作为判定依据
- 测试必须覆盖“列表未更新”场景，否则容易漏掉实际线上问题

## 8. 关联文档

- `docs/PRD/BUG-00058-AI军师打断重生成消息混淆修复.md`
- `docs/开放文档/CN/2026-01-10-bug58-test-handoff.md`
