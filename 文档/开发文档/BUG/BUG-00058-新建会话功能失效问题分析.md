# BUG-00058-新建会话功能失效问题分析

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档编号 | BUG-00058 |
| 创建日期 | 2026-01-09 |
| 问题来源 | 用户反馈 |
| 优先级 | P1 (高) |
| 状态 | 📝 分析完成 |
| 关联功能 | AI军师会话管理 |

---

## 1. 问题描述

### 1.1 现象

用户点击"新建会话"按钮后：
- **期望行为**：创建一个全新的空白会话，从头开始对话
- **实际行为**：没有真正创建新会话，而是跳转到上一个/第一个会话

### 1.2 复现步骤

1. 进入AI军师对话界面
2. 进行一些对话
3. 点击会话历史按钮，进入会话列表页面
4. 点击"新建会话"按钮
5. **问题出现**：返回对话界面后，显示的是之前的会话内容，而不是新的空白会话

### 1.3 影响范围

- 用户无法创建新的对话主题
- 所有对话都混在同一个会话中
- 影响用户体验和对话管理

---

## 2. 根因分析

### 2.1 问题代码定位

**文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NavGraph.kt`

**问题代码** (第287-292行):

```kotlin
onCreateNewSession = {
    // 创建新会话并返回对话界面
    navController.navigate(NavRoutes.aiAdvisorChat(contactId)) {
        popUpTo(NavRoutes.AI_ADVISOR_SESSIONS) { inclusive = true }
    }
}
```

### 2.2 问题分析

这段代码只是简单地导航到对话界面，**没有**：
1. 调用 `CreateAdvisorSessionUseCase` 创建新会话
2. 传递新会话的ID给目标页面
3. 传递"需要创建新会话"的信号给ViewModel

### 2.3 错误流程

```
用户点击"新建会话"
    ↓
onCreateNewSession回调执行
    ↓
直接导航到aiAdvisorChat(contactId)  ❌ 没有创建会话
    ↓
AiAdvisorChatViewModel.loadSessions()执行
    ↓
获取该联系人的所有会话列表
    ↓
选择第一个会话（sessions.first()）  ❌ 应该选择新会话
    ↓
显示第一个会话的对话内容
```

### 2.4 相关代码

**AiAdvisorChatViewModel.kt** (第140-168行):

```kotlin
getAdvisorSessionsUseCase(contactId).onSuccess { sessions ->
    if (sessions.isEmpty()) {
        // Create default session
        createNewSession(contactId)
    } else {
        // BUG-046修复：保持当前会话，如果存在的话
        val currentSessionId = _uiState.value.currentSessionId
        val activeSession = if (currentSessionId != null) {
            sessions.find { it.id == currentSessionId } ?: sessions.first()
        } else {
            sessions.first()  // ❌ 问题：总是选择第一个会话
        }
        // ...
    }
}
```

---

## 3. 修复方案

### 3.1 方案A：通过导航参数传递标志（推荐）

修改导航路由，添加可选参数 `createNew=true`，让ViewModel检测到后调用 `createNewSession()`。

**修改文件**:

1. **NavRoutes.kt** - 添加createNew参数

```kotlin
object NavRoutes {
    // 修改aiAdvisorChat路由，添加createNew参数
    fun aiAdvisorChat(contactId: String, createNew: Boolean = false): String {
        return "ai_advisor_chat/$contactId?createNew=$createNew"
    }
    
    const val AI_ADVISOR_CHAT = "ai_advisor_chat/{contactId}?createNew={createNew}"
}
```

2. **NavGraph.kt** - 修改导航调用

```kotlin
onCreateNewSession = {
    // 传递createNew=true标志
    navController.navigate(NavRoutes.aiAdvisorChat(contactId, createNew = true)) {
        popUpTo(NavRoutes.AI_ADVISOR_SESSIONS) { inclusive = true }
    }
}
```

3. **AiAdvisorChatViewModel.kt** - 处理createNew参数

```kotlin
@HiltViewModel
class AiAdvisorChatViewModel @Inject constructor(
    savedStateHandle: SavedStateHandle,
    // ...
) : ViewModel() {
    
    private val createNew: Boolean = savedStateHandle["createNew"] ?: false
    
    init {
        if (createNew) {
            createNewSession(contactId)
        } else {
            loadSessions()
        }
    }
}
```

### 3.2 方案B：在SessionHistoryScreen中先创建会话

在点击"新建会话"时，先调用UseCase创建会话，获取ID后再导航。

**修改文件**: `SessionHistoryScreen.kt` 和 `SessionHistoryViewModel.kt`

```kotlin
// SessionHistoryViewModel.kt
fun createNewSessionAndNavigate(contactId: String, onSuccess: (sessionId: String) -> Unit) {
    viewModelScope.launch {
        createAdvisorSessionUseCase(contactId).onSuccess { session ->
            onSuccess(session.id)
        }
    }
}

// SessionHistoryScreen.kt
onCreateNewSession = {
    viewModel.createNewSessionAndNavigate(contactId) { sessionId ->
        navController.navigate(NavRoutes.aiAdvisorChat(contactId, sessionId)) {
            popUpTo(NavRoutes.AI_ADVISOR_SESSIONS) { inclusive = true }
        }
    }
}
```

### 3.3 推荐方案

**推荐方案A**，原因：
1. 改动最小，只需修改导航参数
2. 符合现有架构模式
3. AiAdvisorChatViewModel已经有 `createNewSession()` 方法
4. 不需要等待会话创建完成才能导航

---

## 4. 测试用例

### 4.1 TC-001: 新建会话基本功能

**前置条件**: 用户已有至少一个会话

**步骤**:
1. 进入AI军师对话界面
2. 点击会话历史按钮
3. 点击"新建会话"按钮

**预期结果**:
- 创建新的空白会话
- 导航到对话界面
- 显示空的对话列表
- 会话标题为"新对话"

### 4.2 TC-002: 新建会话后发送消息

**前置条件**: 完成TC-001

**步骤**:
1. 在新会话中输入消息
2. 点击发送

**预期结果**:
- 消息发送成功
- AI正常回复
- 消息显示在新会话中

### 4.3 TC-003: 新建会话后切换回旧会话

**前置条件**: 完成TC-002

**步骤**:
1. 点击会话历史按钮
2. 选择之前的旧会话

**预期结果**:
- 正确显示旧会话的对话内容
- 新会话的内容不会混入旧会话

### 4.4 TC-004: 连续新建多个会话

**步骤**:
1. 新建会话1，发送消息
2. 新建会话2，发送消息
3. 新建会话3，发送消息
4. 查看会话列表

**预期结果**:
- 会话列表显示3个新会话
- 每个会话的内容独立

---

## 5. 验证清单

- [ ] 点击"新建会话"后创建新的空白会话
- [ ] 新会话的ID与旧会话不同
- [ ] 新会话的对话列表为空
- [ ] 新会话可以正常发送消息
- [ ] 切换会话后内容正确显示
- [ ] 会话列表正确显示所有会话

---

## 6. 相关文件

| 文件路径 | 修改类型 | 说明 |
|----------|----------|------|
| `presentation/.../navigation/NavRoutes.kt` | 修改 | 添加createNew参数 |
| `presentation/.../navigation/NavGraph.kt` | 修改 | 传递createNew=true |
| `presentation/.../viewmodel/AiAdvisorChatViewModel.kt` | 修改 | 处理createNew参数 |

---

**文档版本**: 1.0
**最后更新**: 2026-01-09
**修复状态**: 📝 分析完成，待实现
