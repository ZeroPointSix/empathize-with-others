# BUG-00059-ä¸­æ–­ç”Ÿæˆåé‡æ–°ç”Ÿæˆæ¶ˆæ¯è§’è‰²é”™ä¹±é—®é¢˜åˆ†æ

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç¼–å· | BUG-00059 |
| åˆ›å»ºæ—¥æœŸ | 2026-01-09 |
| é—®é¢˜æ¥æº | ç”¨æˆ·åé¦ˆ |
| ä¼˜å…ˆçº§ | P0 (ä¸¥é‡) |
| çŠ¶æ€ | ğŸ“ åˆ†æå®Œæˆ |
| å…³è”BUG | BUG-00048 |
| å…³è”åŠŸèƒ½ | AIå†›å¸ˆæµå¼å¯¹è¯ |

---

## 1. é—®é¢˜æè¿°

### 1.1 ç°è±¡

ç”¨æˆ·åœ¨AIç”Ÿæˆè¿‡ç¨‹ä¸­ç‚¹å‡»"åœæ­¢ç”Ÿæˆ"ï¼Œç„¶åç‚¹å‡»"é‡æ–°ç”Ÿæˆ"æ—¶ï¼š
- **æœŸæœ›è¡Œä¸º**ï¼šåˆ é™¤è¢«åœæ­¢çš„AIæ¶ˆæ¯ï¼Œä½¿ç”¨åŸå§‹ç”¨æˆ·è¾“å…¥é‡æ–°ç”ŸæˆAIå›å¤
- **å®é™…è¡Œä¸º**ï¼šAIä¹‹å‰ç”Ÿæˆçš„åŠæˆªå†…å®¹è¢«é”™è¯¯åœ°å½“æˆç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºï¼ˆè“è‰²æ°”æ³¡ï¼‰

### 1.2 æˆªå›¾åˆ†æ

ä»ç”¨æˆ·æä¾›çš„æˆªå›¾æ¥çœ‹ï¼š
- **è“è‰²æ°”æ³¡ï¼ˆç”¨æˆ·æ¶ˆæ¯ï¼‰** æ˜¾ç¤ºï¼š`"å¥¹åˆ†äº«æ¬²å¼ºï¼Œå½“å¥¹è¯´ä¸œè¥¿çš„æ—¶å€™ï¼š- åˆ«æ•·è¡"å“ˆå“ˆå“ˆ""ç¡®å®"..." + "[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"`
- **ç™½è‰²æ°”æ³¡ï¼ˆAIæ¶ˆæ¯ï¼‰** æ˜¾ç¤ºï¼š`"å“ˆå“ˆçœ‹åˆ°ä½ ä¸­é€”åœäº†ï¼Œä¼°è®¡æ˜¯æƒ³è®©æˆ‘é‡æ–°æ•´ç†ä¸€ä¸‹ï¼Ÿ"`

è¿™è¯´æ˜ï¼š
1. AIç”Ÿæˆçš„å†…å®¹è¢«é”™è¯¯åœ°ä¿å­˜ä¸ºç”¨æˆ·æ¶ˆæ¯ï¼ˆmessageType=USERï¼‰
2. æˆ–è€…UIæ¸²æŸ“æ—¶æ¶ˆæ¯ç±»å‹åˆ¤æ–­å‡ºç°é—®é¢˜

### 1.3 å¤ç°æ­¥éª¤

1. è¿›å…¥AIå†›å¸ˆå¯¹è¯ç•Œé¢
2. å‘é€ä¸€æ¡æ¶ˆæ¯ï¼ˆå¦‚"å¸®æˆ‘åˆ†æä¸€ä¸‹è”æ"ï¼‰
3. AIå¼€å§‹æµå¼ç”Ÿæˆå›å¤
4. åœ¨AIç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œç‚¹å‡»"åœæ­¢ç”Ÿæˆ"æŒ‰é’®
5. ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"æŒ‰é’®
6. **é—®é¢˜å‡ºç°**ï¼šAIä¹‹å‰ç”Ÿæˆçš„å†…å®¹æ˜¾ç¤ºä¸ºè“è‰²æ°”æ³¡ï¼ˆç”¨æˆ·æ¶ˆæ¯ï¼‰

### 1.4 å½±å“èŒƒå›´

- å¯¹è¯å†å²æ··ä¹±ï¼Œæ¶ˆæ¯è§’è‰²é”™è¯¯
- ç”¨æˆ·ä½“éªŒä¸¥é‡å—æŸ
- å¯èƒ½å¯¼è‡´åç»­å¯¹è¯ä¸Šä¸‹æ–‡é”™è¯¯

---

## 2. æ ¹å› åˆ†æ

### 2.1 ç›¸å…³ä»£ç æµç¨‹

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
sendMessageStreaming()
  - è®°å½• lastUserInput = message
  - åˆ›å»ºç”¨æˆ·æ¶ˆæ¯ï¼ˆmessageType=USERï¼‰
  - åˆ›å»ºAIæ¶ˆæ¯å ä½ï¼ˆmessageType=AI, status=PENDINGï¼‰
    â†“
AIå¼€å§‹æµå¼ç”Ÿæˆ
  - é€æ­¥æ›´æ–°AIæ¶ˆæ¯å†…å®¹
    â†“
ç”¨æˆ·ç‚¹å‡»åœæ­¢
    â†“
stopGeneration()
  - å–æ¶ˆæµå¼è¯·æ±‚
  - è°ƒç”¨ updateAiMessageContentAndStatus()
  - æ›´æ–°AIæ¶ˆæ¯å†…å®¹ä¸º "xxx + [ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
  - æ›´æ–°AIæ¶ˆæ¯çŠ¶æ€ä¸º CANCELLED
    â†“
ç”¨æˆ·ç‚¹å‡»é‡æ–°ç”Ÿæˆ
    â†“
regenerateLastMessage()
  - æŸ¥æ‰¾æœ€åä¸€æ¡AIæ¶ˆæ¯
  - è·å–ç”¨æˆ·è¾“å…¥ï¼ˆä¼˜å…ˆlastUserInputï¼Œå…¶æ¬¡æŸ¥æ‰¾ï¼‰
  - åˆ é™¤AIæ¶ˆæ¯
  - è°ƒç”¨ regenerateStreaming()
```

### 2.2 å¯èƒ½çš„é—®é¢˜ç‚¹

#### 2.2.1 é—®é¢˜ç‚¹1ï¼šupdateAiMessageContentAndStatuså¯èƒ½æ›´æ–°äº†é”™è¯¯çš„æ¶ˆæ¯

**æ–‡ä»¶**: `data/src/main/kotlin/com/empathy/ai/data/local/dao/AiAdvisorDao.kt`

```kotlin
@Query("""
    UPDATE ai_advisor_conversations 
    SET content = :content, send_status = :status 
    WHERE id = :conversationId AND message_type = 'AI'
""")
suspend fun updateAiMessageContentAndStatus(conversationId: String, content: String, status: String): Int
```

è™½ç„¶SQLæœ‰ `message_type = 'AI'` çš„æ¡ä»¶ï¼Œä½†å¦‚æœ `conversationId` ä¼ å…¥äº†é”™è¯¯çš„å€¼ï¼Œå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚

**éœ€è¦éªŒè¯**ï¼š`currentStreamingMessageId` æ˜¯å¦å§‹ç»ˆæŒ‡å‘æ­£ç¡®çš„AIæ¶ˆæ¯ã€‚

#### 2.2.2 é—®é¢˜ç‚¹2ï¼šæ¶ˆæ¯IDå¯èƒ½è¢«é”™è¯¯è®¾ç½®

**æ–‡ä»¶**: `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

åœ¨ `stopGeneration()` ä¸­ï¼š

```kotlin
val messageId = _uiState.value.currentStreamingMessageId
```

å¦‚æœ `currentStreamingMessageId` åœ¨æŸä¸ªæ—¶åˆ»è¢«é”™è¯¯åœ°è®¾ç½®ä¸ºç”¨æˆ·æ¶ˆæ¯çš„IDï¼Œå°±ä¼šå¯¼è‡´é—®é¢˜ã€‚

**éœ€è¦éªŒè¯**ï¼š`currentStreamingMessageId` çš„è®¾ç½®æ—¶æœºå’Œå€¼ã€‚

#### 2.2.3 é—®é¢˜ç‚¹3ï¼šé‡æ–°ç”Ÿæˆæ—¶åˆ›å»ºäº†é”™è¯¯çš„ç”¨æˆ·æ¶ˆæ¯

**æ–‡ä»¶**: `domain/src/main/kotlin/com/empathy/ai/domain/usecase/SendAdvisorMessageStreamingUseCase.kt`

åœ¨é‡æ–°ç”Ÿæˆåœºæ™¯ä¸‹ï¼š

```kotlin
val userMessageId = if (!skipUserMessage) {
    // åˆ›å»ºæ–°ç”¨æˆ·æ¶ˆæ¯
    val id = UUID.randomUUID().toString()
    val userConversation = AiAdvisorConversation(
        id = id,
        messageType = MessageType.USER,
        content = userMessage,  // âš ï¸ å¦‚æœuserMessageæ˜¯AIç”Ÿæˆçš„å†…å®¹ï¼Œå°±ä¼šå‡ºé—®é¢˜
        // ...
    )
    aiAdvisorRepository.saveMessage(userConversation)
    id
} else {
    relatedUserMessageId
}
```

å¦‚æœ `skipUserMessage=false` ä¸” `userMessage` æ˜¯AIç”Ÿæˆçš„å†…å®¹ï¼Œå°±ä¼šåˆ›å»ºä¸€æ¡å†…å®¹ä¸ºAIç”Ÿæˆå†…å®¹çš„ç”¨æˆ·æ¶ˆæ¯ã€‚

**éœ€è¦éªŒè¯**ï¼š`regenerateStreaming()` æ˜¯å¦æ­£ç¡®ä¼ é€’äº† `skipUserMessage=true`ã€‚

#### 2.2.4 é—®é¢˜ç‚¹4ï¼šgetUserInputForRegenerateè¿”å›äº†é”™è¯¯çš„å†…å®¹

**æ–‡ä»¶**: `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

```kotlin
private fun getUserInputForRegenerate(
    lastAiMessage: AiAdvisorConversation,
    conversations: List<AiAdvisorConversation>
): Pair<String, String?> {
    // ä¼˜å…ˆçº§1ï¼šä½¿ç”¨å†…å­˜ä¸­çš„lastUserInput
    val fromMemory = _uiState.value.lastUserInput
    if (fromMemory.isNotEmpty()) {
        // ...
        return Pair(fromMemory, relatedId)
    }
    
    // ä¼˜å…ˆçº§2ï¼šé€šè¿‡relatedUserMessageIdæŸ¥æ‰¾
    // ...
    
    // ä¼˜å…ˆçº§3ï¼šæ—¶é—´æˆ³å›é€€æŸ¥æ‰¾
    // ...
}
```

å¦‚æœ `lastUserInput` è¢«é”™è¯¯åœ°è®¾ç½®ä¸ºAIç”Ÿæˆçš„å†…å®¹ï¼Œå°±ä¼šå¯¼è‡´é—®é¢˜ã€‚

**éœ€è¦éªŒè¯**ï¼š`lastUserInput` æ˜¯å¦åªåœ¨ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶è®¾ç½®ã€‚

### 2.3 æ ¹æœ¬åŸå› å‡è®¾

åŸºäºä»£ç åˆ†æï¼Œæœ€å¯èƒ½çš„æ ¹æœ¬åŸå› æ˜¯ï¼š

**å‡è®¾A**ï¼š`currentStreamingMessageId` åœ¨æŸä¸ªæ—¶åˆ»æŒ‡å‘äº†ç”¨æˆ·æ¶ˆæ¯çš„IDï¼Œå¯¼è‡´ `updateAiMessageContentAndStatus` å°è¯•æ›´æ–°ç”¨æˆ·æ¶ˆæ¯ï¼ˆä½†ç”±äºSQLæ¡ä»¶é™åˆ¶ï¼Œå®é™…ä¸Šæ²¡æœ‰æ›´æ–°æˆåŠŸï¼‰ï¼Œç„¶åçŠ¶æ€ç®¡ç†å‡ºç°æ··ä¹±ã€‚

**å‡è®¾B**ï¼šåœ¨æŸä¸ªè¾¹ç•Œæ¡ä»¶ä¸‹ï¼ˆå¦‚å¿«é€Ÿæ“ä½œã€ç½‘ç»œå»¶è¿Ÿç­‰ï¼‰ï¼Œ`regenerateStreaming()` è¢«è°ƒç”¨æ—¶ `skipUserMessage` å‚æ•°ä¸º `false`ï¼Œå¯¼è‡´åˆ›å»ºäº†ä¸€æ¡å†…å®¹ä¸ºAIç”Ÿæˆå†…å®¹çš„ç”¨æˆ·æ¶ˆæ¯ã€‚

**å‡è®¾C**ï¼š`lastUserInput` åœ¨æŸä¸ªæ—¶åˆ»è¢«é”™è¯¯åœ°è®¾ç½®ä¸ºAIç”Ÿæˆçš„å†…å®¹ï¼ˆå¯èƒ½æ˜¯é€šè¿‡æŸä¸ªæœªé¢„æœŸçš„ä»£ç è·¯å¾„ï¼‰ã€‚

---

## 3. è°ƒè¯•æ–¹æ¡ˆ

### 3.1 æ·»åŠ æ—¥å¿—è®°å½•

åœ¨å…³é”®ä½ç½®æ·»åŠ æ—¥å¿—ï¼Œè®°å½•æ¶ˆæ¯åˆ›å»ºå’Œæ›´æ–°çš„è¿‡ç¨‹ï¼š

```kotlin
// stopGeneration()
Log.d(TAG, "stopGeneration: messageId=$messageId, content=${currentContent.take(50)}...")

// updateAiMessageContentAndStatus()
Log.d(TAG, "updateAiMessageContentAndStatus: id=$messageId, updatedRows=$result")

// regenerateLastMessage()
Log.d(TAG, "regenerateLastMessage: lastAiMessage.id=${lastAiMessage.id}, userInputToUse=${userInputToUse.take(50)}...")

// sendMessageStreaming()
Log.d(TAG, "sendMessageStreaming: skipUserMessage=$skipUserMessage, userMessage=${userMessage.take(50)}...")
```

### 3.2 æ•°æ®åº“æ£€æŸ¥

åœ¨é—®é¢˜å¤ç°åï¼Œæ£€æŸ¥æ•°æ®åº“ä¸­çš„æ¶ˆæ¯è®°å½•ï¼š

```sql
SELECT id, message_type, content, send_status, timestamp 
FROM ai_advisor_conversations 
WHERE session_id = 'xxx' 
ORDER BY timestamp ASC;
```

éªŒè¯ï¼š
- æ˜¯å¦å­˜åœ¨ `message_type='USER'` ä½† `content` åŒ…å«AIç”Ÿæˆå†…å®¹çš„è®°å½•
- æ¶ˆæ¯çš„åˆ›å»ºé¡ºåºæ˜¯å¦æ­£ç¡®

### 3.3 æ–­ç‚¹è°ƒè¯•

åœ¨ä»¥ä¸‹ä½ç½®è®¾ç½®æ–­ç‚¹ï¼š
1. `stopGeneration()` - æ£€æŸ¥ `messageId` çš„å€¼
2. `updateAiMessageContentAndStatus()` - æ£€æŸ¥è¿”å›å€¼
3. `regenerateLastMessage()` - æ£€æŸ¥ `userInputToUse` çš„å€¼
4. `SendAdvisorMessageStreamingUseCase.invoke()` - æ£€æŸ¥ `skipUserMessage` å’Œ `userMessage` çš„å€¼

---

## 4. ä¿®å¤æ–¹æ¡ˆ

### 4.1 æ–¹æ¡ˆAï¼šå¢å¼ºæ¶ˆæ¯IDéªŒè¯

åœ¨ `stopGeneration()` ä¸­ï¼ŒéªŒè¯ `currentStreamingMessageId` ç¡®å®æŒ‡å‘AIæ¶ˆæ¯ï¼š

```kotlin
fun stopGeneration() {
    val messageId = _uiState.value.currentStreamingMessageId ?: return
    
    // éªŒè¯æ¶ˆæ¯ç±»å‹
    val message = _uiState.value.conversations.find { it.id == messageId }
    if (message?.messageType != MessageType.AI) {
        Log.e(TAG, "stopGeneration: messageId=$messageId is not AI message!")
        return
    }
    
    // ... ç»§ç»­åŸæœ‰é€»è¾‘
}
```

### 4.2 æ–¹æ¡ˆBï¼šå¢å¼ºé‡æ–°ç”Ÿæˆæ—¶çš„å‚æ•°éªŒè¯

åœ¨ `regenerateStreaming()` ä¸­ï¼Œç¡®ä¿ä¸ä¼šåˆ›å»ºé”™è¯¯çš„ç”¨æˆ·æ¶ˆæ¯ï¼š

```kotlin
private fun regenerateStreaming(
    userMessage: String, 
    sessionId: String,
    relatedUserMessageId: String? = null
) {
    // éªŒè¯userMessageä¸æ˜¯AIç”Ÿæˆçš„å†…å®¹
    if (userMessage.contains("[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]") || 
        userMessage.contains("æ ¸å¿ƒç­–ç•¥") ||
        userMessage.length > 500) {  // AIç”Ÿæˆçš„å†…å®¹é€šå¸¸è¾ƒé•¿
        Log.e(TAG, "regenerateStreaming: userMessage looks like AI content!")
        _uiState.update { it.copy(error = "é‡æ–°ç”Ÿæˆå¤±è´¥ï¼šç”¨æˆ·è¾“å…¥å¼‚å¸¸") }
        return
    }
    
    // ... ç»§ç»­åŸæœ‰é€»è¾‘
}
```

### 4.3 æ–¹æ¡ˆCï¼šä½¿ç”¨relatedUserMessageIdä½œä¸ºå”¯ä¸€æ¥æºï¼ˆæ¨èï¼‰

ä¿®æ”¹é‡æ–°ç”Ÿæˆé€»è¾‘ï¼Œå¼ºåˆ¶ä½¿ç”¨ `relatedUserMessageId` è·å–åŸå§‹ç”¨æˆ·è¾“å…¥ï¼š

```kotlin
fun regenerateLastMessage() {
    val conversations = _uiState.value.conversations
    val sessionId = _uiState.value.currentSessionId ?: return
    
    // 1. æ‰¾åˆ°æœ€åä¸€æ¡AIæ¶ˆæ¯
    val lastAiMessage = conversations
        .filter { it.messageType == MessageType.AI }
        .maxByOrNull { it.timestamp }
    
    if (lastAiMessage == null) {
        _uiState.update { it.copy(error = "æœªæ‰¾åˆ°AIæ¶ˆæ¯ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ") }
        return
    }
    
    // 2. å¼ºåˆ¶é€šè¿‡relatedUserMessageIdè·å–ç”¨æˆ·æ¶ˆæ¯
    val relatedUserMessageId = lastAiMessage.relatedUserMessageId
    if (relatedUserMessageId.isNullOrEmpty()) {
        _uiState.update { it.copy(error = "æœªæ‰¾åˆ°å…³è”çš„ç”¨æˆ·æ¶ˆæ¯ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ") }
        return
    }
    
    val relatedUserMessage = conversations.find { it.id == relatedUserMessageId }
    if (relatedUserMessage == null || relatedUserMessage.messageType != MessageType.USER) {
        _uiState.update { it.copy(error = "å…³è”çš„ç”¨æˆ·æ¶ˆæ¯æ— æ•ˆï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ") }
        return
    }
    
    val userInputToUse = relatedUserMessage.content
    
    // 3. åˆ é™¤AIæ¶ˆæ¯å¹¶é‡æ–°ç”Ÿæˆ
    viewModelScope.launch {
        _uiState.update { it.copy(isRegenerating = true) }
        
        val deleteResult = deleteAdvisorConversationUseCase(lastAiMessage.id)
        
        if (deleteResult.isSuccess) {
            kotlinx.coroutines.delay(200)
            regenerateStreaming(userInputToUse, sessionId, relatedUserMessageId)
        } else {
            _uiState.update { 
                it.copy(isRegenerating = false, error = "åˆ é™¤æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•") 
            }
        }
    }
}
```

### 4.4 æ¨èæ–¹æ¡ˆ

**æ¨èæ–¹æ¡ˆC**ï¼ŒåŸå› ï¼š
1. ä½¿ç”¨æ•°æ®åº“ä¸­çš„å…³è”å…³ç³»ï¼Œè€Œä¸æ˜¯å†…å­˜ä¸­çš„çŠ¶æ€
2. é¿å…äº† `lastUserInput` å¯èƒ½è¢«é”™è¯¯è®¾ç½®çš„é—®é¢˜
3. é€»è¾‘æ›´åŠ æ¸…æ™°å’Œå¯é 
4. å³ä½¿åº”ç”¨é‡å¯ï¼Œä¹Ÿèƒ½æ­£ç¡®è·å–ç”¨æˆ·è¾“å…¥

---

## 5. æµ‹è¯•ç”¨ä¾‹

### 5.1 TC-001: æ­£å¸¸åœæ­¢åé‡æ–°ç”Ÿæˆ

**æ­¥éª¤**:
1. å‘é€æ¶ˆæ¯"ä½ å¥½"
2. AIå¼€å§‹ç”Ÿæˆå›å¤
3. ç­‰å¾…AIç”Ÿæˆä¸€éƒ¨åˆ†å†…å®¹åï¼Œç‚¹å‡»"åœæ­¢ç”Ÿæˆ"
4. ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"

**é¢„æœŸç»“æœ**:
- è¢«åœæ­¢çš„AIæ¶ˆæ¯è¢«åˆ é™¤
- ä½¿ç”¨"ä½ å¥½"é‡æ–°ç”ŸæˆAIå›å¤
- ä¸å‡ºç°æ–°çš„ç”¨æˆ·æ¶ˆæ¯
- æ–°çš„AIå›å¤æ­£å¸¸æ˜¾ç¤º

### 5.2 TC-002: å¿«é€Ÿåœæ­¢åé‡æ–°ç”Ÿæˆ

**æ­¥éª¤**:
1. å‘é€æ¶ˆæ¯
2. AIåˆšå¼€å§‹ç”Ÿæˆï¼ˆå‡ ä¹æ²¡æœ‰å†…å®¹ï¼‰æ—¶ï¼Œç«‹å³ç‚¹å‡»"åœæ­¢ç”Ÿæˆ"
3. ç«‹å³ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"

**é¢„æœŸç»“æœ**:
- ä¸å‡ºç°çŠ¶æ€æ··ä¹±
- æ­£ç¡®ä½¿ç”¨åŸå§‹ç”¨æˆ·è¾“å…¥é‡æ–°ç”Ÿæˆ

### 5.3 TC-003: å¤šè½®å¯¹è¯ååœæ­¢é‡æ–°ç”Ÿæˆ

**æ­¥éª¤**:
1. å‘é€æ¶ˆæ¯1 â†’ AIå›å¤1
2. å‘é€æ¶ˆæ¯2 â†’ AIå¼€å§‹å›å¤2
3. åœæ­¢ç”Ÿæˆ
4. é‡æ–°ç”Ÿæˆ

**é¢„æœŸç»“æœ**:
- ä½¿ç”¨æ¶ˆæ¯2çš„å†…å®¹é‡æ–°ç”Ÿæˆ
- ä¸ä¼šä½¿ç”¨æ¶ˆæ¯1çš„å†…å®¹

### 5.4 TC-004: åº”ç”¨é‡å¯åé‡æ–°ç”Ÿæˆ

**æ­¥éª¤**:
1. å‘é€æ¶ˆæ¯ â†’ AIå¼€å§‹å›å¤
2. åœæ­¢ç”Ÿæˆ
3. é‡å¯åº”ç”¨
4. ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"

**é¢„æœŸç»“æœ**:
- å³ä½¿ `lastUserInput` ä¸¢å¤±ï¼Œä¹Ÿèƒ½æ­£ç¡®è·å–ç”¨æˆ·è¾“å…¥
- æ­£ç¡®é‡æ–°ç”Ÿæˆ

### 5.5 TC-005: éªŒè¯æ¶ˆæ¯ç±»å‹

**æ­¥éª¤**:
1. å®ŒæˆTC-001
2. æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ¶ˆæ¯è®°å½•

**é¢„æœŸç»“æœ**:
- æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯çš„ `message_type='USER'`
- æ‰€æœ‰AIæ¶ˆæ¯çš„ `message_type='AI'`
- æ²¡æœ‰æ¶ˆæ¯ç±»å‹é”™è¯¯çš„è®°å½•

---

## 6. éªŒè¯æ¸…å•

- [ ] åœæ­¢ç”Ÿæˆåï¼ŒAIæ¶ˆæ¯æ­£ç¡®æ˜¾ç¤ºä¸ºç™½è‰²æ°”æ³¡
- [ ] åœæ­¢ç”Ÿæˆåï¼ŒAIæ¶ˆæ¯å†…å®¹åŒ…å«"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
- [ ] é‡æ–°ç”Ÿæˆåï¼Œä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·è¾“å…¥
- [ ] é‡æ–°ç”Ÿæˆåï¼Œä¸å‡ºç°æ–°çš„ç”¨æˆ·æ¶ˆæ¯
- [ ] é‡æ–°ç”Ÿæˆåï¼Œæ–°AIæ¶ˆæ¯æ­£ç¡®æ˜¾ç¤ºä¸ºç™½è‰²æ°”æ³¡
- [ ] æ•°æ®åº“ä¸­æ¶ˆæ¯ç±»å‹æ­£ç¡®
- [ ] å¿«é€Ÿæ“ä½œä¸ä¼šå¯¼è‡´çŠ¶æ€æ··ä¹±
- [ ] åº”ç”¨é‡å¯åé‡æ–°ç”Ÿæˆä»ç„¶æ­£å¸¸

---

## 7. ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|----------|----------|------|
| `presentation/.../viewmodel/AiAdvisorChatViewModel.kt` | ä¿®æ”¹ | å¢å¼ºregenerateLastMessageé€»è¾‘ |
| `domain/.../usecase/SendAdvisorMessageStreamingUseCase.kt` | æ£€æŸ¥ | éªŒè¯skipUserMessageå‚æ•° |
| `data/.../dao/AiAdvisorDao.kt` | æ£€æŸ¥ | éªŒè¯SQLæ¡ä»¶ |

---

## 8. ä¸BUG-00048çš„å…³ç³»

æœ¬BUGæ˜¯BUG-00048çš„å»¶ç»­ã€‚BUG-00048å·²ç»è¿›è¡Œäº†å¤šè½®ä¿®å¤ï¼ˆV1-V4ï¼‰ï¼Œä½†é—®é¢˜ä»ç„¶å­˜åœ¨ã€‚

æœ¬æ¬¡åˆ†ææä¾›äº†æ›´æ·±å…¥çš„æ ¹å› åˆ†æå’Œæ›´å¯é çš„ä¿®å¤æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆCï¼šä½¿ç”¨relatedUserMessageIdä½œä¸ºå”¯ä¸€æ¥æºï¼‰ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-09
**ä¿®å¤çŠ¶æ€**: ğŸ“ åˆ†æå®Œæˆï¼Œå¾…å®ç°
