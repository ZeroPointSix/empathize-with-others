# BUG-00060-会话管理增强需求

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档编号 | BUG-00060 |
| 创建日期 | 2026-01-09 |
| 问题来源 | 用户反馈 |
| 优先级 | P1 (高) |
| 状态 | ✅ 已修复 |
| 关联BUG | BUG-00058 |
| 关联功能 | AI军师会话管理 |

---

## 1. 问题描述

### 1.1 问题概述

用户反馈AI军师会话管理存在以下问题：

1. **空会话重复创建**：每次点击AI军师入口时，系统总是新建会话，即使上一个会话是空白的（没有任何对话）
2. **会话命名不友好**：所有会话都叫"新对话"，用户很难区分不同会话的内容
3. **缺少会话管理功能**：无法重命名会话、无法置顶重要会话

### 1.2 期望行为

1. **空会话复用**：
   - 如果上一个会话**有对话内容** → 新建会话
   - 如果上一个会话**是空白的**（没有对话） → 复用这个空白会话

2. **会话自动命名**：
   - 会话名称应该根据用户发送的第一条消息自动生成
   - 取用户输入的前20个字符作为标题

3. **会话管理增强**：
   - 支持会话重命名功能
   - 支持会话置顶功能

### 1.3 影响范围

- 用户体验：会话管理混乱，难以找到历史对话
- 存储空间：产生大量空白会话
- 功能完整性：缺少基本的会话管理能力

---

## 2. 根因分析

### 2.1 问题1：空会话重复创建

**问题代码定位**：`AiAdvisorChatViewModel.kt`

```kotlin
fun createNewSessionFromNavigation() {
    viewModelScope.launch {
        // 直接创建新会话，没有检查是否存在空会话
        createAdvisorSessionUseCase(contactId).onSuccess { session ->
            // ...
        }
    }
}
```

**根本原因**：`createNewSessionFromNavigation()` 方法没有检查是否存在可复用的空会话，总是创建新会话。

### 2.2 问题2：会话命名不友好

**问题代码定位**：`AiAdvisorSession.kt`

```kotlin
companion object {
    fun create(contactId: String, title: String = "新对话"): AiAdvisorSession {
        // 默认标题"新对话"，没有后续更新机制
    }
}
```

**根本原因**：会话创建时使用默认标题"新对话"，没有在用户发送第一条消息时自动更新标题。

### 2.3 问题3：缺少会话管理功能

**问题代码定位**：`AiAdvisorSession.kt` 和 `SessionHistoryScreen.kt`

**根本原因**：
- 数据模型缺少 `isPinned` 字段
- UI缺少重命名和置顶的交互入口

---

## 3. 修复方案

### 3.1 方案概述

| 功能 | 优先级 | 修改范围 | 复杂度 |
|------|--------|----------|--------|
| 空会话复用 | P0 | ViewModel + Repository | 低 |
| 会话自动命名 | P0 | ViewModel | 低 |
| 会话重命名 | P1 | UI + ViewModel | 中 |
| 会话置顶 | P1 | 全栈（DB迁移） | 中 |

### 3.2 功能1：空会话复用

#### 3.2.1 业务逻辑

```
用户点击"新建会话"或进入AI军师
    ↓
检查该联系人是否存在空会话（messageCount == 0）
    ├── 存在空会话 → 复用该会话，不创建新会话
    └── 不存在空会话 → 创建新会话
```

#### 3.2.2 修改文件

1. **AiAdvisorDao.kt** - 添加查询空会话方法
```kotlin
@Query("""
    SELECT * FROM ai_advisor_sessions 
    WHERE contact_id = :contactId AND message_count = 0
    ORDER BY updated_at DESC
    LIMIT 1
""")
suspend fun getLatestEmptySession(contactId: String): AiAdvisorSessionEntity?
```

2. **AiAdvisorRepository.kt** - 添加接口方法
```kotlin
suspend fun getLatestEmptySession(contactId: String): Result<AiAdvisorSession?>
```

3. **AiAdvisorRepositoryImpl.kt** - 实现方法

4. **AiAdvisorChatViewModel.kt** - 修改创建会话逻辑
```kotlin
fun createNewSessionFromNavigation() {
    viewModelScope.launch {
        // 先检查是否存在空会话
        aiAdvisorRepository.getLatestEmptySession(contactId).onSuccess { emptySession ->
            if (emptySession != null) {
                // 复用空会话
                _uiState.update { it.copy(currentSessionId = emptySession.id) }
                loadConversations(emptySession.id)
            } else {
                // 创建新会话
                createAdvisorSessionUseCase(contactId).onSuccess { session ->
                    // ...
                }
            }
        }
    }
}
```

### 3.3 功能2：会话自动命名

#### 3.3.1 业务逻辑

```
用户发送消息
    ↓
检查当前会话的 messageCount
    ├── messageCount == 0 → 这是第一条消息
    │   ↓
    │   生成标题 = 用户消息.take(20) + (if 超长 "..." else "")
    │   ↓
    │   调用 updateSessionTitle(sessionId, newTitle)
    └── messageCount > 0 → 不更新标题
```

#### 3.3.2 标题生成规则

```kotlin
fun generateSessionTitle(userMessage: String): String {
    val maxLength = 20
    val cleaned = userMessage.trim().replace("\n", " ")
    return if (cleaned.length > maxLength) {
        cleaned.take(maxLength) + "..."
    } else {
        cleaned
    }
}
```

#### 3.3.3 修改文件

1. **AiAdvisorChatViewModel.kt** - 在发送消息时更新标题
```kotlin
private fun sendMessageStreaming(message: String, sessionId: String) {
    // 检查是否需要更新会话标题（第一条消息）
    val currentSession = _uiState.value.sessions.find { it.id == sessionId }
    if (currentSession?.messageCount == 0) {
        val newTitle = generateSessionTitle(message)
        viewModelScope.launch {
            aiAdvisorRepository.updateSessionTitle(sessionId, newTitle)
        }
    }
    
    // 继续原有发送逻辑...
}
```

### 3.4 功能3：会话重命名

#### 3.4.1 UI交互设计

- 在 SessionHistoryScreen 的会话列表项上添加长按菜单
- 菜单选项：重命名、置顶/取消置顶、删除
- 点击"重命名"弹出对话框，输入新标题

#### 3.4.2 修改文件

1. **SessionHistoryViewModel.kt** - 添加重命名方法
```kotlin
fun renameSession(sessionId: String, newTitle: String) {
    viewModelScope.launch {
        aiAdvisorRepository.updateSessionTitle(sessionId, newTitle)
            .onSuccess { loadSessions() }
            .onFailure { error -> _uiState.update { it.copy(error = error.message) } }
    }
}
```

2. **SessionHistoryScreen.kt** - 添加重命名对话框
```kotlin
@Composable
private fun RenameSessionDialog(
    currentTitle: String,
    onConfirm: (String) -> Unit,
    onDismiss: () -> Unit
)
```

### 3.5 功能4：会话置顶

#### 3.5.1 数据模型修改

1. **AiAdvisorSession.kt** (domain层)
```kotlin
data class AiAdvisorSession(
    val id: String,
    val contactId: String,
    val title: String,
    val createdAt: Long,
    val updatedAt: Long,
    val messageCount: Int = 0,
    val isActive: Boolean = true,
    val isPinned: Boolean = false  // 新增
)
```

2. **AiAdvisorSessionEntity.kt** (data层)
```kotlin
@ColumnInfo(name = "is_pinned", defaultValue = "0")
val isPinned: Boolean = false
```

#### 3.5.2 数据库迁移

**Migration_12_13.kt**
```kotlin
val MIGRATION_12_13 = object : Migration(12, 13) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL(
            "ALTER TABLE ai_advisor_sessions ADD COLUMN is_pinned INTEGER NOT NULL DEFAULT 0"
        )
    }
}
```

#### 3.5.3 修改文件

1. **AppDatabase.kt** - 版本升级 12→13，添加迁移
2. **AiAdvisorDao.kt** - 添加置顶方法，修改排序
```kotlin
@Query("UPDATE ai_advisor_sessions SET is_pinned = :isPinned WHERE id = :sessionId")
suspend fun updateSessionPinned(sessionId: String, isPinned: Boolean)

@Query("""
    SELECT * FROM ai_advisor_sessions 
    WHERE contact_id = :contactId 
    ORDER BY is_pinned DESC, updated_at DESC
""")
suspend fun getSessionsByContact(contactId: String): List<AiAdvisorSessionEntity>
```

3. **AiAdvisorRepository.kt** - 添加接口方法
4. **AiAdvisorRepositoryImpl.kt** - 实现方法
5. **SessionHistoryViewModel.kt** - 添加置顶方法
6. **SessionHistoryScreen.kt** - 添加置顶图标和菜单选项

---

## 4. 测试用例

### 4.1 TC-001: 空会话复用 - 存在空会话时复用

**前置条件**: 联系人已有一个空会话（messageCount=0）

**步骤**:
1. 进入AI军师对话界面
2. 点击会话历史按钮
3. 点击"新建会话"按钮

**预期结果**:
- 不创建新会话
- 复用现有的空会话
- 会话列表数量不变

### 4.2 TC-002: 空会话复用 - 不存在空会话时创建

**前置条件**: 联系人所有会话都有对话内容（messageCount>0）

**步骤**:
1. 进入AI军师对话界面
2. 点击会话历史按钮
3. 点击"新建会话"按钮

**预期结果**:
- 创建新的空白会话
- 会话列表数量+1

### 4.3 TC-003: 会话自动命名 - 第一条消息

**前置条件**: 新建或复用一个空会话

**步骤**:
1. 在空会话中输入消息"帮我分析一下荔枝的性格"
2. 点击发送

**预期结果**:
- 消息发送成功
- 会话标题自动更新为"帮我分析一下荔枝的性格"（前20字符）

### 4.4 TC-004: 会话自动命名 - 长消息截断

**前置条件**: 新建或复用一个空会话

**步骤**:
1. 在空会话中输入消息"这是一条非常非常非常非常非常长的消息内容"
2. 点击发送

**预期结果**:
- 消息发送成功
- 会话标题自动更新为"这是一条非常非常非常非常非常..."

### 4.5 TC-005: 会话自动命名 - 非第一条消息不更新

**前置条件**: 会话已有对话内容

**步骤**:
1. 在已有对话的会话中发送新消息
2. 检查会话标题

**预期结果**:
- 消息发送成功
- 会话标题保持不变

### 4.6 TC-006: 会话重命名

**前置条件**: 会话历史页面有至少一个会话

**步骤**:
1. 长按某个会话
2. 点击"重命名"
3. 输入新标题"关于工作的讨论"
4. 点击确认

**预期结果**:
- 会话标题更新为"关于工作的讨论"
- 会话列表刷新显示新标题

### 4.7 TC-007: 会话置顶

**前置条件**: 会话历史页面有至少两个会话

**步骤**:
1. 长按第二个会话
2. 点击"置顶"

**预期结果**:
- 该会话移动到列表顶部
- 显示置顶图标
- 其他会话按更新时间排序

### 4.8 TC-008: 取消会话置顶

**前置条件**: 有一个已置顶的会话

**步骤**:
1. 长按已置顶的会话
2. 点击"取消置顶"

**预期结果**:
- 置顶图标消失
- 会话按更新时间重新排序

### 4.9 TC-009: 数据库迁移验证

**前置条件**: 应用使用数据库版本12

**步骤**:
1. 升级应用到新版本（数据库版本13）
2. 打开AI军师会话历史

**预期结果**:
- 应用正常启动
- 历史会话数据保留
- 所有会话的isPinned默认为false

---

## 5. 验证清单

### 5.1 空会话复用
- [ ] 存在空会话时不创建新会话
- [ ] 不存在空会话时正常创建
- [ ] 复用的会话可以正常发送消息
- [ ] 会话列表数量正确

### 5.2 会话自动命名
- [ ] 第一条消息自动更新标题
- [ ] 长消息正确截断并添加"..."
- [ ] 非第一条消息不更新标题
- [ ] 标题去除换行符

### 5.3 会话重命名
- [ ] 长按显示菜单
- [ ] 重命名对话框正常显示
- [ ] 新标题正确保存
- [ ] 列表刷新显示新标题

### 5.4 会话置顶
- [ ] 置顶后会话移到顶部
- [ ] 显示置顶图标
- [ ] 取消置顶后恢复排序
- [ ] 多个置顶会话按更新时间排序

### 5.5 数据库迁移
- [ ] 迁移脚本正确执行
- [ ] 历史数据保留
- [ ] 新字段默认值正确

---

## 6. 相关文件

| 文件路径 | 修改类型 | 说明 |
|----------|----------|------|
| `domain/.../model/AiAdvisorSession.kt` | 修改 | 添加isPinned字段 |
| `domain/.../repository/AiAdvisorRepository.kt` | 修改 | 添加getLatestEmptySession、updateSessionPinned方法 |
| `data/.../entity/AiAdvisorSessionEntity.kt` | 修改 | 添加isPinned字段 |
| `data/.../dao/AiAdvisorDao.kt` | 修改 | 添加查询方法，修改排序 |
| `data/.../local/AppDatabase.kt` | 修改 | 版本升级，添加迁移 |
| `data/.../repository/AiAdvisorRepositoryImpl.kt` | 修改 | 实现新方法 |
| `presentation/.../viewmodel/AiAdvisorChatViewModel.kt` | 修改 | 空会话复用、自动命名逻辑 |
| `presentation/.../viewmodel/SessionHistoryViewModel.kt` | 修改 | 添加重命名、置顶方法 |
| `presentation/.../ui/screen/advisor/SessionHistoryScreen.kt` | 修改 | 添加长按菜单、对话框、置顶图标 |

---

## 7. 风险评估

| 风险项 | 等级 | 说明 | 缓解措施 |
|--------|------|------|----------|
| 数据库迁移失败 | 中 | 新增字段可能导致迁移问题 | 使用ALTER TABLE，编写迁移测试 |
| 空会话判断不准确 | 低 | messageCount可能不同步 | 同时检查对话列表是否为空 |
| 标题更新时序问题 | 低 | 消息发送和标题更新可能冲突 | 使用协程确保顺序执行 |

---

**文档版本**: 1.1
**最后更新**: 2026-01-09
**修复状态**: ✅ 已修复

## 8. 修复实现记录

### 8.1 修改文件清单

| 文件路径 | 修改类型 | 说明 |
|----------|----------|------|
| `domain/.../model/AiAdvisorSession.kt` | 修改 | 添加isPinned字段 |
| `domain/.../repository/AiAdvisorRepository.kt` | 修改 | 添加getLatestEmptySession、updateSessionPinned方法 |
| `data/.../entity/AiAdvisorSessionEntity.kt` | 修改 | 添加isPinned字段和转换逻辑 |
| `data/.../dao/AiAdvisorDao.kt` | 修改 | 添加查询方法，修改排序为置顶优先 |
| `data/.../di/DatabaseModule.kt` | 修改 | 添加MIGRATION_15_16迁移脚本 |
| `data/.../local/AppDatabase.kt` | 修改 | 版本升级15→16 |
| `data/.../repository/AiAdvisorRepositoryImpl.kt` | 修改 | 实现新方法 |
| `presentation/.../viewmodel/AiAdvisorChatViewModel.kt` | 修改 | 空会话复用、自动命名逻辑 |
| `presentation/.../viewmodel/SessionHistoryViewModel.kt` | 修改 | 添加重命名、置顶方法和UI状态 |
| `presentation/.../ui/screen/advisor/SessionHistoryScreen.kt` | 修改 | 添加长按菜单、重命名对话框、置顶图标 |

### 8.2 数据库迁移

```kotlin
// MIGRATION_15_16: 添加is_pinned字段
ALTER TABLE ai_advisor_sessions ADD COLUMN is_pinned INTEGER NOT NULL DEFAULT 0
```

### 8.3 核心功能实现

1. **空会话复用**：在`createNewSessionFromNavigation()`中先调用`getLatestEmptySession()`检查是否存在空会话
2. **会话自动命名**：在`sendMessageStreaming()`中检查`messageCount==0`时调用`generateSessionTitle()`
3. **会话重命名**：通过`SessionHistoryViewModel.renameSession()`调用`updateSessionTitle()`
4. **会话置顶**：通过`SessionHistoryViewModel.togglePinSession()`调用`updateSessionPinned()`
