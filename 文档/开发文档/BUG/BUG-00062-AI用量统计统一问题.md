# BUG-00062：AI用量统计统一问题

## 问题概述

【问题分类】功能缺失

【优先级】P1-高

【发现版本】未知

【发现时间】2025-01-09

---

## 问题描述

### 背景说明

目前应用的 AI 用量统计功能不完整，仅涵盖了部分 AI 功能。需要将所有涉及 AI 服务的模块统一纳入用量统计。

### 当前状态

已纳入统计的模块：
- 悬浮窗的 4 个 AI 选项（快速知识回答、快速提醒、话术生成、联系人生成）

待纳入统计的模块：
- AI 军师的对话请求
- AI 总结功能的请求

### 期望行为

所有经过 AI 服务处理的内容都应该被统一纳入「AI 配置」界面的用量统计中，包括：

1. **悬浮窗模块**（已实现）：
   
2. **AI 军师模块**（待实现）：
   - AI 军师的对话请求和响应

3. **AI 总结模块**（待实现）：
   - 事实流的 AI 总结请求和响应

### 实际行为

- AI 军师的对话不计入用量统计
- AI 总结的请求不计入用量统计
- 用户无法看到完整的 AI 使用情况

---

## 问题分析

### 影响范围

- **功能完整性**：AI 用量统计功能不完整
- **用户体验**：用户无法准确了解自己的 AI 使用情况
- **数据统计**：影响对 AI 资源消耗的准确评估

### 技术影响

- 需要在 AI 军师的请求/响应链路中添加用量统计逻辑
- 需要在 AI 总结的请求/响应链路中添加用量统计逻辑
- 确保统计数据的准确性（token 计数、请求次数等）

---

## 测试步骤

1. 进入「设置」-「AI 配置」-「用量统计」页面
2. 查看当前的用量统计信息
3. 使用悬浮窗的 AI 功能（如快速知识回答）
4. 返回用量统计页面，验证是否记录了本次使用
5. 使用 AI 军师进行对话
6. 返回用量统计页面，验证是否记录了 AI 军师的使用
7. 在事实流中使用 AI 总结功能
8. 返回用量统计页面，验证是否记录了 AI 总结的使用

---

## 实现方案

### 需要修改的模块

#### 1. AI 军师模块

在 `SendAdvisorMessageUseCase` 或相关用例中添加：
- 请求发起时记录用量
- 响应完成时统计 token 消耗
- 统一上报到用量统计服务

#### 2. AI 总结模块

在事实流的 AI 总结功能中添加：
- 总结请求发起时记录用量
- 总结响应完成时统计 token 消耗
- 统一上报到用量统计服务

#### 3. 统一统计服务

确保用量统计服务能够：
- 区分不同来源的 AI 请求
- 正确计算 token 消耗
- 在 UI 上正确展示各类 AI 功能的使用情况

---

## 相关问题

- 来源：BUG-00059 人工测试问题
- 相关模块：
  - 悬浮窗
  - AI 军师
  - AI 总结
  - AI 配置（用量统计）

---

## 备注

这是一个**功能完善**需求，需要将所有 AI 相关功能统一纳入用量统计。建议：
1. 先梳理现有的用量统计实现方式
2. 在 AI 军师和 AI 总结模块中添加统计埋点
3. 确保统计数据的准确性
4. 在 UI 上正确展示各类 AI 功能的使用明细
