# BUG-00065：事实流编辑功能缺失 - 修复方案

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档编号** | BUG-00065 |
| **问题分类** | 功能缺失（UI层连接问题） |
| **优先级** | P2-中 |
| **发现时间** | 2025-01-09 |
| **编写者** | Kiro |
| **状态** | 待实现 |

---

## 一、问题概述

### 1.1 问题描述

在事实流模块中，用户添加事实后没有编辑功能。一旦事实被添加，就无法进行修改、删除或重新编辑。

### 1.2 问题表现

1. **添加后不可修改**：用户添加事实后，只能查看，无法编辑
2. **删除困难**：没有提供删除已添加事实的入口
3. **无重新编辑选项**：无法对已添加的事实进行修正或更新

### 1.3 期望行为

- 点击时光轴中的事实卡片，应该打开编辑对话框
- 点击清单中的事实行，应该打开编辑对话框
- 编辑对话框中可以修改事实内容、删除事实

---

## 二、根因分析

### 2.1 现有代码分析

经过深入分析，发现编辑功能已经**大部分实现（约85%）**：

| 组件 | 状态 | 说明 |
|------|------|------|
| **Fact 模型** | ✅ 完整 | 支持 `copyWithEdit()` 方法和编辑追踪 |
| **UiEvent** | ✅ 完整 | 定义了 `StartEditFact`、`ConfirmEditFact`、`CancelEditFact`、`DeleteFactById` |
| **UiState** | ✅ 完整 | 包含 `showEditFactDialog`、`editingFact` 字段 |
| **ViewModel** | ✅ 完整 | 实现了 `startEditFact`、`confirmEditFact`、`cancelEditFact`、`deleteFactById` |
| **EditFactDialog** | ✅ 完整 | 编辑对话框 UI 已实现 |
| **ContactDetailTabScreen** | ✅ 完整 | 已连接 `onFactEdit` 回调 |
| **FactStreamTab** | ⚠️ 部分 | 定义了 `onFactEdit` 参数，但未传递给子组件 |
| **ModernTimelineView** | ❌ 缺失 | 没有 `onFactEdit` 参数，点击事实卡片无法触发编辑 |
| **ModernListView** | ❌ 缺失 | 没有 `onFactEdit` 参数，点击事实行无法触发编辑 |

### 2.2 根本原因

**问题1：FactStreamTab 没有将 onFactEdit 传递给子组件**

```kotlin
// 当前实现（有问题）
ModernTimelineView(
    items = filteredItems,
    onItemClick = onItemClick  // ❌ 只传递了 onItemClick，没有传递 onFactEdit
)
```

**问题2：ModernTimelineView 没有区分不同类型的 TimelineItem**

```kotlin
// 当前实现（有问题）
ModernTimelineCard(
    ...
    onClick = onClick  // ❌ 所有类型的点击都走同一个回调
)
```

对于 `TimelineItem.UserFact` 类型，点击应该触发编辑，而不是通用的 `onItemClick`。

### 2.3 数据流分析

**期望的数据流**：
```
用户点击事实卡片
  ↓
ModernTimelineView.onFactEdit(factId)
  ↓
FactStreamTab.onFactEdit(factId)
  ↓
ContactDetailTabScreen → ContactDetailUiEvent.StartEditFact(fact)
  ↓
ContactDetailTabViewModel.startEditFact(fact)
  ↓
更新 UiState: showEditFactDialog = true, editingFact = fact
  ↓
显示 EditFactDialog
```

**当前的断点**：
```
用户点击事实卡片
  ↓
ModernTimelineView.onClick()  // ❌ 没有区分事实类型
  ↓
FactStreamTab.onItemClick()   // ❌ 通用点击，不触发编辑
  ↓
❌ 无法进入编辑流程
```

---

## 三、修复方案

### 3.1 修改文件清单

| 文件 | 修改类型 | 优先级 | 说明 |
|------|----------|--------|------|
| `ModernTimelineView.kt` | 修改 | 高 | 添加 `onFactEdit` 参数，区分事实类型点击 |
| `ModernListView.kt` | 修改 | 高 | 添加 `onFactEdit` 参数，区分事实类型点击 |
| `FactStreamTab.kt` | 修改 | 高 | 将 `onFactEdit` 传递给子组件 |

### 3.2 详细修改方案

#### 3.2.1 修改 ModernTimelineView.kt

**文件路径**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/factstream/ModernTimelineView.kt`

**修改内容**：

1. 添加 `onFactEdit` 参数
2. 在 `ModernTimelineRow` 中区分事实类型的点击

```kotlin
// 修改前
@Composable
fun ModernTimelineView(
    items: List<TimelineItem>,
    modifier: Modifier = Modifier,
    onItemClick: ((TimelineItem) -> Unit)? = null
)

// 修改后
@Composable
fun ModernTimelineView(
    items: List<TimelineItem>,
    modifier: Modifier = Modifier,
    onItemClick: ((TimelineItem) -> Unit)? = null,
    onFactEdit: ((String) -> Unit)? = null  // 新增：事实编辑回调
)
```

```kotlin
// 修改 ModernTimelineRow 的点击处理
@Composable
private fun ModernTimelineRow(
    item: TimelineItem,
    index: Int,
    isLast: Boolean,
    onClick: () -> Unit,
    onFactEdit: ((String) -> Unit)? = null  // 新增参数
) {
    // ... 动画代码 ...
    
    ModernTimelineCard(
        title = getItemTitle(item),
        content = getItemContent(item),
        time = formatTimeOnly(item.timestamp),
        sourceLabel = getSourceLabel(item),
        isAiSummary = item is TimelineItem.AiSummary,
        aiSuggestion = getAiSuggestion(item),
        scoreChange = getScoreChange(item),
        tags = getTags(item),
        onClick = {
            // 区分事实类型的点击
            if (item is TimelineItem.UserFact && onFactEdit != null) {
                onFactEdit(item.fact.id)  // 事实类型：触发编辑
            } else {
                onClick()  // 其他类型：通用点击
            }
        }
    )
}
```

#### 3.2.2 修改 ModernListView.kt

**文件路径**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/factstream/ModernListView.kt`

**修改内容**：

1. 添加 `onFactEdit` 参数
2. 在列表行点击时区分事实类型

```kotlin
// 修改前
@Composable
fun ModernListView(
    items: List<TimelineItem>,
    selectedItems: Set<String>,
    isSelectionMode: Boolean,
    onItemClick: (TimelineItem) -> Unit,
    onItemSelect: (String, Boolean) -> Unit,
    modifier: Modifier = Modifier
)

// 修改后
@Composable
fun ModernListView(
    items: List<TimelineItem>,
    selectedItems: Set<String>,
    isSelectionMode: Boolean,
    onItemClick: (TimelineItem) -> Unit,
    onItemSelect: (String, Boolean) -> Unit,
    modifier: Modifier = Modifier,
    onFactEdit: ((String) -> Unit)? = null  // 新增：事实编辑回调
)
```

```kotlin
// 修改列表行的点击处理
ModernListRow(
    item = item,
    isSelected = item.id in selectedItems,
    isSelectionMode = isSelectionMode,
    onClick = {
        if (isSelectionMode) {
            // 选择模式：切换选中状态
            onItemSelect(item.id, item.id !in selectedItems)
        } else if (item is TimelineItem.UserFact && onFactEdit != null) {
            // 非选择模式 + 事实类型：触发编辑
            onFactEdit(item.fact.id)
        } else {
            // 其他情况：通用点击
            onItemClick(item)
        }
    },
    onSelect = { selected -> onItemSelect(item.id, selected) }
)
```

#### 3.2.3 修改 FactStreamTab.kt

**文件路径**：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/factstream/FactStreamTab.kt`

**修改内容**：将 `onFactEdit` 传递给 `ModernTimelineView` 和 `ModernListView`

```kotlin
// 修改前
when (mode) {
    ViewMode.Timeline -> ModernTimelineView(
        items = filteredItems,
        onItemClick = onItemClick
    )
    ViewMode.List -> ModernListView(
        items = filteredItems,
        selectedItems = selectedItems,
        isSelectionMode = isSelectionMode,
        onItemClick = { item -> ... },
        onItemSelect = { id, selected -> ... }
    )
}

// 修改后
when (mode) {
    ViewMode.Timeline -> ModernTimelineView(
        items = filteredItems,
        onItemClick = onItemClick,
        onFactEdit = onFactEdit  // 新增：传递事实编辑回调
    )
    ViewMode.List -> ModernListView(
        items = filteredItems,
        selectedItems = selectedItems,
        isSelectionMode = isSelectionMode,
        onItemClick = { item -> ... },
        onItemSelect = { id, selected -> ... },
        onFactEdit = onFactEdit  // 新增：传递事实编辑回调
    )
}
```

---

## 四、边界情况处理

| 场景 | 处理方式 |
|------|----------|
| 事实列表为空 | 显示空状态提示，无需处理编辑 |
| 编辑时事实被删除 | ViewModel 中已有 NotFound 错误处理 |
| 编辑内容为空 | ViewModel 中已有验证，显示"内容不能为空"错误 |
| 编辑内容未变化 | ViewModel 中已有 NoChanges 处理，显示"内容未变化"提示 |
| 并发编辑 | 使用 UiState 单一状态源，避免并发问题 |

---

## 五、测试用例

### 5.1 功能测试

| 测试ID | 测试场景 | 预期结果 |
|--------|----------|----------|
| TC-001 | 时光轴视图点击事实卡片 | 打开编辑对话框 |
| TC-002 | 清单视图点击事实行 | 打开编辑对话框 |
| TC-003 | 编辑事实内容后保存 | 事实内容更新，显示成功提示 |
| TC-004 | 删除事实 | 事实从列表移除，显示成功提示 |
| TC-005 | 取消编辑 | 关闭对话框，内容不变 |
| TC-006 | 编辑后时间线更新 | 时间线项目正确更新 |
| TC-007 | 编辑后 topTags 更新 | topTags 列表正确更新 |

### 5.2 边界测试

| 测试ID | 测试场景 | 预期结果 |
|--------|----------|----------|
| TC-008 | 编辑内容为空 | 显示"内容不能为空"错误 |
| TC-009 | 编辑内容未变化 | 显示"内容未变化"提示 |
| TC-010 | 点击非事实类型项目 | 触发通用 onItemClick |
| TC-011 | 清单选择模式下点击事实 | 切换选中状态，不触发编辑 |

---

## 六、风险评估

| 风险 | 等级 | 缓解措施 |
|------|------|----------|
| 修改影响其他功能 | 低 | 只修改 UI 层，核心逻辑不变 |
| 回调传递遗漏 | 低 | 编译时类型检查 |
| 点击事件冲突 | 低 | 明确区分事实类型和其他类型 |

---

## 七、实现计划

### 7.1 工作量估算

| 任务 | 预估时间 |
|------|----------|
| ModernTimelineView 修改 | 0.5小时 |
| ModernListView 修改 | 0.5小时 |
| FactStreamTab 修改 | 0.25小时 |
| 测试编写 | 1小时 |
| 人工验收 | 0.5小时 |
| **总计** | **2.75小时** |

### 7.2 实现步骤

1. **Step 1**：修改 `ModernTimelineView.kt`，添加 `onFactEdit` 参数和点击处理
2. **Step 2**：修改 `ModernListView.kt`，添加 `onFactEdit` 参数和点击处理
3. **Step 3**：修改 `FactStreamTab.kt`，传递 `onFactEdit` 回调
4. **Step 4**：编写单元测试
5. **Step 5**：人工验收测试

---

## 八、验收标准

1. ✅ 时光轴视图点击事实卡片能打开编辑对话框
2. ✅ 清单视图点击事实行能打开编辑对话框
3. ✅ 编辑事实内容后能正确保存
4. ✅ 删除事实后能从列表中移除
5. ✅ 编辑/删除后时间线正确更新
6. ✅ 编辑/删除后 topTags 和 latestFact 正确更新
7. ✅ 编辑/删除操作显示成功/错误提示
8. ✅ 点击非事实类型项目仍触发通用点击回调
9. ✅ 清单选择模式下点击事实切换选中状态

---

## 九、相关文档

- **问题文档**：[BUG-00065-事实流编辑功能缺失.md](./BUG-00065-事实流编辑功能缺失.md)
- **相关模块**：presentation 模块
- **相关组件**：
  - `ModernTimelineView.kt`
  - `ModernListView.kt`
  - `FactStreamTab.kt`
  - `ContactDetailTabScreen.kt`
  - `ContactDetailTabViewModel.kt`

---

## 十、变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2026-01-10 | v1.0 | 初始版本 | Kiro |
