# BUG-00066ï¼šç”»åƒæ ‡ç­¾ç¼–è¾‘åŠŸèƒ½ç¼ºå¤± - ä¿®å¤æ–¹æ¡ˆ

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£ç¼–å·** | BUG-00066 |
| **é—®é¢˜åˆ†ç±»** | åŠŸèƒ½ç¼ºå¤± |
| **ä¼˜å…ˆçº§** | P3-è¾ƒä½ |
| **å‘ç°æ—¶é—´** | 2026-01-09 |
| **ç¼–å†™è€…** | Kiro |
| **çŠ¶æ€** | å·²å®ç° |

---

## ä¸€ã€é—®é¢˜æ¦‚è¿°

### 1.1 é—®é¢˜æè¿°

åœ¨è”ç³»äººç”»åƒæ¨¡å—ä¸­ï¼Œç”¨æˆ·æ·»åŠ æ ‡ç­¾ï¼ˆBrainTagï¼‰åæ²¡æœ‰ç¼–è¾‘åŠŸèƒ½ã€‚ä¸€æ—¦æ ‡ç­¾è¢«æ·»åŠ ï¼Œå°±æ— æ³•è¿›è¡Œä¿®æ”¹ï¼Œåªèƒ½åˆ é™¤åé‡æ–°æ·»åŠ ã€‚

### 1.2 é—®é¢˜è¡¨ç°

1. **æ·»åŠ åä¸å¯ä¿®æ”¹**ï¼šç”¨æˆ·æ·»åŠ æ ‡ç­¾åï¼Œåªèƒ½æŸ¥çœ‹ï¼Œæ— æ³•ç¼–è¾‘æ ‡ç­¾å†…å®¹ âŒ
2. **æ— ç¼–è¾‘å…¥å£**ï¼šç‚¹å‡»æ ‡ç­¾æ— ä»»ä½•å“åº”ï¼Œé•¿æŒ‰åªèƒ½åˆ é™¤ âŒ
3. **ç±»å‹ä¸å¯åˆ‡æ¢**ï¼šæ— æ³•å°†é›·åŒºæ ‡ç­¾æ”¹ä¸ºç­–ç•¥æ ‡ç­¾ï¼Œåä¹‹äº¦ç„¶ âŒ

### 1.3 æœŸæœ›è¡Œä¸º

- ç‚¹å‡»æ ‡ç­¾åï¼Œå¼¹å‡ºç¼–è¾‘å¯¹è¯æ¡†
- ç”¨æˆ·å¯ä»¥ä¿®æ”¹æ ‡ç­¾å†…å®¹ï¼ˆcontentï¼‰
- ç”¨æˆ·å¯ä»¥åˆ‡æ¢æ ‡ç­¾ç±»å‹ï¼ˆRISK_RED â†” STRATEGY_GREENï¼‰
- ä¿å­˜å UI å®æ—¶æ›´æ–°æ˜¾ç¤ºæ–°å†…å®¹

---

## äºŒã€æ ¹å› åˆ†æ

### 2.1 ç°æœ‰ä»£ç åˆ†æ

ç»è¿‡æ·±å…¥åˆ†æï¼Œå‘ç°æ ‡ç­¾ç³»ç»Ÿæ¶æ„å®Œæ•´ï¼Œä½†**ç¼ºå°‘ç¼–è¾‘åŠŸèƒ½çš„å®Œæ•´é“¾è·¯**ï¼š

| å±‚çº§ | ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| **Domain** | BrainTag æ¨¡å‹ | âœ… å®Œæ•´ | idã€contactIdã€contentã€typeã€sourceã€isConfirmed |
| **Domain** | BrainTagRepository | âš ï¸ ç¼ºå¤± | æœ‰ getTagsForContactã€saveTagã€deleteTagï¼Œ**ç¼ºå°‘ updateTag** |
| **Domain** | GetBrainTagsUseCase | âœ… å®Œæ•´ | è·å–æ ‡ç­¾ |
| **Domain** | SaveBrainTagUseCase | âœ… å®Œæ•´ | ä¿å­˜æ ‡ç­¾ |
| **Domain** | DeleteBrainTagUseCase | âœ… å®Œæ•´ | åˆ é™¤æ ‡ç­¾ |
| **Domain** | EditBrainTagUseCase | âŒ ç¼ºå¤± | **éœ€è¦åˆ›å»º** |
| **Data** | BrainTagDao | âš ï¸ ç¼ºå¤± | æœ‰ insertTagã€deleteTagï¼Œ**ç¼ºå°‘ updateTag** |
| **Data** | BrainTagRepositoryImpl | âš ï¸ ç¼ºå¤± | **éœ€è¦å®ç° updateTag** |
| **Presentation** | ContactDetailTabViewModel | âš ï¸ ç¼ºå¤± | **éœ€è¦æ·»åŠ ç¼–è¾‘æ–¹æ³•** |
| **Presentation** | ContactDetailUiEvent | âš ï¸ ç¼ºå¤± | **éœ€è¦æ·»åŠ ç¼–è¾‘äº‹ä»¶** |
| **Presentation** | ContactDetailUiState | âš ï¸ ç¼ºå¤± | **éœ€è¦æ·»åŠ ç¼–è¾‘çŠ¶æ€** |
| **Presentation** | EditBrainTagDialog | âŒ ç¼ºå¤± | **éœ€è¦åˆ›å»º** |
| **Presentation** | PersonaTab | âš ï¸ ç¼ºå¤± | **éœ€è¦é›†æˆç¼–è¾‘å…¥å£** |

### 2.2 æ ¹æœ¬åŸå› 

**é—®é¢˜1ï¼šé¢†åŸŸå±‚ç¼ºå°‘ç¼–è¾‘æ¥å£**

```kotlin
// BrainTagRepository.kt å½“å‰æ¥å£
interface BrainTagRepository {
    fun getTagsForContact(contactId: String): Flow<List<BrainTag>>
    suspend fun getAllRedFlags(): Result<List<BrainTag>>
    suspend fun saveTag(tag: BrainTag): Result<Long>
    suspend fun deleteTag(id: Long): Result<Unit>
    // âŒ ç¼ºå°‘: suspend fun updateTag(tag: BrainTag): Result<Unit>
}
```

**é—®é¢˜2ï¼šæ•°æ®å±‚ç¼ºå°‘æ›´æ–°æ–¹æ³•**

```kotlin
// BrainTagDao.kt å½“å‰æ–¹æ³•
@Dao
interface BrainTagDao {
    @Query("SELECT * FROM brain_tags WHERE contact_id = :contactId")
    fun getTagsByContactId(contactId: String): Flow<List<BrainTagEntity>>
    
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertTag(entity: BrainTagEntity): Long
    
    @Query("DELETE FROM brain_tags WHERE id = :id")
    suspend fun deleteTag(id: Long)
    
    // âŒ ç¼ºå°‘: @Query("UPDATE brain_tags SET content = :content, tag_type = :type WHERE id = :id")
    //         suspend fun updateTag(id: Long, content: String, type: String)
}
```

**é—®é¢˜3ï¼šUI å±‚ç¼ºå°‘ç¼–è¾‘äº¤äº’**

```kotlin
// PersonaTab.kt å½“å‰äº¤äº’
onFactClick = { fact ->
    // âŒ å½“å‰ï¼šæ— ä»»ä½•å“åº”
    // âœ… æœŸæœ›ï¼šè§¦å‘ç¼–è¾‘å¯¹è¯æ¡†
}

onFactLongClick = { fact ->
    // âœ… å½“å‰ï¼šåˆ é™¤æ ‡ç­¾
    onEvent(ContactDetailUiEvent.DeleteFactById(fact.id))
}
```

---

## ä¸‰ã€ä¿®å¤æ–¹æ¡ˆ

### 3.1 ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æ¨¡å— | ä¿®æ”¹ç±»å‹ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|------|----------|--------|------|
| `BrainTagRepository.kt` | :domain | ä¿®æ”¹ | P0 | æ·»åŠ  updateTag() æ¥å£ |
| `EditBrainTagUseCase.kt` | :domain | æ–°å¢ | P0 | åˆ›å»ºç¼–è¾‘ç”¨ä¾‹ |
| `BrainTagDao.kt` | :data | ä¿®æ”¹ | P0 | æ·»åŠ  updateTag() SQL |
| `BrainTagRepositoryImpl.kt` | :data | ä¿®æ”¹ | P0 | å®ç° updateTag() |
| `ContactDetailUiState.kt` | :presentation | ä¿®æ”¹ | P1 | æ·»åŠ ç¼–è¾‘çŠ¶æ€å­—æ®µ |
| `ContactDetailUiEvent.kt` | :presentation | ä¿®æ”¹ | P1 | æ·»åŠ ç¼–è¾‘äº‹ä»¶ |
| `ContactDetailTabViewModel.kt` | :presentation | ä¿®æ”¹ | P1 | æ·»åŠ ç¼–è¾‘æ–¹æ³• |
| `EditBrainTagDialog.kt` | :presentation | æ–°å¢ | P1 | åˆ›å»ºç¼–è¾‘å¯¹è¯æ¡† |
| `PersonaTab.kt` | :presentation | ä¿®æ”¹ | P1 | é›†æˆç¼–è¾‘å…¥å£ |

### 3.2 è¯¦ç»†ä¿®æ”¹æ–¹æ¡ˆ

#### 3.2.1 é¢†åŸŸå±‚ï¼ˆ:domainï¼‰

**æ–‡ä»¶1ï¼šBrainTagRepository.kt**

```kotlin
// æ·»åŠ  updateTag æ–¹æ³•
interface BrainTagRepository {
    // ... ç°æœ‰æ–¹æ³• ...
    
    /**
     * æ›´æ–°è„‘æ ‡ç­¾
     *
     * ä¸šåŠ¡è§„åˆ™:
     * - æ”¯æŒä¿®æ”¹æ ‡ç­¾å†…å®¹å’Œç±»å‹
     * - source å­—æ®µä¿æŒä¸å˜ï¼ˆä¸æ”¹å˜æ ‡ç­¾æ¥æºï¼‰
     * - isConfirmed å­—æ®µä¿æŒä¸å˜
     *
     * @param tag æ›´æ–°åçš„è„‘æ ‡ç­¾
     * @return æ“ä½œç»“æœ
     */
    suspend fun updateTag(tag: BrainTag): Result<Unit>
}
```

**æ–‡ä»¶2ï¼šEditBrainTagUseCase.ktï¼ˆæ–°å¢ï¼‰**

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.model.BrainTag
import com.empathy.ai.domain.model.TagType
import com.empathy.ai.domain.repository.BrainTagRepository
import javax.inject.Inject

/**
 * ç¼–è¾‘è„‘æ ‡ç­¾ç”¨ä¾‹
 *
 * ä¸šåŠ¡è§„åˆ™:
 * - æ”¯æŒä¿®æ”¹æ ‡ç­¾å†…å®¹ï¼ˆcontentï¼‰
 * - æ”¯æŒåˆ‡æ¢æ ‡ç­¾ç±»å‹ï¼ˆRISK_RED â†” STRATEGY_GREENï¼‰
 * - ä¸å…è®¸ä¿®æ”¹æ ‡ç­¾æ¥æºï¼ˆsourceï¼‰
 * - å†…å®¹ä¸èƒ½ä¸ºç©º
 *
 * @see BrainTagRepository
 */
class EditBrainTagUseCase @Inject constructor(
    private val brainTagRepository: BrainTagRepository
) {
    /**
     * æ‰§è¡Œç¼–è¾‘æ“ä½œ
     *
     * @param tagId æ ‡ç­¾ID
     * @param newContent æ–°çš„æ ‡ç­¾å†…å®¹
     * @param newType æ–°çš„æ ‡ç­¾ç±»å‹
     * @return æ“ä½œç»“æœ
     */
    suspend operator fun invoke(
        tagId: Long,
        newContent: String,
        newType: TagType
    ): Result<Unit> {
        // éªŒè¯å†…å®¹ä¸ä¸ºç©º
        if (newContent.isBlank()) {
            return Result.failure(IllegalArgumentException("æ ‡ç­¾å†…å®¹ä¸èƒ½ä¸ºç©º"))
        }
        
        // æ„å»ºæ›´æ–°åçš„æ ‡ç­¾ï¼ˆä¿ç•™åŸæœ‰çš„ source å’Œ isConfirmedï¼‰
        // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å…ˆè·å–åŸæ ‡ç­¾ï¼Œä½†ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬åœ¨ Repository å±‚å¤„ç†
        return brainTagRepository.updateTag(
            BrainTag(
                id = tagId,
                contactId = "", // ç”± Repository å±‚ä»æ•°æ®åº“è·å–
                content = newContent,
                type = newType
            )
        )
    }
}
```

#### 3.2.2 æ•°æ®å±‚ï¼ˆ:dataï¼‰

**æ–‡ä»¶3ï¼šBrainTagDao.kt**

```kotlin
// æ·»åŠ  updateTag æ–¹æ³•
@Dao
interface BrainTagDao {
    // ... ç°æœ‰æ–¹æ³• ...
    
    /**
     * æ›´æ–°æ ‡ç­¾å†…å®¹å’Œç±»å‹
     *
     * åªæ›´æ–° content å’Œ tag_type å­—æ®µï¼Œä¿ç•™å…¶ä»–å­—æ®µä¸å˜
     *
     * @param id æ ‡ç­¾ID
     * @param content æ–°çš„æ ‡ç­¾å†…å®¹
     * @param type æ–°çš„æ ‡ç­¾ç±»å‹
     */
    @Query("UPDATE brain_tags SET content = :content, tag_type = :type WHERE id = :id")
    suspend fun updateTag(id: Long, content: String, type: String)
    
    /**
     * æ ¹æ®IDè·å–æ ‡ç­¾
     *
     * @param id æ ‡ç­¾ID
     * @return æ ‡ç­¾å®ä½“ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å›null
     */
    @Query("SELECT * FROM brain_tags WHERE id = :id")
    suspend fun getTagById(id: Long): BrainTagEntity?
}
```

**æ–‡ä»¶4ï¼šBrainTagRepositoryImpl.kt**

```kotlin
// å®ç° updateTag æ–¹æ³•
override suspend fun updateTag(tag: BrainTag): Result<Unit> {
    return try {
        // éªŒè¯æ ‡ç­¾å­˜åœ¨
        val existingTag = dao.getTagById(tag.id)
            ?: return Result.failure(IllegalArgumentException("æ ‡ç­¾ä¸å­˜åœ¨"))
        
        // æ›´æ–°æ ‡ç­¾ï¼ˆåªæ›´æ–° content å’Œ typeï¼‰
        dao.updateTag(
            id = tag.id,
            content = tag.content,
            type = tag.type.name
        )
        
        Result.success(Unit)
    } catch (e: Exception) {
        Result.failure(e)
    }
}
```

#### 3.2.3 è¡¨ç°å±‚ï¼ˆ:presentationï¼‰

**æ–‡ä»¶5ï¼šContactDetailUiState.kt**

```kotlin
// æ·»åŠ ç¼–è¾‘æ ‡ç­¾ç›¸å…³çŠ¶æ€
data class ContactDetailUiState(
    // ... ç°æœ‰å­—æ®µ ...
    
    // ç¼–è¾‘æ ‡ç­¾çŠ¶æ€
    val showEditBrainTagDialog: Boolean = false,
    val editingBrainTag: BrainTag? = null
)
```

**æ–‡ä»¶6ï¼šContactDetailUiEvent.kt**

```kotlin
// æ·»åŠ ç¼–è¾‘æ ‡ç­¾ç›¸å…³äº‹ä»¶
sealed class ContactDetailUiEvent {
    // ... ç°æœ‰äº‹ä»¶ ...
    
    // æ ‡ç­¾ç¼–è¾‘äº‹ä»¶
    data class StartEditBrainTag(val tag: BrainTag) : ContactDetailUiEvent()
    data class ConfirmEditBrainTag(
        val tagId: Long,
        val newContent: String,
        val newType: TagType
    ) : ContactDetailUiEvent()
    data object CancelEditBrainTag : ContactDetailUiEvent()
}
```

**æ–‡ä»¶7ï¼šContactDetailTabViewModel.kt**

```kotlin
// æ·»åŠ ç¼–è¾‘æ ‡ç­¾ç›¸å…³æ–¹æ³•

// åœ¨æ„é€ å‡½æ•°ä¸­æ³¨å…¥ EditBrainTagUseCase
@HiltViewModel
class ContactDetailTabViewModel @Inject constructor(
    // ... ç°æœ‰ä¾èµ– ...
    private val editBrainTagUseCase: EditBrainTagUseCase
) : ViewModel() {

    // åœ¨ onEvent ä¸­æ·»åŠ äº‹ä»¶å¤„ç†
    fun onEvent(event: ContactDetailUiEvent) {
        // ... ç°æœ‰äº‹ä»¶å¤„ç† ...
        
        else if (event is ContactDetailUiEvent.StartEditBrainTag) {
            startEditBrainTag(event.tag)
        } else if (event is ContactDetailUiEvent.ConfirmEditBrainTag) {
            confirmEditBrainTag(event.tagId, event.newContent, event.newType)
        } else if (event is ContactDetailUiEvent.CancelEditBrainTag) {
            cancelEditBrainTag()
        }
    }
    
    /**
     * å¼€å§‹ç¼–è¾‘æ ‡ç­¾
     */
    private fun startEditBrainTag(tag: BrainTag) {
        _uiState.update {
            it.copy(
                showEditBrainTagDialog = true,
                editingBrainTag = tag
            )
        }
    }
    
    /**
     * ç¡®è®¤ç¼–è¾‘æ ‡ç­¾
     */
    private fun confirmEditBrainTag(tagId: Long, newContent: String, newType: TagType) {
        if (newContent.isBlank()) {
            _uiState.update { it.copy(error = "æ ‡ç­¾å†…å®¹ä¸èƒ½ä¸ºç©º") }
            return
        }
        
        viewModelScope.launch {
            editBrainTagUseCase(tagId, newContent, newType)
                .onSuccess {
                    _uiState.update {
                        it.copy(
                            showEditBrainTagDialog = false,
                            editingBrainTag = null,
                            successMessage = "æ ‡ç­¾å·²æ›´æ–°"
                        )
                    }
                    // åˆ·æ–°æ•°æ®
                    _uiState.value.contact?.id?.let { contactId ->
                        loadBrainTags(contactId)
                    }
                }
                .onFailure { error ->
                    _uiState.update {
                        it.copy(error = error.message ?: "æ›´æ–°æ ‡ç­¾å¤±è´¥")
                    }
                }
        }
    }
    
    /**
     * å–æ¶ˆç¼–è¾‘æ ‡ç­¾
     */
    private fun cancelEditBrainTag() {
        _uiState.update {
            it.copy(
                showEditBrainTagDialog = false,
                editingBrainTag = null
            )
        }
    }
}
```

**æ–‡ä»¶8ï¼šEditBrainTagDialog.ktï¼ˆæ–°å¢ï¼‰**

```kotlin
package com.empathy.ai.presentation.ui.component.dialog

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import com.empathy.ai.domain.model.BrainTag
import com.empathy.ai.domain.model.TagType
import com.empathy.ai.presentation.theme.iOSBlue
import com.empathy.ai.presentation.theme.iOSCardBackground
import com.empathy.ai.presentation.theme.iOSTextPrimary
import com.empathy.ai.presentation.theme.iOSTextSecondary

/**
 * ç¼–è¾‘æ ‡ç­¾å¯¹è¯æ¡†
 *
 * iOS é£æ ¼çš„ç¼–è¾‘å¯¹è¯æ¡†ï¼Œæ”¯æŒï¼š
 * - ä¿®æ”¹æ ‡ç­¾å†…å®¹
 * - åˆ‡æ¢æ ‡ç­¾ç±»å‹ï¼ˆé›·åŒº/ç­–ç•¥ï¼‰
 *
 * @param tag è¦ç¼–è¾‘çš„æ ‡ç­¾
 * @param onConfirm ç¡®è®¤å›è°ƒ
 * @param onDismiss å–æ¶ˆå›è°ƒ
 */
@Composable
fun EditBrainTagDialog(
    tag: BrainTag,
    onConfirm: (Long, String, TagType) -> Unit,
    onDismiss: () -> Unit
) {
    var content by remember { mutableStateOf(tag.content) }
    var selectedType by remember { mutableStateOf(tag.type) }
    var contentError by remember { mutableStateOf<String?>(null) }
    
    AlertDialog(
        onDismissRequest = onDismiss,
        shape = RoundedCornerShape(14.dp),
        containerColor = iOSCardBackground,
        title = {
            Text(
                text = "ç¼–è¾‘æ ‡ç­¾",
                color = iOSTextPrimary
            )
        },
        text = {
            Column(
                modifier = Modifier.fillMaxWidth(),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // æ ‡ç­¾å†…å®¹è¾“å…¥
                OutlinedTextField(
                    value = content,
                    onValueChange = {
                        content = it
                        contentError = if (it.isBlank()) "å†…å®¹ä¸èƒ½ä¸ºç©º" else null
                    },
                    label = { Text("æ ‡ç­¾å†…å®¹") },
                    isError = contentError != null,
                    supportingText = contentError?.let { { Text(it) } },
                    modifier = Modifier.fillMaxWidth(),
                    singleLine = true
                )
                
                // æ ‡ç­¾ç±»å‹é€‰æ‹©
                Text(
                    text = "æ ‡ç­¾ç±»å‹",
                    color = iOSTextSecondary
                )
                
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    // é›·åŒºæ ‡ç­¾
                    FilterChip(
                        selected = selectedType == TagType.RISK_RED,
                        onClick = { selectedType = TagType.RISK_RED },
                        label = { Text("ğŸš« é›·åŒº") },
                        modifier = Modifier.weight(1f)
                    )
                    
                    // ç­–ç•¥æ ‡ç­¾
                    FilterChip(
                        selected = selectedType == TagType.STRATEGY_GREEN,
                        onClick = { selectedType = TagType.STRATEGY_GREEN },
                        label = { Text("âœ… ç­–ç•¥") },
                        modifier = Modifier.weight(1f)
                    )
                }
            }
        },
        confirmButton = {
            TextButton(
                onClick = {
                    if (content.isNotBlank()) {
                        onConfirm(tag.id, content, selectedType)
                    } else {
                        contentError = "å†…å®¹ä¸èƒ½ä¸ºç©º"
                    }
                }
            ) {
                Text("ä¿å­˜", color = iOSBlue)
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("å–æ¶ˆ", color = iOSTextSecondary)
            }
        }
    )
}
```

**æ–‡ä»¶9ï¼šPersonaTab.kt**

```kotlin
// ä¿®æ”¹ onFactClick å›è°ƒï¼Œè§¦å‘ç¼–è¾‘

// åœ¨ PersonaTab ç»„ä»¶ä¸­
PersonaTab(
    // ... å…¶ä»–å‚æ•° ...
    onFactClick = { fact ->
        // å°† Fact è½¬æ¢ä¸º BrainTag å¹¶è§¦å‘ç¼–è¾‘
        // æ³¨æ„ï¼šéœ€è¦ç¡®è®¤ Fact å’Œ BrainTag çš„æ˜ å°„å…³ç³»
        onEvent(ContactDetailUiEvent.StartEditBrainTag(
            BrainTag(
                id = fact.id.toLongOrNull() ?: 0L,
                contactId = contactId,
                content = fact.value,
                type = if (fact.key.contains("é›·åŒº")) TagType.RISK_RED else TagType.STRATEGY_GREEN
            )
        ))
    },
    onFactLongClick = { fact ->
        // é•¿æŒ‰ï¼šåˆ é™¤æ ‡ç­¾ï¼ˆä¿æŒä¸å˜ï¼‰
        onEvent(ContactDetailUiEvent.DeleteFactById(fact.id))
    }
)
```

**æ–‡ä»¶10ï¼šContactDetailTabScreen.kt**

```kotlin
// åœ¨ ContactDetailTabScreen ä¸­æ·»åŠ ç¼–è¾‘å¯¹è¯æ¡†

// ç¼–è¾‘æ ‡ç­¾å¯¹è¯æ¡†
if (uiState.showEditBrainTagDialog && uiState.editingBrainTag != null) {
    EditBrainTagDialog(
        tag = uiState.editingBrainTag,
        onConfirm = { tagId, newContent, newType ->
            onEvent(ContactDetailUiEvent.ConfirmEditBrainTag(tagId, newContent, newType))
        },
        onDismiss = {
            onEvent(ContactDetailUiEvent.CancelEditBrainTag)
        }
    )
}
```

---

## å››ã€æ•°æ®æµè®¾è®¡

### 4.1 ç¼–è¾‘æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»æ ‡ç­¾
    â†“
PersonaTab.onFactClick()
    â†“
ContactDetailUiEvent.StartEditBrainTag(tag)
    â†“
ContactDetailTabViewModel.startEditBrainTag()
    â†“
æ›´æ–° UiState: showEditBrainTagDialog = true, editingBrainTag = tag
    â†“
æ˜¾ç¤º EditBrainTagDialog
    â†“
ç”¨æˆ·ä¿®æ”¹å†…å®¹/ç±»å‹ï¼Œç‚¹å‡»ä¿å­˜
    â†“
ContactDetailUiEvent.ConfirmEditBrainTag(tagId, newContent, newType)
    â†“
ContactDetailTabViewModel.confirmEditBrainTag()
    â†“
EditBrainTagUseCase(tagId, newContent, newType)
    â†“
BrainTagRepository.updateTag()
    â†“
BrainTagDao.updateTag()
    â†“
æ•°æ®åº“æ›´æ–°æˆåŠŸ
    â†“
Flow è‡ªåŠ¨è§¦å‘ UI æ›´æ–°
```

### 4.2 çŠ¶æ€ç®¡ç†

```kotlin
// ç¼–è¾‘å‰
ContactDetailUiState(
    showEditBrainTagDialog = false,
    editingBrainTag = null
)

// ç¼–è¾‘ä¸­
ContactDetailUiState(
    showEditBrainTagDialog = true,
    editingBrainTag = BrainTag(id=1, content="ä¸å–œæ¬¢åƒé¦™èœ", type=RISK_RED)
)

// ç¼–è¾‘å
ContactDetailUiState(
    showEditBrainTagDialog = false,
    editingBrainTag = null,
    successMessage = "æ ‡ç­¾å·²æ›´æ–°"
)
```

---

## äº”ã€è¾¹ç•Œæƒ…å†µå¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|----------|
| ç¼–è¾‘å†…å®¹ä¸ºç©º | æ˜¾ç¤ºé”™è¯¯æç¤º"å†…å®¹ä¸èƒ½ä¸ºç©º"ï¼Œä¸å…è®¸ä¿å­˜ |
| ç¼–è¾‘å†…å®¹æœªå˜åŒ– | å…è®¸ä¿å­˜ï¼Œä¸åšç‰¹æ®Šå¤„ç† |
| ç±»å‹åˆ‡æ¢ | å…è®¸åˆ‡æ¢ï¼ŒUI é¢œè‰²å®æ—¶æ›´æ–° |
| ç”¨æˆ·å–æ¶ˆç¼–è¾‘ | æ¢å¤åŸçŠ¶æ€ï¼Œä¸ä¿å­˜ä»»ä½•ä¿®æ”¹ |
| æ•°æ®åº“æ›´æ–°å¤±è´¥ | æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œä¿ç•™å¯¹è¯æ¡†çŠ¶æ€ |
| æ ‡ç­¾ä¸å­˜åœ¨ï¼ˆå·²è¢«åˆ é™¤ï¼‰ | æ˜¾ç¤ºé”™è¯¯æç¤º"æ ‡ç­¾ä¸å­˜åœ¨" |
| AI æ¨æ–­çš„æ ‡ç­¾ | å…è®¸ç¼–è¾‘ï¼Œsource å­—æ®µä¿æŒä¸å˜ |

---

## å…­ã€æµ‹è¯•ç”¨ä¾‹

### 6.1 åŠŸèƒ½æµ‹è¯•

| æµ‹è¯•ID | æµ‹è¯•åœºæ™¯ | é¢„æœŸç»“æœ |
|--------|----------|----------|
| TC-001 | ç‚¹å‡»æ ‡ç­¾ | å¼¹å‡ºç¼–è¾‘å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºå½“å‰å†…å®¹å’Œç±»å‹ |
| TC-002 | ä¿®æ”¹æ ‡ç­¾å†…å®¹ | è¾“å…¥æ¡†å†…å®¹æ›´æ–° |
| TC-003 | åˆ‡æ¢æ ‡ç­¾ç±»å‹ | ç±»å‹é€‰æ‹©å™¨çŠ¶æ€æ›´æ–° |
| TC-004 | ç‚¹å‡»ä¿å­˜ | å¯¹è¯æ¡†å…³é—­ï¼Œæ ‡ç­¾å†…å®¹æ›´æ–°ï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º |
| TC-005 | ç‚¹å‡»å–æ¶ˆ | å¯¹è¯æ¡†å…³é—­ï¼Œæ ‡ç­¾å†…å®¹ä¸å˜ |
| TC-006 | ä¿å­˜ç©ºå†…å®¹ | æ˜¾ç¤ºé”™è¯¯æç¤º"å†…å®¹ä¸èƒ½ä¸ºç©º" |
| TC-007 | ç±»å‹ä»é›·åŒºæ”¹ä¸ºç­–ç•¥ | æ ‡ç­¾é¢œè‰²ä»çº¢è‰²å˜ä¸ºç»¿è‰² |
| TC-008 | ç±»å‹ä»ç­–ç•¥æ”¹ä¸ºé›·åŒº | æ ‡ç­¾é¢œè‰²ä»ç»¿è‰²å˜ä¸ºçº¢è‰² |

### 6.2 è¾¹ç•Œæµ‹è¯•

| æµ‹è¯•ID | æµ‹è¯•åœºæ™¯ | é¢„æœŸç»“æœ |
|--------|----------|----------|
| TC-009 | ç¼–è¾‘è¶…é•¿å†…å®¹ | æ­£å¸¸ä¿å­˜ï¼ŒUI æ­£ç¡®æ˜¾ç¤º |
| TC-010 | ç¼–è¾‘ç‰¹æ®Šå­—ç¬¦ | æ­£å¸¸ä¿å­˜ï¼Œä¸å´©æºƒ |
| TC-011 | å¿«é€Ÿè¿ç»­ç‚¹å‡»ä¿å­˜ | åªæ‰§è¡Œä¸€æ¬¡ä¿å­˜ |
| TC-012 | ç¼–è¾‘ AI æ¨æ–­çš„æ ‡ç­¾ | æ­£å¸¸ç¼–è¾‘ï¼Œsource ä¿æŒ AI_INFERRED |
| TC-013 | ç¼–è¾‘å·²ç¡®è®¤çš„æ ‡ç­¾ | æ­£å¸¸ç¼–è¾‘ï¼ŒisConfirmed ä¿æŒ true |

---

## ä¸ƒã€é£é™©è¯„ä¼°

| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|------|----------|
| æ•°æ®åº“æ›´æ–°å¤±è´¥ | ä½ | ä½¿ç”¨ Result åŒ…è£…ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º |
| UI çŠ¶æ€ä¸åŒæ­¥ | ä½ | ä½¿ç”¨ Flow å“åº”å¼æ›´æ–° |
| ä¸åˆ é™¤åŠŸèƒ½å†²çª | ä½ | ç‚¹å‡»ç¼–è¾‘ï¼Œé•¿æŒ‰åˆ é™¤ï¼Œäº¤äº’åˆ†ç¦» |
| Fact å’Œ BrainTag æ˜ å°„é—®é¢˜ | ä¸­ | éœ€è¦ç¡®è®¤æ˜ å°„å…³ç³»ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ |

---

## å…«ã€å®ç°è®¡åˆ’

### 8.1 å·¥ä½œé‡ä¼°ç®—

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ |
|------|----------|
| Domain å±‚ä¿®æ”¹ | 0.5 å°æ—¶ |
| Data å±‚ä¿®æ”¹ | 0.5 å°æ—¶ |
| Presentation å±‚ä¿®æ”¹ | 2 å°æ—¶ |
| æµ‹è¯•ç¼–å†™ | 1 å°æ—¶ |
| **æ€»è®¡** | **4 å°æ—¶** |

### 8.2 å®ç°æ­¥éª¤

1. **Step 1**ï¼šä¿®æ”¹ `BrainTagRepository.kt`ï¼Œæ·»åŠ  `updateTag()` æ¥å£
2. **Step 2**ï¼šåˆ›å»º `EditBrainTagUseCase.kt`
3. **Step 3**ï¼šä¿®æ”¹ `BrainTagDao.kt`ï¼Œæ·»åŠ  `updateTag()` å’Œ `getTagById()` æ–¹æ³•
4. **Step 4**ï¼šä¿®æ”¹ `BrainTagRepositoryImpl.kt`ï¼Œå®ç° `updateTag()`
5. **Step 5**ï¼šä¿®æ”¹ `ContactDetailUiState.kt` å’Œ `ContactDetailUiEvent.kt`
6. **Step 6**ï¼šä¿®æ”¹ `ContactDetailTabViewModel.kt`ï¼Œæ·»åŠ ç¼–è¾‘æ–¹æ³•
7. **Step 7**ï¼šåˆ›å»º `EditBrainTagDialog.kt`
8. **Step 8**ï¼šä¿®æ”¹ `PersonaTab.kt` å’Œ `ContactDetailTabScreen.kt`ï¼Œé›†æˆç¼–è¾‘åŠŸèƒ½
9. **Step 9**ï¼šç¼–å†™å•å…ƒæµ‹è¯•
10. **Step 10**ï¼šäººå·¥éªŒæ”¶æµ‹è¯•

---

## ä¹ã€éªŒæ”¶æ ‡å‡†

1. âœ… ç‚¹å‡»æ ‡ç­¾å¼¹å‡ºç¼–è¾‘å¯¹è¯æ¡†
2. âœ… å¯¹è¯æ¡†æ˜¾ç¤ºå½“å‰æ ‡ç­¾å†…å®¹å’Œç±»å‹
3. âœ… å¯ä¿®æ”¹æ ‡ç­¾å†…å®¹
4. âœ… å¯åˆ‡æ¢æ ‡ç­¾ç±»å‹ï¼ˆé›·åŒº â†” ç­–ç•¥ï¼‰
5. âœ… ä¿å­˜å UI å®æ—¶æ›´æ–°
6. âœ… å–æ¶ˆç¼–è¾‘ä¸å½±å“åŸæ•°æ®
7. âœ… ç©ºå†…å®¹éªŒè¯æç¤º
8. âœ… é•¿æŒ‰åˆ é™¤åŠŸèƒ½ä¸å—å½±å“

---

## åã€ç›¸å…³æ–‡æ¡£

- **é—®é¢˜æ–‡æ¡£**ï¼š[BUG-00066-ç”»åƒæ ‡ç­¾ç¼–è¾‘åŠŸèƒ½ç¼ºå¤±.md](./BUG-00066-ç”»åƒæ ‡ç­¾ç¼–è¾‘åŠŸèƒ½ç¼ºå¤±.md)
- **ç›¸å…³PRD**ï¼šPRD-00003-è”ç³»äººç”»åƒè®°å¿†ç³»ç»Ÿéœ€æ±‚
- **ç›¸å…³æ¨¡å—**ï¼šdomainã€dataã€presentation

---

## åä¸€ã€å˜æ›´æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| 2026-01-10 | v1.0 | åˆå§‹ç‰ˆæœ¬ | Kiro |
