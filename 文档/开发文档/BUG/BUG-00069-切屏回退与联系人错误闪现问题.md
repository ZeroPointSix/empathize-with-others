# BUG-00069：切屏回退与联系人错误闪现问题

## 1. 基本信息
- **优先级**: P0（问题1/2/3/6），P1（问题4/5）
- **影响范围**: AI军师入口、AI军师对话返回链路、设置 -> AI配置/提示词编辑返回链路、联系人详情进入、新建联系人、全局切屏体验
- **首次发现**: 2026-01-11
- **状态**: 分析中（待补充复现设备/日志）

## 2. 用户反馈原话（完整保留）
- “点击AI军师界面，它会新建两个页面，一个是共行，一个就是共行的欢迎页面。然后另外一个就是用户的对话历是上一个页面…先看到我们共行的那个logo…又把之前上一次对话渲染出来…导致logo被覆盖…退出要退出两层。”
- “切换的时候整个界面是黑屏的…黑屏时间很长。”
- “联系人界面点击联系人，会短暂显示‘错错了’，然后才进入正常页面。”
- “新建联系人也会突然黑屏一下。”
- “设置里AI配置有供应商配置/提示词配置，两者进入后通过手势（ESC）返回，直接回到联系人主列表。”

## 3. 现象与复现步骤

### 3.1 AI军师入口出现双页面与Logo覆盖
1. 从底部导航进入“AI军师”。
2. 先看到入口Logo/欢迎态。
3. 随后出现上一次对话界面，覆盖入口内容。

**期望**: 进入后只出现一个稳定页面（入口或对话），无“Logo被覆盖”的跳闪。  
**实际**: 入口页面与对话页面叠加呈现，视觉上像“多开一层”。

### 3.2 AI军师返回需退两层
1. 进入“AI军师”。
2. 进入对话页面。
3. 点击系统返回或返回按钮。

**期望**: 一次返回回到上一Tab或上一层。  
**实际**: 需要退两层（对话 -> 入口/欢迎 -> 上一Tab）。

### 3.3 全局切屏黑屏时间长
1. 在底部Tab间切换（联系人/AI军师/设置）。
2. 或在设置/联系人等复杂页面间跳转。

**期望**: 切换流畅，无黑屏或短暂空白。  
**实际**: 切换时出现明显黑屏，持续时间肉眼可感。

### 3.4 联系人点击出现“出错了”闪现
1. 联系人列表点击联系人进入详情。
2. 首次瞬间出现“出错了”提示，随后页面正常显示。

**期望**: 不显示错误提示或闪现。  
**实际**: 错误提示短暂闪现。

### 3.5 新建联系人短暂黑屏
1. 联系人列表点击“新建联系人”。
2. 进入页面前出现短暂黑屏。

**期望**: 无黑屏或空白。  
**实际**: 切入时短暂黑屏。

### 3.6 AI配置/提示词配置返回错误
1. 设置 -> AI配置 -> 供应商配置/提示词配置。
2. 使用系统返回手势（ESC/Back）。

**期望**: 返回设置页。  
**实际**: 直接回到联系人主列表。

## 4. 相关文档
- PRD-00034/TDD-00034/FD-00034：界面切换性能优化与页面缓存方案
- PRD-00002/TDD-00002/FD-00002：设置功能与导航
- PRD-00015/TDD-00015/FD-00015：提示词设置与编辑器
- BUG-00060：界面切换性能问题（闪屏黑屏）
- BUG-00068：AI军师入口与设置回退及非Tab性能覆盖问题

## 5. 初步根因假设（需验证）

### 5.1 AI军师入口双页面/双返回
- `AiAdvisorScreen` 为“入口路由页面”，通过导航副作用再跳转到对话或联系人选择。
- 入口页面被缓存且仍可见，导致“Logo页 + 对话页”视觉叠加。
- 返回栈包含入口页与对话页两层，导致返回需两次。

**相关代码**:
- `app/src/main/java/com/empathy/ai/ui/MainActivity.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorScreen.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NavGraph.kt`

### 5.2 切屏黑屏
- `NonTabNavGraph` 在 Tab 可见时 `alpha=0`，切换时存在空白窗口期。
- 非Tab页面仍使用默认 NavHost 生命周期，重建成本高。
- 复杂页面首次渲染阻塞主线程，导致黑屏时间变长。

**相关代码**:
- `app/src/main/java/com/empathy/ai/ui/MainActivity.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NonTabNavGraph.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/navigation/BottomNavScaffold.kt`

### 5.3 联系人“出错了”闪现
- 进入详情时 `ContactDetailTabViewModel` 先上报 error，再异步加载成功后清除。
- UI对 `error` 即时渲染导致闪现。

**相关代码**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactDetailTabScreen.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/ContactDetailTabViewModel.kt`

### 5.4 AI配置/提示词配置返回错误
- NonTab NavGraph 起点为 `CONTACT_LIST`，Settings Tab 未入栈。
- 系统返回触发 `popBackStack()`，回退到联系人而非设置页。

**相关代码**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NavGraph.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/PromptEditorNavigation.kt`

## 6. 方案对比（Dual Solution Protocol）

### 方案A（保守修复）
- AI军师入口页面保留，但在 Tab 切换时只允许“入口或对话”单层展示。
- 在 AI配置/提示词编辑页拦截系统返回，强制回到设置 Tab。
- 对联系人详情加载流程加“错误延迟展示/清理”策略，避免闪现。
- 对非Tab页面做局部性能优化（预加载/缓存关键页面）。

**优点**: 改动小、风险低、可快速验证。  
**❌ 反驳**: 根因未统一解决，返回逻辑分散且易回归；黑屏问题可能仍存在。

### 方案B（推荐）
- **入口稳定化**: AI军师入口改为“真实内容页”（例如：联系人选择/最近会话列表），避免入口纯导航页。
- **统一返回策略**: 建立“来源Tab恢复机制”，在 NonTab 页面返回时恢复来源Tab（统一在 NavGraph 或 MainActivity 层处理）。
- **统一性能策略**: 非Tab页面引入 `SaveableStateHolder` 或统一缓存机制，避免重建空白。
- **错误提示策略**: 加载期 `error` 不直接触发 UI，改为“请求完成且无数据才显示”。

**优势**: 统一解决入口叠加/返回异常/黑屏/闪现问题。  
**Trade-off**: 实施范围更大，需要回归更多页面与导航路径。

## 7. 影响评估
- 统一返回策略会影响所有非Tab页面的返回逻辑，需要回归设置、AI配置、提示词编辑、用户画像等路径。
- 缓存策略扩展可能提升内存占用，需要控制缓存上限与释放策略。

## 8. 待补充信息（STAR Gate）
- **Situation**: 复现设备型号、系统版本、应用版本号。
- **Action**: 已尝试的排查/操作（如清缓存、重装、切换账号）。
- **Result**: 相关日志（logcat）或录屏时间点。

## 9. 实施记录
1. AI配置页与提示词编辑页增加系统返回手势拦截，统一走页面返回逻辑，避免返回联系人列表。
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/aiconfig/AiConfigScreen.kt`
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/prompt/PromptEditorScreen.kt`
2. AI军师对话页返回统一回到联系人列表，避免入口叠加造成双层返回。
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NavGraph.kt`
3. AI军师会话加载阶段保持加载态，减少Logo空态闪现。
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`
4. 联系人详情错误提示增加加载门控，避免“出错了”短暂闪现。
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactDetailTabScreen.kt`
5. 非Tab导航层增加背景色，减轻切屏黑屏观感。
   - `app/src/main/java/com/empathy/ai/ui/MainActivity.kt`
6. AI军师对话加载完成前不显示空态，避免Logo先展示再被历史对话覆盖。
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`
7. 底部导航栏“AI军师”更名为“心语”。
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/navigation/EmpathyBottomNavigation.kt`
8. 联系人详情首次加载未完成时不显示错误与空态，避免“出错了”闪现。
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/ContactDetailTabViewModel.kt`
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactDetailTabScreen.kt`
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactDetailUiState.kt`
9. 联系人详情返回固定回到联系人Tab，避免回到设置页。
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NavGraph.kt`
10. 联系人列表加载完成前不显示错误卡片，避免“出错了”闪现。
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/ContactListViewModel.kt`
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactListUiState.kt`
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactListScreen.kt`
11. 联系人详情系统返回手势强制走自定义返回逻辑。
   - `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactDetailTabScreen.kt`

## 10. 构建与安装
1. 构建: `./gradlew :app:assembleDebug` ✅
2. APK: `app/build/outputs/apk/debug/app-debug.apk`
3. 安装到 MuMu: `adb -s 192.0.2.1:7555 install -r app-debug.apk` ✅
4. 启动: `adb -s 192.0.2.1:7555 shell am start -n com.empathy.ai/com.empathy.ai.ui.MainActivity` ✅
5. 最近一次构建时间: 2026-01-11 18:35 ✅
6. 最近一次构建时间: 2026-01-11 18:45 ✅
7. 最近一次构建时间: 2026-01-11 18:52 ✅
