# BUG-00071：截图权限持久化与图片理解策略调整

## 文档信息
| 项目 | 内容 |
|------|------|
| 文档编号 | BUG-00071 |
| 问题级别 | P0 |
| 状态 | 进行中 |
| 编写者 | Codex |
| 日期 | 2026-01-14 |
| 关联文档 | PRD-00036、TDD-00036、FD-00036 |

---
## 1. 问题现象
- 点击悬浮窗截图后会跳转到 App 内授权，授权结束停留在 App。
- 回到其他应用再截图，实际截到的是 App 界面而非目标应用。
- 模型图片能力默认判定为不支持，截图附件被本地丢弃，仅发送文字。
- **最新反馈**：修复跳转后，截图不再跳转 App，但截图结果为全黑，仅悬浮窗内容可见。
- **新增诉求**：点击截图缩略图可进入全屏预览，便于确认截图是否正确。

## 2. 复现路径
1. 打开悬浮球并进入任意外部应用。
2. 点击悬浮窗中的截图按钮。
3. 系统弹窗授权后停留在 App。
4. 切回其他应用再次截图，最终捕获到 App 界面。

## 3. 现有证据
- 授权链路通过 `ScreenshotPermissionActivity` 触发，返回后进入 `FloatingWindowService` 继续截图流程。
- `endScreenshotSession()` 结束时释放 `MediaProjection`，导致每次截图都要再次授权。
- `getAttachmentsForSend()` 与 `AiRepositoryImpl.providerSupportsImage()` 进行本地过滤，默认模型不支持图片导致附件被清空。

---
## 4. 根因推导
### 4.1 权限与流程
- 授权 Activity 进入 App 前台，遮罩截图在 App 前台执行，导致截图内容来自 App。
- 截图结束释放 `MediaProjection`，无法复用授权结果。

### 4.2 图片理解策略
- 本地能力开关默认关闭，导致截图附件在发送前被丢弃。

### 4.3 显示屏心跳重绑定
- API 29+ 前台包名获取为空时，心跳检测仍会强制切回默认显示屏。
- 多显示屏/模拟器场景下显示屏被反复切换，MediaProjection 采集到的画面与用户当前屏幕不一致，表现为黑屏。

---
## 5. 解决方案对比
### 方案 A（现状）
- 每次截图触发授权；结束即释放投影。
- 本地判断模型是否支持图片，默认不支持。

### 方案 B（推荐）
- “截图权限”改为单一开关，开启即发起一次授权并持久化；关闭时清空旧授权。
- 截图流程不再释放 `MediaProjection`，服务存活期间不重复弹窗。
- 默认允许附件发送，服务端不支持时返回错误提示用户调整。

**最终推荐：方案 B。**

### 方案 C（黑屏根因补充）
- **目标**：避免复用旧的 MediaProjection 授权导致“仅本应用捕获”。
- **策略**：
  - 截图权限持久化时保存版本号；
  - 版本号不匹配或缺失时清空旧授权，强制重新授权；
  - 设置页用“截图权限”开关控制授权重置。
  - API 29+ 前台包名为空时，禁止心跳检测强制切回默认显示屏。

---
## 6. 影响评估
- **正向影响**：截图不再强制跳转 App；附件不被本地过滤；减少授权频次。
- **潜在风险**：授权数据跨进程恢复失败时需要重新授权。
- **兼容性**：Android 12 / MuMu 模拟器验证优先，其他设备需回归确认。
 - **新风险**：截图结果黑屏，无法获取外部界面内容。

---
## 7. 验收标准
- [ ] 设置页“截图权限”开关可发起一次授权。
- [ ] 关闭“截图权限”开关可清空旧授权。
- [ ] 授权后截图不再跳转 App，能截取外部应用界面。
- [ ] 服务重启尝试恢复授权，失败时自动要求再次授权。
- [ ] 发送截图时不再本地丢弃附件，服务端不支持时返回错误提示。
- [ ] 截图结果不为黑屏。
- [ ] 点击截图缩略图进入全屏预览，支持关闭。

---
## 8. 问题复盘（DeBug 规范）
- **现象**：授权后停留 App 且截图为 App 内容；截图附件被丢弃。
- **根因**：授权与截图流程绑定 App 前台；`MediaProjection` 被释放；本地能力开关默认 false。
- **方案**：一次授权持久化 + 默认允许附件发送。
- **结论**：采用方案 B，待验证。

## 9. 新增问题跟踪（黑屏）
- **现象**：截图不再跳转 App，但截图结果为全黑。
- **初步假设**：
  - MediaProjection 处于“单应用捕获”模式（Android 14+ 授权弹窗可选“仅此应用/整个屏幕”），导致其他应用被系统屏蔽为黑帧。
  - VirtualDisplay 采集时机与 UI 切换存在时序问题，导致持续读到黑帧。
  - 心跳检测在 API 29+ 前台包名为空时强制切回默认显示屏，导致捕获显示屏与当前屏幕不一致。
- **拟验证方向**：
  - 授权弹窗是否提供“仅此应用/整个屏幕”选项；选择“整个屏幕”后是否恢复。
  - 使用 `MediaProjectionConfig.createConfigForDefaultDisplay()` 强制默认显示屏捕获是否可用。
  - 延长截取前等待时间，观察黑屏是否改善。
  - 关闭心跳强制切换后观察黑屏是否改善。

## 10. 调试与日志增强
- “截图权限”开关支持清空旧授权并重新授权，避免复用旧 token。
- 按版本号持久化截图授权，版本变化时自动失效旧授权。
- 截图链路增加日志：屏幕尺寸、选区、VirtualDisplay 创建状态、ImageReader 参数、采样亮度。
