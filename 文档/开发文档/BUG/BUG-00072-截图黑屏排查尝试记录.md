# BUG-00072：截图权限请求与黑框缺失问题修复

## 文档信息
| 项目 | 内容 |
|------|------|
| 文档编号 | BUG-00072 |
| 问题级别 | P0 |
| 状态 | 已完成（待验证） |
| 编写者 | Codex |
| 日期 | 2026-01-16 |
| 关联文档 | BUG-00071、PRD-00036、TDD-00036、FD-00036 |

---
## 1. 问题现象
- 悬浮球点击截图按钮 → 弹出“投屏/录制”授权 → 选择“整个屏幕” → 返回 App。
- 未出现黑色遮罩框，截图流程未进入，无法截图。
- 每次截图都会重复弹出授权，体验不符合预期。

---
## 2. 复现路径
1. 打开 App，确保悬浮窗已启用。
2. 点击悬浮球内“截图”按钮。
3. 授权弹窗选择“整个屏幕”。
4. 返回 App，无黑框、无截图（稳定复现）。

---
## 3. 影响范围
- 悬浮球截图入口无法使用。
- 授权弹窗频繁出现，用户体验受损。

---
## 4. 根因分析
- 授权请求从悬浮窗触发，授权结果无法稳定复用。
- 未缓存 MediaProjection 授权，导致每次点击都要重新授权。
- 设置页缺少统一的截图权限入口。

---
## 5. 修复方案
- 设置页新增“截图权限”开关，统一发起授权。
- 授权结果持久化保存（Parcelable 序列化），用于后续截图复用。
- 悬浮球截图仅在已有授权缓存时进入截图流程；否则提示用户先去设置授权。
- 区分授权来源：设置页授权不直接进入截图流程。

---
## 6. 关键改动
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsScreen.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsUiEvent.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsUiState.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/SettingsViewModel.kt`
- `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt`
- `app/src/main/java/com/empathy/ai/ui/ScreenshotPermissionActivity.kt`
- `data/src/main/kotlin/com/empathy/ai/data/local/FloatingWindowPreferences.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/repository/FloatingWindowPreferencesRepository.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/util/MediaProjectionPermissionConstants.kt`

---
## 7. 测试用例
### 7.1 单元测试
- `presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/SettingsViewModelBug00070Test.kt`
  - 未授权时切换“截图权限”，触发待授权请求标志。
  - 已授权时切换“截图权限”，清除授权并提示成功。

### 7.2 手动验证
1. 设置页打开“截图权限”→ 授权成功 → 返回设置页开关为开启。
2. 点击悬浮球截图 → 出现黑色遮罩框 → 框选后生成截图缩略图。
3. 关闭“截图权限” → 再次截图提示“请先在设置中开启截图权限”。

---
## 8. 验收标准
- [ ] 授权入口仅在设置页触发。
- [ ] 授权成功后，悬浮球截图可进入遮罩框流程。
- [ ] 关闭授权后，悬浮球截图给出明确提示。

---
## 9. 备注
- 当前未执行安装与真机验证，需在设备上确认黑屏是否彻底消除。

