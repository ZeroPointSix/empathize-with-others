# BUG-00072：截图权限请求与黑框缺失问题修复

## 文档信息
| 项目 | 内容 |
|------|------|
| 文档编号 | BUG-00072 |
| 问题级别 | P0 |
| 状态 | 进行中 |
| 编写者 | Codex |
| 日期 | 2026-01-16 |
| 关联文档 | BUG-00071、PRD-00036、TDD-00036、FD-00036 |

---
## 1. 问题现象
- 设置页点击“截图权限” → 选择“整个屏幕” → 提示“已授权”。
- 返回设置页后，截图权限开关仍为关闭状态。
- 悬浮窗点击“截图”无任何反应（无 Toast、无黑色遮罩框、无截图缩略图）。

---
## 2. 复现路径
1. 打开 App，进入设置页。
2. 点击“截图权限”开关并授权（选择“整个屏幕”）。
3. 返回设置页，开关仍为关闭。
4. 打开悬浮窗 → 点击“截图” → 无响应（稳定复现）。

---
## 3. 影响范围
- 截图权限无法正确保存与展示。
- 悬浮窗截图入口不可用。

---
## 4. 根因分析
- MediaProjection 授权 Intent 内含 Binder/FD，`Parcel.marshall()` 序列化失败，导致无法落盘（`floating_window_prefs.xml` 无授权相关字段）。
- 设置页虽然完成授权，但授权数据仅存在内存缓存，重启/失效后 `hasScreenshotPermission` 仍为 `false`。
- 悬浮窗尝试通过缓存恢复 MediaProjection 时，`getMediaProjection` 返回 `null`，截图流程无法进入遮罩框。

### 4.1 日志证据（OPPO 真机）
```
ScreenshotPermission: 截图权限返回 resultCode=-1, data=true, source=settings
FloatingWindowPrefs: MediaProjection 授权数据序列化异常: Tried to marshall a Parcel that contains objects (binders or FDs).
FloatingWindowService: restoreMediaProjectionFromCache: hit=true
FloatingWindowService: restoreMediaProjectionFromCache: projection=null
FloatingWindowService: 截图权限缺失，无法进入截图流程
```

---
## 5. 修复方案
- 授权结果改为进程内缓存为主，避免序列化含 Binder/FD 的 Intent。
- 截图前优先使用进程缓存恢复 MediaProjection；必要时调整前台服务类型后再尝试 `getMediaProjection`。
- 若恢复失败，清理权限缓存并提示用户重新授权。
- 保留关键日志，确保可追溯授权与恢复链路。

---
## 6. 关键改动
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsScreen.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsUiEvent.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsUiState.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/SettingsViewModel.kt`
- `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt`
- `app/src/main/java/com/empathy/ai/ui/ScreenshotPermissionActivity.kt`
- `data/src/main/kotlin/com/empathy/ai/data/local/FloatingWindowPreferences.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/repository/FloatingWindowPreferencesRepository.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/util/MediaProjectionPermissionConstants.kt`

---
## 7. 测试用例
### 7.1 单元测试
- `presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/SettingsViewModelBug00070Test.kt`
  - 未授权时切换“截图权限”，触发待授权请求标志。
  - 已授权时切换“截图权限”，清除授权并提示成功。

### 7.2 手动验证
1. 设置页打开“截图权限”→ 授权成功 → 返回设置页开关为开启。
2. 点击悬浮球截图 → 出现黑色遮罩框 → 框选后生成截图缩略图。
3. 关闭“截图权限” → 悬浮窗截图提示重新授权。

---
## 8. 验收标准
- [ ] 授权入口仅在设置页触发。
- [ ] 授权成功后，设置页开关立即刷新为开启。
- [ ] 悬浮窗截图进入遮罩框流程并可生成缩略图。
- [ ] 关闭/失效后，悬浮窗截图给出明确提示。

---
## 9. 备注
- 授权结果无法序列化问题已在 OPPO 真机确认，需修复后复测。

