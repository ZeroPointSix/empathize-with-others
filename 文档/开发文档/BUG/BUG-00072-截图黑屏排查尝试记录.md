# BUG-00072：截图黑屏排查尝试记录

## 文档信息
| 项目 | 内容 |
|------|------|
| 文档编号 | BUG-00072 |
| 问题级别 | P0 |
| 状态 | 未修复 |
| 编写者 | Codex |
| 日期 | 2026-01-14 |
| 关联文档 | BUG-00071、PRD-00036、TDD-00036、FD-00036 |

---
## 1. 问题概述
- 截图不再强制跳转 App，但外部应用画面为黑屏，仅悬浮窗内容可见。
- MuMu 模拟器中稳定复现；截图文件可落盘但画面为黑。

---
## 2. 复现环境
- 设备：MuMu 模拟器
- 现象：全屏截图或框选截图均为黑屏

---
## 3. 已尝试方向与结果
1. **图片能力策略调整**
   - 默认允许附件发送，服务端不支持再提示用户。
   - 结论：附件不再被本地丢弃，但黑屏仍存在。
2. **截图权限持久化**
   - MediaProjection 授权持久化，服务重启尝试恢复。
   - 引入版本号校验，版本变化或缺失时自动失效旧授权。
   - 结论：授权流程稳定，仍为黑屏。
3. **授权入口调整**
   - 设置页“截图权限”改为单一开关：开启发起授权，关闭清空旧授权。
   - 结论：体验符合预期，但黑屏未解决。
4. **默认显示屏授权**
   - Android 14+ 使用 `MediaProjectionConfig.createConfigForDefaultDisplay()`。
   - 结论：在 MuMu 上无明显改善。
5. **全屏预览能力**
   - 添加截图缩略图点击进入全屏预览。
   - 结论：预览恢复可用，但内容仍为黑。
6. **多显示屏重绑定**
   - 修复心跳检测在 API 29+ 前台包名为空时强制切回默认显示屏。
   - 结论：避免 display 被反复切换，黑屏仍未消除（待进一步验证）。
7. **日志增强**
   - 记录 VirtualDisplay、ImageReader stride、采样亮度等。
   - 结论：采样亮度 `avg=0`，说明帧为黑而非裁剪或写入问题。

---
## 4. 关键证据
- 日志显示 VirtualDisplay 创建成功、截图文件生成成功，但采样亮度为 0：
  - `ScreenshotCapture: bitmap sample luma(scaled) avg=0`

---
## 5. 当前结论
- 黑屏更可能来自系统层的捕获限制或 display 绑定不一致。
- 现阶段所有流程类改动未能从根因修复黑屏。

---
## 6. 后续建议方向
- 授权弹窗确认选择“整个屏幕”而非“仅此应用”。
- 在真机上复现对比（模拟器可能限制 MediaProjection 外部捕获）。
- 继续观察 display 绑定与权限状态是否与黑屏相关。

