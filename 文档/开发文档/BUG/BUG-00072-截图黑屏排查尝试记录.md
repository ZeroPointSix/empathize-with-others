# BUG-00072：截图权限请求与黑框缺失问题修复

## 文档信息
| 项目 | 内容 |
|------|------|
| 文档编号 | BUG-00072 |
| 问题级别 | P0 |
| 状态 | 进行中 |
| 编写者 | Codex |
| 日期 | 2026-01-16 |
| 关联文档 | BUG-00071、PRD-00036、TDD-00036、FD-00036 |

---
## 1. 问题现象
- 设置页点击“截图权限” → 选择“整个屏幕” → 提示“已授权”。
- 返回设置页后，截图权限开关仍为关闭状态。
- 悬浮窗点击“截图”无任何反应（无 Toast、无黑色遮罩框、无截图缩略图）。

---
## 2. 复现路径
1. 打开 App，进入设置页。
2. 点击“截图权限”开关并授权（选择“整个屏幕”）。
3. 返回设置页，开关仍为关闭。
4. 打开悬浮窗 → 点击“截图” → 无响应（稳定复现）。

---
## 3. 影响范围
- 截图权限无法正确保存与展示。
- 悬浮窗截图入口不可用。

---
## 4. 根因分析
- MediaProjection 授权 Intent 内含 Binder/FD，`Parcel.marshall()` 序列化失败，导致无法落盘（`floating_window_prefs.xml` 无授权相关字段）。
- 设置页虽然完成授权，但授权数据仅存在内存缓存，重启/失效后 `hasScreenshotPermission` 仍为 `false`。
- 悬浮窗尝试通过缓存恢复 MediaProjection 时，`getMediaProjection` 返回 `null`，截图流程无法进入遮罩框。
- 在 `ScreenshotPermissionActivity` 内直接调用 `getMediaProjection` 会触发 `SecurityException`，因为当前没有 `FOREGROUND_SERVICE_TYPE_MEDIA_PROJECTION` 前台服务。

### 4.1 日志证据（OPPO 真机）
```
ScreenshotPermission: 截图权限返回 resultCode=-1, data=true, source=settings
FloatingWindowPrefs: MediaProjection 授权数据序列化异常: Tried to marshall a Parcel that contains objects (binders or FDs).
FloatingWindowService: restoreMediaProjectionFromCache: hit=true
FloatingWindowService: restoreMediaProjectionFromCache: projection=null
FloatingWindowService: 截图权限缺失，无法进入截图流程
AndroidRuntime: java.lang.SecurityException: Media projections require a foreground service of type ServiceInfo.FOREGROUND_SERVICE_TYPE_MEDIA_PROJECTION
```

---
## 5. 修复方案
- 授权结果改为进程内缓存为主，避免序列化含 Binder/FD 的 Intent。
- 授权回调不再调用 `getMediaProjection`，仅把权限结果回传给悬浮窗服务。
- 悬浮窗服务在切换前台服务类型（包含 `mediaProjection`）后再调用 `getMediaProjection`。
- 若恢复失败，清理权限缓存并提示用户重新授权。
- 保留关键日志，确保可追溯授权与恢复链路。

---
## 6. 关键改动
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsScreen.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsUiEvent.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsUiState.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/SettingsViewModel.kt`
- `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt`
- `app/src/main/java/com/empathy/ai/ui/ScreenshotPermissionActivity.kt`
- `data/src/main/kotlin/com/empathy/ai/data/local/FloatingWindowPreferences.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/repository/FloatingWindowPreferencesRepository.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/util/MediaProjectionPermissionConstants.kt`

---
## 7. 测试用例
### 7.1 单元测试
- `presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/SettingsViewModelBug00070Test.kt`
  - 未授权时切换“截图权限”，触发待授权请求标志。
  - 已授权时切换“截图权限”，清除授权并提示成功。

### 7.2 手动验证
1. 设置页打开“截图权限”→ 授权成功 → 返回设置页开关为开启。
2. 点击悬浮球截图 → 出现黑色遮罩框 → 框选后生成截图缩略图。
3. 关闭“截图权限” → 悬浮窗截图提示重新授权。

---
## 8. 验收标准
- [ ] 授权入口仅在设置页触发。
- [ ] 授权成功后，设置页开关立即刷新为开启。
- [ ] 悬浮窗截图进入遮罩框流程并可生成缩略图。
- [ ] 关闭/失效后，悬浮窗截图给出明确提示。

---
## 9. 2026-01-17 修复：移除 supportsImage 判断

### 9.1 问题现象
- 用户发送带截图的请求时，提示"当前模型不支持图片理解，已仅发送文字内容"
- 即使用户选择了支持图片的模型，图片也不会被发送

### 9.2 根因分析
- `FloatingWindowService.kt` 的 `getAttachmentsForSend()` 函数检查 `supportsImage` 属性
- `AiRepositoryImpl.kt` 的 `buildUserMessage()` 函数也检查 `supportsImage` 属性
- 当模型的 `supportsImage` 为 `false` 时，图片附件被过滤掉

### 9.3 修复方案
移除 `supportsImage` 判断，让用户自己选择模型。如果模型不支持图片，由服务端返回错误。

### 9.4 关键改动

**FloatingWindowService.kt (第 2717-2722 行)**
```kotlin
// 修改前
private suspend fun getAttachmentsForSend(): List<ScreenshotAttachment> {
    if (screenshotAttachments.isEmpty()) return emptyList()
    val provider = aiProviderRepository.getDefaultProvider().getOrNull()
    val supportsImage = provider?.getDefaultModel()?.supportsImage == true
    if (!supportsImage) {
        android.widget.Toast.makeText(
            this,
            "当前模型不支持图片理解，已仅发送文字内容",
            android.widget.Toast.LENGTH_SHORT
        ).show()
        return emptyList()
    }
    return screenshotAttachments.toList()
}

// 修改后
private suspend fun getAttachmentsForSend(): List<ScreenshotAttachment> {
    if (screenshotAttachments.isEmpty()) return emptyList()
    // 移除 supportsImage 判断，让用户自己选择模型
    // 如果模型不支持图片，由服务端返回错误
    return screenshotAttachments.toList()
}
```

**AiRepositoryImpl.kt (第 922-927 行)**
```kotlin
// 修改前
if (attachments.isEmpty() || !supportsImage) {
    Log.d("AiRepositoryImpl", "buildUserMessage: 使用纯文本消息 (attachments.isEmpty=${attachments.isEmpty()}, supportsImage=$supportsImage)")
    return MessageDto.text(role = "user", content = prompt)
}

// 修改后
if (attachments.isEmpty()) {
    Log.d("AiRepositoryImpl", "buildUserMessage: 使用纯文本消息 (无附件)")
    return MessageDto.text(role = "user", content = prompt)
}
```

### 9.5 验证结果
日志显示图片成功发送：
```
23:59:31.505 buildUserMessage: attachments=1, supportsImage=false
23:59:31.506 buildUserMessage: 添加图片附件 .../shot_xxx.jpg, base64长度=79635
23:59:31.506 buildUserMessage: 使用多模态消息，共 2 个部分
```

---
## 10. 备注
- 授权结果无法序列化问题已在 OPPO 真机确认，需修复后复测。
- 2026-01-17：移除 supportsImage 判断，允许用户自由选择模型发送图片。

