# BUG-00073: 截图权限重启后失效问题分析

## 问题描述

**用户反馈**: 即使在设置界面开启了截图权限,但每次应用重启后,截图时还是会自动请求权限。

**复现步骤**:
1. 在设置界面打开"截图权限"开关
2. 系统弹出MediaProjection授权对话框,用户授权
3. 截图功能正常工作
4. 重启应用
5. 尝试截图时,需要重新授权

## 根本原因分析

### 技术限制

根据代码分析和Android系统限制,发现以下关键问题:

1. **Intent对象无法序列化**
   - MediaProjection权限通过Intent对象传递
   - Intent包含Binder/FileDescriptor对象
   - 这些对象无法跨进程边界序列化到SharedPreferences
   - 序列化尝试会抛出异常: `Tried to marshall a Parcel that contains objects (binders or FDs)`

2. **仅内存缓存**
   - 代码位置: `data/src/main/kotlin/com/empathy/ai/data/local/FloatingWindowPreferences.kt:284-292`
   ```kotlin
   fun saveMediaProjectionPermission(resultCode: Int, data: Intent?) {
       if (resultCode != Activity.RESULT_OK || data == null) {
           clearMediaProjectionPermissionInternal()
           return
       }
       mediaProjectionPermissionCache = MediaProjectionPermission(resultCode, data)
       clearMediaProjectionPermissionPersisted()  // 显式清除持久化存储
       android.util.Log.d(TAG, "MediaProjection 授权已缓存（仅内存）")
   }
   ```

3. **内存缓存变量**
   - 代码位置: `FloatingWindowPreferences.kt:346-347`
   ```kotlin
   @Volatile
   private var mediaProjectionPermissionCache: MediaProjectionPermission? = null
   ```
   - 使用`@Volatile`保证多线程可见性
   - 但存储介质仅为进程内存
   - 应用重启后缓存丢失

4. **Android 14+ 额外限制**
   - 代码位置: `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt:2491-2497`
   ```kotlin
   private fun restoreMediaProjectionFromCache(): Boolean {
       // Android 14+ (API 34+) 的 MediaProjection token 只能使用一次
       // 不能从缓存恢复，必须每次重新请求权限
       if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.UPSIDE_DOWN_CAKE) {
           return false
       }
       // ...
   }
   ```

### 代码证据

**持久化常量已定义但未使用**:
```kotlin
// FloatingWindowPreferences.kt:336-338
private const val KEY_MEDIA_PROJECTION_RESULT_CODE = "media_projection_result_code"
private const val KEY_MEDIA_PROJECTION_RESULT_DATA = "media_projection_result_data"
private const val KEY_MEDIA_PROJECTION_DATA_VERSION = "media_projection_data_version"
```

**清除持久化函数**:
```kotlin
// FloatingWindowPreferences.kt:307-313
private fun clearMediaProjectionPermissionPersisted() {
    prefs.edit {
        remove(KEY_MEDIA_PROJECTION_RESULT_CODE)
        remove(KEY_MEDIA_PROJECTION_RESULT_DATA)
        remove(KEY_MEDIA_PROJECTION_DATA_VERSION)
    }
}
```

这说明代码曾尝试持久化,但由于序列化失败,最终改为仅内存缓存。

## 已实施的修复

### 修复1: 保持MediaProjection前台服务类型持续开启

**修改文件**: `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt:2681-2689`

**修改内容**:
```kotlin
private fun endScreenshotSession() {
    cancelScreenshotTimeout()
    hideScreenshotOverlay()
    restoreFloatingViewAfterScreenshot()
    // 不再释放 mediaProjection，允许用户多次截图而不需要重新请求权限
    // releaseMediaProjection() 只在服务销毁时调用
    // BUG-00072: 保持 MediaProjection 前台服务类型开启，避免后续截图失败
    // updateForegroundServiceType(includeMediaProjection = false)
}
```

**效果**:
- MediaProjection前台服务类型在截图会话期间保持开启
- 避免MediaProjection对象失效
- 减少重试机制的触发频率

## 技术限制说明

### 为什么无法持久化MediaProjection权限?

1. **系统安全机制**
   - MediaProjection权限包含系统级Binder对象
   - Binder对象是进程间通信(IPC)的句柄
   - 无法跨进程边界或应用重启后恢复

2. **Intent序列化限制**
   - `Intent.toUri()`只能序列化基本信息(action, data, extras)
   - 无法序列化Parcelable对象(如MediaProjection的token)
   - 这是Android系统的设计限制,无法绕过

3. **Android 14+的额外限制**
   - MediaProjection token只能使用一次
   - 即使内存缓存也不支持恢复
   - 必须每次重新请求权限

## 用户体验优化建议

### 当前状态
- 应用重启后,MediaProjection权限丢失
- 用户需要重新授权
- 设置界面的"截图权限"开关会自动更新为关闭状态

### 优化方案

1. **减少应用重启频率**
   - 保持应用在后台运行
   - 避免被系统杀死

2. **优化权限请求流程**
   - 简化授权步骤
   - 提供清晰的授权指引

3. **用户说明**
   - 在设置界面添加说明文字
   - 告知用户这是Android系统限制
   - 说明应用重启后需要重新授权

## 相关文档

- BUG-00072: 截图黑屏排查尝试记录
- Explore Agent分析报告: MediaProjection权限持久化分析

## 结论

MediaProjection权限无法持久化是Android系统的技术限制,不是代码bug。已实施的修复(保持MediaProjection前台服务类型持续开启)可以减少权限失效的频率,但无法完全解决应用重启后需要重新授权的问题。

建议在用户界面添加说明,告知用户这是系统限制,并优化权限请求流程以提升用户体验。

---

**创建时间**: 2026-01-17 11:56:00
**创建者**: Claude
**状态**: 已分析,待用户确认解决方案
