# BUG-00074 截图预览功能无法显示问题分析

**创建时间**: 2026-01-17 13:37:00
**分析者**: Claude
**关联PRD**: PRD-00036-截图预览功能
**状态**: 分析完成，待修复

---

## 问题描述

### 现象
用户点击悬浮窗中的截图缩略图后，预览对话框没有显示。

### 日志分析
```
01-17 13:25:40.908  3920  3920 D FloatingWindowService: 显示截图预览: /data/user/0/com.empathy.ai/cache/screenshots/shot_1768627536910_4d3d9685-1e1f-416a-ad77-8201283bec13.jpg
01-17 13:25:41.441  3920  3920 D FloatingWindowService: 显示截图预览: /data/user/0/com.empathy.ai/cache/screenshots/shot_1768627536910_4d3d9685-1e1f-416a-ad77-8201283bec13.jpg
```

**关键发现**：
- `showScreenshotPreview()`方法被正常调用
- 但没有看到`ImagePreviewDialog`的日志（如"开始加载图片"、"图片加载成功"）
- 说明Dialog在`show()`时就失败了，没有执行到`onCreate()`

---

## 根本原因分析

### 1. Dialog在Service中显示的限制

**问题核心**：`ImagePreviewDialog`继承自`Dialog`，使用Service context，但Dialog在Service中显示存在以下问题：

1. **Window Token问题**
   - Dialog需要一个有效的Window token才能显示
   - Service context可能没有提供有效的Window token
   - 即使设置了`TYPE_APPLICATION_OVERLAY`，Dialog.show()可能因为缺少Window token而静默失败

2. **Android系统限制**
   - Android系统对从Service显示Dialog有严格限制
   - Dialog设计上是为Activity设计的，不是为Service设计的

### 2. 项目中的实践对比

通过代码探索发现，项目中**所有**从Service成功显示的UI组件都使用`WindowManager`方式：

| 组件 | 实现方式 | 状态 |
|------|----------|------|
| RefinementOverlay | WindowManager.addView() | ✅ 成功 |
| FloatingViewV2 | WindowManager.addView() | ✅ 成功 |
| FloatingBubbleView | WindowManager.addView() | ✅ 成功 |
| ImagePreviewDialog | Dialog.show() | ❌ 失败 |

**结论**：ImagePreviewDialog是项目中唯一一个尝试使用Dialog方式的组件，也是唯一失败的组件。

### 3. RefinementOverlay的成功案例

`RefinementOverlay`是一个全屏覆盖层，与`ImagePreviewDialog`的需求完全一致：
- 全屏显示
- 半透明背景
- 点击外部关闭
- 从Service显示

**RefinementOverlay的实现方式**：
```kotlin
// 创建自定义View
class RefinementOverlay(context: Context, windowManager: WindowManager) : FrameLayout(context) {

    fun show() {
        val params = WindowManager.LayoutParams(
            WindowManager.LayoutParams.MATCH_PARENT,
            WindowManager.LayoutParams.MATCH_PARENT,
            WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
            WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL or
                WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH,
            PixelFormat.TRANSLUCENT
        )
        windowManager.addView(this, params)
    }

    fun dismiss() {
        windowManager.removeView(this)
    }
}
```

这种方式已经在项目中验证可行。

---

## 解决方案

### 方案对比

#### 方案A：继续使用Dialog，尝试修复Window token问题
- **优点**：代码改动小
- **缺点**：
  - Dialog在Service中显示本身就不可靠
  - 可能有其他未知问题
  - 没有项目中的成功案例可参考

#### 方案B：改用WindowManager方式（推荐）
- **优点**：
  - 与项目中其他组件一致
  - 已验证可行（RefinementOverlay、FloatingViewV2等）
  - Android官方推荐的在Service中显示UI的方式
- **缺点**：
  - 需要重写ImagePreviewDialog

### 推荐方案：方案B

**理由**：
1. 项目中所有成功的UI组件都使用WindowManager方式
2. RefinementOverlay已经证明这种方式可行
3. 更符合Android最佳实践

---

## 实施计划

### 1. 重构ImagePreviewDialog

**从**：
```kotlin
class ImagePreviewDialog(context: Context, imagePath: String) : Dialog(...)
```

**改为**：
```kotlin
class ImagePreviewView(
    context: Context,
    private val windowManager: WindowManager,
    private val imagePath: String
) : FrameLayout(context)
```

### 2. 实现show()和dismiss()方法

```kotlin
fun show() {
    val params = WindowManager.LayoutParams(
        WindowManager.LayoutParams.MATCH_PARENT,
        WindowManager.LayoutParams.MATCH_PARENT,
        WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
        WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL or
            WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH,
        PixelFormat.TRANSLUCENT
    ).apply {
        gravity = Gravity.CENTER
    }
    windowManager.addView(this, params)
    loadPreviewImage()
}

fun dismiss() {
    windowManager.removeView(this)
}
```

### 3. 修改FloatingWindowService调用方式

**从**：
```kotlin
private fun showScreenshotPreview(imagePath: String) {
    val dialog = ImagePreviewDialog(this, imagePath)
    dialog.show()
}
```

**改为**：
```kotlin
private var imagePreviewView: ImagePreviewView? = null

private fun showScreenshotPreview(imagePath: String) {
    imagePreviewView?.let { windowManager.removeView(it) }
    imagePreviewView = ImagePreviewView(this, windowManager, imagePath)
    imagePreviewView?.show()
}
```

### 4. 生命周期管理

在`FloatingWindowService.onDestroy()`中清理：
```kotlin
override fun onDestroy() {
    imagePreviewView?.let {
        try {
            windowManager.removeView(it)
        } catch (e: Exception) {
            // View可能已经被移除
        }
    }
    imagePreviewView = null
    super.onDestroy()
}
```

---

## 技术细节

### WindowManager.LayoutParams配置

| 参数 | 值 | 说明 |
|------|-----|------|
| width | MATCH_PARENT | 全屏宽度 |
| height | MATCH_PARENT | 全屏高度 |
| type | TYPE_APPLICATION_OVERLAY | 允许从Service显示 |
| flags | FLAG_NOT_TOUCH_MODAL \| FLAG_WATCH_OUTSIDE_TOUCH | 允许点击外部关闭 |
| format | PixelFormat.TRANSLUCENT | 支持半透明 |
| gravity | CENTER | 居中显示 |

### 权限要求

已在AndroidManifest.xml中声明：
```xml
<uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
```

---

## 预期效果

修复后：
1. 用户点击截图缩略图
2. 立即显示全屏预览对话框
3. 图片加载完成后显示
4. 点击外部区域关闭预览
5. 日志显示完整的加载过程

---

## 风险评估

### 低风险
- WindowManager方式已在项目中多次验证
- 参考RefinementOverlay的成熟实现
- 不影响其他功能

### 需要注意
- 确保在Service销毁时清理View
- 处理快速点击导致的多个预览View

---

## 参考文件

| 文件 | 路径 |
|------|------|
| ImagePreviewDialog | `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/dialog/ImagePreviewDialog.kt` |
| RefinementOverlay | `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/floating/RefinementOverlay.kt` |
| FloatingWindowService | `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt` |
| FloatingViewV2 | `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/floating/FloatingViewV2.kt` |

---

## 变更记录

### 2026-01-17 13:37:00 - Claude
- 创建问题分析文档
- 完成根本原因分析
- 提出解决方案
- 制定实施计划
