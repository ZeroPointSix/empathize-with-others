# BUG-00075 截图完成后跳出权限请求问题分析

**创建时间**: 2026-01-17 14:42:00
**分析者**: Claude
**测试设备**: OPPO PJV110 (真机)
**状态**: 分析完成，待验证

---

## 问题描述

### 现象
用户在OPPO真机上测试截图功能时，截图完成后系统突然跳出权限请求提示，要求重新授权MediaProjection权限。

### 测试环境
- **设备**: OPPO PJV110 (设备ID: QCUKF6DUW46XKVU8)
- **测试场景**: 真机测试
- **问题触发**: 截图完成后

---

## 深度分析

### 1. 代码流程分析

#### 截图权限的生命周期

**权限请求** (`FloatingWindowService.kt:2485-2530`):
```kotlin
private fun requestMediaProjectionPermission() {
    // 启动 ScreenshotPermissionActivity 触发系统授权对话框
    val intent = Intent(this, ScreenshotPermissionActivity::class.java)
    startActivity(intent)
}
```

**权限保存** (`FloatingWindowService.kt:2538-2543`):
```kotlin
private fun handleMediaProjectionResult(intent: Intent) {
    // 保存到缓存
    floatingWindowPreferences.saveMediaProjectionPermission(resultCode, data)
    // 获取 MediaProjection 实例
    mediaProjection = mediaProjectionManager?.getMediaProjection(resultCode, data)
}
```

**截图执行** (`FloatingWindowService.kt:2631-2696`):
```kotlin
private fun captureSelection(rect: Rect) {
    val projection = mediaProjection
    if (projection == null) {
        endScreenshotSession()
        return
    }

    val attachment = try {
        helper.captureRegion(projection, rect)  // 执行截图
    } catch (e: SecurityException) {
        // 关键：如果抛出SecurityException，清理权限并重新请求
        floatingWindowPreferences.clearScreenshotPermission()
        requestMediaProjectionPermission()
        return
    }

    // 截图完成后的处理
    if (floatingWindowPreferences.isContinuousScreenshotEnabled()) {
        showScreenshotOverlay()
    } else {
        endScreenshotSession()
    }
}
```

**截图完成后的清理** (`FloatingWindowService.kt:2728-2736`):
```kotlin
private fun endScreenshotSession() {
    cancelScreenshotTimeout()
    hideScreenshotOverlay()
    // 关键：已注释掉releaseMediaProjection()，理论上应该保持MediaProjection活跃
    // releaseMediaProjection() 只在服务销毁时调用
    // BUG-00072: 保持 MediaProjection 前台服务类型开启，避免后续截图失败
}
```

#### ScreenshotCaptureHelper的实现

**截图核心逻辑** (`ScreenshotCaptureHelper.kt:45-157`):
```kotlin
suspend fun captureRegion(
    mediaProjection: MediaProjection,
    region: Rect
): ScreenshotAttachment? = withContext(Dispatchers.IO) {
    val imageReader = ImageReader.newInstance(...)
    var virtualDisplay: VirtualDisplay? = null

    try {
        // Android 14+ 注册回调监听MediaProjection停止事件
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.UPSIDE_DOWN_CAKE) {
            projectionCallback = object : MediaProjection.Callback() {
                override fun onStop() {
                    Log.d("ScreenshotCapture", "MediaProjection stopped")
                }
            }
            mediaProjection.registerCallback(projectionCallback, Handler(Looper.getMainLooper()))
        }

        // 创建VirtualDisplay
        virtualDisplay = mediaProjection.createVirtualDisplay(...)

        // 截取并保存图片
        val bitmap = acquireLatestBitmap(imageReader, ...)
        val attachment = saveToCache(scaled)
        return@withContext attachment
    } finally {
        // 关键：释放VirtualDisplay，但不释放MediaProjection
        virtualDisplay?.release()
        imageReader.close()

        // Android 14+ 取消注册回调
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.UPSIDE_DOWN_CAKE && projectionCallback != null) {
            mediaProjection.unregisterCallback(projectionCallback)
        }
    }
}
```

### 2. 问题根本原因分析

#### 原因1：Android 14+的MediaProjection单次使用限制（最可能）

**Android 14 (API 34) 的重要变化**：
1. **单次使用限制**：MediaProjection token在使用后可能自动失效
2. **用户同意要求**：每次使用MediaProjection都需要用户明确同意
3. **自动停止机制**：系统在某些情况下会自动停止MediaProjection

**触发场景**：
1. 用户首次请求截图权限，获得MediaProjection
2. 用户进行第一次截图，成功
3. 截图完成后，`ScreenshotCaptureHelper`释放了VirtualDisplay
4. **Android 14+系统检测到VirtualDisplay被释放，认为MediaProjection不再需要，自动停止MediaProjection**
5. 用户尝试第二次截图时，MediaProjection已经失效
6. `captureSelection()`捕获到SecurityException，清理权限缓存并重新请求权限
7. 用户看到权限请求提示

**代码证据**：
- `restoreMediaProjectionFromCache()`在Android 14+直接返回false（`FloatingWindowService.kt:2538-2543`）
- 注释说明："Android 14+ 不支持从缓存恢复"
- `ScreenshotCaptureHelper`在Android 14+注册了`MediaProjection.Callback`来监听停止事件

#### 原因2：OPPO系统的权限管理（次要可能）

**OPPO ColorOS的特点**：
- OPPO的ColorOS可能有自己的权限管理机制
- 可能在截图后自动回收MediaProjection权限
- 这是厂商定制系统的常见行为

**需要验证**：
- 检查OPPO设备的Android版本
- 查看是否有ColorOS特有的权限管理日志

#### 原因3：前台服务类型变化（已排除）

从代码看，`updateForegroundServiceType(includeMediaProjection = false)`已经被注释掉（`FloatingWindowService.kt:2681-2689`），所以这个原因已经被排除。

### 3. 问题触发条件

**必要条件**：
1. Android 14+ 系统（API 34+）
2. 进行截图操作
3. 截图完成后释放VirtualDisplay

**可选条件**：
1. OPPO设备（可能有额外的权限管理）
2. 非连续截图模式（调用`endScreenshotSession()`）

### 4. 验证方法

#### 方法1：检查Android版本
```bash
adb -s QCUKF6DUW46XKVU8 shell getprop ro.build.version.sdk
```

如果返回34或更高，说明是Android 14+。

#### 方法2：查看logcat日志
```bash
adb -s QCUKF6DUW46XKVU8 logcat | grep -E "MediaProjection|SecurityException|ScreenshotCapture"
```

关键日志：
- `MediaProjection stopped` - 说明MediaProjection被系统停止
- `SecurityException` - 说明权限失效
- `开始加载图片` - 说明截图成功

#### 方法3：检查MediaProjection.Callback
在`ScreenshotCaptureHelper.kt`中，Android 14+注册了callback来监听MediaProjection停止事件。如果日志中出现"MediaProjection stopped"，说明系统自动停止了MediaProjection。

---

## 结论

### 最可能的原因

**Android 14+的MediaProjection单次使用限制**

在Android 14+，MediaProjection在VirtualDisplay释放后可能自动失效。即使代码不主动释放MediaProjection，系统也会在认为不再需要时自动停止。这导致第二次截图时MediaProjection已经失效，触发SecurityException，从而重新请求权限。

### 次要可能的原因

**OPPO ColorOS的权限管理**

OPPO的ColorOS可能有额外的权限管理机制，在截图后自动回收权限。这是厂商定制系统的常见行为。

### 代码设计意图 vs 实际行为

**设计意图**（从注释看）：
- 保持MediaProjection活跃，允许用户多次截图而不需要重新请求权限
- `endScreenshotSession()`不释放MediaProjection
- 只在服务销毁时释放MediaProjection

**实际行为**（Android 14+）：
- 即使代码不主动释放MediaProjection，系统也会自动停止
- VirtualDisplay释放后，系统认为MediaProjection不再需要
- 导致第二次截图时权限失效

---

## 解决方向（仅供参考）

### 方案1：接受Android 14+的限制
- 在Android 14+，每次截图都需要重新请求权限（这是系统限制）
- 优化权限请求流程，减少用户感知

### 方案2：保持VirtualDisplay不释放
- 在截图完成后不立即释放VirtualDisplay
- 在用户明确结束截图会话时才释放
- 缺点：消耗更多系统资源

### 方案3：使用Android 14+的新API
- 研究Android 14+是否提供了新的MediaProjection API
- 可能有更好的方式来保持MediaProjection活跃

### 方案4：优化用户体验
- 在权限即将失效时提前提示用户
- 使用更友好的权限请求UI
- 添加"记住我的选择"选项（如果系统支持）

---

## 新增分析：设置页授权后悬浮窗再次弹窗

### 复现步骤
1. 设置页打开“截图权限”并完成授权。
2. 打开悬浮窗 → 点击“截图”。
3. 系统再次弹出 MediaProjection 授权（第二次）。
4. 第二次授权后，短时间内不再重复弹窗。

### context-gatherer 子代理（上下文聚合）
| 文件 | 状态 | 说明 |
|------|------|------|
| `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsScreen.kt` | ✅ | 设置页触发 ScreenshotPermissionActivity |
| `app/src/main/java/com/empathy/ai/ui/ScreenshotPermissionActivity.kt` | ✅ | 授权结果保存并回传 Service |
| `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt` | ✅ | 授权处理、截图入口与权限恢复逻辑 |
| `data/src/main/kotlin/com/empathy/ai/data/local/FloatingWindowPreferences.kt` | ✅ | 权限缓存与持久化逻辑 |

### 使用 debugging-strategies 的分析路径（简化版）
- **Observe**: 设置页授权后，悬浮窗首次截图仍弹窗。
- **Hypothesize**: Android 14+ 的“权限不可复用”保护逻辑导致缓存未被使用。
- **Evidence**:
  - `handleMediaProjectionResult()` 对 `REQUEST_SOURCE_SETTINGS` 直接 `return`，未建立 MediaProjection 实例。
  - `restoreMediaProjectionFromCache()` 在 Android 14+ 直接返回 `false` → 触发 `requestMediaProjectionPermission()`。
- **Conclusion**: 设置页授权被缓存，但在 Android 14+ 被主动忽略，导致首次悬浮窗截图再次授权。

### 关键调用链路
```
SettingsScreen → ScreenshotPermissionActivity
  → FloatingWindowService.handleMediaProjectionResult(source=settings)
    → saveMediaProjectionPermission() 后直接 return
FloatingWindowService.startScreenshotFlow()
  → restoreMediaProjectionFromCache() (Android 14+ 直接 false)
  → requestMediaProjectionPermission() (第二次弹窗)
```

### 思维链 MCP 情况
- 当前环境未配置 MCP 资源（`list_mcp_resources` 为空），本轮通过本地代码与日志推理完成分析。

### 修复策略（本轮拟定）
1. **Android 14+ 允许使用“内存缓存”的权限一次**，仅禁止“持久化恢复”。
2. `saveMediaProjectionPermission()` 在 Android 14+ 不进行持久化，仅保留内存缓存。
3. `getMediaProjectionPermissionInternal()` 在 Android 14+ 若只有持久化缓存则清空并返回 null。
4. `restoreMediaProjectionFromCache()` 移除 Android 14+ 直接 false 的逻辑，允许使用内存缓存恢复。

### 预期效果
- 设置页授权后，首次在悬浮窗截图不再二次弹窗（同进程）。
- 进程重启或权限被系统回收时，仍会正常提示重新授权。

---

## 相关文件

| 文件 | 路径 |
|------|------|
| FloatingWindowService.kt | `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt` |
| ScreenshotCaptureHelper.kt | `app/src/main/java/com/empathy/ai/domain/util/ScreenshotCaptureHelper.kt` |
| FloatingWindowPreferences.kt | `data/src/main/kotlin/com/empathy/ai/data/local/FloatingWindowPreferences.kt` |
| BUG-00073分析文档 | `文档/开发文档/BUG/BUG-00073-截图权限重启后失效分析.md` |

---

## 变更记录

### 2026-01-17 14:42:00 - Claude
- 创建问题分析文档
- 使用Explore agent获取完整上下文
- 使用MCP思维链深度分析问题原因
- 确定最可能的原因是Android 14+的MediaProjection限制

### 2026-01-17 16:20:00 - Codex
- 补充“设置页授权后重复弹窗”原因
- 记录 Android 14+ 缓存策略与修复方向
- 标注 MCP 未配置的处理说明
