# 修复UI相关BUG (BUG-00031/32/33)

<plan>

# Session Handoff Plan

## 1. Primary Request and Intent

用户请求修复三个UI相关的BUG：

1. **BUG-00031**: 设置页面底部导航栏失效 - 进入设置页面后，底部导航栏点击无响应
2. **BUG-00032**: 联系人列表与设置页面风格不统一 - 需要统一为iOS风格
3. **BUG-00033**: 提示词编辑器UI与设计稿不一致 - Tab缺少图标，工具栏样式不对

在修复过程中还发现并解决了：
- **BUG-00034**: Hilt多模块编译错误 - MainActivity放在错误的模块

最终用户反馈：通过Android Studio编译运行后，修复未生效。经深度调研发现ContactListScreen.kt中存在参数覆盖问题。

## 2. Key Technical Concepts

- **Jetpack Compose Navigation**: NavGraph、NavController、composable路由
- **Compose参数传递**: 回调函数参数的默认值机制
- **Hilt多模块架构**: @AndroidEntryPoint只能在Application模块使用
- **iOS风格UI组件**: 大标题、白色圆角卡片、iOSBackground背景色
- **Android Studio增量编译**: 文件变化检测、缓存机制

## 3. Files and Code Sections

### NavGraph.kt
- **路径**: `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NavGraph.kt`
- **Why important**: 定义应用的导航结构，是底部导航栏失效问题的根因所在
- **Changes made**: 
  - 为ContactListScreen添加onNavigate和onAddClick参数
  - 为SettingsScreen添加onNavigate和onAddClick参数
- **Code snippet**:
```kotlin
// 联系人列表页面
composable(route = NavRoutes.CONTACT_LIST) {
    ContactListScreen(
        onNavigateToDetail = { contactId ->
            if (contactId.isNotEmpty()) {
                navController.navigate(NavRoutes.createContactDetailTabRoute(contactId))
            } else {
                navController.navigate(NavRoutes.createContactDetailRoute(contactId))
            }
        },
        onNavigateToSettings = {
            navController.navigate(NavRoutes.SETTINGS)
        },
        // 修复BUG-00031: 添加底部导航栏的导航回调
        onNavigate = { route ->
            if (route != NavRoutes.CONTACT_LIST) {
                navController.navigate(route) {
                    popUpTo(NavRoutes.CONTACT_LIST) {
                        saveState = true
                    }
                    launchSingleTop = true
                    restoreState = true
                }
            }
        },
        // 修复: 添加加号按钮点击回调
        onAddClick = {
            navController.navigate(NavRoutes.createContactDetailRoute(""))
        }
    )
}

// 设置页面
composable(route = NavRoutes.SETTINGS) {
    SettingsScreen(
        onNavigateBack = { navController.navigateUp() },
        onNavigateToAiConfig = { navController.navigate(NavRoutes.AI_CONFIG) },
        onNavigateToPromptEditor = { route -> navController.navigate(route) },
        onNavigateToUserProfile = { navController.navigate(NavRoutes.USER_PROFILE) },
        // 修复BUG-00031: 添加底部导航栏的导航回调
        onNavigate = { route ->
            if (route != NavRoutes.SETTINGS) {
                navController.navigate(route) {
                    popUpTo(NavRoutes.CONTACT_LIST) { saveState = true }
                    launchSingleTop = true
                    restoreState = true
                }
            }
        },
        onAddClick = {
            navController.navigate(NavRoutes.createContactDetailRoute(""))
        }
    )
}
```

### ContactListScreen.kt
- **路径**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactListScreen.kt`
- **Why important**: 联系人列表页面，存在onAddClick被覆盖的BUG
- **Changes made**: 
  - 添加iOS大标题风格（IOSLargeTitleHeader组件）
  - 添加白色圆角卡片容器（ContactListWithHeader组件）
  - 修复onAddClick参数被覆盖的问题
- **Code snippet (关键修复)**:
```kotlin
// 修复前（问题代码）
ContactListScreenContent(
    ...
    onAddClick = { onNavigateToDetail("") },  // ❌ 覆盖了外部传入的回调
    ...
)

// 修复后
ContactListScreenContent(
    ...
    onAddClick = onAddClick,  // ✅ 使用外部传入的回调
    ...
)
```

### PromptSceneTab.kt
- **路径**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/prompt/PromptSceneTab.kt`
- **Why important**: 提示词编辑器的场景切换Tab组件
- **Changes made**: 重写为带图标的圆角胶囊按钮样式
- **Code snippet**:
```kotlin
private fun getSceneIcon(scene: PromptScene): ImageVector {
    return when (scene) {
        PromptScene.ANALYZE -> Icons.Default.Search
        PromptScene.POLISH -> Icons.Default.EditNote
        PromptScene.REPLY -> Icons.Default.Chat
        PromptScene.SUMMARY -> Icons.Default.Summarize
        else -> Icons.Default.Search
    }
}
```

### MainActivity.kt
- **路径**: `app/src/main/java/com/empathy/ai/ui/MainActivity.kt` (新位置)
- **Why important**: 应用主Activity，必须放在Application模块才能使用@AndroidEntryPoint
- **Changes made**: 从presentation模块移动到app模块
- **Code snippet**:
```kotlin
package com.empathy.ai.ui

@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            EmpathyTheme {
                Surface(...) {
                    val navController = rememberNavController()
                    NavGraph(navController = navController)
                }
            }
        }
    }
}
```

### AndroidManifest.xml
- **路径**: `app/src/main/AndroidManifest.xml`
- **Changes made**: 更新MainActivity的引用路径
- **Code snippet**:
```xml
<activity
    android:name=".ui.MainActivity"
    android:exported="true"
    android:theme="@style/Theme.GiveLove">
    <intent-filter>
        <action android:name="android.intent.action.MAIN" />
        <category android:name="android.intent.category.LAUNCHER" />
    </intent-filter>
</activity>
```

## 4. Problem Solving

### 已解决的问题

1. **BUG-00031 设置页面底部导航栏失效**
   - 根因：NavGraph.kt中调用SettingsScreen和ContactListScreen时遗漏了onNavigate参数
   - 解决：添加完整的导航回调参数

2. **BUG-00032 联系人列表风格不统一**
   - 根因：ContactListScreen使用旧的Material3 TopAppBar
   - 解决：改为iOS大标题风格 + 白色圆角卡片容器

3. **BUG-00033 提示词编辑器Tab缺少图标**
   - 根因：PromptSceneTab组件未实现图标
   - 解决：重写组件，添加图标支持

4. **BUG-00034 Hilt多模块编译错误**
   - 根因：MainActivity放在presentation模块（Library模块）
   - 解决：移动到app模块（Application模块）

5. **修复未生效问题**
   - 根因：ContactListScreen.kt中onAddClick被内部覆盖
   - 解决：将`onAddClick = { onNavigateToDetail("") }`改为`onAddClick = onAddClick`

### 待用户操作

用户需要在Android Studio中执行以下步骤使修改生效：
1. **File → Invalidate Caches / Restart → Invalidate and Restart**
2. 等待AS重启并完成索引
3. **Build → Clean Project**
4. **Build → Rebuild Project**
5. 在模拟器上**卸载应用**
6. **Run → Run 'app'**

## 5. Pending Tasks

- 等待用户在Android Studio中执行清理重建
- 验证三个BUG修复是否生效

## 6. Current Work

最后正在处理的是**用户反馈修复未生效**的问题。

经过深度调研（RESEARCH-00049），发现了ContactListScreen.kt中的关键BUG：
```kotlin
// 问题代码
onAddClick = { onNavigateToDetail("") },  // 覆盖了外部传入的回调
```

已修复为：
```kotlin
onAddClick = onAddClick,  // 使用外部传入的回调
```

## 7. Next Step

1. **用户操作**: 在Android Studio中执行Invalidate Caches / Restart，然后Clean + Rebuild
2. **验证**: 在模拟器上验证三个BUG是否修复：
   - 设置页面底部导航栏是否可以跳转
   - 联系人列表是否显示iOS风格（大标题+白色卡片）
   - 提示词编辑器Tab是否显示图标

</plan>

---

## 相关文档

| 文档类型 | 文档编号 | 文档名称 |
|----------|----------|----------|
| BUG | BUG-00031 | 设置页面底部导航栏失效问题 |
| BUG | BUG-00032 | 联系人列表与设置页面风格不统一问题 |
| BUG | BUG-00033 | 提示词编辑器缺少AI润色功能图标问题 |
| BUG | BUG-00034 | Hilt多模块编译错误问题 |
| RE | RESEARCH-00047 | Hilt多模块编译错误深度调研报告 |
| RE | RESEARCH-00048 | 底部导航栏失效深度调研报告 |
| RE | RESEARCH-00049 | BUG修复未生效深度调研报告 |

---

**文档版本**: 1.0  
**创建日期**: 2025-12-25  
**Slug**: fix-ui-bugs-31-32-33
