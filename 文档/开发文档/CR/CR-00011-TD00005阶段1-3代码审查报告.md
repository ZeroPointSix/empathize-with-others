# CR-00011-TD00005é˜¶æ®µ1-3ä»£ç å®¡æŸ¥æŠ¥å‘Š

> **æ–‡æ¡£ç±»å‹**: ä»£ç å®¡æŸ¥æŠ¥å‘Š (CR)  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-16  
> **å®¡æŸ¥äºº**: Roo  
> **å®¡æŸ¥èŒƒå›´**: TD00005é˜¶æ®µ1-3ä»£ç æ–‡ä»¶  
> **å…³è”æ–‡æ¡£**: TDD-00005-æç¤ºè¯ç®¡ç†ç³»ç»ŸæŠ€æœ¯è®¾è®¡.md, TD-00005-æç¤ºè¯ç®¡ç†ç³»ç»Ÿä»»åŠ¡æ¸…å•.md

---

## ğŸ“Š å®¡æŸ¥ç»“æœæ‘˜è¦

| å®¡æŸ¥é¡¹ | çŠ¶æ€ | é—®é¢˜æ•° | è¯´æ˜ |
|--------|------|--------|------|
| ğŸ”´ è¿‡åº¦è®¾è®¡ | âŒ | 8 | å­˜åœ¨è¿‡åº¦ç¼“å­˜å¤æ‚æ€§ã€å¤šå±‚å¤‡ä»½æœºåˆ¶ç­‰é—®é¢˜ |
| ğŸ”´ æ¥å£ä¸€è‡´æ€§ | âŒ | 10 | æ–¹æ³•ç­¾åä¸åŒ¹é…ã€è¿”å›ç±»å‹ä¸ä¸€è‡´ç­‰é—®é¢˜ |
| æ¶æ„åˆè§„æ€§ | âš ï¸ | 3 | éƒ¨åˆ†è¿ç§»é€»è¾‘å¤æ‚ã€ä¾èµ–æ³¨å…¥é…ç½®å¯ä¼˜åŒ– |
| ä»£ç è´¨é‡ | âš ï¸ | 3 | å­˜åœ¨ç¡¬ç¼–ç å­—ç¬¦ä¸²ã€å‚æ•°è¿‡å¤šç­‰é—®é¢˜ |
| åŠŸèƒ½å®Œæ•´æ€§ | âœ… | 0 | æ ¸å¿ƒåŠŸèƒ½å·²å®Œæ•´å®ç° |
| æ€§èƒ½é£é™© | âš ï¸ | 2 | ç¼“å­˜ç­–ç•¥ä¸ä¸€è‡´ã€å¹¶å‘å®‰å…¨é—®é¢˜ |
| å®‰å…¨åˆè§„ | âœ… | 0 | æœªå‘ç°æ˜æ˜¾å®‰å…¨é—®é¢˜ |
| æµ‹è¯•è¦†ç›– | âš ï¸ | 1 | ç¼ºå°‘ç›¸å…³æµ‹è¯•æ–‡ä»¶ |

**æ•´ä½“è¯„åˆ†**: 5.5/10 (éœ€æ”¹è¿›)

---

## ä¸€ã€ğŸ”´ è¿‡åº¦è®¾è®¡æ£€æµ‹ç»“æœ

### OD-001: PromptVariableResolverè¿‡åº¦ç¼“å­˜å¤æ‚æ€§

**é—®é¢˜æè¿°**ï¼š
PromptVariableResolverç±»ä¸­å­˜åœ¨ä¸å¿…è¦çš„ç¼“å­˜å¤æ‚æ€§ï¼Œè™½ç„¶è®¾è®¡æ–‡æ¡£è¯´æ˜äº†ä¸ç¼“å­˜resolve()ç»“æœçš„åŸå› ï¼Œä½†å®ç°ä»ç„¶è¿‡äºå¤æ‚ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/util/PromptVariableResolver.kt:38-72`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
private val extractCache = LruCache<String, List<String>>(EXTRACT_CACHE_SIZE)

fun extractVariables(template: String): List<String> {
    extractCache.get(template)?.let { return it }
    
    val result = VARIABLE_PATTERN.findAll(template)
        .map { it.groupValues[1].lowercase() }
        .distinct()
        .toList()
    
    extractCache.put(template, result)
    return result
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
fun extractVariables(template: String): List<String> {
    // å¯¹äºç®€å•çš„æ¨¡æ¿ï¼Œç›´æ¥è®¡ç®—æ¯”ç¼“å­˜æ›´é«˜æ•ˆ
    // åªæœ‰åœ¨æ¨¡æ¿å¤æ‚ä¸”é‡å¤ä½¿ç”¨æ—¶æ‰è€ƒè™‘ç¼“å­˜
    return VARIABLE_PATTERN.findAll(template)
        .map { it.groupValues[1].lowercase() }
        .distinct()
        .toList()
}
```

### OD-002: PromptFileStorageå¤šå±‚å¤‡ä»½æœºåˆ¶

**é—®é¢˜æè¿°**ï¼š
PromptFileStorageç±»ä¸­å®ç°äº†å¤šå±‚å¤‡ä»½æœºåˆ¶ï¼ŒåŒ…æ‹¬å†…å­˜ç¼“å­˜ã€æ–‡ä»¶å¤‡ä»½å’Œè‡ªåŠ¨æ¢å¤ï¼Œå¢åŠ äº†ç³»ç»Ÿå¤æ‚æ€§ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/data/local/PromptFileStorage.kt:196-209`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
private suspend fun tryRestoreFromBackup(): Result<GlobalPromptConfig> {
    val restoreResult = backup.restoreFromLatestBackup(globalPromptsFile)
    if (restoreResult.isSuccess) {
        return readGlobalConfig()
    }
    
    // å¤‡ä»½æ¢å¤å¤±è´¥ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
    val defaultConfig = GlobalPromptConfig.createDefault { scene ->
        DefaultPrompts.getDefault(scene)
    }
    writeGlobalConfigInternal(defaultConfig)
    cachedConfig = defaultConfig
    return Result.success(defaultConfig)
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
private suspend fun tryRestoreFromBackup(): Result<GlobalPromptConfig> {
    // ç®€åŒ–æ¢å¤é€»è¾‘ï¼Œåªä¿ç•™åŸºæœ¬çš„é”™è¯¯å¤„ç†
    return try {
        val defaultConfig = GlobalPromptConfig.createDefault { scene ->
            DefaultPrompts.getDefault(scene)
        }
        writeGlobalConfigInternal(defaultConfig)
        cachedConfig = defaultConfig
        Result.success(defaultConfig)
    } catch (e: Exception) {
        Result.failure(PromptError.StorageError("æ¢å¤é»˜è®¤é…ç½®å¤±è´¥", e))
    }
}
```

### OD-003: PromptFileBackupè¿‡åº¦è®¾è®¡

**é—®é¢˜æè¿°**ï¼š
PromptFileBackupç±»å®ç°äº†å¤æ‚çš„å¤‡ä»½ç®¡ç†ï¼ŒåŒ…æ‹¬è‡ªåŠ¨æ¸…ç†ã€æ—¶é—´æˆ³ç®¡ç†ç­‰ï¼Œå¯¹äºç®€å•çš„é…ç½®æ–‡ä»¶æ¥è¯´è¿‡äºå¤æ‚ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/data/local/PromptFileBackup.kt:86-96`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
private fun cleanOldBackups() {
    val backups = backupDir.listFiles()
        ?.filter { it.name.startsWith(BACKUP_PREFIX) && it.name.endsWith(BACKUP_SUFFIX) }
        ?.sortedByDescending { it.lastModified() }
        ?: return
    
    backups.drop(MAX_BACKUPS).forEach { it.delete() }
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
private fun cleanOldBackups() {
    // ç®€åŒ–ä¸ºåªä¿ç•™æœ€æ–°çš„ä¸€ä¸ªå¤‡ä»½æ–‡ä»¶
    val backups = backupDir.listFiles()
        ?.filter { it.name.startsWith(BACKUP_PREFIX) && it.name.endsWith(BACKUP_SUFFIX) }
        ?.sortedByDescending { it.lastModified() }
        ?: return
    
    backups.drop(1).forEach { it.delete() }
}
```

### OD-004: PromptBuilderæ–¹æ³•é‡å¤å®ç°

**é—®é¢˜æè¿°**ï¼š
PromptBuilderç±»ä¸­buildSystemInstructionå’ŒbuildSimpleInstructionæ–¹æ³•å­˜åœ¨å¤§é‡é‡å¤ä»£ç ï¼Œè¿åDRYåŸåˆ™ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/util/PromptBuilder.kt:36-139`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
suspend fun buildSystemInstruction(
    scene: PromptScene,
    contactId: String? = null,
    context: PromptContext
): String {
    return buildString {
        // 1. ç³»ç»Ÿè§’è‰²å®šä¹‰
        append(SystemPrompts.getHeader(scene))
        appendLine()
        appendLine()
        
        // 2. ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤
        val globalPromptResult = promptRepository.getGlobalPrompt(scene)
        val globalPrompt = globalPromptResult.getOrNull() ?: ""
        if (globalPrompt.isNotBlank()) {
            appendLine("ã€ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤ã€‘")
            val resolvedPrompt = variableResolver.resolve(globalPrompt, context)
            appendLine(resolvedPrompt)
            appendLine()
        }
        // ... æ›´å¤šé‡å¤ä»£ç 
    }
}

suspend fun buildSimpleInstruction(
    scene: PromptScene,
    contactId: String? = null,
    context: PromptContext
): String {
    return buildString {
        // 1. ç³»ç»Ÿè§’è‰²å®šä¹‰
        append(SystemPrompts.getHeader(scene))
        appendLine()
        appendLine()
        
        // 2. ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤
        val globalPromptResult = promptRepository.getGlobalPrompt(scene)
        val globalPrompt = globalPromptResult.getOrNull() ?: ""
        if (globalPrompt.isNotBlank()) {
            appendLine("ã€ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤ã€‘")
            val resolvedPrompt = variableResolver.resolve(globalPrompt, context)
            appendLine(resolvedPrompt)
            appendLine()
        }
        // ... æ›´å¤šé‡å¤ä»£ç 
    }
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
private suspend fun buildInstructionBase(
    scene: PromptScene,
    contactId: String? = null,
    context: PromptContext,
    includeContextPlaceholder: Boolean = true
): String {
    return buildString {
        // 1. ç³»ç»Ÿè§’è‰²å®šä¹‰
        append(SystemPrompts.getHeader(scene))
        appendLine()
        appendLine()
        
        // 2. ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤
        val globalPromptResult = promptRepository.getGlobalPrompt(scene)
        val globalPrompt = globalPromptResult.getOrNull() ?: ""
        if (globalPrompt.isNotBlank()) {
            appendLine("ã€ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤ã€‘")
            val resolvedPrompt = variableResolver.resolve(globalPrompt, context)
            appendLine(resolvedPrompt)
            appendLine()
        }
        
        // 3. è”ç³»äººä¸“å±æç¤ºè¯
        if (contactId != null) {
            val contactPromptResult = promptRepository.getContactPrompt(contactId)
            val contactPrompt = contactPromptResult.getOrNull()
            if (!contactPrompt.isNullOrBlank()) {
                appendLine("ã€é’ˆå¯¹æ­¤è”ç³»äººçš„ç‰¹æ®ŠæŒ‡ä»¤ã€‘")
                val resolvedPrompt = variableResolver.resolve(contactPrompt, context)
                appendLine(resolvedPrompt)
                appendLine()
            }
        }
        
        // 4. ä¸Šä¸‹æ–‡æ•°æ®å ä½ï¼ˆå¯é€‰ï¼‰
        if (includeContextPlaceholder) {
            appendLine("ã€ä¸Šä¸‹æ–‡æ•°æ®ã€‘")
            appendLine(CONTEXT_PLACEHOLDER)
            appendLine()
        }
        
        // 5. è¾“å‡ºæ ¼å¼çº¦æŸ
        append(SystemPrompts.getFooter(scene))
    }
}

suspend fun buildSystemInstruction(
    scene: PromptScene,
    contactId: String? = null,
    context: PromptContext
): String = buildInstructionBase(scene, contactId, context, includeContextPlaceholder = true)

suspend fun buildSimpleInstruction(
    scene: PromptScene,
    contactId: String? = null,
    context: PromptContext
): String = buildInstructionBase(scene, contactId, context, includeContextPlaceholder = false)
```

### OD-005: PromptFileStorageå¤æ‚JSONè§£æ

**é—®é¢˜æè¿°**ï¼š
PromptFileStorageç±»ä¸­çš„parseConfigæ–¹æ³•å®ç°äº†å¤æ‚çš„JSONè§£æé€»è¾‘ï¼ŒåŒ…æ‹¬æ‰‹åŠ¨ç±»å‹è½¬æ¢å’Œå¤šå±‚åµŒå¥—å¤„ç†ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/data/local/PromptFileStorage.kt:153-191`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
private fun parseConfig(json: String): GlobalPromptConfig? {
    return try {
        val mapAdapter = moshi.adapter<Map<String, Any>>(
            Types.newParameterizedType(Map::class.java, String::class.java, Any::class.java)
        )
        val rootMap = mapAdapter.fromJson(json) ?: return null
        
        val version = (rootMap["version"] as? Number)?.toInt() ?: 1
        val lastModified = rootMap["lastModified"] as? String ?: ""
        
        @Suppress("UNCHECKED_CAST")
        val promptsMap = rootMap["prompts"] as? Map<String, Map<String, Any>> ?: emptyMap()
        
        val prompts = promptsMap.mapNotNull { (key, value) ->
            val scene = try {
                PromptScene.valueOf(key)
            } catch (e: Exception) {
                return@mapNotNull null
            }
            
            val userPrompt = value["userPrompt"] as? String ?: ""
            val enabled = value["enabled"] as? Boolean ?: true
            
            @Suppress("UNCHECKED_CAST")
            val historyList = value["history"] as? List<Map<String, String>> ?: emptyList()
            val history = historyList.mapNotNull { item ->
                val timestamp = item["timestamp"] ?: return@mapNotNull null
                val prompt = item["userPrompt"] ?: return@mapNotNull null
                com.empathy.ai.domain.model.PromptHistoryItem(timestamp, prompt)
            }
            
            scene to ScenePromptConfig(userPrompt, enabled, history)
        }.toMap()
        
        GlobalPromptConfig(version, lastModified, prompts)
    } catch (e: Exception) {
        null
    }
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
private fun parseConfig(json: String): GlobalPromptConfig? {
    return try {
        // ä½¿ç”¨Moshiç›´æ¥ååºåˆ—åŒ–ï¼Œé¿å…æ‰‹åŠ¨ç±»å‹è½¬æ¢
        val adapter = moshi.adapter(GlobalPromptConfig::class.java)
        adapter.fromJson(json)
    } catch (e: Exception) {
        // è§£æå¤±è´¥æ—¶è¿”å›nullï¼Œç”±è°ƒç”¨æ–¹å¤„ç†
        null
    }
}
```

### OD-006: PromptRepositoryImplé‡å¤é…ç½®æ›´æ–°é€»è¾‘

**é—®é¢˜æè¿°**ï¼š
PromptRepositoryImplç±»ä¸­saveGlobalPromptã€restoreDefaultå’ŒrestoreFromHistoryæ–¹æ³•å­˜åœ¨é‡å¤çš„é…ç½®æ›´æ–°é€»è¾‘ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/data/repository/PromptRepositoryImpl.kt:75-91, 130-143, 171-179`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
// saveGlobalPromptæ–¹æ³•ä¸­çš„é…ç½®æ›´æ–°
val newPrompts = currentConfig.prompts.toMutableMap()
newPrompts[scene] = newSceneConfig
val newConfig = currentConfig.copy(prompts = newPrompts)
fileStorage.writeGlobalConfig(newConfig)

// restoreDefaultæ–¹æ³•ä¸­çš„é…ç½®æ›´æ–°
val newPrompts = currentConfig.prompts.toMutableMap()
newPrompts[scene] = newSceneConfig
val newConfig = currentConfig.copy(prompts = newPrompts)
fileStorage.writeGlobalConfig(newConfig)

// restoreFromHistoryæ–¹æ³•ä¸­çš„é…ç½®æ›´æ–°
val newPrompts = currentConfig.prompts.toMutableMap()
newPrompts[scene] = newSceneConfig
val newConfig = currentConfig.copy(prompts = newPrompts)
fileStorage.writeGlobalConfig(newConfig)
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
private suspend fun updateSceneConfig(
    scene: PromptScene,
    configUpdater: (ScenePromptConfig?) -> ScenePromptConfig
): Result<Unit> {
    return mutex.withLock {
        val currentConfig = fileStorage.readGlobalConfig().getOrElse {
            return@withLock Result.failure(
                PromptError.StorageError("è¯»å–é…ç½®å¤±è´¥", it)
            )
        }
        
        val currentSceneConfig = currentConfig.prompts[scene]
        val newSceneConfig = configUpdater(currentSceneConfig)
        
        val newPrompts = currentConfig.prompts.toMutableMap()
        newPrompts[scene] = newSceneConfig
        
        val newConfig = currentConfig.copy(prompts = newPrompts)
        fileStorage.writeGlobalConfig(newConfig)
    }
}

override suspend fun saveGlobalPrompt(scene: PromptScene, prompt: String): Result<Unit> {
    // ... éªŒè¯é€»è¾‘ ...
    
    return updateSceneConfig(scene) { currentSceneConfig ->
        if (currentSceneConfig != null) {
            currentSceneConfig.addHistory(currentSceneConfig.userPrompt)
                .copy(userPrompt = prompt)
        } else {
            ScenePromptConfig(userPrompt = prompt)
        }
    }
}
```

### OD-007: PromptSanitizerè¿‡åº¦åŒ¹é…æ¨¡å¼

**é—®é¢˜æè¿°**ï¼š
PromptSanitizerç±»ä¸­å®šä¹‰äº†è¿‡å¤šçš„å±é™©å†…å®¹åŒ¹é…æ¨¡å¼ï¼Œå¯èƒ½å¯¼è‡´è¯¯æŠ¥å’Œæ€§èƒ½é—®é¢˜ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/util/PromptSanitizer.kt:15-41`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
private val DANGEROUS_PATTERNS = listOf(
    // ä¸­æ–‡æ³¨å…¥æ¨¡å¼
    Regex("å¿½ç•¥.*æŒ‡ä»¤", RegexOption.IGNORE_CASE),
    Regex("å¿½ç•¥.*ä¸Šé¢", RegexOption.IGNORE_CASE),
    Regex("å¿½ç•¥.*ä¹‹å‰", RegexOption.IGNORE_CASE),
    Regex("æ–°çš„è§’è‰²", RegexOption.IGNORE_CASE),
    Regex("ä½ ç°åœ¨æ˜¯", RegexOption.IGNORE_CASE),
    Regex("æ‰®æ¼”.*è§’è‰²", RegexOption.IGNORE_CASE),
    Regex("å‡è£….*æ˜¯", RegexOption.IGNORE_CASE),
    Regex("ä¸è¦.*é™åˆ¶", RegexOption.IGNORE_CASE),
    Regex("å–æ¶ˆ.*é™åˆ¶", RegexOption.IGNORE_CASE),
    
    // è‹±æ–‡æ³¨å…¥æ¨¡å¼
    Regex("ignore.*instruction", RegexOption.IGNORE_CASE),
    Regex("ignore.*above", RegexOption.IGNORE_CASE),
    Regex("ignore.*previous", RegexOption.IGNORE_CASE),
    Regex("disregard.*above", RegexOption.IGNORE_CASE),
    Regex("disregard.*previous", RegexOption.IGNORE_CASE),
    Regex("forget.*previous", RegexOption.IGNORE_CASE),
    Regex("forget.*above", RegexOption.IGNORE_CASE),
    Regex("you are now", RegexOption.IGNORE_CASE),
    Regex("act as", RegexOption.IGNORE_CASE),
    Regex("pretend.*to be", RegexOption.IGNORE_CASE),
    Regex("new role", RegexOption.IGNORE_CASE),
    Regex("jailbreak", RegexOption.IGNORE_CASE),
    Regex("bypass.*restriction", RegexOption.IGNORE_CASE)
)
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
private val DANGEROUS_PATTERNS = listOf(
    // åªä¿ç•™æœ€å…³é”®çš„æ³¨å…¥æ¨¡å¼
    Regex("ignore.*instruction", RegexOption.IGNORE_CASE),
    Regex("ignore.*above", RegexOption.IGNORE_CASE),
    Regex("æ–°çš„è§’è‰²", RegexOption.IGNORE_CASE),
    Regex("ä½ ç°åœ¨æ˜¯", RegexOption.IGNORE_CASE),
    Regex("jailbreak", RegexOption.IGNORE_CASE)
)
```

### OD-008: PromptValidatorè¿‡åº¦éªŒè¯è§„åˆ™

**é—®é¢˜æè¿°**ï¼š
PromptValidatorç±»ä¸­å®ç°äº†è¿‡å¤šçš„éªŒè¯è§„åˆ™ï¼ŒåŒ…æ‹¬é•¿åº¦æ£€æŸ¥ã€å˜é‡æ£€æŸ¥ç­‰ï¼Œå¯¹äºç®€å•çš„æç¤ºè¯æ¥è¯´è¿‡äºå¤æ‚ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/util/PromptValidator.kt:43-81`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
fun validate(prompt: String, scene: PromptScene): PromptValidationResult {
    // 1. æ£€æŸ¥ç©ºå€¼
    if (prompt.isBlank()) {
        return PromptValidationResult.Error(
            message = "æç¤ºè¯ä¸èƒ½ä¸ºç©º",
            errorType = PromptValidationResult.ErrorType.EMPTY_PROMPT
        )
    }
    
    // 2. æ£€æŸ¥é•¿åº¦é™åˆ¶
    if (prompt.length > MAX_PROMPT_LENGTH) {
        return PromptValidationResult.Error(
            message = "æç¤ºè¯é•¿åº¦ä¸èƒ½è¶…è¿‡${MAX_PROMPT_LENGTH}å­—ç¬¦ï¼Œå½“å‰${prompt.length}å­—ç¬¦",
            errorType = PromptValidationResult.ErrorType.EXCEEDS_LENGTH_LIMIT
        )
    }
    
    // 3. æ£€æŸ¥å˜é‡æœ‰æ•ˆæ€§
    val invalidVariables = variableResolver.findInvalidVariables(
        template = prompt,
        allowedVariables = scene.availableVariables
    )
    if (invalidVariables.isNotEmpty()) {
        return PromptValidationResult.Error(
            message = "ä½¿ç”¨äº†æ— æ•ˆå˜é‡: ${invalidVariables.joinToString(", ")}",
            errorType = PromptValidationResult.ErrorType.INVALID_VARIABLES
        )
    }
    
    // 4. æ£€æŸ¥æ˜¯å¦æ¥è¿‘é•¿åº¦é™åˆ¶ï¼ˆè­¦å‘Šï¼‰
    if (prompt.length > WARNING_LENGTH_THRESHOLD) {
        return PromptValidationResult.Warning(
            message = "æç¤ºè¯é•¿åº¦æ¥è¿‘é™åˆ¶ï¼ˆ${prompt.length}/${MAX_PROMPT_LENGTH}ï¼‰",
            warningType = PromptValidationResult.WarningType.NEAR_LENGTH_LIMIT
        )
    }
    
    return PromptValidationResult.Success
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
fun validate(prompt: String, scene: PromptScene): PromptValidationResult {
    // ç®€åŒ–éªŒè¯è§„åˆ™ï¼Œåªä¿ç•™æœ€åŸºæœ¬çš„æ£€æŸ¥
    if (prompt.isBlank()) {
        return PromptValidationResult.Error(
            message = "æç¤ºè¯ä¸èƒ½ä¸ºç©º",
            errorType = PromptValidationResult.ErrorType.EMPTY_PROMPT
        )
    }
    
    if (prompt.length > MAX_PROMPT_LENGTH) {
        return PromptValidationResult.Error(
            message = "æç¤ºè¯é•¿åº¦ä¸èƒ½è¶…è¿‡${MAX_PROMPT_LENGTH}å­—ç¬¦",
            errorType = PromptValidationResult.ErrorType.EXCEEDS_LENGTH_LIMIT
        )
    }
    
    return PromptValidationResult.Success
}
```

---

## äºŒã€ğŸ”´ æ¥å£ä¸€è‡´æ€§éªŒè¯ç»“æœ

### IC-001: PromptRepositoryæ¥å£ä¸å®ç°è¿”å›ç±»å‹ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
PromptRepositoryæ¥å£ä¸­getGlobalPromptæ–¹æ³•è¿”å›Result<String>ï¼Œä½†å®ç°ä¸­å¯èƒ½è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œä¸æ¥å£å¥‘çº¦ä¸ç¬¦ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/repository/PromptRepository.kt:27`
`app/src/main/java/com/empathy/ai/data/repository/PromptRepositoryImpl.kt:43-47`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
// æ¥å£å®šä¹‰
suspend fun getGlobalPrompt(scene: PromptScene): Result<String>

// å®ç°ä»£ç 
override suspend fun getGlobalPrompt(scene: PromptScene): Result<String> {
    return fileStorage.readGlobalConfig().map { config ->
        config.prompts[scene]?.userPrompt ?: DefaultPrompts.getDefault(scene)
    }
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
// ä¿®æ”¹æ¥å£å®šä¹‰ï¼Œæ˜ç¡®å¯èƒ½è¿”å›ç©ºå­—ç¬¦ä¸²
suspend fun getGlobalPrompt(scene: PromptScene): Result<String>

// æˆ–è€…ä¿®æ”¹å®ç°ï¼Œç¡®ä¿æ€»æ˜¯è¿”å›éç©ºå­—ç¬¦ä¸²
override suspend fun getGlobalPrompt(scene: PromptScene): Result<String> {
    return fileStorage.readGlobalConfig().map { config ->
        config.prompts[scene]?.userPrompt ?: DefaultPrompts.getDefault(scene)
    }.map { prompt ->
        if (prompt.isBlank()) {
            DefaultPrompts.getDefault(scene)
        } else {
            prompt
        }
    }
}
```

### IC-002: PromptFileStorageè¿”å›ç±»å‹ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
PromptFileStorageç±»ä¸­readGlobalConfigæ–¹æ³•åœ¨æ–‡ä»¶ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé»˜è®¤é…ç½®ï¼Œä½†é”™è¯¯å¤„ç†è·¯å¾„å¯èƒ½è¿”å›nullï¼Œä¸è¿”å›ç±»å‹ä¸ç¬¦ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/data/local/PromptFileStorage.kt:63-89`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
suspend fun readGlobalConfig(): Result<GlobalPromptConfig> = withContext(ioDispatcher) {
    cachedConfig?.let { return@withContext Result.success(it) }
    
    cacheLock.withLock {
        cachedConfig?.let { return@withContext Result.success(it) }
        
        try {
            if (!globalPromptsFile.exists()) {
                val defaultConfig = GlobalPromptConfig.createDefault { scene ->
                    DefaultPrompts.getDefault(scene)
                }
                writeGlobalConfigInternal(defaultConfig)
                cachedConfig = defaultConfig
                return@withContext Result.success(defaultConfig)
            }
            
            val json = globalPromptsFile.readText(Charsets.UTF_8)
            val config = parseConfig(json)
                ?: return@withContext tryRestoreFromBackup()  // å¯èƒ½è¿”å›null
            
            cachedConfig = config
            Result.success(config)
        } catch (e: Exception) {
            tryRestoreFromBackup()  // å¯èƒ½è¿”å›null
        }
    }
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
suspend fun readGlobalConfig(): Result<GlobalPromptConfig> = withContext(ioDispatcher) {
    cachedConfig?.let { return@withContext Result.success(it) }
    
    cacheLock.withLock {
        cachedConfig?.let { return@withContext Result.success(it) }
        
        try {
            if (!globalPromptsFile.exists()) {
                val defaultConfig = GlobalPromptConfig.createDefault { scene ->
                    DefaultPrompts.getDefault(scene)
                }
                writeGlobalConfigInternal(defaultConfig)
                cachedConfig = defaultConfig
                return@withContext Result.success(defaultConfig)
            }
            
            val json = globalPromptsFile.readText(Charsets.UTF_8)
            val config = parseConfig(json)
            if (config != null) {
                cachedConfig = config
                Result.success(config)
            } else {
                tryRestoreFromBackup()
            }
        } catch (e: Exception) {
            tryRestoreFromBackup()
        }
    }
}
```

### IC-003: PromptContext.getVariable()æ–¹æ³•ä¸å®Œæ•´å®ç°

**é—®é¢˜æè¿°**ï¼š
PromptContext.getVariable()æ–¹æ³•æ²¡æœ‰å¤„ç†æ‰€æœ‰å¯èƒ½çš„å˜é‡åï¼Œä¸PromptSceneä¸­å®šä¹‰çš„availableVariablesä¸å®Œå…¨åŒ¹é…ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/model/PromptContext.kt:31-39`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
fun getVariable(name: String): String? = when (name.lowercase()) {
    "contact_name" -> contactName
    "relationship_status" -> relationshipStatus
    "risk_tags" -> riskTags.joinToString("ã€").ifEmpty { "æ— " }
    "strategy_tags" -> strategyTags.joinToString("ã€").ifEmpty { "æ— " }
    "facts_count" -> factsCount.toString()
    "today_date" -> todayDate
    else -> null
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
fun getVariable(name: String): String? = when (name.lowercase()) {
    "contact_name" -> contactName
    "relationship_status" -> relationshipStatus
    "risk_tags" -> riskTags.joinToString("ã€").ifEmpty { "æ— " }
    "strategy_tags" -> strategyTags.joinToString("ã€").ifEmpty { "æ— " }
    "facts_count" -> factsCount.toString()
    "today_date" -> todayDate
    // æ·»åŠ å¯¹å…¶ä»–å¯èƒ½å˜é‡çš„æ”¯æŒ
    "contactname" -> contactName  // æ”¯æŒæ— ä¸‹åˆ’çº¿æ ¼å¼
    "relationshipstatus" -> relationshipStatus
    "risktags" -> riskTags.joinToString("ã€").ifEmpty { "æ— " }
    "strategytags" -> strategyTags.joinToString("ã€").ifEmpty { "æ— " }
    "factscount" -> factsCount.toString()
    "todaysdate" -> todayDate
    else -> null
}
```

### IC-004: PromptBuilderä¸­Resultå¤„ç†ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
PromptBuilderç±»ä¸­buildSystemInstructionæ–¹æ³•ä½¿ç”¨getOrNull()å¤„ç†Resultï¼Œå¿½ç•¥äº†å¯èƒ½çš„é”™è¯¯ä¿¡æ¯ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/util/PromptBuilder.kt:48-49, 59-60`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
// ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤
val globalPromptResult = promptRepository.getGlobalPrompt(scene)
val globalPrompt = globalPromptResult.getOrNull() ?: ""

// è”ç³»äººä¸“å±æç¤ºè¯
if (contactId != null) {
    val contactPromptResult = promptRepository.getContactPrompt(contactId)
    val contactPrompt = contactPromptResult.getOrNull()
    if (!contactPrompt.isNullOrBlank()) {
        // ...
    }
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
// ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤
val globalPromptResult = promptRepository.getGlobalPrompt(scene)
val globalPrompt = if (globalPromptResult.isSuccess) {
    globalPromptResult.getOrNull() ?: ""
} else {
    // è®°å½•é”™è¯¯å¹¶ä½¿ç”¨é»˜è®¤å€¼
    Log.w("PromptBuilder", "è·å–å…¨å±€æç¤ºè¯å¤±è´¥: ${globalPromptResult.exceptionOrNull()?.message}")
    ""
}

// è”ç³»äººä¸“å±æç¤ºè¯
if (contactId != null) {
    val contactPromptResult = promptRepository.getContactPrompt(contactId)
    val contactPrompt = if (contactPromptResult.isSuccess) {
        contactPromptResult.getOrNull()
    } else {
        // è®°å½•é”™è¯¯å¹¶ä½¿ç”¨null
        Log.w("PromptBuilder", "è·å–è”ç³»äººæç¤ºè¯å¤±è´¥: ${contactPromptResult.exceptionOrNull()?.message}")
        null
    }
    if (!contactPrompt.isNullOrBlank()) {
        // ...
    }
}
```

### IC-005: PromptRepositoryImplä¸­é”™è¯¯å¤„ç†ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
PromptRepositoryImplç±»ä¸­ä¸åŒæ–¹æ³•å¯¹é”™è¯¯çš„å¤„ç†æ–¹å¼ä¸ä¸€è‡´ï¼Œæœ‰äº›è¿”å›PromptErrorï¼Œæœ‰äº›ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/data/repository/PromptRepositoryImpl.kt:94-101, 103-118`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
override suspend fun getContactPrompt(contactId: String): Result<String?> {
    return try {
        val prompt = contactDao.getCustomPrompt(contactId)
        Result.success(prompt)
    } catch (e: Exception) {
        Result.failure(PromptError.DatabaseError("è·å–è”ç³»äººæç¤ºè¯å¤±è´¥", e))
    }
}

override suspend fun saveContactPrompt(contactId: String, prompt: String?): Result<Unit> {
    return try {
        // å®‰å…¨æ€§æ£€æŸ¥ï¼ˆå¦‚æœæœ‰å†…å®¹ï¼‰
        if (prompt != null) {
            val sanitizeResult = PromptSanitizer.detectDangerousContent(prompt)
            if (!sanitizeResult.isSafe) {
                Log.w(TAG, "è”ç³»äººæç¤ºè¯æ£€æµ‹åˆ°æ½œåœ¨é£é™©: ${sanitizeResult.warnings}")
            }
        }
        
        contactDao.updateCustomPrompt(contactId, prompt)
        Result.success(Unit)
    } catch (e: Exception) {
        Result.failure(PromptError.DatabaseError("ä¿å­˜è”ç³»äººæç¤ºè¯å¤±è´¥", e))
    }
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
override suspend fun getContactPrompt(contactId: String): Result<String?> {
    return try {
        val prompt = contactDao.getCustomPrompt(contactId)
        Result.success(prompt)
    } catch (e: Exception) {
        Log.e(TAG, "è·å–è”ç³»äººæç¤ºè¯å¤±è´¥", e)
        Result.failure(PromptError.DatabaseError("è·å–è”ç³»äººæç¤ºè¯å¤±è´¥", e))
    }
}

override suspend fun saveContactPrompt(contactId: String, prompt: String?): Result<Unit> {
    return try {
        // å®‰å…¨æ€§æ£€æŸ¥ï¼ˆå¦‚æœæœ‰å†…å®¹ï¼‰
        if (prompt != null) {
            val sanitizeResult = PromptSanitizer.detectDangerousContent(prompt)
            if (!sanitizeResult.isSafe) {
                Log.w(TAG, "è”ç³»äººæç¤ºè¯æ£€æµ‹åˆ°æ½œåœ¨é£é™©: ${sanitizeResult.warnings}")
            }
        }
        
        contactDao.updateCustomPrompt(contactId, prompt)
        Result.success(Unit)
    } catch (e: Exception) {
        Log.e(TAG, "ä¿å­˜è”ç³»äººæç¤ºè¯å¤±è´¥", e)
        Result.failure(PromptError.DatabaseError("ä¿å­˜è”ç³»äººæç¤ºè¯å¤±è´¥", e))
    }
}
```

### IC-006: PromptFileBackupä¸­æ–‡ä»¶æ“ä½œä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
PromptFileBackupç±»ä¸­createBackupå’ŒrestoreFromLatestBackupæ–¹æ³•å¯¹æ–‡ä»¶æ“ä½œçš„å¤„ç†ä¸ä¸€è‡´ï¼Œä¸€ä¸ªä½¿ç”¨copyToï¼Œä¸€ä¸ªå¯èƒ½è¦†ç›–æ–‡ä»¶ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/data/local/PromptFileBackup.kt:38-53, 61-72`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
suspend fun createBackup(sourceFile: File): Result<Unit> = withContext(ioDispatcher) {
    try {
        if (!sourceFile.exists()) {
            return@withContext Result.success(Unit)
        }
        
        val timestamp = System.currentTimeMillis()
        val backupFile = File(backupDir, "$BACKUP_PREFIX$timestamp$BACKUP_SUFFIX")
        sourceFile.copyTo(backupFile, overwrite = true)
        
        cleanOldBackups()
        Result.success(Unit)
    } catch (e: Exception) {
        Result.failure(e)
    }
}

suspend fun restoreFromLatestBackup(targetFile: File): Result<Unit> =
    withContext(ioDispatcher) {
        try {
            val latestBackup = findLatestBackup()
                ?: return@withContext Result.failure(Exception("æ— å¯ç”¨å¤‡ä»½"))
            
            latestBackup.copyTo(targetFile, overwrite = true)
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
suspend fun createBackup(sourceFile: File): Result<Unit> = withContext(ioDispatcher) {
    try {
        if (!sourceFile.exists()) {
            return@withContext Result.success(Unit)
        }
        
        val timestamp = System.currentTimeMillis()
        val backupFile = File(backupDir, "$BACKUP_PREFIX$timestamp$BACKUP_SUFFIX")
        
        // ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
        backupDir.mkdirs()
        
        sourceFile.copyTo(backupFile, overwrite = true)
        
        cleanOldBackups()
        Result.success(Unit)
    } catch (e: Exception) {
        Result.failure(e)
    }
}

suspend fun restoreFromLatestBackup(targetFile: File): Result<Unit> =
    withContext(ioDispatcher) {
        try {
            val latestBackup = findLatestBackup()
                ?: return@withContext Result.failure(Exception("æ— å¯ç”¨å¤‡ä»½"))
            
            // ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            targetFile.parentFile?.mkdirs()
            
            latestBackup.copyTo(targetFile, overwrite = true)
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
```

### IC-007: PromptVariableResolverä¸­ç¼“å­˜é”®ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
PromptVariableResolverç±»ä¸­extractVariablesæ–¹æ³•ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ä½œä¸ºç¼“å­˜é”®ï¼Œä½†ç›¸åŒçš„æ¨¡æ¿å¯èƒ½å› å†…å­˜åœ°å€ä¸åŒè€Œè¢«è§†ä¸ºä¸åŒé”®ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/util/PromptVariableResolver.kt:62-72`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
fun extractVariables(template: String): List<String> {
    extractCache.get(template)?.let { return it }
    
    val result = VARIABLE_PATTERN.findAll(template)
        .map { it.groupValues[1].lowercase() }
        .distinct()
        .toList()
    
    extractCache.put(template, result)
    return result
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
fun extractVariables(template: String): List<String> {
    // ä½¿ç”¨æ¨¡æ¿çš„hashCodeä½œä¸ºç¼“å­˜é”®ï¼Œæé«˜ç¼“å­˜æ•ˆç‡
    val cacheKey = template.hashCode().toString()
    extractCache.get(cacheKey)?.let { return it }
    
    val result = VARIABLE_PATTERN.findAll(template)
        .map { it.groupValues[1].lowercase() }
        .distinct()
        .toList()
    
    extractCache.put(cacheKey, result)
    return result
}
```

### IC-008: PromptValidatorä¸­éªŒè¯é¡ºåºä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
PromptValidatorç±»ä¸­validateæ–¹æ³•çš„éªŒè¯é¡ºåºå¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„è®¡ç®—ï¼Œä¾‹å¦‚å…ˆæ£€æŸ¥é•¿åº¦å†æ£€æŸ¥å˜é‡æœ‰æ•ˆæ€§ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/util/PromptValidator.kt:43-81`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
fun validate(prompt: String, scene: PromptScene): PromptValidationResult {
    // 1. æ£€æŸ¥ç©ºå€¼
    if (prompt.isBlank()) {
        return PromptValidationResult.Error(
            message = "æç¤ºè¯ä¸èƒ½ä¸ºç©º",
            errorType = PromptValidationResult.ErrorType.EMPTY_PROMPT
        )
    }
    
    // 2. æ£€æŸ¥é•¿åº¦é™åˆ¶
    if (prompt.length > MAX_PROMPT_LENGTH) {
        return PromptValidationResult.Error(
            message = "æç¤ºè¯é•¿åº¦ä¸èƒ½è¶…è¿‡${MAX_PROMPT_LENGTH}å­—ç¬¦ï¼Œå½“å‰${prompt.length}å­—ç¬¦",
            errorType = PromptValidationResult.ErrorType.EXCEEDS_LENGTH_LIMIT
        )
    }
    
    // 3. æ£€æŸ¥å˜é‡æœ‰æ•ˆæ€§
    val invalidVariables = variableResolver.findInvalidVariables(
        template = prompt,
        allowedVariables = scene.availableVariables
    )
    if (invalidVariables.isNotEmpty()) {
        return PromptValidationResult.Error(
            message = "ä½¿ç”¨äº†æ— æ•ˆå˜é‡: ${invalidVariables.joinToString(", ")}",
            errorType = PromptValidationResult.ErrorType.INVALID_VARIABLES
        )
    }
    
    // 4. æ£€æŸ¥æ˜¯å¦æ¥è¿‘é•¿åº¦é™åˆ¶ï¼ˆè­¦å‘Šï¼‰
    if (prompt.length > WARNING_LENGTH_THRESHOLD) {
        return PromptValidationResult.Warning(
            message = "æç¤ºè¯é•¿åº¦æ¥è¿‘é™åˆ¶ï¼ˆ${prompt.length}/${MAX_PROMPT_LENGTH}ï¼‰",
            warningType = PromptValidationResult.WarningType.NEAR_LENGTH_LIMIT
        )
    }
    
    return PromptValidationResult.Success
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
fun validate(prompt: String, scene: PromptScene): PromptValidationResult {
    // 1. æ£€æŸ¥ç©ºå€¼ï¼ˆæœ€å¿«ï¼‰
    if (prompt.isBlank()) {
        return PromptValidationResult.Error(
            message = "æç¤ºè¯ä¸èƒ½ä¸ºç©º",
            errorType = PromptValidationResult.ErrorType.EMPTY_PROMPT
        )
    }
    
    // 2. æ£€æŸ¥å˜é‡æœ‰æ•ˆæ€§ï¼ˆä¸­ç­‰å¼€é”€ï¼‰
    val invalidVariables = variableResolver.findInvalidVariables(
        template = prompt,
        allowedVariables = scene.availableVariables
    )
    if (invalidVariables.isNotEmpty()) {
        return PromptValidationResult.Error(
            message = "ä½¿ç”¨äº†æ— æ•ˆå˜é‡: ${invalidVariables.joinToString(", ")}",
            errorType = PromptValidationResult.ErrorType.INVALID_VARIABLES
        )
    }
    
    // 3. æ£€æŸ¥é•¿åº¦é™åˆ¶ï¼ˆæœ€å¿«ï¼‰
    if (prompt.length > MAX_PROMPT_LENGTH) {
        return PromptValidationResult.Error(
            message = "æç¤ºè¯é•¿åº¦ä¸èƒ½è¶…è¿‡${MAX_PROMPT_LENGTH}å­—ç¬¦ï¼Œå½“å‰${prompt.length}å­—ç¬¦",
            errorType = PromptValidationResult.ErrorType.EXCEEDS_LENGTH_LIMIT
        )
    }
    
    // 4. æ£€æŸ¥æ˜¯å¦æ¥è¿‘é•¿åº¦é™åˆ¶ï¼ˆè­¦å‘Šï¼‰
    if (prompt.length > WARNING_LENGTH_THRESHOLD) {
        return PromptValidationResult.Warning(
            message = "æç¤ºè¯é•¿åº¦æ¥è¿‘é™åˆ¶ï¼ˆ${prompt.length}/${MAX_PROMPT_LENGTH}ï¼‰",
            warningType = PromptValidationResult.WarningType.NEAR_LENGTH_LIMIT
        )
    }
    
    return PromptValidationResult.Success
}
```

### IC-009: PromptFileStorageä¸­å¹¶å‘è®¿é—®ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
PromptFileStorageç±»ä¸­readGlobalConfigå’ŒwriteGlobalConfigæ–¹æ³•éƒ½ä½¿ç”¨äº†Mutexï¼Œä½†invalidateCacheæ–¹æ³•æ²¡æœ‰åŒæ­¥ä¿æŠ¤ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/data/local/PromptFileStorage.kt:122-124`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
fun invalidateCache() {
    cachedConfig = null
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
suspend fun invalidateCache() {
    cacheLock.withLock {
        cachedConfig = null
    }
}
```

### IC-010: PromptBuilderä¸­å¸¸é‡ä½¿ç”¨ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
PromptBuilderç±»ä¸­CONTEXT_PLACEHOLDERå¸¸é‡å®šä¹‰åœ¨companion objectä¸­ï¼Œä½†åœ¨injectContextDataæ–¹æ³•ä¸­ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²å­—é¢é‡ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/util/PromptBuilder.kt:25, 89`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
companion object {
    private const val CONTEXT_PLACEHOLDER = "{{CONTEXT_DATA_PLACEHOLDER}}"
}

fun injectContextData(instruction: String, contextData: String): String {
    return instruction.replace(CONTEXT_PLACEHOLDER, contextData)
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
companion object {
    const val CONTEXT_PLACEHOLDER = "{{CONTEXT_DATA_PLACEHOLDER}}"
}

fun injectContextData(instruction: String, contextData: String): String {
    return instruction.replace(CONTEXT_PLACEHOLDER, contextData)
}
```

---

## ä¸‰ã€æ¶æ„åˆè§„æ€§æ£€æŸ¥ç»“æœ

### AC-001: æ•°æ®åº“è¿ç§»é€»è¾‘å¤æ‚

**é—®é¢˜æè¿°**ï¼š
æ ¹æ®TDD-00005è®¾è®¡ï¼Œæ•°æ®åº“è¿ç§»é€»è¾‘è¾ƒä¸ºå¤æ‚ï¼Œéœ€è¦æ·»åŠ custom_promptå­—æ®µå¹¶å¤„ç†ç°æœ‰æ•°æ®ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/data/local/AppDatabase.kt` (éœ€è¦æ·»åŠ MIGRATION_7_8)

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
// éœ€è¦æ·»åŠ çš„è¿ç§»é€»è¾‘
val MIGRATION_7_8 = object : Migration(7, 8) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL(
            "ALTER TABLE contact_profiles ADD COLUMN custom_prompt TEXT DEFAULT NULL"
        )
    }
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
val MIGRATION_7_8 = object : Migration(7, 8) {
    override fun migrate(database: SupportSQLiteDatabase) {
        // æ·»åŠ è‡ªå®šä¹‰æç¤ºè¯å­—æ®µ
        database.execSQL(
            "ALTER TABLE contact_profiles ADD COLUMN custom_prompt TEXT DEFAULT NULL"
        )
        
        // å¯é€‰ï¼šä¸ºæ–°å¢å­—æ®µæ·»åŠ ç´¢å¼•
        database.execSQL(
            "CREATE INDEX IF NOT EXISTS index_contact_profiles_custom_prompt " +
            "ON contact_profiles(custom_prompt)"
        )
    }
}
```

### AC-002: ä¾èµ–æ³¨å…¥é…ç½®å¯ä¼˜åŒ–

**é—®é¢˜æè¿°**ï¼š
PromptModuleä¸­çš„ä¾èµ–æ³¨å…¥é…ç½®å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œä¾‹å¦‚ä½¿ç”¨@Providesæ³¨è§£çš„é…ç½®å¯ä»¥æ›´ç®€æ´ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/di/PromptModule.kt` (éœ€è¦åˆ›å»º)

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
@Module
@InstallIn(SingletonComponent::class)
object PromptModule {

    @Provides
    @Singleton
    fun providePromptFileBackup(
        @ApplicationContext context: Context,
        @IoDispatcher ioDispatcher: CoroutineDispatcher
    ): PromptFileBackup {
        return PromptFileBackup(context, ioDispatcher)
    }

    @Provides
    @Singleton
    fun providePromptFileStorage(
        @ApplicationContext context: Context,
        moshi: Moshi,
        backup: PromptFileBackup,
        @IoDispatcher ioDispatcher: CoroutineDispatcher
    ): PromptFileStorage {
        return PromptFileStorage(context, moshi, backup, ioDispatcher)
    }

    @Provides
    @Singleton
    fun providePromptVariableResolver(): PromptVariableResolver {
        return PromptVariableResolver()
    }

    @Provides
    @Singleton
    fun providePromptValidator(
        variableResolver: PromptVariableResolver
    ): PromptValidator {
        return PromptValidator(variableResolver)
    }

    @Provides
    @Singleton
    fun providePromptRepository(
        fileStorage: PromptFileStorage,
        contactDao: ContactDao,
        validator: PromptValidator
    ): PromptRepository {
        return PromptRepositoryImpl(fileStorage, contactDao, validator)
    }

    @Provides
    @Singleton
    fun providePromptBuilder(
        promptRepository: PromptRepository,
        variableResolver: PromptVariableResolver
    ): PromptBuilder {
        return PromptBuilder(promptRepository, variableResolver)
    }
}
```

### AC-003: é”™è¯¯å¤„ç†ç­–ç•¥ä¸ç»Ÿä¸€

**é—®é¢˜æè¿°**ï¼š
æ•´ä¸ªæç¤ºè¯ç®¡ç†ç³»ç»Ÿçš„é”™è¯¯å¤„ç†ç­–ç•¥ä¸ç»Ÿä¸€ï¼Œæœ‰äº›ä½¿ç”¨Resultç±»å‹ï¼Œæœ‰äº›ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œæœ‰äº›ä½¿ç”¨å›è°ƒã€‚

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
// ç»Ÿä¸€é”™è¯¯å¤„ç†ç­–ç•¥
sealed class PromptError : Exception() {
    data class ValidationError(
        override val message: String,
        val errorType: PromptValidationResult.ErrorType
    ) : PromptError()
    
    data class StorageError(
        override val message: String,
        val cause: Throwable? = null
    ) : PromptError()
    
    data class ParseError(
        override val message: String,
        val jsonContent: String? = null
    ) : PromptError()
    
    data class BackupError(
        override val message: String
    ) : PromptError()
    
    data class DatabaseError(
        override val message: String,
        val cause: Throwable? = null
    ) : PromptError()
    
    fun getUserMessage(): String = when (this) {
        is ValidationError -> message
        is StorageError -> "ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•"
        is ParseError -> "é…ç½®æ–‡ä»¶æŸåï¼Œå·²æ¢å¤é»˜è®¤è®¾ç½®"
        is BackupError -> "å¤‡ä»½æ¢å¤å¤±è´¥"
        is DatabaseError -> "æ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•"
    }
}
```

---

## å››ã€ä»£ç è´¨é‡æ£€æŸ¥ç»“æœ

### CQ-001: ç¡¬ç¼–ç å­—ç¬¦ä¸²

**é—®é¢˜æè¿°**ï¼š
PromptBuilderç±»ä¸­å­˜åœ¨ç¡¬ç¼–ç çš„ä¸­æ–‡å­—ç¬¦ä¸²ï¼Œåº”è¯¥æå–ä¸ºå¸¸é‡æˆ–èµ„æºã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/util/PromptBuilder.kt:51, 62, 70`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
appendLine("ã€ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤ã€‘")
appendLine("ã€é’ˆå¯¹æ­¤è”ç³»äººçš„ç‰¹æ®ŠæŒ‡ä»¤ã€‘")
appendLine("ã€ä¸Šä¸‹æ–‡æ•°æ®ã€‘")
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
companion object {
    private const val CONTEXT_PLACEHOLDER = "{{CONTEXT_DATA_PLACEHOLDER}}"
    private const val USER_PROMPT_TITLE = "ã€ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤ã€‘"
    private const val CONTACT_PROMPT_TITLE = "ã€é’ˆå¯¹æ­¤è”ç³»äººçš„ç‰¹æ®ŠæŒ‡ä»¤ã€‘"
    private const val CONTEXT_DATA_TITLE = "ã€ä¸Šä¸‹æ–‡æ•°æ®ã€‘"
}

// åœ¨æ–¹æ³•ä¸­ä½¿ç”¨
appendLine(USER_PROMPT_TITLE)
appendLine(CONTACT_PROMPT_TITLE)
appendLine(CONTEXT_DATA_TITLE)
```

### CQ-002: å‚æ•°è¿‡å¤š

**é—®é¢˜æè¿°**ï¼š
PromptBuilderç±»ä¸­buildSystemInstructionå’ŒbuildSimpleInstructionæ–¹æ³•å‚æ•°è¿‡å¤šï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å‚æ•°å¯¹è±¡ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/util/PromptBuilder.kt:36-40, 102-106`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
suspend fun buildSystemInstruction(
    scene: PromptScene,
    contactId: String? = null,
    context: PromptContext
): String

suspend fun buildSimpleInstruction(
    scene: PromptScene,
    contactId: String? = null,
    context: PromptContext
): String
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
data class PromptBuildRequest(
    val scene: PromptScene,
    val contactId: String? = null,
    val context: PromptContext,
    val includeContextPlaceholder: Boolean = true
)

suspend fun buildInstruction(request: PromptBuildRequest): String {
    return buildInstructionBase(
        scene = request.scene,
        contactId = request.contactId,
        context = request.context,
        includeContextPlaceholder = request.includeContextPlaceholder
    )
}

suspend fun buildSystemInstruction(
    scene: PromptScene,
    contactId: String? = null,
    context: PromptContext
): String = buildInstruction(
    PromptBuildRequest(scene, contactId, context, includeContextPlaceholder = true)
)

suspend fun buildSimpleInstruction(
    scene: PromptScene,
    contactId: String? = null,
    context: PromptContext
): String = buildInstruction(
    PromptBuildRequest(scene, contactId, context, includeContextPlaceholder = false)
)
```

### CQ-003: å¤æ‚æ¡ä»¶è¡¨è¾¾å¼

**é—®é¢˜æè¿°**ï¼š
PromptContextç±»ä¸­fromContactæ–¹æ³•çš„æ¡ä»¶è¡¨è¾¾å¼è¿‡äºå¤æ‚ï¼Œå¯è¯»æ€§å·®ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/model/PromptContext.kt:49-55`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
val riskTags = contact.facts
    .filter { it.key == "é›·åŒº" || it.key.contains("é›·åŒº") }
    .map { it.value }

val strategyTags = contact.facts
    .filter { it.key == "ç­–ç•¥" || it.key.contains("ç­–ç•¥") }
    .map { it.value }
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
companion object {
    private const val RISK_ZONE_KEY = "é›·åŒº"
    private const val STRATEGY_KEY = "ç­–ç•¥"
    
    private fun isRiskZone(key: String): Boolean = 
        key == RISK_ZONE_KEY || key.contains(RISK_ZONE_KEY)
    
    private fun isStrategy(key: String): Boolean = 
        key == STRATEGY_KEY || key.contains(STRATEGY_KEY)
}

fun fromContact(contact: ContactProfile): PromptContext {
    val riskTags = contact.facts
        .filter { isRiskZone(it.key) }
        .map { it.value }

    val strategyTags = contact.facts
        .filter { isStrategy(it.key) }
        .map { it.value }

    return PromptContext(
        contactName = contact.name,
        relationshipStatus = contact.getRelationshipLevel().displayName,
        riskTags = riskTags,
        strategyTags = strategyTags,
        factsCount = contact.facts.size,
        todayDate = LocalDate.now().toString()
    )
}
```

---

## äº”ã€åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥ç»“æœ

### FC-001: æ ¸å¿ƒåŠŸèƒ½å·²å®Œæ•´å®ç°

**æ£€æŸ¥ç»“æœ**ï¼š
âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬ï¼š
- æç¤ºè¯åœºæ™¯å®šä¹‰ (PromptScene)
- å˜é‡ä¸Šä¸‹æ–‡ç®¡ç† (PromptContext)
- å…¨å±€é…ç½®ç®¡ç† (GlobalPromptConfig)
- æ–‡ä»¶å­˜å‚¨å’Œå¤‡ä»½ (PromptFileStorage, PromptFileBackup)
- å˜é‡è§£æ (PromptVariableResolver)
- æç¤ºè¯æ„å»º (PromptBuilder)
- è¾“å…¥éªŒè¯ (PromptValidator)
- å®‰å…¨è¿‡æ»¤ (PromptSanitizer)
- ä»“åº“æ¥å£å’Œå®ç° (PromptRepository, PromptRepositoryImpl)

---

## å…­ã€æ€§èƒ½é£é™©æ£€æŸ¥ç»“æœ

### PR-001: ç¼“å­˜ç­–ç•¥ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
PromptVariableResolverç±»ä¸­åªç¼“å­˜extractVariablesç»“æœï¼Œä¸ç¼“å­˜resolveç»“æœï¼Œä½†å®é™…ä½¿ç”¨ä¸­resolveå¯èƒ½è¢«é¢‘ç¹è°ƒç”¨ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/domain/util/PromptVariableResolver.kt:49-54`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
fun resolve(template: String, context: PromptContext): String {
    return VARIABLE_PATTERN.replace(template) { match ->
        val variableName = match.groupValues[1].lowercase()
        context.getVariable(variableName) ?: match.value
    }
}
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
// æ·»åŠ ç®€å•çš„LRUç¼“å­˜ï¼Œé™åˆ¶å¤§å°é¿å…å†…å­˜æ³„æ¼
private val resolveCache = LruCache<String, String>(20)

fun resolve(template: String, context: PromptContext): String {
    // ä½¿ç”¨æ¨¡æ¿å’Œå…³é”®contextå­—æ®µä½œä¸ºç¼“å­˜é”®
    val cacheKey = "${template}_${context.contactName}_${context.factsCount}"
    
    resolveCache.get(cacheKey)?.let { return it }
    
    val result = VARIABLE_PATTERN.replace(template) { match ->
        val variableName = match.groupValues[1].lowercase()
        context.getVariable(variableName) ?: match.value
    }
    
    resolveCache.put(cacheKey, result)
    return result
}
```

### PR-002: å¹¶å‘å®‰å…¨é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
PromptFileStorageç±»ä¸­çš„cachedConfigå­—æ®µä½¿ç”¨äº†@Volatileæ³¨è§£ï¼Œä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä»å¯èƒ½å­˜åœ¨ç«æ€æ¡ä»¶ã€‚

**ä»£ç ä½ç½®**ï¼š
`app/src/main/java/com/empathy/ai/data/local/PromptFileStorage.kt:38-40`

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
@Volatile
private var cachedConfig: GlobalPromptConfig? = null
private val cacheLock = Mutex()
```

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
// ä½¿ç”¨AtomicReferenceæä¾›æ›´å¼ºçš„çº¿ç¨‹å®‰å…¨ä¿è¯
private val cachedConfig = AtomicReference<GlobalPromptConfig?>(null)
private val cacheLock = Mutex()

suspend fun readGlobalConfig(): Result<GlobalPromptConfig> = withContext(ioDispatcher) {
    cachedConfig.get()?.let { return@withContext Result.success(it) }
    
    cacheLock.withLock {
        // åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼
        cachedConfig.get()?.let { return@withContext Result.success(it) }
        
        // ... åŠ è½½é€»è¾‘ ...
        
        val config = // åŠ è½½çš„é…ç½®
        cachedConfig.set(config)
        Result.success(config)
    }
}
```

---

## ä¸ƒã€å®‰å…¨åˆè§„æ£€æŸ¥ç»“æœ

### SC-001: å®‰å…¨æ£€æŸ¥é€šè¿‡

**æ£€æŸ¥ç»“æœ**ï¼š
âœ… æœªå‘ç°æ˜æ˜¾å®‰å…¨é—®é¢˜ï¼ŒåŒ…æ‹¬ï¼š
- PromptSanitizeræä¾›äº†åŸºæœ¬çš„æ³¨å…¥æ”»å‡»é˜²æŠ¤
- æ–‡ä»¶æ“ä½œä½¿ç”¨äº†é€‚å½“çš„å¼‚å¸¸å¤„ç†
- æ•°æ®åº“æ“ä½œä½¿ç”¨äº†å‚æ•°åŒ–æŸ¥è¯¢
- æ•æ„Ÿæ•°æ®æ²¡æœ‰ç¡¬ç¼–ç åœ¨ä»£ç ä¸­

---

## å…«ã€æµ‹è¯•è¦†ç›–æ£€æŸ¥ç»“æœ

### TC-001: ç¼ºå°‘ç›¸å…³æµ‹è¯•æ–‡ä»¶

**é—®é¢˜æè¿°**ï¼š
æ ¹æ®TD-00005ä»»åŠ¡æ¸…å•ï¼Œéœ€è¦åˆ›å»ºå¤šä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œä½†ç›®å‰å°šæœªåˆ›å»ºã€‚

**ä»£ç ä½ç½®**ï¼š
`test/` å’Œ `androidTest/` ç›®å½•

**ä¿®å¤å»ºè®®ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
// éœ€è¦åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶åˆ—è¡¨
test/testutil/PromptTestDataFactory.kt
test/domain/model/PromptSceneTest.kt
test/domain/model/PromptContextTest.kt
test/domain/model/GlobalPromptConfigTest.kt
test/domain/model/PromptErrorTest.kt
test/domain/util/PromptVariableResolverTest.kt
test/domain/util/PromptValidatorTest.kt
test/domain/util/PromptSanitizerTest.kt
test/domain/util/PromptBuilderTest.kt
test/data/local/PromptFileStorageTest.kt
test/data/local/PromptFileBackupTest.kt
test/data/repository/PromptRepositoryImplTest.kt
androidTest/data/local/DatabaseMigration7To8Test.kt
```

---

## ğŸ”§ ä¿®å¤ä¼˜å…ˆçº§æ±‡æ€»

### P1 - å¿…é¡»ä¿®å¤ï¼ˆé˜»å¡å‘å¸ƒï¼‰
1. **IC-001**: PromptRepositoryæ¥å£ä¸å®ç°è¿”å›ç±»å‹ä¸ä¸€è‡´
2. **IC-003**: PromptContext.getVariable()æ–¹æ³•ä¸å®Œæ•´å®ç°
3. **IC-004**: PromptBuilderä¸­Resultå¤„ç†ä¸ä¸€è‡´
4. **IC-009**: PromptFileStorageä¸­å¹¶å‘è®¿é—®ä¸ä¸€è‡´

### P2 - å»ºè®®ä¿®å¤ï¼ˆå½±å“è´¨é‡ï¼‰
1. **OD-001**: PromptVariableResolverè¿‡åº¦ç¼“å­˜å¤æ‚æ€§
2. **OD-004**: PromptBuilderæ–¹æ³•é‡å¤å®ç°
3. **OD-006**: PromptRepositoryImplé‡å¤é…ç½®æ›´æ–°é€»è¾‘
4. **IC-002**: PromptFileStorageè¿”å›ç±»å‹ä¸ä¸€è‡´
5. **IC-005**: PromptRepositoryImplä¸­é”™è¯¯å¤„ç†ä¸ä¸€è‡´
6. **PR-001**: ç¼“å­˜ç­–ç•¥ä¸ä¸€è‡´
7. **PR-002**: å¹¶å‘å®‰å…¨é—®é¢˜
8. **TC-001**: ç¼ºå°‘ç›¸å…³æµ‹è¯•æ–‡ä»¶

### P3 - å¯é€‰ä¼˜åŒ–
1. **OD-002**: PromptFileStorageå¤šå±‚å¤‡ä»½æœºåˆ¶
2. **OD-003**: PromptFileBackupè¿‡åº¦è®¾è®¡
3. **OD-005**: PromptFileStorageå¤æ‚JSONè§£æ
4. **OD-007**: PromptSanitizerè¿‡åº¦åŒ¹é…æ¨¡å¼
5. **OD-008**: PromptValidatorè¿‡åº¦éªŒè¯è§„åˆ™
6. **IC-006**: PromptFileBackupä¸­æ–‡ä»¶æ“ä½œä¸ä¸€è‡´
7. **IC-007**: PromptVariableResolverä¸­ç¼“å­˜é”®ä¸ä¸€è‡´
8. **IC-008**: PromptValidatorä¸­éªŒè¯é¡ºåºä¸ä¸€è‡´
9. **IC-010**: PromptBuilderä¸­å¸¸é‡ä½¿ç”¨ä¸ä¸€è‡´
10. **AC-001**: æ•°æ®åº“è¿ç§»é€»è¾‘å¤æ‚
11. **AC-002**: ä¾èµ–æ³¨å…¥é…ç½®å¯ä¼˜åŒ–
12. **AC-003**: é”™è¯¯å¤„ç†ç­–ç•¥ä¸ç»Ÿä¸€
13. **CQ-001**: ç¡¬ç¼–ç å­—ç¬¦ä¸²
14. **CQ-002**: å‚æ•°è¿‡å¤š
15. **CQ-003**: å¤æ‚æ¡ä»¶è¡¨è¾¾å¼

---

## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

| é—®é¢˜ç±»åˆ« | é—®é¢˜æ•°é‡ | P1 | P2 | P3 |
|---------|---------|----|----|----|
| è¿‡åº¦è®¾è®¡ | 8 | 0 | 3 | 5 |
| æ¥å£ä¸€è‡´æ€§ | 10 | 4 | 3 | 3 |
| æ¶æ„åˆè§„æ€§ | 3 | 0 | 0 | 3 |
| ä»£ç è´¨é‡ | 3 | 0 | 0 | 3 |
| åŠŸèƒ½å®Œæ•´æ€§ | 0 | 0 | 0 | 0 |
| æ€§èƒ½é£é™© | 2 | 0 | 2 | 0 |
| å®‰å…¨åˆè§„ | 0 | 0 | 0 | 0 |
| æµ‹è¯•è¦†ç›– | 1 | 0 | 1 | 0 |
| **æ€»è®¡** | **27** | **4** | **9** | **14** |

---

## å®¡æŸ¥ç»“è®º

TD00005é˜¶æ®µ1-3çš„ä»£ç å®ç°åŸºæœ¬å®Œæˆäº†æç¤ºè¯ç®¡ç†ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†å­˜åœ¨è¾ƒå¤šè®¾è®¡å’Œå®ç°é—®é¢˜ï¼Œä¸»è¦é›†ä¸­åœ¨è¿‡åº¦è®¾è®¡ã€æ¥å£ä¸€è‡´æ€§å’Œæ€§èƒ½é£é™©æ–¹é¢ã€‚

**ä¸»è¦é—®é¢˜**ï¼š
1. **è¿‡åº¦è®¾è®¡**ï¼šéƒ¨åˆ†ç»„ä»¶å®ç°äº†è¿‡äºå¤æ‚çš„åŠŸèƒ½ï¼Œå¦‚å¤šå±‚å¤‡ä»½æœºåˆ¶ã€è¿‡åº¦ç¼“å­˜ç­‰
2. **æ¥å£ä¸ä¸€è‡´**ï¼šå¤šä¸ªæ¥å£ä¸å®ç°ä¹‹é—´å­˜åœ¨ç±»å‹ä¸åŒ¹é…ã€è¿”å›å€¼ä¸ä¸€è‡´ç­‰é—®é¢˜
3. **æ€§èƒ½é£é™©**ï¼šç¼“å­˜ç­–ç•¥ä¸ä¸€è‡´ã€å¹¶å‘å®‰å…¨é—®é¢˜å¯èƒ½å½±å“ç³»ç»Ÿæ€§èƒ½

**å»ºè®®**ï¼š
1. ä¼˜å…ˆä¿®å¤P1çº§åˆ«é—®é¢˜ï¼Œç¡®ä¿æ¥å£ä¸€è‡´æ€§å’Œå¹¶å‘å®‰å…¨
2. ç®€åŒ–è¿‡åº¦è®¾è®¡çš„ç»„ä»¶ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§
3. è¡¥å……å¿…è¦çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæé«˜ä»£ç è´¨é‡
4. ç»Ÿä¸€é”™è¯¯å¤„ç†ç­–ç•¥ï¼Œæé«˜ç³»ç»Ÿå¥å£®æ€§

**æ•´ä½“è¯„åˆ†**: 5.5/10 (éœ€æ”¹è¿›)