# CR-00021: TD20è”ç³»äººè¯¦æƒ…é¡µUIä¼˜åŒ–ä»£ç å®¡æŸ¥æŠ¥å‘Š

> **æ–‡æ¡£ç±»å‹**: ä»£ç å®¡æŸ¥æŠ¥å‘Š (CR)
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-26
> **å®¡æŸ¥äºº**: Roo
> **çŠ¶æ€**: âœ… P1é—®é¢˜å·²ä¿®å¤
> **ä¿®å¤æ—¥æœŸ**: 2025-12-26
> **å®¡æŸ¥èŒƒå›´**: TD-20è”ç³»äººè¯¦æƒ…é¡µUIä¼˜åŒ–ä»£ç 
> **å…³è”æ–‡æ¡£**: TD-00020ã€TDD-00020ã€CN-00003

---

## ğŸ”§ ä¿®å¤è®°å½• (2025-12-26)

### âœ… å·²ä¿®å¤çš„P1é—®é¢˜

| ç¼–å· | é—®é¢˜ | ä¿®å¤å†…å®¹ | æ–‡ä»¶ |
|------|------|----------|------|
| IC-001 | EmotionTimelineView keyä¸ç¨³å®š | ä½¿ç”¨å¤åˆkey `"${item.id}_${item.timestamp}"` | EmotionTimelineView.kt:62 |
| IC-002 | ContactDetailViewModelç©ºå®ç° | å®ç°confirmTagå’ŒrejectTagæ–¹æ³•ï¼Œä½¿ç”¨timestampåŒ¹é… | ContactDetailViewModel.kt:1097-1145 |
| CQ-001 | ç¡¬ç¼–ç å­—ç¬¦ä¸² | ä½¿ç”¨stringResource(R.string.label_days_known) | OverviewTab.kt:237 |

### ä¿®å¤è¯¦æƒ…

1. **IC-001 EmotionTimelineView keyç¨³å®šæ€§ä¿®å¤**
   - åŸä»£ç ï¼š`key = { _, item -> item.id }`
   - ä¿®å¤åï¼š`key = { _, item -> "${item.id}_${item.timestamp}" }`
   - æ·»åŠ æ³¨é‡Šè¯´æ˜å¤åˆkeyçš„ç”¨é€”

2. **IC-002 æ ‡ç­¾ç¡®è®¤/æ‹’ç»åŠŸèƒ½å®ç°**
   - å®ç°confirmTagæ–¹æ³•ï¼šä½¿ç”¨timestampåŒ¹é…Factï¼Œå°†sourceæ”¹ä¸ºMANUAL
   - å®ç°rejectTagæ–¹æ³•ï¼šä½¿ç”¨timestampè¿‡æ»¤ç§»é™¤è¢«æ‹’ç»çš„æ ‡ç­¾
   - æ·»åŠ FactSourceå¯¼å…¥
   - ä¸ContactDetailTabViewModelä¿æŒä¸€è‡´çš„å®ç°é€»è¾‘

3. **CQ-001 ç¡¬ç¼–ç å­—ç¬¦ä¸²å›½é™…åŒ–**
   - åŸä»£ç ï¼š`"ç›¸è¯† $daysSinceFirstMet å¤©"`
   - ä¿®å¤åï¼š`stringResource(R.string.label_days_known, daysSinceFirstMet)`
   - æ·»åŠ stringResourceå’ŒRçš„å¯¼å…¥

---

## ğŸ“Š å®¡æŸ¥ç»“æœæ‘˜è¦

| å®¡æŸ¥é¡¹ | çŠ¶æ€ | é—®é¢˜æ•° | è¯´æ˜ |
|--------|------|--------|------|
| ğŸ”´ è¿‡åº¦è®¾è®¡æ£€æµ‹ | âš ï¸ ä¸­é£é™© | 3 | å‘ç°3å¤„è¿‡åº¦è®¾è®¡é—®é¢˜ï¼Œä¸»è¦æ˜¯ViewModelèŒè´£è¿‡äºé›†ä¸­ |
| ğŸ”´ æ¥å£ä¸€è‡´æ€§éªŒè¯ | âš ï¸ é«˜é£é™© | 2 | å‘ç°æ¥å£å®ç°ä¸å®šä¹‰ä¸åŒ¹é…çš„é—®é¢˜ |
| æ¶æ„åˆè§„æ€§æ£€æŸ¥ | âœ… ä½é£é™© | 1 | æ•´ä½“æ¶æ„ç¬¦åˆClean Architecture |
| ä»£ç è´¨é‡æ£€æŸ¥ | âš ï¸ ä¸­é£é™© | 4 | å‘ç°ç¡¬ç¼–ç ã€æ³¨é‡Šç¼ºå¤±ç­‰é—®é¢˜ |
| åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥ | âš ï¸ ä¸­é£é™© | 3 | å­˜åœ¨å¤šå¤„TODOæ ‡è®°å’Œç©ºå®ç° |
| æ€§èƒ½é£é™©æ£€æŸ¥ | âš ï¸ ä½é£é™© | 2 | Canvasç¼“å­˜å’Œåˆ—è¡¨ä¼˜åŒ–åŸºæœ¬åˆ°ä½ |
| å®‰å…¨åˆè§„æ£€æŸ¥ | âœ… ä½é£é™© | 1 | æœªå‘ç°æ˜æ˜¾å®‰å…¨é—®é¢˜ |
| æµ‹è¯•è¦†ç›–æ£€æŸ¥ | âš ï¸ é«˜é£é™© | 7 | ç¼ºå°‘é¡µé¢é—´å¯¼èˆªçš„é›†æˆæµ‹è¯• |

**æ•´ä½“è¯„åˆ†**: 6.5/10 ([åˆæ ¼/è‰¯å¥½])

---

## ä¸€ã€ğŸ”´ è¿‡åº¦è®¾è®¡æ£€æµ‹ç»“æœ

### âœ… è®¾è®¡åˆç†

1. **ç»„ä»¶è®¾è®¡åˆç†**
   - IOSSegmentedControlä½¿ç”¨ç®€æ´çš„åŠ¨ç”»å®ç°ï¼Œæ²¡æœ‰è¿‡åº¦æŠ½è±¡
   - HealthRingChartä½¿ç”¨rememberç¼“å­˜Brushå¯¹è±¡ï¼Œæ€§èƒ½ä¼˜åŒ–åˆ°ä½
   - EmotionTimelineViewä½¿ç”¨LazyColumnå®ç°è™šæ‹ŸåŒ–åˆ—è¡¨ï¼Œæ¶æ„åˆç†

2. **æ•°æ®æ¨¡å‹è®¾è®¡ç®€æ´**
   - TimelineItemæ•°æ®ç±»è®¾è®¡åˆç†ï¼ŒåŒ…å«å¿…è¦çš„å­—æ®µ
   - EmotionTypeæšä¸¾æ¸…æ™°ï¼Œä¸é¢œè‰²ç³»ç»Ÿé…åˆè‰¯å¥½

### âŒ è¿‡åº¦è®¾è®¡é—®é¢˜

#### OD-001: ContactDetailViewModelèŒè´£è¿‡åº¦é›†ä¸­

**é—®é¢˜æè¿°**: ViewModelåŒ…å«1126è¡Œä»£ç ï¼Œè¿åå•ä¸€èŒè´£åŸåˆ™

**ä»£ç ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/ContactDetailViewModel.kt:1-1126è¡Œ`

**é—®é¢˜è¯¦æƒ…**:
- æ··åˆäº†æ•°æ®ç®¡ç†ã€UIçŠ¶æ€ç®¡ç†ã€äº‹ä»¶å¤„ç†ã€ç¼–è¾‘åŠŸèƒ½ã€æœç´¢è¿‡æ»¤ç­‰å¤šä¸ªèŒè´£
- æ–¹æ³•è¿‡é•¿ï¼š`onEvent`æ–¹æ³•é•¿è¾¾198è¡Œï¼ŒåŒ…å«è¿‡å¤šçš„if-elseåˆ†æ”¯
- çŠ¶æ€ç®¡ç†æ··ä¹±ï¼šUIçŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘æ··åˆåœ¨åŒä¸€ä¸ªç±»ä¸­

**ç®€åŒ–å»ºè®®**:
```kotlin
// å»ºè®®æ‹†åˆ†ä¸ºå¤šä¸ªViewModel
// 1. ContactDetailCoreViewModel - åŸºç¡€æ•°æ®ç®¡ç†
// 2. ContactDetailEditViewModel - ç¼–è¾‘åŠŸèƒ½ç®¡ç†
// 3. ContactDetailFilterViewModel - æœç´¢å’Œç­›é€‰ç®¡ç†
// 4. ContactDetailDialogViewModel - å¯¹è¯æ¡†çŠ¶æ€ç®¡ç†

// ç¤ºä¾‹æ‹†åˆ†åçš„onEventæ–¹æ³•
class ContactDetailCoreViewModel {
    fun onEvent(event: ContactDetailUiEvent) {
        when (event) {
            is ContactDetailUiEvent.LoadContact -> loadContact(event.contactId)
            is ContactDetailUiEvent.SaveContact -> saveContact(event.contact)
            // åªå¤„ç†æ ¸å¿ƒäº‹ä»¶
        }
    }
}
```

**ç®€åŒ–ç†ç”±**: æ‹†åˆ†åæ¯ä¸ªViewModelèŒè´£å•ä¸€ï¼Œä»£ç æ›´æ˜“ç»´æŠ¤å’Œæµ‹è¯•

#### OD-002: ContactDetailUiStateè¿‡åº¦å¤æ‚

**é—®é¢˜æè¿°**: UiStateåŒ…å«è¿‡å¤šè®¡ç®—å±æ€§å’Œæ´¾ç”ŸçŠ¶æ€

**ä»£ç ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactDetailUiState.kt:1-509è¡Œ`

**é—®é¢˜è¯¦æƒ…**:
- åŒ…å«509è¡Œä»£ç ï¼Œå®šä¹‰è¿‡å¤šè®¡ç®—å±æ€§
- æ´¾ç”ŸçŠ¶æ€è¿‡å¤šï¼šå¦‚`filteredTimelineItems`ç­‰å¯é€šè¿‡ç®€å•è®¡ç®—å¾—å‡º
- æ··åˆèŒè´£ï¼šUIçŠ¶æ€ä¸ä¸šåŠ¡é€»è¾‘æ··åˆ

**ç®€åŒ–å»ºè®®**:
```kotlin
// å»ºè®®æå–è®¡ç®—å±æ€§åˆ°ç‹¬ç«‹çš„Composableå‡½æ•°
// ç¤ºä¾‹ï¼šå°†filteredTimelineItemsæå–ä¸ºè®¡ç®—å±æ€§

@Composable
fun rememberFilteredTimelineItems(
    items: List<TimelineItem>,
    selectedFilter: FilterType
): List<TimelineItem> {
    return remember(items, selectedFilter) {
        when (selectedFilter) {
            FilterType.ALL -> items
            FilterType.SWEET -> items.filter { it.emotionType == EmotionType.SWEET }
            // å…¶ä»–ç­›é€‰æ¡ä»¶...
        }
    }
}
```

#### OD-003: æ¥å£å®ç°å†—ä½™

**é—®é¢˜æè¿°**: FactStreamTabå’ŒPersonaTabä¸­å­˜åœ¨é‡å¤çš„ç­›é€‰é€»è¾‘

**ä»£ç ä½ç½®**: 
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/factstream/FactStreamTab.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/persona/PersonaTab.kt`

**é—®é¢˜è¯¦æƒ…**:
- ä»£ç é‡å¤ï¼šç›¸åŒçš„ç­›é€‰é€»è¾‘åœ¨å¤šå¤„é‡å¤å®ç°
- ç»´æŠ¤å›°éš¾ï¼šä¿®æ”¹ç­›é€‰é€»è¾‘éœ€è¦åŒæ—¶æ›´æ–°å¤šä¸ªæ–‡ä»¶

**ç®€åŒ–å»ºè®®**:
```kotlin
// å»ºè®®æå–é€šç”¨ç­›é€‰ç»„ä»¶
@Composable
fun CommonFilterRow(
    filters: List<FilterType>,
    selectedFilter: FilterType,
    onFilterSelected: (FilterType) -> Unit
) {
    // ç»Ÿä¸€çš„ç­›é€‰å®ç°
}
```

---

## äºŒã€ğŸ”´ æ¥å£ä¸€è‡´æ€§éªŒè¯ç»“æœ

### æ¥å£-å®ç°å¯¹ç…§è¡¨

| æ¥å£ | å®ç°ç±» | æ–¹æ³•æ•° | çŠ¶æ€ |
|------|--------|--------|------|
| TimelineItem | TimelineItem.kt | 7 | âœ… |
| EmotionTimelineView | EmotionTimelineView.kt | 1 | âœ… |
| HealthRingChart | HealthRingChart.kt | 2 | âœ… |

### âœ… ä¸€è‡´çš„å®ç°

1. **æ•°æ®æ¨¡å‹ä¸€è‡´**
   - TimelineItemæ•°æ®ç±»å®Œæ•´å®ç°äº†æ‰€æœ‰å¿…è¦å­—æ®µ
   - EmotionTypeæšä¸¾ä¸é¢œè‰²ç³»ç»ŸåŒ¹é…è‰¯å¥½

2. **ç»„ä»¶æ¥å£ä¸€è‡´**
   - EmotionTimelineViewæ­£ç¡®å®ç°äº†LazyColumnè™šæ‹ŸåŒ–åˆ—è¡¨
   - HealthRingChartä½¿ç”¨rememberç¼“å­˜ä¼˜åŒ–æ€§èƒ½

### âŒ ä¸ä¸€è‡´é—®é¢˜

#### IC-001: EmotionTimelineView keyä¸ç¨³å®š

**æ¥å£å®šä¹‰**: TDD-00020è¦æ±‚ä½¿ç”¨ç¨³å®šçš„keyä¼˜åŒ–diffç®—æ³•

**å®é™…å®ç°** (`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/timeline/EmotionTimelineView.kt:62è¡Œ`):
```kotlin
key = { _, item -> item.id }
```

**é—®é¢˜ç±»å‹**: æ½œåœ¨çš„keyç¨³å®šæ€§é—®é¢˜

**é—®é¢˜è¯¦æƒ…**:
- TimelineItem.idå¯èƒ½ä¸å”¯ä¸€ï¼ˆç‰¹åˆ«æ˜¯æ–°å»ºé¡¹ç›®æ—¶ä½¿ç”¨UUIDï¼‰
- åœ¨æ•°æ®æ›´æ–°æ—¶å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„é‡ç»„

**ä¿®å¤å»ºè®®**:
```kotlin
// å»ºè®®ä½¿ç”¨å¤åˆkeyç¡®ä¿ç¨³å®šæ€§
key = { _, item -> "${item.id}_${item.timestamp}" }

// æˆ–è€…ä½¿ç”¨data classç¡®ä¿å”¯ä¸€æ€§
data class TimelineItemKey(
    val id: String,
    val timestamp: Long
)
```

#### IC-002: ContactDetailViewModelç©ºå®ç°

**æ¥å£å®šä¹‰**: ViewModelåº”å®ç°æ‰€æœ‰ä¸šåŠ¡é€»è¾‘æ–¹æ³•

**å®é™…å®ç°** (`presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/ContactDetailViewModel.kt:1097-1107è¡Œ`):
```kotlin
private fun confirmTag(factId: Long) {
    // TODO: å®ç°æ ‡ç­¾ç¡®è®¤é€»è¾‘
    _uiState.update { it.copy(successMessage = "æ ‡ç­¾å·²ç¡®è®¤") }
}

private fun rejectTag(factId: Long) {
    // TODO: å®ç°æ ‡ç­¾æ‹’ç»é€»è¾‘
    _uiState.update { it.copy(successMessage = "æ ‡ç­¾å·²æ‹’ç»") }
}
```

**é—®é¢˜ç±»å‹**: ç©ºå®ç°æ–¹æ³•

**é—®é¢˜è¯¦æƒ…**:
- å…³é”®ä¸šåŠ¡é€»è¾‘æœªå®ç°ï¼Œåªæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
- å¯èƒ½å¯¼è‡´åŠŸèƒ½ä¸å®Œæ•´

**ä¿®å¤å»ºè®®**:
```kotlin
private fun confirmTag(factId: Long) {
    viewModelScope.launch {
        try {
            // å®é™…çš„æ ‡ç­¾ç¡®è®¤é€»è¾‘
            confirmTagUseCase(factId).onSuccess {
                _uiState.update { it.copy(successMessage = "æ ‡ç­¾å·²ç¡®è®¤") }
            }.onFailure { error ->
                _uiState.update { it.copy(error = error.message) }
            }
        } catch (e: Exception) {
            _uiState.update { it.copy(error = e.message) }
        }
    }
}
```

---

## ä¸‰ã€æ¶æ„åˆè§„æ€§æ£€æŸ¥ç»“æœ

### âœ… åˆè§„é¡¹

1. **Clean Architectureåˆ†å±‚æ¸…æ™°**
   - presentationå±‚åªä¾èµ–domainå±‚ï¼Œç¬¦åˆä¾èµ–æ–¹å‘
   - ViewModelæ­£ç¡®ä½¿ç”¨UseCaseå¤„ç†ä¸šåŠ¡é€»è¾‘
   - UIç»„ä»¶ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»è‰¯å¥½

2. **MVVMæ¨¡å¼å®ç°æ­£ç¡®**
   - ä½¿ç”¨StateFlowç®¡ç†UIçŠ¶æ€
   - äº‹ä»¶å¤„ç†é€šè¿‡onEventç»Ÿä¸€å…¥å£
   - çŠ¶æ€ä¸å¯å˜æ€§ä¿è¯

3. **ä¾èµ–æ³¨å…¥è§„èŒƒ**
   - ä½¿ç”¨@HiltViewModelæ³¨è§£
   - æ„é€ å‡½æ•°æ³¨å…¥UseCase

### âŒ ä¸åˆè§„é¡¹

#### AR-001: åŒ…ç»“æ„è½»å¾®åå·®

**é—®é¢˜æè¿°**: éƒ¨åˆ†ç»„ä»¶æ”¾ç½®ä½ç½®ä¸TDD-00020è§„èŒƒä¸å®Œå…¨ä¸€è‡´

**ä»£ç ä½ç½®**: 
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/persona/` (å­˜åœ¨PersonaTab.ktå’ŒPersonaTabV2.kt)
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/timeline/` (å­˜åœ¨TimelineView.ktå’ŒEmotionTimelineView.kt)

**é—®é¢˜è¯¦æƒ…**:
- å­˜åœ¨é‡å¤æˆ–ç‰ˆæœ¬å†²çªçš„ç»„ä»¶
- å¯èƒ½å¯¼è‡´ç»´æŠ¤å›°éš¾

**ä¿®å¤å»ºè®®**:
```kotlin
// å»ºè®®æ¸…ç†é‡å¤ç»„ä»¶
// 1. ç¡®å®šä½¿ç”¨çš„ç‰ˆæœ¬ï¼Œåˆ é™¤æ—§ç‰ˆæœ¬
// 2. ç»Ÿä¸€å‘½åè§„èŒƒï¼Œé¿å…V2åç¼€
// 3. æ›´æ–°ç›¸å…³å¼•ç”¨
```

---

## å››ã€ä»£ç è´¨é‡æ£€æŸ¥ç»“æœ

### âœ… åˆè§„é¡¹

1. **å‘½åè§„èŒƒè‰¯å¥½**
   - ç±»åã€æ–¹æ³•åç¬¦åˆKotlinçº¦å®š
   - ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å

2. **ç±»å‹å®‰å…¨**
   - å¤§é‡ä½¿ç”¨nullableç±»å‹æ­£ç¡®å¤„ç†
   - ä½¿ç”¨sealed classå®šä¹‰äº‹ä»¶ç±»å‹

3. **é”™è¯¯å¤„ç†**
   - ViewModelä¸­ä½¿ç”¨try-catchå¤„ç†å¼‚å¸¸
   - ä½¿ç”¨Resultç±»å‹åŒ…è£…è¿”å›å€¼

### âš ï¸ è­¦å‘Šé¡¹

#### CQ-001: ç¡¬ç¼–ç å­—ç¬¦ä¸²

**ä»£ç ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/overview/OverviewTab.kt:237è¡Œ`

**é—®é¢˜ä»£ç **:
```kotlin
Text(
    text = "ç›¸è¯† $daysSinceFirstMet å¤©",
    fontSize = 14.sp,
    color = iOSTextSecondary
)
```

**é—®é¢˜è¯¦æƒ…**:
- ç¡¬ç¼–ç ä¸­æ–‡å­—ç¬¦ä¸²ï¼Œä¸åˆ©äºå›½é™…åŒ–
- ç»´æŠ¤å›°éš¾ï¼Œä¿®æ”¹éœ€è¦å¤šå¤„æ›´æ–°

**ä¿®å¤å»ºè®®**:
```kotlin
// å»ºè®®ä½¿ç”¨å­—ç¬¦ä¸²èµ„æº
Text(
    text = stringResource(R.string.days_since_met, daysSinceFirstMet),
    fontSize = 14.sp,
    color = iOSTextSecondary
)
```

#### CQ-002: æ³¨é‡Šç¼ºå¤±

**ä»£ç ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/ContactDetailViewModel.kt`

**é—®é¢˜è¯¦æƒ…**:
- å¤æ‚çš„onEventæ–¹æ³•ç¼ºå°‘æ³¨é‡Šè¯´æ˜å„åˆ†æ”¯ç”¨é€”
- éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘ç¼ºå°‘è§£é‡Š

**ä¿®å¤å»ºè®®**:
```kotlin
/**
 * ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†å…¥å£
 * 
 * è®¾è®¡æ„å›¾ï¼š
 * 1. å•ä¸€å…¥å£ï¼Œä¾¿äºè¿½è¸ªå’Œè°ƒè¯•
 * 2. ä½¿ç”¨whenè¡¨è¾¾å¼æ›¿ä»£if-elseé“¾
 */
fun onEvent(event: ContactDetailUiEvent) {
    when (event) {
        is ContactDetailUiEvent.LoadContact -> {
            // åŠ è½½è”ç³»äººè¯¦æƒ…
            loadContact(event.contactId)
        }
        // å…¶ä»–äº‹ä»¶...
    }
}
```

#### CQ-003: æ–¹æ³•è¿‡é•¿

**ä»£ç ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/ContactDetailViewModel.kt:67-194è¡Œ`

**é—®é¢˜è¯¦æƒ…**:
- `onEvent`æ–¹æ³•é•¿è¾¾198è¡Œ
- `loadContact`æ–¹æ³•åŒ…å«è¿‡å¤šé€»è¾‘

**ä¿®å¤å»ºè®®**:
```kotlin
// å»ºè®®æ‹†åˆ†å¤§æ–¹æ³•
fun onEvent(event: ContactDetailUiEvent) {
    when (event) {
        is ContactDetailUiEvent.LoadContact -> handleLoadContact(event)
        is ContactDetailUiEvent.SaveContact -> handleSaveContact(event)
        // å…¶ä»–äº‹ä»¶...
    }
}

private fun handleLoadContact(event: ContactDetailUiEvent.LoadContact) {
    // å…·ä½“çš„åŠ è½½é€»è¾‘
}
```

---

## äº”ã€åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥ç»“æœ

### âœ… å·²å®ç°åŠŸèƒ½

1. **æ ¸å¿ƒç»„ä»¶å®Œæ•´**
   - IOSSegmentedControlå®ç°å®Œæ•´
   - HealthRingChartæ”¯æŒåŠ¨ç”»å’Œæ¸å˜
   - EmotionTimelineViewæ”¯æŒè™šæ‹ŸåŒ–åˆ—è¡¨

2. **é¡µé¢é‡å†™å®Œæˆ**
   - OverviewTabå®ç°iOSé£æ ¼è®¾è®¡
   - FactStreamTabæ”¯æŒæ—¶å…‰è½´å’Œåˆ—è¡¨è§†å›¾
   - PersonaTabæ”¯æŒæ ‡ç­¾ç®¡ç†

### âŒ æœªå®ç°/ç©ºå®ç°

#### FI-001: TODOæ ‡è®°æœªæ¸…ç†

**ä»£ç ä½ç½®**: å¤šä¸ªæ–‡ä»¶ä¸­å­˜åœ¨æœªå®Œæˆçš„TODOæ ‡è®°

**é—®é¢˜è¯¦æƒ…**:
- `ContactDetailViewModel.kt:1097-1107è¡Œ` - æ ‡ç­¾ç¡®è®¤/æ‹’ç»é€»è¾‘æœªå®ç°
- `OverviewTab.kt:114-116è¡Œ` - å¿«é€Ÿæ“ä½œæŒ‰é’®åŠŸèƒ½æœªå®ç°

**ä¿®å¤å»ºè®®**:
```kotlin
// å®ç°å¿«é€Ÿæ“ä½œæŒ‰é’®åŠŸèƒ½
private fun handleCallAction() {
    // å®ç°æ‹¨å·é€»è¾‘
    val intent = Intent(Intent.ACTION_CALL).apply {
        data = Uri.parse("tel:${contact.phone}")
    }
    context.startActivity(intent)
}
```

#### FI-002: ç©ºå®ç°æ–¹æ³•

**ä»£ç ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/timeline/TimelineCard.kt`

**é—®é¢˜è¯¦æƒ…**:
- éƒ¨åˆ†æ–¹æ³•ä½“ä¸ºç©ºæˆ–åªè¿”å›é»˜è®¤å€¼
- å¯èƒ½å¯¼è‡´UIæ˜¾ç¤ºå¼‚å¸¸

**ä¿®å¤å»ºè®®**:
```kotlin
// ç¡®ä¿æ‰€æœ‰æ–¹æ³•æœ‰å®é™…å®ç°
@Composable
fun TimelineCard(
    item: TimelineItem,
    onClick: () -> Unit
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .clickable(onClick = onClick),
        // å®Œæ•´çš„å¡ç‰‡å®ç°
    ) {
        // å®é™…å†…å®¹å®ç°
    }
}
```

---

## å…­ã€æ€§èƒ½é£é™©æ£€æŸ¥ç»“æœ

### âœ… æ— é£é™©é¡¹

1. **Canvasç¼“å­˜ä¼˜åŒ–**
   - HealthRingChartä½¿ç”¨rememberç¼“å­˜Brushå¯¹è±¡
   - é¿å…æ¯æ¬¡é‡ç»„åˆ›å»ºæ–°å¯¹è±¡

2. **åˆ—è¡¨è™šæ‹ŸåŒ–**
   - EmotionTimelineViewä½¿ç”¨LazyColumn
   - æä¾›ç¨³å®šçš„keyä¼˜åŒ–diffç®—æ³•

3. **åŠ¨ç”»ä¼˜åŒ–**
   - ä½¿ç”¨animateDpAsStateå’ŒanimateFloatAsState
   - åŠ¨ç”»æ—¶é•¿æ§åˆ¶åœ¨åˆç†èŒƒå›´(250-1000ms)

### âš ï¸ æ½œåœ¨é£é™©

#### PR-001: Canvasç¼“å­˜ä¸å……åˆ†

**ä»£ç ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/timeline/EmotionTimelineView.kt`

**é—®é¢˜è¯¦æƒ…**:
- æ¯æ¬¡é‡ç»„éƒ½åˆ›å»ºæ–°çš„Pathå¯¹è±¡
- å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜

**ä¿®å¤å»ºè®®**:
```kotlin
// å»ºè®®åœ¨ç»„ä»¶çº§åˆ«ç¼“å­˜Pathå¯¹è±¡
@Composable
fun EmotionTimelineView(
    items: List<TimelineItem>,
    modifier: Modifier = Modifier
) {
    val timelinePath = remember { Path() }
    
    // ä½¿ç”¨ç¼“å­˜çš„Pathå¯¹è±¡
    LazyColumn(...) {
        // ç»„ä»¶å®ç°
    }
}
```

#### PR-002: åˆ—è¡¨ä¼˜åŒ–ä¸è¶³

**ä»£ç ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/timeline/EmotionTimelineView.kt`

**é—®é¢˜è¯¦æƒ…**:
- æœªä½¿ç”¨rememberç¼“å­˜è¿‡æ»¤ç»“æœ
- æ¯æ¬¡ç­›é€‰éƒ½é‡æ–°è®¡ç®—

**ä¿®å¤å»ºè®®**:
```kotlin
// å»ºè®®ç¼“å­˜è¿‡æ»¤ç»“æœ
@Composable
fun EmotionTimelineView(
    items: List<TimelineItem>,
    selectedFilter: FilterType,
    modifier: Modifier = Modifier
) {
    val filteredItems = remember(items, selectedFilter) {
        when (selectedFilter) {
            FilterType.ALL -> items
            FilterType.SWEET -> items.filter { it.emotionType == EmotionType.SWEET }
            // å…¶ä»–ç­›é€‰æ¡ä»¶...
        }
    }
    
    LazyColumn(...) {
        // ä½¿ç”¨ç¼“å­˜çš„filteredItems
    }
}
```

---

## ä¸ƒã€å®‰å…¨åˆè§„æ£€æŸ¥ç»“æœ

### âœ… åˆè§„é¡¹

1. **æ•°æ®éªŒè¯**
   - è¾“å…¥éªŒè¯åŸºæœ¬åˆ°ä½
   - ä½¿ç”¨nullableç±»å‹æ­£ç¡®å¤„ç†ç©ºå€¼

2. **æƒé™å¤„ç†**
   - æœªå‘ç°æƒé™æ»¥ç”¨

### âš ï¸ éœ€è¦æ³¨æ„é¡¹

#### SC-001: è¾“å…¥éªŒè¯ä¸å®Œæ•´

**ä»£ç ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/ContactDetailViewModel.kt:800-845è¡Œ`

**é—®é¢˜è¯¦æƒ…**:
- éƒ¨åˆ†éªŒè¯åªæ£€æŸ¥ç©ºå€¼ï¼ŒæœªéªŒè¯æ ¼å¼
- å¯èƒ½å¯¼è‡´æ— æ•ˆæ•°æ®æäº¤

**ä¿®å¤å»ºè®®**:
```kotlin
// å»ºè®®æ·»åŠ æ ¼å¼éªŒè¯
private fun validateName(): String? {
    val currentState = _uiState.value
    return when {
        currentState.name.isBlank() -> "åç§°ä¸èƒ½ä¸ºç©º"
        currentState.name.length > 50 -> "åç§°é•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦"
        !currentState.name.matches(Regex("^[\\u4e00-\\u9fa5]+.*")) -> "åç§°åªèƒ½åŒ…å«ä¸­æ–‡å­—ç¬¦"
        else -> null
    }
}
```

---

## å…«ã€æµ‹è¯•è¦†ç›–æ£€æŸ¥ç»“æœ

### æµ‹è¯•æ–‡ä»¶å¯¹ç…§

| æºæ–‡ä»¶ | æµ‹è¯•æ–‡ä»¶ | çŠ¶æ€ |
|--------|---------|------|
| HealthRingChart.kt | HealthRingChartTest.kt | âœ… |
| EmotionTimelineView.kt | EmotionTimelineViewTest.kt | âœ… |
| IOSSegmentedControl.kt | (ç¼ºå¤±) | âŒ |
| OverviewTab.kt | (ç¼ºå¤±) | âŒ |
| ContactDetailViewModel.kt | (ç¼ºå¤±) | âŒ |

### âœ… è¦†ç›–è‰¯å¥½çš„æµ‹è¯•

1. **HealthRingChartæµ‹è¯•å®Œæ•´**
   - è¦†ç›–è¿›åº¦è¾¹ç•Œå€¼æµ‹è¯•
   - åŒ…å«åˆ†æ•°æ˜¾ç¤ºæµ‹è¯•
   - æµ‹è¯•æ¸å˜å’Œé¢œè‰²å®šä¹‰

2. **EmotionTimelineViewæµ‹è¯•åŸºæœ¬å®Œæ•´**
   - æµ‹è¯•æ•°æ®é¢„éªŒè¯
   - åŒ…å«ç©ºçŠ¶æ€å’Œé”™è¯¯çŠ¶æ€æµ‹è¯•

### âŒ æµ‹è¯•ç¼ºå¤±

#### TC-001: æ ¸å¿ƒç»„ä»¶æµ‹è¯•ç¼ºå¤±

**ç¼ºå¤±æµ‹è¯•**: 
- IOSSegmentedControlæµ‹è¯•
- OverviewTabæµ‹è¯•
- ContactDetailViewModelæµ‹è¯•

**é—®é¢˜è¯¦æƒ…**:
- æ ¸å¿ƒUIç»„ä»¶ç¼ºå°‘å•å…ƒæµ‹è¯•
- ViewModelä¸šåŠ¡é€»è¾‘æœªæµ‹è¯•
- é›†æˆæµ‹è¯•ä¸è¶³

**ä¿®å¤å»ºè®®**:
```kotlin
// å»ºè®®æ·»åŠ IOSSegmentedControlæµ‹è¯•
class IOSSegmentedControlTest {
    @get:Rule
    val composeTestRule = createComposeRule()
    
    @Test
    fun `clicking tab triggers callback`() {
        var selectedIndex = 0
        composeTestRule.setContent {
            IOSSegmentedControl(
                tabs = listOf("æ¦‚è§ˆ", "äº‹å®æµ"),
                selectedIndex = selectedIndex,
                onTabSelected = { selectedIndex = it }
            )
        }
        
        composeTestRule.onNodeWithText("äº‹å®æµ").performClick()
        assertEquals(1, selectedIndex)
    }
}
```

#### TC-002: é›†æˆæµ‹è¯•ä¸è¶³

**é—®é¢˜è¯¦æƒ…**:
- ç¼ºå°‘é¡µé¢é—´å¯¼èˆªçš„é›†æˆæµ‹è¯•
- ç¼ºå°‘Tabåˆ‡æ¢çš„ç«¯åˆ°ç«¯æµ‹è¯•

**ä¿®å¤å»ºè®®**:
```kotlin
// å»ºè®®æ·»åŠ é›†æˆæµ‹è¯•
@RunWith(AndroidJUnit4::class)
class ContactDetailNavigationTest {
    @get:Rule
    val composeTestRule = createAndroidComposeRule()
    
    @Test
    fun `tab switching works correctly`() {
        // æµ‹è¯•Tabåˆ‡æ¢åŠŸèƒ½
    }
    
    @Test
    fun `navigation to chat works`() {
        // æµ‹è¯•å¯¼èˆªåˆ°èŠå¤©åŠŸèƒ½
    }
}
```

---

## ğŸ”§ ä¿®å¤ä¼˜å…ˆçº§æ±‡æ€»

### P1 - å¿…é¡»ä¿®å¤ï¼ˆé˜»å¡å‘å¸ƒï¼‰

| ç¼–å· | ç±»å‹ | é—®é¢˜ | æ–‡ä»¶ |
|------|------|------|
| IC-001 | æ¥å£ä¸€è‡´æ€§ | EmotionTimelineView.kt:62 |
| IC-002 | æ¥å£ä¸€è‡´æ€§ | ContactDetailViewModel.kt:1097-1107 |
| FI-001 | åŠŸèƒ½å®Œæ•´æ€§ | å¤šä¸ªæ–‡ä»¶ä¸­çš„TODOæ ‡è®° |
| FI-002 | åŠŸèƒ½å®Œæ•´æ€§ | TimelineCard.kt |

### P2 - å»ºè®®ä¿®å¤ï¼ˆå½±å“è´¨é‡ï¼‰

| ç¼–å· | ç±»å‹ | é—®é¢˜ | æ–‡ä»¶ |
|------|------|------|
| OD-001 | è¿‡åº¦è®¾è®¡ | ContactDetailViewModel.kt:1-1126 |
| OD-002 | è¿‡åº¦è®¾è®¡ | ContactDetailUiState.kt:1-509 |
| CQ-001 | ä»£ç è´¨é‡ | OverviewTab.kt:237 |
| CQ-002 | ä»£ç è´¨é‡ | ContactDetailViewModel.kt:67-194 |
| CQ-003 | ä»£ç è´¨é‡ | ContactDetailViewModel.kt:67-194 |

### P3 - å¯é€‰ä¼˜åŒ–ï¼ˆæ€§èƒ½æå‡ï¼‰

| ç¼–å· | ç±»å‹ | é—®é¢˜ | æ–‡ä»¶ |
|------|------|------|
| PR-001 | æ€§èƒ½é£é™© | EmotionTimelineView.kt |
| PR-002 | æ€§èƒ½é£é™© | EmotionTimelineView.kt |
| SC-001 | å®‰å…¨åˆè§„ | ContactDetailViewModel.kt:800-845 |

---

## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

| ç±»åˆ« | æ•°é‡ |
|------|------|
| âœ… åˆè§„é¡¹ | 15 |
| âš ï¸ è­¦å‘Šé¡¹ | 8 |
| âŒ ä¸åˆè§„é¡¹ | 7 |
| **æ€»è®¡** | **30** |

---

## ğŸ¯ æ€»ä½“è¯„ä»·

TD20è”ç³»äººè¯¦æƒ…é¡µUIä¼˜åŒ–ä»£ç æ•´ä½“å®ç°è´¨é‡è‰¯å¥½ï¼ŒåŸºæœ¬è¾¾åˆ°äº†è®¾è®¡ç›®æ ‡ï¼š

### ä¼˜ç‚¹

1. **ç»„ä»¶è®¾è®¡ä¼˜ç§€**
   - iOSé£æ ¼ç»„ä»¶å®ç°åˆ°ä½ï¼Œè§†è§‰æ•ˆæœç¬¦åˆè®¾è®¡ç¨¿
   - åŠ¨ç”»æµç•…ï¼Œç”¨æˆ·ä½“éªŒè‰¯å¥½
   - Canvasç»˜åˆ¶æ€§èƒ½ä¼˜åŒ–åˆç†

2. **æ¶æ„æ¸…æ™°**
   - éµå¾ªClean ArchitectureåŸåˆ™
   - MVVMæ¨¡å¼å®ç°æ­£ç¡®
   - ä¾èµ–æ³¨å…¥è§„èŒƒ

3. **ä»£ç è´¨é‡è‰¯å¥½**
   - ç±»å‹å®‰å…¨å¤„ç†åˆ°ä½
   - é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
   - å‘½åè§„èŒƒåˆç†

### éœ€è¦æ”¹è¿›çš„æ–¹é¢

1. **ViewModelèŒè´£è¿‡é‡**
   - å»ºè®®æ‹†åˆ†ä¸ºå¤šä¸ªä¸“é—¨çš„ViewModel
   - ç®€åŒ–onEventæ–¹æ³•é€»è¾‘

2. **æµ‹è¯•è¦†ç›–ä¸è¶³**
   - æ ¸å¿ƒç»„ä»¶ç¼ºå°‘å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•éœ€è¦è¡¥å……

3. **ä»£ç ç»†èŠ‚ä¼˜åŒ–**
   - æ¸…ç†TODOæ ‡è®°å’Œç©ºå®ç°
   - æå–ç¡¬ç¼–ç å­—ç¬¦ä¸²åˆ°èµ„æºæ–‡ä»¶

**å»ºè®®**: ä¼˜å…ˆä¿®å¤P1çº§åˆ«é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯æ¥å£ä¸€è‡´æ€§å’ŒåŠŸèƒ½å®Œæ•´æ€§ï¼Œç„¶åé€æ­¥ä¼˜åŒ–P2å’ŒP3é—®é¢˜ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-12-26  
**å®¡æŸ¥äºº**: Roo  
**ä¸‹æ¬¡å®¡æŸ¥**: ä¿®å¤å®Œæˆåè¿›è¡ŒäºŒæ¬¡å®¡æŸ¥