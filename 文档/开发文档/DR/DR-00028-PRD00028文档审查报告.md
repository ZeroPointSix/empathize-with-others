# DR-00028 PRD-00028 文档审查报告

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档类型** | PRD (Product Requirements Document) |
| **文档编号** | PRD-00028 |
| **功能名称** | AI军师流式对话升级 |
| **版本** | 1.1 |
| **存放路径** | `文档/开发文档/PRD/PRD-00028-AI军师流式对话升级需求.md` |
| **状态** | 草稿 |
| **关联前置文档** | PRD-00026（AI军师对话功能需求，已读取） |
| **缺失前置文档** | FD-00028、TD-00028、TDD-00028（均不存在） |

---

## 质量评分

| 维度 | 评分 | 说明 |
|------|------|------|
| **格式规范性** | 9/10 | 命名、路径、编号均符合规范 |
| **内容完整性** | 9/10 | 章节齐全，必要内容完整 |
| **开发可行性** | 6/10 | 技术方案可行，但存在架构风险 |
| **架构符合性** | 5/10 | 存在Android依赖违反Clean Architecture |
| **功能集成性** | N/A | 无前置文档，暂无法评估 |

**整体评分**：6.5/10 ⚠️

---

## 优点

1. **需求背景清晰**：明确指出了PRD-00026的4个体验痛点（响应等待、思考过程、消息结构、无法取消）
2. **参考设计明确**：完整参考Cherry Studio的Block架构和ChunkType协议
3. **功能优先级合理**：区分P0/P1/P2/P3级别，便于分阶段实施
4. **数据模型设计详细**：`AiStreamChunk`、`MessageBlockType`、`MessageBlockStatus`等设计完整
5. **数据库迁移方案完整**：包含数据迁移SQL脚本（v13→v14）
6. **验收标准具体**：每个功能点都有明确的验收标准列表
7. **开发计划详细**：Phase 1-3分解，时间预估合理（2.5周+20%缓冲）
8. **风险评估全面**：识别了AI服务商、数据库迁移、流式解析等风险及缓解措施

---

## 需要改进项

### 1. 格式规范问题

#### 规范-001: 前置文档不完整

**问题描述**：根据项目文档规范，同一功能的不同类型文档应使用相同编号。目前缺少：
- `FD-00028`（功能设计文档）
- `TD-00028`（任务清单文档）
- `TDD-00028`（技术设计文档）

**建议**：在开发前补全前置文档，特别是TDD文档应包含：
- Android API使用策略（如SseStreamReader应在:data模块）
- 模块间依赖关系图
- 详细的状态管理设计

---

### 2. 内容完整性问题

#### 内容-001: 缺少与PRD-00026的差异分析

**问题描述**：PRD-00026已完成基础对话功能，PRD-00028是升级需求，但文档未明确：
- 哪些是新增功能（流式、思考过程、Block架构）
- 哪些是修改功能（消息状态增强）
- 哪些是废弃功能

**建议**添加章节说明与PRD-00026的兼容性：

```markdown
## 与PRD-00026的兼容性说明

### 兼容变更
- `AdvisorMessageStatus`新增STREAMING状态（向后兼容）
- `AiAdvisorConversation`表结构不变

### 新增表
- `ai_advisor_message_blocks`（P0新增）

### 废弃功能
- 无废弃功能，SendAdvisorMessageUseCase保留作为非流式备选
```

#### 内容-002: 缺少流式响应与现有SendAdvisorMessageUseCase的协作关系

**问题描述**：文档提到"不影响现有的SendAdvisorMessageUseCase"，但未说明：
- 何时使用流式版本？何时使用非流式版本？
- 是否有开关让用户选择？
- 降级策略是什么？

**建议**添加降级策略说明：

```markdown
### 降级策略

| 场景 | 使用版本 | 原因 |
|------|---------|------|
| 用户主动禁用流式 | 非流式版本 | 用户偏好设置 |
| Provider不支持SSE | 非流式版本 | 技术限制 |
| 网络不稳定 | 非流式版本 | 提升成功率 |
| 默认场景 | 流式版本 | 最佳体验 |
```

---

### 3. 架构设计问题

#### 架构-001: Android API在领域层的风险 ⚠️

**问题描述**：文档中`SseStreamReader`类使用`okHttpClient`和`EventSourceListener`，但代码示例放在`data/remote/SseStreamReader.kt`，这是正确的。然而，`AiStreamChunk`密封类中使用了`Throwable`：

```kotlin
data class Error(val error: Throwable) : AiStreamChunk()
```

`Throwable`是Android/Java标准库类，在`:domain`模块（纯Kotlin）中可以使用，但建议明确说明。

**建议**：在文档中添加说明：

```markdown
### 模块分布说明

| 类/接口 | 所在模块 | 原因 |
|--------|---------|------|
| AiStreamChunk | :domain | 纯数据模型，无Android依赖 |
| MessageBlockType | :domain | 枚举定义，无Android依赖 |
| SseStreamReader | :data | 使用OkHttp，需要Android环境 |
| SendAdvisorMessageStreamingUseCase | :domain | 业务逻辑，无Android依赖 |
```

#### 架构-002: ViewModel在:presentation模块，但文档中示例代码缺少@HiltViewModel注解

**问题描述**：文档中`AiAdvisorChatViewModel`示例缺少关键注解：

```kotlin
// 文档中
class AiAdvisorChatViewModel @Inject constructor(...) : ViewModel() {

// 建议
@HiltViewModel
class AiAdvisorChatViewModel @Inject constructor(...) : ViewModel() {
```

**建议**：在文档中添加完整的注解：

```kotlin
@HiltViewModel
class AiAdvisorChatViewModel @Inject constructor(
    private val savedStateHandle: SavedStateHandle,
    private val sendAdvisorMessageStreamingUseCase: SendAdvisorMessageStreamingUseCase
) : ViewModel() {
```

---

### 4. 数据库设计问题

#### DB-001: 数据库迁移版本号需要验证

**问题描述**：根据项目架构文档，当前数据库版本是v11或v12（PRD-00026提到v12→v13）。文档中写的是v13→v14。

**需要确认**：PRD-00028的数据库迁移版本是v13→v14还是v12→v13？

**建议**：添加版本确认说明：

```markdown
### 数据库迁移版本确认

当前版本：v12（根据PRD-00026）
本PRD迁移：v13→v14

⚠️ 注意：如果PRD-00026的迁移尚未合并，需要调整版本号。
```

#### DB-002: 缺少回滚方案

**问题描述**：数据库迁移脚本没有提供回滚方案。

**建议**：添加回滚SQL：

```sql
-- 回滚脚本（如果需要）
DROP TABLE IF EXISTS ai_advisor_message_blocks;
-- 数据恢复需要从备份或云端重新同步
```

---

### 5. 测试覆盖问题

#### 测试-001: 缺少测试策略说明

**问题描述**：文档没有提到如何测试流式功能：
- 单元测试如何模拟流式数据？
- 集成测试如何验证数据库迁移？
- UI测试如何验证打字机效果？

**建议**添加测试策略章节：

```markdown
## 测试策略

### 单元测试
- AiStreamChunk密封类测试
- BlockUpdateManager节流逻辑测试
- SendAdvisorMessageStreamingUseCase流式处理测试

### 集成测试
- 数据库迁移测试（MIGRATION_13_14）
- Room Flow响应式更新测试

### UI测试
- 流式打字机效果测试
- 思考过程折叠/展开测试
- 取消按钮功能测试
```

---

## 严重问题

### 严重-001: 缺少TDD文档，无法验证技术可行性 ⚠️

**问题描述**：PRD-00028缺少对应的TDD-00028文档，无法验证：
- OkHttp SSE实现是否与现有Retrofit/OkHttp配置兼容
- BlockUpdateManager的节流策略是否会影响UI响应性
- 大量流式写入是否会导致ANR

**必须补充**：在开发前必须完成TDD-00028文档，明确：
1. OkHttpClient的复用策略
2. 数据库写入线程和UI线程的分离
3. 内存占用限制（5MB增量）

---

### 严重-002: SseStreamReader的异常处理不完整

**问题描述**：文档中`SseStreamReader`的`parseChunk`方法只处理了`choices`数组存在的情况，没有处理：
- 空响应
- 格式异常的JSON
- 网络重连场景

**建议**增强错误处理：

```kotlin
private fun parseChunk(data: String): AiStreamChunk? {
    return try {
        val json = JSONObject(data)
        if (json.optString("object") == "error") {
            return AiStreamChunk.Error(Exception(json.optString("message")))
        }
        val choices = json.optJSONArray("choices") ?: return null
        if (choices.length() == 0) return null
        // ... 现有逻辑
    } catch (e: JSONException) {
        AiStreamChunk.Error(e)
    }
}
```

---

## 前置文档一致性

### 与PRD-00026的一致性检查

| 检查项 | PRD-00026 | PRD-00028 | 一致性 |
|--------|-----------|-----------|--------|
| 数据库版本 | v12→v13 | v13→v14 | ⚠️ 版本跳跃，需确认 |
| 消息状态 | PENDING, SUCCESS, ERROR | +STREAMING, STOPPED | ✅ 兼容扩展 |
| 数据模型 | AiAdvisorConversation | +AiAdvisorMessageBlock | ✅ 新增兼容 |
| Repository接口 | saveMessage, getConversations | +saveBlock, updateBlock | ✅ 兼容扩展 |
| 入口方式 | 底部导航栏 | 保持不变 | ✅ 一致 |

**结论**：PRD-00028的设计与PRD-00026基本兼容，但数据库版本需要确认（PRD-00026是v12→v13，PRD-00028是v13→v14）。

---

## 改进建议

### 立即修复（开发前必须完成）

| 优先级 | 问题 | 建议行动 |
|--------|------|---------|
| 🔴 高 | 缺少TDD文档 | 编写TDD-00028技术设计文档 |
| 🔴 高 | 数据库版本不连续 | 确认PRD-00026的迁移版本号 |
| 🔴 高 | 缺少FD文档 | 编写FD-00028功能设计文档 |
| 🟡 中 | ViewModel缺少注解 | 补充@HiltViewModel注解 |
| 🟡 中 | 缺少测试策略 | 添加测试策略章节 |
| 🟡 中 | 缺少降级策略 | 添加流式/非流式降级逻辑 |

### 建议添加（增强文档质量）

| 优先级 | 建议内容 | 原因 |
|--------|---------|------|
| 🟢 低 | 模块分布说明 | 避免Android依赖违规 |
| 🟢 低 | 回滚方案 | 数据库迁移安全保障 |
| 🟢 低 | 性能基准测试 | 验证5MB增量限制 |
| 🟢 低 | 与PRD-00026兼容性说明 | 便于维护和升级 |

---

## 审查结论

**PRD-00028**是一份**设计意图良好但文档完整性不足**的需求文档。

**主要问题**：
1. 缺少前置文档（FD/TD/TDD-00028）
2. 数据库版本需要与PRD-00026对齐
3. 缺少关键架构决策说明
4. 测试策略不完整

**建议行动**：
1. ⚠️ **必须**在开发前补充TDD-00028文档
2. ⚠️ **必须**确认数据库版本号
3. 建议补充FD-00028和TD-00028文档
4. 完善测试策略和降级策略

**审查状态**：⚠️ **建议修改后通过**

---

**审查者**: Roo  
**审查日期**: 2026-01-04  
**文档版本**: 1.0
