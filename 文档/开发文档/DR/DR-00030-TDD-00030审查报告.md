# DR-00030: TDD-00030 AI军师Markdown渲染与会话隔离技术设计文档审查报告

> **审查编号**: DR-00030
> **审查日期**: 2026-01-07
> **审查文档**: TDD-00030-AI军师Markdown渲染与会话隔离技术设计.md
> **审查人**: Roo (AI文档审查助手)
> **状态**: ✅ 审查完成
> **优先级**: 🔴 高

---

## 📄 文档信息

| 属性 | 内容 |
|------|------|
| **文档类型** | 技术设计文档 (TDD) |
| **文档编号** | 00030 |
| **文档标题** | AI军师Markdown渲染与会话隔离技术设计 |
| **存放路径** | `文档/开发文档/TDD/TDD-00030-AI军师Markdown渲染与会话隔离技术设计.md` |
| **创建日期** | 2026-01-07 |
| **作者** | Kiro |
| **审核人** | - |
| **审核状态** | 🔄 待审核 |
| **关联文档** | PRD-00030, TDD-00026, TDD-00029, DR-00048 |

---

## 📊 质量评分

| 审查维度 | 评分 | 说明 |
|---------|------|------|
| **格式规范性** | 9/10 | 文档格式规范，结构清晰，编号正确 |
| **内容完整性** | 9/10 | 技术设计完整，包含架构图、数据流图、代码示例 |
| **开发可行性** | 8/10 | 技术方案可行，但缺少部分实现细节确认 |
| **架构符合性** | 9/10 | 符合Clean Architecture + MVVM架构规范 |
| **功能集成性** | 5/10 | 🔴 **重点关注：功能尚未实现，需检查集成点** |
| **整体评分** | **8/10** | 文档质量优秀，需关注实现进度 |

---

## ✅ 优点

### 1. 文档结构完整清晰
- **文档信息表格**完整，包含版本历史、参考标准等必要信息
- **架构目标明确**，清晰定义了两个核心功能：Markdown渲染和会话隔离
- **技术栈选择合理**，使用compose-markdown库，版本0.5.4已验证兼容性

### 2. 技术设计详尽
- **功能架构图**清晰展示了Markdown渲染和会话隔离的组件关系
- **数据流图**详细描述了消息从AI返回到UI渲染的完整流程
- **代码示例完整**，提供了修改前后的对比代码，易于开发人员理解和实现

### 3. 依赖关系清晰
- **DI模块集成**设计合理，复用现有AiAdvisorModule
- **Repository接口**定义明确，标注了需要确认的方法
- **调用链设计**完整，覆盖了Markdown渲染和会话隔离两个场景

### 4. 测试计划周全
- **单元测试**用例设计合理，覆盖核心逻辑
- **UI测试**用例覆盖了主要Markdown语法渲染场景
- **集成测试**场景明确，包括新会话隔离、画像信息传递等

### 5. 风险评估充分
- 识别了主要风险点：compose-markdown兼容性、getConversationsBySession方法存在性
- 提供了缓解措施和应对策略

---

## ⚠️ 需要改进项

### 1. 前置文档引用不完整
**问题**: 文档提到了关联文档，但未详细说明与前置文档（PRD-00030）的一致性

**建议**: 在文档开头添加与PRD-00030的对比表，确认技术设计完全覆盖需求

### 2. BrainTagRepository依赖未在文件变更清单中体现
**问题**: 第360行提到需要新增`BrainTagRepository`依赖，但第8.2节文件变更清单未明确列出

**建议**: 在文件变更清单中添加需要修改的Repository接口文件

### 3. 联系人画像信息增强缺少具体格式定义
**问题**: buildPrompt方法增强部分提到了标签和事实流，但未定义具体的输出格式

**建议**: 添加联系人画像信息的Prompt模板示例，确保AI理解一致

### 4. 流式Markdown渲染性能风险未充分评估
**问题**: 文档提到"流式Markdown渲染性能问题"风险等级为"中"，但未提供具体的监控指标

**建议**: 添加性能监控指标，如渲染帧率、内存占用等

---

## ❌ 严重问题

### 1. 🔴 会话隔离核心方法尚未实现

**问题描述**: 
- `AiAdvisorRepository.kt` 当前只有 `getRecentConversations(contactId, limit)` 方法
- **缺少** TDD-00030 设计的 `getConversationsBySession(sessionId, limit)` 方法

**影响范围**: 会话隔离功能无法实现，新会话仍会获取所有历史对话

**修复建议**: 
```kotlin
// 需要在 AiAdvisorRepository.kt 中新增方法
/**
 * 按会话ID获取对话历史
 * TDD-00030: 会话隔离功能需要此方法
 * 
 * @param sessionId 会话ID
 * @param limit 最大返回数量
 * @return 对话列表，按时间正序
 */
suspend fun getConversationsBySession(sessionId: String, limit: Int): Result<List<AiAdvisorConversation>>
```

### 2. 🔴 SendAdvisorMessageStreamingUseCase 尚未修改

**问题描述**: 
- 第138行仍使用旧代码：`aiAdvisorRepository.getRecentConversations(contactId, DEFAULT_HISTORY_LIMIT)`
- 应修改为：`aiAdvisorRepository.getConversationsBySession(sessionId, DEFAULT_HISTORY_LIMIT)`

**影响范围**: 会话隔离功能不生效

**修复建议**: 
```kotlin
// 第138行修改为
val historyResult = aiAdvisorRepository.getConversationsBySession(sessionId, DEFAULT_HISTORY_LIMIT)
```

### 3. 🔴 Markdown渲染组件尚未实现

**问题描述**:
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/markdown/MarkdownText.kt` 文件不存在
- `AiAdvisorChatScreen.kt` 中的 `ChatBubble` 组件仍使用普通 `Text()` 组件

**影响范围**: AI回复无法显示Markdown格式

**修复建议**: 
1. 创建 `MarkdownText.kt` 组件或直接使用 `compose-markdown` 库的 `Markdown()` Composable
2. 修改 `ChatBubble` 组件，将AI消息的 `Text()` 替换为 `Markdown()`

---

## 🔗 前置文档一致性

### 与 PRD-00030 的一致性检查

| 需求项 | PRD描述 | TDD实现 | 一致性 |
|--------|---------|---------|--------|
| Markdown粗体渲染 | `**文字**`显示为粗体 | 使用Markdown组件 | ✅ 一致 |
| Markdown斜体渲染 | `*文字*`显示为斜体 | 使用Markdown组件 | ✅ 一致 |
| Markdown列表渲染 | `- 项目`显示为列表 | 使用Markdown组件 | ✅ 一致 |
| Markdown代码块 | 代码块显示灰色背景 | 配置了codeBackground | ✅ 一致 |
| 新会话隔离 | AI无法获取之前会话历史 | 改用sessionId获取 | ✅ 一致 |
| 画像信息保留 | AI可获取联系人画像 | 增强buildPrompt方法 | ✅ 一致 |

### 与 TDD-00026/TDD-00029 的一致性检查

| 文档 | 关联点 | 一致性 |
|------|--------|--------|
| TDD-00026 | AI军师基础对话功能 | ✅ TDD-00030在基础上扩展 |
| TDD-00029 | AI军师UI架构优化 | ✅ 导航和页面结构复用 |

---

## 🔗 功能集成完整性检查

### 📋 当前实现状态总结

| 功能模块 | TDD设计状态 | 代码实现状态 | 完成度 |
|---------|------------|-------------|--------|
| Markdown依赖添加 | ✅ 已设计 | ❌ 未实现 | 0% |
| ChatBubble Markdown渲染 | ✅ 已设计 | ❌ 未实现 | 0% |
| StreamingMessageBubble Markdown渲染 | ✅ 已设计 | ❌ 未实现 | 0% |
| 会话隔离 (sessionId获取) | ✅ 已设计 | ❌ 未实现 | 0% |
| 联系人画像信息增强 | ✅ 已设计 | ❌ 未实现 | 0% |
| BrainTagRepository依赖注入 | ✅ 已设计 | ❌ 未实现 | 0% |

### 🔗 集成点验证

| 集成点 | 文件 | 设计状态 | 实现状态 | 状态 |
|--------|------|---------|---------|------|
| Markdown依赖 | libs.versions.toml | ✅ | ❌ | 🔴 未实现 |
| ChatBubble修改 | AiAdvisorChatScreen.kt | ✅ | ❌ | 🔴 未实现 |
| Streaming修改 | StreamingMessageBubble.kt | ✅ | ❌ | 🔴 未实现 |
| UseCase修改 | SendAdvisorMessageStreamingUseCase.kt | ✅ | ❌ | 🔴 未实现 |
| DI模块更新 | AiAdvisorModule.kt | ✅ | ❌ | 未检查 |
| Repository方法 | AiAdvisorRepository.kt | ✅ | ❌ | 🔴 缺失方法 |

### ❌ 集成缺失问题

#### INT-001: Repository方法缺失
**问题描述**: `AiAdvisorRepository.kt` 中缺少 `getConversationsBySession` 方法
**缺失位置**: `domain/src/main/kotlin/com/empathy/ai/domain/repository/AiAdvisorRepository.kt`
**修复建议**: 
```kotlin
// 在 AiAdvisorRepository.kt 中添加以下方法
@Query("SELECT * FROM ai_advisor_conversations WHERE session_id = :sessionId ORDER BY timestamp ASC LIMIT :limit")
suspend fun getConversationsBySession(sessionId: String, limit: Int): Result<List<AiAdvisorConversation>>
```

#### INT-002: ChatBubble未使用Markdown
**问题描述**: `AiAdvisorChatScreen.kt` 的 `ChatBubble` 组件使用普通 `Text()` 而非 `Markdown()`
**缺失位置**: 第534-544行
**修复建议**: 
```kotlin
// 将 Text() 替换为 Markdown()
if (isUser) {
    Text(
        text = conversation.content,
        modifier = Modifier.padding(horizontal = 14.dp, vertical = 10.dp),
        color = Color.White,
        fontSize = 16.sp,
        lineHeight = 22.sp
    )
} else {
    Markdown(
        content = conversation.content,
        modifier = Modifier.padding(horizontal = 14.dp, vertical = 10.dp),
        colors = markdownColors(
            text = when {
                isFailed || isCancelled -> iOSRed
                else -> iOSTextPrimary
            },
            codeBackground = Color(0xFFF5F5F5),
            inlineCodeBackground = Color(0xFFE8E8E8)
        )
    )
}
```

#### INT-003: SendAdvisorMessageStreamingUseCase未修改
**问题描述**: 第138行仍使用 `getRecentConversations(contactId, ...)` 而非 `getConversationsBySession(sessionId, ...)`
**缺失位置**: `domain/src/main/kotlin/com/empathy/ai/domain/usecase/SendAdvisorMessageStreamingUseCase.kt` 第138行
**修复建议**: 
```kotlin
// 修改第138行
val historyResult = aiAdvisorRepository.getConversationsBySession(sessionId, DEFAULT_HISTORY_LIMIT)
```

---

## 📋 改进建议

### 🔴 优先级P0（立即修复）

1. **实现 `getConversationsBySession` 方法**
   - 在 `AiAdvisorRepository.kt` 接口中添加方法定义
   - 在 `AiAdvisorRepositoryImpl.kt` 中实现该方法
   - 添加对应的DAO查询方法

2. **修改 `SendAdvisorMessageStreamingUseCase`**
   - 将历史获取逻辑改为按 `sessionId` 获取
   - 添加 `BrainTagRepository` 依赖注入

3. **添加Markdown渲染支持**
   - 在 `libs.versions.toml` 中添加 compose-markdown 依赖
   - 修改 `ChatBubble` 组件使用 `Markdown()` 组件
   - 修改 `StreamingMessageBubble` 组件使用 `Markdown()` 组件

### 🟡 优先级P1（短期内修复）

4. **更新 `AiAdvisorModule` DI配置**
   - 添加 `BrainTagRepository` 依赖注入

5. **增强联系人画像信息**
   - 在 `buildPrompt` 方法中添加标签和事实流获取逻辑

6. **编写单元测试**
   - 测试会话隔离逻辑
   - 测试Prompt构建逻辑

### 🟢 优先级P2（后续优化）

7. **性能监控**
   - 添加Markdown渲染性能监控
   - 添加历史获取性能监控

8. **文档更新**
   - 补充与PRD-00030的对比表
   - 添加联系人画像Prompt格式示例

---

## 📚 关联文档

- [PRD-00030-AI军师Markdown渲染与会话隔离需求](../PRD/PRD-00030-AI军师Markdown渲染与会话隔离需求.md)
- [TDD-00026-AI军师对话功能技术设计](./TDD-00026-AI军师对话功能技术设计.md)
- [TDD-00029-AI军师UI架构优化技术设计](./TDD-00029-AI军师UI架构优化技术设计.md)
- [DR-00048-PRD00030文档审查报告](../DR/DR-00048-PRD-00030文档审查报告.md)

---

**文档版本**: 1.0  
**最后更新**: 2026-01-07  
**更新内容**: 初始版本 - TDD-00030文档审查
