# DR-00036: TDD-00036 区域截图功能技术设计审查报告

> **文档类型**: 文档审查报告 (DR)
> **版本**: 1.0
> **创建日期**: 2026-01-12
> **更新日期**: 2026-01-12
> **负责人**: Codex
> **关联文档**: TDD-00036
> **状态**: ✅ 审查完成

---

## 📄 文档信息
- 文档类型、编号、标题: TDD-00036 / 区域截图功能技术设计
- 存放路径: `文档/开发文档/TDD/TDD-00036-区域截图功能技术设计.md`
- 关联的前置文档列表: PRD-00036, FD-00036

---

## 📊 质量评分
- 格式规范性：9/10
- 内容完整性：7/10
- 开发可行性：6/10
- 架构符合性：7/10
- **功能集成性：4/10**（🔴 新增）
- 整体评分：**6.6/10**

---

## ✅ 优点
- 结构清晰，覆盖权限、遮罩、截图、压缩、降级、清理等核心链路。
- 关键数据结构（附件模型、多模态消息结构）给出示例，便于理解。
- 兼顾性能指标与错误处理，包含测试策略。

---

## ⚠️ 需要改进项
- **数据库设计缺失**：TDD类型要求包含数据库设计，但未说明是否需要表/迁移或明确“不入库”。
- **交互范围扩展**：TDD新增“拖动取景框/四角缩放”交互，PRD/FD未明确，需需求对齐。
- **模型能力来源不清**：`supportsImage` 的判定来源与配置路径未定义。
- **测试落点不明确**：测试用例未标注实际模块路径与命名规范。

---

## ❌ 严重问题
- **集成链路缺失**：文档列出的新类/新DTO与权限要求在代码中未见落地，导致“技术设计与当前实现脱节”。

---

## 🔗 前置文档一致性
- 与 PRD-00036/FD-00036 大部分一致。
- 不一致点：TDD新增“取景框可拖动/缩放”交互；PRD/FD仅要求“拖拽生成矩形松手截图”。

---

## 🔗 功能集成完整性检查

### 功能组件清单
| 组件类型 | 组件名称 | 集成状态 |
|---------|---------|---------|
| Screen | 无新增页面 | ✅ |
| ViewModel | 未定义 | ❌ |
| UseCase | 未定义 | ❌ |
| Repository | 未定义 | ❌ |
| DAO | 未定义 | ❌ |
| Entity | 未定义 | ✅（规划为临时文件，不入库） |

### 集成点验证
| 集成点 | 文件 | 状态 | 说明 |
|--------|------|------|------|
| 导航注册 | `presentation/navigation/NavGraph.kt` | ✅ | 无新增页面，不需要路由集成（现有仅有 TODO 图片选择器占位） |
| DI绑定 | `app/di/*`、`data/di/*` | ❌ | 新服务/管理类未定义，无法绑定 |
| DAO提供 | `data/di/DatabaseModule.kt` | ✅ | 规划为临时文件，不需DAO |
| Entity注册 | `data/local/AppDatabase.kt` | ✅ | 规划为临时文件，不入库 |
| 入口点 | `app/domain/service/FloatingWindowService.kt`、`presentation/ui/floating/*` | ❌ | 入口按钮/遮罩/附件列表未实现 |
| 权限声明 | `app/src/main/AndroidManifest.xml` | ❌ | 未声明 MediaProjection / FGS mediaProjection 类型 |
| 调用链完整 | Screen → ViewModel → UseCase → Repository | ❌ | 相关层级缺失 |
| 字符串资源 | `presentation/src/main/res/values/strings.xml` | ❌ | 降级提示文案未定义 |

### ❌ 集成缺失问题

#### INT-001: 权限与前台服务类型缺失
**问题描述**: 文档要求 MediaProjection 截图，但 Manifest 未声明相关权限与前台服务类型。
**缺失位置**: `app/src/main/AndroidManifest.xml`（未见 MediaProjection / mediaProjection FGS 类型）。
**修复建议**:
```xml
<!-- 示例：需根据实际方案选择是否添加 -->
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PROJECTION" />
```

#### INT-002: 悬浮窗入口与遮罩未集成
**问题描述**: TDD列出 `ScreenshotOverlayView` / `ScreenshotThumbAdapter` / 入口按钮，但代码中未发现实现与接入。
**缺失位置**: `presentation/ui/floating/FloatingViewV2.kt`、`app/domain/service/FloatingWindowService.kt`。
**修复建议**:
```kotlin
// 在 FloatingViewV2 中增加截图入口按钮并回调到 Service
```

#### INT-003: 多模态请求结构未落地
**问题描述**: TDD提出 `MessageContentPartDto` 和 `image_url` 结构，但 `MessageDto`/`ChatRequestDto` 仍为纯文本。
**缺失位置**: `data/remote/model/MessageDto.kt`, `data/remote/model/ChatRequestDto.kt`。
**修复建议**:
```kotlin
// 需要定义 MessageContentPartDto 并调整 content 类型为 List<Part>
```

#### INT-004: 模型能力字段未实现
**问题描述**: TDD要求 `AiModel.supportsImage`，但现有 `AiModel` 无该字段。
**缺失位置**: `domain/model/AiModel.kt`。
**修复建议**:
```kotlin
data class AiModel(
    val id: String,
    val displayName: String? = null,
    val supportsImage: Boolean = false
)
```

#### INT-005: 文案资源缺失
**问题描述**: 降级提示文案未在资源中定义。
**缺失位置**: `presentation/src/main/res/values/strings.xml`。
**修复建议**:
```xml
<string name="image_not_supported_tip">当前模型不支持图片理解，已仅发送文字内容</string>
```

---

## 📋 改进建议
- **P0**: 补齐权限/前台服务类型与入口集成说明，确保可运行闭环。
- **P1**: 明确模型能力来源与配置路径，补齐多模态 DTO 方案落点。
- **P1**: 明确“临时附件不入库”的数据库设计声明（可在 TDD 中显式写明）。
- **P2**: 补齐测试落点路径与命名，覆盖压缩策略、附件上限与降级逻辑。

---

## 审查结论
TDD-00036 结构完整、方向明确，但与当前代码实现存在显著集成缺口，且部分交互范围超出 PRD/FD。建议先对齐需求边界并补充集成与权限落点说明，再进入实现阶段。

---

**审查人**: Codex
**审查日期**: 2026-01-12
**文档状态**: ✅ 审查完成
