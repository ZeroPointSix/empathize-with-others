# FD-00002-设置功能设计

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | FD (Functional Document) |
| 文档编号 | FD-00002 |
| 功能名称 | 设置功能 |
| 版本 | 1.0 |
| 创建日期 | 2024-12-12 |
| 作者 | Claude |
| 审核人 | 待定 |
| 关联文档 | PRD-00002-设置功能需求 |

## 2. 功能概述

### 2.1 功能定位

设置功能是共情AI助手的核心配置中心，为用户提供统一的应用配置入口。MVP阶段聚焦于核心功能：AI服务商管理、隐私保护、悬浮窗控制和基本应用信息。

### 2.2 设计原则

- **简洁明了**: 设置项分组清晰，说明文字简洁易懂
- **即时生效**: 设置变更后立即生效，无需重启应用
- **安全可靠**: 敏感数据加密存储，操作有二次确认
- **符合规范**: 遵循Material Design 3设计规范
- **易于扩展**: 架构设计便于后续添加新的设置项

### 2.3 MVP范围

**本次实现**：
- ✅ AI服务商配置（切换默认服务商）
- ✅ 隐私保护设置（数据掩码、本地优先模式）
- ✅ 悬浮窗设置（权限管理、服务控制）
- ✅ 关于信息（版本号、应用简介、数据管理）

**明确不包含**：
- ❌ 主题设置
- ❌ 字体大小调节
- ❌ 通知设置
- ❌ 数据导入导出
- ❌ 多语言支持

## 3. 页面结构设计

### 3.1 整体布局

```
┌─────────────────────────────────┐
│ [←] 设置                        │  ← TopAppBar (56dp)
├─────────────────────────────────┤
│                                 │
│  ┌───────────────────────────┐ │
│  │ AI 服务商                  │ │  ← Section 1
│  │ ┌─────────────────────┐   │ │
│  │ │ 当前服务商          │   │ │
│  │ │ DeepSeek      [>]  │   │ │
│  │ └─────────────────────┘   │ │
│  │ [管理 AI 服务商]          │ │
│  └───────────────────────────┘ │
│                                 │
│  ────────────────────────────  │  ← Divider
│                                 │
│  ┌───────────────────────────┐ │
│  │ 隐私设置                   │ │  ← Section 2
│  │ ┌─────────────────────┐   │ │
│  │ │ 数据掩码      [●]  │   │ │
│  │ └─────────────────────┘   │ │
│  │ ┌─────────────────────┐   │ │
│  │ │ 本地优先      [●]  │   │ │
│  │ └─────────────────────┘   │ │
│  └───────────────────────────┘ │
│                                 │
│  ────────────────────────────  │
│                                 │
│  ┌───────────────────────────┐ │
│  │ 悬浮窗功能                 │ │  ← Section 3
│  │ ┌─────────────────────┐   │ │
│  │ │ 启用悬浮窗    [○]  │   │ │
│  │ └─────────────────────┘   │ │
│  └───────────────────────────┘ │
│                                 │
│  ────────────────────────────  │
│                                 │
│  ┌───────────────────────────┐ │
│  │ 关于                      │ │  ← Section 4
│  │ 应用版本: 1.0.0           │ │
│  │ 共情 AI 助手              │ │
│  └───────────────────────────┘ │
│                                 │
└─────────────────────────────────┘
```

### 3.2 布局规格

**页面容器**：
- **背景色**: `MaterialTheme.colorScheme.background`
- **内边距**: 16dp (左右)
- **滚动**: 支持垂直滚动

**Section间距**：
- **Section间距**: 24dp
- **Divider高度**: 1dp
- **Divider颜色**: `MaterialTheme.colorScheme.outlineVariant`

**Section标题**：
- **字体**: `MaterialTheme.typography.titleMedium`
- **颜色**: `MaterialTheme.colorScheme.primary`
- **间距**: 底部12dp

## 4. 功能详细设计

### 4.1 AI服务商配置

#### 4.1.1 当前服务商显示卡片

**视觉设计**：
```
┌─────────────────────────────────┐
│ 当前服务商                       │  ← bodySmall, onSurfaceVariant
│ DeepSeek                  [>]   │  ← bodyLarge, onSurface
└─────────────────────────────────┘
```

**组件规格**：
- **容器**: `Card` (Material 3)
- **高度**: 72dp
- **圆角**: 12dp
- **内边距**: 16dp
- **点击效果**: Ripple效果

**状态设计**：
- **已配置**: 显示服务商名称和箭头图标
- **未配置**: 显示"尚未配置"提示

#### 4.1.2 服务商选择对话框

**对话框布局**：
```
┌─────────────────────────────────┐
│ 选择 AI 服务商                   │  ← Title
├─────────────────────────────────┤
│ ○ OpenAI                        │  ← RadioButton
│   gpt-4-turbo                   │  ← 模型名称
│                                 │
│ ● DeepSeek                      │  ← 选中状态
│   deepseek-chat                 │
│                                 │
│ ○ Claude                        │
│   claude-3-opus                 │
├─────────────────────────────────┤
│                        [关闭]   │  ← TextButton
└─────────────────────────────────┘
```

**交互设计**：
- **触发**: 点击服务商卡片
- **选择**: 点击RadioButton或整行
- **确认**: 选择后自动关闭，显示Toast
- **取消**: 点击"关闭"或对话框外部

**动画效果**：
- **进入**: 300ms淡入 + 缩放动画
- **退出**: 200ms淡出动画

#### 4.1.3 管理服务商按钮

**按钮设计**：
```
┌─────────────────────────────────┐
│ [⚙️] 管理 AI 服务商              │
└─────────────────────────────────┘
```

**组件规格**：
- **类型**: `OutlinedButton`
- **宽度**: 填充父容器
- **高度**: 40dp
- **图标**: 20dp Settings图标
- **文字**: bodyMedium

**交互设计**：
- **点击**: 导航到AiConfigScreen
- **反馈**: Ripple效果 + 触觉反馈

#### 4.1.4 未配置提示卡片

**视觉设计**：
```
┌─────────────────────────────────┐
│ ℹ️ 尚未配置 AI 服务商            │
│ 请先添加至少一个 AI 服务商       │
│ 才能使用 AI 功能                │
└─────────────────────────────────┘
```

**组件规格**：
- **容器**: `Card` (secondaryContainer背景)
- **图标**: 24dp Info图标
- **文字**: bodyMedium
- **颜色**: onSecondaryContainer
- **内边距**: 16dp

### 4.2 隐私保护设置

#### 4.2.1 数据掩码开关

**卡片布局**：
```
┌─────────────────────────────────┐
│ 数据掩码                  [●]   │  ← 标题 + Switch
│ AI 分析前自动掩码敏感信息        │  ← 说明文字
└─────────────────────────────────┘
```

**组件规格**：
- **容器**: `Card`
- **高度**: 72dp
- **标题**: bodyLarge
- **说明**: bodySmall, onSurfaceVariant
- **开关**: Material 3 Switch

**交互设计**：
- **点击区域**: 整个卡片可点击
- **开关切换**: 立即保存到SharedPreferences
- **反馈**: 开关动画 + 触觉反馈
- **默认值**: 开启 (true)

**状态说明**：
- **开启**: "AI 分析前自动掩码敏感信息"
- **关闭**: "原始数据直接发送给AI（不推荐）"

#### 4.2.2 本地优先模式开关

**卡片布局**：
```
┌─────────────────────────────────┐
│ 本地优先模式              [●]   │
│ 优先使用本地规则，减少 AI 调用   │
└─────────────────────────────────┘
```

**组件规格**：
- 与数据掩码开关相同

**交互设计**：
- 与数据掩码开关相同
- **默认值**: 开启 (true)

**状态说明**：
- **开启**: "优先使用本地规则，减少 AI 调用"
- **关闭**: "所有检查都通过AI进行（更准确但更慢）"

### 4.3 悬浮窗设置

#### 4.3.1 悬浮窗开关卡片

**卡片布局**：
```
┌─────────────────────────────────┐
│ 启用悬浮窗                [○]   │
│ 需要悬浮窗权限                  │  ← 未授权状态
└─────────────────────────────────┘
```

**组件规格**：
- **容器**: `Card`
- **高度**: 72dp
- **标题**: bodyLarge
- **说明**: bodySmall
- **说明颜色**: 
  - 已授权: onSurfaceVariant
  - 未授权: error

**状态设计**：

| 权限状态 | 开关状态 | 说明文字 | 说明颜色 |
|---------|---------|---------|---------|
| 已授权 | 开启 | "在聊天应用上显示快捷按钮" | onSurfaceVariant |
| 已授权 | 关闭 | "在聊天应用上显示快捷按钮" | onSurfaceVariant |
| 未授权 | 关闭 | "需要悬浮窗权限" | error |

#### 4.3.2 权限提示卡片

**卡片布局**：
```
┌─────────────────────────────────┐
│ ⚠️ 需要悬浮窗权限          [>]  │
│ 点击查看说明并授权               │
└─────────────────────────────────┘
```

**组件规格**：
- **容器**: `Card` (errorContainer背景)
- **图标**: 24dp Warning图标, error颜色
- **文字**: bodyMedium, onErrorContainer
- **箭头**: 24dp ChevronRight图标
- **显示条件**: 权限未授权时显示

**交互设计**：
- **点击**: 显示权限说明对话框
- **反馈**: Ripple效果

#### 4.3.3 权限说明对话框

**对话框布局**：
```
┌─────────────────────────────────┐
│ 需要悬浮窗权限                   │  ← Title
├─────────────────────────────────┤
│ 悬浮窗功能需要"在其他应用上层   │
│ 显示"权限。                     │
│                                 │
│ 此权限用于：                    │
│ • 在聊天应用上显示快捷按钮      │
│ • 快速访问 AI 助手功能          │
│                                 │
│ 我们承诺：                      │
│ • 不会滥用此权限                │
│ • 不会收集您的屏幕内容          │
├─────────────────────────────────┤
│              [取消]  [去授权]   │
└─────────────────────────────────┘
```

**组件规格**：
- **标题**: titleLarge
- **内容**: bodyMedium, 行间距1.5
- **按钮**: TextButton
- **内边距**: 24dp

**交互设计**：
- **取消**: 关闭对话框
- **去授权**: 跳转到系统设置页面

#### 4.3.4 功能提示文字

**提示文字**：
```
提示：悬浮窗功能用于在聊天应用上显示快捷按钮，
方便您快速访问 AI 助手功能
```

**组件规格**：
- **字体**: bodySmall
- **颜色**: onSurfaceVariant
- **位置**: Section底部
- **内边距**: 顶部8dp

### 4.4 关于信息

#### 4.4.1 关于信息卡片

**卡片布局**：
```
┌─────────────────────────────────┐
│ 应用版本              1.0.0     │
│                                 │
│ 共情 AI 助手                    │
│                                 │
│ 隐私优先的社交沟通助手           │
└─────────────────────────────────┘
```

**组件规格**：
- **容器**: `Card`
- **内边距**: 16dp
- **行间距**: 8dp
- **版本号**: bodyMedium, onSurfaceVariant
- **应用名**: bodySmall, onSurfaceVariant
- **简介**: bodySmall, onSurfaceVariant

#### 4.4.2 清除数据按钮（可选）

**按钮设计**：
```
┌─────────────────────────────────┐
│ [清除所有设置]                  │
└─────────────────────────────────┘
```

**组件规格**：
- **类型**: `OutlinedButton`
- **颜色**: error
- **宽度**: 填充父容器
- **高度**: 40dp

**交互设计**：
- **点击**: 显示确认对话框
- **确认**: 执行清除操作
- **反馈**: Toast提示

#### 4.4.3 清除数据确认对话框

**对话框布局**：
```
┌─────────────────────────────────┐
│ 清除所有设置                    │
├─────────────────────────────────┤
│ 确定要清除以下数据吗？          │
│                                 │
│ 将被清除：                      │
│ • AI服务商配置                  │
│ • 隐私保护设置                  │
│ • 悬浮窗设置                    │
│                                 │
│ 不会清除：                      │
│ • 联系人数据                    │
│ • 标签数据                      │
│                                 │
│ 此操作不可恢复！                │
├─────────────────────────────────┤
│              [取消]  [确定清除] │
└─────────────────────────────────┘
```

**组件规格**：
- **标题**: titleLarge
- **内容**: bodyMedium
- **警告文字**: error颜色
- **确认按钮**: error颜色

## 5. 交互流程设计

### 5.1 切换AI服务商流程

```
用户进入设置页面
    ↓
点击"当前服务商"卡片
    ↓
显示服务商选择对话框
    ↓
┌─────────────┬─────────────┐
│ 选择服务商  │ 点击关闭    │
├─────────────┼─────────────┤
│ 调用API     │ 关闭对话框  │
│ 设置默认    │             │
│     ↓       │             │
│ 更新UI状态  │             │
│     ↓       │             │
│ 显示Toast   │             │
│ "已切换为XX"│             │
│     ↓       │             │
│ 关闭对话框  │             │
└─────────────┴─────────────┘
```

### 5.2 切换隐私设置流程

```
用户点击开关
    ↓
获取新的状态值
    ↓
保存到SharedPreferences
    ↓
┌─────────────┬─────────────┐
│ 保存成功    │ 保存失败    │
├─────────────┼─────────────┤
│ 更新UI状态  │ 显示错误    │
│ 开关动画    │ Toast提示   │
│ 触觉反馈    │ 恢复原状态  │
└─────────────┴─────────────┘
```

### 5.3 启用悬浮窗流程

```
用户点击悬浮窗开关
    ↓
检查权限状态
    ↓
┌─────────────┬─────────────┐
│ 已授权      │ 未授权      │
├─────────────┼─────────────┤
│ 启动服务    │ 显示权限    │
│     ↓       │ 说明对话框  │
│ 保存状态    │     ↓       │
│     ↓       │ 用户确认    │
│ 更新UI      │     ↓       │
│     ↓       │ 跳转系统    │
│ Toast提示   │ 设置页面    │
│             │     ↓       │
│             │ 用户授权    │
│             │     ↓       │
│             │ 返回应用    │
│             │     ↓       │
│             │ 重新检测    │
│             │ 权限状态    │
└─────────────┴─────────────┘
```

### 5.4 清除数据流程

```
用户点击"清除所有设置"
    ↓
显示确认对话框
    ↓
┌─────────────┬─────────────┐
│ 用户确认    │ 用户取消    │
├─────────────┼─────────────┤
│ 显示加载    │ 关闭对话框  │
│ 指示器      │             │
│     ↓       │             │
│ 清除AI服务商│             │
│     ↓       │             │
│ 清除隐私设置│             │
│     ↓       │             │
│ 清除悬浮窗  │             │
│ 设置        │             │
│     ↓       │             │
│ 停止悬浮窗  │             │
│ 服务        │             │
│     ↓       │             │
│ 更新UI状态  │             │
│     ↓       │             │
│ 显示Toast   │             │
│ "已清除"    │             │
│     ↓       │             │
│ 关闭对话框  │             │
└─────────────┴─────────────┘
```

## 6. 状态管理设计

### 6.1 UI状态定义

```kotlin
data class SettingsUiState(
    // 通用状态
    val isLoading: Boolean = false,
    val error: String? = null,
    val successMessage: String? = null,

    // AI 服务商选择
    val selectedProvider: String = "",
    val availableProviders: List<String> = emptyList(),
    val providersList: List<AiProvider> = emptyList(),

    // 隐私设置
    val dataMaskingEnabled: Boolean = true,
    val localFirstMode: Boolean = true,

    // 悬浮窗设置
    val floatingWindowEnabled: Boolean = false,
    val hasFloatingWindowPermission: Boolean = false,

    // 应用信息
    val appVersion: String = "1.0.0",

    // UI 交互状态
    val showProviderDialog: Boolean = false,
    val showClearDataDialog: Boolean = false,
    val showPermissionDialog: Boolean = false
)
```

### 6.2 UI事件定义

```kotlin
sealed interface SettingsUiEvent {
    // AI 服务商事件
    data class SelectProvider(val provider: String) : SettingsUiEvent
    data object ShowProviderDialog : SettingsUiEvent
    data object HideProviderDialog : SettingsUiEvent

    // 隐私设置事件
    data object ToggleDataMasking : SettingsUiEvent
    data object ToggleLocalFirstMode : SettingsUiEvent

    // 悬浮窗事件
    data object ToggleFloatingWindow : SettingsUiEvent
    data object ShowPermissionDialog : SettingsUiEvent
    data object HidePermissionDialog : SettingsUiEvent
    data object CheckFloatingWindowPermission : SettingsUiEvent

    // 数据管理事件
    data object ShowClearDataDialog : SettingsUiEvent
    data object HideClearDataDialog : SettingsUiEvent
    data object ClearAllData : SettingsUiEvent

    // 通用事件
    data object ClearError : SettingsUiEvent
    data object ClearSuccessMessage : SettingsUiEvent
    data object NavigateBack : SettingsUiEvent
}
```

### 6.3 状态流转图

```
初始状态
    ↓
加载设置数据
    ↓
┌─────────────────────────────────┐
│ 正常显示状态                    │
│ - 显示所有设置项                │
│ - 响应用户交互                  │
└─────────────────────────────────┘
    ↓
用户操作
    ↓
┌─────────┬─────────┬─────────┐
│ 切换服务商│ 切换开关 │ 清除数据 │
├─────────┼─────────┼─────────┤
│ 显示对话框│ 保存设置 │ 显示确认 │
│     ↓    │     ↓    │     ↓    │
│ 用户选择 │ 更新UI  │ 用户确认 │
│     ↓    │     ↓    │     ↓    │
│ 保存设置 │ Toast提示│ 执行清除 │
│     ↓    │         │     ↓    │
│ 更新UI  │         │ 更新UI  │
│     ↓    │         │     ↓    │
│ Toast提示│         │ Toast提示│
└─────────┴─────────┴─────────┘
    ↓
返回正常显示状态
```

## 7. 异常处理设计

### 7.1 网络异常处理

**场景**: 切换服务商时网络请求失败

**处理策略**：
1. 捕获异常，不崩溃
2. 显示友好的错误提示
3. 保持原有状态不变
4. 提供重试选项

**错误提示**：
```
Toast: "切换失败，请检查网络连接"
或
Snackbar: "切换失败，请检查网络连接" + [重试]按钮
```

### 7.2 权限异常处理

**场景**: 悬浮窗权限被拒绝

**处理策略**：
1. 检测权限状态
2. 显示权限说明对话框
3. 引导用户到系统设置
4. 返回后重新检测权限

**错误提示**：
```
对话框: "需要悬浮窗权限"
内容: 详细说明权限用途
按钮: [取消] [去授权]
```

### 7.3 数据保存异常处理

**场景**: SharedPreferences保存失败

**处理策略**：
1. 捕获异常
2. 恢复原有状态
3. 显示错误提示
4. 记录错误日志

**错误提示**：
```
Toast: "保存设置失败，请稍后重试"
```

### 7.4 服务启动异常处理

**场景**: 悬浮窗服务启动失败

**处理策略**：
1. 捕获异常
2. 关闭开关
3. 显示详细错误信息
4. 提供重试机制（最多3次）

**错误提示**：
```
Toast: "启动失败: [错误原因]"
或
对话框: "服务启动失败"
内容: 详细错误信息
按钮: [取消] [重试]
```

## 8. 性能设计

### 8.1 响应性能

**性能指标**：
- **页面加载**: < 500ms
- **开关响应**: < 100ms
- **对话框显示**: < 200ms
- **数据保存**: < 50ms

**优化策略**：
- 使用`lazy`延迟初始化SharedPreferences
- 使用`Flow`避免不必要的数据库查询
- 使用`remember`缓存Compose状态
- 避免在主线程执行IO操作

### 8.2 内存管理

**内存指标**：
- **页面驻留**: < 50MB
- **峰值内存**: < 80MB

**优化策略**：
- 及时释放不用的资源
- 避免内存泄漏
- 使用`DisposableEffect`管理生命周期
- 避免持有Activity引用

### 8.3 电池优化

**优化策略**：
- 减少不必要的UI刷新
- 避免频繁的数据库查询
- 合理使用动画
- 避免后台任务

## 9. 可访问性设计

### 9.1 内容描述

**所有UI元素都需要contentDescription**：

```kotlin
// 服务商卡片
contentDescription = "当前AI服务商: $providerName, 点击切换"

// 数据掩码开关
contentDescription = "数据掩码开关, 当前${if (enabled) "开启" else "关闭"}"

// 悬浮窗开关
contentDescription = "悬浮窗开关, 当前${if (enabled) "开启" else "关闭"}"

// 管理服务商按钮
contentDescription = "管理AI服务商, 点击进入配置页面"
```

### 9.2 TalkBack支持

**朗读顺序**：
1. Section标题
2. 卡片内容
3. 开关状态
4. 说明文字

**朗读示例**：
```
"AI服务商"
"当前服务商: DeepSeek, 点击切换"
"管理AI服务商按钮"

"隐私设置"
"数据掩码开关, 当前开启"
"AI分析前自动掩码敏感信息"
```

### 9.3 触摸目标

**最小触摸目标**: 48dp x 48dp

**组件触摸区域**：
- **卡片**: 整个卡片可点击
- **开关**: 48dp x 48dp
- **按钮**: 最小48dp高度

## 10. 主题设计

### 10.1 浅色主题

```kotlin
// 主要颜色
primary = Color(0xFF1976D2)
onPrimary = Color(0xFFFFFFFF)
primaryContainer = Color(0xFFD1E4FF)
onPrimaryContainer = Color(0xFF001D36)

// 表面颜色
surface = Color(0xFFFFFFFF)
onSurface = Color(0xFF1C1B1F)
surfaceVariant = Color(0xFFE7E0EC)
onSurfaceVariant = Color(0xFF49454F)

// 错误颜色
error = Color(0xFFB3261E)
onError = Color(0xFFFFFFFF)
errorContainer = Color(0xFFF9DEDC)
onErrorContainer = Color(0xFF410E0B)

// 成功颜色（自定义）
success = Color(0xFF4CAF50)
onSuccess = Color(0xFFFFFFFF)
```

### 10.2 深色主题

```kotlin
// 主要颜色
primary = Color(0xFF90CAF9)
onPrimary = Color(0xFF003258)
primaryContainer = Color(0xFF004A77)
onPrimaryContainer = Color(0xFFD1E4FF)

// 表面颜色
surface = Color(0xFF1C1B1F)
onSurface = Color(0xFFE6E1E5)
surfaceVariant = Color(0xFF49454F)
onSurfaceVariant = Color(0xFFCAC4D0)

// 错误颜色
error = Color(0xFFF2B8B5)
onError = Color(0xFF601410)
errorContainer = Color(0xFF8C1D18)
onErrorContainer = Color(0xFFF9DEDC)

// 成功颜色（自定义）
success = Color(0xFF81C784)
onSuccess = Color(0xFF003300)
```

### 10.3 主题切换

**切换方式**: 跟随系统主题设置

```kotlin
@Composable
fun EmpathyTheme(
    darkTheme: Boolean = isSystemInDarkTheme(),
    content: @Composable () -> Unit
) {
    val colorScheme = if (darkTheme) {
        darkColorScheme()
    } else {
        lightColorScheme()
    }
    
    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        content = content
    )
}
```

## 11. 验收标准

### 11.1 功能验收

- [ ] AI服务商配置功能完整可用
- [ ] 隐私保护设置能正确保存和恢复
- [ ] 悬浮窗设置能正常控制服务启停
- [ ] 所有开关状态能持久化保存
- [ ] 应用重启后能恢复上次的设置状态
- [ ] 清除数据功能能正确清除所有设置

### 11.2 UI验收

- [ ] 所有UI元素符合Material Design 3规范
- [ ] 所有文字清晰易读
- [ ] 所有图标大小一致
- [ ] 所有间距符合设计规范
- [ ] 支持深色模式
- [ ] 支持不同屏幕尺寸

### 11.3 交互验收

- [ ] 所有按钮点击有视觉反馈
- [ ] 所有开关切换有动画效果
- [ ] 所有对话框有进入退出动画
- [ ] 所有Toast提示清晰明确
- [ ] 所有错误提示友好且有指导意义

### 11.4 性能验收

- [ ] 页面加载时间 < 500ms
- [ ] 开关响应时间 < 100ms
- [ ] 内存占用 < 50MB
- [ ] 无内存泄漏
- [ ] 无ANR

### 11.5 可访问性验收

- [ ] 所有UI元素都有contentDescription
- [ ] TalkBack能正确朗读所有内容
- [ ] 触摸目标不小于48dp
- [ ] 支持键盘导航

## 12. 附录

### 12.1 相关文档

- [PRD-00002-设置功能需求](../PRD/PRD-00002-设置功能需求.md)
- [TDD-00002-设置架构设计](../TDD/TDD-00002-设置架构设计.md)（待创建）

### 12.2 设计资源

**Material Design 3 组件**：
- Card: https://m3.material.io/components/cards
- Switch: https://m3.material.io/components/switch
- Dialog: https://m3.material.io/components/dialogs
- Button: https://m3.material.io/components/buttons

**图标资源**：
- Material Icons: https://fonts.google.com/icons
- 使用24dp图标
- 使用Filled风格

## 13. 技术实现设计

### 13.1 Repository层扩展

**SettingsRepository接口扩展**：

```kotlin
interface SettingsRepository {
    // 现有方法...
    
    // 隐私设置方法
    suspend fun getDataMaskingEnabled(): Result<Boolean>
    suspend fun setDataMaskingEnabled(enabled: Boolean): Result<Unit>
    suspend fun getLocalFirstModeEnabled(): Result<Boolean>
    suspend fun setLocalFirstModeEnabled(enabled: Boolean): Result<Unit>
    
    // 批量操作
    suspend fun getAllSettings(): Result<Map<String, Any>>
    suspend fun resetToDefaults(): Result<Unit>
}
```

**SettingsRepositoryImpl实现**：

```kotlin
@Singleton
class SettingsRepositoryImpl @Inject constructor(
    @ApplicationContext private val context: Context
) : SettingsRepository {
    
    private val privacyPrefs by lazy {
        context.getSharedPreferences("privacy_settings", Context.MODE_PRIVATE)
    }
    
    // 缓存策略：使用内存缓存减少IO操作
    private val settingsCache = mutableMapOf<String, Any>()
    
    override suspend fun getDataMaskingEnabled(): Result<Boolean> {
        return withContext(Dispatchers.IO) {
            try {
                val cached = settingsCache["data_masking"] as? Boolean
                if (cached != null) return@withContext Result.success(cached)
                
                val value = privacyPrefs.getBoolean("privacy_data_masking_enabled", true)
                settingsCache["data_masking"] = value
                Result.success(value)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    }
    
    override suspend fun setDataMaskingEnabled(enabled: Boolean): Result<Unit> {
        return withContext(Dispatchers.IO) {
            try {
                privacyPrefs.edit()
                    .putBoolean("privacy_data_masking_enabled", enabled)
                    .apply()
                settingsCache["data_masking"] = enabled
                Result.success(Unit)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    }
}
```

### 13.2 ViewModel层设计

**状态管理策略**：

```kotlin
@HiltViewModel
class SettingsViewModel @Inject constructor(
    application: Application,
    private val settingsRepository: SettingsRepository,
    private val floatingWindowPreferences: FloatingWindowPreferences,
    private val aiProviderRepository: AiProviderRepository
) : AndroidViewModel(application) {
    
    // 状态管理
    private val _uiState = MutableStateFlow(SettingsUiState())
    val uiState: StateFlow<SettingsUiState> = _uiState.asStateFlow()
    
    // 事件处理的并发控制
    private val eventMutex = Mutex()
    
    init {
        loadSettings()
        observeProviders()
    }
    
    // 异步操作的并发控制
    fun onEvent(event: SettingsUiEvent) {
        viewModelScope.launch {
            eventMutex.withLock {
                handleEvent(event)
            }
        }
    }
    
    private suspend fun handleEvent(event: SettingsUiEvent) {
        when (event) {
            is SettingsUiEvent.ToggleDataMasking -> toggleDataMasking()
            // 其他事件...
        }
    }
    
    // 状态恢复的容错方案
    private fun loadSettings() {
        viewModelScope.launch {
            try {
                val dataMasking = settingsRepository.getDataMaskingEnabled()
                    .getOrDefault(true)
                val localFirst = settingsRepository.getLocalFirstModeEnabled()
                    .getOrDefault(true)
                
                _uiState.update {
                    it.copy(
                        dataMaskingEnabled = dataMasking,
                        localFirstMode = localFirst
                    )
                }
            } catch (e: Exception) {
                Log.e("SettingsViewModel", "加载设置失败", e)
                // 使用默认值，不影响应用使用
            }
        }
    }
}
```

### 13.3 依赖注入设计

**Module配置**：

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object SettingsModule {
    
    @Provides
    @Singleton
    fun provideSettingsRepository(
        @ApplicationContext context: Context
    ): SettingsRepository {
        return SettingsRepositoryImpl(context)
    }
    
    @Provides
    @Singleton
    fun provideFloatingWindowPreferences(
        @ApplicationContext context: Context
    ): FloatingWindowPreferences {
        return FloatingWindowPreferences(context)
    }
}
```

### 13.4 数据持久化设计

**SharedPreferences键值规范**：

| 键名 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `privacy_data_masking_enabled` | Boolean | true | 数据掩码开关 |
| `privacy_local_first_mode_enabled` | Boolean | true | 本地优先模式 |
| `floating_window_enabled` | Boolean | false | 悬浮窗启用状态 |
| `floating_window_position_x` | Int | -1 | 悬浮窗X坐标 |
| `floating_window_position_y` | Int | -1 | 悬浮窗Y坐标 |

**数据版本兼容性**：

```kotlin
object SettingsVersionManager {
    private const val KEY_VERSION = "settings_version"
    private const val CURRENT_VERSION = 1
    
    fun migrateIfNeeded(prefs: SharedPreferences) {
        val version = prefs.getInt(KEY_VERSION, 0)
        
        when {
            version < 1 -> migrateToV1(prefs)
            // 未来版本的迁移...
        }
        
        prefs.edit().putInt(KEY_VERSION, CURRENT_VERSION).apply()
    }
    
    private fun migrateToV1(prefs: SharedPreferences) {
        // 从旧版本迁移数据
        // 例如：重命名键名、转换数据格式等
    }
}
```

## 14. 测试设计

### 14.1 单元测试设计

**SettingsRepositoryImpl测试**：

```kotlin
@RunWith(AndroidJUnit4::class)
class SettingsRepositoryImplTest {
    
    private lateinit var context: Context
    private lateinit var repository: SettingsRepositoryImpl
    
    @Before
    fun setup() {
        context = ApplicationProvider.getApplicationContext()
        repository = SettingsRepositoryImpl(context)
    }
    
    @After
    fun tearDown() {
        // 清理测试数据
        context.getSharedPreferences("privacy_settings", Context.MODE_PRIVATE)
            .edit().clear().commit()
    }
    
    @Test
    fun `数据掩码默认开启`() = runTest {
        val result = repository.getDataMaskingEnabled()
        assertTrue(result.isSuccess)
        assertTrue(result.getOrNull() == true)
    }
    
    @Test
    fun `能正确保存和读取数据掩码设置`() = runTest {
        repository.setDataMaskingEnabled(false)
        val result = repository.getDataMaskingEnabled()
        assertFalse(result.getOrNull() == true)
    }
    
    @Test
    fun `设置保存失败时返回错误`() = runTest {
        // 模拟IO异常
        // ...
    }
}
```

**SettingsViewModel测试**：

```kotlin
@RunWith(AndroidJUnit4::class)
class SettingsViewModelTest {
    
    @get:Rule
    val instantExecutorRule = InstantTaskExecutorRule()
    
    private lateinit var viewModel: SettingsViewModel
    private lateinit var mockRepository: SettingsRepository
    
    @Before
    fun setup() {
        mockRepository = mockk()
        viewModel = SettingsViewModel(
            application = ApplicationProvider.getApplicationContext(),
            settingsRepository = mockRepository,
            // 其他依赖...
        )
    }
    
    @Test
    fun `切换数据掩码能正确保存`() = runTest {
        // Given
        coEvery { mockRepository.setDataMaskingEnabled(any()) } returns Result.success(Unit)
        
        // When
        viewModel.onEvent(SettingsUiEvent.ToggleDataMasking)
        
        // Then
        coVerify { mockRepository.setDataMaskingEnabled(false) }
        assertFalse(viewModel.uiState.value.dataMaskingEnabled)
    }
}
```

### 14.2 UI测试设计

**SettingsScreen测试**：

```kotlin
@RunWith(AndroidJUnit4::class)
class SettingsScreenTest {
    
    @get:Rule
    val composeTestRule = createComposeRule()
    
    @Test
    fun `点击数据掩码开关能正确切换状态`() {
        // Given
        var dataMaskingEnabled = true
        composeTestRule.setContent {
            SettingsScreen(
                uiState = SettingsUiState(dataMaskingEnabled = dataMaskingEnabled),
                onEvent = { event ->
                    if (event is SettingsUiEvent.ToggleDataMasking) {
                        dataMaskingEnabled = !dataMaskingEnabled
                    }
                },
                onNavigateBack = {},
                onNavigateToAiConfig = {}
            )
        }
        
        // When
        composeTestRule.onNodeWithText("数据掩码").performClick()
        
        // Then
        assertFalse(dataMaskingEnabled)
    }
    
    @Test
    fun `未配置服务商时显示提示卡片`() {
        composeTestRule.setContent {
            SettingsScreen(
                uiState = SettingsUiState(availableProviders = emptyList()),
                onEvent = {},
                onNavigateBack = {},
                onNavigateToAiConfig = {}
            )
        }
        
        composeTestRule.onNodeWithText("尚未配置 AI 服务商").assertExists()
    }
}
```

### 14.3 集成测试设计

**设置持久化集成测试**：

```kotlin
@RunWith(AndroidJUnit4::class)
class SettingsPersistenceIntegrationTest {
    
    @Test
    fun `设置变更后能在业务逻辑中正确读取`() = runTest {
        // Given
        val context = ApplicationProvider.getApplicationContext<Context>()
        val repository = SettingsRepositoryImpl(context)
        val privacyEngine = PrivacyEngine(repository)
        
        // When
        repository.setDataMaskingEnabled(false)
        val result = privacyEngine.maskSensitiveData("手机号：13000000000")
        
        // Then
        assertEquals("手机号：13000000000", result) // 未掩码
    }
}
```

### 14.4 性能测试设计

**性能基准测试**：

```kotlin
@RunWith(AndroidJUnit4::class)
class SettingsPerformanceTest {
    
    @Test
    fun `页面加载时间应小于500ms`() {
        val startTime = System.currentTimeMillis()
        
        composeTestRule.setContent {
            SettingsScreen(
                uiState = SettingsUiState(),
                onEvent = {},
                onNavigateBack = {},
                onNavigateToAiConfig = {}
            )
        }
        
        composeTestRule.waitForIdle()
        val loadTime = System.currentTimeMillis() - startTime
        
        assertTrue("页面加载时间: ${loadTime}ms", loadTime < 500)
    }
    
    @Test
    fun `开关响应时间应小于100ms`() {
        var responseTime = 0L
        
        composeTestRule.setContent {
            SettingsScreen(
                uiState = SettingsUiState(),
                onEvent = { event ->
                    if (event is SettingsUiEvent.ToggleDataMasking) {
                        responseTime = System.currentTimeMillis()
                    }
                },
                onNavigateBack = {},
                onNavigateToAiConfig = {}
            )
        }
        
        val clickTime = System.currentTimeMillis()
        composeTestRule.onNodeWithText("数据掩码").performClick()
        
        assertTrue("响应时间: ${responseTime - clickTime}ms", 
            responseTime - clickTime < 100)
    }
}
```

## 15. 部署和维护

### 15.1 发布检查清单

**功能检查**：
- [ ] 所有设置项能正确保存和恢复
- [ ] 应用重启后设置状态保持不变
- [ ] 服务商切换功能正常
- [ ] 悬浮窗权限管理正常
- [ ] 清除数据功能正常

**性能检查**：
- [ ] 页面加载时间 < 500ms
- [ ] 开关响应时间 < 100ms
- [ ] 内存占用 < 50MB
- [ ] 无内存泄漏
- [ ] 无ANR

**兼容性检查**：
- [ ] Android 7.0 (API 24) 正常运行
- [ ] Android 12+ (API 31+) 正常运行
- [ ] 小米、华为、OPPO等主流ROM正常运行
- [ ] 不同屏幕尺寸正常显示
- [ ] 横竖屏切换正常

**安全检查**：
- [ ] API Key使用加密存储
- [ ] 权限申请有明确说明
- [ ] 无硬编码的密钥
- [ ] 敏感操作有日志记录

### 15.2 监控和告警

**性能监控**：
```kotlin
object SettingsPerformanceMonitor {
    fun trackPageLoad(duration: Long) {
        if (duration > 500) {
            Log.w("Performance", "设置页面加载慢: ${duration}ms")
            // 上报到监控系统
        }
    }
    
    fun trackSwitchResponse(duration: Long) {
        if (duration > 100) {
            Log.w("Performance", "开关响应慢: ${duration}ms")
        }
    }
}
```

**错误监控**：
```kotlin
object SettingsErrorMonitor {
    fun trackError(error: Throwable, context: String) {
        Log.e("SettingsError", "错误发生在: $context", error)
        // 上报到错误收集系统
    }
}
```

### 15.3 问题排查指南

**常见问题**：

| 问题 | 可能原因 | 排查步骤 | 解决方案 |
|------|---------|---------|---------|
| 设置不保存 | SharedPreferences写入失败 | 检查存储权限、磁盘空间 | 清理缓存、重新安装 |
| 服务商切换失败 | 网络异常、数据库错误 | 检查网络连接、数据库状态 | 重试操作、清除数据 |
| 悬浮窗无法启动 | 权限不足、系统限制 | 检查权限状态、系统版本 | 引导用户授权 |
| 页面加载慢 | 数据量大、IO阻塞 | 检查数据库大小、IO操作 | 优化查询、异步加载 |

### 15.4 版本升级策略

**数据迁移**：
```kotlin
object SettingsMigration {
    fun migrate(from: Int, to: Int) {
        when {
            from < 1 && to >= 1 -> migrateToV1()
            from < 2 && to >= 2 -> migrateToV2()
            // 更多版本迁移...
        }
    }
    
    private fun migrateToV1() {
        // v1迁移逻辑
    }
}
```

### 12.3 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2024-12-12 | 初始版本 | Claude |
| v1.1 | 2024-12-12 | 补充技术实现设计、测试设计、部署维护章节 | Claude |
