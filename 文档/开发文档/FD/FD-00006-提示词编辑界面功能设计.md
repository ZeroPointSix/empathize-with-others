# FD-00006: æç¤ºè¯ç¼–è¾‘ç•Œé¢åŠŸèƒ½è®¾è®¡

> **æ–‡æ¡£ç±»å‹**: åŠŸèƒ½è®¾è®¡æ–‡æ¡£ (FD)  
> **ç‰ˆæœ¬**: 1.2  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-16  
> **æœ€åæ›´æ–°**: 2026-01-07  
> **è´Ÿè´£äºº**: Kiro  
> **çŠ¶æ€**: âœ… å®¡æŸ¥ä¿®è®¢å®Œæˆ  
> **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­  
> **å…³è”PRD**: PRD-00006  
> **å…³è”FD**: FD-00005ï¼ˆæç¤ºè¯ç®¡ç†ç³»ç»ŸåŠŸèƒ½è®¾è®¡ï¼‰

---

## ğŸ“œ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-16 | Kiro | åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«å®Œæ•´UIæ¶æ„è®¾è®¡ |
| 1.1 | 2025-12-16 | Kiro | æ ¹æ®DR-00012å®¡æŸ¥æŠ¥å‘Šè¡¥å……ï¼šå›½é™…åŒ–è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–ã€æ‰©å±•æµ‹è¯•ç”¨ä¾‹ã€ç‰ˆæœ¬å…¼å®¹æ€§ |
| 1.2 | 2026-01-07 | Kiro | æ ¹æ®FD-00006å®¡æŸ¥æŠ¥å‘Šä¿®è®¢ï¼š<br>- ä¿®å¤ç›®å½•é‡å¤æ¡ç›®<br>- æ·»åŠ InlineErrorBannerç»„ä»¶è¯¦ç»†è®¾è®¡<br>- è¡¥å……ViewModelé˜²æŠ–å®ç°ä»£ç <br>- æ·»åŠ å¤ç”¨ç»„ä»¶è¯´æ˜è¡¨æ ¼ |

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°æç¤ºè¯ç¼–è¾‘ç•Œé¢çš„æŠ€æœ¯æ¶æ„ã€ç»„ä»¶è®¾è®¡ã€çŠ¶æ€ç®¡ç†å’Œå®ç°ç»†èŠ‚ã€‚

**è®¾è®¡ç›®æ ‡**ï¼š
- æ‰“é€ æç®€ã€èšç„¦çš„æç¤ºè¯ç¼–è¾‘ä½“éªŒ
- æ²¿ç”¨äº§å“æ ‡å¿—æ€§çš„æƒ…æ„ŸåŒ–è®¾è®¡è¯­è¨€ï¼ˆæš–è‰²å…‰æ™• + ç£¨ç ‚ç»ç’ƒï¼‰
- ç¡®ä¿é”®ç›˜å¼¹èµ·æ—¶çš„è‰¯å¥½äº¤äº’ä½“éªŒ
- æ”¯æŒå…¨å±€æç¤ºè¯å’Œè”ç³»äººæç¤ºè¯ä¸¤ç§ç¼–è¾‘æ¨¡å¼

**ä¾èµ–åº“ç‰ˆæœ¬**ï¼š
- Jetpack Compose BOM: 2024.12.01
- Material 3: 1.3.1
- Navigation Compose: 2.8.5
- Hilt: 2.52


---

## ğŸ“‘ ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
3. [æ ¸å¿ƒç»„ä»¶è®¾è®¡](#æ ¸å¿ƒç»„ä»¶è®¾è®¡)
4. [çŠ¶æ€ç®¡ç†è®¾è®¡](#çŠ¶æ€ç®¡ç†è®¾è®¡)
5. [å¯¼èˆªè®¾è®¡](#å¯¼èˆªè®¾è®¡)
6. [è§†è§‰ç»„ä»¶è®¾è®¡](#è§†è§‰ç»„ä»¶è®¾è®¡)
7. [äº¤äº’è®¾è®¡](#äº¤äº’è®¾è®¡)
8. [é”™è¯¯å¤„ç†æœºåˆ¶](#é”™è¯¯å¤„ç†æœºåˆ¶)
9. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
10. [å›½é™…åŒ–è®¾è®¡](#å›½é™…åŒ–è®¾è®¡)
11. [æ€§èƒ½ä¼˜åŒ–è®¾è®¡](#æ€§èƒ½ä¼˜åŒ–è®¾è®¡)
12. [æ‰©å±•æµ‹è¯•ç”¨ä¾‹](#æ‰©å±•æµ‹è¯•ç”¨ä¾‹)
13. [ç‰ˆæœ¬å…¼å®¹æ€§](#ç‰ˆæœ¬å…¼å®¹æ€§)
14. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              PromptEditorScreen                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚           EmotionalBackground              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚         GlassmorphicCard             â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚      PromptEditorTopBar        â”‚  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚      PromptInputField          â”‚  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚      CharacterCounter          â”‚  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           PromptEditorViewModel                   â”‚  â”‚
â”‚  â”‚  - UiState ç®¡ç†                                   â”‚  â”‚
â”‚  â”‚  - äº‹ä»¶å¤„ç†                                       â”‚  â”‚
â”‚  â”‚  - æ•°æ®åŠ è½½/ä¿å­˜                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Domain Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚PromptRepositoryâ”‚ â”‚PromptValidatorâ”‚ â”‚PromptScene  â”‚  â”‚
â”‚  â”‚   (æ¥å£)      â”‚  â”‚  (éªŒè¯å™¨)    â”‚  â”‚  (åœºæ™¯æšä¸¾) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—åˆ’åˆ†

```
presentation/
â”œâ”€â”€ ui/screen/prompt/
â”‚   â”œâ”€â”€ PromptEditorScreen.kt           # ä¸»ç•Œé¢
â”‚   â”œâ”€â”€ PromptEditorUiState.kt          # UIçŠ¶æ€
â”‚   â”œâ”€â”€ PromptEditorUiEvent.kt          # UIäº‹ä»¶
â”‚   â””â”€â”€ component/
â”‚       â”œâ”€â”€ PromptEditorTopBar.kt       # é¡¶éƒ¨å¯¼èˆªæ 
â”‚       â”œâ”€â”€ PromptInputField.kt         # è¾“å…¥æ¡†ç»„ä»¶
â”‚       â”œâ”€â”€ CharacterCounter.kt         # å­—ç¬¦è®¡æ•°å™¨
â”‚       â””â”€â”€ DiscardConfirmDialog.kt     # æ”¾å¼ƒç¡®è®¤å¯¹è¯æ¡†
â”œâ”€â”€ viewmodel/
â”‚   â””â”€â”€ PromptEditorViewModel.kt        # ViewModel
â”œâ”€â”€ navigation/
â”‚   â””â”€â”€ PromptEditorNavigation.kt       # å¯¼èˆªå®šä¹‰
â””â”€â”€ theme/
    â””â”€â”€ BrandColors.kt                  # å“ç‰Œè‰²å®šä¹‰ï¼ˆæ‰©å±•ï¼‰
```


---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### 1. PromptEditorUiStateï¼ˆUIçŠ¶æ€ï¼‰

**èŒè´£**ï¼šç®¡ç†ç¼–è¾‘å™¨ç•Œé¢çš„å®Œæ•´çŠ¶æ€

```kotlin
data class PromptEditorUiState(
    // ç¼–è¾‘æ¨¡å¼
    val editMode: PromptEditMode = PromptEditMode.GlobalScene(PromptScene.ANALYZE),
    
    // å†…å®¹çŠ¶æ€
    val originalPrompt: String = "",          // åŸå§‹æç¤ºè¯ï¼ˆç”¨äºæ£€æµ‹ä¿®æ”¹ï¼‰
    val currentPrompt: String = "",           // å½“å‰ç¼–è¾‘çš„æç¤ºè¯
    val placeholderText: String = "",         // åŠ¨æ€å ä½ç¬¦æ–‡æ¡ˆ
    
    // åŠ è½½çŠ¶æ€
    val isLoading: Boolean = false,           // åˆå§‹åŠ è½½çŠ¶æ€
    val isSaving: Boolean = false,            // ä¿å­˜çŠ¶æ€
    
    // å¯¹è¯æ¡†çŠ¶æ€
    val showDiscardDialog: Boolean = false,   // æ˜¾ç¤ºæ”¾å¼ƒä¿®æ”¹å¯¹è¯æ¡†
    
    // é”™è¯¯çŠ¶æ€
    val errorMessage: String? = null          // é”™è¯¯ä¿¡æ¯
) {
    // è®¡ç®—å±æ€§
    val charCount: Int get() = currentPrompt.length
    val isOverLimit: Boolean get() = charCount > MAX_PROMPT_LENGTH
    val isNearLimit: Boolean get() = charCount > WARN_PROMPT_LENGTH
    val hasUnsavedChanges: Boolean get() = currentPrompt != originalPrompt
    val canSave: Boolean get() = !isOverLimit && !isSaving && !isLoading
    
    // æ ‡é¢˜æ–‡æ¡ˆ
    val titleText: String get() = when (editMode) {
        is PromptEditMode.GlobalScene -> "ç¼–è¾‘æŒ‡ä»¤"
        is PromptEditMode.ContactCustom -> "ç¼–è¾‘ä¸“å±æŒ‡ä»¤"
    }
    
    companion object {
        const val MAX_PROMPT_LENGTH = 1000
        const val WARN_PROMPT_LENGTH = 800
    }
}
```

### 2. PromptEditModeï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰

**èŒè´£**ï¼šåŒºåˆ†å…¨å±€åœºæ™¯ç¼–è¾‘å’Œè”ç³»äººä¸“å±ç¼–è¾‘

```kotlin
sealed class PromptEditMode {
    /**
     * å…¨å±€åœºæ™¯æç¤ºè¯ç¼–è¾‘
     * @param scene åœºæ™¯ç±»å‹
     */
    data class GlobalScene(val scene: PromptScene) : PromptEditMode()
    
    /**
     * è”ç³»äººä¸“å±æç¤ºè¯ç¼–è¾‘
     * @param contactId è”ç³»äººID
     * @param contactName è”ç³»äººåç§°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
     */
    data class ContactCustom(
        val contactId: String,
        val contactName: String
    ) : PromptEditMode()
}
```

### 3. PromptEditorUiEventï¼ˆUIäº‹ä»¶ï¼‰

**èŒè´£**ï¼šå®šä¹‰ç”¨æˆ·äº¤äº’äº§ç”Ÿçš„æ‰€æœ‰äº‹ä»¶

```kotlin
sealed class PromptEditorUiEvent {
    // å†…å®¹ç¼–è¾‘
    data class UpdatePrompt(val text: String) : PromptEditorUiEvent()
    
    // æ“ä½œæŒ‰é’®
    object SavePrompt : PromptEditorUiEvent()
    object CancelEdit : PromptEditorUiEvent()
    
    // å¯¹è¯æ¡†äº¤äº’
    object ConfirmDiscard : PromptEditorUiEvent()
    object DismissDiscardDialog : PromptEditorUiEvent()
    
    // é”™è¯¯å¤„ç†
    object ClearError : PromptEditorUiEvent()
}
```

### 4. PromptEditorResultï¼ˆç¼–è¾‘ç»“æœï¼‰

**èŒè´£**ï¼šå‘è°ƒç”¨æ–¹è¿”å›ç¼–è¾‘ç»“æœ

```kotlin
sealed class PromptEditorResult {
    object Saved : PromptEditorResult()      // ä¿å­˜æˆåŠŸ
    object Cancelled : PromptEditorResult()  // ç”¨æˆ·å–æ¶ˆ
}
```


---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. PromptEditorViewModel

**èŒè´£**ï¼šç®¡ç†ç¼–è¾‘å™¨çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€

```kotlin
@HiltViewModel
class PromptEditorViewModel @Inject constructor(
    private val promptRepository: PromptRepository,
    private val promptValidator: PromptValidator,
    savedStateHandle: SavedStateHandle
) : ViewModel() {

    // ä»å¯¼èˆªå‚æ•°è·å–ç¼–è¾‘æ¨¡å¼
    private val editMode: PromptEditMode = parseEditMode(savedStateHandle)
    
    private val _uiState = MutableStateFlow(
        PromptEditorUiState(
            editMode = editMode,
            placeholderText = getPlaceholderText(editMode)
        )
    )
    val uiState: StateFlow<PromptEditorUiState> = _uiState.asStateFlow()
    
    // ç¼–è¾‘ç»“æœå›è°ƒ
    private val _result = MutableSharedFlow<PromptEditorResult>()
    val result: SharedFlow<PromptEditorResult> = _result.asSharedFlow()
    
    init {
        loadPrompt()
    }
    
    fun onEvent(event: PromptEditorUiEvent) {
        when (event) {
            is PromptEditorUiEvent.UpdatePrompt -> updatePrompt(event.text)
            is PromptEditorUiEvent.SavePrompt -> savePrompt()
            is PromptEditorUiEvent.CancelEdit -> handleCancel()
            is PromptEditorUiEvent.ConfirmDiscard -> confirmDiscard()
            is PromptEditorUiEvent.DismissDiscardDialog -> dismissDiscardDialog()
            is PromptEditorUiEvent.ClearError -> clearError()
        }
    }
    
    private fun loadPrompt() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            
            try {
                val prompt = when (val mode = editMode) {
                    is PromptEditMode.GlobalScene -> 
                        promptRepository.getGlobalPrompt(mode.scene)
                    is PromptEditMode.ContactCustom -> 
                        promptRepository.getContactPrompt(mode.contactId) ?: ""
                }
                
                _uiState.update { 
                    it.copy(
                        originalPrompt = prompt,
                        currentPrompt = prompt,
                        isLoading = false
                    )
                }
            } catch (e: Exception) {
                _uiState.update { 
                    it.copy(
                        isLoading = false,
                        errorMessage = "åŠ è½½å¤±è´¥: ${e.message}"
                    )
                }
            }
        }
    }
    
    // ğŸ†• é˜²æŠ–å¤„ç† Channelï¼ˆç”¨äºåç»­éªŒè¯ç­‰æ“ä½œï¼‰
    private val promptInputChannel = Channel<String>(Channel.CONFLATED)
    
    init {
        loadPrompt()
        
        // ğŸ†• å¯åŠ¨é˜²æŠ–å¤„ç†åç¨‹
        viewModelScope.launch {
            promptInputChannel.receiveAsFlow()
                .debounce(300L)  // 300ms é˜²æŠ–
                .collect { text ->
                    // å¯åœ¨æ­¤å¤„æ·»åŠ éªŒè¯é€»è¾‘
                    // validatePrompt(text)
                }
        }
    }
    
    private fun updatePrompt(text: String) {
        // ğŸ›¡ï¸ å¤§æ–‡æœ¬ä¿æŠ¤ï¼šå…ˆæˆªæ–­å†å¤„ç†
        val safeText = text.take(PromptEditorUiState.MAX_PROMPT_LENGTH)
        
        // ç«‹å³æ›´æ–° UIï¼ˆä¿è¯è¾“å…¥å“åº”æ€§ï¼‰
        _uiState.update { it.copy(currentPrompt = safeText) }
        
        // å‘é€åˆ° Channel è¿›è¡Œé˜²æŠ–å¤„ç†ï¼ˆç”¨äºåç»­éªŒè¯ç­‰æ“ä½œï¼‰
        viewModelScope.launch {
            promptInputChannel.send(safeText)
        }
    }
    
    private fun savePrompt() {
        val currentState = _uiState.value
        if (!currentState.canSave) return
        
        viewModelScope.launch {
            _uiState.update { it.copy(isSaving = true) }
            
            try {
                val result = when (val mode = editMode) {
                    is PromptEditMode.GlobalScene -> 
                        promptRepository.saveGlobalPrompt(mode.scene, currentState.currentPrompt)
                    is PromptEditMode.ContactCustom -> 
                        promptRepository.saveContactPrompt(
                            mode.contactId, 
                            currentState.currentPrompt.ifBlank { null }
                        )
                }
                
                result.fold(
                    onSuccess = {
                        _result.emit(PromptEditorResult.Saved)
                    },
                    onFailure = { e ->
                        _uiState.update { 
                            it.copy(
                                isSaving = false,
                                errorMessage = "ä¿å­˜å¤±è´¥: ${e.message}"
                            )
                        }
                    }
                )
            } catch (e: Exception) {
                _uiState.update { 
                    it.copy(
                        isSaving = false,
                        errorMessage = "ä¿å­˜å¤±è´¥: ${e.message}"
                    )
                }
            }
        }
    }
    
    private fun handleCancel() {
        if (_uiState.value.hasUnsavedChanges) {
            _uiState.update { it.copy(showDiscardDialog = true) }
        } else {
            viewModelScope.launch {
                _result.emit(PromptEditorResult.Cancelled)
            }
        }
    }
    
    private fun confirmDiscard() {
        viewModelScope.launch {
            _uiState.update { it.copy(showDiscardDialog = false) }
            _result.emit(PromptEditorResult.Cancelled)
        }
    }
    
    private fun dismissDiscardDialog() {
        _uiState.update { it.copy(showDiscardDialog = false) }
    }
    
    private fun clearError() {
        _uiState.update { it.copy(errorMessage = null) }
    }
    
    companion object {
        /**
         * è·å–åŠ¨æ€å ä½ç¬¦æ–‡æ¡ˆ
         */
        fun getPlaceholderText(editMode: PromptEditMode): String {
            return when (editMode) {
                is PromptEditMode.ContactCustom -> 
                    "ä¾‹å¦‚ï¼šå’Œå¥¹èŠå¤©æ—¶è¦æ³¨æ„é¿å¼€å‰ä»»è¯é¢˜..."
                is PromptEditMode.GlobalScene -> when (editMode.scene) {
                    PromptScene.ANALYZE -> "ä¾‹å¦‚ï¼šè¯·å¸®æˆ‘åˆ†æå¥¹è¿™å¥è¯çš„æ½œå°è¯..."
                    PromptScene.CHECK -> "ä¾‹å¦‚ï¼šæ£€æŸ¥æ—¶è¦ç‰¹åˆ«æ³¨æ„å·¥ä½œç›¸å…³è¯é¢˜..."
                    PromptScene.EXTRACT -> "ä¾‹å¦‚ï¼šé‡ç‚¹å…³æ³¨å¯¹æ–¹æåˆ°çš„å…´è¶£çˆ±å¥½..."
                    PromptScene.SUMMARY -> "ä¾‹å¦‚ï¼šæ€»ç»“ä»Šå¤©çš„å¯¹è¯äº®ç‚¹å’Œéœ€è¦æ³¨æ„çš„åœ°æ–¹..."
                }
            }
        }
    }
}
```


---

## ğŸ¨ è§†è§‰ç»„ä»¶è®¾è®¡

### å¤ç”¨ç°æœ‰ç»„ä»¶

æœ¬åŠŸèƒ½å¤ç”¨é¡¹ç›®ä¸­å·²æœ‰çš„æƒ…æ„ŸåŒ–è®¾è®¡ç»„ä»¶ï¼Œä¿æŒè§†è§‰é£æ ¼ä¸€è‡´æ€§ï¼š

| ç»„ä»¶ | æ–‡ä»¶ä½ç½® | å¤ç”¨æ–¹å¼ | ç”¨é€” |
|------|----------|---------|------|
| `EmotionalBackground` | `presentation/ui/component/emotion/EmotionalBackground.kt` | ç›´æ¥ä½¿ç”¨ | åŠ¨æ€å…‰æ™•èƒŒæ™¯å±‚ |
| `GlassmorphicCard` | `presentation/ui/component/emotion/GlassmorphicCard.kt` | ç›´æ¥ä½¿ç”¨ | ç£¨ç ‚ç»ç’ƒå¡ç‰‡å®¹å™¨ |

### 1. PromptEditorScreenï¼ˆä¸»ç•Œé¢ï¼‰

**èŒè´£**ï¼šç»„åˆæ‰€æœ‰å­ç»„ä»¶ï¼Œå¤„ç†é”®ç›˜é¿è®©

```kotlin
@Composable
fun PromptEditorScreen(
    viewModel: PromptEditorViewModel = hiltViewModel(),
    onNavigateBack: () -> Unit
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    // ç›‘å¬ç¼–è¾‘ç»“æœ
    LaunchedEffect(Unit) {
        viewModel.result.collect { result ->
            when (result) {
                is PromptEditorResult.Saved -> {
                    // æ˜¾ç¤ºä¿å­˜æˆåŠŸ Toast
                    onNavigateBack()
                }
                is PromptEditorResult.Cancelled -> {
                    onNavigateBack()
                }
            }
        }
    }
    
    // å¤„ç†è¿”å›é”®
    BackHandler(enabled = uiState.hasUnsavedChanges) {
        viewModel.onEvent(PromptEditorUiEvent.CancelEdit)
    }
    
    Box(
        modifier = Modifier
            .fillMaxSize()
            .imePadding()  // é”®ç›˜é¿è®©
            .navigationBarsPadding()
    ) {
        // èƒŒæ™¯å±‚
        EmotionalBackground(
            emotionType = EmotionType.WARM,
            modifier = Modifier.fillMaxSize()
        )
        
        // å†…å®¹å±‚
        PromptEditorContent(
            uiState = uiState,
            onEvent = viewModel::onEvent,
            modifier = Modifier
                .fillMaxSize()
                .padding(16.dp)
        )
        
        // æ”¾å¼ƒç¡®è®¤å¯¹è¯æ¡†
        if (uiState.showDiscardDialog) {
            DiscardConfirmDialog(
                onConfirm = { viewModel.onEvent(PromptEditorUiEvent.ConfirmDiscard) },
                onDismiss = { viewModel.onEvent(PromptEditorUiEvent.DismissDiscardDialog) }
            )
        }
        
        // é”™è¯¯æç¤º
        uiState.errorMessage?.let { message ->
            LaunchedEffect(message) {
                // æ˜¾ç¤º Snackbar æˆ– Toast
                delay(3000)
                viewModel.onEvent(PromptEditorUiEvent.ClearError)
            }
        }
    }
}

@Composable
private fun PromptEditorContent(
    uiState: PromptEditorUiState,
    onEvent: (PromptEditorUiEvent) -> Unit,
    modifier: Modifier = Modifier
) {
    GlassmorphicCard(
        modifier = modifier
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 20.dp, vertical = 16.dp)
        ) {
            // é¡¶éƒ¨å¯¼èˆªæ 
            PromptEditorTopBar(
                title = uiState.titleText,
                canSave = uiState.canSave,
                isSaving = uiState.isSaving,
                onCancel = { onEvent(PromptEditorUiEvent.CancelEdit) },
                onSave = { onEvent(PromptEditorUiEvent.SavePrompt) }
            )
            
            Spacer(modifier = Modifier.height(16.dp))
            
            // è¾“å…¥åŒºåŸŸ
            PromptInputField(
                value = uiState.currentPrompt,
                onValueChange = { onEvent(PromptEditorUiEvent.UpdatePrompt(it)) },
                placeholder = uiState.placeholderText,
                isLoading = uiState.isLoading,
                modifier = Modifier
                    .fillMaxWidth()
                    .weight(1f, fill = false)
            )
            
            Spacer(modifier = Modifier.height(8.dp))
            
            // å­—ç¬¦è®¡æ•°å™¨
            CharacterCounter(
                currentCount = uiState.charCount,
                maxCount = PromptEditorUiState.MAX_PROMPT_LENGTH,
                isNearLimit = uiState.isNearLimit,
                isOverLimit = uiState.isOverLimit,
                modifier = Modifier.align(Alignment.End)
            )
        }
    }
}
```

### 2. PromptEditorTopBarï¼ˆé¡¶éƒ¨å¯¼èˆªæ ï¼‰

**èŒè´£**ï¼šæ˜¾ç¤ºå–æ¶ˆã€æ ‡é¢˜ã€å®ŒæˆæŒ‰é’®

```kotlin
@Composable
fun PromptEditorTopBar(
    title: String,
    canSave: Boolean,
    isSaving: Boolean,
    onCancel: () -> Unit,
    onSave: () -> Unit,
    modifier: Modifier = Modifier
) {
    Row(
        modifier = modifier
            .fillMaxWidth()
            .height(44.dp),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        // å–æ¶ˆæŒ‰é’®
        TextButton(
            onClick = onCancel,
            enabled = !isSaving
        ) {
            Text(
                text = "å–æ¶ˆ",
                style = MaterialTheme.typography.bodyLarge,
                color = MaterialTheme.colorScheme.onSurface.copy(
                    alpha = if (isSaving) 0.4f else 0.8f
                )
            )
        }
        
        // æ ‡é¢˜
        Text(
            text = title,
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.SemiBold,
            color = MaterialTheme.colorScheme.onSurface
        )
        
        // å®ŒæˆæŒ‰é’® / åŠ è½½åœˆ
        Box(
            modifier = Modifier.width(64.dp),
            contentAlignment = Alignment.CenterEnd
        ) {
            if (isSaving) {
                CircularProgressIndicator(
                    modifier = Modifier.size(20.dp),
                    color = BrandWarmGold,
                    strokeWidth = 2.dp
                )
            } else {
                TextButton(
                    onClick = onSave,
                    enabled = canSave
                ) {
                    Text(
                        text = "å®Œæˆ",
                        style = MaterialTheme.typography.bodyLarge,
                        fontWeight = FontWeight.SemiBold,
                        color = if (canSave) {
                            BrandWarmGold
                        } else {
                            BrandWarmGold.copy(alpha = 0.4f)
                        }
                    )
                }
            }
        }
    }
}
```


### 3. PromptInputFieldï¼ˆè¾“å…¥æ¡†ç»„ä»¶ï¼‰

**èŒè´£**ï¼šæä¾›å“ç‰Œè‰²å…‰æ ‡çš„å¤šè¡Œæ–‡æœ¬è¾“å…¥ï¼Œç¡®ä¿å…‰æ ‡å§‹ç»ˆå¯è§

#### 3.1 åŸºç¡€å®ç°ï¼ˆBringIntoViewRequester æ–¹æ¡ˆï¼‰

```kotlin
@Composable
fun PromptInputField(
    value: String,
    onValueChange: (String) -> Unit,
    placeholder: String,
    isLoading: Boolean,
    modifier: Modifier = Modifier
) {
    val bringIntoViewRequester = remember { BringIntoViewRequester() }
    val coroutineScope = rememberCoroutineScope()
    val scrollState = rememberScrollState()
    
    // é…ç½®å“ç‰Œè‰²é€‰ä¸­æ•ˆæœ
    CompositionLocalProvider(
        LocalTextSelectionColors provides TextSelectionColors(
            handleColor = BrandWarmGold,
            backgroundColor = BrandWarmGold.copy(alpha = 0.3f)
        )
    ) {
        Box(
            modifier = modifier
                .heightIn(min = 200.dp)
                .verticalScroll(scrollState)
        ) {
            if (isLoading) {
                // åŠ è½½çŠ¶æ€
                Box(
                    modifier = Modifier.fillMaxSize(),
                    contentAlignment = Alignment.Center
                ) {
                    CircularProgressIndicator(
                        color = BrandWarmGold,
                        modifier = Modifier.size(32.dp)
                    )
                }
            } else {
                BasicTextField(
                    value = value,
                    onValueChange = { newText ->
                        onValueChange(newText)
                        // ç¡®ä¿å…‰æ ‡ä½ç½®å¯è§
                        coroutineScope.launch {
                            bringIntoViewRequester.bringIntoView()
                        }
                    },
                    modifier = Modifier
                        .fillMaxWidth()
                        .bringIntoViewRequester(bringIntoViewRequester),
                    textStyle = MaterialTheme.typography.bodyLarge.copy(
                        lineHeight = 24.sp,
                        color = MaterialTheme.colorScheme.onSurface
                    ),
                    cursorBrush = SolidColor(BrandWarmGold),
                    decorationBox = { innerTextField ->
                        Box {
                            if (value.isEmpty()) {
                                Text(
                                    text = placeholder,
                                    style = MaterialTheme.typography.bodyLarge.copy(
                                        lineHeight = 24.sp
                                    ),
                                    color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.4f)
                                )
                            }
                            innerTextField()
                        }
                    }
                )
            }
        }
    }
}
```

#### 3.2 å¢å¼ºå®ç°ï¼ˆonTextLayout ç²¾å‡†å®šä½æ–¹æ¡ˆï¼‰

> âš ï¸ **å¤‡é€‰æ–¹æ¡ˆ**ï¼šå¦‚æœåŸºç¡€å®ç°åœ¨é•¿æ–‡æœ¬åœºæ™¯ä¸‹å…‰æ ‡è·Ÿéšä¸å¤Ÿç²¾å‡†ï¼Œå¯é‡‡ç”¨æ­¤å¢å¼ºæ–¹æ¡ˆ

```kotlin
@Composable
fun PromptInputFieldEnhanced(
    value: String,
    onValueChange: (String) -> Unit,
    placeholder: String,
    isLoading: Boolean,
    modifier: Modifier = Modifier
) {
    val textFieldValue = remember(value) {
        TextFieldValue(text = value, selection = TextRange(value.length))
    }
    var currentTextFieldValue by remember { mutableStateOf(textFieldValue) }
    
    val scrollState = rememberScrollState()
    val coroutineScope = rememberCoroutineScope()
    val density = LocalDensity.current
    
    // è®°å½•å…‰æ ‡ä½ç½®ç”¨äºç²¾å‡†æ»šåŠ¨
    var cursorRect by remember { mutableStateOf<Rect?>(null) }
    
    // é…ç½®å“ç‰Œè‰²é€‰ä¸­æ•ˆæœ
    CompositionLocalProvider(
        LocalTextSelectionColors provides TextSelectionColors(
            handleColor = BrandWarmGold,
            backgroundColor = BrandWarmGold.copy(alpha = 0.3f)
        )
    ) {
        Box(
            modifier = modifier
                .heightIn(min = 200.dp)
                .verticalScroll(scrollState)
        ) {
            if (isLoading) {
                Box(
                    modifier = Modifier.fillMaxSize(),
                    contentAlignment = Alignment.Center
                ) {
                    CircularProgressIndicator(
                        color = BrandWarmGold,
                        modifier = Modifier.size(32.dp)
                    )
                }
            } else {
                BasicTextField(
                    value = currentTextFieldValue,
                    onValueChange = { newValue ->
                        currentTextFieldValue = newValue
                        onValueChange(newValue.text)
                    },
                    modifier = Modifier.fillMaxWidth(),
                    textStyle = MaterialTheme.typography.bodyLarge.copy(
                        lineHeight = 24.sp,
                        color = MaterialTheme.colorScheme.onSurface
                    ),
                    cursorBrush = SolidColor(BrandWarmGold),
                    // ğŸ†• é€šè¿‡ onTextLayout è·å–ç²¾å‡†å…‰æ ‡ä½ç½®
                    onTextLayout = { textLayoutResult ->
                        val cursorOffset = currentTextFieldValue.selection.start
                        if (cursorOffset >= 0 && cursorOffset <= currentTextFieldValue.text.length) {
                            try {
                                cursorRect = textLayoutResult.getCursorRect(cursorOffset)
                                
                                // è®¡ç®—å…‰æ ‡åœ¨æ»šåŠ¨å®¹å™¨ä¸­çš„ä½ç½®
                                cursorRect?.let { rect ->
                                    val cursorBottom = rect.bottom
                                    val visibleHeight = scrollState.viewportSize
                                    val currentScroll = scrollState.value
                                    
                                    // å¦‚æœå…‰æ ‡åœ¨å¯è§†åŒºåŸŸä¸‹æ–¹ï¼Œæ»šåŠ¨åˆ°å…‰æ ‡ä½ç½®
                                    if (cursorBottom > currentScroll + visibleHeight - 50) {
                                        coroutineScope.launch {
                                            scrollState.animateScrollTo(
                                                (cursorBottom - visibleHeight + 100).toInt()
                                                    .coerceAtLeast(0)
                                            )
                                        }
                                    }
                                    // å¦‚æœå…‰æ ‡åœ¨å¯è§†åŒºåŸŸä¸Šæ–¹ï¼Œæ»šåŠ¨åˆ°å…‰æ ‡ä½ç½®
                                    else if (rect.top < currentScroll) {
                                        coroutineScope.launch {
                                            scrollState.animateScrollTo(
                                                (rect.top - 50).toInt().coerceAtLeast(0)
                                            )
                                        }
                                    }
                                }
                            } catch (e: Exception) {
                                // å¿½ç•¥è¶Šç•Œå¼‚å¸¸
                            }
                        }
                    },
                    decorationBox = { innerTextField ->
                        Box {
                            if (currentTextFieldValue.text.isEmpty()) {
                                Text(
                                    text = placeholder,
                                    style = MaterialTheme.typography.bodyLarge.copy(
                                        lineHeight = 24.sp
                                    ),
                                    color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.4f)
                                )
                            }
                            innerTextField()
                        }
                    }
                )
            }
        }
    }
}
```

#### 3.3 å…‰æ ‡è·Ÿéšæµ‹è¯•åœºæ™¯

> âš ï¸ **é‡è¦**ï¼šåœ¨é•¿æ–‡æœ¬ï¼ˆè¶…è¿‡ä¸€å±å¹•ï¼‰åœºæ™¯ä¸‹éœ€é‡ç‚¹æµ‹è¯•ä»¥ä¸‹æƒ…å†µ

| æµ‹è¯•åœºæ™¯ | é¢„æœŸè¡Œä¸º | éªŒè¯æ–¹æ³• |
|---------|---------|---------|
| è¾“å…¥åˆ°åº•éƒ¨æ—¶é”®ç›˜å¼¹èµ· | å…‰æ ‡ä¸è¢«é”®ç›˜é®æŒ¡ | è¾“å…¥è¶…è¿‡10è¡Œæ–‡å­—ï¼Œè§‚å¯Ÿæœ€åä¸€è¡Œ |
| å¿«é€Ÿè¿ç»­è¾“å…¥ | æ»šåŠ¨å¹³æ»‘ï¼Œæ— è·³åŠ¨ | å¿«é€Ÿè¾“å…¥50ä¸ªå­—ç¬¦ |
| ç²˜è´´å¤§æ®µæ–‡å­— | å…‰æ ‡å®šä½åˆ°ç²˜è´´æœ«å°¾ | ç²˜è´´500å­—æ–‡æœ¬ |
| ç‚¹å‡»æ–‡æœ¬ä¸­é—´ä½ç½® | å…‰æ ‡æ­£ç¡®å®šä½ | ç‚¹å‡»ç¬¬5è¡Œä¸­é—´ |
| é”®ç›˜æ”¶èµ·åå†å¼¹èµ· | å…‰æ ‡ä½ç½®ä¿æŒ | æ”¶èµ·é”®ç›˜åå†ç‚¹å‡»è¾“å…¥æ¡† |
| æ¨ªç«–å±åˆ‡æ¢ | å…‰æ ‡ä½ç½®ä¿æŒå¯è§ | è¾“å…¥åæ—‹è½¬å±å¹• |

#### 3.4 å®ç°é€‰æ‹©å»ºè®®

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| åŸºç¡€æ–¹æ¡ˆ (BringIntoViewRequester) | å®ç°ç®€å•ï¼Œä»£ç é‡å°‘ | é•¿æ–‡æœ¬åœºæ™¯å¯èƒ½ä¸å¤Ÿç²¾å‡† | MVP é˜¶æ®µé¦–é€‰ |
| å¢å¼ºæ–¹æ¡ˆ (onTextLayout) | ç²¾å‡†å®šä½ï¼Œæ”¯æŒå¤æ‚åœºæ™¯ | ä»£ç å¤æ‚ï¼Œéœ€è¦æ›´å¤šæµ‹è¯• | å¦‚åŸºç¡€æ–¹æ¡ˆæœ‰é—®é¢˜æ—¶å‡çº§ |

**å»ºè®®**ï¼šå…ˆä½¿ç”¨åŸºç¡€æ–¹æ¡ˆå®ç°ï¼Œåœ¨æµ‹è¯•é˜¶æ®µå¦‚æœå‘ç°é•¿æ–‡æœ¬åœºæ™¯æœ‰é—®é¢˜ï¼Œå†å‡çº§åˆ°å¢å¼ºæ–¹æ¡ˆã€‚

### 4. CharacterCounterï¼ˆå­—ç¬¦è®¡æ•°å™¨ï¼‰

**èŒè´£**ï¼šæ˜¾ç¤ºå­—ç¬¦è®¡æ•°å’ŒçŠ¶æ€é¢œè‰²

```kotlin
@Composable
fun CharacterCounter(
    currentCount: Int,
    maxCount: Int,
    isNearLimit: Boolean,
    isOverLimit: Boolean,
    modifier: Modifier = Modifier
) {
    val color = when {
        isOverLimit -> Color.Red
        isNearLimit -> BrandWarmOrange
        else -> MaterialTheme.colorScheme.onSurface.copy(alpha = 0.5f)
    }
    
    Text(
        text = "å­—ç¬¦è®¡æ•°: $currentCount/$maxCount",
        style = MaterialTheme.typography.bodySmall,
        color = color,
        modifier = modifier
    )
}
```

### 5. DiscardConfirmDialogï¼ˆæ”¾å¼ƒç¡®è®¤å¯¹è¯æ¡†ï¼‰

**èŒè´£**ï¼šç¡®è®¤ç”¨æˆ·æ˜¯å¦æ”¾å¼ƒæœªä¿å­˜çš„ä¿®æ”¹

```kotlin
@Composable
fun DiscardConfirmDialog(
    onConfirm: () -> Unit,
    onDismiss: () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = {
            Text(
                text = "æ”¾å¼ƒä¿®æ”¹ï¼Ÿ",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.SemiBold
            )
        },
        text = {
            Text(
                text = "ä½ æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šè¦æ”¾å¼ƒå—ï¼Ÿ",
                style = MaterialTheme.typography.bodyMedium
            )
        },
        confirmButton = {
            TextButton(onClick = onConfirm) {
                Text(
                    text = "æ”¾å¼ƒ",
                    color = Color.Red
                )
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text(
                    text = "ç»§ç»­ç¼–è¾‘",
                    color = BrandWarmGold
                )
            }
        }
    )
}
```

### 6. å“ç‰Œè‰²å®šä¹‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/theme/BrandColors.kt`

```kotlin
// å“ç‰Œæš–è‰²ç³»
val BrandWarmGold = Color(0xFFF5A623)      // æš–é‡‘è‰² - ä¸»è¦æ“ä½œæŒ‰é’®ã€å…‰æ ‡
val BrandWarmOrange = Color(0xFFFF9500)    // æš–æ©™è‰² - è­¦å‘ŠçŠ¶æ€
val BrandWarmAmber = Color(0xFFFFCC00)     // ç¥ç€è‰² - è¾…åŠ©é«˜äº®
```


---

## ğŸ§­ å¯¼èˆªè®¾è®¡

### 1. å¯¼èˆªè·¯ç”±å®šä¹‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/navigation/NavRoutes.kt`ï¼ˆæ‰©å±•ï¼‰

```kotlin
object NavRoutes {
    // ... ç°æœ‰è·¯ç”± ...
    
    // æç¤ºè¯ç¼–è¾‘å™¨è·¯ç”±
    const val PROMPT_EDITOR = "prompt_editor"
    const val PROMPT_EDITOR_ARG_MODE = "mode"
    const val PROMPT_EDITOR_ARG_SCENE = "scene"
    const val PROMPT_EDITOR_ARG_CONTACT_ID = "contactId"
    const val PROMPT_EDITOR_ARG_CONTACT_NAME = "contactName"
    
    // å…¨å±€åœºæ™¯ç¼–è¾‘è·¯ç”±
    fun promptEditorGlobal(scene: PromptScene): String {
        return "$PROMPT_EDITOR?$PROMPT_EDITOR_ARG_MODE=global&$PROMPT_EDITOR_ARG_SCENE=${scene.name}"
    }
    
    // è”ç³»äººä¸“å±ç¼–è¾‘è·¯ç”±
    fun promptEditorContact(contactId: String, contactName: String): String {
        val encodedName = URLEncoder.encode(contactName, "UTF-8")
        return "$PROMPT_EDITOR?$PROMPT_EDITOR_ARG_MODE=contact&$PROMPT_EDITOR_ARG_CONTACT_ID=$contactId&$PROMPT_EDITOR_ARG_CONTACT_NAME=$encodedName"
    }
}
```

### 2. å¯¼èˆªå›¾é…ç½®

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/navigation/NavGraph.kt`ï¼ˆæ‰©å±•ï¼‰

```kotlin
fun NavGraphBuilder.promptEditorNavigation(
    navController: NavController
) {
    composable(
        route = "${NavRoutes.PROMPT_EDITOR}?${NavRoutes.PROMPT_EDITOR_ARG_MODE}={mode}&${NavRoutes.PROMPT_EDITOR_ARG_SCENE}={scene}&${NavRoutes.PROMPT_EDITOR_ARG_CONTACT_ID}={contactId}&${NavRoutes.PROMPT_EDITOR_ARG_CONTACT_NAME}={contactName}",
        arguments = listOf(
            navArgument(NavRoutes.PROMPT_EDITOR_ARG_MODE) {
                type = NavType.StringType
                defaultValue = "global"
            },
            navArgument(NavRoutes.PROMPT_EDITOR_ARG_SCENE) {
                type = NavType.StringType
                nullable = true
                defaultValue = null
            },
            navArgument(NavRoutes.PROMPT_EDITOR_ARG_CONTACT_ID) {
                type = NavType.StringType
                nullable = true
                defaultValue = null
            },
            navArgument(NavRoutes.PROMPT_EDITOR_ARG_CONTACT_NAME) {
                type = NavType.StringType
                nullable = true
                defaultValue = null
            }
        )
    ) {
        PromptEditorScreen(
            onNavigateBack = { navController.popBackStack() }
        )
    }
}
```

### 3. å¯¼èˆªå‚æ•°è§£æ

**åœ¨ ViewModel ä¸­è§£æ**ï¼š

```kotlin
private fun parseEditMode(savedStateHandle: SavedStateHandle): PromptEditMode {
    val mode = savedStateHandle.get<String>(NavRoutes.PROMPT_EDITOR_ARG_MODE) ?: "global"
    
    return when (mode) {
        "global" -> {
            val sceneName = savedStateHandle.get<String>(NavRoutes.PROMPT_EDITOR_ARG_SCENE)
                ?: PromptScene.ANALYZE.name
            val scene = PromptScene.valueOf(sceneName)
            PromptEditMode.GlobalScene(scene)
        }
        "contact" -> {
            val contactId = savedStateHandle.get<String>(NavRoutes.PROMPT_EDITOR_ARG_CONTACT_ID)
                ?: throw IllegalArgumentException("contactId is required for contact mode")
            val contactName = savedStateHandle.get<String>(NavRoutes.PROMPT_EDITOR_ARG_CONTACT_NAME)
                ?.let { URLDecoder.decode(it, "UTF-8") }
                ?: "è”ç³»äºº"
            PromptEditMode.ContactCustom(contactId, contactName)
        }
        else -> PromptEditMode.GlobalScene(PromptScene.ANALYZE)
    }
}
```

---

## ğŸ”„ äº¤äº’æµç¨‹è®¾è®¡

### 1. è¿›å…¥ç¼–è¾‘å™¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¾ç½®é¡µé¢        â”‚     â”‚  è”ç³»äººè¯¦æƒ…é¡µ    â”‚     â”‚  å…¶ä»–å…¥å£       â”‚
â”‚  ç‚¹å‡»åœºæ™¯å¡ç‰‡    â”‚     â”‚  ç‚¹å‡»æç¤ºè¯è®¾ç½®  â”‚     â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NavController.navigate()                      â”‚
â”‚  - promptEditorGlobal(scene)                                    â”‚
â”‚  - promptEditorContact(contactId, contactName)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PromptEditorScreen                            â”‚
â”‚  1. ViewModel è§£æå¯¼èˆªå‚æ•°                                       â”‚
â”‚  2. æ ¹æ® editMode åŠ è½½å¯¹åº”æç¤ºè¯                                 â”‚
â”‚  3. è®¾ç½®åŠ¨æ€å ä½ç¬¦                                               â”‚
â”‚  4. æ˜¾ç¤ºç¼–è¾‘ç•Œé¢                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ä¿å­˜æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç‚¹å‡»"å®Œæˆ" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æŸ¥ canSave                            â”‚
â”‚  - !isOverLimit                          â”‚
â”‚  - !isSaving                             â”‚
â”‚  - !isLoading                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ canSave = true
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¾ç½® isSaving = true                    â”‚
â”‚  æ˜¾ç¤ºåŠ è½½åœˆ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è°ƒç”¨ PromptRepository                   â”‚
â”‚  - saveGlobalPrompt() æˆ–                 â”‚
â”‚  - saveContactPrompt()                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆåŠŸ  â”‚ â”‚ å¤±è´¥                          â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                     â”‚
    â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ emit(Saved)   â”‚ â”‚ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯           â”‚
â”‚ è¿”å›ä¸Šä¸€é¡µ    â”‚ â”‚ isSaving = false       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å–æ¶ˆæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç‚¹å‡»"å–æ¶ˆ"æˆ–è¿”å›é”®                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æŸ¥ hasUnsavedChanges                  â”‚
â”‚  currentPrompt != originalPrompt         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ— ä¿®æ”¹    â”‚ â”‚ æœ‰ä¿®æ”¹                    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                     â”‚
      â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ emit(Cancelled)â”‚ â”‚ æ˜¾ç¤ºæ”¾å¼ƒç¡®è®¤å¯¹è¯æ¡†    â”‚
â”‚ è¿”å›ä¸Šä¸€é¡µ    â”‚ â”‚ showDiscardDialog=true â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                   â”‚
                  â–¼                   â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ç‚¹å‡»"æ”¾å¼ƒ"    â”‚ â”‚ ç‚¹å‡»"ç»§ç»­ç¼–è¾‘"â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                 â”‚
                  â–¼                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ emit(Cancelled)â”‚ â”‚ å…³é—­å¯¹è¯æ¡†    â”‚
          â”‚ è¿”å›ä¸Šä¸€é¡µ    â”‚ â”‚ ç»§ç»­ç¼–è¾‘      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## âš ï¸ é”™è¯¯å¤„ç†æœºåˆ¶

### 1. é”™è¯¯ç±»å‹å®šä¹‰

```kotlin
sealed class PromptEditorError {
    object LoadFailed : PromptEditorError()
    object SaveFailed : PromptEditorError()
    object NetworkError : PromptEditorError()
    data class ValidationError(val message: String) : PromptEditorError()
    
    fun toDisplayMessage(): String = when (this) {
        is LoadFailed -> "åŠ è½½æç¤ºè¯å¤±è´¥ï¼Œè¯·é‡è¯•"
        is SaveFailed -> "ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•"
        is NetworkError -> "ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
        is ValidationError -> message
    }
}
```

### 2. é”™è¯¯å¤„ç†ç­–ç•¥

| é”™è¯¯åœºæ™¯ | å¤„ç†æ–¹å¼ | ç”¨æˆ·åé¦ˆ |
|---------|---------|---------|
| åŠ è½½å¤±è´¥ | æ˜¾ç¤ºç©ºå†…å®¹ï¼Œå…è®¸ç¼–è¾‘ | Toast "åŠ è½½å¤±è´¥" |
| ä¿å­˜å¤±è´¥ | ä¿æŒç¼–è¾‘çŠ¶æ€ï¼Œä¸å…³é—­ | Toast "ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•" |
| å­—æ•°è¶…é™ | ç¦ç”¨ä¿å­˜æŒ‰é’® | å­—ç¬¦è®¡æ•°å˜çº¢ |
| ç½‘ç»œé”™è¯¯ | é‡è¯•æœºåˆ¶ | Toast "ç½‘ç»œé”™è¯¯" |

### 3. InlineErrorBannerï¼ˆå†…è”é”™è¯¯æç¤ºæ¡ï¼‰

**èŒè´£**ï¼šåœ¨ TopBar ä¸‹æ–¹æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œé¿å…è¢«é”®ç›˜é®æŒ¡

```kotlin
@Composable
fun InlineErrorBanner(
    errorMessage: String?,
    onDismiss: () -> Unit,
    modifier: Modifier = Modifier
) {
    AnimatedVisibility(
        visible = errorMessage != null,
        enter = slideInVertically(initialOffsetY = { -it }) + fadeIn(),
        exit = slideOutVertically(targetOffsetY = { -it }) + fadeOut(),
        modifier = modifier
    ) {
        errorMessage?.let { message ->
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            LaunchedEffect(message) {
                delay(3000)
                onDismiss()
            }
            
            Surface(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 16.dp),
                shape = RoundedCornerShape(8.dp),
                color = MaterialTheme.colorScheme.errorContainer
            ) {
                Row(
                    modifier = Modifier.padding(12.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        imageVector = Icons.Rounded.Warning,
                        contentDescription = null,
                        tint = MaterialTheme.colorScheme.error
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        text = message,
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onErrorContainer,
                        modifier = Modifier.weight(1f)
                    )
                    IconButton(
                        onClick = onDismiss,
                        modifier = Modifier.size(24.dp)
                    ) {
                        Icon(
                            imageVector = Icons.Rounded.Close,
                            contentDescription = "å…³é—­",
                            tint = MaterialTheme.colorScheme.onErrorContainer
                        )
                    }
                }
            }
        }
    }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼šåœ¨ `PromptEditorScreen` ä¸­é›†æˆ

```kotlin
@Composable
fun PromptEditorScreen(...) {
    // ...
    Column {
        PromptEditorTopBar(...)
        
        // ğŸ†• å†…è”é”™è¯¯æç¤ºæ¡
        InlineErrorBanner(
            errorMessage = uiState.errorMessage,
            onDismiss = { viewModel.onEvent(PromptEditorUiEvent.ClearError) }
        )
        
        // å…¶ä»–å†…å®¹...
    }
}
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

**ViewModel æµ‹è¯•**ï¼š

```kotlin
@Test
fun `åŠ è½½å…¨å±€æç¤ºè¯æˆåŠŸ`() = runTest {
    // Given
    val scene = PromptScene.ANALYZE
    val expectedPrompt = "æµ‹è¯•æç¤ºè¯"
    coEvery { promptRepository.getGlobalPrompt(scene) } returns expectedPrompt
    
    // When
    val viewModel = createViewModel(PromptEditMode.GlobalScene(scene))
    
    // Then
    val state = viewModel.uiState.value
    assertEquals(expectedPrompt, state.currentPrompt)
    assertEquals(expectedPrompt, state.originalPrompt)
    assertFalse(state.isLoading)
}

@Test
fun `ä¿å­˜æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€`() = runTest {
    // Given
    val viewModel = createViewModel()
    viewModel.onEvent(PromptEditorUiEvent.UpdatePrompt("æ–°å†…å®¹"))
    
    // When
    viewModel.onEvent(PromptEditorUiEvent.SavePrompt)
    
    // Then
    assertTrue(viewModel.uiState.value.isSaving)
}

@Test
fun `æœ‰æœªä¿å­˜ä¿®æ”¹æ—¶å–æ¶ˆæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†`() = runTest {
    // Given
    val viewModel = createViewModel()
    viewModel.onEvent(PromptEditorUiEvent.UpdatePrompt("ä¿®æ”¹åçš„å†…å®¹"))
    
    // When
    viewModel.onEvent(PromptEditorUiEvent.CancelEdit)
    
    // Then
    assertTrue(viewModel.uiState.value.showDiscardDialog)
}

@Test
fun `å­—æ•°è¶…é™æ—¶canSaveä¸ºfalse`() = runTest {
    // Given
    val viewModel = createViewModel()
    val longText = "a".repeat(1001)
    
    // When
    viewModel.onEvent(PromptEditorUiEvent.UpdatePrompt(longText))
    
    // Then
    assertTrue(viewModel.uiState.value.isOverLimit)
    assertFalse(viewModel.uiState.value.canSave)
}

@Test
fun `åŠ¨æ€å ä½ç¬¦æ ¹æ®åœºæ™¯æ­£ç¡®æ˜¾ç¤º`() = runTest {
    // Given & When
    val analyzeMode = PromptEditMode.GlobalScene(PromptScene.ANALYZE)
    val checkMode = PromptEditMode.GlobalScene(PromptScene.CHECK)
    
    // Then
    val analyzePlaceholder = PromptEditorViewModel.getPlaceholderText(analyzeMode)
    val checkPlaceholder = PromptEditorViewModel.getPlaceholderText(checkMode)
    
    assertTrue(analyzePlaceholder.contains("åˆ†æ"))
    assertTrue(checkPlaceholder.contains("æ£€æŸ¥"))
}
```

### 2. UI æµ‹è¯•

```kotlin
@Test
fun `è¾“å…¥æ–‡å­—æ—¶å­—ç¬¦è®¡æ•°å®æ—¶æ›´æ–°`() {
    composeTestRule.setContent {
        PromptEditorScreen(...)
    }
    
    // è¾“å…¥æ–‡å­—
    composeTestRule.onNodeWithTag("prompt_input")
        .performTextInput("æµ‹è¯•å†…å®¹")
    
    // éªŒè¯è®¡æ•°æ›´æ–°
    composeTestRule.onNodeWithText("å­—ç¬¦è®¡æ•°: 4/1000")
        .assertIsDisplayed()
}

@Test
fun `ä¿å­˜ä¸­çŠ¶æ€æ˜¾ç¤ºåŠ è½½åœˆ`() {
    composeTestRule.setContent {
        PromptEditorTopBar(
            title = "ç¼–è¾‘æŒ‡ä»¤",
            canSave = false,
            isSaving = true,
            onCancel = {},
            onSave = {}
        )
    }
    
    // éªŒè¯åŠ è½½åœˆæ˜¾ç¤º
    composeTestRule.onNodeWithTag("saving_indicator")
        .assertIsDisplayed()
    
    // éªŒè¯"å®Œæˆ"æ–‡å­—ä¸æ˜¾ç¤º
    composeTestRule.onNodeWithText("å®Œæˆ")
        .assertDoesNotExist()
}

@Test
fun `é”®ç›˜å¼¹èµ·æ—¶å­—ç¬¦è®¡æ•°ä¸è¢«é®æŒ¡`() {
    // æ­¤æµ‹è¯•éœ€è¦åœ¨çœŸæœºæˆ–æ¨¡æ‹Ÿå™¨ä¸Šè¿è¡Œ
    // éªŒè¯ imePadding() æ­£ç¡®å·¥ä½œ
}
```

---

## ğŸŒ å›½é™…åŒ–è®¾è®¡

### 1. å­—ç¬¦ä¸²èµ„æºæ–‡ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`res/values/strings.xml`ï¼ˆä¸­æ–‡ï¼‰

```xml
<!-- æç¤ºè¯ç¼–è¾‘å™¨ -->
<string name="prompt_editor_title_global">ç¼–è¾‘æŒ‡ä»¤</string>
<string name="prompt_editor_title_contact">ç¼–è¾‘ä¸“å±æŒ‡ä»¤</string>
<string name="prompt_editor_cancel">å–æ¶ˆ</string>
<string name="prompt_editor_save">å®Œæˆ</string>
<string name="prompt_editor_char_count">å­—ç¬¦è®¡æ•°: %1$d/%2$d</string>

<!-- åŠ¨æ€å ä½ç¬¦ -->
<string name="prompt_placeholder_analyze">ä¾‹å¦‚ï¼šè¯·å¸®æˆ‘åˆ†æå¥¹è¿™å¥è¯çš„æ½œå°è¯...</string>
<string name="prompt_placeholder_check">ä¾‹å¦‚ï¼šæ£€æŸ¥æ—¶è¦ç‰¹åˆ«æ³¨æ„å·¥ä½œç›¸å…³è¯é¢˜...</string>
<string name="prompt_placeholder_extract">ä¾‹å¦‚ï¼šé‡ç‚¹å…³æ³¨å¯¹æ–¹æåˆ°çš„å…´è¶£çˆ±å¥½...</string>
<string name="prompt_placeholder_summary">ä¾‹å¦‚ï¼šæ€»ç»“ä»Šå¤©çš„å¯¹è¯äº®ç‚¹å’Œéœ€è¦æ³¨æ„çš„åœ°æ–¹...</string>
<string name="prompt_placeholder_contact">ä¾‹å¦‚ï¼šå’Œå¥¹èŠå¤©æ—¶è¦æ³¨æ„é¿å¼€å‰ä»»è¯é¢˜...</string>
<string name="prompt_placeholder_default">åœ¨è¿™é‡Œè¾“å…¥ä½ çš„æˆ˜æœ¯æŒ‡ä»¤...</string>

<!-- å¯¹è¯æ¡† -->
<string name="prompt_discard_title">æ”¾å¼ƒä¿®æ”¹ï¼Ÿ</string>
<string name="prompt_discard_message">ä½ æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šè¦æ”¾å¼ƒå—ï¼Ÿ</string>
<string name="prompt_discard_confirm">æ”¾å¼ƒ</string>
<string name="prompt_discard_cancel">ç»§ç»­ç¼–è¾‘</string>

<!-- æç¤ºä¿¡æ¯ -->
<string name="prompt_save_success">ä¿å­˜æˆåŠŸ</string>
<string name="prompt_save_failed">ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•</string>
<string name="prompt_load_failed">åŠ è½½å¤±è´¥</string>
```

**æ–‡ä»¶ä½ç½®**ï¼š`res/values-en/strings.xml`ï¼ˆè‹±æ–‡ï¼‰

```xml
<!-- Prompt Editor -->
<string name="prompt_editor_title_global">Edit Instruction</string>
<string name="prompt_editor_title_contact">Edit Custom Instruction</string>
<string name="prompt_editor_cancel">Cancel</string>
<string name="prompt_editor_save">Done</string>
<string name="prompt_editor_char_count">Characters: %1$d/%2$d</string>

<!-- Dynamic Placeholders -->
<string name="prompt_placeholder_analyze">e.g., Help me analyze the subtext of her message...</string>
<string name="prompt_placeholder_check">e.g., Pay special attention to work-related topics...</string>
<string name="prompt_placeholder_extract">e.g., Focus on hobbies and interests mentioned...</string>
<string name="prompt_placeholder_summary">e.g., Summarize today\'s conversation highlights...</string>
<string name="prompt_placeholder_contact">e.g., Avoid mentioning ex when chatting with her...</string>
<string name="prompt_placeholder_default">Enter your tactical instruction here...</string>

<!-- Dialog -->
<string name="prompt_discard_title">Discard Changes?</string>
<string name="prompt_discard_message">You have unsaved changes. Are you sure you want to discard them?</string>
<string name="prompt_discard_confirm">Discard</string>
<string name="prompt_discard_cancel">Keep Editing</string>

<!-- Toast Messages -->
<string name="prompt_save_success">Saved successfully</string>
<string name="prompt_save_failed">Save failed, please try again</string>
<string name="prompt_load_failed">Load failed</string>
```

### 2. ä»£ç ä¸­ä½¿ç”¨å­—ç¬¦ä¸²èµ„æº

```kotlin
// åœ¨ Composable ä¸­ä½¿ç”¨
@Composable
fun PromptEditorTopBar(...) {
    Text(
        text = stringResource(R.string.prompt_editor_cancel),
        ...
    )
}

// åœ¨ ViewModel ä¸­è·å–å ä½ç¬¦
fun getPlaceholderResId(editMode: PromptEditMode): Int {
    return when (editMode) {
        is PromptEditMode.ContactCustom -> R.string.prompt_placeholder_contact
        is PromptEditMode.GlobalScene -> when (editMode.scene) {
            PromptScene.ANALYZE -> R.string.prompt_placeholder_analyze
            PromptScene.CHECK -> R.string.prompt_placeholder_check
            PromptScene.EXTRACT -> R.string.prompt_placeholder_extract
            PromptScene.SUMMARY -> R.string.prompt_placeholder_summary
        }
    }
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### 1. å¤§æ–‡æœ¬è¾“å…¥ä¼˜åŒ–

**é—®é¢˜**ï¼šè¾“å…¥è¶…è¿‡500å­—æ—¶å¯èƒ½å‡ºç°å¡é¡¿

**è§£å†³æ–¹æ¡ˆ**ï¼š

```kotlin
@Composable
fun PromptInputField(...) {
    // ä½¿ç”¨ derivedStateOf å‡å°‘ä¸å¿…è¦çš„é‡ç»„
    val charCount by remember(value) {
        derivedStateOf { value.length }
    }
    
    // ä½¿ç”¨ TextFieldValue è€Œé Stringï¼Œé¿å…å…‰æ ‡ä½ç½®ä¸¢å¤±
    var textFieldValue by remember {
        mutableStateOf(TextFieldValue(text = value))
    }
    
    // é˜²æŠ–å¤„ç†ï¼šé¿å…æ¯æ¬¡è¾“å…¥éƒ½è§¦å‘çŠ¶æ€æ›´æ–°
    val debouncedOnValueChange = remember(onValueChange) {
        debounce(100L) { newText: String ->
            onValueChange(newText)
        }
    }
    
    BasicTextField(
        value = textFieldValue,
        onValueChange = { newValue ->
            textFieldValue = newValue
            debouncedOnValueChange(newValue.text)
        },
        ...
    )
}

// é˜²æŠ–å·¥å…·å‡½æ•°
fun <T> debounce(
    delayMillis: Long,
    coroutineScope: CoroutineScope,
    action: (T) -> Unit
): (T) -> Unit {
    var debounceJob: Job? = null
    return { param: T ->
        debounceJob?.cancel()
        debounceJob = coroutineScope.launch {
            delay(delayMillis)
            action(param)
        }
    }
}
```

### 2. å†…å­˜ä¼˜åŒ–

```kotlin
// é¿å…åœ¨ Composable ä¸­åˆ›å»ºå¤§å¯¹è±¡
@Composable
fun PromptEditorScreen(...) {
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨ remember ç¼“å­˜
    val scrollState = rememberScrollState()
    val bringIntoViewRequester = remember { BringIntoViewRequester() }
    
    // âŒ é”™è¯¯ï¼šæ¯æ¬¡é‡ç»„éƒ½åˆ›å»ºæ–°å¯¹è±¡
    // val scrollState = ScrollState(0)
}

// ViewModel ä¸­åŠæ—¶æ¸…ç†èµ„æº
@HiltViewModel
class PromptEditorViewModel @Inject constructor(...) : ViewModel() {
    
    override fun onCleared() {
        super.onCleared()
        // æ¸…ç†å¯èƒ½çš„èµ„æº
    }
}
```

### 3. åŠ¨ç”»æ€§èƒ½ä¼˜åŒ–

```kotlin
// ä½¿ç”¨ animateFloatAsState è€Œé animate*AsState å‡å°‘é‡ç»„
val alpha by animateFloatAsState(
    targetValue = if (isNearLimit) 1f else 0.5f,
    animationSpec = tween(durationMillis = 150),
    label = "charCountAlpha"
)

// é¿å…åœ¨åŠ¨ç”»ä¸­ä½¿ç”¨å¤æ‚è®¡ç®—
val charCountColor = remember(isOverLimit, isNearLimit) {
    when {
        isOverLimit -> Color.Red
        isNearLimit -> BrandWarmOrange
        else -> Color.Gray
    }
}
```

### 4. æ€§èƒ½ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|---------|
| é¦–æ¬¡æ¸²æŸ“æ—¶é—´ | < 100ms | Compose Metrics |
| è¾“å…¥å“åº”å»¶è¿Ÿ | < 16ms | Systrace |
| å†…å­˜å ç”¨ | < 50MB | Android Profiler |
| æ»šåŠ¨å¸§ç‡ | 60fps | GPU Profiler |

---

## ğŸ§ª æ‰©å±•æµ‹è¯•ç”¨ä¾‹

### 1. è¾¹ç•Œæ¡ä»¶æµ‹è¯•

```kotlin
@Test
fun `ç©ºå­—ç¬¦ä¸²ä¿å­˜æˆåŠŸ`() = runTest {
    val viewModel = createViewModel()
    viewModel.onEvent(PromptEditorUiEvent.UpdatePrompt(""))
    viewModel.onEvent(PromptEditorUiEvent.SavePrompt)
    
    // ç©ºå­—ç¬¦ä¸²åº”è¯¥å¯ä»¥ä¿å­˜ï¼ˆæ¸…é™¤è‡ªå®šä¹‰æç¤ºè¯ï¼‰
    coVerify { promptRepository.saveGlobalPrompt(any(), "") }
}

@Test
fun `æ°å¥½1000å­—ç¬¦å¯ä»¥ä¿å­˜`() = runTest {
    val viewModel = createViewModel()
    val exactLimitText = "a".repeat(1000)
    
    viewModel.onEvent(PromptEditorUiEvent.UpdatePrompt(exactLimitText))
    
    assertFalse(viewModel.uiState.value.isOverLimit)
    assertTrue(viewModel.uiState.value.canSave)
}

@Test
fun `1001å­—ç¬¦ä¸èƒ½ä¿å­˜`() = runTest {
    val viewModel = createViewModel()
    val overLimitText = "a".repeat(1001)
    
    viewModel.onEvent(PromptEditorUiEvent.UpdatePrompt(overLimitText))
    
    assertTrue(viewModel.uiState.value.isOverLimit)
    assertFalse(viewModel.uiState.value.canSave)
}

@Test
fun `ç‰¹æ®Šå­—ç¬¦æ­£ç¡®å¤„ç†`() = runTest {
    val viewModel = createViewModel()
    val specialChars = "æµ‹è¯•\næ¢è¡Œ\tåˆ¶è¡¨ç¬¦{{å˜é‡}}emojiğŸ˜€"
    
    viewModel.onEvent(PromptEditorUiEvent.UpdatePrompt(specialChars))
    
    assertEquals(specialChars, viewModel.uiState.value.currentPrompt)
}
```

### 2. æ€§èƒ½æµ‹è¯•

```kotlin
@Test
fun `é•¿æ–‡æœ¬è¾“å…¥æ€§èƒ½æµ‹è¯•`() = runTest {
    val viewModel = createViewModel()
    val longText = "æµ‹è¯•æ–‡æœ¬".repeat(200) // 800å­—
    
    val startTime = System.currentTimeMillis()
    viewModel.onEvent(PromptEditorUiEvent.UpdatePrompt(longText))
    val endTime = System.currentTimeMillis()
    
    // çŠ¶æ€æ›´æ–°åº”åœ¨50mså†…å®Œæˆ
    assertTrue(endTime - startTime < 50)
}

@Test
fun `å¿«é€Ÿè¿ç»­è¾“å…¥ä¸ä¸¢å¤±å­—ç¬¦`() = runTest {
    val viewModel = createViewModel()
    
    // æ¨¡æ‹Ÿå¿«é€Ÿè¾“å…¥
    repeat(100) { i ->
        viewModel.onEvent(PromptEditorUiEvent.UpdatePrompt("a".repeat(i + 1)))
    }
    
    assertEquals(100, viewModel.uiState.value.charCount)
}
```

### 3. çŠ¶æ€æ¢å¤æµ‹è¯•

```kotlin
@Test
fun `æ¨ªç«–å±åˆ‡æ¢æ—¶çŠ¶æ€ä¿æŒ`() = runTest {
    val savedStateHandle = SavedStateHandle()
    val viewModel = createViewModel(savedStateHandle)
    
    viewModel.onEvent(PromptEditorUiEvent.UpdatePrompt("æµ‹è¯•å†…å®¹"))
    
    // æ¨¡æ‹Ÿé…ç½®å˜æ›´åé‡å»º ViewModel
    val newViewModel = createViewModel(savedStateHandle)
    
    // çŠ¶æ€åº”è¯¥æ¢å¤
    assertEquals("æµ‹è¯•å†…å®¹", newViewModel.uiState.value.currentPrompt)
}

@Test
fun `è¿›ç¨‹è¢«æ€åçŠ¶æ€æ¢å¤`() = runTest {
    val savedStateHandle = SavedStateHandle()
    val viewModel = createViewModel(savedStateHandle)
    
    viewModel.onEvent(PromptEditorUiEvent.UpdatePrompt("é‡è¦å†…å®¹"))
    
    // æ¨¡æ‹Ÿè¿›ç¨‹è¢«æ€
    savedStateHandle.set("current_prompt", "é‡è¦å†…å®¹")
    
    val restoredViewModel = createViewModel(savedStateHandle)
    assertEquals("é‡è¦å†…å®¹", restoredViewModel.uiState.value.currentPrompt)
}
```

### 4. æ— éšœç¢æµ‹è¯•

```kotlin
@Test
fun `è¾“å…¥æ¡†æœ‰æ­£ç¡®çš„å†…å®¹æè¿°`() {
    composeTestRule.setContent {
        PromptInputField(
            value = "æµ‹è¯•",
            onValueChange = {},
            placeholder = "å ä½ç¬¦",
            isLoading = false
        )
    }
    
    composeTestRule.onNodeWithTag("prompt_input")
        .assertContentDescriptionContains("æç¤ºè¯è¾“å…¥æ¡†")
}

@Test
fun `å­—ç¬¦è®¡æ•°å¯¹å±å¹•é˜…è¯»å™¨å¯è§`() {
    composeTestRule.setContent {
        CharacterCounter(
            currentCount = 100,
            maxCount = 1000,
            isNearLimit = false,
            isOverLimit = false
        )
    }
    
    composeTestRule.onNodeWithText("å­—ç¬¦è®¡æ•°: 100/1000")
        .assertIsDisplayed()
}
```

---

## ğŸ“± ç‰ˆæœ¬å…¼å®¹æ€§

### æ”¯æŒçš„ Android ç‰ˆæœ¬

| Android ç‰ˆæœ¬ | API Level | æ”¯æŒçŠ¶æ€ | å¤‡æ³¨ |
|-------------|-----------|---------|------|
| Android 7.0+ | 24+ | âœ… å®Œå…¨æ”¯æŒ | æœ€ä½æ”¯æŒç‰ˆæœ¬ |
| Android 10+ | 29+ | âœ… å®Œå…¨æ”¯æŒ | æ¨èç‰ˆæœ¬ |
| Android 12+ | 31+ | âœ… å®Œå…¨æ”¯æŒ | æœ€ä½³ä½“éªŒ |

### å…¼å®¹æ€§æ³¨æ„äº‹é¡¹

1. **IME Insets**ï¼šAndroid 11+ åŸç”Ÿæ”¯æŒï¼Œä½ç‰ˆæœ¬éœ€è¦ `WindowCompat` å…¼å®¹
2. **Blur Effect**ï¼šAndroid 12+ åŸç”Ÿæ”¯æŒï¼Œä½ç‰ˆæœ¬ä½¿ç”¨ RenderScript é™çº§
3. **åŠ¨æ€é¢œè‰²**ï¼šAndroid 12+ Material You æ”¯æŒï¼Œä½ç‰ˆæœ¬ä½¿ç”¨å›ºå®šå“ç‰Œè‰²

---

## ğŸ“… å®æ–½è®¡åˆ’

### é˜¶æ®µåˆ’åˆ†

| é˜¶æ®µ | ä»»åŠ¡ | é¢„ä¼°å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|---------|--------|
| 1 | æ•°æ®æ¨¡å‹å’Œ ViewModel | 2h | P0 |
| 2 | æ ¸å¿ƒ UI ç»„ä»¶ | 3h | P0 |
| 3 | å¯¼èˆªé›†æˆ | 1h | P0 |
| 4 | é”®ç›˜é¿è®©å’Œå…‰æ ‡è·Ÿéš | 1h | P0 |
| 5 | å“ç‰Œè‰²å’Œè§†è§‰ç»†èŠ‚ | 1h | P1 |
| 6 | å›½é™…åŒ–èµ„æº | 0.5h | P1 |
| 7 | å•å…ƒæµ‹è¯• | 2h | P1 |
| 8 | UI æµ‹è¯• | 1h | P2 |
| 9 | æ€§èƒ½ä¼˜åŒ– | 1h | P2 |

**æ€»é¢„ä¼°å·¥æ—¶**ï¼š12.5h

### ä¾èµ–å…³ç³»

```
é˜¶æ®µ1 (æ•°æ®æ¨¡å‹)
    â”‚
    â–¼
é˜¶æ®µ2 (UIç»„ä»¶) â”€â”€â”€â”€â”€â”€â–º é˜¶æ®µ5 (è§†è§‰ç»†èŠ‚)
    â”‚                      â”‚
    â–¼                      â–¼
é˜¶æ®µ3 (å¯¼èˆªé›†æˆ)      é˜¶æ®µ6 (å›½é™…åŒ–)
    â”‚
    â–¼
é˜¶æ®µ4 (é”®ç›˜é¿è®©)
    â”‚
    â–¼
é˜¶æ®µ7 (å•å…ƒæµ‹è¯•) â”€â”€â”€â”€â”€â”€â–º é˜¶æ®µ8 (UIæµ‹è¯•)
                              â”‚
                              â–¼
                         é˜¶æ®µ9 (æ€§èƒ½ä¼˜åŒ–)
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PRD-00006-æç¤ºè¯ç¼–è¾‘ç•Œé¢éœ€æ±‚](../PRD/PRD-00006-æç¤ºè¯ç¼–è¾‘ç•Œé¢éœ€æ±‚.md)
- [FD-00005-æç¤ºè¯ç®¡ç†ç³»ç»ŸåŠŸèƒ½è®¾è®¡](FD-00005-æç¤ºè¯ç®¡ç†ç³»ç»ŸåŠŸèƒ½è®¾è®¡.md)
- [FD-00004-è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIåŠŸèƒ½è®¾è®¡](FD-00004-è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIåŠŸèƒ½è®¾è®¡.md)ï¼ˆå‚è€ƒæƒ…æ„ŸåŒ–è®¾è®¡ï¼‰
- [DR-00012-FD00006æ–‡æ¡£å®¡æŸ¥æŠ¥å‘Š](../DR/DR-00012-FD00006æ–‡æ¡£å®¡æŸ¥æŠ¥å‘Š.md)
