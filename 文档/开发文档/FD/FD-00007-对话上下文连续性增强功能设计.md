# FD-00007: å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºåŠŸèƒ½è®¾è®¡

> **æ–‡æ¡£ç±»å‹**: åŠŸèƒ½è®¾è®¡æ–‡æ¡£ (FD)  
> **ç‰ˆæœ¬**: 1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-16  
> **æœ€åæ›´æ–°**: 2025-12-16  
> **è´Ÿè´£äºº**: Kiro  
> **çŠ¶æ€**: ğŸ“ è‰ç¨¿  
> **ä¼˜å…ˆçº§**: ï¿½  é«˜  
> **å…³è”PRD**: PRD-00007  

---

## ğŸ“œ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-16 | Kiro | åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«å®Œæ•´æ¶æ„è®¾è®¡ |
| 1.1 | 2025-12-16 | Kiro | æ ¹æ®å®¡æŸ¥æ„è§ä¼˜åŒ–ï¼šMessageSenderé™åˆ¶è¯´æ˜ã€æœ¬åœ°åŒ–å»ºè®®ã€SQLæ€§èƒ½åˆ†æ |

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºåŠŸèƒ½çš„æŠ€æœ¯æ¶æ„ã€ç»„ä»¶è®¾è®¡ã€æ•°æ®æµå’Œå®ç°ç»†èŠ‚ã€‚

**è®¾è®¡ç›®æ ‡**ï¼š
- è®©AIèƒ½å¤Ÿ"è®°ä½"æœ€è¿‘çš„å¯¹è¯å†å²ï¼Œå®ç°å¯¹è¯è¿ç»­æ€§
- é€šè¿‡"æ—¶é—´æµé€æ ‡è®°"è®©AIç†è§£å¯¹è¯çš„æ—¶é—´é—´éš”
- æ¨¡æ‹Ÿäººç±»ç¿»çœ‹èŠå¤©è®°å½•çš„å¿ƒç†æ´»åŠ¨ï¼Œæ„å»ºè‡ªç„¶çš„ä¸Šä¸‹æ–‡ç»“æ„
- AIèƒ½ä»æ—¶é—´é—´éš”ä¸­æ¨æ–­å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå˜åŒ–

**ä¾èµ–åº“ç‰ˆæœ¬**ï¼š
- Room: 2.6.1ï¼ˆæ•°æ®åº“ï¼‰
- Kotlin Coroutines: 1.9.0ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
- Hilt: 2.52ï¼ˆä¾èµ–æ³¨å…¥ï¼‰

---

## ğŸ“‘ ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
3. [æ ¸å¿ƒç»„ä»¶è®¾è®¡](#æ ¸å¿ƒç»„ä»¶è®¾è®¡)
4. [æ—¶é—´æµé€æ ‡è®°ç®—æ³•](#æ—¶é—´æµé€æ ‡è®°ç®—æ³•)
5. [æ¥å£è®¾è®¡](#æ¥å£è®¾è®¡)
6. [ä¸ç°æœ‰ä»£ç çš„é›†æˆè®¾è®¡](#ä¸ç°æœ‰ä»£ç çš„é›†æˆè®¾è®¡)
7. [è®¾ç½®ç•Œé¢è®¾è®¡](#è®¾ç½®ç•Œé¢è®¾è®¡)
8. [æ€§èƒ½ä¼˜åŒ–è®¾è®¡](#æ€§èƒ½ä¼˜åŒ–è®¾è®¡)
9. [é”™è¯¯å¤„ç†æœºåˆ¶](#é”™è¯¯å¤„ç†æœºåˆ¶)
10. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚SettingsScreenâ”‚  â”‚SettingsViewModelâ”‚                  â”‚
â”‚  â”‚ (å†å²æ¡æ•°é…ç½®) â”‚  â”‚  (çŠ¶æ€ç®¡ç†)   â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Domain Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ConversationContext â”‚  â”‚  AnalyzeChatUseCase â”‚        â”‚
â”‚  â”‚     Builder        â”‚  â”‚    (é›†æˆå†å²ä¸Šä¸‹æ–‡)  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ TimestampedMessage â”‚  â”‚   TimeFlowMarker   â”‚        â”‚
â”‚  â”‚      (æ¨¡å‹)        â”‚  â”‚      (æ ‡è®°ç±»å‹)     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Data Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ConversationRepositoryâ”‚ â”‚ ConversationLogDao â”‚        â”‚
â”‚  â”‚       Impl          â”‚  â”‚  (æ–°å¢æŸ¥è¯¢æ–¹æ³•)    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚SettingsPreferences â”‚                                â”‚
â”‚  â”‚  (å†å²æ¡æ•°å­˜å‚¨)     â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—åˆ’åˆ†

```
domain/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ TimestampedMessage.kt        # å¸¦æ—¶é—´æˆ³çš„æ¶ˆæ¯æ¨¡å‹
â”‚   â”œâ”€â”€ MessageSender.kt             # æ¶ˆæ¯å‘é€è€…æšä¸¾
â”‚   â””â”€â”€ TimeFlowMarker.kt            # æ—¶é—´æµé€æ ‡è®°å¯†å°ç±»
â”œâ”€â”€ util/
â”‚   â””â”€â”€ ConversationContextBuilder.kt # å¯¹è¯ä¸Šä¸‹æ–‡æ„å»ºå™¨
â””â”€â”€ repository/
    â””â”€â”€ ConversationRepository.kt     # æ‰©å±•æ¥å£

data/
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ ConversationRepositoryImpl.kt # æ‰©å±•å®ç°
â”œâ”€â”€ local/
â”‚   â”œâ”€â”€ dao/
â”‚   â”‚   â””â”€â”€ ConversationLogDao.kt     # æ‰©å±•DAO
â”‚   â””â”€â”€ SettingsPreferences.kt        # è®¾ç½®å­˜å‚¨ï¼ˆæ‰©å±•ï¼‰

presentation/
â”œâ”€â”€ ui/screen/settings/
â”‚   â””â”€â”€ SettingsScreen.kt             # è®¾ç½®ç•Œé¢ï¼ˆæ‰©å±•ï¼‰
â””â”€â”€ viewmodel/
    â””â”€â”€ SettingsViewModel.kt          # è®¾ç½®ViewModelï¼ˆæ‰©å±•ï¼‰
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### 1. MessageSenderï¼ˆæ¶ˆæ¯å‘é€è€…æšä¸¾ï¼‰

**èŒè´£**ï¼šæ ‡è¯†æ¶ˆæ¯çš„å‘é€æ–¹

> âš ï¸ **å½“å‰ç‰ˆæœ¬é™åˆ¶**ï¼šç”±äºæ•°æ®åº“ `conversation_logs` è¡¨ç›®å‰åªå­˜å‚¨äº†ç”¨æˆ·è¾“å…¥ï¼ˆ`user_input`ï¼‰ï¼Œ
> æ²¡æœ‰å­˜å‚¨è”ç³»äººçš„æ¶ˆæ¯ï¼Œå› æ­¤**å½“å‰ç‰ˆæœ¬ä»…å›æ”¾ç”¨æˆ·ä¾§å†å²**ã€‚`CONTACT` ç±»å‹é¢„ç•™ç»™åç»­ç‰ˆæœ¬æ‰©å±•ã€‚
> 
> **åç»­æ‰©å±•æ–¹å‘**ï¼š
> - æ–¹æ¡ˆAï¼šæ‰©å±•æ•°æ®åº“è¡¨ï¼Œå¢åŠ  `sender_type` å­—æ®µ
> - æ–¹æ¡ˆBï¼šä»å±å¹•æŠ“å–æ—¶è§£ææ¶ˆæ¯å‘é€è€…
> - æ–¹æ¡ˆCï¼šç”¨æˆ·æ‰‹åŠ¨æ ‡è®°æ¶ˆæ¯å½’å±

```kotlin
/**
 * æ¶ˆæ¯å‘é€è€…ç±»å‹
 * 
 * ã€é‡è¦è¯´æ˜ã€‘å½“å‰ç‰ˆæœ¬ä»…æ”¯æŒ USER ç±»å‹ï¼ŒCONTACT ç±»å‹é¢„ç•™ç»™åç»­æ‰©å±•ã€‚
 * åŸå› ï¼šæ•°æ®åº“ conversation_logs è¡¨ç›®å‰åªå­˜å‚¨ç”¨æˆ·è¾“å…¥ï¼Œä¸åŒ…å«è”ç³»äººæ¶ˆæ¯ã€‚
 */
enum class MessageSender(val prefix: String, val displayName: String) {
    /**
     * ç”¨æˆ·å‘é€çš„æ¶ˆæ¯
     * ã€å½“å‰ç‰ˆæœ¬ã€‘ï¼šä»…æ­¤ç±»å‹è¢«å®é™…ä½¿ç”¨
     */
    USER("[User]", "æˆ‘"),
    
    /**
     * è”ç³»äººå‘é€çš„æ¶ˆæ¯
     * ã€é¢„ç•™ã€‘ï¼šåç»­ç‰ˆæœ¬æ‰©å±•ä½¿ç”¨
     */
    CONTACT("[Contact]", "å¯¹æ–¹");
    
    companion object {
        /**
         * æ ¹æ®å‰ç¼€è§£æå‘é€è€…ç±»å‹
         */
        fun fromPrefix(prefix: String): MessageSender? {
            return values().find { it.prefix == prefix }
        }
    }
}
```

### 2. TimestampedMessageï¼ˆå¸¦æ—¶é—´æˆ³çš„æ¶ˆæ¯ï¼‰

**èŒè´£**ï¼šæ‰¿è½½å¸¦æ—¶é—´ä¿¡æ¯çš„å¯¹è¯æ¶ˆæ¯

```kotlin
/**
 * å¸¦æ—¶é—´æˆ³çš„å¯¹è¯æ¶ˆæ¯
 *
 * ç”¨äºæ„å»ºå¸¦æ—¶é—´æµé€æ ‡è®°çš„ä¸Šä¸‹æ–‡
 *
 * @property content æ¶ˆæ¯å†…å®¹
 * @property timestamp æ¶ˆæ¯æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
 * @property sender æ¶ˆæ¯å‘é€è€…
 */
data class TimestampedMessage(
    val content: String,
    val timestamp: Long,
    val sender: MessageSender
) {
    init {
        require(content.isNotBlank()) { "æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º" }
        require(timestamp > 0) { "æ—¶é—´æˆ³å¿…é¡»å¤§äº0" }
    }
    
    /**
     * è·å–æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸² (HH:mm)
     */
    fun getFormattedTime(): String {
        val sdf = java.text.SimpleDateFormat("HH:mm", java.util.Locale.getDefault())
        return sdf.format(java.util.Date(timestamp))
    }
    
    /**
     * è·å–æ ¼å¼åŒ–çš„æ—¥æœŸå­—ç¬¦ä¸² (yyyy-MM-dd)
     */
    fun getFormattedDate(): String {
        val sdf = java.text.SimpleDateFormat("yyyy-MM-dd", java.util.Locale.getDefault())
        return sdf.format(java.util.Date(timestamp))
    }
    
    /**
     * è½¬æ¢ä¸ºæ˜¾ç¤ºæ ¼å¼
     * ç¤ºä¾‹: [User]: ä½ å¥½ (10:30)
     */
    fun toDisplayString(showTime: Boolean = true): String {
        return if (showTime) {
            "${sender.prefix}: $content (${getFormattedTime()})"
        } else {
            "${sender.prefix}: $content"
        }
    }
}
```

### 3. TimeFlowMarkerï¼ˆæ—¶é—´æµé€æ ‡è®°ï¼‰

**èŒè´£**ï¼šè¡¨ç¤ºä¸åŒç±»å‹çš„æ—¶é—´æµé€æ ‡è®°

```kotlin
/**
 * æ—¶é—´æµé€æ ‡è®°ç±»å‹
 *
 * ç”¨äºåœ¨å¯¹è¯å†å²ä¸­æ’å…¥æ—¶é—´é—´éš”æç¤º
 */
sealed class TimeFlowMarker {
    
    /**
     * æ—¥æœŸå˜æ›´æ ‡è®°
     * ç¤ºä¾‹: --- [2025-12-16] ---
     *
     * @property date æ—¥æœŸå­—ç¬¦ä¸² (yyyy-MM-dd)
     */
    data class DateChange(val date: String) : TimeFlowMarker() {
        override fun toDisplayString(): String = "--- [$date] ---"
    }
    
    /**
     * çŸ­é—´éš”æ ‡è®°ï¼ˆ10åˆ†é’Ÿ ~ 3å°æ—¶ï¼‰
     * ç¤ºä¾‹: --- (ç»è¿‡äº† 45 åˆ†é’Ÿ) ---
     *
     * @property minutes é—´éš”åˆ†é’Ÿæ•°
     * 
     * ã€æœ¬åœ°åŒ–è¯´æ˜ã€‘å½“å‰ç¡¬ç¼–ç ä¸­æ–‡å­—ç¬¦ä¸²ï¼Œåç»­ç‰ˆæœ¬å»ºè®®ï¼š
     * - æå–åˆ° strings.xml èµ„æºæ–‡ä»¶
     * - æˆ–ä½¿ç”¨ android.text.format.DateUtils.getRelativeTimeSpanString()
     */
    data class ShortGap(val minutes: Int) : TimeFlowMarker() {
        override fun toDisplayString(): String {
            // TODO: åç»­ç‰ˆæœ¬æå–åˆ° strings.xml
            // context.getString(R.string.time_flow_short_gap, formatDuration(minutes))
            val duration = if (minutes >= 60) {
                "${minutes / 60} å°æ—¶"
            } else {
                "$minutes åˆ†é’Ÿ"
            }
            return "--- (ç»è¿‡äº† $duration) ---"
        }
    }
    
    /**
     * é•¿é—´éš”æ ‡è®°ï¼ˆ> 3å°æ—¶ï¼‰
     * ç¤ºä¾‹: --- (è·ç¦»ä¸Šæ¬¡å¯¹è¯å·²è¿‡ 6 å°æ—¶ï¼Œæ³¨æ„æƒ…ç»ªå˜åŒ–) ---
     *
     * @property hours é—´éš”å°æ—¶æ•°
     * 
     * ã€æœ¬åœ°åŒ–è¯´æ˜ã€‘å½“å‰ç¡¬ç¼–ç ä¸­æ–‡å­—ç¬¦ä¸²ï¼Œåç»­ç‰ˆæœ¬å»ºè®®æå–åˆ°èµ„æºæ–‡ä»¶
     */
    data class LongGap(val hours: Int) : TimeFlowMarker() {
        override fun toDisplayString(): String {
            // TODO: åç»­ç‰ˆæœ¬æå–åˆ° strings.xml
            // context.getString(R.string.time_flow_long_gap, hours)
            return "--- (è·ç¦»ä¸Šæ¬¡å¯¹è¯å·²è¿‡ $hours å°æ—¶ï¼Œæ³¨æ„å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå †ç§¯) ---"
        }
    }
    
    /**
     * æ— æ ‡è®°ï¼ˆçƒ­å¯¹è¯ï¼Œ< 10åˆ†é’Ÿï¼‰
     */
    object None : TimeFlowMarker() {
        override fun toDisplayString(): String = ""
    }
    
    /**
     * è½¬æ¢ä¸ºæ˜¾ç¤ºå­—ç¬¦ä¸²
     */
    abstract fun toDisplayString(): String
}
```

### 4. ConversationContextConfigï¼ˆä¸Šä¸‹æ–‡é…ç½®ï¼‰

**èŒè´£**ï¼šç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡çš„é…ç½®å‚æ•°

```kotlin
/**
 * å¯¹è¯ä¸Šä¸‹æ–‡é…ç½®
 *
 * @property historyCount å†å²å¯¹è¯æ¡æ•° (0/5/10)
 * @property hotSessionThreshold çƒ­å¯¹è¯é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤10åˆ†é’Ÿ
 * @property warmSessionThreshold æ¸©å¯¹è¯é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤3å°æ—¶
 */
data class ConversationContextConfig(
    val historyCount: Int = DEFAULT_HISTORY_COUNT,
    val hotSessionThreshold: Long = DEFAULT_HOT_SESSION_THRESHOLD,
    val warmSessionThreshold: Long = DEFAULT_WARM_SESSION_THRESHOLD
) {
    companion object {
        const val DEFAULT_HISTORY_COUNT = 5
        const val DEFAULT_HOT_SESSION_THRESHOLD = 10 * 60 * 1000L      // 10åˆ†é’Ÿ
        const val DEFAULT_WARM_SESSION_THRESHOLD = 3 * 60 * 60 * 1000L // 3å°æ—¶
        
        val HISTORY_COUNT_OPTIONS = listOf(0, 5, 10)
    }
    
    init {
        require(historyCount in HISTORY_COUNT_OPTIONS) {
            "å†å²æ¡æ•°å¿…é¡»æ˜¯ ${HISTORY_COUNT_OPTIONS.joinToString()} ä¹‹ä¸€"
        }
        require(hotSessionThreshold > 0) { "çƒ­å¯¹è¯é˜ˆå€¼å¿…é¡»å¤§äº0" }
        require(warmSessionThreshold > hotSessionThreshold) {
            "æ¸©å¯¹è¯é˜ˆå€¼å¿…é¡»å¤§äºçƒ­å¯¹è¯é˜ˆå€¼"
        }
    }
}
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. ConversationContextBuilderï¼ˆå¯¹è¯ä¸Šä¸‹æ–‡æ„å»ºå™¨ï¼‰

**èŒè´£**ï¼šæ„å»ºå¸¦æ—¶é—´æµé€æ ‡è®°çš„å¯¹è¯å†å²ä¸Šä¸‹æ–‡

**æ–‡ä»¶ä½ç½®**ï¼š`domain/util/ConversationContextBuilder.kt`

```kotlin
/**
 * å¯¹è¯ä¸Šä¸‹æ–‡æ„å»ºå™¨
 *
 * è´Ÿè´£æ„å»ºå¸¦æ—¶é—´æµé€æ ‡è®°çš„å¯¹è¯å†å²ï¼Œæ¨¡æ‹Ÿäººç±»ç¿»çœ‹èŠå¤©è®°å½•çš„å¿ƒç†æ´»åŠ¨ã€‚
 *
 * æ—¶é—´æµé€æ ‡è®°ç­–ç•¥ï¼š
 * - < 10åˆ†é’Ÿï¼šHot Sessionï¼Œä¸æ’å…¥æ ‡è®°
 * - 10åˆ†é’Ÿ ~ 3å°æ—¶ï¼šWarm Sessionï¼Œæ’å…¥è½»æ ‡è®°
 * - > 3å°æ—¶ï¼šCold Sessionï¼Œæ’å…¥å¼ºæ ‡è®°å¹¶æç¤ºæƒ…ç»ªå˜åŒ–
 * - è·¨å¤©ï¼šæ’å…¥æ—¥æœŸæ ‡è®°
 */
@Singleton
class ConversationContextBuilder @Inject constructor() {

    /**
     * æ„å»ºå¸¦æ—¶é—´æµé€æ ‡è®°çš„å¯¹è¯å†å²
     *
     * @param messages æŒ‰æ—¶é—´æ­£åºæ’åˆ—çš„æ¶ˆæ¯åˆ—è¡¨
     * @param config ä¸Šä¸‹æ–‡é…ç½®
     * @return æ ¼å¼åŒ–åçš„å¯¹è¯å†å²å­—ç¬¦ä¸²
     */
    fun buildHistoryContext(
        messages: List<TimestampedMessage>,
        config: ConversationContextConfig = ConversationContextConfig()
    ): String {
        if (messages.isEmpty()) return ""
        
        return buildString {
            appendLine("ã€å†å²å¯¹è¯ã€‘(æœ€è¿‘${messages.size}æ¡)")
            
            var previousTimestamp: Long? = null
            var previousDate: String? = null
            
            messages.forEach { message ->
                // è®¡ç®—æ—¶é—´æ ‡è®°
                val marker = calculateTimeMarker(
                    previousTimestamp = previousTimestamp,
                    currentTimestamp = message.timestamp,
                    previousDate = previousDate,
                    config = config
                )
                
                // æ’å…¥æ—¶é—´æ ‡è®°ï¼ˆå¦‚æœæœ‰ï¼‰
                val markerStr = marker.toDisplayString()
                if (markerStr.isNotEmpty()) {
                    appendLine(markerStr)
                }
                
                // æ·»åŠ æ¶ˆæ¯ï¼ˆåœ¨æ—¶é—´é—´éš”åæ˜¾ç¤ºæ—¶é—´ï¼‰
                val showTime = marker !is TimeFlowMarker.None
                appendLine(message.toDisplayString(showTime))
                
                // æ›´æ–°å‰ä¸€æ¡æ¶ˆæ¯çš„ä¿¡æ¯
                previousTimestamp = message.timestamp
                previousDate = message.getFormattedDate()
            }
        }.trimEnd()
    }

    /**
     * è®¡ç®—æ—¶é—´æµé€æ ‡è®°
     *
     * @param previousTimestamp ä¸Šä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³
     * @param currentTimestamp å½“å‰æ¶ˆæ¯çš„æ—¶é—´æˆ³
     * @param previousDate ä¸Šä¸€æ¡æ¶ˆæ¯çš„æ—¥æœŸ
     * @param config é…ç½®å‚æ•°
     * @return æ—¶é—´æµé€æ ‡è®°
     */
    fun calculateTimeMarker(
        previousTimestamp: Long?,
        currentTimestamp: Long,
        previousDate: String?,
        config: ConversationContextConfig
    ): TimeFlowMarker {
        // ç¬¬ä¸€æ¡æ¶ˆæ¯ä¸éœ€è¦æ ‡è®°
        if (previousTimestamp == null) return TimeFlowMarker.None
        
        val currentDate = formatDate(currentTimestamp)
        
        // ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦è·¨å¤©
        if (previousDate != null && previousDate != currentDate) {
            return TimeFlowMarker.DateChange(currentDate)
        }
        
        // è®¡ç®—æ—¶é—´é—´éš”
        val gap = currentTimestamp - previousTimestamp
        
        return when {
            // çƒ­å¯¹è¯ï¼š< 10åˆ†é’Ÿï¼Œä¸æ’å…¥æ ‡è®°
            gap < config.hotSessionThreshold -> TimeFlowMarker.None
            
            // æ¸©å¯¹è¯ï¼š10åˆ†é’Ÿ ~ 3å°æ—¶ï¼Œæ’å…¥è½»æ ‡è®°
            gap < config.warmSessionThreshold -> {
                val minutes = (gap / (60 * 1000)).toInt()
                TimeFlowMarker.ShortGap(minutes)
            }
            
            // å†·å¯¹è¯ï¼š> 3å°æ—¶ï¼Œæ’å…¥å¼ºæ ‡è®°
            else -> {
                val hours = (gap / (60 * 60 * 1000)).toInt()
                TimeFlowMarker.LongGap(hours)
            }
        }
    }

    /**
     * æ ¼å¼åŒ–æ—¥æœŸ
     */
    private fun formatDate(timestamp: Long): String {
        val sdf = java.text.SimpleDateFormat("yyyy-MM-dd", java.util.Locale.getDefault())
        return sdf.format(java.util.Date(timestamp))
    }
}
```

### 2. æ„å»ºåçš„ä¸Šä¸‹æ–‡ç¤ºä¾‹

**è¾“å…¥æ•°æ®**ï¼š
```kotlin
val messages = listOf(
    TimestampedMessage("å®ï¼Œæ—©å®‰", 1702684200000, MessageSender.USER),      // 08:10
    TimestampedMessage("æ—©å‘€", 1702685400000, MessageSender.CONTACT),       // 08:30
    TimestampedMessage("æˆ‘å‡ºé—¨äº†", 1702686600000, MessageSender.USER),      // 08:50
    TimestampedMessage("è·¯ä¸Šå°å¿ƒ", 1702686900000, MessageSender.CONTACT),   // 08:55
    TimestampedMessage("ä½ ä»Šå¤©ä¸€å¤©éƒ½å¾ˆå¿™å—ï¼Ÿ", 1702708800000, MessageSender.CONTACT) // 15:00
)
```

**è¾“å‡ºç»“æœ**ï¼š
```
ã€å†å²å¯¹è¯ã€‘(æœ€è¿‘5æ¡)
[User]: å®ï¼Œæ—©å®‰
[Contact]: æ—©å‘€ (08:30)
--- (ç»è¿‡äº† 20 åˆ†é’Ÿ) ---
[User]: æˆ‘å‡ºé—¨äº† (08:50)
[Contact]: è·¯ä¸Šå°å¿ƒ (08:55)
--- (è·ç¦»ä¸Šæ¬¡å¯¹è¯å·²è¿‡ 6 å°æ—¶ï¼Œæ³¨æ„å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå †ç§¯) ---
[Contact]: ä½ ä»Šå¤©ä¸€å¤©éƒ½å¾ˆå¿™å—ï¼Ÿ (15:00)
```

---

## â±ï¸ æ—¶é—´æµé€æ ‡è®°ç®—æ³•

### ç®—æ³•æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å¼€å§‹å¤„ç†æ¶ˆæ¯                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ˜¯å¦ä¸ºç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Ÿ                â”‚
â”‚              â†“ æ˜¯                        â”‚
â”‚         è¿”å› None                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ å¦
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ˜¯å¦è·¨å¤©ï¼Ÿ                      â”‚
â”‚              â†“ æ˜¯                        â”‚
â”‚    è¿”å› DateChange(å½“å‰æ—¥æœŸ)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ å¦
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      è®¡ç®—æ—¶é—´é—´éš” gap                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      gap < 10åˆ†é’Ÿï¼Ÿ                      â”‚
â”‚         â†“ æ˜¯                            â”‚
â”‚      è¿”å› None (Hot Session)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ å¦
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      gap < 3å°æ—¶ï¼Ÿ                       â”‚
â”‚         â†“ æ˜¯                            â”‚
â”‚   è¿”å› ShortGap(åˆ†é’Ÿæ•°) (Warm Session)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ å¦
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿”å› LongGap(å°æ—¶æ•°) (Cold Session)    â”‚
â”‚   æç¤ºï¼šæ³¨æ„å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå †ç§¯            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¶é—´é˜ˆå€¼é…ç½®

| ä¼šè¯çŠ¶æ€ | æ—¶é—´é—´éš” | æ ‡è®°ç±»å‹ | è¯´æ˜ |
|---------|---------|---------|------|
| Hot Session | < 10åˆ†é’Ÿ | None | è¿è´¯å¯¹è¯ï¼Œä¸æ’å…¥æ ‡è®° |
| Warm Session | 10åˆ†é’Ÿ ~ 3å°æ—¶ | ShortGap | åŒä¸€è¯é¢˜å»¶ç»­ï¼Œè½»æ ‡è®° |
| Cold Session | > 3å°æ—¶ | LongGap | æ–°ä¼šè¯å‘¨æœŸï¼Œå¼ºæ ‡è®°+æƒ…ç»ªæç¤º |
| New Day | è·¨å¤© | DateChange | æ—¥æœŸå˜æ›´æ ‡è®° |

### æ—¶é—´æ ¼å¼åŒ–è§„åˆ™

```kotlin
/**
 * æ—¶é—´é—´éš”æ ¼å¼åŒ–
 */
fun formatDuration(minutes: Int): String {
    return when {
        minutes < 60 -> "$minutes åˆ†é’Ÿ"
        minutes < 120 -> "1 å°æ—¶"
        else -> "${minutes / 60} å°æ—¶"
    }
}
```

---

## ğŸ”Œ æ¥å£è®¾è®¡

### 1. ConversationRepository æ‰©å±•

**æ–°å¢æ–¹æ³•**ï¼šè·å–æœ€è¿‘Næ¡å¯¹è¯è®°å½•

```kotlin
interface ConversationRepository {
    // ... ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜ ...

    /**
     * è·å–æŒ‡å®šè”ç³»äººçš„æœ€è¿‘Næ¡å¯¹è¯è®°å½•
     *
     * @param contactId è”ç³»äººID
     * @param limit æœ€å¤§æ¡æ•°
     * @return æŒ‰æ—¶é—´æ­£åºæ’åˆ—çš„å¯¹è¯è®°å½•ï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰
     */
    suspend fun getRecentConversations(
        contactId: String,
        limit: Int
    ): Result<List<ConversationLog>>
}
```

### 2. ConversationRepositoryImpl å®ç°

```kotlin
@Singleton
class ConversationRepositoryImpl @Inject constructor(
    private val dao: ConversationLogDao
) : ConversationRepository {

    // ... ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜ ...

    override suspend fun getRecentConversations(
        contactId: String,
        limit: Int
    ): Result<List<ConversationLog>> = withContext(Dispatchers.IO) {
        try {
            val entities = dao.getRecentConversations(contactId, limit)
            Result.success(entities.map { it.toDomain() })
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

### 3. ConversationLogDao æ‰©å±•

```kotlin
@Dao
interface ConversationLogDao {
    // ... ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜ ...

    /**
     * è·å–æŒ‡å®šè”ç³»äººçš„æœ€è¿‘Næ¡å¯¹è¯è®°å½•
     * æŒ‰æ—¶é—´æˆ³æ­£åºæ’åˆ—ï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰
     *
     * ä½¿ç”¨å­æŸ¥è¯¢å…ˆè·å–æœ€è¿‘Næ¡ï¼ˆå€’åºï¼‰ï¼Œå†æ­£åºæ’åˆ—
     * 
     * ã€SQLæ€§èƒ½åˆ†æã€‘
     * - åˆ©ç”¨ contact_id ç´¢å¼•å¿«é€Ÿå®šä½è”ç³»äººè®°å½•
     * - åˆ©ç”¨ timestamp ç´¢å¼•è¿›è¡Œæ’åº
     * - å­æŸ¥è¯¢ + LIMIT é¿å…å…¨è¡¨æ‰«æ
     * - é¢„ä¼°æ€§èƒ½ï¼šå•äººAppåœºæ™¯ï¼ˆ<10ä¸‡æ¡è®°å½•ï¼‰ï¼ŒæŸ¥è¯¢æ—¶é—´ < 10ms
     * - æç«¯åœºæ™¯ï¼ˆ>50ä¸‡æ¡è®°å½•ï¼‰å¯èƒ½éœ€è¦å¤åˆç´¢å¼•ä¼˜åŒ–
     */
    @Query("""
        SELECT * FROM (
            SELECT * FROM conversation_logs 
            WHERE contact_id = :contactId 
            ORDER BY timestamp DESC 
            LIMIT :limit
        ) 
        ORDER BY timestamp ASC
    """)
    suspend fun getRecentConversations(contactId: String, limit: Int): List<ConversationLogEntity>
}
```

> ğŸ’¡ **æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼ˆåç»­ç‰ˆæœ¬ï¼‰**ï¼š
> å¦‚æœæ•°æ®é‡å¢é•¿åˆ°æç«¯è§„æ¨¡ï¼Œå¯è€ƒè™‘æ·»åŠ å¤åˆç´¢å¼•ï¼š
> ```sql
> CREATE INDEX idx_contact_timestamp ON conversation_logs(contact_id, timestamp DESC)
> ```

### 4. SettingsRepository æ‰©å±•

```kotlin
interface SettingsRepository {
    // ... ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜ ...

    /**
     * è·å–å†å²å¯¹è¯æ¡æ•°é…ç½®
     * @return 0/5/10ï¼Œé»˜è®¤5
     */
    suspend fun getHistoryConversationCount(): Result<Int>

    /**
     * è®¾ç½®å†å²å¯¹è¯æ¡æ•°
     * @param count æ¡æ•°ï¼Œå¿…é¡»æ˜¯ 0/5/10 ä¹‹ä¸€
     */
    suspend fun setHistoryConversationCount(count: Int): Result<Unit>
}
```

### 5. SettingsRepositoryImpl å®ç°

```kotlin
@Singleton
class SettingsRepositoryImpl @Inject constructor(
    private val settingsPreferences: SettingsPreferences
) : SettingsRepository {

    // ... ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜ ...

    override suspend fun getHistoryConversationCount(): Result<Int> {
        return try {
            Result.success(settingsPreferences.getHistoryConversationCount())
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    override suspend fun setHistoryConversationCount(count: Int): Result<Unit> {
        return try {
            require(count in ConversationContextConfig.HISTORY_COUNT_OPTIONS) {
                "å†å²æ¡æ•°å¿…é¡»æ˜¯ ${ConversationContextConfig.HISTORY_COUNT_OPTIONS.joinToString()} ä¹‹ä¸€"
            }
            settingsPreferences.setHistoryConversationCount(count)
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

### 6. SettingsPreferences æ‰©å±•

```kotlin
@Singleton
class SettingsPreferences @Inject constructor(
    @ApplicationContext private val context: Context
) {
    private val prefs = context.getSharedPreferences("settings", Context.MODE_PRIVATE)

    companion object {
        private const val KEY_HISTORY_CONVERSATION_COUNT = "history_conversation_count"
        private const val DEFAULT_HISTORY_COUNT = 5
    }

    // ... ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜ ...

    /**
     * è·å–å†å²å¯¹è¯æ¡æ•°
     */
    fun getHistoryConversationCount(): Int {
        return prefs.getInt(KEY_HISTORY_CONVERSATION_COUNT, DEFAULT_HISTORY_COUNT)
    }

    /**
     * è®¾ç½®å†å²å¯¹è¯æ¡æ•°
     */
    fun setHistoryConversationCount(count: Int) {
        prefs.edit().putInt(KEY_HISTORY_CONVERSATION_COUNT, count).apply()
    }
}
```

---

## ğŸ”— ä¸ç°æœ‰ä»£ç çš„é›†æˆè®¾è®¡

### 1. AnalyzeChatUseCase é›†æˆ

**ä¿®æ”¹ä½ç½®**ï¼š`domain/usecase/AnalyzeChatUseCase.kt`

**é›†æˆæ–¹æ¡ˆ**ï¼šåœ¨æ„å»ºä¸Šä¸‹æ–‡æ—¶åŠ å…¥å†å²å¯¹è¯

```kotlin
class AnalyzeChatUseCase @Inject constructor(
    private val contactRepository: ContactRepository,
    private val brainTagRepository: BrainTagRepository,
    private val privacyRepository: PrivacyRepository,
    private val aiRepository: AiRepository,
    private val settingsRepository: SettingsRepository,
    private val aiProviderRepository: AiProviderRepository,
    private val conversationRepository: ConversationRepository,
    private val promptBuilder: PromptBuilder,
    private val conversationContextBuilder: ConversationContextBuilder  // æ–°å¢
) {
    suspend operator fun invoke(
        contactId: String,
        rawScreenContext: List<String>
    ): Result<AnalysisResult> {
        // ... ç°æœ‰å‰ç½®æ£€æŸ¥é€»è¾‘ ...

        // ã€æ–°å¢ã€‘è·å–å†å²å¯¹è¯é…ç½®
        val historyCount = settingsRepository.getHistoryConversationCount()
            .getOrDefault(ConversationContextConfig.DEFAULT_HISTORY_COUNT)

        // ã€æ–°å¢ã€‘æ„å»ºå†å²ä¸Šä¸‹æ–‡
        val historyContext = if (historyCount > 0) {
            buildHistoryContext(contactId, historyCount)
        } else {
            ""
        }

        // æ„å»ºè¿è¡Œæ—¶æ•°æ®ï¼ˆåŠ å…¥å†å²ä¸Šä¸‹æ–‡ï¼‰
        val runtimeData = buildContextData(
            targetGoal = profile.targetGoal,
            facts = profile.facts,
            redTags = redTags,
            greenTags = greenTags,
            conversationHistory = maskedContext,
            historyContext = historyContext  // æ–°å¢å‚æ•°
        )

        // ... åç»­AIè°ƒç”¨é€»è¾‘ ...
    }

    /**
     * ã€æ–°å¢ã€‘æ„å»ºå†å²ä¸Šä¸‹æ–‡
     * 
     * ã€é‡è¦è¯´æ˜ã€‘å½“å‰ç‰ˆæœ¬ä»…å›æ”¾ç”¨æˆ·ä¾§å†å²
     * åŸå› ï¼šæ•°æ®åº“ conversation_logs è¡¨åªå­˜å‚¨äº† user_inputï¼Œ
     * æ²¡æœ‰å­˜å‚¨è”ç³»äººçš„æ¶ˆæ¯ï¼Œå› æ­¤ sender å›ºå®šä¸º MessageSender.USERã€‚
     * 
     * åç»­æ‰©å±•æ–¹å‘ï¼š
     * - æ‰©å±•æ•°æ®åº“è¡¨å¢åŠ  sender_type å­—æ®µ
     * - æˆ–ä»å±å¹•æŠ“å–æ—¶è§£ææ¶ˆæ¯å‘é€è€…
     */
    private suspend fun buildHistoryContext(contactId: String, limit: Int): String {
        val recentLogs = conversationRepository
            .getRecentConversations(contactId, limit)
            .getOrDefault(emptyList())

        if (recentLogs.isEmpty()) return ""

        // å°†ConversationLogè½¬æ¢ä¸ºTimestampedMessage
        // ã€æ³¨æ„ã€‘å½“å‰ç‰ˆæœ¬ sender å›ºå®šä¸º USERï¼Œå› ä¸ºæ•°æ®åº“åªå­˜å‚¨ç”¨æˆ·è¾“å…¥
        val messages = recentLogs.map { log ->
            TimestampedMessage(
                content = log.userInput,
                timestamp = log.timestamp,
                sender = MessageSender.USER  // å½“å‰ç‰ˆæœ¬å›ºå®šä¸ºUSER
            )
        }

        return conversationContextBuilder.buildHistoryContext(messages)
    }

    /**
     * ã€ä¿®æ”¹ã€‘æ„å»ºä¸Šä¸‹æ–‡æ•°æ®ï¼ŒåŠ å…¥å†å²å¯¹è¯åŒºå—
     */
    private fun buildContextData(
        targetGoal: String,
        facts: List<Fact>,
        redTags: List<BrainTag>,
        greenTags: List<BrainTag>,
        conversationHistory: List<String>,
        historyContext: String = ""  // æ–°å¢å‚æ•°
    ): String {
        return buildString {
            // ã€æ–°å¢ã€‘å†å²å¯¹è¯åŒºå—ï¼ˆæ”¾åœ¨æœ€å‰é¢ï¼Œè®©AIå…ˆäº†è§£èƒŒæ™¯ï¼‰
            if (historyContext.isNotBlank()) {
                appendLine(historyContext)
                appendLine()
            }

            appendLine("ã€æ”»ç•¥ç›®æ ‡ã€‘")
            appendLine(targetGoal)
            appendLine()

            if (facts.isNotEmpty()) {
                appendLine("ã€å·²çŸ¥ä¿¡æ¯ã€‘")
                facts.forEach { fact ->
                    appendLine("- ${fact.key}: ${fact.value}")
                }
                appendLine()
            }

            if (redTags.isNotEmpty()) {
                appendLine("ã€é›·åŒºè­¦å‘Šã€‘")
                redTags.forEach { tag ->
                    appendLine("- ${tag.content}")
                }
                appendLine()
            }

            if (greenTags.isNotEmpty()) {
                appendLine("ã€ç­–ç•¥å»ºè®®ã€‘")
                greenTags.forEach { tag ->
                    appendLine("- ${tag.content}")
                }
                appendLine()
            }

            appendLine("ã€å½“å‰èŠå¤©è®°å½•ã€‘")
            conversationHistory.forEach { message ->
                appendLine(message)
            }
        }
    }
}
```

### 2. å®Œæ•´ä¸Šä¸‹æ–‡ç»“æ„ç¤ºä¾‹

**AIæœ€ç»ˆçœ‹åˆ°çš„ä¸Šä¸‹æ–‡**ï¼š

```
ã€å†å²å¯¹è¯ã€‘(æœ€è¿‘5æ¡)
[User]: å®ï¼Œæ—©å®‰
[Contact]: æ—©å‘€ (08:30)
--- (ç»è¿‡äº† 20 åˆ†é’Ÿ) ---
[User]: æˆ‘å‡ºé—¨äº† (08:50)
[Contact]: è·¯ä¸Šå°å¿ƒ (08:55)
--- (è·ç¦»ä¸Šæ¬¡å¯¹è¯å·²è¿‡ 6 å°æ—¶ï¼Œæ³¨æ„å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå †ç§¯) ---
[Contact]: ä½ ä»Šå¤©ä¸€å¤©éƒ½å¾ˆå¿™å—ï¼Ÿ (15:00)

ã€æ”»ç•¥ç›®æ ‡ã€‘
è¿½æ±‚é˜¶æ®µï¼Œå¸Œæœ›å‘å±•æˆæ‹äººå…³ç³»

ã€å·²çŸ¥ä¿¡æ¯ã€‘
- ç”Ÿæ—¥: 3æœˆ15æ—¥
- çˆ±å¥½: çœ‹ç”µå½±ã€å–å’–å•¡
- å·¥ä½œ: è®¾è®¡å¸ˆ

ã€é›·åŒºè­¦å‘Šã€‘
- ä¸è¦æå‰ä»»
- ä¸è¦å‚¬ä¿ƒå›å¤

ã€ç­–ç•¥å»ºè®®ã€‘
- å¤šå…³å¿ƒå¥¹çš„å·¥ä½œ
- é€‚å½“è¡¨è¾¾å…³å¿ƒ

ã€å½“å‰èŠå¤©è®°å½•ã€‘
ä½ ä»Šå¤©ä¸€å¤©éƒ½å¾ˆå¿™å—ï¼Ÿ
```

---

## ğŸ–¥ï¸ è®¾ç½®ç•Œé¢è®¾è®¡

### 1. è®¾ç½®é¡µé¢UIæ‰©å±•

**ä½ç½®**ï¼šè®¾ç½®é¡µé¢ â†’ AIé…ç½®åŒºåŸŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI é…ç½®                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é»˜è®¤æœåŠ¡å•†              DeepSeek    >   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æç¤ºè¯ç®¡ç†                          >   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†å²å¯¹è¯æ¡æ•°                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â—‹ ä¸å‘é€å†å² (0æ¡)                  â”‚ â”‚
â”‚ â”‚ â— æœ€è¿‘5æ¡ (æ¨è)                    â”‚ â”‚
â”‚ â”‚ â—‹ æœ€è¿‘10æ¡                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ å‘é€ç»™AIçš„å†å²å¯¹è¯æ•°é‡ï¼Œå¸®åŠ©AIç†è§£      â”‚
â”‚ å¯¹è¯ä¸Šä¸‹æ–‡å’Œæ—¶é—´é—´éš”                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. SettingsUiState æ‰©å±•

```kotlin
data class SettingsUiState(
    // ... ç°æœ‰å­—æ®µ ...
    
    /**
     * å†å²å¯¹è¯æ¡æ•°é…ç½®
     */
    val historyConversationCount: Int = 5,
    
    /**
     * å†å²æ¡æ•°é€‰é¡¹
     */
    val historyCountOptions: List<HistoryCountOption> = listOf(
        HistoryCountOption(0, "ä¸å‘é€å†å²", "æ¯æ¬¡åˆ†æç‹¬ç«‹ï¼Œä¸åŒ…å«å†å²å¯¹è¯"),
        HistoryCountOption(5, "æœ€è¿‘5æ¡", "æ¨èï¼Œå¹³è¡¡ä¸Šä¸‹æ–‡å’ŒTokenæ¶ˆè€—"),
        HistoryCountOption(10, "æœ€è¿‘10æ¡", "æ›´å®Œæ•´çš„ä¸Šä¸‹æ–‡ï¼ŒTokenæ¶ˆè€—è¾ƒé«˜")
    )
)

/**
 * å†å²æ¡æ•°é€‰é¡¹
 */
data class HistoryCountOption(
    val count: Int,
    val label: String,
    val description: String
)
```

### 3. SettingsUiEvent æ‰©å±•

```kotlin
sealed class SettingsUiEvent {
    // ... ç°æœ‰äº‹ä»¶ ...
    
    /**
     * æ›´æ”¹å†å²å¯¹è¯æ¡æ•°
     */
    data class ChangeHistoryConversationCount(val count: Int) : SettingsUiEvent()
}
```

### 4. SettingsViewModel æ‰©å±•

```kotlin
@HiltViewModel
class SettingsViewModel @Inject constructor(
    // ... ç°æœ‰ä¾èµ– ...
    private val settingsRepository: SettingsRepository
) : ViewModel() {

    // ... ç°æœ‰ä»£ç  ...

    init {
        loadSettings()
    }

    private fun loadSettings() {
        viewModelScope.launch {
            // ... ç°æœ‰åŠ è½½é€»è¾‘ ...
            
            // åŠ è½½å†å²å¯¹è¯æ¡æ•°é…ç½®
            val historyCount = settingsRepository.getHistoryConversationCount()
                .getOrDefault(5)
            _uiState.update { it.copy(historyConversationCount = historyCount) }
        }
    }

    fun onEvent(event: SettingsUiEvent) {
        when (event) {
            // ... ç°æœ‰äº‹ä»¶å¤„ç† ...
            
            is SettingsUiEvent.ChangeHistoryConversationCount -> {
                changeHistoryConversationCount(event.count)
            }
        }
    }

    private fun changeHistoryConversationCount(count: Int) {
        viewModelScope.launch {
            settingsRepository.setHistoryConversationCount(count)
                .onSuccess {
                    _uiState.update { it.copy(historyConversationCount = count) }
                }
                .onFailure { e ->
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    Log.e(TAG, "ä¿å­˜å†å²æ¡æ•°é…ç½®å¤±è´¥", e)
                }
        }
    }
}
```

### 5. SettingsScreen UIç»„ä»¶

```kotlin
@Composable
fun HistoryConversationCountSection(
    selectedCount: Int,
    options: List<HistoryCountOption>,
    onCountChange: (Int) -> Unit,
    modifier: Modifier = Modifier
) {
    Column(modifier = modifier.padding(16.dp)) {
        Text(
            text = "å†å²å¯¹è¯æ¡æ•°",
            style = MaterialTheme.typography.titleMedium
        )
        
        Spacer(modifier = Modifier.height(8.dp))
        
        options.forEach { option ->
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .clickable { onCountChange(option.count) }
                    .padding(vertical = 8.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                RadioButton(
                    selected = selectedCount == option.count,
                    onClick = { onCountChange(option.count) }
                )
                
                Spacer(modifier = Modifier.width(8.dp))
                
                Column {
                    Text(
                        text = option.label,
                        style = MaterialTheme.typography.bodyLarge
                    )
                    Text(
                        text = option.description,
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }
        }
        
        Spacer(modifier = Modifier.height(8.dp))
        
        Text(
            text = "å‘é€ç»™AIçš„å†å²å¯¹è¯æ•°é‡ï¼Œå¸®åŠ©AIç†è§£å¯¹è¯ä¸Šä¸‹æ–‡å’Œæ—¶é—´é—´éš”",
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

**ç´¢å¼•åˆ©ç”¨**ï¼š`conversation_logs` è¡¨å·²æœ‰ `contact_id` å’Œ `timestamp` ç´¢å¼•

```kotlin
// ç°æœ‰ç´¢å¼•å®šä¹‰ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
@Entity(
    tableName = "conversation_logs",
    indices = [
        Index(value = ["contact_id"]),
        Index(value = ["timestamp"]),
        Index(value = ["is_summarized"])
    ]
)
```

**æŸ¥è¯¢ä¼˜åŒ–**ï¼šä½¿ç”¨å­æŸ¥è¯¢é¿å…å…¨è¡¨æ‰«æ

```sql
-- ä¼˜åŒ–åçš„æŸ¥è¯¢ï¼ˆå…ˆå€’åºå–Næ¡ï¼Œå†æ­£åºæ’åˆ—ï¼‰
SELECT * FROM (
    SELECT * FROM conversation_logs 
    WHERE contact_id = :contactId 
    ORDER BY timestamp DESC 
    LIMIT :limit
) 
ORDER BY timestamp ASC
```

### 2. å†…å­˜ä¼˜åŒ–

- **é™åˆ¶å†å²æ¡æ•°**ï¼šæœ€å¤š10æ¡ï¼Œé¿å…å†…å­˜å ç”¨è¿‡å¤§
- **å­—ç¬¦ä¸²æ„å»º**ï¼šä½¿ç”¨ `buildString` é¿å…å¤šæ¬¡å­—ç¬¦ä¸²æ‹¼æ¥
- **æ‡’åŠ è½½**ï¼šåªåœ¨éœ€è¦æ—¶æ‰æŸ¥è¯¢å†å²å¯¹è¯

### 3. Tokenæ¶ˆè€—ä¼°ç®—

| å†å²æ¡æ•° | é¢„ä¼°Tokenå¢åŠ  | è¯´æ˜ |
|---------|--------------|------|
| 0æ¡ | 0 | ä¸å‘é€å†å² |
| 5æ¡ | ~200-400 | çº¦5-10%å¢åŠ  |
| 10æ¡ | ~400-800 | çº¦10-20%å¢åŠ  |

**ä¼˜åŒ–ç­–ç•¥**ï¼šæ—¶é—´æ ‡è®°ç®€æ´ï¼Œä¸ç»™æ¯æ¡æ¶ˆæ¯éƒ½åŠ æ ‡è®°

---

## ğŸš¨ é”™è¯¯å¤„ç†æœºåˆ¶

### 1. é”™è¯¯ç±»å‹å®šä¹‰

```kotlin
/**
 * å¯¹è¯ä¸Šä¸‹æ–‡æ„å»ºé”™è¯¯
 */
sealed class ConversationContextError : Exception() {
    /**
     * æ•°æ®åº“æŸ¥è¯¢å¤±è´¥
     */
    data class DatabaseError(override val cause: Throwable) : ConversationContextError()
    
    /**
     * é…ç½®æ— æ•ˆ
     */
    data class InvalidConfig(override val message: String) : ConversationContextError()
}
```

### 2. é”™è¯¯å¤„ç†ç­–ç•¥

| é”™è¯¯åœºæ™¯ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·å½±å“ |
|---------|---------|---------|
| æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ | è¿”å›ç©ºå†å²ï¼Œç»§ç»­åˆ†æ | æ— æ„ŸçŸ¥ï¼Œåˆ†ææ­£å¸¸è¿›è¡Œ |
| é…ç½®è¯»å–å¤±è´¥ | ä½¿ç”¨é»˜è®¤å€¼(5æ¡) | æ— æ„ŸçŸ¥ |
| æ—¶é—´æˆ³å¼‚å¸¸ | è·³è¿‡è¯¥æ¡æ¶ˆæ¯ | å†å²å¯èƒ½ä¸å®Œæ•´ |

### 3. é™çº§ç­–ç•¥

```kotlin
private suspend fun buildHistoryContext(contactId: String, limit: Int): String {
    return try {
        val recentLogs = conversationRepository
            .getRecentConversations(contactId, limit)
            .getOrDefault(emptyList())

        if (recentLogs.isEmpty()) return ""

        val messages = recentLogs.mapNotNull { log ->
            try {
                TimestampedMessage(
                    content = log.userInput,
                    timestamp = log.timestamp,
                    sender = MessageSender.USER
                )
            } catch (e: Exception) {
                Log.w(TAG, "è·³è¿‡æ— æ•ˆçš„å¯¹è¯è®°å½•: ${log.id}", e)
                null  // è·³è¿‡æ— æ•ˆè®°å½•
            }
        }

        conversationContextBuilder.buildHistoryContext(messages)
    } catch (e: Exception) {
        Log.e(TAG, "æ„å»ºå†å²ä¸Šä¸‹æ–‡å¤±è´¥ï¼Œé™çº§ä¸ºç©ºå†å²", e)
        ""  // é™çº§ï¼šè¿”å›ç©ºå†å²ï¼Œä¸å½±å“ä¸»æµç¨‹
    }
}
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

#### ConversationContextBuilderTest

```kotlin
class ConversationContextBuilderTest {

    private lateinit var builder: ConversationContextBuilder

    @Before
    fun setup() {
        builder = ConversationContextBuilder()
    }

    @Test
    fun `ç©ºæ¶ˆæ¯åˆ—è¡¨è¿”å›ç©ºå­—ç¬¦ä¸²`() {
        val result = builder.buildHistoryContext(emptyList())
        assertEquals("", result)
    }

    @Test
    fun `å•æ¡æ¶ˆæ¯ä¸æ’å…¥æ—¶é—´æ ‡è®°`() {
        val messages = listOf(
            TimestampedMessage("ä½ å¥½", 1702684200000, MessageSender.USER)
        )
        val result = builder.buildHistoryContext(messages)
        
        assertTrue(result.contains("[User]: ä½ å¥½"))
        assertFalse(result.contains("---"))
    }

    @Test
    fun `çƒ­å¯¹è¯ä¸æ’å…¥æ—¶é—´æ ‡è®°`() {
        val baseTime = 1702684200000L
        val messages = listOf(
            TimestampedMessage("ä½ å¥½", baseTime, MessageSender.USER),
            TimestampedMessage("ä½ å¥½å‘€", baseTime + 5 * 60 * 1000, MessageSender.CONTACT) // 5åˆ†é’Ÿå
        )
        val result = builder.buildHistoryContext(messages)
        
        assertFalse(result.contains("ç»è¿‡äº†"))
    }

    @Test
    fun `æ¸©å¯¹è¯æ’å…¥è½»æ ‡è®°`() {
        val baseTime = 1702684200000L
        val messages = listOf(
            TimestampedMessage("ä½ å¥½", baseTime, MessageSender.USER),
            TimestampedMessage("ä½ å¥½å‘€", baseTime + 30 * 60 * 1000, MessageSender.CONTACT) // 30åˆ†é’Ÿå
        )
        val result = builder.buildHistoryContext(messages)
        
        assertTrue(result.contains("ç»è¿‡äº† 30 åˆ†é’Ÿ"))
    }

    @Test
    fun `å†·å¯¹è¯æ’å…¥å¼ºæ ‡è®°å¹¶æç¤ºæƒ…ç»ª`() {
        val baseTime = 1702684200000L
        val messages = listOf(
            TimestampedMessage("ä½ å¥½", baseTime, MessageSender.USER),
            TimestampedMessage("ä½ å¥½å‘€", baseTime + 6 * 60 * 60 * 1000, MessageSender.CONTACT) // 6å°æ—¶å
        )
        val result = builder.buildHistoryContext(messages)
        
        assertTrue(result.contains("è·ç¦»ä¸Šæ¬¡å¯¹è¯å·²è¿‡ 6 å°æ—¶"))
        assertTrue(result.contains("æƒ…ç»ªå †ç§¯"))
    }

    @Test
    fun `è·¨å¤©æ’å…¥æ—¥æœŸæ ‡è®°`() {
        val day1 = 1702684200000L  // 2023-12-16 08:10
        val day2 = day1 + 24 * 60 * 60 * 1000  // 2023-12-17 08:10
        val messages = listOf(
            TimestampedMessage("æ™šå®‰", day1, MessageSender.USER),
            TimestampedMessage("æ—©å®‰", day2, MessageSender.CONTACT)
        )
        val result = builder.buildHistoryContext(messages)
        
        assertTrue(result.contains("--- ["))
    }

    @Test
    fun `æ—¶é—´æ ¼å¼åŒ–æ­£ç¡®`() {
        val messages = listOf(
            TimestampedMessage("ä½ å¥½", 1702684200000, MessageSender.USER) // 08:10
        )
        val result = builder.buildHistoryContext(messages)
        
        // ç¬¬ä¸€æ¡æ¶ˆæ¯ä¸æ˜¾ç¤ºæ—¶é—´ï¼ˆå› ä¸ºæ²¡æœ‰æ—¶é—´é—´éš”ï¼‰
        assertTrue(result.contains("[User]: ä½ å¥½"))
    }
}
```

#### TimeFlowMarkerTest

```kotlin
class TimeFlowMarkerTest {

    @Test
    fun `DateChangeæ˜¾ç¤ºæ ¼å¼æ­£ç¡®`() {
        val marker = TimeFlowMarker.DateChange("2025-12-16")
        assertEquals("--- [2025-12-16] ---", marker.toDisplayString())
    }

    @Test
    fun `ShortGapåˆ†é’Ÿæ˜¾ç¤ºæ ¼å¼æ­£ç¡®`() {
        val marker = TimeFlowMarker.ShortGap(30)
        assertEquals("--- (ç»è¿‡äº† 30 åˆ†é’Ÿ) ---", marker.toDisplayString())
    }

    @Test
    fun `ShortGapå°æ—¶æ˜¾ç¤ºæ ¼å¼æ­£ç¡®`() {
        val marker = TimeFlowMarker.ShortGap(90)
        assertEquals("--- (ç»è¿‡äº† 1 å°æ—¶) ---", marker.toDisplayString())
    }

    @Test
    fun `LongGapæ˜¾ç¤ºæ ¼å¼æ­£ç¡®`() {
        val marker = TimeFlowMarker.LongGap(6)
        assertEquals(
            "--- (è·ç¦»ä¸Šæ¬¡å¯¹è¯å·²è¿‡ 6 å°æ—¶ï¼Œæ³¨æ„å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå †ç§¯) ---",
            marker.toDisplayString()
        )
    }

    @Test
    fun `Noneè¿”å›ç©ºå­—ç¬¦ä¸²`() {
        assertEquals("", TimeFlowMarker.None.toDisplayString())
    }
}
```

#### TimestampedMessageTest

```kotlin
class TimestampedMessageTest {

    @Test
    fun `toDisplayStringåŒ…å«å‘é€è€…å‰ç¼€`() {
        val message = TimestampedMessage("ä½ å¥½", 1702684200000, MessageSender.USER)
        assertTrue(message.toDisplayString().startsWith("[User]:"))
    }

    @Test
    fun `toDisplayStringåŒ…å«æ—¶é—´`() {
        val message = TimestampedMessage("ä½ å¥½", 1702684200000, MessageSender.USER)
        val result = message.toDisplayString(showTime = true)
        assertTrue(result.contains("("))
        assertTrue(result.contains(")"))
    }

    @Test
    fun `toDisplayStringä¸åŒ…å«æ—¶é—´`() {
        val message = TimestampedMessage("ä½ å¥½", 1702684200000, MessageSender.USER)
        val result = message.toDisplayString(showTime = false)
        assertFalse(result.contains("("))
    }

    @Test(expected = IllegalArgumentException::class)
    fun `ç©ºå†…å®¹æŠ›å‡ºå¼‚å¸¸`() {
        TimestampedMessage("", 1702684200000, MessageSender.USER)
    }

    @Test(expected = IllegalArgumentException::class)
    fun `æ— æ•ˆæ—¶é—´æˆ³æŠ›å‡ºå¼‚å¸¸`() {
        TimestampedMessage("ä½ å¥½", 0, MessageSender.USER)
    }
}
```

### 2. é›†æˆæµ‹è¯•

#### AnalyzeChatUseCaseIntegrationTest

```kotlin
@HiltAndroidTest
class AnalyzeChatUseCaseIntegrationTest {

    @Inject
    lateinit var analyzeChatUseCase: AnalyzeChatUseCase

    @Inject
    lateinit var conversationRepository: ConversationRepository

    @Inject
    lateinit var settingsRepository: SettingsRepository

    @Test
    fun `åˆ†ææ—¶åŒ…å«å†å²å¯¹è¯ä¸Šä¸‹æ–‡`() = runTest {
        // Given: è®¾ç½®å†å²æ¡æ•°ä¸º5
        settingsRepository.setHistoryConversationCount(5)
        
        // Given: ä¿å­˜ä¸€äº›å†å²å¯¹è¯
        conversationRepository.saveUserInput("contact_1", "æ—©å®‰")
        conversationRepository.saveUserInput("contact_1", "æˆ‘å‡ºé—¨äº†")
        
        // When: æ‰§è¡Œåˆ†æ
        val result = analyzeChatUseCase(
            contactId = "contact_1",
            rawScreenContext = listOf("ä½ ä»Šå¤©å¿™å—ï¼Ÿ")
        )
        
        // Then: éªŒè¯å†å²ä¸Šä¸‹æ–‡è¢«åŒ…å«
        // (é€šè¿‡æ—¥å¿—æˆ–MockéªŒè¯)
    }

    @Test
    fun `å†å²æ¡æ•°ä¸º0æ—¶ä¸åŒ…å«å†å²`() = runTest {
        // Given: è®¾ç½®å†å²æ¡æ•°ä¸º0
        settingsRepository.setHistoryConversationCount(0)
        
        // When: æ‰§è¡Œåˆ†æ
        val result = analyzeChatUseCase(
            contactId = "contact_1",
            rawScreenContext = listOf("ä½ å¥½")
        )
        
        // Then: éªŒè¯æ²¡æœ‰å†å²ä¸Šä¸‹æ–‡
    }
}
```

### 3. æµ‹è¯•è¦†ç›–ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | é‡ç‚¹æµ‹è¯•é¡¹ |
|------|-----------|-----------|
| ConversationContextBuilder | 90%+ | æ—¶é—´æ ‡è®°ç®—æ³•ã€è¾¹ç•Œæ¡ä»¶ |
| TimeFlowMarker | 100% | æ‰€æœ‰æ ‡è®°ç±»å‹çš„æ˜¾ç¤ºæ ¼å¼ |
| TimestampedMessage | 100% | æ ¼å¼åŒ–ã€éªŒè¯é€»è¾‘ |
| ConversationRepositoryæ‰©å±• | 80%+ | æŸ¥è¯¢æ­£ç¡®æ€§ã€æ’åº |
| SettingsRepositoryæ‰©å±• | 80%+ | é…ç½®è¯»å†™ |

---

## ğŸ“‹ å®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šé¢†åŸŸå±‚å®ç°ï¼ˆé¢„è®¡1å¤©ï¼‰

| ä»»åŠ¡ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| 1.1 | `MessageSender.kt` | æ–°å»ºæ¶ˆæ¯å‘é€è€…æšä¸¾ |
| 1.2 | `TimestampedMessage.kt` | æ–°å»ºå¸¦æ—¶é—´æˆ³æ¶ˆæ¯æ¨¡å‹ |
| 1.3 | `TimeFlowMarker.kt` | æ–°å»ºæ—¶é—´æµé€æ ‡è®°å¯†å°ç±» |
| 1.4 | `ConversationContextConfig.kt` | æ–°å»ºé…ç½®æ¨¡å‹ |
| 1.5 | `ConversationContextBuilder.kt` | æ–°å»ºä¸Šä¸‹æ–‡æ„å»ºå™¨ |
| 1.6 | å•å…ƒæµ‹è¯• | ç¼–å†™ä¸Šè¿°ç»„ä»¶çš„å•å…ƒæµ‹è¯• |

### é˜¶æ®µ2ï¼šæ•°æ®å±‚å®ç°ï¼ˆé¢„è®¡0.5å¤©ï¼‰

| ä»»åŠ¡ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| 2.1 | `ConversationLogDao.kt` | æ·»åŠ  `getRecentConversations` æ–¹æ³• |
| 2.2 | `ConversationRepository.kt` | æ‰©å±•æ¥å£ |
| 2.3 | `ConversationRepositoryImpl.kt` | å®ç°æ–°æ–¹æ³• |
| 2.4 | `SettingsPreferences.kt` | æ·»åŠ å†å²æ¡æ•°å­˜å‚¨ |
| 2.5 | `SettingsRepository.kt` | æ‰©å±•æ¥å£ |
| 2.6 | `SettingsRepositoryImpl.kt` | å®ç°æ–°æ–¹æ³• |

### é˜¶æ®µ3ï¼šä¸šåŠ¡å±‚é›†æˆï¼ˆé¢„è®¡0.5å¤©ï¼‰

| ä»»åŠ¡ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| 3.1 | `AnalyzeChatUseCase.kt` | é›†æˆå†å²ä¸Šä¸‹æ–‡æ„å»º |
| 3.2 | `ContextBuilder.kt` | å¯é€‰ï¼šæ‰©å±•æ”¯æŒå†å²åŒºå— |

### é˜¶æ®µ4ï¼šUIå±‚å®ç°ï¼ˆé¢„è®¡0.5å¤©ï¼‰

| ä»»åŠ¡ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| 4.1 | `SettingsUiState.kt` | æ·»åŠ å†å²æ¡æ•°çŠ¶æ€ |
| 4.2 | `SettingsUiEvent.kt` | æ·»åŠ æ›´æ”¹äº‹ä»¶ |
| 4.3 | `SettingsViewModel.kt` | å®ç°äº‹ä»¶å¤„ç† |
| 4.4 | `SettingsScreen.kt` | æ·»åŠ UIç»„ä»¶ |

### é˜¶æ®µ5ï¼šæµ‹è¯•ä¸éªŒæ”¶ï¼ˆé¢„è®¡1å¤©ï¼‰

| ä»»åŠ¡ | è¯´æ˜ |
|------|------|
| 5.1 | è¡¥å……é›†æˆæµ‹è¯• |
| 5.2 | ç«¯åˆ°ç«¯æµ‹è¯• |
| 5.3 | æ€§èƒ½æµ‹è¯• |
| 5.4 | æ–‡æ¡£æ›´æ–° |

**æ€»é¢„è®¡å·¥ä½œé‡**ï¼š3.5å¤©

---

## âš ï¸ å·²çŸ¥é™åˆ¶ä¸åç»­ä¼˜åŒ–

### 1. MessageSender æ•°æ®æ¥æºé™åˆ¶

| é—®é¢˜ | å½“å‰çŠ¶æ€ | åç»­ä¼˜åŒ–æ–¹å‘ |
|------|---------|-------------|
| æ•°æ®åº“åªå­˜å‚¨ç”¨æˆ·è¾“å…¥ | sender å›ºå®šä¸º `USER` | æ‰©å±•è¡¨ç»“æ„å¢åŠ  `sender_type` å­—æ®µ |
| æ— æ³•åŒºåˆ†ç”¨æˆ·/è”ç³»äººæ¶ˆæ¯ | ä»…å›æ”¾ç”¨æˆ·ä¾§å†å² | ä»å±å¹•æŠ“å–æ—¶è§£æå‘é€è€… |
| `CONTACT` ç±»å‹æœªä½¿ç”¨ | é¢„ç•™ç»™åç»­ç‰ˆæœ¬ | ç”¨æˆ·æ‰‹åŠ¨æ ‡è®°æ¶ˆæ¯å½’å± |

**ä»£ç æ ‡æ³¨**ï¼šåœ¨ `buildHistoryContext` æ–¹æ³•ä¸­å·²æ·»åŠ æ³¨é‡Šè¯´æ˜æ­¤é™åˆ¶ã€‚

### 2. æ—¶é—´æ ¼å¼åŒ–æœ¬åœ°åŒ–

| é—®é¢˜ | å½“å‰çŠ¶æ€ | åç»­ä¼˜åŒ–æ–¹å‘ |
|------|---------|-------------|
| ç¡¬ç¼–ç ä¸­æ–‡å­—ç¬¦ä¸² | "åˆ†é’Ÿ"ã€"å°æ—¶"ç­‰ | æå–åˆ° `strings.xml` |
| SimpleDateFormat | ä½¿ç”¨é»˜è®¤Locale | ä½¿ç”¨ `java.time` API (Android O+) |
| ç›¸å¯¹æ—¶é—´æ ¼å¼ | è‡ªå®šä¹‰å®ç° | ä½¿ç”¨ `DateUtils.getRelativeTimeSpanString()` |

**MVPé˜¶æ®µ**ï¼šå½“å‰å®ç°æ»¡è¶³ä¸­æ–‡Appéœ€æ±‚ï¼Œåç»­å›½é™…åŒ–æ—¶å†ä¼˜åŒ–ã€‚

### 3. SQLæŸ¥è¯¢æ€§èƒ½

| åœºæ™¯ | é¢„ä¼°æ€§èƒ½ | ä¼˜åŒ–å»ºè®® |
|------|---------|---------|
| æ­£å¸¸åœºæ™¯ (<10ä¸‡æ¡) | < 10ms | æ— éœ€ä¼˜åŒ– |
| ä¸­ç­‰è§„æ¨¡ (10-50ä¸‡æ¡) | < 50ms | å¯æ¥å— |
| æç«¯åœºæ™¯ (>50ä¸‡æ¡) | å¯èƒ½è¾ƒæ…¢ | æ·»åŠ å¤åˆç´¢å¼• |

**å¤åˆç´¢å¼•å»ºè®®**ï¼ˆåç»­ç‰ˆæœ¬ï¼‰ï¼š
```sql
CREATE INDEX idx_contact_timestamp ON conversation_logs(contact_id, timestamp DESC)
```

### 4. åç»­ç‰ˆæœ¬æ‰©å±•ç‚¹

- [ ] æ”¯æŒè”ç³»äººæ¶ˆæ¯å›æ”¾ï¼ˆéœ€æ‰©å±•æ•°æ®åº“ï¼‰
- [ ] å­—ç¬¦ä¸²èµ„æºæœ¬åœ°åŒ–ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
- [ ] ä½¿ç”¨ `java.time` API æ›¿ä»£ `SimpleDateFormat`
- [ ] æ·»åŠ å¤åˆç´¢å¼•ä¼˜åŒ–å¤§æ•°æ®é‡æŸ¥è¯¢
- [ ] æ”¯æŒè‡ªå®šä¹‰æ—¶é—´é˜ˆå€¼é…ç½®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PRD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºéœ€æ±‚](../PRD/PRD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºéœ€æ±‚.md)
- [ContextBuilder.kt](../../../app/src/main/java/com/empathy/ai/domain/util/ContextBuilder.kt)
- [ConversationRepository.kt](../../../app/src/main/java/com/empathy/ai/domain/repository/ConversationRepository.kt)
- [AnalyzeChatUseCase.kt](../../../app/src/main/java/com/empathy/ai/domain/usecase/AnalyzeChatUseCase.kt)
- [ConversationLogDao.kt](../../../app/src/main/java/com/empathy/ai/data/local/dao/ConversationLogDao.kt)
