# FD-00009: æ‚¬æµ®çª—åŠŸèƒ½é‡æ„åŠŸèƒ½è®¾è®¡

> **æ–‡æ¡£ç±»å‹**: åŠŸèƒ½è®¾è®¡æ–‡æ¡£ (FD)  
> **ç‰ˆæœ¬**: 1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-17  
> **æœ€åæ›´æ–°**: 2025-12-17  
> **è´Ÿè´£äºº**: Kiro  
> **å®¡æŸ¥äºº**: å¾…å®š  
> **çŠ¶æ€**: ğŸ“ è‰ç¨¿  
> **ä¼˜å…ˆçº§**: ğŸ”´ é«˜  
> **å…³è”PRD**: PRD-00009  

---

## ğŸ“œ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-17 | Kiro | åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«å®Œæ•´æ¶æ„è®¾è®¡ |

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°æ‚¬æµ®çª—åŠŸèƒ½é‡æ„çš„æŠ€æœ¯æ¶æ„ã€ç»„ä»¶è®¾è®¡ã€æ•°æ®æµå’Œå®ç°ç»†èŠ‚ã€‚

**è®¾è®¡ç›®æ ‡**ï¼š
- å°†ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½ï¼ˆåˆ†æã€æ¶¦è‰²ã€å›å¤ï¼‰ç»Ÿä¸€åˆ°Tabåˆ‡æ¢ç•Œé¢
- å®ç°çŠ¶æ€ä¿æŒï¼Œæœ€å°åŒ–æ—¶ä¿å­˜å®Œæ•´çŠ¶æ€
- å®ç°è”ç³»äººè®°å¿†ï¼Œé»˜è®¤é€‰ä¸­ä¸Šæ¬¡å¯¹è¯çš„è”ç³»äºº
- å®ç°å¾®è°ƒé‡æ–°ç”ŸæˆåŠŸèƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

**ä¾èµ–åº“ç‰ˆæœ¬**ï¼š
- Room: 2.6.1ï¼ˆæ•°æ®åº“ï¼‰
- Kotlin Coroutines: 1.9.0ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
- Hilt: 2.52ï¼ˆä¾èµ–æ³¨å…¥ï¼‰
- Material Components: 1.3.1ï¼ˆUIç»„ä»¶ï¼‰

---

## ğŸ“‘ ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
3. [æ ¸å¿ƒç»„ä»¶è®¾è®¡](#æ ¸å¿ƒç»„ä»¶è®¾è®¡)
4. [UseCaseè®¾è®¡](#usecaseè®¾è®¡)
5. [æç¤ºè¯è®¾è®¡](#æç¤ºè¯è®¾è®¡)
6. [UIç»„ä»¶è®¾è®¡](#uiç»„ä»¶è®¾è®¡)
7. [çŠ¶æ€ç®¡ç†è®¾è®¡](#çŠ¶æ€ç®¡ç†è®¾è®¡)
8. [ä¸ç°æœ‰ä»£ç çš„é›†æˆ](#ä¸ç°æœ‰ä»£ç çš„é›†æˆ)


---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ FloatingView â”‚  â”‚RefinementDialogâ”‚ â”‚ ResultCard  â”‚  â”‚
â”‚  â”‚  (ä¸»ç•Œé¢)    â”‚  â”‚  (å¾®è°ƒå¯¹è¯æ¡†) â”‚  â”‚  (ç»“æœå±•ç¤º) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Domain Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚AnalyzeChat   â”‚  â”‚PolishDraft   â”‚  â”‚GenerateReply â”‚  â”‚
â”‚  â”‚  UseCase     â”‚  â”‚  UseCase     â”‚  â”‚  UseCase     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Refinement   â”‚  â”‚PromptBuilder â”‚                    â”‚
â”‚  â”‚  UseCase     â”‚  â”‚  (æç¤ºè¯)    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Data Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚AiRepository  â”‚  â”‚FloatingWindowâ”‚  â”‚ContactDao    â”‚  â”‚
â”‚  â”‚  Impl        â”‚  â”‚ Preferences  â”‚  â”‚              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—åˆ’åˆ†

```
domain/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ ActionType.kt              # æ“ä½œç±»å‹æšä¸¾ï¼ˆæ‰©å±•ï¼‰
â”‚   â”œâ”€â”€ PolishResult.kt            # æ¶¦è‰²ç»“æœæ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ ReplyResult.kt             # å›å¤ç»“æœæ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ FloatingWindowState.kt     # æ‚¬æµ®çª—çŠ¶æ€æ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ usecase/
â”‚   â”œâ”€â”€ AnalyzeChatUseCase.kt      # åˆ†æç”¨ä¾‹ï¼ˆå·²æœ‰ï¼‰
â”‚   â”œâ”€â”€ PolishDraftUseCase.kt      # æ¶¦è‰²ç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ GenerateReplyUseCase.kt    # å›å¤ç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ RefinementUseCase.kt       # å¾®è°ƒç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ util/
â”‚   â””â”€â”€ SystemPrompts.kt           # ç³»ç»Ÿæç¤ºè¯ï¼ˆæ‰©å±•ï¼‰

data/
â”œâ”€â”€ local/
â”‚   â””â”€â”€ FloatingWindowPreferences.kt  # æ‚¬æµ®çª—åå¥½ï¼ˆæ‰©å±•ï¼‰

presentation/
â”œâ”€â”€ ui/
â”‚   â””â”€â”€ floating/
â”‚       â”œâ”€â”€ FloatingView.kt        # ä¸»è§†å›¾ï¼ˆé‡æ„ï¼‰
â”‚       â”œâ”€â”€ TabSwitcher.kt         # Tabåˆ‡æ¢ç»„ä»¶ï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ ResultCard.kt          # ç»“æœå¡ç‰‡ï¼ˆæ–°å¢ï¼‰
â”‚       â””â”€â”€ RefinementDialog.kt    # å¾®è°ƒå¯¹è¯æ¡†ï¼ˆæ–°å¢ï¼‰
```


---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### 1. ActionTypeï¼ˆæ“ä½œç±»å‹æšä¸¾ - æ‰©å±•ï¼‰

**èŒè´£**ï¼šå®šä¹‰æ‚¬æµ®çª—æ”¯æŒçš„æ“ä½œç±»å‹

```kotlin
enum class ActionType(
    val displayName: String,
    val icon: String,
    val identityPrefix: String
) {
    /**
     * å¸®æˆ‘åˆ†æ - åˆ†æå¯¹æ–¹è¯´çš„è¯
     */
    ANALYZE(
        displayName = "å¸®æˆ‘åˆ†æ",
        icon = "ğŸ”",
        identityPrefix = "ã€å¯¹æ–¹è¯´ã€‘"
    ),
    
    /**
     * å¸®æˆ‘æ¶¦è‰² - ä¼˜åŒ–æˆ‘è¦è¯´çš„è¯
     */
    POLISH(
        displayName = "å¸®æˆ‘æ¶¦è‰²",
        icon = "âœï¸",
        identityPrefix = "ã€æˆ‘æ­£åœ¨å›å¤ã€‘"
    ),
    
    /**
     * å¸®æˆ‘å›å¤ - æ ¹æ®å¯¹æ–¹çš„è¯ç”Ÿæˆå›å¤
     */
    REPLY(
        displayName = "å¸®æˆ‘å›å¤",
        icon = "ğŸ’¬",
        identityPrefix = "ã€å¯¹æ–¹è¯´ã€‘"
    );
    
    companion object {
        /**
         * è·å–é»˜è®¤æ“ä½œç±»å‹
         */
        fun default(): ActionType = ANALYZE
    }
}
```

### 2. PolishResultï¼ˆæ¶¦è‰²ç»“æœæ¨¡å‹ - æ–°å¢ï¼‰

**èŒè´£**ï¼šæ‰¿è½½æ¶¦è‰²åŠŸèƒ½çš„AIè¿”å›ç»“æœ

```kotlin
data class PolishResult(
    /**
     * ä¼˜åŒ–åçš„æ–‡æœ¬ï¼ˆå¯ç›´æ¥å¤åˆ¶ä½¿ç”¨ï¼‰
     */
    val polishedText: String,
    
    /**
     * æ˜¯å¦æ£€æµ‹åˆ°é£é™©
     */
    val hasRisk: Boolean = false,
    
    /**
     * é£é™©æç¤ºï¼ˆå¦‚æœæœ‰é£é™©ï¼‰
     */
    val riskWarning: String? = null
) {
    /**
     * è·å–ç”¨äºå¤åˆ¶çš„æ–‡æœ¬
     */
    fun getCopyableText(): String = polishedText
    
    /**
     * è·å–ç”¨äºæ˜¾ç¤ºçš„å®Œæ•´å†…å®¹
     */
    fun getDisplayContent(): String = buildString {
        append(polishedText)
        if (hasRisk && !riskWarning.isNullOrBlank()) {
            appendLine()
            appendLine()
            append("âš ï¸ é£é™©æç¤ºï¼š$riskWarning")
        }
    }
}
```

### 3. ReplyResultï¼ˆå›å¤ç»“æœæ¨¡å‹ - æ–°å¢ï¼‰

**èŒè´£**ï¼šæ‰¿è½½å›å¤åŠŸèƒ½çš„AIè¿”å›ç»“æœ

```kotlin
data class ReplyResult(
    /**
     * å»ºè®®çš„å›å¤å†…å®¹ï¼ˆå¯ç›´æ¥å¤åˆ¶ä½¿ç”¨ï¼‰
     */
    val suggestedReply: String,
    
    /**
     * ç­–ç•¥è¯´æ˜ï¼ˆä¸ºä»€ä¹ˆè¿™æ ·å›å¤ï¼‰
     */
    val strategyNote: String? = null
) {
    /**
     * è·å–ç”¨äºå¤åˆ¶çš„æ–‡æœ¬
     */
    fun getCopyableText(): String = suggestedReply
    
    /**
     * è·å–ç”¨äºæ˜¾ç¤ºçš„å®Œæ•´å†…å®¹
     */
    fun getDisplayContent(): String = buildString {
        append(suggestedReply)
        if (!strategyNote.isNullOrBlank()) {
            appendLine()
            appendLine()
            append("ğŸ’¡ ç­–ç•¥è¯´æ˜ï¼š$strategyNote")
        }
    }
}
```

### 4. FloatingWindowStateï¼ˆæ‚¬æµ®çª—çŠ¶æ€æ¨¡å‹ - æ–°å¢ï¼‰

**èŒè´£**ï¼šç®¡ç†æ‚¬æµ®çª—çš„å®Œæ•´çŠ¶æ€ï¼Œæ”¯æŒçŠ¶æ€ä¿æŒå’Œæ¢å¤

```kotlin
data class FloatingWindowState(
    /**
     * å½“å‰é€‰ä¸­çš„Tab
     */
    val selectedTab: ActionType = ActionType.ANALYZE,
    
    /**
     * é€‰ä¸­çš„è”ç³»äººID
     */
    val selectedContactId: String? = null,
    
    /**
     * è¾“å…¥æ¡†å†…å®¹
     */
    val inputText: String = "",
    
    /**
     * AIè¿”å›çš„ç»“æœ
     */
    val lastResult: AiResult? = null,
    
    /**
     * æ˜¯å¦æ­£åœ¨åŠ è½½
     */
    val isLoading: Boolean = false,
    
    /**
     * é”™è¯¯ä¿¡æ¯
     */
    val errorMessage: String? = null
) {
    /**
     * æ˜¯å¦æœ‰ç»“æœå¯æ˜¾ç¤º
     */
    fun hasResult(): Boolean = lastResult != null
    
    /**
     * æ˜¯å¦å¯ä»¥å‘é€è¯·æ±‚
     */
    fun canSubmit(): Boolean = 
        !isLoading && 
        inputText.isNotBlank() && 
        selectedContactId != null
    
    /**
     * æ¸…ç©ºç»“æœå’Œé”™è¯¯
     */
    fun clearResult(): FloatingWindowState = copy(
        lastResult = null,
        errorMessage = null
    )
}

/**
 * AIç»“æœçš„å¯†å°ç±»
 */
sealed class AiResult {
    /**
     * åˆ†æç»“æœ
     */
    data class Analysis(val result: AnalysisResult) : AiResult()
    
    /**
     * æ¶¦è‰²ç»“æœ
     */
    data class Polish(val result: PolishResult) : AiResult()
    
    /**
     * å›å¤ç»“æœ
     */
    data class Reply(val result: ReplyResult) : AiResult()
    
    /**
     * è·å–å¯å¤åˆ¶çš„æ–‡æœ¬
     */
    fun getCopyableText(): String = when (this) {
        is Analysis -> result.replySuggestion
        is Polish -> result.getCopyableText()
        is Reply -> result.getCopyableText()
    }
}
```

### 5. RefinementRequestï¼ˆå¾®è°ƒè¯·æ±‚æ¨¡å‹ - æ–°å¢ï¼‰

**èŒè´£**ï¼šæ‰¿è½½å¾®è°ƒé‡æ–°ç”Ÿæˆçš„è¯·æ±‚å‚æ•°

```kotlin
data class RefinementRequest(
    /**
     * åŸå§‹ç”¨æˆ·è¾“å…¥
     */
    val originalInput: String,
    
    /**
     * åŸå§‹ä»»åŠ¡ç±»å‹
     */
    val originalTask: ActionType,
    
    /**
     * AIä¸Šæ¬¡çš„å›å¤
     */
    val lastAiResponse: String,
    
    /**
     * ç”¨æˆ·çš„å¾®è°ƒæŒ‡ä»¤ï¼ˆå¯é€‰ï¼‰
     * ä¸ºç©ºè¡¨ç¤ºç›´æ¥é‡æ–°ç”Ÿæˆ
     */
    val refinementInstruction: String? = null,
    
    /**
     * è”ç³»äººID
     */
    val contactId: String
) {
    /**
     * æ˜¯å¦æœ‰å¾®è°ƒæŒ‡ä»¤
     */
    fun hasInstruction(): Boolean = !refinementInstruction.isNullOrBlank()
}
```


---

## ğŸ”§ UseCaseè®¾è®¡

### 1. PolishDraftUseCaseï¼ˆæ¶¦è‰²ç”¨ä¾‹ - æ–°å¢ï¼‰

**èŒè´£**ï¼šä¼˜åŒ–ç”¨æˆ·è‰ç¨¿ï¼Œä½¿è¡¨è¾¾æ›´å¾—ä½“

```kotlin
class PolishDraftUseCase @Inject constructor(
    private val contactRepository: ContactRepository,
    private val brainTagRepository: BrainTagRepository,
    private val privacyRepository: PrivacyRepository,
    private val aiRepository: AiRepository,
    private val settingsRepository: SettingsRepository,
    private val aiProviderRepository: AiProviderRepository,
    private val promptBuilder: PromptBuilder
) {
    /**
     * æ‰§è¡Œè‰ç¨¿æ¶¦è‰²
     *
     * @param contactId è”ç³»äººID
     * @param draftText ç”¨æˆ·è‰ç¨¿
     * @return æ¶¦è‰²ç»“æœ
     */
    suspend operator fun invoke(
        contactId: String,
        draftText: String
    ): Result<PolishResult> {
        return try {
            // 1. å‰ç½®æ£€æŸ¥
            val defaultProvider = aiProviderRepository.getDefaultProvider().getOrNull()
                ?: return Result.failure(IllegalStateException("æœªé…ç½®é»˜è®¤ AI æœåŠ¡å•†"))
            
            // 2. åŠ è½½è”ç³»äººæ•°æ®
            val profile = contactRepository.getProfile(contactId).getOrNull()
                ?: return Result.failure(IllegalStateException("æœªæ‰¾åˆ°è”ç³»äºº"))
            
            val brainTags = brainTagRepository.getTagsForContact(contactId).first()
            val redTags = brainTags.filter { it.type == TagType.RISK_RED }
            
            // 3. æ•°æ®è„±æ•
            val privacyMapping = privacyRepository.getPrivacyMapping().getOrElse { emptyMap() }
            val maskedDraft = PrivacyEngine.mask(draftText, privacyMapping)
            
            // 4. æ·»åŠ èº«ä»½å‰ç¼€
            val prefixedDraft = IdentityPrefixHelper.addPrefix(
                content = maskedDraft,
                actionType = ActionType.POLISH
            )
            
            // 5. æ„å»ºæç¤ºè¯
            val promptContext = PromptContext.fromContact(profile)
            val systemInstruction = promptBuilder.buildSystemInstruction(
                scene = PromptScene.POLISH,
                contactId = contactId,
                context = promptContext,
                runtimeData = buildRuntimeData(prefixedDraft, redTags)
            )
            
            // 6. è°ƒç”¨AI
            val result = aiRepository.polishDraft(
                provider = defaultProvider,
                draft = prefixedDraft,
                systemInstruction = systemInstruction
            ).getOrThrow()
            
            Result.success(result)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    private fun buildRuntimeData(draft: String, redTags: List<BrainTag>): String {
        return buildString {
            appendLine("ã€ç”¨æˆ·è‰ç¨¿ã€‘")
            appendLine(draft)
            appendLine()
            if (redTags.isNotEmpty()) {
                appendLine("ã€é›·åŒºè­¦å‘Šã€‘")
                redTags.forEach { appendLine("- ${it.content}") }
            }
        }
    }
}
```

### 2. GenerateReplyUseCaseï¼ˆå›å¤ç”¨ä¾‹ - æ–°å¢ï¼‰

**èŒè´£**ï¼šæ ¹æ®å¯¹æ–¹çš„è¯ç”Ÿæˆåˆé€‚çš„å›å¤

```kotlin
class GenerateReplyUseCase @Inject constructor(
    private val contactRepository: ContactRepository,
    private val brainTagRepository: BrainTagRepository,
    private val privacyRepository: PrivacyRepository,
    private val aiRepository: AiRepository,
    private val aiProviderRepository: AiProviderRepository,
    private val promptBuilder: PromptBuilder,
    private val conversationRepository: ConversationRepository
) {
    /**
     * ç”Ÿæˆå›å¤å»ºè®®
     *
     * @param contactId è”ç³»äººID
     * @param theirMessage å¯¹æ–¹è¯´çš„è¯
     * @return å›å¤ç»“æœ
     */
    suspend operator fun invoke(
        contactId: String,
        theirMessage: String
    ): Result<ReplyResult> {
        return try {
            // 1. å‰ç½®æ£€æŸ¥
            val defaultProvider = aiProviderRepository.getDefaultProvider().getOrNull()
                ?: return Result.failure(IllegalStateException("æœªé…ç½®é»˜è®¤ AI æœåŠ¡å•†"))
            
            // 2. åŠ è½½è”ç³»äººæ•°æ®
            val profile = contactRepository.getProfile(contactId).getOrNull()
                ?: return Result.failure(IllegalStateException("æœªæ‰¾åˆ°è”ç³»äºº"))
            
            val brainTags = brainTagRepository.getTagsForContact(contactId).first()
            val redTags = brainTags.filter { it.type == TagType.RISK_RED }
            val greenTags = brainTags.filter { it.type == TagType.STRATEGY_GREEN }
            
            // 3. æ•°æ®è„±æ•
            val privacyMapping = privacyRepository.getPrivacyMapping().getOrElse { emptyMap() }
            val maskedMessage = PrivacyEngine.mask(theirMessage, privacyMapping)
            
            // 4. æ·»åŠ èº«ä»½å‰ç¼€
            val prefixedMessage = IdentityPrefixHelper.addPrefix(
                content = maskedMessage,
                actionType = ActionType.REPLY
            )
            
            // 5. ä¿å­˜ç”¨æˆ·è¾“å…¥åˆ°å¯¹è¯è®°å½•
            conversationRepository.saveUserInput(contactId, prefixedMessage)
            
            // 6. æ„å»ºæç¤ºè¯
            val promptContext = PromptContext.fromContact(profile)
            val systemInstruction = promptBuilder.buildSystemInstruction(
                scene = PromptScene.REPLY,
                contactId = contactId,
                context = promptContext,
                runtimeData = buildRuntimeData(prefixedMessage, redTags, greenTags, profile)
            )
            
            // 7. è°ƒç”¨AI
            val result = aiRepository.generateReply(
                provider = defaultProvider,
                message = prefixedMessage,
                systemInstruction = systemInstruction
            ).getOrThrow()
            
            Result.success(result)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    private fun buildRuntimeData(
        message: String,
        redTags: List<BrainTag>,
        greenTags: List<BrainTag>,
        profile: ContactProfile
    ): String {
        return buildString {
            appendLine("ã€æ”»ç•¥ç›®æ ‡ã€‘")
            appendLine(profile.targetGoal)
            appendLine()
            appendLine("ã€å¯¹æ–¹æ¶ˆæ¯ã€‘")
            appendLine(message)
            appendLine()
            if (redTags.isNotEmpty()) {
                appendLine("ã€é›·åŒºè­¦å‘Šã€‘")
                redTags.forEach { appendLine("- ${it.content}") }
                appendLine()
            }
            if (greenTags.isNotEmpty()) {
                appendLine("ã€ç­–ç•¥å»ºè®®ã€‘")
                greenTags.forEach { appendLine("- ${it.content}") }
            }
        }
    }
}
```

### 3. RefinementUseCaseï¼ˆå¾®è°ƒç”¨ä¾‹ - æ–°å¢ï¼‰

**èŒè´£**ï¼šæ ¹æ®ç”¨æˆ·åé¦ˆé‡æ–°ç”ŸæˆAIç»“æœ

```kotlin
class RefinementUseCase @Inject constructor(
    private val analyzeChatUseCase: AnalyzeChatUseCase,
    private val polishDraftUseCase: PolishDraftUseCase,
    private val generateReplyUseCase: GenerateReplyUseCase,
    private val aiRepository: AiRepository,
    private val aiProviderRepository: AiProviderRepository
) {
    /**
     * æ‰§è¡Œå¾®è°ƒé‡æ–°ç”Ÿæˆ
     *
     * @param request å¾®è°ƒè¯·æ±‚
     * @return AIç»“æœ
     */
    suspend operator fun invoke(request: RefinementRequest): Result<AiResult> {
        return try {
            if (request.hasInstruction()) {
                // æœ‰å¾®è°ƒæŒ‡ä»¤ï¼Œä½¿ç”¨ç‰¹æ®Šçš„å¾®è°ƒæç¤ºè¯
                refineWithInstruction(request)
            } else {
                // æ— å¾®è°ƒæŒ‡ä»¤ï¼Œç›´æ¥é‡æ–°è°ƒç”¨åŸUseCase
                regenerateDirectly(request)
            }
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    /**
     * å¸¦å¾®è°ƒæŒ‡ä»¤çš„é‡æ–°ç”Ÿæˆ
     */
    private suspend fun refineWithInstruction(
        request: RefinementRequest
    ): Result<AiResult> {
        val defaultProvider = aiProviderRepository.getDefaultProvider().getOrNull()
            ?: return Result.failure(IllegalStateException("æœªé…ç½®é»˜è®¤ AI æœåŠ¡å•†"))
        
        // æ„å»ºå¾®è°ƒæç¤ºè¯
        val refinementPrompt = buildRefinementPrompt(request)
        
        // æ ¹æ®åŸä»»åŠ¡ç±»å‹è°ƒç”¨å¯¹åº”çš„AIæ¥å£
        return when (request.originalTask) {
            ActionType.ANALYZE -> {
                val result = aiRepository.refineAnalysis(
                    provider = defaultProvider,
                    refinementPrompt = refinementPrompt
                ).getOrThrow()
                Result.success(AiResult.Analysis(result))
            }
            ActionType.POLISH -> {
                val result = aiRepository.refinePolish(
                    provider = defaultProvider,
                    refinementPrompt = refinementPrompt
                ).getOrThrow()
                Result.success(AiResult.Polish(result))
            }
            ActionType.REPLY -> {
                val result = aiRepository.refineReply(
                    provider = defaultProvider,
                    refinementPrompt = refinementPrompt
                ).getOrThrow()
                Result.success(AiResult.Reply(result))
            }
        }
    }
    
    /**
     * ç›´æ¥é‡æ–°ç”Ÿæˆï¼ˆä¸å¸¦å¾®è°ƒæŒ‡ä»¤ï¼‰
     */
    private suspend fun regenerateDirectly(
        request: RefinementRequest
    ): Result<AiResult> {
        return when (request.originalTask) {
            ActionType.ANALYZE -> {
                val result = analyzeChatUseCase(
                    request.contactId,
                    listOf(request.originalInput)
                ).getOrThrow()
                Result.success(AiResult.Analysis(result))
            }
            ActionType.POLISH -> {
                val result = polishDraftUseCase(
                    request.contactId,
                    request.originalInput
                ).getOrThrow()
                Result.success(AiResult.Polish(result))
            }
            ActionType.REPLY -> {
                val result = generateReplyUseCase(
                    request.contactId,
                    request.originalInput
                ).getOrThrow()
                Result.success(AiResult.Reply(result))
            }
        }
    }
    
    /**
     * æ„å»ºå¾®è°ƒæç¤ºè¯
     */
    private fun buildRefinementPrompt(request: RefinementRequest): String {
        return buildString {
            appendLine("ç”¨æˆ·å¯¹ä¸Šä¸€æ¬¡çš„ç”Ÿæˆç»“æœä¸æ»¡æ„ã€‚")
            appendLine()
            appendLine("ã€åŸå§‹è¾“å…¥ã€‘")
            appendLine(request.originalInput)
            appendLine()
            appendLine("ã€ä¸Šæ¬¡çš„ç»“æœã€‘")
            appendLine(request.lastAiResponse)
            appendLine()
            appendLine("ã€ç”¨æˆ·çš„ä¿®æ”¹æ„è§ã€‘")
            appendLine(request.refinementInstruction)
            appendLine()
            appendLine("è¯·åŸºäºç”¨æˆ·çš„æ„è§é‡æ–°ç”Ÿæˆï¼Œä¸è¦è§£é‡Šï¼Œç›´æ¥è¾“å‡ºæ–°çš„ç»“æœã€‚")
        }
    }
}
```


---

## ğŸ“ æç¤ºè¯è®¾è®¡

### 1. PromptSceneæ‰©å±•

åœ¨ç°æœ‰çš„`PromptScene`æšä¸¾ä¸­æ–°å¢ä¸¤ä¸ªåœºæ™¯ï¼š

```kotlin
enum class PromptScene {
    ANALYZE,   // å·²æœ‰ï¼šèŠå¤©åˆ†æ
    CHECK,     // å·²æœ‰ï¼šå®‰å…¨æ£€æŸ¥ï¼ˆå°†é€æ­¥åºŸå¼ƒï¼‰
    EXTRACT,   // å·²æœ‰ï¼šä¿¡æ¯æå–
    SUMMARY,   // å·²æœ‰ï¼šæ¯æ—¥æ€»ç»“
    POLISH,    // æ–°å¢ï¼šæ¶¦è‰²åœºæ™¯
    REPLY      // æ–°å¢ï¼šå›å¤åœºæ™¯
}
```

### 2. æ¶¦è‰²åœºæ™¯æç¤ºè¯ï¼ˆPOLISHï¼‰

```kotlin
// SystemPrompts.kt ä¸­æ–°å¢

private const val POLISH_HEADER = """ä½ æ˜¯ç”¨æˆ·çš„"é«˜æƒ…å•†å˜´æ›¿"ã€‚

ã€ä½ çš„äººè®¾ã€‘
ä½ æ˜¯ä¸€ä¸ªæƒ…å•†å¾ˆé«˜çš„æœ‹å‹ï¼Œå¸®ç”¨æˆ·æŠŠè¯è¯´å¾—æ›´å¥½å¬ã€æ›´å¾—ä½“ã€‚
è¯´è¯ç›´æ¥ï¼Œæ”¹å®Œå°±ç»™ç»“æœï¼Œåˆ«å•°å—¦ã€‚

ã€èº«ä»½è¯†åˆ«ã€‘
- ã€æˆ‘æ­£åœ¨å›å¤ã€‘å¼€å¤´ = ç”¨æˆ·æ‰“ç®—å‘é€çš„è‰ç¨¿ï¼Œä½ è¦å¸®ç”¨æˆ·ä¼˜åŒ–è¡¨è¾¾

ã€ä½ çš„ä»»åŠ¡ã€‘
1. æ£€æŸ¥è‰ç¨¿æœ‰æ²¡æœ‰è¸©é›·çš„åœ°æ–¹
2. ä¼˜åŒ–è¡¨è¾¾ï¼Œè®©è¯è¯´å¾—æ›´å¾—ä½“
3. ä¿æŒç”¨æˆ·çš„åŸæ„ï¼Œä¸è¦æ”¹å˜æ ¸å¿ƒå†…å®¹

ã€è¾“å‡ºè¦æ±‚ã€‘
- ç›´æ¥è¾“å‡ºä¼˜åŒ–åçš„æ–‡æœ¬
- å¦‚æœæœ‰é£é™©ï¼Œåœ¨æœ€åç®€å•æä¸€å¥
- ä¸è¦è§£é‡Šä¸ºä»€ä¹ˆè¿™æ ·æ”¹"""

private const val POLISH_FOOTER = """è¯·ä»¥JSONæ ¼å¼è¿”å›ç»“æœï¼š
{
  "polishedText": "ä¼˜åŒ–åçš„æ–‡æœ¬",
  "hasRisk": false,
  "riskWarning": null
}

ã€å­—æ®µè¯´æ˜ã€‘
- polishedText: ä¼˜åŒ–åå¯ç›´æ¥ä½¿ç”¨çš„æ–‡æœ¬
- hasRisk: æ˜¯å¦æ£€æµ‹åˆ°é£é™©ï¼ˆtrue/falseï¼‰
- riskWarning: é£é™©æç¤ºï¼ˆæ²¡æœ‰é£é™©åˆ™ä¸ºnullï¼‰

ã€ç¦æ­¢äº‹é¡¹ã€‘
- ç¦æ­¢è¿”å›Markdownæ ¼å¼
- ç¦æ­¢åœ¨JSONå‰åæ·»åŠ ä»»ä½•æ–‡å­—"""
```

### 3. å›å¤åœºæ™¯æç¤ºè¯ï¼ˆREPLYï¼‰

```kotlin
private const val REPLY_HEADER = """ä½ æ˜¯ç”¨æˆ·çš„"ç¥å›å¤ç”Ÿæˆå™¨"ã€‚

ã€ä½ çš„äººè®¾ã€‘
ä½ æ˜¯ä¸€ä¸ªé˜…äººæ— æ•°çš„è€å¸æœºï¼Œèƒ½æ ¹æ®å¯¹æ–¹çš„è¯ï¼Œç»™å‡ºæœ€åˆé€‚çš„å›å¤ã€‚
è¯´è¯ç›´æ¥ï¼Œç»™å®Œå›å¤ç®€å•è¯´ä¸€å¥ä¸ºä»€ä¹ˆè¿™æ ·å›å°±è¡Œã€‚

ã€èº«ä»½è¯†åˆ«ã€‘
- ã€å¯¹æ–¹è¯´ã€‘å¼€å¤´ = å¯¹æ–¹å‘ç»™ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œä½ è¦å¸®ç”¨æˆ·ç”Ÿæˆå›å¤

ã€ä½ çš„ä»»åŠ¡ã€‘
1. ç†è§£å¯¹æ–¹è¯é‡Œçš„æƒ…ç»ªå’Œæ„å›¾
2. ç»“åˆè”ç³»äººç”»åƒï¼Œç”Ÿæˆåˆé€‚çš„å›å¤
3. å›å¤è¦è‡ªç„¶ï¼Œåƒç”¨æˆ·è‡ªå·±è¯´çš„è¯

ã€è¾“å‡ºè¦æ±‚ã€‘
- ç›´æ¥ç»™å‡ºå¯ä»¥å‘é€çš„å›å¤
- ç®€å•è¯´ä¸€å¥ä¸ºä»€ä¹ˆè¿™æ ·å›å¤
- å›å¤è¦ç¬¦åˆç”¨æˆ·å’Œå¯¹æ–¹çš„å…³ç³»"""

private const val REPLY_FOOTER = """è¯·ä»¥JSONæ ¼å¼è¿”å›ç»“æœï¼š
{
  "suggestedReply": "å»ºè®®çš„å›å¤å†…å®¹",
  "strategyNote": "ç®€çŸ­çš„ç­–ç•¥è¯´æ˜"
}

ã€å­—æ®µè¯´æ˜ã€‘
- suggestedReply: å¯ç›´æ¥å¤åˆ¶å‘é€çš„å›å¤
- strategyNote: ä¸€å¥è¯è¯´æ˜ä¸ºä»€ä¹ˆè¿™æ ·å›å¤

ã€ç¦æ­¢äº‹é¡¹ã€‘
- ç¦æ­¢è¿”å›Markdownæ ¼å¼
- ç¦æ­¢åœ¨JSONå‰åæ·»åŠ ä»»ä½•æ–‡å­—"""
```

### 4. å¾®è°ƒåœºæ™¯æç¤ºè¯è¡¥å……

```kotlin
/**
 * æ„å»ºå¾®è°ƒæç¤ºè¯çš„ç³»ç»ŸæŒ‡ä»¤
 */
fun buildRefinementInstruction(
    originalTask: ActionType,
    lastResponse: String,
    instruction: String
): String {
    val taskName = when (originalTask) {
        ActionType.ANALYZE -> "åˆ†æ"
        ActionType.POLISH -> "æ¶¦è‰²"
        ActionType.REPLY -> "å›å¤"
    }
    
    return """ç”¨æˆ·å¯¹ä¸Šä¸€æ¬¡çš„${taskName}ç»“æœä¸æ»¡æ„ã€‚

ã€ä¸Šæ¬¡çš„ç»“æœã€‘
$lastResponse

ã€ç”¨æˆ·çš„ä¿®æ”¹æ„è§ã€‘
$instruction

è¯·åŸºäºç”¨æˆ·çš„æ„è§é‡æ–°ç”Ÿæˆï¼Œä¸è¦è§£é‡Šï¼Œç›´æ¥è¾“å‡ºæ–°çš„ç»“æœã€‚
è¾“å‡ºæ ¼å¼ä¸ä¸Šæ¬¡ç›¸åŒã€‚"""
}
```


---

## ğŸ¨ UIç»„ä»¶è®¾è®¡

### 1. æ•´ä½“å¸ƒå±€ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           FloatingInputDialog            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         TabSwitcher                 â”‚â”‚  â† ä¸‰Tabåˆ‡æ¢
â”‚  â”‚  [ğŸ”åˆ†æ] [âœï¸æ¶¦è‰²] [ğŸ’¬å›å¤]        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚       ContactSelector               â”‚â”‚  â† è”ç³»äººé€‰æ‹©
â”‚  â”‚  è”ç³»äºº: [å°çº¢ â–¼]                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         InputSection                â”‚â”‚  â† è¾“å…¥åŒºåŸŸ
â”‚  â”‚  (è¾“å…¥æ¡† æˆ– ç»“æœå±•ç¤º)               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         ActionBar                   â”‚â”‚  â† æ“ä½œæŒ‰é’®
â”‚  â”‚  [å…³é—­] [æœ€å°åŒ–] [å‘é€/å¤åˆ¶/é‡æ–°ç”Ÿæˆ]â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. TabSwitcherç»„ä»¶

**èŒè´£**ï¼šæä¾›ä¸‰ä¸ªåŠŸèƒ½Tabçš„åˆ‡æ¢

```xml
<!-- res/layout/floating_tab_switcher.xml -->
<com.google.android.material.tabs.TabLayout
    android:id="@+id/tab_layout"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    app:tabMode="fixed"
    app:tabGravity="fill"
    app:tabIndicatorColor="@color/primary"
    app:tabSelectedTextColor="@color/primary"
    app:tabTextColor="@color/on_surface_variant">
    
    <com.google.android.material.tabs.TabItem
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="ğŸ” åˆ†æ" />
    
    <com.google.android.material.tabs.TabItem
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="âœï¸ æ¶¦è‰²" />
    
    <com.google.android.material.tabs.TabItem
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="ğŸ’¬ å›å¤" />
        
</com.google.android.material.tabs.TabLayout>
```

**Kotlinå®ç°**ï¼š

```kotlin
class TabSwitcher(context: Context) : FrameLayout(context) {
    
    private var tabLayout: TabLayout
    var onTabSelected: ((ActionType) -> Unit)? = null
    
    init {
        LayoutInflater.from(context).inflate(
            R.layout.floating_tab_switcher, this, true
        )
        tabLayout = findViewById(R.id.tab_layout)
        
        tabLayout.addOnTabSelectedListener(object : TabLayout.OnTabSelectedListener {
            override fun onTabSelected(tab: TabLayout.Tab?) {
                val actionType = when (tab?.position) {
                    0 -> ActionType.ANALYZE
                    1 -> ActionType.POLISH
                    2 -> ActionType.REPLY
                    else -> ActionType.ANALYZE
                }
                onTabSelected?.invoke(actionType)
            }
            override fun onTabUnselected(tab: TabLayout.Tab?) {}
            override fun onTabReselected(tab: TabLayout.Tab?) {}
        })
    }
    
    /**
     * è®¾ç½®å½“å‰é€‰ä¸­çš„Tab
     */
    fun setSelectedTab(actionType: ActionType) {
        val position = when (actionType) {
            ActionType.ANALYZE -> 0
            ActionType.POLISH -> 1
            ActionType.REPLY -> 2
        }
        tabLayout.getTabAt(position)?.select()
    }
    
    /**
     * è·å–å½“å‰é€‰ä¸­çš„Tab
     */
    fun getSelectedTab(): ActionType {
        return when (tabLayout.selectedTabPosition) {
            0 -> ActionType.ANALYZE
            1 -> ActionType.POLISH
            2 -> ActionType.REPLY
            else -> ActionType.ANALYZE
        }
    }
}
```

### 3. ResultCardç»„ä»¶

**èŒè´£**ï¼šå±•ç¤ºAIè¿”å›çš„ç»“æœ

```kotlin
class ResultCard(context: Context) : FrameLayout(context) {
    
    private var titleText: TextView
    private var contentText: TextView
    private var copyButton: MaterialButton
    private var regenerateButton: MaterialButton
    
    var onCopyClick: (() -> Unit)? = null
    var onRegenerateClick: (() -> Unit)? = null
    
    init {
        LayoutInflater.from(context).inflate(
            R.layout.floating_result_card, this, true
        )
        
        titleText = findViewById(R.id.result_title)
        contentText = findViewById(R.id.result_content)
        copyButton = findViewById(R.id.btn_copy)
        regenerateButton = findViewById(R.id.btn_regenerate)
        
        copyButton.setOnClickListener { onCopyClick?.invoke() }
        regenerateButton.setOnClickListener { onRegenerateClick?.invoke() }
    }
    
    /**
     * æ˜¾ç¤ºåˆ†æç»“æœ
     */
    fun showAnalysisResult(result: AnalysisResult) {
        titleText.text = "ğŸ” åˆ†æç»“æœ"
        contentText.text = buildString {
            appendLine("ã€å†›å¸ˆåˆ†æã€‘")
            appendLine(result.strategyAnalysis)
            appendLine()
            appendLine("ã€è¯æœ¯å»ºè®®ã€‘")
            appendLine(result.replySuggestion)
        }
        // æ ¹æ®é£é™©ç­‰çº§è®¾ç½®èƒŒæ™¯è‰²
        setBackgroundByRiskLevel(result.riskLevel)
    }
    
    /**
     * æ˜¾ç¤ºæ¶¦è‰²ç»“æœ
     */
    fun showPolishResult(result: PolishResult) {
        titleText.text = "âœï¸ æ¶¦è‰²ç»“æœ"
        contentText.text = result.getDisplayContent()
        if (result.hasRisk) {
            setBackgroundColor(context.getColor(R.color.warning_background))
        } else {
            setBackgroundColor(context.getColor(R.color.surface))
        }
    }
    
    /**
     * æ˜¾ç¤ºå›å¤ç»“æœ
     */
    fun showReplyResult(result: ReplyResult) {
        titleText.text = "ğŸ’¬ å›å¤å»ºè®®"
        contentText.text = result.getDisplayContent()
        setBackgroundColor(context.getColor(R.color.surface))
    }
    
    private fun setBackgroundByRiskLevel(riskLevel: RiskLevel) {
        val color = when (riskLevel) {
            RiskLevel.SAFE -> R.color.safe_background
            RiskLevel.WARNING -> R.color.warning_background
            RiskLevel.DANGER -> R.color.danger_background
        }
        setBackgroundColor(context.getColor(color))
    }
}
```

### 4. RefinementDialogç»„ä»¶

**èŒè´£**ï¼šå¾®è°ƒé‡æ–°ç”Ÿæˆçš„å¯¹è¯æ¡†

```kotlin
class RefinementDialog(context: Context) : AlertDialog(context) {
    
    private var instructionInput: EditText
    private var directButton: MaterialButton
    private var withInstructionButton: MaterialButton
    
    var onDirectRegenerate: (() -> Unit)? = null
    var onRegenerateWithInstruction: ((String) -> Unit)? = null
    
    init {
        val view = LayoutInflater.from(context).inflate(
            R.layout.dialog_refinement, null
        )
        setView(view)
        
        setTitle("éœ€è¦è°ƒæ•´æ–¹å‘å—ï¼Ÿ")
        
        instructionInput = view.findViewById(R.id.instruction_input)
        directButton = view.findViewById(R.id.btn_direct)
        withInstructionButton = view.findViewById(R.id.btn_with_instruction)
        
        instructionInput.hint = "ä¾‹å¦‚ï¼šå¼ºç¡¬ä¸€ç‚¹ã€å¹½é»˜ä¸€ç‚¹ã€ç®€çŸ­ç‚¹..."
        
        directButton.text = "ç›´æ¥é‡æ–°ç”Ÿæˆ"
        directButton.setOnClickListener {
            onDirectRegenerate?.invoke()
            dismiss()
        }
        
        withInstructionButton.text = "æŒ‰æ–¹å‘ç”Ÿæˆ"
        withInstructionButton.setOnClickListener {
            val instruction = instructionInput.text.toString()
            if (instruction.isNotBlank()) {
                onRegenerateWithInstruction?.invoke(instruction)
                dismiss()
            } else {
                instructionInput.error = "è¯·è¾“å…¥è°ƒæ•´æ–¹å‘"
            }
        }
    }
    
    companion object {
        fun show(
            context: Context,
            onDirect: () -> Unit,
            onWithInstruction: (String) -> Unit
        ) {
            RefinementDialog(context).apply {
                onDirectRegenerate = onDirect
                onRegenerateWithInstruction = onWithInstruction
                show()
            }
        }
    }
}
```


---

## ğŸ’¾ çŠ¶æ€ç®¡ç†è®¾è®¡

### 1. FloatingWindowPreferencesæ‰©å±•

**èŒè´£**ï¼šæŒä¹…åŒ–æ‚¬æµ®çª—çŠ¶æ€ï¼Œæ”¯æŒçŠ¶æ€ä¿æŒå’Œæ¢å¤

```kotlin
@Singleton
class FloatingWindowPreferences @Inject constructor(
    @ApplicationContext private val context: Context
) {
    private val prefs = context.getSharedPreferences(
        "floating_window_prefs", Context.MODE_PRIVATE
    )
    
    companion object {
        // å·²æœ‰çš„é”®
        private const val KEY_ENABLED = "enabled"
        private const val KEY_BUTTON_X = "button_x"
        private const val KEY_BUTTON_Y = "button_y"
        
        // æ–°å¢çš„é”® - çŠ¶æ€ä¿æŒ
        private const val KEY_SELECTED_TAB = "selected_tab"
        private const val KEY_LAST_CONTACT_ID = "last_contact_id"
        private const val KEY_SAVED_INPUT_TEXT = "saved_input_text"
        private const val KEY_HAS_SAVED_STATE = "has_saved_state"
    }
    
    // ==================== å·²æœ‰æ–¹æ³• ====================
    
    fun isEnabled(): Boolean = prefs.getBoolean(KEY_ENABLED, false)
    fun setEnabled(enabled: Boolean) {
        prefs.edit().putBoolean(KEY_ENABLED, enabled).apply()
    }
    
    fun getButtonX(): Int = prefs.getInt(KEY_BUTTON_X, 0)
    fun getButtonY(): Int = prefs.getInt(KEY_BUTTON_Y, 100)
    fun saveButtonPosition(x: Int, y: Int) {
        prefs.edit()
            .putInt(KEY_BUTTON_X, x)
            .putInt(KEY_BUTTON_Y, y)
            .apply()
    }
    
    // ==================== æ–°å¢æ–¹æ³• - Tabè®°å¿† ====================
    
    /**
     * è·å–ä¸Šæ¬¡é€‰ä¸­çš„Tab
     */
    fun getSelectedTab(): ActionType {
        val ordinal = prefs.getInt(KEY_SELECTED_TAB, ActionType.ANALYZE.ordinal)
        return ActionType.values().getOrElse(ordinal) { ActionType.ANALYZE }
    }
    
    /**
     * ä¿å­˜é€‰ä¸­çš„Tab
     */
    fun saveSelectedTab(tab: ActionType) {
        prefs.edit().putInt(KEY_SELECTED_TAB, tab.ordinal).apply()
    }
    
    // ==================== æ–°å¢æ–¹æ³• - è”ç³»äººè®°å¿† ====================
    
    /**
     * è·å–ä¸Šæ¬¡å¯¹è¯çš„è”ç³»äººID
     */
    fun getLastContactId(): String? {
        return prefs.getString(KEY_LAST_CONTACT_ID, null)
    }
    
    /**
     * ä¿å­˜ä¸Šæ¬¡å¯¹è¯çš„è”ç³»äººID
     */
    fun saveLastContactId(contactId: String) {
        prefs.edit().putString(KEY_LAST_CONTACT_ID, contactId).apply()
    }
    
    // ==================== æ–°å¢æ–¹æ³• - çŠ¶æ€ä¿æŒ ====================
    
    /**
     * ä¿å­˜æ‚¬æµ®çª—çŠ¶æ€ï¼ˆæœ€å°åŒ–æ—¶è°ƒç”¨ï¼‰
     */
    fun saveState(state: FloatingWindowState) {
        prefs.edit()
            .putInt(KEY_SELECTED_TAB, state.selectedTab.ordinal)
            .putString(KEY_LAST_CONTACT_ID, state.selectedContactId)
            .putString(KEY_SAVED_INPUT_TEXT, state.inputText)
            .putBoolean(KEY_HAS_SAVED_STATE, true)
            .apply()
    }
    
    /**
     * æ¢å¤æ‚¬æµ®çª—çŠ¶æ€ï¼ˆä»æœ€å°åŒ–æ¢å¤æ—¶è°ƒç”¨ï¼‰
     */
    fun restoreState(): FloatingWindowState? {
        if (!prefs.getBoolean(KEY_HAS_SAVED_STATE, false)) {
            return null
        }
        
        val tabOrdinal = prefs.getInt(KEY_SELECTED_TAB, ActionType.ANALYZE.ordinal)
        val tab = ActionType.values().getOrElse(tabOrdinal) { ActionType.ANALYZE }
        
        return FloatingWindowState(
            selectedTab = tab,
            selectedContactId = prefs.getString(KEY_LAST_CONTACT_ID, null),
            inputText = prefs.getString(KEY_SAVED_INPUT_TEXT, "") ?: ""
        )
    }
    
    /**
     * æ¸…é™¤ä¿å­˜çš„çŠ¶æ€ï¼ˆå…³é—­æ—¶è°ƒç”¨ï¼‰
     */
    fun clearSavedState() {
        prefs.edit()
            .remove(KEY_SAVED_INPUT_TEXT)
            .putBoolean(KEY_HAS_SAVED_STATE, false)
            .apply()
    }
    
    /**
     * æ˜¯å¦æœ‰ä¿å­˜çš„çŠ¶æ€
     */
    fun hasSavedState(): Boolean {
        return prefs.getBoolean(KEY_HAS_SAVED_STATE, false)
    }
}
```

### 2. çŠ¶æ€æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      çŠ¶æ€æµè½¬å›¾                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æŒ‰é’®æ€   â”‚ â† åˆå§‹çŠ¶æ€
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚ ç‚¹å‡»æŒ‰é’®
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  è¾“å…¥æ€   â”‚ â† æ˜¾ç¤ºTab + è¾“å…¥æ¡†
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚            â”‚            â”‚
    â–¼         â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…³é—­ â”‚ â”‚æœ€å°åŒ–â”‚    â”‚  å‘é€    â”‚  â”‚ Tabåˆ‡æ¢  â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚        â”‚             â”‚             â”‚
   â”‚        â”‚             â–¼             â”‚
   â”‚        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   â”‚        â”‚        â”‚  åŠ è½½æ€   â”‚       â”‚
   â”‚        â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚
   â”‚        â”‚             â”‚             â”‚
   â”‚        â”‚             â–¼             â”‚
   â”‚        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   â”‚        â”‚        â”‚  ç»“æœæ€   â”‚       â”‚
   â”‚        â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚
   â”‚        â”‚             â”‚             â”‚
   â”‚        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
   â”‚        â”‚    â”‚                 â”‚    â”‚
   â”‚        â”‚    â–¼                 â–¼    â”‚
   â”‚        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
   â”‚        â”‚ â”‚ å¤åˆ¶ â”‚      â”‚é‡æ–°ç”Ÿæˆ  â”‚â”‚
   â”‚        â”‚ â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜â”‚
   â”‚        â”‚                    â”‚      â”‚
   â”‚        â”‚                    â–¼      â”‚
   â”‚        â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚        â”‚              â”‚å¾®è°ƒå¯¹è¯æ¡†â”‚ â”‚
   â”‚        â”‚              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
   â”‚        â”‚                   â”‚       â”‚
   â”‚        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚        â”‚         â”‚                 â”‚
   â”‚        â”‚         â–¼                 â–¼
   â”‚        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚        â”‚    â”‚ç›´æ¥é‡æ–°  â”‚    â”‚æŒ‰æ–¹å‘ç”Ÿæˆâ”‚
   â”‚        â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚        â”‚         â”‚               â”‚
   â”‚        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚        â”‚                 â”‚
   â”‚        â”‚                 â–¼
   â”‚        â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚        â”‚           â”‚  åŠ è½½æ€   â”‚ â†’ å¾ªç¯å›ç»“æœæ€
   â”‚        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚        â”‚
   â”‚        â–¼
   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   â”‚ æœ€å°åŒ–æ€  â”‚ â† ä¿å­˜çŠ¶æ€
   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚        â”‚ ç‚¹å‡»æŒ‡ç¤ºå™¨
   â”‚        â–¼
   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   â”‚  è¾“å…¥æ€   â”‚ â† æ¢å¤çŠ¶æ€
   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŒ‰é’®æ€   â”‚ â† æ¸…ç©ºçŠ¶æ€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. çŠ¶æ€ä¿æŒé€»è¾‘

```kotlin
// FloatingWindowService.kt ä¸­çš„çŠ¶æ€ç®¡ç†

class FloatingWindowService : Service() {
    
    @Inject
    lateinit var preferences: FloatingWindowPreferences
    
    private var currentState = FloatingWindowState()
    
    /**
     * å¤„ç†æœ€å°åŒ–
     */
    private fun handleMinimize() {
        // ä¿å­˜å½“å‰çŠ¶æ€
        preferences.saveState(currentState)
        
        // æ˜¾ç¤ºæœ€å°åŒ–æŒ‡ç¤ºå™¨
        floatingView?.minimizeDialog()
    }
    
    /**
     * å¤„ç†ä»æœ€å°åŒ–æ¢å¤
     */
    private fun handleRestore() {
        // æ¢å¤ä¿å­˜çš„çŠ¶æ€
        val savedState = preferences.restoreState()
        if (savedState != null) {
            currentState = savedState
            floatingView?.restoreState(savedState)
        }
    }
    
    /**
     * å¤„ç†å…³é—­
     */
    private fun handleClose() {
        // æ¸…ç©ºä¿å­˜çš„çŠ¶æ€
        preferences.clearSavedState()
        currentState = FloatingWindowState()
        
        // éšè—è¾“å…¥å¯¹è¯æ¡†
        floatingView?.hideInputDialog()
    }
    
    /**
     * å¤„ç†Tabåˆ‡æ¢
     */
    private fun handleTabChange(newTab: ActionType) {
        // æ›´æ–°çŠ¶æ€ï¼ˆä¿ç•™è¾“å…¥å†…å®¹ï¼‰
        currentState = currentState.copy(
            selectedTab = newTab,
            lastResult = null  // åˆ‡æ¢Tabæ—¶æ¸…ç©ºç»“æœ
        )
        
        // ä¿å­˜Tabé€‰æ‹©
        preferences.saveSelectedTab(newTab)
    }
    
    /**
     * å¤„ç†å‘é€æˆåŠŸ
     */
    private fun handleSendSuccess(contactId: String) {
        // ä¿å­˜è”ç³»äººID
        preferences.saveLastContactId(contactId)
    }
}
```


---

## ğŸ”Œ ä¸ç°æœ‰ä»£ç çš„é›†æˆ

### 1. AiRepositoryæ¥å£æ‰©å±•

```kotlin
interface AiRepository {
    // ==================== å·²æœ‰æ–¹æ³• ====================
    
    suspend fun analyzeChat(
        provider: AiProvider,
        promptContext: String,
        systemInstruction: String
    ): Result<AnalysisResult>
    
    suspend fun checkDraftSafety(
        provider: AiProvider,
        draft: String,
        riskRules: List<String>,
        systemInstruction: String
    ): Result<SafetyCheckResult>
    
    // ==================== æ–°å¢æ–¹æ³• ====================
    
    /**
     * æ¶¦è‰²è‰ç¨¿
     */
    suspend fun polishDraft(
        provider: AiProvider,
        draft: String,
        systemInstruction: String
    ): Result<PolishResult>
    
    /**
     * ç”Ÿæˆå›å¤
     */
    suspend fun generateReply(
        provider: AiProvider,
        message: String,
        systemInstruction: String
    ): Result<ReplyResult>
    
    /**
     * å¾®è°ƒåˆ†æç»“æœ
     */
    suspend fun refineAnalysis(
        provider: AiProvider,
        refinementPrompt: String
    ): Result<AnalysisResult>
    
    /**
     * å¾®è°ƒæ¶¦è‰²ç»“æœ
     */
    suspend fun refinePolish(
        provider: AiProvider,
        refinementPrompt: String
    ): Result<PolishResult>
    
    /**
     * å¾®è°ƒå›å¤ç»“æœ
     */
    suspend fun refineReply(
        provider: AiProvider,
        refinementPrompt: String
    ): Result<ReplyResult>
}
```

### 2. AiRepositoryImplå®ç°

```kotlin
class AiRepositoryImpl @Inject constructor(
    private val openAiApi: OpenAiApi,
    private val moshi: Moshi
) : AiRepository {
    
    // ... å·²æœ‰å®ç° ...
    
    override suspend fun polishDraft(
        provider: AiProvider,
        draft: String,
        systemInstruction: String
    ): Result<PolishResult> = withContext(Dispatchers.IO) {
        try {
            val response = callAi(provider, systemInstruction, draft)
            val result = parsePolishResult(response)
            Result.success(result)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun generateReply(
        provider: AiProvider,
        message: String,
        systemInstruction: String
    ): Result<ReplyResult> = withContext(Dispatchers.IO) {
        try {
            val response = callAi(provider, systemInstruction, message)
            val result = parseReplyResult(response)
            Result.success(result)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    private fun parsePolishResult(response: String): PolishResult {
        val cleanedJson = AiResponseCleaner.clean(response)
        val adapter = moshi.adapter(PolishResult::class.java)
        return adapter.fromJson(cleanedJson)
            ?: throw IllegalStateException("è§£ææ¶¦è‰²ç»“æœå¤±è´¥")
    }
    
    private fun parseReplyResult(response: String): ReplyResult {
        val cleanedJson = AiResponseCleaner.clean(response)
        val adapter = moshi.adapter(ReplyResult::class.java)
        return adapter.fromJson(cleanedJson)
            ?: throw IllegalStateException("è§£æå›å¤ç»“æœå¤±è´¥")
    }
}
```

### 3. Hiltä¾èµ–æ³¨å…¥

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object FloatingWindowModule {
    
    @Provides
    @Singleton
    fun providePolishDraftUseCase(
        contactRepository: ContactRepository,
        brainTagRepository: BrainTagRepository,
        privacyRepository: PrivacyRepository,
        aiRepository: AiRepository,
        settingsRepository: SettingsRepository,
        aiProviderRepository: AiProviderRepository,
        promptBuilder: PromptBuilder
    ): PolishDraftUseCase {
        return PolishDraftUseCase(
            contactRepository,
            brainTagRepository,
            privacyRepository,
            aiRepository,
            settingsRepository,
            aiProviderRepository,
            promptBuilder
        )
    }
    
    @Provides
    @Singleton
    fun provideGenerateReplyUseCase(
        contactRepository: ContactRepository,
        brainTagRepository: BrainTagRepository,
        privacyRepository: PrivacyRepository,
        aiRepository: AiRepository,
        aiProviderRepository: AiProviderRepository,
        promptBuilder: PromptBuilder,
        conversationRepository: ConversationRepository
    ): GenerateReplyUseCase {
        return GenerateReplyUseCase(
            contactRepository,
            brainTagRepository,
            privacyRepository,
            aiRepository,
            aiProviderRepository,
            promptBuilder,
            conversationRepository
        )
    }
    
    @Provides
    @Singleton
    fun provideRefinementUseCase(
        analyzeChatUseCase: AnalyzeChatUseCase,
        polishDraftUseCase: PolishDraftUseCase,
        generateReplyUseCase: GenerateReplyUseCase,
        aiRepository: AiRepository,
        aiProviderRepository: AiProviderRepository
    ): RefinementUseCase {
        return RefinementUseCase(
            analyzeChatUseCase,
            polishDraftUseCase,
            generateReplyUseCase,
            aiRepository,
            aiProviderRepository
        )
    }
}
```

### 4. FloatingWindowServiceé‡æ„

```kotlin
@AndroidEntryPoint
class FloatingWindowService : Service() {
    
    @Inject lateinit var analyzeChatUseCase: AnalyzeChatUseCase
    @Inject lateinit var polishDraftUseCase: PolishDraftUseCase      // æ–°å¢
    @Inject lateinit var generateReplyUseCase: GenerateReplyUseCase  // æ–°å¢
    @Inject lateinit var refinementUseCase: RefinementUseCase        // æ–°å¢
    @Inject lateinit var contactRepository: ContactRepository
    @Inject lateinit var floatingWindowPreferences: FloatingWindowPreferences
    
    private var currentState = FloatingWindowState()
    
    /**
     * å¤„ç†å‘é€è¯·æ±‚
     */
    private fun handleSubmit(contactId: String, text: String) {
        val actionType = currentState.selectedTab
        
        serviceScope.launch {
            currentState = currentState.copy(isLoading = true)
            floatingView?.showLoading(getLoadingText(actionType))
            
            val result = when (actionType) {
                ActionType.ANALYZE -> {
                    analyzeChatUseCase(contactId, listOf(text))
                        .map { AiResult.Analysis(it) }
                }
                ActionType.POLISH -> {
                    polishDraftUseCase(contactId, text)
                        .map { AiResult.Polish(it) }
                }
                ActionType.REPLY -> {
                    generateReplyUseCase(contactId, text)
                        .map { AiResult.Reply(it) }
                }
            }
            
            result.onSuccess { aiResult ->
                currentState = currentState.copy(
                    isLoading = false,
                    lastResult = aiResult
                )
                floatingView?.showResult(aiResult)
                floatingWindowPreferences.saveLastContactId(contactId)
            }.onFailure { error ->
                currentState = currentState.copy(
                    isLoading = false,
                    errorMessage = error.message
                )
                floatingView?.showError(error.message ?: "è¯·æ±‚å¤±è´¥")
            }
        }
    }
    
    /**
     * å¤„ç†é‡æ–°ç”Ÿæˆ
     */
    private fun handleRegenerate(instruction: String?) {
        val lastResult = currentState.lastResult ?: return
        
        val request = RefinementRequest(
            originalInput = currentState.inputText,
            originalTask = currentState.selectedTab,
            lastAiResponse = lastResult.getCopyableText(),
            refinementInstruction = instruction,
            contactId = currentState.selectedContactId ?: return
        )
        
        serviceScope.launch {
            currentState = currentState.copy(isLoading = true)
            floatingView?.showLoading("æ­£åœ¨é‡æ–°ç”Ÿæˆ...")
            
            refinementUseCase(request)
                .onSuccess { aiResult ->
                    currentState = currentState.copy(
                        isLoading = false,
                        lastResult = aiResult
                    )
                    floatingView?.showResult(aiResult)
                }
                .onFailure { error ->
                    currentState = currentState.copy(
                        isLoading = false,
                        errorMessage = error.message
                    )
                    floatingView?.showError(error.message ?: "é‡æ–°ç”Ÿæˆå¤±è´¥")
                }
        }
    }
    
    private fun getLoadingText(actionType: ActionType): String {
        return when (actionType) {
            ActionType.ANALYZE -> "æ­£åœ¨åˆ†æèŠå¤©å†…å®¹..."
            ActionType.POLISH -> "æ­£åœ¨æ¶¦è‰²æ‚¨çš„è‰ç¨¿..."
            ActionType.REPLY -> "æ­£åœ¨ç”Ÿæˆå›å¤å»ºè®®..."
        }
    }
}
```


---

## ğŸ“‹ å®æ–½è®¡åˆ’

### é˜¶æ®µä¸€ï¼šåç«¯é‡æ„ï¼ˆé¢„è®¡3å¤©ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|------|--------|----------|------|
| 1.1 æ‰©å±•ActionTypeæšä¸¾ | P0 | 0.5å¤© | æ—  |
| 1.2 æ–°å¢PolishResultã€ReplyResultæ¨¡å‹ | P0 | 0.5å¤© | 1.1 |
| 1.3 æ–°å¢FloatingWindowStateæ¨¡å‹ | P0 | 0.5å¤© | 1.1 |
| 1.4 æ‰©å±•PromptSceneå’ŒSystemPrompts | P0 | 0.5å¤© | æ—  |
| 1.5 å®ç°PolishDraftUseCase | P0 | 0.5å¤© | 1.2, 1.4 |
| 1.6 å®ç°GenerateReplyUseCase | P0 | 0.5å¤© | 1.2, 1.4 |
| 1.7 å®ç°RefinementUseCase | P1 | 0.5å¤© | 1.5, 1.6 |
| 1.8 æ‰©å±•AiRepositoryæ¥å£å’Œå®ç° | P0 | 0.5å¤© | 1.2 |

### é˜¶æ®µäºŒï¼šUIé‡æ„ï¼ˆé¢„è®¡4å¤©ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|------|--------|----------|------|
| 2.1 å®ç°TabSwitcherç»„ä»¶ | P0 | 0.5å¤© | 1.1 |
| 2.2 é‡æ„FloatingViewæ·»åŠ Tab | P0 | 1å¤© | 2.1 |
| 2.3 å®ç°ResultCardç»„ä»¶ | P0 | 0.5å¤© | 1.2 |
| 2.4 å®ç°RefinementDialogç»„ä»¶ | P1 | 0.5å¤© | æ—  |
| 2.5 æ‰©å±•FloatingWindowPreferences | P0 | 0.5å¤© | 1.3 |
| 2.6 é‡æ„FloatingWindowService | P0 | 1å¤© | 2.2, 2.5 |

### é˜¶æ®µä¸‰ï¼šé›†æˆæµ‹è¯•ï¼ˆé¢„è®¡2å¤©ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|------|--------|----------|------|
| 3.1 UseCaseå•å…ƒæµ‹è¯• | P0 | 0.5å¤© | é˜¶æ®µä¸€ |
| 3.2 çŠ¶æ€ç®¡ç†å•å…ƒæµ‹è¯• | P0 | 0.5å¤© | é˜¶æ®µäºŒ |
| 3.3 é›†æˆæµ‹è¯• | P0 | 0.5å¤© | 3.1, 3.2 |
| 3.4 UIæµ‹è¯• | P1 | 0.5å¤© | é˜¶æ®µäºŒ |

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

```kotlin
// PolishDraftUseCaseTest.kt
class PolishDraftUseCaseTest {
    
    @Test
    fun `æ¶¦è‰²æˆåŠŸæ—¶è¿”å›PolishResult`() = runTest {
        // Given
        val contactId = "contact_1"
        val draftText = "ä¸å»ï¼Œè¦å‡è‚¥"
        
        coEvery { aiRepository.polishDraft(any(), any(), any()) } returns 
            Result.success(PolishResult(
                polishedText = "äº²çˆ±çš„ï¼Œä»Šæ™šæƒ³åœ¨å®¶ä¼‘æ¯ä¸€ä¸‹ï½",
                hasRisk = false
            ))
        
        // When
        val result = useCase(contactId, draftText)
        
        // Then
        assertTrue(result.isSuccess)
        assertEquals("äº²çˆ±çš„ï¼Œä»Šæ™šæƒ³åœ¨å®¶ä¼‘æ¯ä¸€ä¸‹ï½", result.getOrNull()?.polishedText)
    }
    
    @Test
    fun `æ£€æµ‹åˆ°é£é™©æ—¶è¿”å›é£é™©æç¤º`() = runTest {
        // Given
        coEvery { aiRepository.polishDraft(any(), any(), any()) } returns 
            Result.success(PolishResult(
                polishedText = "ä»Šæ™šä¸æƒ³å»",
                hasRisk = true,
                riskWarning = "è¯­æ°”å¯èƒ½è¿‡äºç›´æ¥"
            ))
        
        // When
        val result = useCase("contact_1", "ä¸å»")
        
        // Then
        assertTrue(result.getOrNull()?.hasRisk == true)
        assertNotNull(result.getOrNull()?.riskWarning)
    }
}

// RefinementUseCaseTest.kt
class RefinementUseCaseTest {
    
    @Test
    fun `æ— å¾®è°ƒæŒ‡ä»¤æ—¶ç›´æ¥é‡æ–°ç”Ÿæˆ`() = runTest {
        // Given
        val request = RefinementRequest(
            originalInput = "å¥¹è¯´ä»Šæ™šä¸æƒ³å‡ºé—¨",
            originalTask = ActionType.ANALYZE,
            lastAiResponse = "å¥¹å¯èƒ½åœ¨è¯•æ¢ä½ ",
            refinementInstruction = null,
            contactId = "contact_1"
        )
        
        // When
        val result = useCase(request)
        
        // Then
        coVerify { analyzeChatUseCase(any(), any()) }
        coVerify(exactly = 0) { aiRepository.refineAnalysis(any(), any()) }
    }
    
    @Test
    fun `æœ‰å¾®è°ƒæŒ‡ä»¤æ—¶ä½¿ç”¨å¾®è°ƒæç¤ºè¯`() = runTest {
        // Given
        val request = RefinementRequest(
            originalInput = "å¥¹è¯´ä»Šæ™šä¸æƒ³å‡ºé—¨",
            originalTask = ActionType.ANALYZE,
            lastAiResponse = "å¥¹å¯èƒ½åœ¨è¯•æ¢ä½ ",
            refinementInstruction = "åˆ†æå¾—æ›´è¯¦ç»†ä¸€ç‚¹",
            contactId = "contact_1"
        )
        
        // When
        val result = useCase(request)
        
        // Then
        coVerify { aiRepository.refineAnalysis(any(), any()) }
        coVerify(exactly = 0) { analyzeChatUseCase(any(), any()) }
    }
}
```

### 2. çŠ¶æ€ç®¡ç†æµ‹è¯•

```kotlin
// FloatingWindowPreferencesTest.kt
class FloatingWindowPreferencesTest {
    
    @Test
    fun `ä¿å­˜çŠ¶æ€åå¯ä»¥æ­£ç¡®æ¢å¤`() {
        // Given
        val state = FloatingWindowState(
            selectedTab = ActionType.POLISH,
            selectedContactId = "contact_1",
            inputText = "æµ‹è¯•å†…å®¹"
        )
        
        // When
        preferences.saveState(state)
        val restored = preferences.restoreState()
        
        // Then
        assertEquals(ActionType.POLISH, restored?.selectedTab)
        assertEquals("contact_1", restored?.selectedContactId)
        assertEquals("æµ‹è¯•å†…å®¹", restored?.inputText)
    }
    
    @Test
    fun `æ¸…é™¤çŠ¶æ€åæ¢å¤è¿”å›null`() {
        // Given
        preferences.saveState(FloatingWindowState())
        
        // When
        preferences.clearSavedState()
        val restored = preferences.restoreState()
        
        // Then
        assertNull(restored)
    }
}
```

---

## âš ï¸ é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| çŠ¶æ€ä¿æŒå¯¼è‡´å†…å­˜æ³„æ¼ | ä¸­ | ä½ | ä½¿ç”¨WeakReferenceï¼ŒåŠæ—¶æ¸…ç† |
| Tabåˆ‡æ¢å½±å“ç°æœ‰é€»è¾‘ | ä¸­ | ä¸­ | ä¿æŒå‘åå…¼å®¹ï¼Œæ¸è¿›å¼é‡æ„ |
| å¾®è°ƒåŠŸèƒ½å¢åŠ APIæˆæœ¬ | ä½ | ä¸­ | é™åˆ¶å¾®è°ƒæ¬¡æ•°ï¼Œæç¤ºç”¨æˆ· |
| AIå“åº”è§£æå¤±è´¥ | ä¸­ | ä½ | ä½¿ç”¨AiResponseCleanerï¼Œæ·»åŠ é™çº§å¤„ç† |

### å…¼å®¹æ€§é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| ä¸ç°æœ‰CheckDraftUseCaseå†²çª | ä½ | ä½ | ä¿ç•™CHECKåœºæ™¯ï¼Œé€æ­¥åºŸå¼ƒ |
| FloatingWindowPreferencesæ•°æ®è¿ç§» | ä½ | ä½ | æ–°å¢å­—æ®µä½¿ç”¨é»˜è®¤å€¼ |

---

## ğŸ“š é™„å½•

### A. ç›¸å…³æ–‡æ¡£

- [PRD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„éœ€æ±‚](../PRD/PRD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„éœ€æ±‚.md)
- [PRD-00001-æ‚¬æµ®çª—åŠŸèƒ½éœ€æ±‚](../PRD/PRD-00001-æ‚¬æµ®çª—åŠŸèƒ½éœ€æ±‚.md)
- [PRD-00008-è¾“å…¥å†…å®¹èº«ä»½è¯†åˆ«ä¸åŒå‘å¯¹è¯å†å²éœ€æ±‚](../PRD/PRD-00008-è¾“å…¥å†…å®¹èº«ä»½è¯†åˆ«ä¸åŒå‘å¯¹è¯å†å²éœ€æ±‚.md)

### B. æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| ActionType | æ“ä½œç±»å‹ï¼Œå®šä¹‰æ‚¬æµ®çª—æ”¯æŒçš„åŠŸèƒ½ |
| PolishResult | æ¶¦è‰²ç»“æœï¼ŒåŒ…å«ä¼˜åŒ–åçš„æ–‡æœ¬å’Œé£é™©æç¤º |
| ReplyResult | å›å¤ç»“æœï¼ŒåŒ…å«å»ºè®®çš„å›å¤å’Œç­–ç•¥è¯´æ˜ |
| RefinementRequest | å¾®è°ƒè¯·æ±‚ï¼ŒåŒ…å«åŸå§‹è¾“å…¥å’Œå¾®è°ƒæŒ‡ä»¤ |
| FloatingWindowState | æ‚¬æµ®çª—çŠ¶æ€ï¼Œç”¨äºçŠ¶æ€ä¿æŒå’Œæ¢å¤ |

### C. å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| 2025-12-17 | 1.0 | åˆå§‹ç‰ˆæœ¬ | Kiro |
