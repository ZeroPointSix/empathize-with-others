# FD-00010: 悬浮球状态指示与拖动功能设计

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | FD (Functional Design) |
| 文档编号 | FD-00010 |
| 功能名称 | 悬浮球状态指示与拖动功能 |
| 版本 | 1.0 |
| 创建日期 | 2025-12-18 |
| 作者 | Kiro |
| 审核人 | 待定 |
| 关联文档 | PRD-00010, TDD-00009 |

---

## 2. 功能概述

### 2.1 功能目标

为悬浮球（最小化后的小圆球）增加三个核心能力：
1. **可拖动**：用户可以将悬浮球拖动到屏幕任意位置
2. **状态指示**：通过视觉变化显示AI处理状态
3. **完成通知**：AI处理完成后通过系统通知和视觉变化提醒用户

### 2.2 功能边界

| 包含 | 不包含 |
|------|--------|
| 悬浮球拖动 | 悬浮窗（主界面）拖动 |
| 悬浮球状态指示 | 悬浮窗内的加载状态 |
| 系统通知 | 应用内Toast提示 |
| 位置记忆 | 多设备同步 |

---

## 3. 功能流程设计

### 3.1 整体流程图

```
┌─────────────────────────────────────────────────────────────┐
│                      用户操作流程                            │
└─────────────────────────────────────────────────────────────┘

  ┌──────────┐
  │ 悬浮窗   │ ← 用户输入内容，点击发送
  │ (展开态) │
  └──────────┘
       │
       │ 点击最小化
       ▼
  ┌──────────┐     有AI请求?     ┌──────────────┐
  │ 判断状态 │ ─────────────────→│ 悬浮球(LOADING)│
  └──────────┘        是         │ 显示旋转动画  │
       │                         └──────────────┘
       │ 否                            │
       ▼                               │ AI返回结果
  ┌──────────┐                         ▼
  │ 悬浮球   │                   ┌──────────────┐
  │ (IDLE)   │                   │ 成功/失败?   │
  └──────────┘                   └──────────────┘
                                   │         │
                              成功 │         │ 失败
                                   ▼         ▼
                            ┌─────────┐ ┌─────────┐
                            │ SUCCESS │ │ ERROR   │
                            │ 绿色勾  │ │ 红色叹号│
                            └─────────┘ └─────────┘
                                   │         │
                                   └────┬────┘
                                        │
                                        ▼
                                 ┌──────────────┐
                                 │ 发送系统通知 │
                                 │ + 视觉变化   │
                                 └──────────────┘
                                        │
                                        │ 用户点击悬浮球
                                        ▼
                                 ┌──────────────┐
                                 │ 展开悬浮窗   │
                                 │ 显示结果     │
                                 │ 状态→IDLE    │
                                 └──────────────┘
```

### 3.2 拖动流程

```
  用户触摸悬浮球
         │
         ▼
  ┌──────────────┐
  │ 记录触摸位置 │
  │ 记录触摸时间 │
  └──────────────┘
         │
         │ 手指移动
         ▼
  ┌──────────────┐     移动距离 > 10dp?
  │ 计算移动距离 │ ─────────────────────→ 进入拖动模式
  └──────────────┘         是            更新悬浮球位置
         │
         │ 否（移动距离 ≤ 10dp）
         │
         │ 手指抬起
         ▼
  ┌──────────────┐     触摸时长 < 200ms?
  │ 计算触摸时长 │ ─────────────────────→ 视为点击
  └──────────────┘         是            展开悬浮窗
         │
         │ 否（触摸时长 ≥ 200ms 且 移动距离 ≤ 10dp）
         ▼
  ┌──────────────┐
  │ 视为长按     │ → 无特殊操作
  └──────────────┘
```

---

## 4. 状态机设计

### 4.1 悬浮球状态定义

```kotlin
enum class FloatingBubbleState {
    IDLE,      // 空闲 - 静态图标
    LOADING,   // 加载中 - 旋转动画
    SUCCESS,   // 成功 - 绿色勾
    ERROR      // 失败 - 红色叹号
}
```

### 4.2 状态转换规则

| 当前状态 | 触发事件 | 目标状态 | 条件 |
|----------|----------|----------|------|
| IDLE | AI请求发起 | LOADING | 必须是真正的网络请求 |
| LOADING | AI返回成功 | SUCCESS | - |
| LOADING | AI返回失败 | ERROR | - |
| LOADING | 请求超时 | ERROR | 超时时间30秒 |
| SUCCESS | 用户点击悬浮球 | IDLE | - |
| ERROR | 用户点击悬浮球 | IDLE | - |
| 任意状态 | 用户展开悬浮窗 | IDLE | 如果有结果则显示 |

### 4.3 状态触发时机（关键）

**⚠️ 核心原则：只有真正发起AI网络请求后，才能进入LOADING状态**

```kotlin
// ❌ 错误示例：点击发送按钮就显示加载
fun onSubmitClick() {
    setBubbleState(LOADING)  // 错误！此时还没发请求
    validateInput()
    buildRequest()
    callAi()
}

// ✅ 正确示例：在真正调用AI时才显示加载
fun onSubmitClick() {
    val validationResult = validateInput()
    if (validationResult.isFailure) {
        showError(validationResult.error)  // 本地校验失败，不显示加载
        return
    }
    
    val request = buildRequest()
    // 在这里才设置加载状态
    setBubbleState(LOADING)
    callAi(request)
}
```

---

## 5. 交互设计

### 5.1 悬浮球视觉设计

| 状态 | 背景色 | 图标 | 动画 |
|------|--------|------|------|
| IDLE | #FFFFFF | App Logo (32dp) | 无 |
| LOADING | #FFFFFF | 进度环 | 旋转 1000ms/圈 |
| SUCCESS | #E8F5E9 | ✓ (绿色) | 弹跳 300ms |
| ERROR | #FFEBEE | ! (红色) | 无 |

### 5.2 悬浮球尺寸

- 直径：56dp
- 图标大小：32dp
- 阴影：elevation 8dp
- 触摸区域：至少 48dp × 48dp

### 5.3 拖动交互

| 参数 | 值 | 说明 |
|------|-----|------|
| 点击判定阈值 | 10dp | 移动距离小于此值视为点击 |
| 点击时长阈值 | 200ms | 触摸时长小于此值视为点击 |
| 边界保护 | 50% | 悬浮球至少50%在屏幕内 |
| 默认位置 | 右侧中间 | 首次使用时的位置 |

### 5.4 通知设计

**通知渠道**：
- ID: `empathy_ai_result`
- 名称: `AI处理结果`
- 重要性: `IMPORTANCE_DEFAULT`

**通知内容**：

| 场景 | 标题 | 内容 |
|------|------|------|
| 分析成功 | 共情AI | 分析完成，点击查看结果 |
| 润色成功 | 共情AI | 润色完成，点击查看结果 |
| 回复成功 | 共情AI | 回复已生成，点击查看 |
| 处理失败 | 共情AI | 处理失败，点击重试 |

---

## 6. 数据持久化设计

### 6.1 需要持久化的数据

| 数据项 | 存储位置 | 有效期 |
|--------|----------|--------|
| 悬浮球X坐标 | SharedPreferences | 永久 |
| 悬浮球Y坐标 | SharedPreferences | 永久 |
| 最小化请求信息 | SharedPreferences | 10分钟 |
| 最小化时间戳 | SharedPreferences | 10分钟 |

### 6.2 恢复逻辑

```
应用启动/Service重建
         │
         ▼
  ┌──────────────┐
  │ 读取保存的   │
  │ 悬浮球位置   │
  └──────────────┘
         │
         ▼
  ┌──────────────┐     有最小化请求?
  │ 检查最小化   │ ─────────────────→ 检查有效期
  │ 请求信息     │         是
  └──────────────┘                    │
         │                            │ 未过期(10分钟内)
         │ 否                         ▼
         ▼                     ┌──────────────┐
  ┌──────────────┐             │ 恢复LOADING  │
  │ 显示IDLE状态 │             │ 继续等待结果 │
  └──────────────┘             └──────────────┘
                                      │
                                      │ 已过期
                                      ▼
                               ┌──────────────┐
                               │ 清除请求信息 │
                               │ 显示IDLE状态 │
                               └──────────────┘
```

---

## 7. 异常处理设计

### 7.1 异常场景

| 场景 | 处理方式 |
|------|----------|
| 拖动时悬浮球被系统回收 | 重建时恢复到保存的位置 |
| AI请求超时 | 30秒后自动切换到ERROR状态 |
| 通知权限被拒绝 | 仅依赖悬浮球视觉变化 |
| 进程被杀死 | 重启后检查是否有未完成的请求 |

### 7.2 边界情况

| 场景 | 处理方式 |
|------|----------|
| 悬浮球被拖出屏幕 | 限制至少50%在屏幕内 |
| 屏幕旋转 | 重新计算位置，保持相对位置 |
| 分屏模式 | 限制在当前窗口范围内 |

---

## 8. 验收标准

### 8.1 功能验收

- [ ] 悬浮球可拖动到屏幕任意位置
- [ ] 短按悬浮球展开悬浮窗
- [ ] 拖动后位置被记住
- [ ] 四种状态显示正确
- [ ] 状态转换逻辑正确
- [ ] 系统通知正常发送和点击跳转
- [ ] **关键：只有真正发起AI请求才显示加载状态**

### 8.2 性能验收

- [ ] 拖动帧率 ≥ 55FPS
- [ ] 动画流畅无卡顿
- [ ] 内存增量 < 1MB

---

## 9. 相关文档

- [PRD-00010-悬浮球状态指示与拖动功能需求](../PRD/PRD-00010-悬浮球状态指示与拖动功能需求.md)
- [TDD-00010-悬浮球状态指示与拖动技术设计](../TDD/TDD-00010-悬浮球状态指示与拖动技术设计.md)
- [TDD-00009-悬浮窗功能重构技术设计](../TDD/TDD-00009-悬浮窗功能重构技术设计.md)
