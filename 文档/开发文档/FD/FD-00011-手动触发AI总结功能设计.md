# FD-00011: 手动触发AI总结功能设计

---
**文档类型**: FD (Functional Design) - 开发过程文档  
**存放规范**: 符合项目宪法第IV条 - 文档规范  
**版本控制**: Git管理，见.commit钩子  
---

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | FD (Functional Design) |
| 文档编号 | FD-00011 |
| 功能名称 | 手动触发AI总结功能 |
| 版本 | 1.1 |
| 创建日期 | 2025-12-19 |
| 最后更新 | 2025-12-19 |
| 作者 | Kiro |
| 审核人 | 待定 |
| 关联文档 | PRD-00011, Q&A-00011, TDD-00011 |

---

## 2. 功能概述

### 2.1 功能目标

为用户提供手动触发AI总结的能力，解决以下核心问题：
1. **灵活性**：用户可自主选择任意日期范围生成总结
2. **补救机制**：填补自动总结失败或历史数据空白
3. **个性化**：支持针对特定事件或时间点生成定制化总结

### 2.2 功能边界

| 包含 (V1) | 不包含 (V2规划) |
|-----------|-----------------|
| 单个联系人的手动总结 | 跨联系人批量总结 |
| 自定义日期范围选择 | 超过90天的总结 |
| 总结进度显示与取消 | 总结模板自定义 |
| 冲突检测与处理 | 总结内容编辑 |
| 结果展示与标识 | 总结分享导出 |
| 缺失总结提示卡片 | 批量操作入口 |

> **V2规划说明**：批量操作、模板自定义等功能将在后续版本中实现，本次迭代聚焦核心手动总结能力。


---

## 3. 功能流程设计

### 3.1 整体流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    手动触发总结流程                          │
└─────────────────────────────────────────────────────────────┘

  ┌──────────────┐
  │ 联系人详情页 │ ← 用户进入
  └──────────────┘
         │
         │ 点击"生成总结"按钮
         ▼
  ┌──────────────┐
  │ 日期范围选择 │ ← 显示日历/快捷选项
  │    对话框    │
  └──────────────┘
         │
         │ 用户选择日期范围
         ▼
  ┌──────────────┐     存在冲突?      ┌──────────────┐
  │ 冲突检测     │ ─────────────────→ │ 冲突处理对话框│
  └──────────────┘        是          │ 覆盖/合并/取消│
         │                            └──────────────┘
         │ 否                               │
         ▼                                  │ 用户选择
  ┌──────────────┐ ←────────────────────────┘
  │ 确认生成     │
  └──────────────┘
         │
         │ 开始生成
         ▼
  ┌──────────────┐
  │ 进度显示     │ ← 获取对话→AI分析→生成结果→保存
  │   对话框     │
  └──────────────┘
         │
         │ 生成完成/失败
         ▼
  ┌──────────────┐     成功?      ┌──────────────┐
  │ 结果判断     │ ─────────────→ │ 显示总结结果 │
  └──────────────┘       是       │ 跳转时光轴   │
         │                        └──────────────┘
         │ 否
         ▼
  ┌──────────────┐
  │ 错误提示     │ ← 提供重试选项
  │ 重试/取消    │
  └──────────────┘
```

### 3.2 日期选择流程

```
  用户点击日期选择
         │
         ▼
  ┌──────────────────────────────────────┐
  │           日期范围选择器              │
  │  ┌────────────────────────────────┐  │
  │  │ 快捷选项                        │  │
  │  │ ○ 最近7天  ○ 本月  ○ 上月      │  │
  │  │ ○ 最近30天 ○ 未总结时段        │  │
  │  └────────────────────────────────┘  │
  │  ┌────────────────────────────────┐  │
  │  │ 自定义日期                      │  │
  │  │ 开始: [____年__月__日]         │  │
  │  │ 结束: [____年__月__日]         │  │
  │  └────────────────────────────────┘  │
  │  ┌────────────────────────────────┐  │
  │  │ 已有总结提示                    │  │
  │  │ ⚠️ 12/10-12/15 已有总结        │  │
  │  └────────────────────────────────┘  │
  │           [取消]  [确认]             │
  └──────────────────────────────────────┘
```


---

## 4. 状态机设计

### 4.1 总结任务状态定义

```kotlin
enum class SummaryTaskStatus {
    IDLE,           // 空闲 - 未开始
    FETCHING_DATA,  // 获取数据 - 正在获取对话记录
    ANALYZING,      // 分析中 - AI正在处理
    GENERATING,     // 生成中 - 正在生成总结内容
    SAVING,         // 保存中 - 正在保存结果
    SUCCESS,        // 成功 - 总结完成
    FAILED,         // 失败 - 处理出错
    CANCELLED       // 已取消 - 用户取消
}
```

### 4.2 状态转换规则

| 当前状态 | 触发事件 | 目标状态 | 条件 |
|----------|----------|----------|------|
| IDLE | 用户确认生成 | FETCHING_DATA | 日期范围有效 |
| FETCHING_DATA | 数据获取完成 | ANALYZING | 有对话数据 |
| FETCHING_DATA | 无对话数据 | FAILED | 选定范围无对话 |
| FETCHING_DATA | 用户取消 | CANCELLED | - |
| ANALYZING | AI分析完成 | GENERATING | - |
| ANALYZING | AI调用失败 | FAILED | 网络/API错误 |
| ANALYZING | 用户取消 | CANCELLED | - |
| GENERATING | 生成完成 | SAVING | - |
| GENERATING | 生成失败 | FAILED | - |
| SAVING | 保存成功 | SUCCESS | - |
| SAVING | 保存失败 | FAILED | 数据库错误 |
| FAILED | 用户重试 | FETCHING_DATA | - |
| SUCCESS | 用户查看 | IDLE | 重置状态 |
| CANCELLED | 用户重新开始 | IDLE | - |

### 4.3 进度百分比映射

| 状态 | 进度范围 | 显示文案 |
|------|----------|----------|
| FETCHING_DATA | 0% - 20% | 正在获取对话记录... |
| ANALYZING | 20% - 70% | AI正在分析对话内容... |
| GENERATING | 70% - 90% | 正在生成总结... |
| SAVING | 90% - 100% | 正在保存结果... |


---

## 5. 交互设计

### 5.1 入口设计

#### 5.1.1 主入口：联系人详情页FAB

| 属性 | 值 |
|------|-----|
| 位置 | 右下角，距底部16dp，距右侧16dp |
| 尺寸 | 56dp × 56dp |
| 图标 | 日历+AI图标组合 (24dp) |
| 颜色 | Primary色 |
| 动画 | 点击时缩放0.9→1.0 |

#### 5.1.2 辅助入口：时光轴空白提示（MissingSummaryCard）

当时光轴检测到某时间段无总结时，显示提示卡片：

```
┌────────────────────────────────────┐
│ 📅 12月10日 - 12月15日             │
│                                    │
│ 这段时间有5条对话，但还没有总结    │
│                                    │
│        [生成这段时间的总结]        │
└────────────────────────────────────┘
```

**MissingSummaryCard组件设计**：

| 属性 | 值 |
|------|-----|
| 背景色 | Surface variant |
| 边框 | 1dp dashed, Primary色 |
| 圆角 | 12dp |
| 内边距 | 16dp |
| 图标 | Calendar + Sparkles (24dp) |
| 标题字号 | titleSmall |
| 描述字号 | bodyMedium |
| 按钮样式 | FilledTonalButton |

**显示条件**：
- 时间段内有对话记录（≥1条）
- 该时间段无已有总结
- 时间段跨度 ≥ 3天

### 5.2 日期范围选择器设计

#### 5.2.1 快捷选项

| 选项 | 日期范围 | 说明 |
|------|----------|------|
| 最近7天 | 今天 - 7天前 | 默认选中 |
| 本月 | 本月1日 - 今天 | - |
| 上月 | 上月1日 - 上月末 | - |
| 最近30天 | 今天 - 30天前 | - |
| 未总结时段 | 自动检测 | 智能推荐 |

#### 5.2.2 日期限制规则

| 规则 | 值 | 说明 |
|------|-----|------|
| 最大范围 | 30天 | 默认限制 |
| 扩展范围 | 90天 | 需确认警告 |
| 最早日期 | 联系人创建日期 | 不能早于此 |
| 最晚日期 | 今天 | 不能选择未来 |

#### 5.2.3 范围超限警告

当用户选择超过30天时显示：

```
┌────────────────────────────────────┐
│ ⚠️ 时间范围较长                    │
│                                    │
│ 您选择了45天的时间范围，这可能需要 │
│ 较长时间处理，且总结质量可能下降。 │
│                                    │
│ 建议分多次生成，每次不超过30天。   │
│                                    │
│      [取消]  [仍然继续]            │
└────────────────────────────────────┘
```

### 5.3 冲突处理设计

#### 5.3.1 冲突检测逻辑

```kotlin
// 检测选定范围内是否存在已有总结
fun checkConflict(
    contactId: String,
    startDate: String,
    endDate: String
): ConflictResult {
    val existingSummaries = summaryRepository.getSummariesInRange(
        contactId, startDate, endDate
    )
    return when {
        existingSummaries.isEmpty() -> ConflictResult.NoConflict
        else -> ConflictResult.HasConflict(existingSummaries)
    }
}
```

#### 5.3.2 冲突处理选项

| 选项 | 行为 | 适用场景 |
|------|------|----------|
| 覆盖现有 | 删除旧总结，生成新总结 | 想要重新生成 |
| 仅补充 | 只生成无总结的日期 | 填补空白 |
| 取消 | 返回日期选择 | 重新考虑 |

#### 5.3.3 冲突对话框

```
┌────────────────────────────────────┐
│ 检测到已有总结                      │
│                                    │
│ 选定范围内已存在以下总结：          │
│ • 12月10日 (自动生成)              │
│ • 12月12日 (手动生成)              │
│                                    │
│ 请选择处理方式：                    │
│                                    │
│ ○ 覆盖现有总结                     │
│ ○ 仅补充缺失日期                   │
│                                    │
│      [取消]  [确认]                │
└────────────────────────────────────┘
```


### 5.4 进度显示设计

#### 5.4.1 进度对话框

```
┌────────────────────────────────────┐
│ 正在生成总结                        │
│                                    │
│ ████████████░░░░░░░░  60%          │
│                                    │
│ AI正在分析对话内容...               │
│                                    │
│ 预计剩余时间: 约15秒                │
│                                    │
│           [取消]                   │
└────────────────────────────────────┘
```

#### 5.4.2 进度阶段动画

| 阶段 | 图标 | 动画 |
|------|------|------|
| 获取数据 | 📥 | 下载动画 |
| AI分析 | 🤖 | 思考动画 |
| 生成结果 | ✍️ | 书写动画 |
| 保存 | 💾 | 保存动画 |

### 5.5 结果展示设计

#### 5.5.1 成功结果

```
┌────────────────────────────────────┐
│ ✅ 总结生成成功                     │
│                                    │
│ 已为 12月10日-12月15日 生成总结     │
│                                    │
│ 📊 分析了 23 条对话                 │
│ 🎯 提取了 5 个关键事件              │
│ 📈 关系评分变化: +3                 │
│                                    │
│    [查看总结]  [返回]              │
└────────────────────────────────────┘
```

#### 5.5.2 失败结果

```
┌────────────────────────────────────┐
│ ❌ 总结生成失败                     │
│                                    │
│ 原因: 网络连接超时                  │
│                                    │
│ 建议:                              │
│ • 检查网络连接                      │
│ • 稍后重试                         │
│                                    │
│    [重试]  [取消]                  │
└────────────────────────────────────┘
```

### 5.6 总结标识设计

#### 5.6.1 来源标识

| 来源 | 标识 | 颜色 |
|------|------|------|
| 自动生成 | 🤖 自动 | 灰色 |
| 手动生成 | 👤 手动 | 蓝色 |

#### 5.6.2 时光轴展示

手动生成的总结在时光轴中显示时，添加"手动"标签：

```
┌────────────────────────────────────┐
│ 12月10日 - 12月15日  [👤 手动]     │
│────────────────────────────────────│
│ 这段时间你们讨论了项目进展...       │
│                                    │
│ 关键事件:                          │
│ • 确定了项目截止日期                │
│ • 讨论了技术方案选型                │
└────────────────────────────────────┘
```


---

## 6. 数据模型设计

### 6.1 总结任务模型

```kotlin
data class SummaryTask(
    val id: String,                    // 任务唯一ID
    val contactId: String,             // 联系人ID
    val startDate: String,             // 开始日期 (yyyy-MM-dd)
    val endDate: String,               // 结束日期 (yyyy-MM-dd)
    val status: SummaryTaskStatus,     // 任务状态
    val progress: Float,               // 进度 (0.0 - 1.0)
    val currentStep: String,           // 当前步骤描述
    val createdAt: Long,               // 创建时间戳
    val startedAt: Long?,              // 开始执行时间戳
    val completedAt: Long?,            // 完成时间戳
    val error: SummaryError?           // 错误信息
)
```

### 6.2 总结结果模型扩展

```kotlin
// 扩展现有DailySummary模型
data class DailySummary(
    val id: Long,
    val contactId: String,
    val summaryDate: String,           // 总结日期（统一命名，符合现有规范）
    val startDate: String?,            // 范围总结开始日期 (新增)
    val endDate: String?,              // 范围总结结束日期 (新增)
    val content: String,
    val keyEvents: List<KeyEvent>,
    val newFacts: List<Fact>,
    val updatedTags: List<TagUpdate>,
    val relationshipScoreChange: Int,
    val relationshipTrend: RelationshipTrend,
    val summaryType: SummaryType,      // DAILY, CUSTOM_RANGE (新增)
    val generationSource: GenerationSource, // AUTO, MANUAL (新增)
    val generatedAt: Long,
    val conversationCount: Int         // 分析的对话数量 (新增)
)

enum class SummaryType {
    DAILY,          // 单日总结
    CUSTOM_RANGE    // 自定义范围总结
}

enum class GenerationSource {
    AUTO,           // 自动生成
    MANUAL          // 手动触发
}
```

### 6.3 错误模型

```kotlin
sealed class SummaryError {
    object NoConversations : SummaryError()      // 无对话数据
    object NetworkError : SummaryError()         // 网络错误
    object ApiError : SummaryError()             // AI API错误
    object DatabaseError : SummaryError()        // 数据库错误
    object Timeout : SummaryError()              // 超时
    data class Unknown(val message: String) : SummaryError()
}
```

### 6.4 冲突检测结果

```kotlin
sealed class ConflictResult {
    object NoConflict : ConflictResult()
    data class HasConflict(
        val existingSummaries: List<DailySummary>,
        val conflictDates: List<String>
    ) : ConflictResult()
}

enum class ConflictResolution {
    OVERWRITE,      // 覆盖现有
    FILL_GAPS,      // 仅补充缺失
    CANCEL          // 取消操作
}
```


---

## 7. 业务规则设计

### 7.1 日期范围规则

| 规则ID | 规则描述 | 处理方式 |
|--------|----------|----------|
| DR-001 | 开始日期不能晚于结束日期 | 交换日期或提示错误 |
| DR-002 | 结束日期不能晚于今天 | 自动调整为今天 |
| DR-003 | 开始日期不能早于联系人创建日期 | 自动调整为创建日期 |
| DR-004 | 范围不能超过30天（默认） | 显示警告，允许继续 |
| DR-005 | 范围不能超过90天（硬限制） | 阻止操作，提示分批 |

### 7.2 数据有效性规则

| 规则ID | 规则描述 | 处理方式 |
|--------|----------|----------|
| DV-001 | 选定范围内必须有对话记录 | 提示无数据，建议调整范围 |
| DV-002 | 对话数量超过500条 | 显示警告，建议缩小范围 |
| DV-003 | 联系人必须存在且有效 | 返回错误，刷新页面 |

### 7.3 并发控制规则

| 规则ID | 规则描述 | 处理方式 |
|--------|----------|----------|
| CC-001 | 同一联系人同时只能有一个总结任务 | 提示等待或取消现有任务 |
| CC-002 | 全局最多3个并发总结任务 | 排队等待 |
| CC-003 | 任务超时时间30秒 | 自动标记失败，允许重试 |

### 7.4 冲突处理规则

| 规则ID | 规则描述 | 处理方式 |
|--------|----------|----------|
| CF-001 | 检测到已有总结时必须提示用户 | 显示冲突对话框 |
| CF-002 | 覆盖操作需要二次确认 | 显示确认对话框 |
| CF-003 | 仅补充模式跳过已有总结日期 | 自动过滤 |


---

## 8. 异常处理设计

### 8.1 错误分类与处理

| 错误类型 | 错误码 | 用户提示 | 处理策略 |
|----------|--------|----------|----------|
| 无对话数据 | E001 | 选定时间段内没有对话记录 | 建议调整日期范围 |
| 网络连接失败 | E002 | 网络连接失败，请检查网络 | 提供重试按钮 |
| AI服务不可用 | E003 | AI服务暂时不可用 | 自动重试3次后提示 |
| API配额不足 | E004 | API调用次数已用完 | 引导用户检查配置 |
| 请求超时 | E005 | 处理超时，请稍后重试 | 提供重试按钮 |
| 数据库错误 | E006 | 保存失败，请重试 | 提供重试按钮 |
| 用户取消 | E007 | 已取消 | 静默处理 |

### 8.2 重试策略

```kotlin
data class RetryConfig(
    val maxRetries: Int = 3,           // 最大重试次数
    val initialDelay: Long = 1000,     // 初始延迟(ms)
    val maxDelay: Long = 10000,        // 最大延迟(ms)
    val multiplier: Double = 2.0       // 延迟倍数
)

// 可重试的错误类型
val retryableErrors = setOf(
    SummaryError.NetworkError,
    SummaryError.Timeout
)
```

### 8.3 降级处理

当AI服务不可用时，提供本地降级方案：

| 场景 | 降级方案 |
|------|----------|
| AI分析失败 | 使用本地规则提取关键词 |
| 情感分析失败 | 跳过情感分析，仅统计对话 |
| 完全失败 | 生成基础统计报告 |

### 8.4 数据恢复

| 场景 | 恢复策略 |
|------|----------|
| 任务中断 | 保存中间状态，支持断点续传 |
| 应用崩溃 | 重启后检查未完成任务 |
| 保存失败 | 缓存结果，后台重试保存 |


---

## 9. 性能设计

### 9.1 性能指标

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 日期选择器响应 | < 100ms | 从点击到显示 |
| 冲突检测 | < 500ms | 数据库查询时间 |
| 对话数据加载 | < 2s (100条) | 分页加载时间 |
| AI分析时间 | < 20s (30天) | API调用时间 |
| 结果保存 | < 500ms | 数据库写入时间 |
| UI帧率 | ≥ 55fps | 进度动画期间 |

### 9.2 优化策略

#### 9.2.1 数据加载优化

```kotlin
// 分批加载对话数据
suspend fun loadConversationsInBatches(
    contactId: String,
    startDate: String,
    endDate: String,
    batchSize: Int = 50
): Flow<List<ConversationLog>> = flow {
    var offset = 0
    while (true) {
        val batch = conversationDao.getConversations(
            contactId, startDate, endDate, batchSize, offset
        )
        if (batch.isEmpty()) break
        emit(batch)
        offset += batchSize
    }
}
```

#### 9.2.2 进度更新优化

```kotlin
// 节流进度更新，避免UI过度刷新
private val progressThrottler = Throttler(intervalMs = 100)

fun updateProgress(progress: Float, step: String) {
    progressThrottler.throttle {
        _uiState.update { it.copy(progress = progress, currentStep = step) }
    }
}
```

#### 9.2.3 内存管理

| 策略 | 实现方式 |
|------|----------|
| 分批处理 | 每批最多50条对话 |
| 及时释放 | 处理完成后清理中间数据 |
| 弱引用 | 大对象使用弱引用 |


---

## 10. 组件设计

### 10.1 UI组件清单

| 组件名称 | 类型 | 职责 |
|----------|------|------|
| ManualSummaryFab | Composable | 触发入口FAB按钮 |
| DateRangePickerDialog | Composable | 日期范围选择对话框 |
| QuickDateOptions | Composable | 快捷日期选项组件 |
| ConflictResolutionDialog | Composable | 冲突处理对话框 |
| SummaryProgressDialog | Composable | 进度显示对话框 |
| SummaryResultDialog | Composable | 结果展示对话框 |
| MissingSummaryCard | Composable | 时光轴缺失总结提示卡片 |
| SummarySourceBadge | Composable | 总结来源标识徽章 |

### 10.2 业务组件清单

| 组件名称 | 层级 | 职责 |
|----------|------|------|
| ManualSummaryUseCase | Domain | 手动总结核心业务逻辑 |
| SummaryConflictChecker | Domain | 冲突检测服务 |
| SummaryTaskManager | Domain | 任务状态管理 |
| DateRangeValidator | Domain | 日期范围验证 |
| ManualSummaryViewModel | Presentation | UI状态管理 |

### 10.3 组件交互图

```
┌─────────────────────────────────────────────────────────────┐
│                     Presentation Layer                       │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │ FAB Button  │───→│ DatePicker  │───→│ Progress    │     │
│  └─────────────┘    │ Dialog      │    │ Dialog      │     │
│                     └─────────────┘    └─────────────┘     │
│         │                  │                  │             │
│         └──────────────────┼──────────────────┘             │
│                            ▼                                │
│                  ┌─────────────────┐                        │
│                  │ ManualSummary   │                        │
│                  │ ViewModel       │                        │
│                  └─────────────────┘                        │
└────────────────────────────┼────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────┐
│                     Domain Layer                             │
│                            ▼                                │
│                  ┌─────────────────┐                        │
│                  │ ManualSummary   │                        │
│                  │ UseCase         │                        │
│                  └─────────────────┘                        │
│                     │    │    │                             │
│         ┌───────────┘    │    └───────────┐                 │
│         ▼                ▼                ▼                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Conflict    │  │ DateRange   │  │ TaskManager │         │
│  │ Checker     │  │ Validator   │  │             │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└────────────────────────────┼────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────┐
│                     Data Layer                               │
│         ┌──────────────────┼──────────────────┐             │
│         ▼                  ▼                  ▼             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │ Conversation│    │ DailySummary│    │ AI          │     │
│  │ Repository  │    │ Repository  │    │ Repository  │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
└─────────────────────────────────────────────────────────────┘
```


---

## 11. 验收标准

### 11.1 功能验收

#### P0 - 核心功能（必须通过）

- [ ] 用户可以在联系人详情页点击FAB触发手动总结
- [ ] 日期范围选择器正常显示和交互
- [ ] 快捷选项（最近7天、本月等）正确计算日期
- [ ] 自定义日期选择正常工作
- [ ] 日期范围验证规则正确执行
- [ ] 冲突检测正确识别已有总结
- [ ] 冲突处理对话框正常显示三个选项
- [ ] 进度对话框正确显示各阶段进度
- [ ] 取消操作能够中断任务
- [ ] 成功结果正确保存到数据库
- [ ] 失败时显示友好错误提示
- [ ] 重试功能正常工作

#### P1 - 增强功能（应该通过）

- [ ] 时光轴显示缺失总结提示卡片
- [ ] 手动总结显示来源标识
- [ ] 超过30天范围显示警告
- [ ] 无对话数据时提示调整范围
- [ ] 进度百分比和阶段文案正确

#### P2 - 优化功能（可以通过）

- [ ] 进度动画流畅
- [ ] 日期选择器显示已有总结日期
- [ ] 智能推荐未总结时段

### 11.2 性能验收

- [ ] 日期选择器响应时间 < 100ms
- [ ] 冲突检测时间 < 500ms
- [ ] 30天范围总结时间 < 30s
- [ ] 进度动画帧率 ≥ 55fps
- [ ] 内存增量 < 10MB

### 11.3 兼容性验收

- [ ] 与现有自动总结系统兼容
- [ ] 新旧数据格式兼容
- [ ] 不同屏幕尺寸适配正常


---

## 12. 开发优先级

### 12.1 阶段划分

#### 阶段一：基础功能（P0）- 预计3天

| 任务 | 优先级 | 预估工时 |
|------|--------|----------|
| ManualSummaryUseCase核心逻辑 | P0 | 4h |
| DateRangePickerDialog组件 | P0 | 4h |
| SummaryProgressDialog组件 | P0 | 3h |
| 日期范围验证逻辑 | P0 | 2h |
| 数据库模型扩展 | P0 | 2h |
| 基础单元测试 | P0 | 4h |

#### 阶段二：完整功能（P1）- 预计4天

| 任务 | 优先级 | 预估工时 |
|------|--------|----------|
| 冲突检测与处理 | P1 | 4h |
| ConflictResolutionDialog组件 | P1 | 3h |
| 错误处理与重试机制 | P1 | 4h |
| 进度状态管理 | P1 | 3h |
| ManualSummaryViewModel | P1 | 4h |
| 集成测试 | P1 | 4h |

#### 阶段三：优化完善（P2）- 预计3天

| 任务 | 优先级 | 预估工时 |
|------|--------|----------|
| MissingSummaryCard组件 | P2 | 3h |
| 来源标识UI | P2 | 2h |
| 性能优化 | P2 | 4h |
| UI动画优化 | P2 | 3h |
| 完整测试覆盖 | P2 | 4h |

### 12.2 依赖关系

```
阶段一
  │
  ├── ManualSummaryUseCase ──┐
  │                          │
  ├── DateRangePickerDialog ─┼──→ 阶段二
  │                          │      │
  └── 数据库模型扩展 ────────┘      │
                                    │
                              ┌─────┘
                              │
阶段二                        ▼
  │
  ├── 冲突检测与处理 ────────┐
  │                          │
  ├── 错误处理机制 ──────────┼──→ 阶段三
  │                          │
  └── ManualSummaryViewModel ┘
```


---

## 13. 风险评估

### 13.1 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| AI API响应时间不稳定 | 高 | 中 | 设置超时，提供取消选项 |
| 大数据量处理性能问题 | 中 | 高 | 分批处理，限制范围 |
| 与现有总结系统冲突 | 低 | 高 | 充分测试，渐进式发布 |

### 13.2 产品风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 用户不理解功能用途 | 中 | 中 | 添加引导提示 |
| 功能入口不够明显 | 中 | 低 | 多入口设计 |
| 总结质量不满足预期 | 中 | 高 | 提供反馈机制 |

### 13.3 资源风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 开发时间超预期 | 中 | 中 | 分阶段交付，优先核心功能 |
| API调用成本增加 | 低 | 低 | 添加使用限制提示 |

---

## 14. 相关文档

- [PRD-00011-手动触发AI总结功能产品需求文档](../PRD/PRD-00011-手动触发AI总结功能产品需求文档.md)
- [Q&A-00011-手动触发AI总结功能讨论问题清单](../Q&A/Q&A-00011-手动触发AI总结功能讨论问题清单.md)
- [TDD-00003-联系人画像记忆系统技术设计](../TDD/TDD-00003-联系人画像记忆系统技术设计.md)
- [TD-00003-联系人画像记忆系统任务清单](../TD/TD-00003-联系人画像记忆系统任务清单.md)

---

## 15. 修订历史

| 版本 | 日期 | 作者 | 修改内容 |
|------|------|------|----------|
| 1.0 | 2025-12-19 | Kiro | 初始版本 |

