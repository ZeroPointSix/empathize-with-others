# FD-00013: 自己画像界面功能设计

---
**文档类型**: FD (Functional Design) - 开发过程文档  
**存放规范**: 符合项目宪法第IV条 - 文档规范  
**版本控制**: Git管理，见.commit钩子  
---

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | FD (Functional Design) |
| 文档编号 | FD-00013 |
| 功能名称 | 自己画像界面 |
| 版本 | 1.1 |
| 创建日期 | 2025-12-21 |
| 最后更新 | 2025-12-21 |
| 作者 | Kiro |
| 审核人 | 待定 |
| 关联文档 | PRD-00013, TDD-00013 |

---

## 2. 功能概述

### 2.1 功能目标

为用户提供一个系统化的自我画像管理界面，解决以下核心问题：
1. **AI分析个性化**：让AI了解用户特点，提供更贴合用户风格的建议
2. **自我认知系统化**：帮助用户系统化了解自己的社交特点
3. **上下文增强**：将用户画像信息作为AI分析的重要上下文

### 2.2 功能边界

| 包含 (V1) | 不包含 (V2规划) |
|-----------|-----------------|
| 基础维度填写（性格、价值观等） | AI自动画像生成 |
| 自定义维度管理 | 画像对比分析 |
| 标签增删改操作 | 数据可视化图表 |
| AI上下文集成 | 画像分享功能 |
| 画像完整度提示 | 多场景画像切换 |
| 数据本地加密存储 | 云端同步 |
| 画像导出功能 | 画像历史记录功能 |


---

## 3. 功能流程设计

### 3.1 整体流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    自己画像功能整体流程                       │
└─────────────────────────────────────────────────────────────┘

  ┌──────────────┐
  │ 设置页面     │ ← 用户点击"个人画像"
  └──────────────┘
         │
         ▼
  ┌──────────────┐     首次使用?
  │ 画像主界面   │ ─────────────────────────────────────┐
  └──────────────┘        是                            │
         │                                              │
         │ 否（已有数据）                               ▼
         │                                    ┌──────────────┐
         ▼                                    │ 引导页面     │
  ┌──────────────┐                            │ 快速填写     │
  │ 显示已有画像 │                            └──────────────┘
  │ 完整度指示   │                                    │
  └──────────────┘                                    │
         │                                            │
         │ 用户操作                                   │
         ▼                                            ▼
  ┌──────────────────────────────────────────────────────────┐
  │                    标签页切换                              │
  │  ┌─────────────┐              ┌─────────────┐            │
  │  │ 基础信息    │              │ 自定义维度   │            │
  │  └─────────────┘              └─────────────┘            │
  └──────────────────────────────────────────────────────────┘
         │
         │ 编辑操作
         ▼
  ┌──────────────┐
  │ 保存到本地   │
  │ 更新完整度   │
  └──────────────┘
         │
         │ AI分析时
         ▼
  ┌──────────────┐
  │ 构建上下文   │
  │ 集成用户画像 │
  └──────────────┘
```

### 3.2 基础信息填写流程

```
  用户进入基础信息页
         │
         ▼
  ┌──────────────────────────────────────┐
  │           基础信息页面                │
  │  ┌────────────────────────────────┐  │
  │  │ 性格特点                        │  │
  │  │ [内向] [理性] [+添加]          │  │
  │  └────────────────────────────────┘  │
  │  ┌────────────────────────────────┐  │
  │  │ 价值观                          │  │
  │  │ [重视家庭] [追求事业] [+添加]  │  │
  │  └────────────────────────────────┘  │
  │  ┌────────────────────────────────┐  │
  │  │ 兴趣爱好                        │  │
  │  │ [阅读] [运动] [旅行] [+添加]   │  │
  │  └────────────────────────────────┘  │
  │  ┌────────────────────────────────┐  │
  │  │ 沟通风格                        │  │
  │  │ [直接] [幽默] [+添加]          │  │
  │  └────────────────────────────────┘  │
  │  ┌────────────────────────────────┐  │
  │  │ 社交偏好                        │  │
  │  │ [小群体] [深度交流] [+添加]    │  │
  │  └────────────────────────────────┘  │
  └──────────────────────────────────────┘
```

### 3.3 自定义维度管理流程

```
  用户进入自定义维度页
         │
         ▼
  ┌──────────────────────────────────────┐
  │         自定义维度页面                │
  │  ┌────────────────────────────────┐  │
  │  │ 职业特点                    [×] │  │
  │  │ [细心] [有耐心] [+添加]        │  │
  │  └────────────────────────────────┘  │
  │  ┌────────────────────────────────┐  │
  │  │ 情感状态                    [×] │  │
  │  │ [单身] [+添加]                 │  │
  │  └────────────────────────────────┘  │
  │                                      │
  │       [+ 添加新维度]                 │
  └──────────────────────────────────────┘
         │
         │ 点击添加新维度
         ▼
  ┌──────────────────────────────────────┐
  │         添加维度对话框                │
  │  ┌────────────────────────────────┐  │
  │  │ 维度名称                        │  │
  │  │ [请输入维度名称_____________]  │  │
  │  └────────────────────────────────┘  │
  │           [取消]  [确定]             │
  └──────────────────────────────────────┘
```

### 3.4 AI上下文集成流程

```
  AI分析请求触发
         │
         ▼
  ┌──────────────┐
  │ 加载用户画像 │
  └──────────────┘
         │
         ▼
  ┌──────────────┐     画像为空?      ┌──────────────┐
  │ 检查画像数据 │ ─────────────────→ │ 跳过用户画像 │
  └──────────────┘        是          │ 使用默认上下文│
         │                            └──────────────┘
         │ 否                                │
         ▼                                   │
  ┌──────────────┐                           │
  │ 智能筛选     │                           │
  │ 相关画像信息 │                           │
  └──────────────┘                           │
         │                                   │
         ▼                                   │
  ┌──────────────┐                           │
  │ 构建上下文   │ ←─────────────────────────┘
  │ 拼接提示词   │
  └──────────────┘
         │
         ▼
  ┌──────────────┐
  │ 发送AI请求   │
  └──────────────┘
```


---

## 4. 数据模型设计

### 4.1 UserProfile领域模型

 UserProfile领域模型定义请参考 PRD-00013-自己画像界面产品需求文档.md 第7.1.1节

### 4.2 UserProfileDimension枚举

```kotlin
/**
 * 用户画像基础维度枚举
 */
enum class UserProfileDimension(
    val displayName: String,
    val description: String,
    val presetTags: List<String>
) {
    PERSONALITY_TRAITS(
        displayName = "性格特点",
        description = "描述你的性格特征",
        presetTags = listOf(
            "内向", "外向", "理性", "感性", "乐观", "谨慎",
            "热情", "冷静", "细心", "大方", "幽默", "严肃"
        )
    ),
    VALUES(
        displayName = "价值观",
        description = "你最看重的事物",
        presetTags = listOf(
            "重视家庭", "追求事业", "注重健康", "珍惜友情",
            "追求自由", "重视诚信", "追求成长", "享受生活"
        )
    ),
    INTERESTS(
        displayName = "兴趣爱好",
        description = "你喜欢做的事情",
        presetTags = listOf(
            "阅读", "运动", "旅行", "音乐", "电影", "游戏",
            "美食", "摄影", "绘画", "写作", "编程", "园艺"
        )
    ),
    COMMUNICATION_STYLE(
        displayName = "沟通风格",
        description = "你习惯的沟通方式",
        presetTags = listOf(
            "直接", "委婉", "幽默", "严肃", "主动", "被动",
            "倾听型", "表达型", "逻辑型", "情感型"
        )
    ),
    SOCIAL_PREFERENCES(
        displayName = "社交偏好",
        description = "你喜欢的社交方式",
        presetTags = listOf(
            "大群体", "小群体", "一对一", "线上社交", "线下社交",
            "深度交流", "轻松闲聊", "工作社交", "兴趣社交"
        )
    )
}
```

### 4.3 存储设计

```kotlin
/**
 * 用户画像本地存储
 * 使用EncryptedSharedPreferences加密存储，符合项目宪法隐私优先原则
 * 支持JSON序列化
 */
@Singleton
class UserProfilePreferences @Inject constructor(
    @ApplicationContext private val context: Context,
    private val moshi: Moshi
) {
    // 使用EncryptedSharedPreferences确保敏感数据安全
    private val masterKey = MasterKey.Builder(context)
        .setKeyScheme(MasterKey.KeyScheme.AES256_GCM)
        .build()
    
    private val encryptedPrefs = EncryptedSharedPreferences.create(
        context,
        "user_profile_prefs",
        masterKey,
        EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
        EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
    )
    
    private val adapter = moshi.adapter(UserProfile::class.java)
    
    companion object {
        private const val KEY_USER_PROFILE = "user_profile"
    }
    
    /**
     * 保存用户画像
     * 添加异常处理确保数据安全
     */
    fun saveUserProfile(profile: UserProfile): Result<Unit> {
        return try {
            val json = adapter.toJson(profile.copy(updatedAt = System.currentTimeMillis()))
            encryptedPrefs.edit().putString(KEY_USER_PROFILE, json).apply()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(Exception("保存用户画像失败: ${e.message}", e))
        }
    }
    
    /**
     * 加载用户画像
     * 添加异常处理确保数据安全
     */
    fun loadUserProfile(): Result<UserProfile> {
        return try {
            val json = encryptedPrefs.getString(KEY_USER_PROFILE, null)
            val profile = if (json != null) {
                adapter.fromJson(json) ?: UserProfile()
            } else {
                UserProfile()
            }
            Result.success(profile)
        } catch (e: Exception) {
            Result.failure(Exception("加载用户画像失败: ${e.message}", e))
        }
    }
    
    /**
     * 清除用户画像
     * 添加异常处理确保数据安全
     */
    fun clearUserProfile(): Result<Unit> {
        return try {
            encryptedPrefs.edit().remove(KEY_USER_PROFILE).apply()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(Exception("清除用户画像失败: ${e.message}", e))
        }
    }
    
    /**
     * 导出用户画像数据
     * 返回JSON格式的用户画像数据
     */
    fun exportUserProfile(): Result<String> {
        return try {
            val profileResult = loadUserProfile()
            if (profileResult.isFailure) {
                return Result.failure(profileResult.exceptionOrNull() ?: Exception("加载用户画像失败"))
            }
            
            val profile = profileResult.getOrThrow()
            val json = adapter.toJson(profile)
            Result.success(json)
        } catch (e: Exception) {
            Result.failure(Exception("导出用户画像失败: ${e.message}", e))
        }
    }
    
    /**
     * 导入用户画像数据
     * 从JSON格式的字符串导入用户画像数据
     */
    fun importUserProfile(json: String): Result<Unit> {
        return try {
            val profile = adapter.fromJson(json) ?: UserProfile()
            saveUserProfile(profile)
        } catch (e: Exception) {
            Result.failure(Exception("导入用户画像失败: ${e.message}", e))
        }
    }
}
```


---

## 5. 交互设计

### 5.1 入口设计

#### 5.1.1 设置页面入口

| 属性 | 值 |
|------|-----|
| 位置 | 设置页面，AI服务商配置下方 |
| 图标 | Person图标 |
| 标题 | 个人画像 |
| 副标题 | 完整度: XX% |
| 点击行为 | 跳转到UserProfileScreen |

#### 5.1.2 入口UI设计

```
┌────────────────────────────────────────┐
│ 👤 个人画像                         >  │
│    完整度: 65%                         │
│    ████████░░░░                        │
└────────────────────────────────────────┘
```

### 5.2 主界面设计

#### 5.2.1 界面布局

```
┌────────────────────────────────────────┐
│ ← 个人画像                    [重置]   │
├────────────────────────────────────────┤
│                                        │
│  ┌────────────────────────────────┐   │
│  │ 画像完整度                      │   │
│  │ ████████████░░░░░░  65%        │   │
│  │ 已添加 12 个标签                │   │
│  └────────────────────────────────┘   │
│                                        │
│  ┌──────────────┬──────────────┐      │
│  │  基础信息    │  自定义维度   │      │
│  └──────────────┴──────────────┘      │
│                                        │
│  [标签页内容区域]                      │
│                                        │
└────────────────────────────────────────┘
```

#### 5.2.2 基础信息标签页

```
┌────────────────────────────────────────┐
│ 性格特点                           ▼   │
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌────┐    │
│ │ 内向 │ │ 理性 │ │ 细心 │ │ +  │    │
│ └──────┘ └──────┘ └──────┘ └────┘    │
│                                        │
│ 💡 建议标签: 外向 热情 乐观           │
├────────────────────────────────────────┤
│ 价值观                             ▼   │
│ ┌────────┐ ┌────────┐ ┌────┐         │
│ │重视家庭│ │追求事业│ │ +  │         │
│ └────────┘ └────────┘ └────┘         │
│                                        │
│ 💡 建议标签: 注重健康 珍惜友情        │
├────────────────────────────────────────┤
│ 兴趣爱好                           ▼   │
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌────┐    │
│ │ 阅读 │ │ 运动 │ │ 旅行 │ │ +  │    │
│ └──────┘ └──────┘ └──────┘ └────┘    │
├────────────────────────────────────────┤
│ 沟通风格                           ▼   │
│ ┌──────┐ ┌──────┐ ┌────┐             │
│ │ 直接 │ │ 幽默 │ │ +  │             │
│ └──────┘ └──────┘ └────┘             │
├────────────────────────────────────────┤
│ 社交偏好                           ▼   │
│ ┌────────┐ ┌────────┐ ┌────┐         │
│ │ 小群体 │ │深度交流│ │ +  │         │
│ └────────┘ └────────┘ └────┘         │
└────────────────────────────────────────┘
```

#### 5.2.3 自定义维度标签页

```
┌────────────────────────────────────────┐
│ 职业特点                          [×]  │
│ ┌──────┐ ┌────────┐ ┌────┐           │
│ │ 细心 │ │ 有耐心 │ │ +  │           │
│ └──────┘ └────────┘ └────┘           │
├────────────────────────────────────────┤
│ 情感状态                          [×]  │
│ ┌──────┐ ┌────┐                       │
│ │ 单身 │ │ +  │                       │
│ └──────┘ └────┘                       │
├────────────────────────────────────────┤
│                                        │
│         [+ 添加新维度]                 │
│                                        │
└────────────────────────────────────────┘
```

### 5.3 标签操作设计

#### 5.3.1 添加标签

| 触发方式 | 点击"+"按钮 |
|----------|-------------|
| 交互流程 | 显示输入对话框 → 输入标签 → 确认添加 |
| 预设建议 | 显示该维度的预设标签供快速选择 |
| 验证规则 | 1-20字符，不能重复 |

```
┌────────────────────────────────────────┐
│ 添加标签                               │
├────────────────────────────────────────┤
│ ┌────────────────────────────────────┐ │
│ │ [请输入标签内容_______________]   │ │
│ └────────────────────────────────────┘ │
│                                        │
│ 快速选择:                              │
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐  │
│ │ 外向 │ │ 热情 │ │ 乐观 │ │ 谨慎 │  │
│ └──────┘ └──────┘ └──────┘ └──────┘  │
│                                        │
│           [取消]  [添加]               │
└────────────────────────────────────────┘
```

#### 5.3.2 删除标签

| 触发方式 | 长按标签 或 点击标签上的×图标 |
|----------|-------------------------------|
| 交互流程 | 显示确认对话框 → 确认删除 |
| 动画效果 | 标签淡出消失 |

#### 5.3.3 编辑标签

| 触发方式 | 点击已有标签 |
|----------|-------------|
| 交互流程 | 显示编辑对话框 → 修改内容 → 确认保存 |
| 验证规则 | 同添加标签 |

#### 5.3.4 标签拖拽排序

| 交互状态 | 视觉反馈 | 触发条件 |
|----------|----------|----------|
| 长按触发 | 标签轻微放大+阴影 | 长按500ms |
| 拖拽中 | 标签半透明+拖拽阴影 | 手指移动 |
| 可放置位置 | 目标位置显示插入指示器 | 拖拽到其他标签上方 |
| 不可放置位置 | 显示禁止图标 | 拖拽到非目标区域 |

**拖拽交互细节**：
- **长按识别**：用户长按标签500ms后进入拖拽模式
- **视觉反馈**：标签放大1.1倍，添加阴影效果，透明度降至70%
- **拖拽指示器**：在目标位置显示蓝色插入线，指示标签将要放置的位置
- **边界处理**：拖拽到屏幕边界时自动滚动界面
- **释放确认**：松手时在目标位置插入标签，其他标签自动调整位置
- **取消操作**：拖拽到非目标区域或超出屏幕边界时取消拖拽

### 5.4 维度操作设计

#### 5.4.1 添加自定义维度

```
┌────────────────────────────────────────┐
│ 添加新维度                             │
├────────────────────────────────────────┤
│ ┌────────────────────────────────────┐ │
│ │ 维度名称                            │ │
│ │ [请输入维度名称_______________]   │ │
│ └────────────────────────────────────┘ │
│                                        │
│ 示例: 职业特点、情感状态、生活习惯    │
│                                        │
│           [取消]  [添加]               │
└────────────────────────────────────────┘
```

#### 5.4.2 删除自定义维度

| 触发方式 | 点击维度右侧的×图标 |
|----------|---------------------|
| 交互流程 | 显示确认对话框 → 确认删除（包含所有标签） |
| 限制 | 基础维度不可删除 |

### 5.5 导出功能设计

#### 5.5.1 导出界面

```
┌────────────────────────────────────────┐
│ 画像数据导出                           │
├────────────────────────────────────────┤
│ 选择导出格式:                          │
│ ○ JSON格式 (推荐)                      │
│ ○ 纯文本格式                          │
│                                        │
│ 导出内容:                              │
│ ☑ 基础维度数据                        │
│ ☑ 自定义维度数据                      │
│ ☑ 创建和更新时间                      │
│                                        │
│           [取消]  [导出]               │
└────────────────────────────────────────┘
```


---

## 6. 业务规则设计

### 6.1 输入验证规则

| 规则ID | 规则描述 | 处理方式 |
|--------|----------|----------|
| VR-001 | 标签内容不能为空 | 显示错误提示，禁用确认按钮 |
| VR-002 | 标签长度1-20字符 | 显示字数超限提示 |
| VR-003 | 同一维度内标签不能重复 | 提示"该标签已存在" |
| VR-004 | 维度名称不能为空 | 显示错误提示，禁用确认按钮 |
| VR-005 | 维度名称2-10字符 | 显示字数超限提示 |
| VR-006 | 自定义维度名称不能与基础维度重复 | 提示"该维度已存在" |
| VR-007 | 单个维度最多20个标签 | 提示"标签数量已达上限" |
| VR-008 | 自定义维度最多10个 | 提示"自定义维度已达上限" |

### 6.2 数据一致性规则

| 规则ID | 规则描述 | 处理方式 |
|--------|----------|----------|
| CR-001 | 每次修改必须更新updatedAt | 自动设置为当前时间 |
| CR-002 | 删除维度时同时删除所有标签 | 级联删除 |
| CR-003 | 画像数据变更后立即持久化 | 自动保存到EncryptedSharedPreferences |
| CR-004 | 空画像不影响AI分析 | 跳过用户画像上下文 |
| CR-005 | 数据操作失败必须提供用户反馈 | 显示错误提示和重试选项 |

### 6.3 AI上下文集成规则

| 规则ID | 规则描述 | 处理方式 |
|--------|----------|----------|
| AI-001 | 用户画像优先级高于联系人画像 | 上下文中先展示用户画像 |
| AI-002 | 空维度不加入上下文 | 跳过无标签的维度 |
| AI-003 | 上下文长度限制 | 最多包含50个标签信息 |
| AI-004 | 智能筛选相关信息 | 根据对话内容筛选相关维度 |

---

## 7. 组件设计

### 7.1 UI组件清单

| 组件名称 | 类型 | 职责 |
|----------|------|------|
| UserProfileScreen | Composable | 用户画像主界面 |
| ProfileCompletenessCard | Composable | 画像完整度卡片 |
| DimensionCard | Composable | 维度卡片（可展开/收起） |
| TagChipGroup | Composable | 标签组显示 |
| AddTagDialog | Composable | 添加标签对话框 |
| EditTagDialog | Composable | 编辑标签对话框 |
| AddDimensionDialog | Composable | 添加维度对话框 |
| DeleteConfirmDialog | Composable | 删除确认对话框 |
| PresetTagSelector | Composable | 预设标签选择器 |
| ExportProfileDialog | Composable | 导出画像对话框 |

### 7.2 业务组件清单

| 组件名称 | 层级 | 职责 |
|----------|------|------|
| UserProfileRepository | Domain | 用户画像仓库接口 |
| UserProfileRepositoryImpl | Data | 用户画像仓库实现 |
| UserProfilePreferences | Data | 用户画像本地加密存储 |
| GetUserProfileUseCase | Domain | 获取用户画像 |
| UpdateUserProfileUseCase | Domain | 更新用户画像 |
| UserProfileContextBuilder | Domain | 用户画像上下文构建器 |
| UserProfileExporter | Domain | 用户画像导出器 |

### 7.3 组件交互图

```
┌─────────────────────────────────────────────────────────────┐
│                     Presentation Layer                       │
│  ┌─────────────────┐    ┌─────────────────┐                 │
│  │ UserProfile     │───→│ UserProfile     │                 │
│  │ Screen          │    │ ViewModel       │                 │
│  └─────────────────┘    └─────────────────┘                 │
│         │                       │                           │
│         ▼                       ▼                           │
│  ┌─────────────────┐    ┌─────────────────┐                 │
│  │ DimensionCard   │    │ UiState/Event   │                 │
│  │ TagChipGroup    │    │ 状态管理        │                 │
│  │ ExportDialog    │    │                 │                 │
│  └─────────────────┘    └─────────────────┘                 │
└────────────────────────────┼────────────────────────────────┘
                              │
┌────────────────────────────┼────────────────────────────────┐
│                     Domain Layer                             │
│                            ▼                                │
│  ┌─────────────────┐    ┌─────────────────┐                 │
│  │ GetUserProfile  │    │ UpdateUserProfile│                │
│  │ UseCase         │    │ UseCase          │                │
│  │ ExportProfile   │    │ ContextBuilder   │                │
│  │ UseCase         │    │                 │                │
│  └─────────────────┘    └─────────────────┘                 │
│         │                       │                           │
│         └───────────┬───────────┘                           │
│                     ▼                                       │
│         ┌─────────────────────┐                             │
│         │ UserProfileRepository│                             │
│         │ (接口)               │                             │
│         └─────────────────────┘                             │
└────────────────────────────┼────────────────────────────────┘
                              │
┌────────────────────────────┼────────────────────────────────┐
│                     Data Layer                               │
│                            ▼                                │
│         ┌─────────────────────┐                             │
│         │ UserProfileRepository│                             │
│         │ Impl                 │                             │
│         └─────────────────────┘                             │
│                     │                                       │
│                     ▼                                       │
│         ┌─────────────────────┐                             │
│         │ UserProfilePreferences│                            │
│         │ (EncryptedSharedPreferences) │                   │
│         └─────────────────────┘                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.4 ViewModel设计

```kotlin
/**
 * 用户画像ViewModel
 */
@HiltViewModel
class UserProfileViewModel @Inject constructor(
    private val getUserProfileUseCase: GetUserProfileUseCase,
    private val updateUserProfileUseCase: UpdateUserProfileUseCase,
    private val exportProfileUseCase: ExportProfileUseCase
) : ViewModel() {

    private val _uiState = MutableStateFlow(UserProfileUiState())
    val uiState: StateFlow<UserProfileUiState> = _uiState.asStateFlow()

    init {
        loadUserProfile()
    }

    fun onEvent(event: UserProfileUiEvent) {
        when (event) {
            is UserProfileUiEvent.AddTag -> addTag(event.dimension, event.tag)
            is UserProfileUiEvent.RemoveTag -> removeTag(event.dimension, event.tag)
            is UserProfileUiEvent.EditTag -> editTag(event.dimension, event.oldTag, event.newTag)
            is UserProfileUiEvent.AddCustomDimension -> addCustomDimension(event.name)
            is UserProfileUiEvent.RemoveCustomDimension -> removeCustomDimension(event.name)
            is UserProfileUiEvent.ResetProfile -> resetProfile()
            is UserProfileUiEvent.SwitchTab -> switchTab(event.tabIndex)
            is UserProfileUiEvent.ExportProfile -> exportProfile()
        }
    }
    
    // ... 具体实现
}
```

### 7.5 UiState设计

```kotlin
/**
 * 用户画像UI状态
 */
data class UserProfileUiState(
    val profile: UserProfile = UserProfile(),
    val selectedTabIndex: Int = 0,
    val isLoading: Boolean = false,
    val error: String? = null,
    val showAddTagDialog: Boolean = false,
    val showAddDimensionDialog: Boolean = false,
    val showExportDialog: Boolean = false,
    val currentEditDimension: String? = null,
    val currentEditTag: String? = null
) {
    val completeness: Int get() = profile.getCompleteness()
    val totalTagCount: Int get() = profile.getTotalTagCount()
    val isEmpty: Boolean get() = profile.isEmpty()
}

/**
 * 用户画像UI事件
 */
sealed class UserProfileUiEvent {
    data class AddTag(val dimension: String, val tag: String) : UserProfileUiEvent()
    data class RemoveTag(val dimension: String, val tag: String) : UserProfileUiEvent()
    data class EditTag(val dimension: String, val oldTag, val newTag: String) : UserProfileUiEvent()
    data class AddCustomDimension(val name: String) : UserProfileUiEvent()
    data class RemoveCustomDimension(val name: String) : UserProfileUiEvent()
    object ResetProfile : UserProfileUiEvent()
    data class SwitchTab(val tabIndex: Int) : UserProfileUiEvent()
    object ExportProfile : UserProfileUiEvent()
}
```


---

## 8. AI上下文集成设计

### 8.1 上下文构建策略

```kotlin
/**
 * 用户画像上下文构建器
 * 将用户画像信息整合到AI分析提示词中
 */
class UserProfileContextBuilder @Inject constructor(
    private val userProfileRepository: UserProfileRepository
) {
    /**
     * 构建包含用户画像的分析上下文
     * 添加错误处理确保上下文构建的稳定性
     */
    suspend fun buildAnalysisContext(
        contact: ContactProfile,
        userInput: String
    ): Result<String> {
        return try {
            val userProfileResult = userProfileRepository.getUserProfile()
            if (userProfileResult.isFailure) {
                return Result.failure(Exception("获取用户画像失败: ${userProfileResult.exceptionOrNull()?.message}"))
            }
            
            val userProfile = userProfileResult.getOrThrow()
            
            val context = buildString {
                // 1. 用户画像信息（优先级最高）
                if (!userProfile.isEmpty()) {
                    appendLine("【用户画像（你的特点）】")
                    appendUserProfileSection(userProfile)
                    appendLine()
                }
                
                // 2. 联系人信息
                appendLine("【联系人信息】")
                appendContactSection(contact)
                appendLine()
                
                // 3. 用户输入的聊天记录
                appendLine("【用户提供的聊天记录】")
                appendLine(userInput)
            }
            
            Result.success(context)
        } catch (e: Exception) {
            Result.failure(Exception("构建分析上下文失败: ${e.message}", e))
        }
    }
    
    private fun StringBuilder.appendUserProfileSection(profile: UserProfile) {
        if (profile.personalityTraits.isNotEmpty()) {
            appendLine("- 性格特点: ${profile.personalityTraits.joinToString("、")}")
        }
        if (profile.values.isNotEmpty()) {
            appendLine("- 价值观: ${profile.values.joinToString("、")}")
        }
        if (profile.interests.isNotEmpty()) {
            appendLine("- 兴趣爱好: ${profile.interests.joinToString("、")}")
        }
        if (profile.communicationStyle.isNotEmpty()) {
            appendLine("- 沟通风格: ${profile.communicationStyle.joinToString("、")}")
        }
        if (profile.socialPreferences.isNotEmpty()) {
            appendLine("- 社交偏好: ${profile.socialPreferences.joinToString("、")}")
        }
        // 自定义维度
        profile.customDimensions.forEach { (dimension, tags) ->
            if (tags.isNotEmpty()) {
                appendLine("- $dimension: ${tags.joinToString("、")}")
            }
        }
    }
}
```

### 8.2 智能筛选算法

```kotlin
/**
 * 根据对话内容智能筛选相关的用户画像信息
 * 增强算法，支持更复杂的匹配逻辑
 */
fun filterRelevantProfileInfo(
    profile: UserProfile,
    chatContent: String
): UserProfile {
    // 1. 关键词匹配规则（基础匹配）
    val keywordRelevanceRules = mapOf(
        "工作" to listOf("values", "communicationStyle"),
        "职场" to listOf("values", "communicationStyle"),
        "同事" to listOf("values", "communicationStyle"),
        "朋友" to listOf("socialPreferences", "interests"),
        "聚会" to listOf("socialPreferences", "interests"),
        "家人" to listOf("values", "personalityTraits"),
        "父母" to listOf("values", "personalityTraits"),
        "约会" to listOf("interests", "communicationStyle", "personalityTraits"),
        "恋爱" to listOf("interests", "communicationStyle", "personalityTraits"),
        "学习" to listOf("interests", "personalityTraits"),
        "运动" to listOf("interests", "socialPreferences"),
        "旅行" to listOf("interests", "socialPreferences")
    )
    
    // 2. 情感分析匹配
    val emotionKeywords = mapOf(
        "开心" to listOf("personalityTraits", "interests"),
        "难过" to listOf("personalityTraits", "values"),
        "生气" to listOf("personalityTraits", "communicationStyle"),
        "焦虑" to listOf("personalityTraits", "socialPreferences"),
        "兴奋" to listOf("interests", "communicationStyle")
    )
    
    // 3. 场景匹配
    val scenarioKeywords = mapOf(
        "会议" to listOf("communicationStyle", "values"),
        "演讲" to listOf("communicationStyle", "personalityTraits"),
        "谈判" to listOf("communicationStyle", "values"),
        "面试" to listOf("communicationStyle", "values", "personalityTraits"),
        "聚餐" to listOf("socialPreferences", "interests"),
        "旅行" to listOf("interests", "socialPreferences"),
        "看电影" to listOf("interests", "socialPreferences")
    )
    
    // 合并所有匹配规则
    val allRelevanceRules = keywordRelevanceRules + emotionKeywords + scenarioKeywords
    
    // 4. 根据聊天内容匹配相关维度
    val relevantDimensions = mutableSetOf<String>()
    val chatContentLower = chatContent.lowercase()
    
    allRelevanceRules.forEach { (keyword, dimensions) ->
        if (chatContentLower.contains(keyword.lowercase())) {
            relevantDimensions.addAll(dimensions)
        }
    }
    
    // 5. 如果没有匹配到特定维度，返回完整画像
    if (relevantDimensions.isEmpty()) {
        return profile
    }
    
    // 6. 返回筛选后的画像
    return profile.copy(
        personalityTraits = if ("personalityTraits" in relevantDimensions) 
            profile.personalityTraits else emptyList(),
        values = if ("values" in relevantDimensions) 
            profile.values else emptyList(),
        interests = if ("interests" in relevantDimensions) 
            profile.interests else emptyList(),
        communicationStyle = if ("communicationStyle" in relevantDimensions) 
            profile.communicationStyle else emptyList(),
        socialPreferences = if ("socialPreferences" in relevantDimensions) 
            profile.socialPreferences else emptyList()
    )
}
```

### 8.3 与现有系统集成

#### 8.3.1 AnalyzeChatUseCase集成

```kotlin
/**
 * 修改AnalyzeChatUseCase，集成用户画像上下文
 */
class AnalyzeChatUseCase @Inject constructor(
    private val aiRepository: AiRepository,
    private val contactRepository: ContactRepository,
    private val userProfileContextBuilder: UserProfileContextBuilder  // 新增
) {
    suspend operator fun invoke(
        contactId: String,
        chatContent: String
    ): Result<AnalysisResult> {
        // 1. 获取联系人信息
        val contact = contactRepository.getContactById(contactId)
            ?: return Result.failure(Exception("联系人不存在"))
        
        // 2. 使用新的上下文构建器，添加错误处理
        val contextResult = userProfileContextBuilder.buildAnalysisContext(
            contact = contact,
            userInput = chatContent
        )
        
        if (contextResult.isFailure) {
            return Result.failure(Exception("构建分析上下文失败: ${contextResult.exceptionOrNull()?.message}"))
        }
        
        val context = contextResult.getOrThrow()
        
        // 3. 发送AI请求
        return aiRepository.analyzeChat(context)
    }
}
```

#### 8.3.2 系统提示词增强

```kotlin
/**
 * 增强系统提示词，引导AI利用用户画像
 */
object SystemPrompts {
    val ANALYSIS_WITH_USER_PROFILE = """
        你是一个专业的社交沟通顾问。在分析对话时，请注意：
        
        1. 【用户画像】部分描述了用户（提问者）的性格特点和偏好
        2. 请根据用户的性格特点，提供符合其风格的建议
        3. 考虑用户的沟通风格，给出适合的表达方式
        4. 结合用户的价值观，确保建议不违背其原则
        
        请基于以上信息，提供个性化的沟通建议。
    """.trimIndent()
}
```

### 8.4 导出功能实现

```kotlin
/**
 * 用户画像导出用例
 */
class ExportProfileUseCase @Inject constructor(
    private val userProfileRepository: UserProfileRepository
) {
    suspend operator fun invoke(
        format: ExportFormat = ExportFormat.JSON,
        includeMetadata: Boolean = true
    ): Result<String> {
        return try {
            val profileResult = userProfileRepository.getUserProfile()
            if (profileResult.isFailure) {
                return Result.failure(profileResult.exceptionOrNull() ?: Exception("获取用户画像失败"))
            }
            
            val profile = profileResult.getOrThrow()
            
            when (format) {
                ExportFormat.JSON -> {
                    val moshi = Moshi.Builder().build()
                    val adapter = moshi.adapter(UserProfile::class.java)
                    val json = adapter.toJson(profile)
                    Result.success(json)
                }
                ExportFormat.TEXT -> {
                    val text = buildString {
                        appendLine("=== 用户画像 ===")
                        appendLine("性格特点: ${profile.personalityTraits.joinToString("、")}")
                        appendLine("价值观: ${profile.values.joinToString("、")}")
                        appendLine("兴趣爱好: ${profile.interests.joinToString("、")}")
                        appendLine("沟通风格: ${profile.communicationStyle.joinToString("、")}")
                        appendLine("社交偏好: ${profile.socialPreferences.joinToString("、")}")
                        
                        if (includeMetadata) {
                            appendLine()
                            appendLine("=== 元数据 ===")
                            appendLine("创建时间: ${Date(profile.createdAt)}")
                            appendLine("更新时间: ${Date(profile.updatedAt)}")
                        }
                        
                        profile.customDimensions.forEach { (dimension, tags) ->
                            appendLine("$dimension: ${tags.joinToString("、")}")
                        }
                    }
                    Result.success(text)
                }
            }
        } catch (e: Exception) {
            Result.failure(Exception("导出用户画像失败: ${e.message}", e))
        }
    }
}

/**
 * 导出格式枚举
 */
enum class ExportFormat {
    JSON,
    TEXT
}
```


---

## 9. 异常处理设计

### 9.1 错误分类与处理

| 错误类型 | 错误码 | 用户提示 | 处理策略 |
|----------|--------|----------|----------|
| 标签为空 | E001 | 标签内容不能为空 | 禁用确认按钮 |
| 标签过长 | E002 | 标签不能超过20字 | 显示字数提示 |
| 标签重复 | E003 | 该标签已存在 | Toast提示 |
| 维度为空 | E004 | 维度名称不能为空 | 禁用确认按钮 |
| 维度重复 | E005 | 该维度已存在 | Toast提示 |
| 保存失败 | E006 | 保存失败，请重试 | 提供重试按钮 |
| 数据加载失败 | E007 | 加载失败，请重试 | 显示重试界面 |
| 导出失败 | E008 | 导出失败，请重试 | 提供重试按钮 |
| 加密存储失败 | E009 | 数据存储异常，请重试 | 提供重试按钮 |

### 9.2 异常处理场景

| 场景 | 错误提示 | 恢复策略 |
|------|----------|----------|
| 网络异常 | "网络连接异常，已保存到本地" | 自动重试机制，最多3次 |
| 存储空间不足 | "存储空间不足，请清理后重试" | 引导用户清理缓存，提供一键清理按钮 |
| 数据损坏 | "画像数据异常，已恢复到上次备份" | 自动恢复备份，如备份失败则重置为默认 |
| 操作超时 | "操作超时，请重试" | 提供重试按钮，增加超时时间阈值 |
| 加密失败 | "数据加密异常，已启用安全模式" | 降级到非加密模式，提供手动重试 |
| 内存不足 | "内存不足，已释放部分缓存" | 自动清理非必要缓存，释放内存 |

### 9.3 用户反馈设计

| 场景 | 反馈方式 | 持续时间 |
|------|----------|----------|
| 添加标签成功 | 标签动画出现 | 300ms |
| 删除标签成功 | 标签动画消失 | 300ms |
| 保存成功 | Toast "已保存" | 2秒 |
| 验证失败 | 输入框下方错误提示 | 持续显示 |
| 重置成功 | Toast "已重置" | 2秒 |
| 导出成功 | Toast "导出成功" | 2秒 |
| 网络恢复 | Toast "网络连接已恢复" | 2秒 |
| 数据恢复 | Toast "数据已恢复到备份" | 3秒 |

### 9.4 错误恢复机制

#### 自动恢复策略
- **数据备份**：每次修改前自动创建备份，最多保留5个历史版本
- **增量保存**：采用增量保存策略，减少数据丢失风险
- **崩溃恢复**：应用异常退出后自动恢复到上次保存状态

#### 手动恢复选项
- **历史版本回退**：用户可选择回退到任一历史版本
- **数据导入**：支持从之前导出的JSON文件恢复数据
- **重置功能**：提供完全重置选项，清空所有画像数据


---

## 10. 性能设计

### 10.1 性能指标

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 界面加载时间 | < 300ms | 从点击到界面完全显示 |
| 标签操作响应 | < 100ms | 从点击到UI更新 |
| 数据保存时间 | < 200ms | EncryptedSharedPreferences写入 |
| AI上下文构建 | < 50ms | 画像数据序列化 |
| 内存占用 | < 5MB | 画像数据内存占用 |

### 10.2 优化策略

#### 10.2.1 数据缓存

```kotlin
/**
 * 内存缓存用户画像数据
 */
@Singleton
class UserProfileCache @Inject constructor() {
    private var cachedProfile: UserProfile? = null
    private var lastLoadTime: Long = 0
    
    fun get(): UserProfile? = cachedProfile
    
    fun set(profile: UserProfile) {
        cachedProfile = profile
        lastLoadTime = System.currentTimeMillis()
    }
    
    fun invalidate() {
        cachedProfile = null
    }
    
    fun isValid(): Boolean {
        return cachedProfile != null && 
               System.currentTimeMillis() - lastLoadTime < 60_000 // 1分钟有效期
    }
}
```

#### 10.2.2 懒加载自定义维度

```kotlin
/**
 * 自定义维度懒加载
 */
@Composable
fun CustomDimensionsSection(
    dimensions: Map<String, List<String>>,
    onAddTag: (String, String) -> Unit,
    onRemoveTag: (String, String) -> Unit
) {
    // 仅在切换到自定义维度标签页时加载
    var isExpanded by remember { mutableStateOf(false) }
    
    LaunchedEffect(isExpanded) {
        if (isExpanded) {
            // 加载自定义维度数据
        }
    }
}
```


---

## 11. 验收标准

### 11.1 功能验收

#### P0 - 核心功能（必须通过）

- [ ] 可以查看用户画像界面
- [ ] 可以添加基础维度标签
- [ ] 可以删除基础维度标签
- [ ] 可以添加自定义维度
- [ ] 可以删除自定义维度
- [ ] 画像完整度正确计算
- [ ] 数据正确保存到本地加密存储
- [ ] AI分析时正确集成用户画像
- [ ] 可以导出用户画像数据

#### P1 - 增强功能（应该通过）

- [ ] 可以编辑已有标签
- [ ] 预设标签可快速选择
- [ ] 输入验证规则正确执行
- [ ] 标签页切换流畅
- [ ] 重置功能正常工作
- [ ] 导出功能支持多种格式

#### P2 - 优化功能（可以通过）

- [ ] 界面加载流畅
- [ ] 操作响应及时
- [ ] 错误提示友好

### 11.2 性能验收

- [ ] 界面加载时间 < 300ms
- [ ] 标签操作响应 < 100ms
- [ ] 数据保存时间 < 200ms
- [ ] 内存占用 < 5MB

### 11.3 兼容性验收

- [ ] 与现有设置页面兼容
- [ ] 与AI分析功能兼容
- [ ] 不同屏幕尺寸适配正常
- [ ] Android 7.0+设备正常运行


---

## 12. 开发优先级

### 12.1 阶段划分

#### 阶段一：数据层实现（1天）

| 任务 | 优先级 | 预估工时 |
|------|--------|----------|
| UserProfile领域模型 | P0 | 1h |
| UserProfileDimension枚举 | P0 | 0.5h |
| UserProfilePreferences加密存储 | P0 | 2h |
| UserProfileRepository接口 | P0 | 0.5h |
| UserProfileRepositoryImpl实现 | P0 | 1h |
| 数据层单元测试 | P0 | 1.5h |

#### 阶段二：业务层实现（1天）

| 任务 | 优先级 | 预估工时 |
|------|--------|----------|
| GetUserProfileUseCase | P0 | 1h |
| UpdateUserProfileUseCase | P0 | 1.5h |
| UserProfileContextBuilder | P0 | 2h |
| ExportProfileUseCase | P0 | 1.5h |
| AnalyzeChatUseCase集成 | P0 | 1h |
| 业务层单元测试 | P0 | 1.5h |

#### 阶段三：UI层实现（2天）

| 任务 | 优先级 | 预估工时 |
|------|--------|----------|
| UserProfileViewModel | P0 | 2h |
| UserProfileUiState/Event | P0 | 1h |
| UserProfileScreen主界面 | P0 | 3h |
| ProfileCompletenessCard | P0 | 1h |
| DimensionCard组件 | P0 | 2h |
| TagChipGroup组件 | P0 | 1.5h |
| AddTagDialog | P0 | 1.5h |
| AddDimensionDialog | P0 | 1h |
| ExportProfileDialog | P0 | 1.5h |
| PresetTagSelector | P1 | 1.5h |
| 设置页面入口集成 | P0 | 1h |

#### 阶段四：测试与优化（1天）

| 任务 | 优先级 | 预估工时 |
|------|--------|----------|
| ViewModel单元测试 | P0 | 2h |
| UI组件测试 | P1 | 1.5h |
| 集成测试 | P1 | 1.5h |
| 性能优化 | P2 | 1h |
| Bug修复 | P0 | 1h |

### 12.2 依赖关系

```
阶段一（数据层）
  │
  ├── UserProfile模型 ────────┐
  │                           │
  ├── UserProfilePreferences ─┼──→ 阶段二（业务层）
  │                           │      │
  └── Repository接口/实现 ────┘      │
                                     │
                               ┌─────┘
                               │
阶段二（业务层）               ▼
  │
  ├── UseCase实现 ────────────┐
  │                           │
  ├── ContextBuilder ─────────┼──→ 阶段三（UI层）
  │                           │
  ├── ExportProfileUseCase ────┘
  │                           │
  └── AI集成 ─────────────────┘
                               │
                               │
阶段三（UI层）                 ▼
  │
  ├── ViewModel ──────────────┐
  │                           │
  ├── Screen/组件 ────────────┼──→ 阶段四（测试）
  │                           │
  └── 设置页面集成 ───────────┘
```


---

## 13. 风险评估

### 13.1 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| EncryptedSharedPreferences数据丢失 | 低 | 高 | 定期备份，异常处理 |
| AI上下文过长 | 中 | 中 | 智能筛选，长度限制 |
| 性能影响 | 低 | 中 | 缓存优化，懒加载 |
| 与现有功能冲突 | 低 | 中 | 充分测试，渐进式发布 |

### 13.2 产品风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 用户填写意愿低 | 中 | 高 | 简化流程，预设标签 |
| 画像质量不高 | 高 | 中 | 填写指导，示例引导 |
| 用户理解偏差 | 中 | 中 | 详细说明，帮助文档 |


---

## 14. 附录

### 14.1 术语表

| 术语 | 定义 |
|------|------|
| 用户画像 | 用户在社交互动中的性格特点、价值观等信息的集合 |
| 基础维度 | 系统预设的五个画像维度（性格、价值观、兴趣、沟通风格、社交偏好） |
| 自定义维度 | 用户根据个人需求添加的画像维度 |
| 上下文构建 | 将用户画像信息整合到AI分析提示词中的过程 |
| 画像完整度 | 用户画像填写程度的百分比指标 |
| 加密存储 | 使用EncryptedSharedPreferences对敏感数据进行加密存储 |

### 14.2 参考文档

- [PRD-00013-自己画像界面产品需求文档](../PRD/PRD-00013-自己画像界面产品需求文档.md)
- [TDD-00013-自己画像界面技术设计.md](../TDD/TDD-00013-自己画像界面技术设计.md)
- [TDD-00003-联系人画像记忆系统架构设计](../TDD/TDD-00003-联系人画像记忆系统架构设计.md)
- [FD-00004-联系人画像记忆系统UI功能设计](./FD-00004-联系人画像记忆系统UI功能设计.md)

### 14.3 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2025-12-21 | 初始版本 | Kiro |
| v1.1 | 2025-12-21 | 修复宪法对齐问题：将SharedPreferences改为EncryptedSharedPreferences；补充画像导出功能设计；增强智能筛选算法；统一界面设计；补充错误处理 | Kiro |

---

**文档结束**