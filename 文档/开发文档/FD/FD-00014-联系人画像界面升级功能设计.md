# FD-00014: 联系人画像界面升级功能设计

---
**文档类型**: FD (Functional Design) - 开发过程文档  
**存放规范**: 符合项目宪法第IV条 - 文档规范  
**版本控制**: Git管理，见.commit钩子  
---

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | FD (Functional Design) |
| 文档编号 | FD-00014 |
| 功能名称 | 联系人画像界面升级 |
| 版本 | 1.0 |
| 创建日期 | 2025-12-21 |
| 最后更新 | 2025-12-21 |
| 作者 | Kiro |
| 审核人 | 待定 |
| 关联文档 | PRD-00014, TD-00014 |

---

## 2. 功能概述

### 2.1 功能目标

升级联系人画像界面（Persona Tab），使其成为一个动态、交互丰富、视觉友好的个性化信息中心：
1. **动态分类展示**：基于Fact Key自动分组，不再限制于预设的"雷区标签"和"策略标签"
2. **高效管理能力**：提供搜索、多选、批量操作等功能
3. **视觉体验提升**：引入动态配色系统和流畅的布局动画

### 2.2 功能边界

| 包含 (V1) | 不包含 (V2规划) |
|-----------|-----------------|
| 基于Fact Key的动态分组展示 | AI自动标签推荐 |
| 分类动态配色系统 | 标签关联分析 |
| 标签搜索与实时过滤 | 标签使用统计 |
| 长按进入编辑模式 | 标签云可视化 |
| 批量选择与删除 | 跨联系人标签对比 |
| 批量修改分类（Key） | 标签导入导出 |
| 单个标签编辑 | 标签模板功能 |
| 分类折叠/展开 | 标签历史记录 |


---

## 3. 功能流程设计

### 3.1 整体流程图

```
┌─────────────────────────────────────────────────────────────┐
│                 联系人画像界面升级整体流程                    │
└─────────────────────────────────────────────────────────────┘

  ┌──────────────┐
  │ 联系人详情页 │ ← 用户点击"标签画像"Tab
  └──────────────┘
         │
         ▼
  ┌──────────────┐     有标签数据?
  │ PersonaTab   │ ─────────────────────────────────────┐
  └──────────────┘        否                            │
         │                                              │
         │ 是                                           ▼
         ▼                                    ┌──────────────┐
  ┌──────────────┐                            │ 显示空状态   │
  │ 加载标签数据 │                            │ 引导添加标签 │
  └──────────────┘                            └──────────────┘
         │
         │ 按Key分组
         ▼
  ┌──────────────┐
  │ 动态分组展示 │
  │ 分配分类颜色 │
  └──────────────┘
         │
         │ 用户操作
         ▼
  ┌──────────────────────────────────────────────────────────┐
  │                    用户交互分支                           │
  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
  │  │ 搜索标签    │  │ 长按标签    │  │ 点击标签    │      │
  │  └─────────────┘  └─────────────┘  └─────────────┘      │
  │        │                │                │              │
  │        ▼                ▼                ▼              │
  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
  │  │ 实时过滤    │  │ 进入编辑模式│  │ 查看/编辑   │      │
  │  │ 显示结果    │  │ 批量操作    │  │ 标签详情    │      │
  │  └─────────────┘  └─────────────┘  └─────────────┘      │
  └──────────────────────────────────────────────────────────┘
```

### 3.2 动态分组展示流程

```
  加载联系人Facts数据
         │
         ▼
  ┌──────────────┐
  │ 提取所有Key  │
  │ 去重排序     │
  └──────────────┘
         │
         ▼
  ┌──────────────┐
  │ 按Key分组    │
  │ Facts列表    │
  └──────────────┘
         │
         ▼
  ┌──────────────┐
  │ 为每个分类   │
  │ 分配颜色     │
  └──────────────┘
         │
         ▼
  ┌──────────────────────────────────────┐
  │           分类展示区域                │
  │  ┌────────────────────────────────┐  │
  │  │ 🔴 性格特点                 ▼  │  │
  │  │ [内向] [理性] [细心]          │  │
  │  └────────────────────────────────┘  │
  │  ┌────────────────────────────────┐  │
  │  │ 🟢 兴趣爱好                 ▼  │  │
  │  │ [阅读] [运动] [旅行]          │  │
  │  └────────────────────────────────┘  │
  │  ┌────────────────────────────────┐  │
  │  │ 🔵 工作信息                 ▼  │  │
  │  │ [程序员] [互联网行业]         │  │
  │  └────────────────────────────────┘  │
  └──────────────────────────────────────┘
```

### 3.3 搜索过滤流程

```
  用户输入搜索关键词
         │
         ▼
  ┌──────────────┐
  │ 实时监听输入 │
  │ 防抖300ms    │
  └──────────────┘
         │
         ▼
  ┌──────────────┐     关键词为空?      ┌──────────────┐
  │ 检查关键词   │ ─────────────────→   │ 显示全部标签 │
  └──────────────┘        是            └──────────────┘
         │
         │ 否
         ▼
  ┌──────────────┐
  │ 匹配标签内容 │
  │ 匹配分类名称 │
  └──────────────┘
         │
         ▼
  ┌──────────────┐     有匹配结果?      ┌──────────────┐
  │ 过滤结果     │ ─────────────────→   │ 显示空搜索   │
  └──────────────┘        否            │ 结果提示     │
         │                              └──────────────┘
         │ 是
         ▼
  ┌──────────────┐
  │ 显示匹配标签 │
  │ 高亮关键词   │
  └──────────────┘
```

### 3.4 编辑模式流程

```
  用户长按任意标签
         │
         ▼
  ┌──────────────┐
  │ 触发震动反馈 │
  │ 进入编辑模式 │
  └──────────────┘
         │
         ▼
  ┌──────────────────────────────────────┐
  │           编辑模式界面                │
  │  ┌────────────────────────────────┐  │
  │  │ 已选择 0 项          [取消]   │  │
  │  └────────────────────────────────┘  │
  │                                      │
  │  ┌────────────────────────────────┐  │
  │  │ 性格特点              [全选]  │  │
  │  │ [☐内向] [☐理性] [☐细心]      │  │
  │  └────────────────────────────────┘  │
  │                                      │
  │  ┌────────────────────────────────┐  │
  │  │ 🗑️删除    📁移动分类          │  │
  │  └────────────────────────────────┘  │
  └──────────────────────────────────────┘
         │
         │ 用户选择操作
         ▼
  ┌──────────────────────────────────────────────────────────┐
  │                    批量操作分支                           │
  │  ┌─────────────┐              ┌─────────────┐            │
  │  │ 批量删除    │              │ 批量移动    │            │
  │  └─────────────┘              └─────────────┘            │
  │        │                            │                    │
  │        ▼                            ▼                    │
  │  ┌─────────────┐              ┌─────────────┐            │
  │  │ 确认对话框  │              │ 选择目标分类│            │
  │  │ 二次确认    │              │ 对话框      │            │
  │  └─────────────┘              └─────────────┘            │
  │        │                            │                    │
  │        ▼                            ▼                    │
  │  ┌─────────────┐              ┌─────────────┐            │
  │  │ 执行删除    │              │ 执行移动    │            │
  │  │ 更新数据库  │              │ 更新Key     │            │
  │  └─────────────┘              └─────────────┘            │
  └──────────────────────────────────────────────────────────┘
         │
         ▼
  ┌──────────────┐
  │ 退出编辑模式 │
  │ 刷新UI显示   │
  └──────────────┘
```


---

## 4. 数据模型设计

### 4.1 现有Fact模型（无需修改）

```kotlin
/**
 * 事实模型 - 已存在于domain/model/Fact.kt
 * 本次升级复用现有模型，无需修改
 */
data class Fact(
    val id: String = UUID.randomUUID().toString(),
    val key: String,           // 分类键，如"性格特点"、"兴趣爱好"
    val value: String,         // 标签值，如"内向"、"阅读"
    val timestamp: Long,
    val source: FactSource,
    val isUserModified: Boolean = false,
    val lastModifiedTime: Long = timestamp,
    val originalKey: String? = null,
    val originalValue: String? = null
)
```

### 4.2 分类分组模型（新增）

```kotlin
/**
 * 标签分类分组
 * 用于UI层展示动态分组后的标签
 */
data class FactCategory(
    val key: String,                    // 分类名称（Fact的Key）
    val facts: List<Fact>,              // 该分类下的所有标签
    val color: CategoryColor,           // 分类颜色
    val isExpanded: Boolean = true      // 是否展开
) {
    val factCount: Int get() = facts.size
    val isEmpty: Boolean get() = facts.isEmpty()
}

/**
 * 分类颜色
 * 包含标题颜色和标签背景色
 */
data class CategoryColor(
    val titleColor: Color,              // 分类标题颜色
    val tagBackgroundColor: Color,      // 标签背景色
    val tagTextColor: Color             // 标签文字颜色
)
```

### 4.3 编辑模式状态模型（新增）

```kotlin
/**
 * 编辑模式状态
 */
data class EditModeState(
    val isActive: Boolean = false,              // 是否处于编辑模式
    val selectedFactIds: Set<String> = emptySet(), // 已选中的Fact ID集合
    val showDeleteConfirm: Boolean = false,     // 是否显示删除确认对话框
    val showMoveDialog: Boolean = false         // 是否显示移动分类对话框
) {
    val selectedCount: Int get() = selectedFactIds.size
    val hasSelection: Boolean get() = selectedFactIds.isNotEmpty()
}
```

### 4.4 搜索状态模型（新增）

```kotlin
/**
 * 搜索状态
 */
data class SearchState(
    val query: String = "",                     // 搜索关键词
    val isSearching: Boolean = false,           // 是否正在搜索
    val filteredCategories: List<FactCategory> = emptyList() // 过滤后的分类
) {
    val hasQuery: Boolean get() = query.isNotBlank()
    val hasResults: Boolean get() = filteredCategories.isNotEmpty()
}
```

### 4.5 颜色调色板（新增）

```kotlin
/**
 * Pastel色系调色板
 * 用于动态分配给不同分类
 */
object CategoryColorPalette {
    
    private val lightColors = listOf(
        CategoryColor(
            titleColor = Color(0xFFE57373),     // 红色系
            tagBackgroundColor = Color(0xFFFFEBEE),
            tagTextColor = Color(0xFFC62828)
        ),
        CategoryColor(
            titleColor = Color(0xFF81C784),     // 绿色系
            tagBackgroundColor = Color(0xFFE8F5E9),
            tagTextColor = Color(0xFF2E7D32)
        ),
        CategoryColor(
            titleColor = Color(0xFF64B5F6),     // 蓝色系
            tagBackgroundColor = Color(0xFFE3F2FD),
            tagTextColor = Color(0xFF1565C0)
        ),
        CategoryColor(
            titleColor = Color(0xFFFFB74D),     // 橙色系
            tagBackgroundColor = Color(0xFFFFF3E0),
            tagTextColor = Color(0xFFE65100)
        ),
        CategoryColor(
            titleColor = Color(0xFFBA68C8),     // 紫色系
            tagBackgroundColor = Color(0xFFF3E5F5),
            tagTextColor = Color(0xFF7B1FA2)
        ),
        CategoryColor(
            titleColor = Color(0xFF4DB6AC),     // 青色系
            tagBackgroundColor = Color(0xFFE0F2F1),
            tagTextColor = Color(0xFF00695C)
        ),
        CategoryColor(
            titleColor = Color(0xFFF06292),     // 粉色系
            tagBackgroundColor = Color(0xFFFCE4EC),
            tagTextColor = Color(0xFFC2185B)
        ),
        CategoryColor(
            titleColor = Color(0xFF90A4AE),     // 灰蓝色系
            tagBackgroundColor = Color(0xFFECEFF1),
            tagTextColor = Color(0xFF455A64)
        )
    )
    
    private val darkColors = listOf(
        CategoryColor(
            titleColor = Color(0xFFEF9A9A),
            tagBackgroundColor = Color(0xFF4A2020),
            tagTextColor = Color(0xFFFFCDD2)
        ),
        CategoryColor(
            titleColor = Color(0xFFA5D6A7),
            tagBackgroundColor = Color(0xFF1B3D1B),
            tagTextColor = Color(0xFFC8E6C9)
        ),
        CategoryColor(
            titleColor = Color(0xFF90CAF9),
            tagBackgroundColor = Color(0xFF1A3A5C),
            tagTextColor = Color(0xFFBBDEFB)
        ),
        CategoryColor(
            titleColor = Color(0xFFFFCC80),
            tagBackgroundColor = Color(0xFF4A3520),
            tagTextColor = Color(0xFFFFE0B2)
        ),
        CategoryColor(
            titleColor = Color(0xFFCE93D8),
            tagBackgroundColor = Color(0xFF3D1A4A),
            tagTextColor = Color(0xFFE1BEE7)
        ),
        CategoryColor(
            titleColor = Color(0xFF80CBC4),
            tagBackgroundColor = Color(0xFF1A3D3A),
            tagTextColor = Color(0xFFB2DFDB)
        ),
        CategoryColor(
            titleColor = Color(0xFFF48FB1),
            tagBackgroundColor = Color(0xFF4A1A2E),
            tagTextColor = Color(0xFFF8BBD9)
        ),
        CategoryColor(
            titleColor = Color(0xFFB0BEC5),
            tagBackgroundColor = Color(0xFF2A3A4A),
            tagTextColor = Color(0xFFCFD8DC)
        )
    )
    
    /**
     * 根据分类名称获取颜色
     * 使用哈希算法确保同一分类始终获得相同颜色
     */
    fun getColorForCategory(categoryKey: String, isDarkMode: Boolean): CategoryColor {
        val colors = if (isDarkMode) darkColors else lightColors
        val index = abs(categoryKey.hashCode()) % colors.size
        return colors[index]
    }
}
```
