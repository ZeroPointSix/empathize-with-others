# FD-00015: æç¤ºè¯è®¾ç½®ä¼˜åŒ–åŠŸèƒ½è®¾è®¡

> **æ–‡æ¡£ç±»å‹**: åŠŸèƒ½è®¾è®¡æ–‡æ¡£ (FD)  
> **ç‰ˆæœ¬**: 1.1  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-22  
> **æœ€åæ›´æ–°**: 2025-12-22  
> **è´Ÿè´£äºº**: Kiro  
> **çŠ¶æ€**: âœ… å®¡æŸ¥é€šè¿‡  
> **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­  
> **å…³è”PRD**: PRD-00015  
> **å…³è”FD**: FD-00005ï¼ˆæç¤ºè¯ç®¡ç†ç³»ç»ŸåŠŸèƒ½è®¾è®¡ï¼‰ã€FD-00006ï¼ˆæç¤ºè¯ç¼–è¾‘ç•Œé¢åŠŸèƒ½è®¾è®¡ï¼‰  
> **å…³è”å®¡æŸ¥**: DR-00015

---

## ğŸ“œ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-22 | Kiro | åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«åœºæ™¯ç®€åŒ–å’ŒUIä¼˜åŒ–è®¾è®¡ |
| 1.1 | 2025-12-22 | Kiro | æ ¹æ®DR-00015å®¡æŸ¥æŠ¥å‘Šè¡¥å……ï¼šé›†æˆç‚¹ä»£ç ã€é”™è¯¯å¤„ç†æœºåˆ¶ã€æ€§èƒ½è¯„ä¼°ã€å›æ»šæœºåˆ¶ã€ç›‘æ§æ—¥å¿— |

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°æç¤ºè¯è®¾ç½®ä¼˜åŒ–çš„æŠ€æœ¯æ¶æ„ã€ç»„ä»¶å˜æ›´ã€æ•°æ®è¿ç§»å’Œå®ç°ç»†èŠ‚ã€‚

**è®¾è®¡ç›®æ ‡**ï¼š
- å°†6ä¸ªåœºæ™¯ç®€åŒ–ä¸º4ä¸ªæ ¸å¿ƒåœºæ™¯ï¼ˆåˆ†æã€æ¶¦è‰²ã€å›å¤ã€æ€»ç»“ï¼‰
- ç§»é™¤å†—ä½™çš„å®‰å…¨æ£€æŸ¥ï¼ˆCHECKï¼‰å’Œä¿¡æ¯æå–ï¼ˆEXTRACTï¼‰åœºæ™¯
- ä¼˜åŒ–è®¾ç½®ç•Œé¢ï¼Œå‡å°‘ç”¨æˆ·è®¤çŸ¥è´Ÿæ‹…
- ç¡®ä¿æ•°æ®è¿ç§»å¹³æ»‘ï¼Œä¸å½±å“ç°æœ‰ç”¨æˆ·

**ä¾èµ–åº“ç‰ˆæœ¬**ï¼š
- Moshi: 1.15.1ï¼ˆJSONåºåˆ—åŒ–ï¼‰
- Room: 2.6.1ï¼ˆæ•°æ®åº“ï¼‰
- Kotlin Coroutines: 1.9.0ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
- Hilt: 2.52ï¼ˆä¾èµ–æ³¨å…¥ï¼‰

---

## ğŸ“‘ ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [åœºæ™¯å˜æ›´è®¾è®¡](#åœºæ™¯å˜æ›´è®¾è®¡)
3. [æ•°æ®æ¨¡å‹å˜æ›´](#æ•°æ®æ¨¡å‹å˜æ›´)
4. [ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–](#ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–)
5. [UIç•Œé¢å˜æ›´](#uiç•Œé¢å˜æ›´)
6. [å¯¼èˆªä¸DIé›†æˆ](#å¯¼èˆªä¸dié›†æˆ)
7. [æ•°æ®è¿ç§»è®¾è®¡](#æ•°æ®è¿ç§»è®¾è®¡)
8. [å…¼å®¹æ€§å¤„ç†](#å…¼å®¹æ€§å¤„ç†)
9. [é”™è¯¯å¤„ç†æœºåˆ¶](#é”™è¯¯å¤„ç†æœºåˆ¶)
10. [æ€§èƒ½å½±å“è¯„ä¼°](#æ€§èƒ½å½±å“è¯„ä¼°)
11. [ç›‘æ§ä¸æ—¥å¿—](#ç›‘æ§ä¸æ—¥å¿—)
12. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
13. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„å˜æ›´æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å˜æ›´å‰ï¼ˆ6ä¸ªåœºæ™¯ï¼‰                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ ANALYZE  â”‚ â”‚  CHECK   â”‚ â”‚ EXTRACT  â”‚               â”‚
â”‚  â”‚ èŠå¤©åˆ†æ â”‚ â”‚ å®‰å…¨æ£€æŸ¥ â”‚ â”‚ ä¿¡æ¯æå– â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ SUMMARY  â”‚ â”‚  POLISH  â”‚ â”‚  REPLY   â”‚               â”‚
â”‚  â”‚ æ¯æ—¥æ€»ç»“ â”‚ â”‚ æ¶¦è‰²ä¼˜åŒ– â”‚ â”‚ ç”Ÿæˆå›å¤ â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å˜æ›´åï¼ˆ4ä¸ªåœºæ™¯ï¼‰                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ANALYZE  â”‚ â”‚  POLISH  â”‚ â”‚  REPLY   â”‚ â”‚ SUMMARY  â”‚  â”‚
â”‚  â”‚ èŠå¤©åˆ†æ â”‚ â”‚ æ¶¦è‰²ä¼˜åŒ– â”‚ â”‚ ç”Ÿæˆå›å¤ â”‚ â”‚ æ¯æ—¥æ€»ç»“ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  âŒ CHECKï¼ˆå·²åºŸå¼ƒï¼ŒåŠŸèƒ½åˆå¹¶åˆ°POLISHï¼‰                    â”‚
â”‚  âŒ EXTRACTï¼ˆå·²åºŸå¼ƒï¼Œæš‚ä¸åœ¨è®¾ç½®ç•Œé¢å±•ç¤ºï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—å½±å“èŒƒå›´

```
domain/
â”œâ”€â”€ model/
â”‚   â””â”€â”€ PromptScene.kt              # ğŸ”„ æ›´æ–°ï¼šæ ‡è®°åºŸå¼ƒåœºæ™¯
â”œâ”€â”€ util/
â”‚   â”œâ”€â”€ SystemPrompts.kt            # ğŸ”„ æ›´æ–°ï¼šä¼˜åŒ–4ä¸ªæ ¸å¿ƒåœºæ™¯æç¤ºè¯
â”‚   â””â”€â”€ DefaultPrompts.kt           # ğŸ”„ æ›´æ–°ï¼šä¼˜åŒ–é»˜è®¤æç¤ºè¯æ¨¡æ¿

data/
â”œâ”€â”€ local/
â”‚   â””â”€â”€ PromptFileStorage.kt        # ğŸ”„ æ›´æ–°ï¼šæ·»åŠ è¿ç§»é€»è¾‘

presentation/
â”œâ”€â”€ ui/screen/settings/
â”‚   â””â”€â”€ SettingsScreen.kt           # ğŸ”„ æ›´æ–°ï¼šåªæ˜¾ç¤º4ä¸ªæ ¸å¿ƒåœºæ™¯
â”œâ”€â”€ ui/screen/prompt/
â”‚   â””â”€â”€ PromptEditorScreen.kt       # âœ… æ— éœ€ä¿®æ”¹
â””â”€â”€ viewmodel/
    â””â”€â”€ SettingsViewModel.kt        # ğŸ”„ æ›´æ–°ï¼šè¿‡æ»¤åºŸå¼ƒåœºæ™¯
```

---

## ğŸ¯ åœºæ™¯å˜æ›´è®¾è®¡

### åœºæ™¯å¯¹ç…§è¡¨

| åŸåœºæ™¯ | çŠ¶æ€ | å˜æ›´è¯´æ˜ |
|--------|------|----------|
| ANALYZE | âœ… ä¿ç•™ | æ ¸å¿ƒåŠŸèƒ½ï¼Œæ— å˜æ›´ |
| CHECK | âŒ åºŸå¼ƒ | åŠŸèƒ½å·²åˆå¹¶åˆ°POLISH |
| EXTRACT | âŒ åºŸå¼ƒ | æš‚ä¸åœ¨è®¾ç½®ç•Œé¢å±•ç¤º |
| SUMMARY | âœ… ä¿ç•™ | æ ¸å¿ƒåŠŸèƒ½ï¼Œæ— å˜æ›´ |
| POLISH | âœ… ä¿ç•™ | æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…å«é£é™©æ£€æŸ¥ |
| REPLY | âœ… ä¿ç•™ | æ ¸å¿ƒåŠŸèƒ½ï¼Œæ— å˜æ›´ |

### æ ¸å¿ƒåœºæ™¯å®šä¹‰

#### 1. ANALYZEï¼ˆèŠå¤©åˆ†æï¼‰

```kotlin
ANALYZE(
    displayName = "èŠå¤©åˆ†æ",
    description = "åˆ†æèŠå¤©ä¸Šä¸‹æ–‡ï¼Œæä¾›æ²Ÿé€šå»ºè®®",
    availableVariables = listOf(
        "contact_name",
        "relationship_status",
        "risk_tags",
        "strategy_tags",
        "facts_count"
    )
)
```

**åŠŸèƒ½å®šä½**ï¼š
- åˆ†æå¯¹æ–¹æ¶ˆæ¯çš„æƒ…ç»ªå’Œæ„å›¾
- æä¾›æˆ˜ç•¥æ€§æ²Ÿé€šå»ºè®®
- è¯†åˆ«æ½œåœ¨é£é™©ç‚¹

**è¾“å‡ºæ ¼å¼**ï¼š
```json
{
  "riskLevel": "SAFE|WARNING|DANGER",
  "emotionAnalysis": "å¯¹æ–¹æƒ…ç»ªåˆ†æ",
  "intentAnalysis": "å¯¹æ–¹æ„å›¾åˆ†æ",
  "strategyAnalysis": "æ²Ÿé€šç­–ç•¥å»ºè®®",
  "replySuggestion": "å…·ä½“å›å¤å»ºè®®æ–‡æœ¬",
  "riskPoints": ["é£é™©ç‚¹1", "é£é™©ç‚¹2"]
}
```

#### 2. POLISHï¼ˆæ¶¦è‰²ä¼˜åŒ–ï¼‰

```kotlin
POLISH(
    displayName = "æ¶¦è‰²ä¼˜åŒ–",
    description = "ä¼˜åŒ–ç”¨æˆ·è‰ç¨¿ï¼Œä½¿è¡¨è¾¾æ›´å¾—ä½“",
    availableVariables = listOf(
        "contact_name",
        "relationship_status",
        "risk_tags"
    )
)
```

**åŠŸèƒ½å®šä½**ï¼š
- ä¼˜åŒ–ç”¨æˆ·è‰ç¨¿çš„è¡¨è¾¾æ–¹å¼
- æ£€æŸ¥æ˜¯å¦è§¦å‘é£é™©è§„åˆ™ï¼ˆåˆå¹¶åŸCHECKåŠŸèƒ½ï¼‰
- æä¾›ä¿®æ”¹å»ºè®®

**è¾“å‡ºæ ¼å¼**ï¼š
```json
{
  "polishedText": "ä¼˜åŒ–åçš„æ–‡æœ¬",
  "isSafe": true,
  "riskLevel": "SAFE|WARNING|DANGER",
  "issues": ["é—®é¢˜1", "é—®é¢˜2"],
  "suggestion": "ä¿®æ”¹å»ºè®®"
}
```

#### 3. REPLYï¼ˆç”Ÿæˆå›å¤ï¼‰

```kotlin
REPLY(
    displayName = "ç”Ÿæˆå›å¤",
    description = "æ ¹æ®å¯¹æ–¹æ¶ˆæ¯ç”Ÿæˆåˆé€‚çš„å›å¤",
    availableVariables = listOf(
        "contact_name",
        "relationship_status",
        "risk_tags",
        "strategy_tags"
    )
)
```

**åŠŸèƒ½å®šä½**ï¼š
- æ ¹æ®å¯¹æ–¹æ¶ˆæ¯ç”Ÿæˆå›å¤å»ºè®®
- è€ƒè™‘è”ç³»äººç‰¹ç‚¹å’Œç­–ç•¥æ ‡ç­¾
- é¿å…è§¦å‘é›·åŒº

**è¾“å‡ºæ ¼å¼**ï¼š
```json
{
  "replyText": "å»ºè®®å›å¤å†…å®¹",
  "strategy": "ç­–ç•¥è¯´æ˜",
  "alternatives": ["å¤‡é€‰å›å¤1", "å¤‡é€‰å›å¤2"]
}
```

#### 4. SUMMARYï¼ˆæ¯æ—¥æ€»ç»“ï¼‰

```kotlin
SUMMARY(
    displayName = "æ¯æ—¥æ€»ç»“",
    description = "ç”Ÿæˆæ¯æ—¥å¯¹è¯æ€»ç»“",
    availableVariables = listOf(
        "contact_name",
        "relationship_status",
        "facts_count",
        "today_date"
    )
)
```

**åŠŸèƒ½å®šä½**ï¼š
- ç”Ÿæˆæ¯æ—¥å¯¹è¯æ€»ç»“
- æå–æ–°å‘ç°çš„äº‹å®ä¿¡æ¯
- è¯„ä¼°å…³ç³»å˜åŒ–è¶‹åŠ¿

**è¾“å‡ºæ ¼å¼**ï¼š
```json
{
  "summary": "ä»Šæ—¥æ€»ç»“",
  "highlights": ["äº®ç‚¹1", "äº®ç‚¹2"],
  "concerns": ["å…³æ³¨ç‚¹1"],
  "newFacts": [{"key": "åˆ†ç±»", "value": "ä¿¡æ¯"}],
  "relationshipTrend": "UP|STABLE|DOWN"
}
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹å˜æ›´

### 1. PromptSceneæšä¸¾æ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/PromptScene.kt`

```kotlin
enum class PromptScene(
    val displayName: String,
    val description: String,
    val availableVariables: List<String>,
    val isDeprecated: Boolean = false,  // ğŸ†• æ–°å¢ï¼šåºŸå¼ƒæ ‡è®°
    val showInSettings: Boolean = true   // ğŸ†• æ–°å¢ï¼šæ˜¯å¦åœ¨è®¾ç½®ç•Œé¢æ˜¾ç¤º
) {
    /**
     * èŠå¤©åˆ†æåœºæ™¯ - åˆ†æèŠå¤©ä¸Šä¸‹æ–‡ï¼Œæä¾›æ²Ÿé€šå»ºè®®
     */
    ANALYZE(
        displayName = "èŠå¤©åˆ†æ",
        description = "åˆ†æèŠå¤©ä¸Šä¸‹æ–‡ï¼Œæä¾›æ²Ÿé€šå»ºè®®",
        availableVariables = listOf(
            "contact_name",
            "relationship_status",
            "risk_tags",
            "strategy_tags",
            "facts_count"
        ),
        isDeprecated = false,
        showInSettings = true
    ),

    /**
     * å®‰å…¨æ£€æŸ¥åœºæ™¯ - æ£€æŸ¥è‰ç¨¿å†…å®¹æ˜¯å¦è§¦å‘é£é™©è§„åˆ™
     *
     * @deprecated ä½¿ç”¨ POLISH æ›¿ä»£ï¼Œé£é™©æ£€æŸ¥å·²åˆå¹¶åˆ°æ¶¦è‰²åŠŸèƒ½
     */
    @Deprecated("ä½¿ç”¨ POLISH æ›¿ä»£ï¼Œé£é™©æ£€æŸ¥å·²åˆå¹¶åˆ°æ¶¦è‰²åŠŸèƒ½")
    CHECK(
        displayName = "å®‰å…¨æ£€æŸ¥",
        description = "æ£€æŸ¥è‰ç¨¿å†…å®¹æ˜¯å¦è§¦å‘é£é™©è§„åˆ™",
        availableVariables = listOf("contact_name", "risk_tags"),
        isDeprecated = true,
        showInSettings = false  // ğŸ†• ä¸åœ¨è®¾ç½®ç•Œé¢æ˜¾ç¤º
    ),

    /**
     * ä¿¡æ¯æå–åœºæ™¯ - ä»æ–‡æœ¬ä¸­æå–å…³é”®ä¿¡æ¯
     *
     * @deprecated æš‚ä¸åœ¨è®¾ç½®ç•Œé¢å±•ç¤º
     */
    @Deprecated("æš‚ä¸åœ¨è®¾ç½®ç•Œé¢å±•ç¤º")
    EXTRACT(
        displayName = "ä¿¡æ¯æå–",
        description = "ä»æ–‡æœ¬ä¸­æå–å…³é”®ä¿¡æ¯",
        availableVariables = listOf("contact_name"),
        isDeprecated = true,
        showInSettings = false  // ğŸ†• ä¸åœ¨è®¾ç½®ç•Œé¢æ˜¾ç¤º
    ),

    /**
     * æ¯æ—¥æ€»ç»“åœºæ™¯ - ç”Ÿæˆæ¯æ—¥å¯¹è¯æ€»ç»“
     */
    SUMMARY(
        displayName = "æ¯æ—¥æ€»ç»“",
        description = "ç”Ÿæˆæ¯æ—¥å¯¹è¯æ€»ç»“",
        availableVariables = listOf(
            "contact_name",
            "relationship_status",
            "facts_count",
            "today_date"
        ),
        isDeprecated = false,
        showInSettings = true
    ),

    /**
     * æ¶¦è‰²ä¼˜åŒ–åœºæ™¯ - ä¼˜åŒ–ç”¨æˆ·è‰ç¨¿ï¼Œä½¿è¡¨è¾¾æ›´å¾—ä½“
     *
     * æ›¿ä»£åŸæœ‰çš„ CHECK åœºæ™¯ï¼ŒåŒæ—¶åŒ…å«é£é™©æ£€æŸ¥åŠŸèƒ½
     */
    POLISH(
        displayName = "æ¶¦è‰²ä¼˜åŒ–",
        description = "ä¼˜åŒ–ç”¨æˆ·è‰ç¨¿ï¼Œä½¿è¡¨è¾¾æ›´å¾—ä½“",
        availableVariables = listOf(
            "contact_name",
            "relationship_status",
            "risk_tags"
        ),
        isDeprecated = false,
        showInSettings = true
    ),

    /**
     * ç”Ÿæˆå›å¤åœºæ™¯ - æ ¹æ®å¯¹æ–¹æ¶ˆæ¯ç”Ÿæˆåˆé€‚çš„å›å¤
     */
    REPLY(
        displayName = "ç”Ÿæˆå›å¤",
        description = "æ ¹æ®å¯¹æ–¹æ¶ˆæ¯ç”Ÿæˆåˆé€‚çš„å›å¤",
        availableVariables = listOf(
            "contact_name",
            "relationship_status",
            "risk_tags",
            "strategy_tags"
        ),
        isDeprecated = false,
        showInSettings = true
    );

    companion object {
        /**
         * è·å–åœ¨è®¾ç½®ç•Œé¢æ˜¾ç¤ºçš„åœºæ™¯åˆ—è¡¨
         * @return å¯åœ¨è®¾ç½®ç•Œé¢é…ç½®çš„åœºæ™¯åˆ—è¡¨
         */
        fun getSettingsScenes(): List<PromptScene> {
            return entries.filter { it.showInSettings }
        }

        /**
         * è·å–æ´»è·ƒï¼ˆéåºŸå¼ƒï¼‰çš„åœºæ™¯åˆ—è¡¨
         * @return æ´»è·ƒåœºæ™¯åˆ—è¡¨
         */
        fun getActiveScenes(): List<PromptScene> {
            return entries.filter { !it.isDeprecated }
        }

        /**
         * ä» ActionType è·å–å¯¹åº”çš„ PromptScene
         */
        fun fromActionType(actionType: ActionType): PromptScene = when (actionType) {
            ActionType.ANALYZE -> ANALYZE
            ActionType.POLISH -> POLISH
            ActionType.REPLY -> REPLY
            @Suppress("DEPRECATION")
            ActionType.CHECK -> CHECK
        }
    }
}
```

### 2. è®¾ç½®ç•Œé¢åœºæ™¯é¡ºåº

ä¸ºäº†æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œè®¾ç½®ç•Œé¢çš„åœºæ™¯æŒ‰ä»¥ä¸‹é¡ºåºæ˜¾ç¤ºï¼š

```kotlin
/**
 * è®¾ç½®ç•Œé¢åœºæ™¯æ˜¾ç¤ºé¡ºåº
 */
val SETTINGS_SCENE_ORDER = listOf(
    PromptScene.ANALYZE,   // 1. èŠå¤©åˆ†æ
    PromptScene.POLISH,    // 2. æ¶¦è‰²ä¼˜åŒ–
    PromptScene.REPLY,     // 3. ç”Ÿæˆå›å¤
    PromptScene.SUMMARY    // 4. æ¯æ—¥æ€»ç»“
)
```

---

## ğŸ”§ ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–

### 1. SystemPromptsæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`domain/util/SystemPrompts.kt`

```kotlin
object SystemPrompts {

    /**
     * è·å–åœºæ™¯çš„ç³»ç»Ÿå¤´éƒ¨ï¼ˆè§’è‰²å®šä¹‰å’Œä»»åŠ¡è¯´æ˜ï¼‰
     */
    fun getHeader(scene: PromptScene): String = when (scene) {
        PromptScene.ANALYZE -> """
            |ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¤¾äº¤æ²Ÿé€šåˆ†æåŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯åˆ†æç”¨æˆ·æä¾›çš„èŠå¤©è®°å½•ï¼Œç†è§£å¯¹è¯åŒæ–¹çš„æƒ…ç»ªå’Œæ„å›¾ï¼Œ
            |å¹¶ç»™å‡ºå…·ä½“ã€å¯æ“ä½œçš„æ²Ÿé€šå»ºè®®ã€‚
            |
            |ã€è”ç³»äººä¿¡æ¯ã€‘
            |å§“åï¼š{{contact_name}}
            |å…³ç³»çŠ¶æ€ï¼š{{relationship_status}}
            |é›·åŒºæ ‡ç­¾ï¼š{{risk_tags}}
            |ç­–ç•¥æ ‡ç­¾ï¼š{{strategy_tags}}
            |å·²è®°å½•äº‹å®æ•°ï¼š{{facts_count}}
        """.trimMargin()

        PromptScene.POLISH -> """
            |ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡å­—æ¶¦è‰²å’Œé£é™©æ£€æµ‹åŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯ï¼š
            |1. ä¼˜åŒ–ç”¨æˆ·å‡†å¤‡å‘é€çš„æ¶ˆæ¯ï¼Œä½¿è¡¨è¾¾æ›´å¾—ä½“ã€æ›´æœ‰æ•ˆ
            |2. æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å¯èƒ½è§¦å‘å¯¹æ–¹çš„æ•æ„Ÿç‚¹æˆ–é›·åŒº
            |
            |ã€è”ç³»äººä¿¡æ¯ã€‘
            |å§“åï¼š{{contact_name}}
            |å…³ç³»çŠ¶æ€ï¼š{{relationship_status}}
            |é›·åŒºæ ‡ç­¾ï¼š{{risk_tags}}
        """.trimMargin()

        PromptScene.REPLY -> """
            |ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¤¾äº¤å›å¤ç”ŸæˆåŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®å¯¹æ–¹å‘é€çš„æ¶ˆæ¯ï¼Œç”Ÿæˆåˆé€‚çš„å›å¤å»ºè®®ã€‚
            |å›å¤åº”è¯¥è‡ªç„¶ã€çœŸè¯šï¼ŒåŒæ—¶é¿å…è§¦å‘å¯¹æ–¹çš„æ•æ„Ÿç‚¹ã€‚
            |
            |ã€è”ç³»äººä¿¡æ¯ã€‘
            |å§“åï¼š{{contact_name}}
            |å…³ç³»çŠ¶æ€ï¼š{{relationship_status}}
            |é›·åŒºæ ‡ç­¾ï¼š{{risk_tags}}
            |ç­–ç•¥æ ‡ç­¾ï¼š{{strategy_tags}}
        """.trimMargin()

        PromptScene.SUMMARY -> """
            |ä½ æ˜¯ä¸€ä¸ªå¯¹è¯æ€»ç»“åŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯åˆ†æä»Šæ—¥çš„å¯¹è¯è®°å½•ï¼Œç”Ÿæˆç®€æ´çš„æ€»ç»“æŠ¥å‘Šï¼Œ
            |æå–æ–°å‘ç°çš„äº‹å®ä¿¡æ¯ï¼Œå¹¶è¯„ä¼°å…³ç³»å˜åŒ–è¶‹åŠ¿ã€‚
            |
            |ã€è”ç³»äººä¿¡æ¯ã€‘
            |å§“åï¼š{{contact_name}}
            |å…³ç³»çŠ¶æ€ï¼š{{relationship_status}}
            |å·²è®°å½•äº‹å®æ•°ï¼š{{facts_count}}
            |ä»Šæ—¥æ—¥æœŸï¼š{{today_date}}
        """.trimMargin()

        // åºŸå¼ƒåœºæ™¯ä¿æŒåŸæœ‰å®ç°ä»¥ç¡®ä¿å…¼å®¹æ€§
        @Suppress("DEPRECATION")
        PromptScene.CHECK -> """
            |ä½ æ˜¯ä¸€ä¸ªæ•æ„Ÿè¯é¢˜æ£€æµ‹åŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯æ£€æŸ¥ç”¨æˆ·å‡†å¤‡å‘é€çš„æ¶ˆæ¯ï¼Œåˆ¤æ–­æ˜¯å¦å¯èƒ½è§¦å‘å¯¹æ–¹çš„æ•æ„Ÿç‚¹æˆ–é›·åŒºã€‚
        """.trimMargin()

        @Suppress("DEPRECATION")
        PromptScene.EXTRACT -> """
            |ä½ æ˜¯ä¸€ä¸ªä¿¡æ¯æå–åŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯ä»å¯¹è¯æ–‡æœ¬ä¸­æå–å…³é”®çš„ä¸ªäººä¿¡æ¯ã€åå¥½å’Œé‡è¦äº‹ä»¶ã€‚
        """.trimMargin()
    }

    /**
     * è·å–åœºæ™¯çš„ç³»ç»Ÿå°¾éƒ¨ï¼ˆè¾“å‡ºæ ¼å¼çº¦æŸï¼‰
     */
    fun getFooter(scene: PromptScene): String = when (scene) {
        PromptScene.ANALYZE -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦æ·»åŠ ä»»ä½•é¢å¤–å†…å®¹ï¼š
            |{
            |  "riskLevel": "SAFE|WARNING|DANGER",
            |  "emotionAnalysis": "å¯¹æ–¹æƒ…ç»ªåˆ†æ",
            |  "intentAnalysis": "å¯¹æ–¹æ„å›¾åˆ†æ",
            |  "strategyAnalysis": "æ²Ÿé€šç­–ç•¥å»ºè®®",
            |  "replySuggestion": "å…·ä½“å›å¤å»ºè®®æ–‡æœ¬",
            |  "riskPoints": ["é£é™©ç‚¹1", "é£é™©ç‚¹2"]
            |}
            |
            |ã€é‡è¦çº¦æŸã€‘
            |- åªè¾“å‡ºJSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—
            |- ä¸è¦ä½¿ç”¨Markdownæ ¼å¼
            |- riskLevelåªèƒ½æ˜¯SAFEã€WARNINGã€DANGERä¸‰ä¸ªå€¼ä¹‹ä¸€
        """.trimMargin()

        PromptScene.POLISH -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
            |{
            |  "polishedText": "ä¼˜åŒ–åçš„æ–‡æœ¬",
            |  "isSafe": true|false,
            |  "riskLevel": "SAFE|WARNING|DANGER",
            |  "issues": ["é—®é¢˜1", "é—®é¢˜2"],
            |  "suggestion": "ä¿®æ”¹å»ºè®®"
            |}
            |
            |ã€é‡è¦çº¦æŸã€‘
            |- åªè¾“å‡ºJSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—
            |- polishedTextæ˜¯ä¼˜åŒ–åå¯ç›´æ¥å‘é€çš„æ–‡æœ¬
            |- å¦‚æœåŸæ–‡å·²ç»å¾ˆå¥½ï¼ŒpolishedTextå¯ä»¥ä¸åŸæ–‡ç›¸åŒ
        """.trimMargin()

        PromptScene.REPLY -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
            |{
            |  "replyText": "å»ºè®®å›å¤å†…å®¹",
            |  "strategy": "ç­–ç•¥è¯´æ˜",
            |  "alternatives": ["å¤‡é€‰å›å¤1", "å¤‡é€‰å›å¤2"]
            |}
            |
            |ã€é‡è¦çº¦æŸã€‘
            |- åªè¾“å‡ºJSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—
            |- replyTextæ˜¯ä¸»è¦æ¨èçš„å›å¤å†…å®¹
            |- alternativesæä¾›2-3ä¸ªå¤‡é€‰æ–¹æ¡ˆ
        """.trimMargin()

        PromptScene.SUMMARY -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
            |{
            |  "summary": "ä»Šæ—¥æ€»ç»“",
            |  "highlights": ["äº®ç‚¹1", "äº®ç‚¹2"],
            |  "concerns": ["å…³æ³¨ç‚¹1"],
            |  "newFacts": [{"key": "åˆ†ç±»", "value": "ä¿¡æ¯"}],
            |  "relationshipTrend": "UP|STABLE|DOWN"
            |}
            |
            |ã€é‡è¦çº¦æŸã€‘
            |- åªè¾“å‡ºJSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—
            |- relationshipTrendåªèƒ½æ˜¯UPã€STABLEã€DOWNä¸‰ä¸ªå€¼ä¹‹ä¸€
        """.trimMargin()

        // åºŸå¼ƒåœºæ™¯ä¿æŒåŸæœ‰å®ç°
        @Suppress("DEPRECATION")
        PromptScene.CHECK -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
            |{
            |  "isSafe": true|false,
            |  "riskLevel": "SAFE|WARNING|DANGER",
            |  "issues": ["é—®é¢˜1", "é—®é¢˜2"],
            |  "suggestion": "ä¿®æ”¹å»ºè®®"
            |}
        """.trimMargin()

        @Suppress("DEPRECATION")
        PromptScene.EXTRACT -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
            |{
            |  "facts": [
            |    {"key": "åˆ†ç±»", "value": "å…·ä½“ä¿¡æ¯", "confidence": 0.9}
            |  ]
            |}
        """.trimMargin()
    }
}
```

---

### 2. DefaultPromptsæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/DefaultPrompts.kt`

```kotlin
object DefaultPrompts {

    fun getDefault(scene: PromptScene): String = when (scene) {
        PromptScene.ANALYZE -> """
            |è¯·åŸºäºæä¾›çš„ä¿¡æ¯ï¼Œåˆ†æå½“å‰èŠå¤©æƒ…å†µï¼Œå¹¶ç»™å‡º:
            |1. å¯¹æ–¹å½“å‰çš„æƒ…ç»ªå’Œæ½œåœ¨æ„å›¾
            |2. å¯èƒ½å­˜åœ¨çš„é£é™©ç‚¹
            |3. å…·ä½“çš„å›å¤å»ºè®®ï¼ˆå¯ç›´æ¥å‘é€çš„æ–‡æœ¬ï¼‰
            |
            |æ³¨æ„äº‹é¡¹:
            |- ä¸¥æ ¼éµå®ˆé›·åŒºè­¦å‘Šï¼Œä¸è¦è§¦ç¢°æ•æ„Ÿè¯é¢˜
            |- ä¼˜å…ˆä½¿ç”¨ç­–ç•¥å»ºè®®ä¸­çš„æ–¹æ³•
            |- å›å¤è¦çœŸè¯šã€è‡ªç„¶ï¼Œä¸è¦å¤ªè¿‡åˆ»æ„
            |- å¦‚æœå‘ç°é«˜é£é™©æƒ…å†µï¼Œè¯·æ˜ç¡®æ ‡æ³¨
        """.trimMargin()

        PromptScene.POLISH -> """
            |è¯·ä¼˜åŒ–ç”¨æˆ·çš„è‰ç¨¿å†…å®¹ï¼ŒåŒæ—¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨é£é™©ï¼š
            |
            |ä¼˜åŒ–è¦æ±‚:
            |- ä¿æŒåŸæ„ï¼Œä½¿è¡¨è¾¾æ›´è‡ªç„¶ã€å¾—ä½“
            |- é¿å…è§¦åŠå¯¹æ–¹çš„é›·åŒºè¯é¢˜
            |- è¯­æ°”è¦ç¬¦åˆå½“å‰å…³ç³»çŠ¶æ€
            |
            |é£é™©æ£€æŸ¥:
            |- æ˜¯å¦è§¦åŠå¯¹æ–¹çš„é›·åŒºè¯é¢˜
            |- è¯­æ°”æ˜¯å¦å¯èƒ½å¼•èµ·è¯¯è§£
            |- æ˜¯å¦æœ‰æ•æ„Ÿè¯æ±‡éœ€è¦æ›¿æ¢
        """.trimMargin()

        PromptScene.REPLY -> """
            |è¯·æ ¹æ®å¯¹æ–¹çš„æ¶ˆæ¯ï¼Œç”Ÿæˆåˆé€‚çš„å›å¤å»ºè®®ï¼š
            |
            |å›å¤è¦æ±‚:
            |- å›å¤è¦è‡ªç„¶ã€çœŸè¯šï¼Œç¬¦åˆæ—¥å¸¸å¯¹è¯é£æ ¼
            |- è€ƒè™‘å¯¹æ–¹çš„æ€§æ ¼ç‰¹ç‚¹å’Œå½“å‰æƒ…ç»ª
            |- é¿å…è§¦åŠé›·åŒºè¯é¢˜
            |- é€‚å½“è¿ç”¨ç­–ç•¥æ ‡ç­¾ä¸­çš„å»ºè®®
            |
            |è¯·æä¾›ä¸€ä¸ªä¸»è¦å›å¤å’Œ2-3ä¸ªå¤‡é€‰æ–¹æ¡ˆ
        """.trimMargin()

        PromptScene.SUMMARY -> """
            |è¯·åˆ†æä»Šæ—¥çš„å¯¹è¯è®°å½•ï¼Œç”Ÿæˆç®€æ´çš„æ€»ç»“ï¼ŒåŒ…æ‹¬ï¼š
            |- æ–°å‘ç°çš„äº‹å®ä¿¡æ¯
            |- å…³ç³»å˜åŒ–è¶‹åŠ¿
            |- éœ€è¦å…³æ³¨çš„è¦ç‚¹
            |
            |æ€»ç»“è¦æ±‚:
            |- çªå‡ºä»Šæ—¥äº’åŠ¨çš„äº®ç‚¹
            |- æ ‡æ³¨éœ€è¦æ³¨æ„çš„é—®é¢˜
            |- ç»™å‡ºåç»­æ²Ÿé€šå»ºè®®
        """.trimMargin()

        // åºŸå¼ƒåœºæ™¯ä¿æŒåŸæœ‰å®ç°ä»¥ç¡®ä¿å…¼å®¹æ€§
        @Suppress("DEPRECATION")
        PromptScene.CHECK -> """
            |è¯·ä»”ç»†æ£€æŸ¥ç”¨æˆ·çš„è‰ç¨¿å†…å®¹ï¼Œåˆ¤æ–­æ˜¯å¦è§¦å‘äº†ä»»ä½•é£é™©è§„åˆ™ã€‚
            |å¦‚æœå‘ç°é—®é¢˜ï¼Œè¯·ç»™å‡ºå…·ä½“çš„ä¿®æ”¹å»ºè®®ã€‚
        """.trimMargin()

        @Suppress("DEPRECATION")
        PromptScene.EXTRACT -> """
            |è¯·ä»æ–‡æœ¬ä¸­æå–å…³é”®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
            |- å¯¹æ–¹é€éœ²çš„ä¸ªäººä¿¡æ¯
            |- éœ€è¦æ³¨æ„çš„é›·åŒºè¯é¢˜
            |- æœ‰æ•ˆçš„æ²Ÿé€šç­–ç•¥
        """.trimMargin()
    }
}
```

---

## ğŸ¨ UIç•Œé¢å˜æ›´

### 1. è®¾ç½®ç•Œé¢ä¼˜åŒ–

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/settings/SettingsScreen.kt`

#### å˜æ›´å‰

```
æç¤ºè¯è®¾ç½®
â”œâ”€â”€ èŠå¤©åˆ†ææŒ‡ä»¤
â”œâ”€â”€ å®‰å…¨æ£€æŸ¥æŒ‡ä»¤      â† ç§»é™¤
â”œâ”€â”€ ä¿¡æ¯æå–æŒ‡ä»¤      â† ç§»é™¤
â”œâ”€â”€ æ¯æ—¥æ€»ç»“æŒ‡ä»¤
â”œâ”€â”€ æ¶¦è‰²ä¼˜åŒ–æŒ‡ä»¤
â””â”€â”€ ç”Ÿæˆå›å¤æŒ‡ä»¤
```

#### å˜æ›´å

```
æç¤ºè¯è®¾ç½®
â”œâ”€â”€ èŠå¤©åˆ†ææŒ‡ä»¤
â”‚   â””â”€â”€ è‡ªå®šä¹‰AIåˆ†æèŠå¤©å†…å®¹æ—¶çš„è¡Œä¸º
â”œâ”€â”€ æ¶¦è‰²ä¼˜åŒ–æŒ‡ä»¤  
â”‚   â””â”€â”€ è‡ªå®šä¹‰AIä¼˜åŒ–è¡¨è¾¾æ—¶çš„è¡Œä¸ºï¼ˆåŒ…å«é£é™©æ£€æŸ¥ï¼‰
â”œâ”€â”€ ç”Ÿæˆå›å¤æŒ‡ä»¤
â”‚   â””â”€â”€ è‡ªå®šä¹‰AIç”Ÿæˆå›å¤æ—¶çš„è¡Œä¸º
â””â”€â”€ æ¯æ—¥æ€»ç»“æŒ‡ä»¤
    â””â”€â”€ è‡ªå®šä¹‰AIç”Ÿæˆæ€»ç»“æ—¶çš„è¡Œä¸º
```

### 2. SettingsViewModelæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/viewmodel/SettingsViewModel.kt`

```kotlin
@HiltViewModel
class SettingsViewModel @Inject constructor(
    // ... ç°æœ‰ä¾èµ–
) : ViewModel() {

    // ğŸ†• è·å–è®¾ç½®ç•Œé¢æ˜¾ç¤ºçš„åœºæ™¯åˆ—è¡¨
    val promptScenes: List<PromptScene> = PromptScene.getSettingsScenes()

    // æˆ–è€…ä½¿ç”¨é¢„å®šä¹‰é¡ºåº
    val promptScenesOrdered: List<PromptScene> = listOf(
        PromptScene.ANALYZE,
        PromptScene.POLISH,
        PromptScene.REPLY,
        PromptScene.SUMMARY
    )
}
```

### 3. æç¤ºè¯è®¾ç½®åŒºåŸŸç»„ä»¶

```kotlin
@Composable
fun PromptSettingsSection(
    scenes: List<PromptScene>,
    onSceneClick: (PromptScene) -> Unit,
    modifier: Modifier = Modifier
) {
    Column(modifier = modifier) {
        Text(
            text = "æç¤ºè¯è®¾ç½®",
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.SemiBold,
            modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)
        )

        scenes.forEach { scene ->
            PromptSettingItem(
                scene = scene,
                onClick = { onSceneClick(scene) }
            )
        }
    }
}

@Composable
private fun PromptSettingItem(
    scene: PromptScene,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    ListItem(
        headlineContent = {
            Text(text = "${scene.displayName}æŒ‡ä»¤")
        },
        supportingContent = {
            Text(
                text = scene.description,
                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
            )
        },
        trailingContent = {
            Icon(
                imageVector = Icons.Default.ChevronRight,
                contentDescription = null,
                tint = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.4f)
            )
        },
        modifier = modifier.clickable(onClick = onClick)
    )
}
```

---

## ï¿½ å¯¼æ®èˆªä¸DIé›†æˆ

### 1. å¯¼èˆªç³»ç»Ÿé›†æˆ

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/navigation/NavGraph.kt`

```kotlin
// åœ¨NavGraphä¸­æ·»åŠ æç¤ºè¯ç¼–è¾‘å™¨çš„å¯¼èˆªé…ç½®
fun NavGraphBuilder.settingsNavigation(
    navController: NavController
) {
    composable(route = NavRoutes.SETTINGS) {
        val viewModel: SettingsViewModel = hiltViewModel()
        SettingsScreen(
            viewModel = viewModel,
            onNavigateToPromptEditor = { scene ->
                navController.navigate(NavRoutes.promptEditorGlobal(scene))
            },
            onNavigateToAiConfig = {
                navController.navigate(NavRoutes.AI_CONFIG)
            }
        )
    }
    
    // æç¤ºè¯ç¼–è¾‘å™¨è·¯ç”±
    composable(
        route = "${NavRoutes.PROMPT_EDITOR}?mode={mode}&scene={scene}",
        arguments = listOf(
            navArgument("mode") { 
                type = NavType.StringType
                defaultValue = "global"
            },
            navArgument("scene") {
                type = NavType.StringType
                nullable = true
            }
        )
    ) { backStackEntry ->
        val mode = backStackEntry.arguments?.getString("mode") ?: "global"
        val sceneName = backStackEntry.arguments?.getString("scene")
        
        PromptEditorScreen(
            editMode = when (mode) {
                "global" -> PromptEditMode.GlobalScene(
                    PromptScene.valueOf(sceneName ?: "ANALYZE")
                )
                else -> PromptEditMode.GlobalScene(PromptScene.ANALYZE)
            },
            onNavigateBack = { navController.popBackStack() }
        )
    }
}
```

### 2. å¯¼èˆªè·¯ç”±å®šä¹‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/navigation/NavRoutes.kt`

```kotlin
object NavRoutes {
    // ç°æœ‰è·¯ç”±...
    const val SETTINGS = "settings"
    const val AI_CONFIG = "ai_config"
    const val PROMPT_EDITOR = "prompt_editor"
    
    // ğŸ†• æç¤ºè¯ç¼–è¾‘å™¨è·¯ç”±æ„å»ºæ–¹æ³•
    fun promptEditorGlobal(scene: PromptScene): String {
        return "$PROMPT_EDITOR?mode=global&scene=${scene.name}"
    }
    
    fun promptEditorContact(contactId: String, contactName: String): String {
        val encodedName = URLEncoder.encode(contactName, "UTF-8")
        return "$PROMPT_EDITOR?mode=contact&contactId=$contactId&contactName=$encodedName"
    }
}
```

### 3. DIæ¨¡å—æ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`di/PromptModule.kt`

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object PromptModule {

    @Provides
    @Singleton
    fun providePromptFileStorage(
        @ApplicationContext context: Context,
        moshi: Moshi
    ): PromptFileStorage {
        return PromptFileStorage(context, moshi)
    }

    @Provides
    @Singleton
    fun providePromptFileBackup(
        @ApplicationContext context: Context
    ): PromptFileBackup {
        return PromptFileBackup(context)
    }

    @Provides
    @Singleton
    fun providePromptVariableResolver(): PromptVariableResolver {
        return PromptVariableResolver()
    }

    @Provides
    @Singleton
    fun providePromptValidator(
        variableResolver: PromptVariableResolver
    ): PromptValidator {
        return PromptValidator(variableResolver)
    }

    @Provides
    @Singleton
    fun providePromptRepository(
        fileStorage: PromptFileStorage,
        fileBackup: PromptFileBackup,
        contactDao: ContactDao
    ): PromptRepository {
        return PromptRepositoryImpl(fileStorage, fileBackup, contactDao)
    }

    @Provides
    @Singleton
    fun providePromptBuilder(
        promptRepository: PromptRepository,
        variableResolver: PromptVariableResolver
    ): PromptBuilder {
        return PromptBuilder(promptRepository, variableResolver)
    }

    // ğŸ†• æä¾›åœºæ™¯è¿‡æ»¤å™¨
    @Provides
    fun provideSettingsScenes(): List<PromptScene> {
        return PromptScene.getSettingsScenes()
    }
}
```

### 4. SettingsScreené›†æˆç‚¹

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/settings/SettingsScreen.kt`

```kotlin
@Composable
fun SettingsScreen(
    viewModel: SettingsViewModel = hiltViewModel(),
    onNavigateToPromptEditor: (PromptScene) -> Unit,
    onNavigateToAiConfig: () -> Unit
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    LazyColumn(
        modifier = Modifier.fillMaxSize()
    ) {
        // AIæœåŠ¡å•†é…ç½®åŒºåŸŸ
        item {
            AiProviderSection(
                currentProvider = uiState.currentProvider,
                onClick = onNavigateToAiConfig
            )
        }
        
        // ğŸ†• æç¤ºè¯è®¾ç½®åŒºåŸŸï¼ˆåªæ˜¾ç¤º4ä¸ªæ ¸å¿ƒåœºæ™¯ï¼‰
        item {
            PromptSettingsSection(
                scenes = viewModel.promptScenesOrdered,
                onSceneClick = onNavigateToPromptEditor
            )
        }
        
        // éšç§è®¾ç½®åŒºåŸŸ
        item {
            PrivacySettingsSection(
                dataMaskingEnabled = uiState.dataMaskingEnabled,
                localFirstMode = uiState.localFirstMode,
                onToggleDataMasking = { viewModel.onEvent(SettingsUiEvent.ToggleDataMasking) },
                onToggleLocalFirstMode = { viewModel.onEvent(SettingsUiEvent.ToggleLocalFirstMode) }
            )
        }
        
        // å…¶ä»–è®¾ç½®åŒºåŸŸ...
    }
}
```

### 5. å…¥å£ç‚¹å¯è¾¾æ€§éªŒè¯

| å…¥å£ç‚¹ | è·¯å¾„ | çŠ¶æ€ |
|--------|------|------|
| è®¾ç½®ç•Œé¢ â†’ æç¤ºè¯è®¾ç½® | SettingsScreen â†’ PromptSettingsSection â†’ PromptEditorScreen | âœ… å¯è¾¾ |
| è”ç³»äººè¯¦æƒ… â†’ ä¸“å±æç¤ºè¯ | ContactDetailScreen â†’ PromptEditorScreen | âœ… å¯è¾¾ |
| æ‚¬æµ®çª— â†’ æç¤ºè¯ä½¿ç”¨ | FloatingWindowService â†’ PromptBuilder | âœ… å¯è¾¾ |

---

## ğŸ”„ æ•°æ®è¿ç§»è®¾è®¡

### 1. è¿ç§»ç­–ç•¥

| åœºæ™¯ | è¿ç§»ç­–ç•¥ | è¯´æ˜ |
|------|----------|------|
| CHECK | åˆå¹¶åˆ°POLISH | å¦‚æœç”¨æˆ·è‡ªå®šä¹‰äº†CHECKæç¤ºè¯ï¼Œè¿½åŠ åˆ°POLISH |
| EXTRACT | ä¿ç•™ä½†éšè— | æ•°æ®ä¿ç•™ï¼Œä½†ä¸åœ¨è®¾ç½®ç•Œé¢æ˜¾ç¤º |
| å…¶ä»–åœºæ™¯ | æ— å˜æ›´ | ä¿æŒåŸæœ‰æ•°æ® |

### 2. PromptFileStorageè¿ç§»é€»è¾‘

```kotlin
@Singleton
class PromptFileStorage @Inject constructor(
    @ApplicationContext private val context: Context,
    private val moshi: Moshi
) {
    companion object {
        private const val PROMPTS_DIR = "prompts"
        private const val GLOBAL_PROMPTS_FILE = "global_prompts.json"
        private const val MIGRATION_VERSION_KEY = "migration_version"
        private const val CURRENT_MIGRATION_VERSION = 2  // ğŸ†• è¿ç§»ç‰ˆæœ¬
    }

    /**
     * è¯»å–å…¨å±€é…ç½®ï¼ˆåŒ…å«è¿ç§»é€»è¾‘ï¼‰
     */
    suspend fun readGlobalConfig(): Result<GlobalPromptConfig> = withContext(Dispatchers.IO) {
        try {
            if (!globalPromptsFile.exists()) {
                val defaultConfig = GlobalPromptConfig.createDefault()
                writeGlobalConfig(defaultConfig)
                return@withContext Result.success(defaultConfig)
            }

            val json = globalPromptsFile.readText(Charsets.UTF_8)
            val config = adapter.fromJson(json)
                ?: return@withContext Result.failure(Exception("è§£æé…ç½®æ–‡ä»¶å¤±è´¥"))

            // ğŸ†• æ‰§è¡Œè¿ç§»
            val migratedConfig = migrateIfNeeded(config)
            if (migratedConfig != config) {
                writeGlobalConfig(migratedConfig)
            }

            Result.success(migratedConfig)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * ğŸ†• æ‰§è¡Œå¿…è¦çš„è¿ç§»
     */
    private fun migrateIfNeeded(config: GlobalPromptConfig): GlobalPromptConfig {
        if (config.version >= CURRENT_MIGRATION_VERSION) {
            return config
        }

        var migratedConfig = config

        // è¿ç§»ç‰ˆæœ¬1 -> 2ï¼šåˆå¹¶CHECKåˆ°POLISH
        if (config.version < 2) {
            migratedConfig = migrateCheckToPolish(migratedConfig)
        }

        return migratedConfig.copy(version = CURRENT_MIGRATION_VERSION)
    }

    /**
     * ğŸ†• å°†CHECKåœºæ™¯çš„è‡ªå®šä¹‰æç¤ºè¯åˆå¹¶åˆ°POLISH
     */
    @Suppress("DEPRECATION")
    private fun migrateCheckToPolish(config: GlobalPromptConfig): GlobalPromptConfig {
        val checkConfig = config.prompts[PromptScene.CHECK]
        val polishConfig = config.prompts[PromptScene.POLISH]

        // å¦‚æœCHECKæœ‰è‡ªå®šä¹‰å†…å®¹ä¸”ä¸æ˜¯é»˜è®¤å€¼
        if (checkConfig != null && 
            checkConfig.userPrompt.isNotBlank() &&
            checkConfig.userPrompt != DefaultPrompts.getDefault(PromptScene.CHECK)) {
            
            // åˆå¹¶åˆ°POLISH
            val mergedPrompt = buildString {
                append(polishConfig?.userPrompt ?: DefaultPrompts.getDefault(PromptScene.POLISH))
                appendLine()
                appendLine()
                appendLine("ã€åŸå®‰å…¨æ£€æŸ¥æŒ‡ä»¤ï¼ˆå·²åˆå¹¶ï¼‰ã€‘")
                append(checkConfig.userPrompt)
            }

            val updatedPolishConfig = (polishConfig ?: ScenePromptConfig(
                userPrompt = DefaultPrompts.getDefault(PromptScene.POLISH),
                enabled = true
            )).copy(userPrompt = mergedPrompt)

            return config.copy(
                prompts = config.prompts + (PromptScene.POLISH to updatedPolishConfig)
            )
        }

        return config
    }
}
```

### 3. è¿ç§»æ—¥å¿—è®°å½•

```kotlin
/**
 * è®°å½•è¿ç§»æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
 */
private fun logMigration(fromVersion: Int, toVersion: Int, details: String) {
    Log.i("PromptMigration", "è¿ç§» v$fromVersion -> v$toVersion: $details")
}
```

---

## ğŸ”’ å…¼å®¹æ€§å¤„ç†

### 1. åºŸå¼ƒåœºæ™¯çš„ä»£ç å¤„ç†

#### ActionTypeå…¼å®¹æ€§

```kotlin
enum class ActionType {
    ANALYZE,
    POLISH,
    REPLY,
    
    @Deprecated("ä½¿ç”¨ POLISH æ›¿ä»£")
    CHECK;

    companion object {
        /**
         * è·å–æ´»è·ƒçš„æ“ä½œç±»å‹ï¼ˆæ’é™¤åºŸå¼ƒç±»å‹ï¼‰
         */
        fun getActiveTypes(): List<ActionType> = listOf(ANALYZE, POLISH, REPLY)
    }
}
```

#### PromptScene.fromActionTypeå…¼å®¹æ€§

```kotlin
companion object {
    /**
     * ä» ActionType è·å–å¯¹åº”çš„ PromptScene
     * 
     * @param actionType æ“ä½œç±»å‹
     * @return å¯¹åº”çš„æç¤ºè¯åœºæ™¯
     */
    fun fromActionType(actionType: ActionType): PromptScene = when (actionType) {
        ActionType.ANALYZE -> ANALYZE
        ActionType.POLISH -> POLISH
        ActionType.REPLY -> REPLY
        @Suppress("DEPRECATION")
        ActionType.CHECK -> POLISH  // ğŸ†• CHECKæ˜ å°„åˆ°POLISH
    }
}
```

### 2. æ—§ç‰ˆæœ¬æ•°æ®å…¼å®¹

```kotlin
/**
 * å¤„ç†æ—§ç‰ˆæœ¬JSONä¸­å¯èƒ½å­˜åœ¨çš„åºŸå¼ƒåœºæ™¯
 */
class PromptSceneAdapter : JsonAdapter<PromptScene>() {
    @FromJson
    override fun fromJson(reader: JsonReader): PromptScene? {
        val name = reader.nextString()
        return try {
            PromptScene.valueOf(name)
        } catch (e: IllegalArgumentException) {
            // æœªçŸ¥åœºæ™¯è¿”å›nullï¼Œç”±è°ƒç”¨æ–¹å¤„ç†
            null
        }
    }

    @ToJson
    override fun toJson(writer: JsonWriter, value: PromptScene?) {
        writer.value(value?.name)
    }
}
```

### 3. é”™è¯¯æ¢å¤æœºåˆ¶

```kotlin
/**
 * é…ç½®æ–‡ä»¶æŸåæ—¶çš„æ¢å¤ç­–ç•¥
 */
suspend fun recoverFromCorruption(): Result<GlobalPromptConfig> {
    return try {
        // 1. å°è¯•ä»å¤‡ä»½æ¢å¤
        val backup = promptFileBackup.getLatestBackup()
        if (backup != null) {
            val config = adapter.fromJson(backup.readText())
            if (config != null) {
                writeGlobalConfig(config)
                return Result.success(config)
            }
        }

        // 2. å¤‡ä»½ä¹Ÿå¤±è´¥ï¼Œé‡ç½®ä¸ºé»˜è®¤
        val defaultConfig = GlobalPromptConfig.createDefault()
        writeGlobalConfig(defaultConfig)
        Result.success(defaultConfig)
    } catch (e: Exception) {
        Result.failure(e)
    }
}
```

---

## âš ï¸ é”™è¯¯å¤„ç†æœºåˆ¶

### 1. é”™è¯¯ç±»å‹å®šä¹‰

```kotlin
sealed class PromptSettingsError {
    object LoadFailed : PromptSettingsError()
    object SaveFailed : PromptSettingsError()
    object MigrationFailed : PromptSettingsError()
    object BackupFailed : PromptSettingsError()
    data class ValidationFailed(val message: String) : PromptSettingsError()
    data class UnknownError(val cause: Throwable) : PromptSettingsError()
}
```

### 2. é”™è¯¯å¤„ç†ç­–ç•¥

| é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·æç¤º | é‡è¯•æ¬¡æ•° |
|----------|----------|----------|----------|
| é…ç½®åŠ è½½å¤±è´¥ | ä½¿ç”¨é»˜è®¤é…ç½® | "åŠ è½½é…ç½®å¤±è´¥ï¼Œå·²ä½¿ç”¨é»˜è®¤è®¾ç½®" | 0 |
| é…ç½®ä¿å­˜å¤±è´¥ | é‡è¯•åæç¤º | "ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" | 3 |
| è¿ç§»å¤±è´¥ | ä¿ç•™åŸé…ç½® | é™é»˜å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ· | 1 |
| å¤‡ä»½å¤±è´¥ | ç»§ç»­æ“ä½œ | é™é»˜å¤„ç†ï¼Œè®°å½•æ—¥å¿— | 0 |
| éªŒè¯å¤±è´¥ | é˜»æ­¢ä¿å­˜ | æ˜¾ç¤ºå…·ä½“éªŒè¯é”™è¯¯ | 0 |

### 3. é”™è¯¯æ¢å¤æµç¨‹

```
é…ç½®åŠ è½½
    â†“
[æˆåŠŸ] â†’ æ£€æŸ¥è¿ç§» â†’ [éœ€è¦è¿ç§»] â†’ æ‰§è¡Œè¿ç§» â†’ [æˆåŠŸ] â†’ è¿”å›é…ç½®
    â†“                                    â†“
[å¤±è´¥]                              [å¤±è´¥] â†’ ä¿ç•™åŸé…ç½®
    â†“
å°è¯•å¤‡ä»½æ¢å¤
    â†“
[æˆåŠŸ] â†’ è¿”å›é…ç½®
    â†“
[å¤±è´¥] â†’ ä½¿ç”¨é»˜è®¤é…ç½®
```

### 4. è¯¦ç»†é”™è¯¯å¤„ç†å®ç°

```kotlin
@Singleton
class PromptErrorHandler @Inject constructor(
    private val promptFileBackup: PromptFileBackup,
    private val promptFileStorage: PromptFileStorage
) {
    companion object {
        private const val MAX_RETRY_COUNT = 3
        private const val RETRY_DELAY_MS = 500L
    }

    /**
     * å¸¦é‡è¯•çš„ä¿å­˜æ“ä½œ
     */
    suspend fun saveWithRetry(
        config: GlobalPromptConfig,
        onRetry: (Int) -> Unit = {}
    ): Result<Unit> {
        var lastError: Throwable? = null
        
        repeat(MAX_RETRY_COUNT) { attempt ->
            try {
                // å…ˆåˆ›å»ºå¤‡ä»½
                promptFileBackup.createBackup(promptFileStorage.globalPromptsFile)
                
                // æ‰§è¡Œä¿å­˜
                val result = promptFileStorage.writeGlobalConfig(config)
                if (result.isSuccess) {
                    return Result.success(Unit)
                }
                lastError = result.exceptionOrNull()
            } catch (e: Exception) {
                lastError = e
            }
            
            onRetry(attempt + 1)
            delay(RETRY_DELAY_MS * (attempt + 1))
        }
        
        return Result.failure(lastError ?: Exception("ä¿å­˜å¤±è´¥"))
    }

    /**
     * ä»é”™è¯¯ä¸­æ¢å¤é…ç½®
     */
    suspend fun recoverFromError(): Result<GlobalPromptConfig> {
        return try {
            // 1. å°è¯•ä»å¤‡ä»½æ¢å¤
            val backup = promptFileBackup.getLatestBackup()
            if (backup != null && backup.exists()) {
                val json = backup.readText(Charsets.UTF_8)
                val config = promptFileStorage.parseConfig(json)
                if (config != null) {
                    promptFileStorage.writeGlobalConfig(config)
                    return Result.success(config)
                }
            }

            // 2. å¤‡ä»½ä¹Ÿå¤±è´¥ï¼Œé‡ç½®ä¸ºé»˜è®¤
            val defaultConfig = GlobalPromptConfig.createDefault()
            promptFileStorage.writeGlobalConfig(defaultConfig)
            Result.success(defaultConfig)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

### 5. å›æ»šæœºåˆ¶

```kotlin
/**
 * æ•°æ®è¿ç§»å›æ»šæœºåˆ¶
 */
class MigrationRollback @Inject constructor(
    private val promptFileBackup: PromptFileBackup,
    private val promptFileStorage: PromptFileStorage
) {
    /**
     * åœ¨è¿ç§»å‰åˆ›å»ºå›æ»šç‚¹
     */
    suspend fun createRollbackPoint(): Result<File> {
        return promptFileBackup.createBackup(
            promptFileStorage.globalPromptsFile,
            prefix = "migration_rollback_"
        )
    }

    /**
     * æ‰§è¡Œå›æ»š
     */
    suspend fun rollback(rollbackFile: File): Result<Unit> {
        return try {
            if (rollbackFile.exists()) {
                rollbackFile.copyTo(promptFileStorage.globalPromptsFile, overwrite = true)
                Result.success(Unit)
            } else {
                Result.failure(FileNotFoundException("å›æ»šæ–‡ä»¶ä¸å­˜åœ¨"))
            }
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

---

## ğŸ“Š æ€§èƒ½å½±å“è¯„ä¼°

### 1. æ€§èƒ½å½±å“åˆ†æ

| æ“ä½œ | å½±å“èŒƒå›´ | é¢„ä¼°è€—æ—¶ | ä¼˜åŒ–å»ºè®® |
|------|----------|----------|----------|
| é…ç½®æ–‡ä»¶è¯»å– | åº”ç”¨å¯åŠ¨ | <50ms | ä½¿ç”¨å†…å­˜ç¼“å­˜ |
| é…ç½®æ–‡ä»¶å†™å…¥ | ä¿å­˜æ“ä½œ | <100ms | å¼‚æ­¥å†™å…¥ |
| æ•°æ®è¿ç§» | é¦–æ¬¡å‡çº§ | <200ms | åå°æ‰§è¡Œ |
| UIæ¸²æŸ“ | è®¾ç½®ç•Œé¢ | <16ms | ä½¿ç”¨LazyColumn |

### 2. å†…å­˜å½±å“

```kotlin
/**
 * å†…å­˜ä½¿ç”¨ä¼°ç®—
 * 
 * GlobalPromptConfigå¯¹è±¡å¤§å°ï¼š
 * - åŸºç¡€å¯¹è±¡ï¼š~100 bytes
 * - 4ä¸ªåœºæ™¯é…ç½®ï¼š~4KBï¼ˆæ¯ä¸ªåœºæ™¯çº¦1KBï¼‰
 * - å†å²è®°å½•ï¼ˆæ¯åœºæ™¯3æ¡ï¼‰ï¼š~12KB
 * - æ€»è®¡ï¼š~16KB
 * 
 * ç¼“å­˜ç­–ç•¥ï¼š
 * - ä½¿ç”¨å•ä¾‹ç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½
 * - é…ç½®å˜æ›´æ—¶æ›´æ–°ç¼“å­˜
 */
```

### 3. å¯åŠ¨æ—¶é—´å½±å“

```kotlin
/**
 * å¯åŠ¨æ—¶é—´ä¼˜åŒ–ç­–ç•¥
 */
class PromptConfigLoader @Inject constructor(
    private val promptFileStorage: PromptFileStorage,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) {
    // å»¶è¿ŸåŠ è½½ï¼Œä¸é˜»å¡åº”ç”¨å¯åŠ¨
    private val configDeferred = CoroutineScope(ioDispatcher).async(start = CoroutineStart.LAZY) {
        promptFileStorage.readGlobalConfig().getOrElse {
            GlobalPromptConfig.createDefault()
        }
    }

    suspend fun getConfig(): GlobalPromptConfig = configDeferred.await()
}
```

### 4. æ€§èƒ½ç›‘æ§ç‚¹

| ç›‘æ§ç‚¹ | æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« |
|--------|------|------|----------|
| é…ç½®åŠ è½½æ—¶é—´ | loadTime | >100ms | WARNING |
| é…ç½®ä¿å­˜æ—¶é—´ | saveTime | >200ms | WARNING |
| è¿ç§»æ‰§è¡Œæ—¶é—´ | migrationTime | >500ms | INFO |
| å†…å­˜å ç”¨ | memoryUsage | >50KB | INFO |

---

## ğŸ“ ç›‘æ§ä¸æ—¥å¿—

### 1. æ—¥å¿—è®°å½•ç­–ç•¥

```kotlin
object PromptSettingsLogger {
    private const val TAG = "PromptSettings"

    /**
     * è®°å½•é…ç½®åŠ è½½
     */
    fun logConfigLoad(success: Boolean, duration: Long, source: String) {
        if (success) {
            Log.i(TAG, "é…ç½®åŠ è½½æˆåŠŸ [æ¥æº=$source, è€—æ—¶=${duration}ms]")
        } else {
            Log.e(TAG, "é…ç½®åŠ è½½å¤±è´¥ [æ¥æº=$source, è€—æ—¶=${duration}ms]")
        }
    }

    /**
     * è®°å½•é…ç½®ä¿å­˜
     */
    fun logConfigSave(success: Boolean, scene: PromptScene?, duration: Long) {
        val sceneInfo = scene?.let { "[åœºæ™¯=${it.name}]" } ?: ""
        if (success) {
            Log.i(TAG, "é…ç½®ä¿å­˜æˆåŠŸ $sceneInfo [è€—æ—¶=${duration}ms]")
        } else {
            Log.e(TAG, "é…ç½®ä¿å­˜å¤±è´¥ $sceneInfo [è€—æ—¶=${duration}ms]")
        }
    }

    /**
     * è®°å½•æ•°æ®è¿ç§»
     */
    fun logMigration(fromVersion: Int, toVersion: Int, success: Boolean, details: String) {
        val status = if (success) "æˆåŠŸ" else "å¤±è´¥"
        Log.i(TAG, "æ•°æ®è¿ç§»$status [v$fromVersion â†’ v$toVersion] $details")
    }

    /**
     * è®°å½•é”™è¯¯æ¢å¤
     */
    fun logRecovery(method: String, success: Boolean) {
        val status = if (success) "æˆåŠŸ" else "å¤±è´¥"
        Log.w(TAG, "é”™è¯¯æ¢å¤$status [æ–¹æ³•=$method]")
    }
}
```

### 2. å…³é”®æ“ä½œç›‘æ§

```kotlin
/**
 * æ€§èƒ½ç›‘æ§åŒ…è£…å™¨
 */
suspend inline fun <T> measureAndLog(
    operationName: String,
    crossinline block: suspend () -> T
): T {
    val startTime = System.currentTimeMillis()
    return try {
        val result = block()
        val duration = System.currentTimeMillis() - startTime
        Log.d("PromptPerf", "$operationName å®Œæˆ [è€—æ—¶=${duration}ms]")
        result
    } catch (e: Exception) {
        val duration = System.currentTimeMillis() - startTime
        Log.e("PromptPerf", "$operationName å¤±è´¥ [è€—æ—¶=${duration}ms]", e)
        throw e
    }
}

// ä½¿ç”¨ç¤ºä¾‹
suspend fun loadConfig(): GlobalPromptConfig {
    return measureAndLog("åŠ è½½æç¤ºè¯é…ç½®") {
        promptFileStorage.readGlobalConfig().getOrThrow()
    }
}
```

### 3. ç”¨æˆ·è¡Œä¸ºè¿½è¸ª

```kotlin
/**
 * ç”¨æˆ·è¡Œä¸ºäº‹ä»¶ï¼ˆç”¨äºåˆ†æä¼˜åŒ–æ•ˆæœï¼‰
 */
sealed class PromptSettingsEvent {
    data class SceneViewed(val scene: PromptScene) : PromptSettingsEvent()
    data class PromptEdited(val scene: PromptScene, val charCount: Int) : PromptSettingsEvent()
    data class PromptSaved(val scene: PromptScene, val isCustom: Boolean) : PromptSettingsEvent()
    data class PromptReset(val scene: PromptScene) : PromptSettingsEvent()
}

/**
 * äº‹ä»¶è®°å½•å™¨ï¼ˆæœ¬åœ°å­˜å‚¨ï¼Œä¸ä¸Šä¼ ï¼‰
 */
class PromptSettingsAnalytics @Inject constructor(
    @ApplicationContext private val context: Context
) {
    private val prefs = context.getSharedPreferences("prompt_analytics", Context.MODE_PRIVATE)

    fun trackEvent(event: PromptSettingsEvent) {
        when (event) {
            is PromptSettingsEvent.SceneViewed -> {
                incrementCounter("view_${event.scene.name}")
            }
            is PromptSettingsEvent.PromptEdited -> {
                incrementCounter("edit_${event.scene.name}")
            }
            is PromptSettingsEvent.PromptSaved -> {
                incrementCounter("save_${event.scene.name}")
            }
            is PromptSettingsEvent.PromptReset -> {
                incrementCounter("reset_${event.scene.name}")
            }
        }
    }

    private fun incrementCounter(key: String) {
        val current = prefs.getInt(key, 0)
        prefs.edit().putInt(key, current + 1).apply()
    }
}
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

#### PromptSceneæµ‹è¯•

```kotlin
class PromptSceneTest {

    @Test
    fun `getSettingsScenesåº”è¯¥è¿”å›4ä¸ªæ ¸å¿ƒåœºæ™¯`() {
        val scenes = PromptScene.getSettingsScenes()
        
        assertEquals(4, scenes.size)
        assertTrue(scenes.contains(PromptScene.ANALYZE))
        assertTrue(scenes.contains(PromptScene.POLISH))
        assertTrue(scenes.contains(PromptScene.REPLY))
        assertTrue(scenes.contains(PromptScene.SUMMARY))
    }

    @Test
    fun `getSettingsScenesä¸åº”è¯¥åŒ…å«åºŸå¼ƒåœºæ™¯`() {
        val scenes = PromptScene.getSettingsScenes()
        
        @Suppress("DEPRECATION")
        assertFalse(scenes.contains(PromptScene.CHECK))
        @Suppress("DEPRECATION")
        assertFalse(scenes.contains(PromptScene.EXTRACT))
    }

    @Test
    fun `fromActionTypeåº”è¯¥å°†CHECKæ˜ å°„åˆ°POLISH`() {
        @Suppress("DEPRECATION")
        val scene = PromptScene.fromActionType(ActionType.CHECK)
        
        assertEquals(PromptScene.POLISH, scene)
    }
}
```

#### æ•°æ®è¿ç§»æµ‹è¯•

```kotlin
class PromptMigrationTest {

    @Test
    fun `è¿ç§»åº”è¯¥å°†CHECKè‡ªå®šä¹‰å†…å®¹åˆå¹¶åˆ°POLISH`() {
        // Given
        val oldConfig = GlobalPromptConfig(
            version = 1,
            prompts = mapOf(
                @Suppress("DEPRECATION")
                PromptScene.CHECK to ScenePromptConfig(
                    userPrompt = "è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥æŒ‡ä»¤",
                    enabled = true
                ),
                PromptScene.POLISH to ScenePromptConfig(
                    userPrompt = "è‡ªå®šä¹‰æ¶¦è‰²æŒ‡ä»¤",
                    enabled = true
                )
            )
        )

        // When
        val migratedConfig = storage.migrateIfNeeded(oldConfig)

        // Then
        val polishPrompt = migratedConfig.prompts[PromptScene.POLISH]?.userPrompt
        assertTrue(polishPrompt?.contains("è‡ªå®šä¹‰æ¶¦è‰²æŒ‡ä»¤") == true)
        assertTrue(polishPrompt?.contains("è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥æŒ‡ä»¤") == true)
    }

    @Test
    fun `è¿ç§»ä¸åº”è¯¥å½±å“é»˜è®¤CHECKå†…å®¹`() {
        // Given
        val oldConfig = GlobalPromptConfig(
            version = 1,
            prompts = mapOf(
                @Suppress("DEPRECATION")
                PromptScene.CHECK to ScenePromptConfig(
                    userPrompt = DefaultPrompts.getDefault(PromptScene.CHECK),
                    enabled = true
                )
            )
        )

        // When
        val migratedConfig = storage.migrateIfNeeded(oldConfig)

        // Then
        val polishPrompt = migratedConfig.prompts[PromptScene.POLISH]?.userPrompt
        assertFalse(polishPrompt?.contains("åŸå®‰å…¨æ£€æŸ¥æŒ‡ä»¤") == true)
    }
}
```

### 2. UIæµ‹è¯•

```kotlin
class PromptSettingsSectionTest {

    @get:Rule
    val composeTestRule = createComposeRule()

    @Test
    fun `è®¾ç½®ç•Œé¢åº”è¯¥æ˜¾ç¤º4ä¸ªæç¤ºè¯é€‰é¡¹`() {
        composeTestRule.setContent {
            PromptSettingsSection(
                scenes = PromptScene.getSettingsScenes(),
                onSceneClick = {}
            )
        }

        composeTestRule.onNodeWithText("èŠå¤©åˆ†ææŒ‡ä»¤").assertIsDisplayed()
        composeTestRule.onNodeWithText("æ¶¦è‰²ä¼˜åŒ–æŒ‡ä»¤").assertIsDisplayed()
        composeTestRule.onNodeWithText("ç”Ÿæˆå›å¤æŒ‡ä»¤").assertIsDisplayed()
        composeTestRule.onNodeWithText("æ¯æ—¥æ€»ç»“æŒ‡ä»¤").assertIsDisplayed()
    }

    @Test
    fun `è®¾ç½®ç•Œé¢ä¸åº”è¯¥æ˜¾ç¤ºåºŸå¼ƒåœºæ™¯`() {
        composeTestRule.setContent {
            PromptSettingsSection(
                scenes = PromptScene.getSettingsScenes(),
                onSceneClick = {}
            )
        }

        composeTestRule.onNodeWithText("å®‰å…¨æ£€æŸ¥æŒ‡ä»¤").assertDoesNotExist()
        composeTestRule.onNodeWithText("ä¿¡æ¯æå–æŒ‡ä»¤").assertDoesNotExist()
    }
}
```

### 3. é›†æˆæµ‹è¯•

```kotlin
class PromptSettingsIntegrationTest {

    @Test
    fun `ä»æ—§ç‰ˆæœ¬å‡çº§ååº”è¯¥æ­£ç¡®è¿ç§»æ•°æ®`() = runTest {
        // Given: æ¨¡æ‹Ÿæ—§ç‰ˆæœ¬é…ç½®æ–‡ä»¶
        val oldConfigJson = """
            {
                "version": 1,
                "prompts": {
                    "CHECK": {"userPrompt": "è‡ªå®šä¹‰æ£€æŸ¥", "enabled": true}
                }
            }
        """.trimIndent()
        
        // When: è¯»å–é…ç½®
        val config = storage.readGlobalConfig().getOrThrow()
        
        // Then: éªŒè¯è¿ç§»ç»“æœ
        assertEquals(2, config.version)
        assertTrue(config.prompts[PromptScene.POLISH]?.userPrompt?.contains("è‡ªå®šä¹‰æ£€æŸ¥") == true)
    }
}
```

---

## ğŸ“… å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®å±‚ä¼˜åŒ–ï¼ˆ1å¤©ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„ä¼°æ—¶é—´ |
|------|--------|----------|
| æ›´æ–°PromptSceneæšä¸¾ | P0 | 1å°æ—¶ |
| å®ç°è¿ç§»é€»è¾‘ | P0 | 2å°æ—¶ |
| æ›´æ–°SystemPrompts | P1 | 1å°æ—¶ |
| æ›´æ–°DefaultPrompts | P1 | 1å°æ—¶ |
| ç¼–å†™å•å…ƒæµ‹è¯• | P0 | 2å°æ—¶ |

### ç¬¬äºŒé˜¶æ®µï¼šUIç•Œé¢æ›´æ–°ï¼ˆ0.5å¤©ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„ä¼°æ—¶é—´ |
|------|--------|----------|
| æ›´æ–°SettingsViewModel | P0 | 1å°æ—¶ |
| æ›´æ–°SettingsScreen | P0 | 1å°æ—¶ |
| ç¼–å†™UIæµ‹è¯• | P1 | 1å°æ—¶ |

### ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•å’ŒéªŒè¯ï¼ˆ0.5å¤©ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„ä¼°æ—¶é—´ |
|------|--------|----------|
| é›†æˆæµ‹è¯• | P0 | 1å°æ—¶ |
| å…¼å®¹æ€§éªŒè¯ | P0 | 1å°æ—¶ |
| æ–‡æ¡£æ›´æ–° | P1 | 1å°æ—¶ |

### é‡Œç¨‹ç¢‘

```
Day 1: æ•°æ®å±‚ä¼˜åŒ–å®Œæˆ
  â”œâ”€â”€ PromptSceneæšä¸¾æ›´æ–° âœ“
  â”œâ”€â”€ è¿ç§»é€»è¾‘å®ç° âœ“
  â”œâ”€â”€ æç¤ºè¯å†…å®¹ä¼˜åŒ– âœ“
  â””â”€â”€ å•å…ƒæµ‹è¯•é€šè¿‡ âœ“

Day 2: UIæ›´æ–°å’Œæµ‹è¯•å®Œæˆ
  â”œâ”€â”€ è®¾ç½®ç•Œé¢æ›´æ–° âœ“
  â”œâ”€â”€ UIæµ‹è¯•é€šè¿‡ âœ“
  â”œâ”€â”€ é›†æˆæµ‹è¯•é€šè¿‡ âœ“
  â””â”€â”€ æ–‡æ¡£æ›´æ–° âœ“
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PRD-00015 æç¤ºè¯è®¾ç½®ä¼˜åŒ–éœ€æ±‚](../PRD/PRD-00015-æç¤ºè¯è®¾ç½®ä¼˜åŒ–éœ€æ±‚.md)
- [FD-00005 æç¤ºè¯ç®¡ç†ç³»ç»ŸåŠŸèƒ½è®¾è®¡](../FD/FD-00005-æç¤ºè¯ç®¡ç†ç³»ç»ŸåŠŸèƒ½è®¾è®¡.md)
- [FD-00006 æç¤ºè¯ç¼–è¾‘ç•Œé¢åŠŸèƒ½è®¾è®¡](../FD/FD-00006-æç¤ºè¯ç¼–è¾‘ç•Œé¢åŠŸèƒ½è®¾è®¡.md)
- [TDD-00006 æç¤ºè¯ç¼–è¾‘ç•Œé¢æŠ€æœ¯è®¾è®¡](../TDD/TDD-00006-æç¤ºè¯ç¼–è¾‘ç•Œé¢æŠ€æœ¯è®¾è®¡.md)

---

## ğŸ“ é™„å½•

### A. åœºæ™¯å˜é‡å¯¹ç…§è¡¨

| åœºæ™¯ | å˜é‡ | è¯´æ˜ |
|------|------|------|
| ANALYZE | contact_name | è”ç³»äººå§“å |
| | relationship_status | å…³ç³»çŠ¶æ€ |
| | risk_tags | é›·åŒºæ ‡ç­¾åˆ—è¡¨ |
| | strategy_tags | ç­–ç•¥æ ‡ç­¾åˆ—è¡¨ |
| | facts_count | å·²è®°å½•äº‹å®æ•°é‡ |
| POLISH | contact_name | è”ç³»äººå§“å |
| | relationship_status | å…³ç³»çŠ¶æ€ |
| | risk_tags | é›·åŒºæ ‡ç­¾åˆ—è¡¨ |
| REPLY | contact_name | è”ç³»äººå§“å |
| | relationship_status | å…³ç³»çŠ¶æ€ |
| | risk_tags | é›·åŒºæ ‡ç­¾åˆ—è¡¨ |
| | strategy_tags | ç­–ç•¥æ ‡ç­¾åˆ—è¡¨ |
| SUMMARY | contact_name | è”ç³»äººå§“å |
| | relationship_status | å…³ç³»çŠ¶æ€ |
| | facts_count | å·²è®°å½•äº‹å®æ•°é‡ |
| | today_date | ä»Šæ—¥æ—¥æœŸ |

### B. è¿ç§»ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | å˜æ›´å†…å®¹ |
|------|----------|
| v1 | åˆå§‹ç‰ˆæœ¬ï¼Œ6ä¸ªåœºæ™¯ |
| v2 | ç®€åŒ–ä¸º4ä¸ªåœºæ™¯ï¼ŒCHECKåˆå¹¶åˆ°POLISH |

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å®¡æŸ¥é€šè¿‡  
**åˆ›å»ºæ—¥æœŸ**: 2025-12-22  
**è´Ÿè´£äºº**: Kiro  
**å®¡æ ¸çŠ¶æ€**: å·²é€šè¿‡ï¼ˆDR-00015ï¼‰
