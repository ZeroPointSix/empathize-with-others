# FD-00016: å¯¹è¯ä¸»é¢˜åŠŸèƒ½è®¾è®¡

> **æ–‡æ¡£ç±»å‹**: åŠŸèƒ½è®¾è®¡æ–‡æ¡£ (FD)  
> **ç‰ˆæœ¬**: 1.1  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-22  
> **æœ€åæ›´æ–°**: 2025-12-22  
> **è´Ÿè´£äºº**: Kiro  
> **çŠ¶æ€**: âœ… å®¡æŸ¥é€šè¿‡  
> **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­  
> **å…³è”PRD**: PRD-00016  
> **å…³è”FD**: FD-00005ï¼ˆæç¤ºè¯ç®¡ç†ç³»ç»ŸåŠŸèƒ½è®¾è®¡ï¼‰ã€FD-00009ï¼ˆæ‚¬æµ®çª—åŠŸèƒ½é‡æ„åŠŸèƒ½è®¾è®¡ï¼‰  
> **å…³è”å®¡æŸ¥**: DR-00016

---

## ğŸ“œ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-22 | Kiro | åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«å¯¹è¯ä¸»é¢˜åŠŸèƒ½çš„å®Œæ•´è®¾è®¡ |
| 1.1 | 2025-12-22 | Kiro | æ ¹æ®DR-00016å®¡æŸ¥æŠ¥å‘Šè¡¥å……ï¼šç³»ç»Ÿé›†æˆè®¾è®¡ã€ç”¨æˆ·å…¥å£ç‚¹ã€æ•°æ®åº“é›†æˆã€ç®€åŒ–é”™è¯¯å¤„ç† |

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°å¯¹è¯ä¸»é¢˜åŠŸèƒ½çš„æŠ€æœ¯æ¶æ„ã€æ•°æ®æ¨¡å‹ã€UIè®¾è®¡å’Œå®ç°ç»†èŠ‚ã€‚

**è®¾è®¡ç›®æ ‡**ï¼š
- å…è®¸ç”¨æˆ·ä¸ºæ¯ä¸ªè”ç³»äººè®¾ç½®ç‹¬ç«‹çš„å¯¹è¯ä¸»é¢˜
- ä¸»é¢˜ä½œä¸ºç³»ç»Ÿæç¤ºè¯çš„ä¸€éƒ¨åˆ†ä¼ é€’ç»™AI
- æ”¯æŒä¸»é¢˜çš„æŒä¹…åŒ–å­˜å‚¨å’Œè·¨ä¼šè¯ä¿æŒ
- æä¾›ç®€æ´æ˜“ç”¨çš„ä¸»é¢˜ç®¡ç†ç•Œé¢

**ä¾èµ–åº“ç‰ˆæœ¬**ï¼š
- Room: 2.6.1ï¼ˆæ•°æ®åº“ï¼‰
- Kotlin Coroutines: 1.9.0ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
- Hilt: 2.52ï¼ˆä¾èµ–æ³¨å…¥ï¼‰
- Jetpack Compose: BOM 2024.12.01ï¼ˆUIæ¡†æ¶ï¼‰

---

## ğŸ“‘ ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [ç³»ç»Ÿé›†æˆè®¾è®¡](#ç³»ç»Ÿé›†æˆè®¾è®¡)
3. [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
4. [é¢†åŸŸå±‚è®¾è®¡](#é¢†åŸŸå±‚è®¾è®¡)
5. [æ•°æ®å±‚è®¾è®¡](#æ•°æ®å±‚è®¾è®¡)
6. [è¡¨ç°å±‚è®¾è®¡](#è¡¨ç°å±‚è®¾è®¡)
7. [ç³»ç»Ÿæç¤ºè¯é›†æˆ](#ç³»ç»Ÿæç¤ºè¯é›†æˆ)
8. [UIç•Œé¢è®¾è®¡](#uiç•Œé¢è®¾è®¡)
9. [ç”¨æˆ·å…¥å£ç‚¹è®¾è®¡](#ç”¨æˆ·å…¥å£ç‚¹è®¾è®¡)
10. [é”™è¯¯å¤„ç†æœºåˆ¶](#é”™è¯¯å¤„ç†æœºåˆ¶)
11. [æ€§èƒ½å½±å“è¯„ä¼°](#æ€§èƒ½å½±å“è¯„ä¼°)
12. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
13. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¯¹è¯ä¸»é¢˜åŠŸèƒ½æ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Presentation Layer                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ TopicDialog â”‚  â”‚ TopicBadge  â”‚  â”‚ TopicViewModel  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ä¸»é¢˜è®¾ç½®   â”‚  â”‚  çŠ¶æ€æŒ‡ç¤º   â”‚  â”‚   çŠ¶æ€ç®¡ç†      â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Domain Layer                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ ConversationTopicâ”‚  â”‚ TopicRepository (Interface) â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     é¢†åŸŸæ¨¡å‹     â”‚  â”‚        ä»“åº“æ¥å£              â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ SetTopicUseCase â”‚  â”‚ GetTopicUseCase             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚   è®¾ç½®ä¸»é¢˜ç”¨ä¾‹   â”‚  â”‚   è·å–ä¸»é¢˜ç”¨ä¾‹              â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                       Data Layer                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ TopicEntity     â”‚  â”‚ TopicRepositoryImpl         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚   æ•°æ®åº“å®ä½“     â”‚  â”‚      ä»“åº“å®ç°               â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚   â”‚
â”‚  â”‚  â”‚ TopicDao        â”‚                                    â”‚   â”‚
â”‚  â”‚  â”‚   æ•°æ®è®¿é—®å¯¹è±¡   â”‚                                    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—å½±å“èŒƒå›´

```
domain/
â”œâ”€â”€ model/
â”‚   â””â”€â”€ ConversationTopic.kt          # ğŸ†• æ–°å¢ï¼šå¯¹è¯ä¸»é¢˜é¢†åŸŸæ¨¡å‹
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ TopicRepository.kt            # ğŸ†• æ–°å¢ï¼šä¸»é¢˜ä»“åº“æ¥å£
â””â”€â”€ usecase/
    â”œâ”€â”€ SetTopicUseCase.kt            # ğŸ†• æ–°å¢ï¼šè®¾ç½®ä¸»é¢˜ç”¨ä¾‹
    â”œâ”€â”€ GetTopicUseCase.kt            # ğŸ†• æ–°å¢ï¼šè·å–ä¸»é¢˜ç”¨ä¾‹
    â””â”€â”€ ClearTopicUseCase.kt          # ğŸ†• æ–°å¢ï¼šæ¸…é™¤ä¸»é¢˜ç”¨ä¾‹

data/
â”œâ”€â”€ local/
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â””â”€â”€ ConversationTopicEntity.kt # ğŸ†• æ–°å¢ï¼šä¸»é¢˜æ•°æ®åº“å®ä½“
â”‚   â””â”€â”€ dao/
â”‚       â””â”€â”€ ConversationTopicDao.kt    # ğŸ†• æ–°å¢ï¼šä¸»é¢˜DAO
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ TopicRepositoryImpl.kt         # ğŸ†• æ–°å¢ï¼šä¸»é¢˜ä»“åº“å®ç°

presentation/
â”œâ”€â”€ ui/component/topic/
â”‚   â”œâ”€â”€ TopicSettingDialog.kt          # ğŸ†• æ–°å¢ï¼šä¸»é¢˜è®¾ç½®å¯¹è¯æ¡†
â”‚   â”œâ”€â”€ TopicBadge.kt                  # ğŸ†• æ–°å¢ï¼šä¸»é¢˜çŠ¶æ€å¾½ç« 
â”‚   â””â”€â”€ TopicInputField.kt             # ğŸ†• æ–°å¢ï¼šä¸»é¢˜è¾“å…¥æ¡†
â”œâ”€â”€ viewmodel/
â”‚   â””â”€â”€ TopicViewModel.kt              # ğŸ†• æ–°å¢ï¼šä¸»é¢˜ViewModel
â””â”€â”€ ui/floating/
    â””â”€â”€ FloatingViewV2.kt              # ğŸ”„ æ›´æ–°ï¼šé›†æˆä¸»é¢˜æ˜¾ç¤º

di/
â””â”€â”€ TopicModule.kt                     # ğŸ†• æ–°å¢ï¼šä¸»é¢˜ä¾èµ–æ³¨å…¥æ¨¡å—
```

---

## ğŸ”— ç³»ç»Ÿé›†æˆè®¾è®¡

> **é‡è¦**: æœ¬ç« èŠ‚å®šä¹‰äº†å¯¹è¯ä¸»é¢˜åŠŸèƒ½ä¸ç°æœ‰ç³»ç»Ÿçš„æ‰€æœ‰é›†æˆç‚¹ï¼Œæ˜¯åŠŸèƒ½æ­£ç¡®è¿è¡Œçš„å…³é”®ã€‚

### 1. æ•°æ®åº“é›†æˆ

#### 1.1 AppDatabaseæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/AppDatabase.kt`

```kotlin
@Database(
    entities = [
        ContactProfileEntity::class,
        BrainTagEntity::class,
        AiProviderEntity::class,
        ConversationLogEntity::class,
        DailySummaryEntity::class,
        FailedSummaryTaskEntity::class,
        ConversationTopicEntity::class  // ğŸ†• æ–°å¢å®ä½“
    ],
    version = 11,  // ğŸ”„ ç‰ˆæœ¬å‡çº§ 10 â†’ 11
    exportSchema = true
)
@TypeConverters(RoomTypeConverters::class, FactListConverter::class)
abstract class AppDatabase : RoomDatabase() {
    
    // ç°æœ‰DAO...
    abstract fun contactDao(): ContactDao
    abstract fun brainTagDao(): BrainTagDao
    abstract fun aiProviderDao(): AiProviderDao
    abstract fun conversationLogDao(): ConversationLogDao
    abstract fun dailySummaryDao(): DailySummaryDao
    abstract fun failedSummaryTaskDao(): FailedSummaryTaskDao
    
    // ğŸ†• æ–°å¢DAO
    abstract fun conversationTopicDao(): ConversationTopicDao
}
```

#### 1.2 è¿ç§»è„šæœ¬é›†æˆ

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/AppDatabase.kt`ï¼ˆä¼´ç”Ÿå¯¹è±¡ï¼‰

```kotlin
companion object {
    // ç°æœ‰è¿ç§»...
    
    // ğŸ†• æ–°å¢è¿ç§»
    val MIGRATION_10_11 = object : Migration(10, 11) {
        override fun migrate(database: SupportSQLiteDatabase) {
            // åˆ›å»ºconversation_topicsè¡¨
            database.execSQL("""
                CREATE TABLE IF NOT EXISTS conversation_topics (
                    id TEXT PRIMARY KEY NOT NULL,
                    contact_id TEXT NOT NULL,
                    content TEXT NOT NULL,
                    created_at INTEGER NOT NULL,
                    updated_at INTEGER NOT NULL,
                    is_active INTEGER NOT NULL DEFAULT 1,
                    FOREIGN KEY (contact_id) REFERENCES contact_profiles(id) ON DELETE CASCADE
                )
            """)
            
            // åˆ›å»ºç´¢å¼•
            database.execSQL("""
                CREATE INDEX IF NOT EXISTS index_conversation_topics_contact_id 
                ON conversation_topics(contact_id)
            """)
            
            database.execSQL("""
                CREATE INDEX IF NOT EXISTS index_conversation_topics_contact_id_is_active 
                ON conversation_topics(contact_id, is_active)
            """)
        }
    }
}
```

#### 1.3 DatabaseModuleæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`di/DatabaseModule.kt`

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object DatabaseModule {
    
    @Provides
    @Singleton
    fun provideAppDatabase(@ApplicationContext context: Context): AppDatabase {
        return Room.databaseBuilder(
            context,
            AppDatabase::class.java,
            "empathy_database"
        )
            .addMigrations(
                // ç°æœ‰è¿ç§»...
                MIGRATION_9_10,
                MIGRATION_10_11  // ğŸ†• æ·»åŠ æ–°è¿ç§»
            )
            .build()
    }
    
    // ç°æœ‰DAOæä¾›æ–¹æ³•...
    
    // ğŸ†• æ–°å¢DAOæä¾›æ–¹æ³•
    @Provides
    fun provideConversationTopicDao(database: AppDatabase): ConversationTopicDao {
        return database.conversationTopicDao()
    }
}
```

### 2. ä¾èµ–æ³¨å…¥é›†æˆ

#### 2.1 TopicModuleå®Œæ•´é…ç½®

**æ–‡ä»¶ä½ç½®**ï¼š`di/TopicModule.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜ä¾èµ–æ³¨å…¥æ¨¡å—
 * 
 * æä¾›ä¸»é¢˜åŠŸèƒ½æ‰€éœ€çš„æ‰€æœ‰ä¾èµ–
 */
@Module
@InstallIn(SingletonComponent::class)
object TopicModule {
    
    // DAOç”±DatabaseModuleæä¾›ï¼Œæ­¤å¤„ä¸éœ€è¦é‡å¤æä¾›
    
    @Provides
    @Singleton
    fun provideTopicRepository(
        topicDao: ConversationTopicDao,
        @IoDispatcher ioDispatcher: CoroutineDispatcher
    ): TopicRepository {
        return TopicRepositoryImpl(topicDao, ioDispatcher)
    }
    
    @Provides
    fun provideSetTopicUseCase(
        topicRepository: TopicRepository
    ): SetTopicUseCase {
        return SetTopicUseCase(topicRepository)
    }
    
    @Provides
    fun provideGetTopicUseCase(
        topicRepository: TopicRepository
    ): GetTopicUseCase {
        return GetTopicUseCase(topicRepository)
    }
    
    @Provides
    fun provideClearTopicUseCase(
        topicRepository: TopicRepository
    ): ClearTopicUseCase {
        return ClearTopicUseCase(topicRepository)
    }
}
```

#### 2.2 ç°æœ‰UseCaseä¾èµ–æ›´æ–°

**æ›´æ–° FloatingWindowModule**ï¼š

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object FloatingWindowModule {
    
    // ç°æœ‰æä¾›æ–¹æ³•...
    
    // ğŸ”„ æ›´æ–°ï¼šAnalyzeChatUseCaseéœ€è¦TopicRepository
    @Provides
    fun provideAnalyzeChatUseCase(
        aiRepository: AiRepository,
        promptBuilder: PromptBuilder,
        topicRepository: TopicRepository  // ğŸ†• æ–°å¢ä¾èµ–
    ): AnalyzeChatUseCase {
        return AnalyzeChatUseCase(aiRepository, promptBuilder, topicRepository)
    }
    
    // ğŸ”„ æ›´æ–°ï¼šPolishDraftUseCaseéœ€è¦TopicRepository
    @Provides
    fun providePolishDraftUseCase(
        aiRepository: AiRepository,
        promptBuilder: PromptBuilder,
        sessionContextService: SessionContextService,
        topicRepository: TopicRepository  // ğŸ†• æ–°å¢ä¾èµ–
    ): PolishDraftUseCase {
        return PolishDraftUseCase(aiRepository, promptBuilder, sessionContextService, topicRepository)
    }
    
    // ğŸ”„ æ›´æ–°ï¼šGenerateReplyUseCaseéœ€è¦TopicRepository
    @Provides
    fun provideGenerateReplyUseCase(
        aiRepository: AiRepository,
        promptBuilder: PromptBuilder,
        sessionContextService: SessionContextService,
        topicRepository: TopicRepository  // ğŸ†• æ–°å¢ä¾èµ–
    ): GenerateReplyUseCase {
        return GenerateReplyUseCase(aiRepository, promptBuilder, sessionContextService, topicRepository)
    }
}
```

### 3. å¯¼èˆªç³»ç»Ÿé›†æˆ

#### 3.1 NavRoutesæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/navigation/NavRoutes.kt`

```kotlin
object NavRoutes {
    // ç°æœ‰è·¯ç”±...
    const val CONTACT_LIST = "contact_list"
    const val CONTACT_DETAIL = "contact_detail/{contactId}"
    const val SETTINGS = "settings"
    const val AI_CONFIG = "ai_config"
    const val PROMPT_EDITOR = "prompt_editor"
    
    // ğŸ†• ä¸»é¢˜è®¾ç½®ä¸éœ€è¦ç‹¬ç«‹é¡µé¢ï¼Œä½¿ç”¨å¯¹è¯æ¡†å½¢å¼
    // ä¸»é¢˜è®¾ç½®å…¥å£é›†æˆåœ¨ContactDetailScreenå’ŒFloatingViewV2ä¸­
    
    // è¾…åŠ©æ–¹æ³•
    fun contactDetail(contactId: String) = "contact_detail/$contactId"
}
```

#### 3.2 å¯¼èˆªè¯´æ˜

ä¸»é¢˜è®¾ç½®åŠŸèƒ½é‡‡ç”¨**å¯¹è¯æ¡†å½¢å¼**è€Œéç‹¬ç«‹é¡µé¢ï¼Œå› æ­¤ä¸éœ€è¦åœ¨NavGraphä¸­æ·»åŠ æ–°è·¯ç”±ã€‚ä¸»é¢˜è®¾ç½®å¯¹è¯æ¡†é€šè¿‡ä»¥ä¸‹æ–¹å¼è§¦å‘ï¼š

1. **è”ç³»äººè¯¦æƒ…é¡µ**: ç‚¹å‡»é¡¶éƒ¨å·¥å…·æ çš„ä¸»é¢˜å›¾æ ‡
2. **æ‚¬æµ®çª—**: ç‚¹å‡»ä¸»é¢˜çŠ¶æ€å¾½ç« 

### 4. é›†æˆç‚¹éªŒè¯æ¸…å•

| é›†æˆç‚¹ | æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|------|
| Entityæ³¨å†Œ | AppDatabase.kt | âœ… å·²å®šä¹‰ | ConversationTopicEntityæ·»åŠ åˆ°entitiesæ•°ç»„ |
| DAOæä¾› | DatabaseModule.kt | âœ… å·²å®šä¹‰ | provideConversationTopicDaoæ–¹æ³• |
| è¿ç§»é›†æˆ | AppDatabase.kt | âœ… å·²å®šä¹‰ | MIGRATION_10_11æ·»åŠ åˆ°addMigrations |
| Repositoryç»‘å®š | TopicModule.kt | âœ… å·²å®šä¹‰ | provideTopicRepositoryæ–¹æ³• |
| UseCaseæ›´æ–° | FloatingWindowModule.kt | âœ… å·²å®šä¹‰ | ä¸‰ä¸ªUseCaseæ·»åŠ TopicRepositoryä¾èµ– |
| å…¥å£ç‚¹-è”ç³»äººè¯¦æƒ… | ContactDetailScreen.kt | âœ… å·²å®šä¹‰ | é¡¶éƒ¨å·¥å…·æ ä¸»é¢˜å›¾æ ‡ |
| å…¥å£ç‚¹-æ‚¬æµ®çª— | FloatingViewV2.kt | âœ… å·²å®šä¹‰ | ä¸»é¢˜çŠ¶æ€å¾½ç«  |

---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### 1. é¢†åŸŸæ¨¡å‹

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/ConversationTopic.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜é¢†åŸŸæ¨¡å‹
 *
 * è¡¨ç¤ºç”¨æˆ·ä¸ºç‰¹å®šè”ç³»äººè®¾ç½®çš„å¯¹è¯ä¸»é¢˜ï¼Œç”¨äºå¢å¼ºAIç†è§£å¯¹è¯èƒŒæ™¯
 *
 * @property id ä¸»é¢˜å”¯ä¸€æ ‡è¯†
 * @property contactId å…³è”çš„è”ç³»äººID
 * @property content ä¸»é¢˜å†…å®¹ï¼ˆæœ€å¤š500å­—ç¬¦ï¼‰
 * @property createdAt åˆ›å»ºæ—¶é—´
 * @property updatedAt æœ€åæ›´æ–°æ—¶é—´
 * @property isActive æ˜¯å¦ä¸ºå½“å‰æ´»è·ƒä¸»é¢˜
 */
data class ConversationTopic(
    val id: String = UUID.randomUUID().toString(),
    val contactId: String,
    val content: String,
    val createdAt: Long = System.currentTimeMillis(),
    val updatedAt: Long = System.currentTimeMillis(),
    val isActive: Boolean = true
) {
    companion object {
        /** ä¸»é¢˜å†…å®¹æœ€å¤§é•¿åº¦ */
        const val MAX_CONTENT_LENGTH = 500
        
        /** ä¸»é¢˜é¢„è§ˆæœ€å¤§é•¿åº¦ */
        const val PREVIEW_LENGTH = 50
    }
    
    /**
     * è·å–ä¸»é¢˜å†…å®¹é¢„è§ˆï¼ˆå‰50å­—ç¬¦ï¼‰
     */
    fun getPreview(): String {
        return if (content.length > PREVIEW_LENGTH) {
            content.take(PREVIEW_LENGTH) + "..."
        } else {
            content
        }
    }
    
    /**
     * éªŒè¯ä¸»é¢˜å†…å®¹æ˜¯å¦æœ‰æ•ˆ
     */
    fun isValid(): Boolean {
        return content.isNotBlank() && content.length <= MAX_CONTENT_LENGTH
    }
}
```

### 2. æ•°æ®åº“å®ä½“

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/entity/ConversationTopicEntity.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜æ•°æ®åº“å®ä½“
 */
@Entity(
    tableName = "conversation_topics",
    foreignKeys = [
        ForeignKey(
            entity = ContactProfileEntity::class,
            parentColumns = ["id"],
            childColumns = ["contact_id"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [
        Index(value = ["contact_id"]),
        Index(value = ["contact_id", "is_active"])
    ]
)
data class ConversationTopicEntity(
    @PrimaryKey
    @ColumnInfo(name = "id")
    val id: String,
    
    @ColumnInfo(name = "contact_id")
    val contactId: String,
    
    @ColumnInfo(name = "content")
    val content: String,
    
    @ColumnInfo(name = "created_at")
    val createdAt: Long,
    
    @ColumnInfo(name = "updated_at")
    val updatedAt: Long,
    
    @ColumnInfo(name = "is_active")
    val isActive: Boolean
) {
    /**
     * è½¬æ¢ä¸ºé¢†åŸŸæ¨¡å‹
     */
    fun toDomain(): ConversationTopic = ConversationTopic(
        id = id,
        contactId = contactId,
        content = content,
        createdAt = createdAt,
        updatedAt = updatedAt,
        isActive = isActive
    )
    
    companion object {
        /**
         * ä»é¢†åŸŸæ¨¡å‹åˆ›å»ºå®ä½“
         */
        fun fromDomain(topic: ConversationTopic): ConversationTopicEntity =
            ConversationTopicEntity(
                id = topic.id,
                contactId = topic.contactId,
                content = topic.content,
                createdAt = topic.createdAt,
                updatedAt = topic.updatedAt,
                isActive = topic.isActive
            )
    }
}
```

### 3. æ•°æ®åº“è¿ç§»

**Roomæ•°æ®åº“ç‰ˆæœ¬å‡çº§**ï¼šv10 â†’ v11

```kotlin
/**
 * æ•°æ®åº“è¿ç§»ï¼šæ·»åŠ conversation_topicsè¡¨
 */
val MIGRATION_10_11 = object : Migration(10, 11) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS conversation_topics (
                id TEXT PRIMARY KEY NOT NULL,
                contact_id TEXT NOT NULL,
                content TEXT NOT NULL,
                created_at INTEGER NOT NULL,
                updated_at INTEGER NOT NULL,
                is_active INTEGER NOT NULL DEFAULT 1,
                FOREIGN KEY (contact_id) REFERENCES contact_profiles(id) ON DELETE CASCADE
            )
        """)
        
        database.execSQL("""
            CREATE INDEX IF NOT EXISTS index_conversation_topics_contact_id 
            ON conversation_topics(contact_id)
        """)
        
        database.execSQL("""
            CREATE INDEX IF NOT EXISTS index_conversation_topics_contact_id_is_active 
            ON conversation_topics(contact_id, is_active)
        """)
    }
}
```

---

## ğŸ¯ é¢†åŸŸå±‚è®¾è®¡

### 1. ä»“åº“æ¥å£

**æ–‡ä»¶ä½ç½®**ï¼š`domain/repository/TopicRepository.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜ä»“åº“æ¥å£
 *
 * å®šä¹‰ä¸»é¢˜æ•°æ®çš„è®¿é—®å’Œç®¡ç†æ“ä½œ
 */
interface TopicRepository {
    
    /**
     * è·å–è”ç³»äººå½“å‰æ´»è·ƒçš„ä¸»é¢˜
     *
     * @param contactId è”ç³»äººID
     * @return å½“å‰æ´»è·ƒä¸»é¢˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›null
     */
    suspend fun getActiveTopic(contactId: String): ConversationTopic?
    
    /**
     * è·å–è”ç³»äººå½“å‰æ´»è·ƒä¸»é¢˜çš„Flow
     *
     * @param contactId è”ç³»äººID
     * @return ä¸»é¢˜Flowï¼Œå®æ—¶æ›´æ–°
     */
    fun observeActiveTopic(contactId: String): Flow<ConversationTopic?>
    
    /**
     * è®¾ç½®è”ç³»äººçš„å¯¹è¯ä¸»é¢˜
     *
     * @param topic è¦è®¾ç½®çš„ä¸»é¢˜
     * @return æ“ä½œç»“æœ
     */
    suspend fun setTopic(topic: ConversationTopic): Result<Unit>
    
    /**
     * æ›´æ–°ç°æœ‰ä¸»é¢˜å†…å®¹
     *
     * @param topicId ä¸»é¢˜ID
     * @param content æ–°çš„ä¸»é¢˜å†…å®¹
     * @return æ“ä½œç»“æœ
     */
    suspend fun updateTopicContent(topicId: String, content: String): Result<Unit>
    
    /**
     * æ¸…é™¤è”ç³»äººçš„å½“å‰ä¸»é¢˜
     *
     * @param contactId è”ç³»äººID
     * @return æ“ä½œç»“æœ
     */
    suspend fun clearTopic(contactId: String): Result<Unit>
    
    /**
     * è·å–è”ç³»äººçš„ä¸»é¢˜å†å²è®°å½•
     *
     * @param contactId è”ç³»äººID
     * @param limit è¿”å›æ•°é‡é™åˆ¶
     * @return ä¸»é¢˜å†å²åˆ—è¡¨
     */
    suspend fun getTopicHistory(contactId: String, limit: Int = 10): List<ConversationTopic>
    
    /**
     * åˆ é™¤æŒ‡å®šä¸»é¢˜
     *
     * @param topicId ä¸»é¢˜ID
     * @return æ“ä½œç»“æœ
     */
    suspend fun deleteTopic(topicId: String): Result<Unit>
}
```

### 2. è®¾ç½®ä¸»é¢˜ç”¨ä¾‹

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/SetTopicUseCase.kt`

```kotlin
/**
 * è®¾ç½®å¯¹è¯ä¸»é¢˜ç”¨ä¾‹
 *
 * è´Ÿè´£éªŒè¯å’Œä¿å­˜ç”¨æˆ·è®¾ç½®çš„å¯¹è¯ä¸»é¢˜
 */
class SetTopicUseCase @Inject constructor(
    private val topicRepository: TopicRepository
) {
    /**
     * è®¾ç½®å¯¹è¯ä¸»é¢˜
     *
     * @param contactId è”ç³»äººID
     * @param content ä¸»é¢˜å†…å®¹
     * @return æ“ä½œç»“æœï¼ŒæˆåŠŸè¿”å›åˆ›å»ºçš„ä¸»é¢˜
     */
    suspend operator fun invoke(
        contactId: String,
        content: String
    ): Result<ConversationTopic> {
        // 1. éªŒè¯è¾“å…¥
        if (contactId.isBlank()) {
            return Result.failure(IllegalArgumentException("è”ç³»äººIDä¸èƒ½ä¸ºç©º"))
        }
        
        if (content.isBlank()) {
            return Result.failure(IllegalArgumentException("ä¸»é¢˜å†…å®¹ä¸èƒ½ä¸ºç©º"))
        }
        
        if (content.length > ConversationTopic.MAX_CONTENT_LENGTH) {
            return Result.failure(
                IllegalArgumentException("ä¸»é¢˜å†…å®¹ä¸èƒ½è¶…è¿‡${ConversationTopic.MAX_CONTENT_LENGTH}å­—ç¬¦")
            )
        }
        
        // 2. æ¸…é™¤æ—§çš„æ´»è·ƒä¸»é¢˜
        topicRepository.clearTopic(contactId)
        
        // 3. åˆ›å»ºæ–°ä¸»é¢˜
        val topic = ConversationTopic(
            contactId = contactId,
            content = content.trim(),
            isActive = true
        )
        
        // 4. ä¿å­˜ä¸»é¢˜
        return topicRepository.setTopic(topic).map { topic }
    }
}
```

### 3. è·å–ä¸»é¢˜ç”¨ä¾‹

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/GetTopicUseCase.kt`

```kotlin
/**
 * è·å–å¯¹è¯ä¸»é¢˜ç”¨ä¾‹
 *
 * è´Ÿè´£è·å–è”ç³»äººå½“å‰æ´»è·ƒçš„å¯¹è¯ä¸»é¢˜
 */
class GetTopicUseCase @Inject constructor(
    private val topicRepository: TopicRepository
) {
    /**
     * è·å–è”ç³»äººå½“å‰æ´»è·ƒä¸»é¢˜
     *
     * @param contactId è”ç³»äººID
     * @return å½“å‰æ´»è·ƒä¸»é¢˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›null
     */
    suspend operator fun invoke(contactId: String): ConversationTopic? {
        if (contactId.isBlank()) {
            return null
        }
        return topicRepository.getActiveTopic(contactId)
    }
    
    /**
     * è§‚å¯Ÿè”ç³»äººä¸»é¢˜å˜åŒ–
     *
     * @param contactId è”ç³»äººID
     * @return ä¸»é¢˜Flow
     */
    fun observe(contactId: String): Flow<ConversationTopic?> {
        if (contactId.isBlank()) {
            return flowOf(null)
        }
        return topicRepository.observeActiveTopic(contactId)
    }
}
```

### 4. æ¸…é™¤ä¸»é¢˜ç”¨ä¾‹

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/ClearTopicUseCase.kt`

```kotlin
/**
 * æ¸…é™¤å¯¹è¯ä¸»é¢˜ç”¨ä¾‹
 *
 * è´Ÿè´£æ¸…é™¤è”ç³»äººå½“å‰çš„å¯¹è¯ä¸»é¢˜
 */
class ClearTopicUseCase @Inject constructor(
    private val topicRepository: TopicRepository
) {
    /**
     * æ¸…é™¤è”ç³»äººå½“å‰ä¸»é¢˜
     *
     * @param contactId è”ç³»äººID
     * @return æ“ä½œç»“æœ
     */
    suspend operator fun invoke(contactId: String): Result<Unit> {
        if (contactId.isBlank()) {
            return Result.failure(IllegalArgumentException("è”ç³»äººIDä¸èƒ½ä¸ºç©º"))
        }
        return topicRepository.clearTopic(contactId)
    }
}
```

---

## ğŸ’¾ æ•°æ®å±‚è®¾è®¡

### 1. æ•°æ®è®¿é—®å¯¹è±¡ï¼ˆDAOï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/dao/ConversationTopicDao.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜æ•°æ®è®¿é—®å¯¹è±¡
 */
@Dao
interface ConversationTopicDao {
    
    /**
     * æ’å…¥ä¸»é¢˜
     */
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insert(topic: ConversationTopicEntity)
    
    /**
     * æ›´æ–°ä¸»é¢˜
     */
    @Update
    suspend fun update(topic: ConversationTopicEntity)
    
    /**
     * åˆ é™¤ä¸»é¢˜
     */
    @Delete
    suspend fun delete(topic: ConversationTopicEntity)
    
    /**
     * æ ¹æ®IDåˆ é™¤ä¸»é¢˜
     */
    @Query("DELETE FROM conversation_topics WHERE id = :topicId")
    suspend fun deleteById(topicId: String)
    
    /**
     * è·å–è”ç³»äººå½“å‰æ´»è·ƒä¸»é¢˜
     */
    @Query("""
        SELECT * FROM conversation_topics 
        WHERE contact_id = :contactId AND is_active = 1 
        LIMIT 1
    """)
    suspend fun getActiveTopic(contactId: String): ConversationTopicEntity?
    
    /**
     * è§‚å¯Ÿè”ç³»äººå½“å‰æ´»è·ƒä¸»é¢˜
     */
    @Query("""
        SELECT * FROM conversation_topics 
        WHERE contact_id = :contactId AND is_active = 1 
        LIMIT 1
    """)
    fun observeActiveTopic(contactId: String): Flow<ConversationTopicEntity?>
    
    /**
     * æ¸…é™¤è”ç³»äººæ‰€æœ‰æ´»è·ƒä¸»é¢˜ï¼ˆè®¾ç½®ä¸ºéæ´»è·ƒï¼‰
     */
    @Query("""
        UPDATE conversation_topics 
        SET is_active = 0, updated_at = :timestamp 
        WHERE contact_id = :contactId AND is_active = 1
    """)
    suspend fun deactivateAllTopics(contactId: String, timestamp: Long = System.currentTimeMillis())
    
    /**
     * è·å–è”ç³»äººä¸»é¢˜å†å²
     */
    @Query("""
        SELECT * FROM conversation_topics 
        WHERE contact_id = :contactId 
        ORDER BY updated_at DESC 
        LIMIT :limit
    """)
    suspend fun getTopicHistory(contactId: String, limit: Int): List<ConversationTopicEntity>
    
    /**
     * æ ¹æ®IDè·å–ä¸»é¢˜
     */
    @Query("SELECT * FROM conversation_topics WHERE id = :topicId")
    suspend fun getById(topicId: String): ConversationTopicEntity?
    
    /**
     * æ›´æ–°ä¸»é¢˜å†…å®¹
     */
    @Query("""
        UPDATE conversation_topics 
        SET content = :content, updated_at = :timestamp 
        WHERE id = :topicId
    """)
    suspend fun updateContent(topicId: String, content: String, timestamp: Long = System.currentTimeMillis())
}
```

### 2. ä»“åº“å®ç°

**æ–‡ä»¶ä½ç½®**ï¼š`data/repository/TopicRepositoryImpl.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜ä»“åº“å®ç°
 */
class TopicRepositoryImpl @Inject constructor(
    private val topicDao: ConversationTopicDao,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) : TopicRepository {
    
    override suspend fun getActiveTopic(contactId: String): ConversationTopic? =
        withContext(ioDispatcher) {
            topicDao.getActiveTopic(contactId)?.toDomain()
        }
    
    override fun observeActiveTopic(contactId: String): Flow<ConversationTopic?> =
        topicDao.observeActiveTopic(contactId)
            .map { it?.toDomain() }
            .flowOn(ioDispatcher)
    
    override suspend fun setTopic(topic: ConversationTopic): Result<Unit> =
        withContext(ioDispatcher) {
            try {
                // å…ˆæ¸…é™¤æ—§çš„æ´»è·ƒä¸»é¢˜
                topicDao.deactivateAllTopics(topic.contactId)
                // æ’å…¥æ–°ä¸»é¢˜
                topicDao.insert(ConversationTopicEntity.fromDomain(topic))
                Result.success(Unit)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    
    override suspend fun updateTopicContent(topicId: String, content: String): Result<Unit> =
        withContext(ioDispatcher) {
            try {
                topicDao.updateContent(topicId, content)
                Result.success(Unit)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    
    override suspend fun clearTopic(contactId: String): Result<Unit> =
        withContext(ioDispatcher) {
            try {
                topicDao.deactivateAllTopics(contactId)
                Result.success(Unit)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    
    override suspend fun getTopicHistory(contactId: String, limit: Int): List<ConversationTopic> =
        withContext(ioDispatcher) {
            topicDao.getTopicHistory(contactId, limit).map { it.toDomain() }
        }
    
    override suspend fun deleteTopic(topicId: String): Result<Unit> =
        withContext(ioDispatcher) {
            try {
                topicDao.deleteById(topicId)
                Result.success(Unit)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
}
```

### 3. ä¾èµ–æ³¨å…¥æ¨¡å—

**æ–‡ä»¶ä½ç½®**ï¼š`di/TopicModule.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜ä¾èµ–æ³¨å…¥æ¨¡å—
 */
@Module
@InstallIn(SingletonComponent::class)
object TopicModule {
    
    @Provides
    fun provideConversationTopicDao(database: AppDatabase): ConversationTopicDao {
        return database.conversationTopicDao()
    }
    
    @Provides
    @Singleton
    fun provideTopicRepository(
        topicDao: ConversationTopicDao,
        @IoDispatcher ioDispatcher: CoroutineDispatcher
    ): TopicRepository {
        return TopicRepositoryImpl(topicDao, ioDispatcher)
    }
    
    @Provides
    fun provideSetTopicUseCase(
        topicRepository: TopicRepository
    ): SetTopicUseCase {
        return SetTopicUseCase(topicRepository)
    }
    
    @Provides
    fun provideGetTopicUseCase(
        topicRepository: TopicRepository
    ): GetTopicUseCase {
        return GetTopicUseCase(topicRepository)
    }
    
    @Provides
    fun provideClearTopicUseCase(
        topicRepository: TopicRepository
    ): ClearTopicUseCase {
        return ClearTopicUseCase(topicRepository)
    }
}
```

---

## ğŸ¨ è¡¨ç°å±‚è®¾è®¡

### 1. UIçŠ¶æ€å®šä¹‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/viewmodel/TopicUiState.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜UIçŠ¶æ€
 */
data class TopicUiState(
    /** å½“å‰æ´»è·ƒä¸»é¢˜ */
    val currentTopic: ConversationTopic? = null,
    /** æ˜¯å¦æ­£åœ¨åŠ è½½ */
    val isLoading: Boolean = false,
    /** æ˜¯å¦æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡† */
    val showSettingDialog: Boolean = false,
    /** è¾“å…¥æ¡†å†…å®¹ */
    val inputContent: String = "",
    /** é”™è¯¯ä¿¡æ¯ */
    val errorMessage: String? = null,
    /** æ˜¯å¦ä¿å­˜æˆåŠŸ */
    val saveSuccess: Boolean = false,
    /** ä¸»é¢˜å†å²è®°å½• */
    val topicHistory: List<ConversationTopic> = emptyList()
) {
    /** æ˜¯å¦æœ‰æ´»è·ƒä¸»é¢˜ */
    val hasActiveTopic: Boolean get() = currentTopic != null
    
    /** ä¸»é¢˜é¢„è§ˆæ–‡æœ¬ */
    val topicPreview: String get() = currentTopic?.getPreview() ?: ""
    
    /** è¾“å…¥å­—ç¬¦æ•° */
    val inputCharCount: Int get() = inputContent.length
    
    /** æ˜¯å¦è¶…å‡ºå­—ç¬¦é™åˆ¶ */
    val isOverLimit: Boolean get() = inputCharCount > ConversationTopic.MAX_CONTENT_LENGTH
    
    /** æ˜¯å¦å¯ä»¥ä¿å­˜ */
    val canSave: Boolean get() = inputContent.isNotBlank() && !isOverLimit && !isLoading
}
```

### 2. UIäº‹ä»¶å®šä¹‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/viewmodel/TopicUiEvent.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜UIäº‹ä»¶
 */
sealed class TopicUiEvent {
    /** æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡† */
    object ShowSettingDialog : TopicUiEvent()
    
    /** éšè—è®¾ç½®å¯¹è¯æ¡† */
    object HideSettingDialog : TopicUiEvent()
    
    /** æ›´æ–°è¾“å…¥å†…å®¹ */
    data class UpdateInput(val content: String) : TopicUiEvent()
    
    /** ä¿å­˜ä¸»é¢˜ */
    object SaveTopic : TopicUiEvent()
    
    /** æ¸…é™¤ä¸»é¢˜ */
    object ClearTopic : TopicUiEvent()
    
    /** ä»å†å²è®°å½•é€‰æ‹©ä¸»é¢˜ */
    data class SelectFromHistory(val topic: ConversationTopic) : TopicUiEvent()
    
    /** æ¸…é™¤é”™è¯¯ä¿¡æ¯ */
    object ClearError : TopicUiEvent()
    
    /** æ¸…é™¤ä¿å­˜æˆåŠŸçŠ¶æ€ */
    object ClearSaveSuccess : TopicUiEvent()
}
```

### 3. ViewModelå®ç°

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/viewmodel/TopicViewModel.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜ViewModel
 */
@HiltViewModel
class TopicViewModel @Inject constructor(
    private val setTopicUseCase: SetTopicUseCase,
    private val getTopicUseCase: GetTopicUseCase,
    private val clearTopicUseCase: ClearTopicUseCase,
    private val topicRepository: TopicRepository,
    savedStateHandle: SavedStateHandle
) : ViewModel() {
    
    private val contactId: String = savedStateHandle.get<String>("contactId") ?: ""
    
    private val _uiState = MutableStateFlow(TopicUiState())
    val uiState: StateFlow<TopicUiState> = _uiState.asStateFlow()
    
    init {
        observeTopic()
        loadTopicHistory()
    }
    
    /**
     * è§‚å¯Ÿå½“å‰ä¸»é¢˜å˜åŒ–
     */
    private fun observeTopic() {
        viewModelScope.launch {
            getTopicUseCase.observe(contactId).collect { topic ->
                _uiState.update { it.copy(currentTopic = topic) }
            }
        }
    }
    
    /**
     * åŠ è½½ä¸»é¢˜å†å²
     */
    private fun loadTopicHistory() {
        viewModelScope.launch {
            val history = topicRepository.getTopicHistory(contactId, 10)
            _uiState.update { it.copy(topicHistory = history) }
        }
    }
    
    /**
     * å¤„ç†UIäº‹ä»¶
     */
    fun onEvent(event: TopicUiEvent) {
        when (event) {
            is TopicUiEvent.ShowSettingDialog -> showSettingDialog()
            is TopicUiEvent.HideSettingDialog -> hideSettingDialog()
            is TopicUiEvent.UpdateInput -> updateInput(event.content)
            is TopicUiEvent.SaveTopic -> saveTopic()
            is TopicUiEvent.ClearTopic -> clearTopic()
            is TopicUiEvent.SelectFromHistory -> selectFromHistory(event.topic)
            is TopicUiEvent.ClearError -> clearError()
            is TopicUiEvent.ClearSaveSuccess -> clearSaveSuccess()
        }
    }
    
    private fun showSettingDialog() {
        val currentContent = _uiState.value.currentTopic?.content ?: ""
        _uiState.update { 
            it.copy(
                showSettingDialog = true,
                inputContent = currentContent
            )
        }
    }
    
    private fun hideSettingDialog() {
        _uiState.update { 
            it.copy(
                showSettingDialog = false,
                inputContent = "",
                errorMessage = null
            )
        }
    }
    
    private fun updateInput(content: String) {
        _uiState.update { it.copy(inputContent = content) }
    }
    
    private fun saveTopic() {
        val content = _uiState.value.inputContent.trim()
        if (content.isBlank()) {
            _uiState.update { it.copy(errorMessage = "ä¸»é¢˜å†…å®¹ä¸èƒ½ä¸ºç©º") }
            return
        }
        
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            
            setTopicUseCase(contactId, content)
                .onSuccess {
                    _uiState.update { 
                        it.copy(
                            isLoading = false,
                            showSettingDialog = false,
                            inputContent = "",
                            saveSuccess = true
                        )
                    }
                    loadTopicHistory()
                }
                .onFailure { error ->
                    _uiState.update { 
                        it.copy(
                            isLoading = false,
                            errorMessage = error.message ?: "ä¿å­˜å¤±è´¥"
                        )
                    }
                }
        }
    }
    
    private fun clearTopic() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            
            clearTopicUseCase(contactId)
                .onSuccess {
                    _uiState.update { 
                        it.copy(
                            isLoading = false,
                            showSettingDialog = false,
                            inputContent = ""
                        )
                    }
                }
                .onFailure { error ->
                    _uiState.update { 
                        it.copy(
                            isLoading = false,
                            errorMessage = error.message ?: "æ¸…é™¤å¤±è´¥"
                        )
                    }
                }
        }
    }
    
    private fun selectFromHistory(topic: ConversationTopic) {
        _uiState.update { it.copy(inputContent = topic.content) }
    }
    
    private fun clearError() {
        _uiState.update { it.copy(errorMessage = null) }
    }
    
    private fun clearSaveSuccess() {
        _uiState.update { it.copy(saveSuccess = false) }
    }
}
```

---

## ğŸ”— ç³»ç»Ÿæç¤ºè¯é›†æˆ

### 1. ä¸»é¢˜æ³¨å…¥åˆ°ç³»ç»Ÿæç¤ºè¯

**æ–‡ä»¶ä½ç½®**ï¼š`domain/util/PromptBuilder.kt`ï¼ˆæ›´æ–°ï¼‰

```kotlin
/**
 * æ„å»ºåŒ…å«ä¸»é¢˜çš„ç³»ç»Ÿæç¤ºè¯
 *
 * @param scene æç¤ºè¯åœºæ™¯
 * @param context æç¤ºè¯ä¸Šä¸‹æ–‡
 * @param topic å½“å‰å¯¹è¯ä¸»é¢˜ï¼ˆå¯é€‰ï¼‰
 * @return å®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯
 */
suspend fun buildWithTopic(
    scene: PromptScene,
    context: PromptContext,
    topic: ConversationTopic?
): String {
    val basePrompt = build(scene, context)
    
    // å¦‚æœæ²¡æœ‰ä¸»é¢˜ï¼Œç›´æ¥è¿”å›åŸºç¡€æç¤ºè¯
    if (topic == null || topic.content.isBlank()) {
        return basePrompt
    }
    
    // åœ¨ç³»ç»Ÿæç¤ºè¯ä¸­æ³¨å…¥ä¸»é¢˜ä¿¡æ¯
    val topicSection = buildTopicSection(topic)
    
    return """
        |$basePrompt
        |
        |$topicSection
    """.trimMargin()
}

/**
 * æ„å»ºä¸»é¢˜éƒ¨åˆ†çš„æç¤ºè¯
 */
private fun buildTopicSection(topic: ConversationTopic): String {
    return """
        |ã€å½“å‰å¯¹è¯ä¸»é¢˜ã€‘
        |ç”¨æˆ·è®¾ç½®äº†ä»¥ä¸‹å¯¹è¯ä¸»é¢˜ï¼Œè¯·åœ¨å›å¤æ—¶å……åˆ†è€ƒè™‘è¿™ä¸ªèƒŒæ™¯ï¼š
        |
        |${topic.content}
        |
        |è¯·ç¡®ä¿ä½ çš„å›å¤ä¸ä¸Šè¿°ä¸»é¢˜ä¿æŒä¸€è‡´å’Œç›¸å…³ã€‚
    """.trimMargin()
}
```

### 2. UseCaseå±‚é›†æˆ

**æ›´æ–° AnalyzeChatUseCase**ï¼š

```kotlin
class AnalyzeChatUseCase @Inject constructor(
    private val aiRepository: AiRepository,
    private val promptBuilder: PromptBuilder,
    private val topicRepository: TopicRepository  // ğŸ†• æ–°å¢ä¾èµ–
) {
    suspend operator fun invoke(
        contactId: String,
        messages: List<ChatMessage>,
        context: PromptContext
    ): Result<AnalysisResult> {
        // è·å–å½“å‰ä¸»é¢˜
        val topic = topicRepository.getActiveTopic(contactId)
        
        // æ„å»ºåŒ…å«ä¸»é¢˜çš„æç¤ºè¯
        val systemPrompt = promptBuilder.buildWithTopic(
            scene = PromptScene.ANALYZE,
            context = context,
            topic = topic
        )
        
        // è°ƒç”¨AIåˆ†æ
        return aiRepository.analyze(systemPrompt, messages)
    }
}
```

**æ›´æ–° PolishDraftUseCase**ï¼š

```kotlin
class PolishDraftUseCase @Inject constructor(
    private val aiRepository: AiRepository,
    private val promptBuilder: PromptBuilder,
    private val topicRepository: TopicRepository  // ğŸ†• æ–°å¢ä¾èµ–
) {
    suspend operator fun invoke(
        contactId: String,
        draft: String,
        context: PromptContext
    ): Result<PolishResult> {
        // è·å–å½“å‰ä¸»é¢˜
        val topic = topicRepository.getActiveTopic(contactId)
        
        // æ„å»ºåŒ…å«ä¸»é¢˜çš„æç¤ºè¯
        val systemPrompt = promptBuilder.buildWithTopic(
            scene = PromptScene.POLISH,
            context = context,
            topic = topic
        )
        
        // è°ƒç”¨AIæ¶¦è‰²
        return aiRepository.polish(systemPrompt, draft)
    }
}
```

**æ›´æ–° GenerateReplyUseCase**ï¼š

```kotlin
class GenerateReplyUseCase @Inject constructor(
    private val aiRepository: AiRepository,
    private val promptBuilder: PromptBuilder,
    private val topicRepository: TopicRepository  // ğŸ†• æ–°å¢ä¾èµ–
) {
    suspend operator fun invoke(
        contactId: String,
        receivedMessage: String,
        context: PromptContext
    ): Result<ReplyResult> {
        // è·å–å½“å‰ä¸»é¢˜
        val topic = topicRepository.getActiveTopic(contactId)
        
        // æ„å»ºåŒ…å«ä¸»é¢˜çš„æç¤ºè¯
        val systemPrompt = promptBuilder.buildWithTopic(
            scene = PromptScene.REPLY,
            context = context,
            topic = topic
        )
        
        // è°ƒç”¨AIç”Ÿæˆå›å¤
        return aiRepository.generateReply(systemPrompt, receivedMessage)
    }
}
```

### 3. æ‚¬æµ®çª—æœåŠ¡é›†æˆ

**æ›´æ–° FloatingWindowService**ï¼š

```kotlin
// åœ¨FloatingWindowServiceä¸­æ·»åŠ ä¸»é¢˜æ”¯æŒ
private suspend fun executeAiAction(
    actionType: ActionType,
    input: String,
    contactId: String
) {
    // è·å–å½“å‰ä¸»é¢˜
    val topic = topicRepository.getActiveTopic(contactId)
    
    // æ„å»ºä¸Šä¸‹æ–‡
    val context = buildPromptContext(contactId)
    
    // æ ¹æ®æ“ä½œç±»å‹æ‰§è¡Œå¯¹åº”çš„UseCase
    val result = when (actionType) {
        ActionType.ANALYZE -> analyzeChatUseCase(contactId, parseMessages(input), context)
        ActionType.POLISH -> polishDraftUseCase(contactId, input, context)
        ActionType.REPLY -> generateReplyUseCase(contactId, input, context)
    }
    
    // å¤„ç†ç»“æœ...
}
```

---

## ğŸ–¼ï¸ UIç•Œé¢è®¾è®¡

### 1. ä¸»é¢˜è®¾ç½®å¯¹è¯æ¡†

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/component/topic/TopicSettingDialog.kt`

```kotlin
/**
 * ä¸»é¢˜è®¾ç½®å¯¹è¯æ¡†
 */
@Composable
fun TopicSettingDialog(
    uiState: TopicUiState,
    onEvent: (TopicUiEvent) -> Unit,
    modifier: Modifier = Modifier
) {
    if (!uiState.showSettingDialog) return
    
    AlertDialog(
        onDismissRequest = { onEvent(TopicUiEvent.HideSettingDialog) },
        modifier = modifier,
        title = {
            Text(
                text = "è®¾ç½®å¯¹è¯ä¸»é¢˜",
                style = MaterialTheme.typography.titleLarge
            )
        },
        text = {
            Column(
                modifier = Modifier.fillMaxWidth(),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                // è¯´æ˜æ–‡å­—
                Text(
                    text = "è®¾ç½®å¯¹è¯ä¸»é¢˜å¯ä»¥å¸®åŠ©AIæ›´å¥½åœ°ç†è§£å¯¹è¯èƒŒæ™¯ï¼Œæä¾›æ›´ç²¾å‡†çš„å›å¤ã€‚",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                
                // è¾“å…¥æ¡†
                TopicInputField(
                    value = uiState.inputContent,
                    onValueChange = { onEvent(TopicUiEvent.UpdateInput(it)) },
                    charCount = uiState.inputCharCount,
                    maxLength = ConversationTopic.MAX_CONTENT_LENGTH,
                    isError = uiState.isOverLimit,
                    modifier = Modifier.fillMaxWidth()
                )
                
                // é”™è¯¯æç¤º
                if (uiState.errorMessage != null) {
                    Text(
                        text = uiState.errorMessage,
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.error
                    )
                }
                
                // å†å²è®°å½•ï¼ˆå¦‚æœæœ‰ï¼‰
                if (uiState.topicHistory.isNotEmpty()) {
                    TopicHistorySection(
                        history = uiState.topicHistory,
                        onSelect = { onEvent(TopicUiEvent.SelectFromHistory(it)) }
                    )
                }
            }
        },
        confirmButton = {
            Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                // æ¸…é™¤æŒ‰é’®ï¼ˆä»…å½“æœ‰æ´»è·ƒä¸»é¢˜æ—¶æ˜¾ç¤ºï¼‰
                if (uiState.hasActiveTopic) {
                    TextButton(
                        onClick = { onEvent(TopicUiEvent.ClearTopic) },
                        enabled = !uiState.isLoading
                    ) {
                        Text("æ¸…é™¤ä¸»é¢˜")
                    }
                }
                
                // ä¿å­˜æŒ‰é’®
                Button(
                    onClick = { onEvent(TopicUiEvent.SaveTopic) },
                    enabled = uiState.canSave
                ) {
                    if (uiState.isLoading) {
                        CircularProgressIndicator(
                            modifier = Modifier.size(16.dp),
                            strokeWidth = 2.dp
                        )
                    } else {
                        Text("ä¿å­˜")
                    }
                }
            }
        },
        dismissButton = {
            TextButton(
                onClick = { onEvent(TopicUiEvent.HideSettingDialog) },
                enabled = !uiState.isLoading
            ) {
                Text("å–æ¶ˆ")
            }
        }
    )
}
```

### 2. ä¸»é¢˜è¾“å…¥æ¡†ç»„ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/component/topic/TopicInputField.kt`

```kotlin
/**
 * ä¸»é¢˜è¾“å…¥æ¡†ç»„ä»¶
 */
@Composable
fun TopicInputField(
    value: String,
    onValueChange: (String) -> Unit,
    charCount: Int,
    maxLength: Int,
    isError: Boolean,
    modifier: Modifier = Modifier
) {
    Column(modifier = modifier) {
        OutlinedTextField(
            value = value,
            onValueChange = onValueChange,
            modifier = Modifier.fillMaxWidth(),
            label = { Text("ä¸»é¢˜æè¿°") },
            placeholder = { 
                Text(
                    text = "ä¾‹å¦‚ï¼šè®¨è®ºé¡¹ç›®è¿›åº¦ã€å­¦ä¹ ç¼–ç¨‹çŸ¥è¯†ã€æƒ…æ„Ÿå’¨è¯¢...",
                    color = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.6f)
                )
            },
            supportingText = {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween
                ) {
                    if (isError) {
                        Text(
                            text = "å·²è¶…å‡ºå­—ç¬¦é™åˆ¶",
                            color = MaterialTheme.colorScheme.error
                        )
                    } else {
                        Spacer(modifier = Modifier.weight(1f))
                    }
                    Text(
                        text = "$charCount / $maxLength",
                        color = if (isError) {
                            MaterialTheme.colorScheme.error
                        } else {
                            MaterialTheme.colorScheme.onSurfaceVariant
                        }
                    )
                }
            },
            isError = isError,
            minLines = 3,
            maxLines = 6,
            keyboardOptions = KeyboardOptions(
                capitalization = KeyboardCapitalization.Sentences,
                imeAction = ImeAction.Done
            )
        )
    }
}
```

### 3. ä¸»é¢˜çŠ¶æ€å¾½ç« 

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/component/topic/TopicBadge.kt`

```kotlin
/**
 * ä¸»é¢˜çŠ¶æ€å¾½ç« 
 *
 * æ˜¾ç¤ºå½“å‰æ˜¯å¦æœ‰æ´»è·ƒä¸»é¢˜ï¼Œç‚¹å‡»å¯å±•å¼€è®¾ç½®
 */
@Composable
fun TopicBadge(
    topic: ConversationTopic?,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    val hasActiveTopic = topic != null
    
    Surface(
        onClick = onClick,
        modifier = modifier,
        shape = RoundedCornerShape(16.dp),
        color = if (hasActiveTopic) {
            MaterialTheme.colorScheme.primaryContainer
        } else {
            MaterialTheme.colorScheme.surfaceVariant
        },
        tonalElevation = if (hasActiveTopic) 2.dp else 0.dp
    ) {
        Row(
            modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp),
            horizontalArrangement = Arrangement.spacedBy(6.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(
                imageVector = if (hasActiveTopic) {
                    Icons.Default.Topic
                } else {
                    Icons.Outlined.AddCircle
                },
                contentDescription = null,
                modifier = Modifier.size(16.dp),
                tint = if (hasActiveTopic) {
                    MaterialTheme.colorScheme.onPrimaryContainer
                } else {
                    MaterialTheme.colorScheme.onSurfaceVariant
                }
            )
            
            Text(
                text = if (hasActiveTopic) {
                    topic!!.getPreview()
                } else {
                    "è®¾ç½®ä¸»é¢˜"
                },
                style = MaterialTheme.typography.labelMedium,
                color = if (hasActiveTopic) {
                    MaterialTheme.colorScheme.onPrimaryContainer
                } else {
                    MaterialTheme.colorScheme.onSurfaceVariant
                },
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
        }
    }
}
```

### 4. ä¸»é¢˜å†å²è®°å½•åŒºåŸŸ

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/component/topic/TopicHistorySection.kt`

```kotlin
/**
 * ä¸»é¢˜å†å²è®°å½•åŒºåŸŸ
 */
@Composable
fun TopicHistorySection(
    history: List<ConversationTopic>,
    onSelect: (ConversationTopic) -> Unit,
    modifier: Modifier = Modifier
) {
    Column(modifier = modifier) {
        Text(
            text = "å†å²ä¸»é¢˜",
            style = MaterialTheme.typography.labelMedium,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
            modifier = Modifier.padding(bottom = 8.dp)
        )
        
        LazyRow(
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            items(history.take(5)) { topic ->
                TopicHistoryChip(
                    topic = topic,
                    onClick = { onSelect(topic) }
                )
            }
        }
    }
}

@Composable
private fun TopicHistoryChip(
    topic: ConversationTopic,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    SuggestionChip(
        onClick = onClick,
        label = {
            Text(
                text = topic.getPreview(),
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
        },
        modifier = modifier
    )
}
```

### 5. æ‚¬æµ®çª—ä¸»é¢˜æ˜¾ç¤ºé›†æˆ

**æ›´æ–° FloatingViewV2**ï¼š

```kotlin
// åœ¨æ‚¬æµ®çª—é¡¶éƒ¨æ·»åŠ ä¸»é¢˜æ˜¾ç¤ºåŒºåŸŸ
@Composable
private fun TopicIndicator(
    topic: ConversationTopic?,
    onEditClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    if (topic == null) return
    
    Row(
        modifier = modifier
            .fillMaxWidth()
            .background(MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.5f))
            .padding(horizontal = 12.dp, vertical = 4.dp),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Row(
            horizontalArrangement = Arrangement.spacedBy(4.dp),
            verticalAlignment = Alignment.CenterVertically,
            modifier = Modifier.weight(1f)
        ) {
            Icon(
                imageVector = Icons.Default.Topic,
                contentDescription = null,
                modifier = Modifier.size(14.dp),
                tint = MaterialTheme.colorScheme.primary
            )
            Text(
                text = topic.getPreview(),
                style = MaterialTheme.typography.labelSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
        }
        
        IconButton(
            onClick = onEditClick,
            modifier = Modifier.size(24.dp)
        ) {
            Icon(
                imageVector = Icons.Default.Edit,
                contentDescription = "ç¼–è¾‘ä¸»é¢˜",
                modifier = Modifier.size(14.dp)
            )
        }
    }
}
```

---

## ğŸšª ç”¨æˆ·å…¥å£ç‚¹è®¾è®¡

> **é‡è¦**: æœ¬ç« èŠ‚å®šä¹‰äº†ç”¨æˆ·å¦‚ä½•è®¿é—®å’Œä½¿ç”¨å¯¹è¯ä¸»é¢˜åŠŸèƒ½çš„æ‰€æœ‰å…¥å£ç‚¹ã€‚

### 1. è”ç³»äººè¯¦æƒ…é¡µå…¥å£

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/ContactDetailScreen.kt`

#### 1.1 é¡¶éƒ¨å·¥å…·æ é›†æˆ

```kotlin
@Composable
fun ContactDetailScreen(
    contactId: String,
    viewModel: ContactDetailViewModel = hiltViewModel(),
    topicViewModel: TopicViewModel = hiltViewModel(),  // ğŸ†• æ³¨å…¥TopicViewModel
    onNavigateBack: () -> Unit
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    val topicUiState by topicViewModel.uiState.collectAsStateWithLifecycle()
    
    Scaffold(
        topBar = {
            ContactDetailTopBar(
                contactName = uiState.contact?.name ?: "",
                currentTopic = topicUiState.currentTopic,  // ğŸ†• ä¼ é€’ä¸»é¢˜çŠ¶æ€
                onBackClick = onNavigateBack,
                onTopicClick = { topicViewModel.onEvent(TopicUiEvent.ShowSettingDialog) }  // ğŸ†• ä¸»é¢˜ç‚¹å‡»
            )
        }
    ) { paddingValues ->
        // é¡µé¢å†…å®¹...
        
        // ğŸ†• ä¸»é¢˜è®¾ç½®å¯¹è¯æ¡†
        TopicSettingDialog(
            uiState = topicUiState,
            onEvent = topicViewModel::onEvent
        )
    }
}
```

#### 1.2 é¡¶éƒ¨å·¥å…·æ ç»„ä»¶

```kotlin
@Composable
private fun ContactDetailTopBar(
    contactName: String,
    currentTopic: ConversationTopic?,
    onBackClick: () -> Unit,
    onTopicClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    TopAppBar(
        title = { Text(contactName) },
        navigationIcon = {
            IconButton(onClick = onBackClick) {
                Icon(Icons.Default.ArrowBack, contentDescription = "è¿”å›")
            }
        },
        actions = {
            // ğŸ†• ä¸»é¢˜è®¾ç½®æŒ‰é’®
            IconButton(onClick = onTopicClick) {
                Icon(
                    imageVector = if (currentTopic != null) {
                        Icons.Filled.Topic
                    } else {
                        Icons.Outlined.Topic
                    },
                    contentDescription = "è®¾ç½®å¯¹è¯ä¸»é¢˜",
                    tint = if (currentTopic != null) {
                        MaterialTheme.colorScheme.primary
                    } else {
                        MaterialTheme.colorScheme.onSurface
                    }
                )
            }
            // å…¶ä»–æ“ä½œæŒ‰é’®...
        },
        modifier = modifier
    )
}
```

### 2. æ‚¬æµ®çª—å…¥å£

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/floating/FloatingViewV2.kt`

#### 2.1 æ‚¬æµ®çª—é¡¶éƒ¨ä¸»é¢˜å¾½ç« 

```kotlin
class FloatingViewV2 @Inject constructor(
    private val context: Context,
    private val topicRepository: TopicRepository  // ğŸ†• æ³¨å…¥TopicRepository
) {
    private var currentTopic: ConversationTopic? = null
    private var showTopicDialog = false
    
    /**
     * åˆå§‹åŒ–æ—¶åŠ è½½å½“å‰è”ç³»äººçš„ä¸»é¢˜
     */
    fun loadTopic(contactId: String) {
        CoroutineScope(Dispatchers.Main).launch {
            currentTopic = topicRepository.getActiveTopic(contactId)
            updateTopicIndicator()
        }
    }
    
    /**
     * æ›´æ–°ä¸»é¢˜æŒ‡ç¤ºå™¨UI
     */
    private fun updateTopicIndicator() {
        // åœ¨æ‚¬æµ®çª—é¡¶éƒ¨æ˜¾ç¤ºä¸»é¢˜å¾½ç« 
        topicBadgeView.apply {
            visibility = View.VISIBLE
            text = currentTopic?.getPreview() ?: "è®¾ç½®ä¸»é¢˜"
            setOnClickListener { showTopicSettingDialog() }
        }
    }
    
    /**
     * æ˜¾ç¤ºä¸»é¢˜è®¾ç½®å¯¹è¯æ¡†
     */
    private fun showTopicSettingDialog() {
        // ä½¿ç”¨ç³»ç»Ÿå¯¹è¯æ¡†æˆ–è‡ªå®šä¹‰æ‚¬æµ®çª—å¯¹è¯æ¡†
        TopicSettingDialogHelper.show(
            context = context,
            currentTopic = currentTopic,
            onSave = { content -> saveTopic(content) },
            onClear = { clearTopic() }
        )
    }
}
```

#### 2.2 æ‚¬æµ®çª—å¸ƒå±€æ›´æ–°

```xml
<!-- floating_view_v2.xml -->
<LinearLayout
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="vertical">
    
    <!-- ğŸ†• ä¸»é¢˜æŒ‡ç¤ºå™¨åŒºåŸŸ -->
    <LinearLayout
        android:id="@+id/topic_indicator_container"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:background="?attr/colorSurfaceVariant"
        android:padding="8dp"
        android:visibility="gone">
        
        <ImageView
            android:layout_width="16dp"
            android:layout_height="16dp"
            android:src="@drawable/ic_topic"
            android:tint="?attr/colorPrimary" />
        
        <TextView
            android:id="@+id/topic_preview_text"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:layout_marginStart="8dp"
            android:ellipsize="end"
            android:maxLines="1"
            android:textSize="12sp" />
        
        <ImageButton
            android:id="@+id/topic_edit_button"
            android:layout_width="24dp"
            android:layout_height="24dp"
            android:background="?attr/selectableItemBackgroundBorderless"
            android:src="@drawable/ic_edit" />
    </LinearLayout>
    
    <!-- Tabåˆ‡æ¢å™¨ -->
    <include layout="@layout/floating_tab_switcher" />
    
    <!-- å†…å®¹åŒºåŸŸ -->
    <FrameLayout
        android:id="@+id/content_container"
        android:layout_width="match_parent"
        android:layout_height="wrap_content" />
</LinearLayout>
```

### 3. å…¥å£ç‚¹äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·å…¥å£ç‚¹äº¤äº’æµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  å…¥å£1: è”ç³»äººè¯¦æƒ…é¡µ                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ç‚¹å‡»ä¸»é¢˜å›¾æ ‡ â”‚ â†’ â”‚ æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†â”‚ â†’ â”‚ ä¿å­˜/æ¸…é™¤ä¸»é¢˜    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                 â”‚
â”‚  å…¥å£2: æ‚¬æµ®çª—                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ç‚¹å‡»ä¸»é¢˜å¾½ç«  â”‚ â†’ â”‚ æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†â”‚ â†’ â”‚ ä¿å­˜/æ¸…é™¤ä¸»é¢˜    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                 â”‚
â”‚  ä¸»é¢˜ç”Ÿæ•ˆæµç¨‹:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ä¸»é¢˜ä¿å­˜æˆåŠŸ â”‚ â†’ â”‚ æ›´æ–°UIæ˜¾ç¤º   â”‚ â†’ â”‚ ä¸‹æ¬¡AIè°ƒç”¨æ—¶ç”Ÿæ•ˆ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. å…¥å£ç‚¹å¯è¾¾æ€§éªŒè¯

| å…¥å£ç‚¹ | è§¦å‘æ–¹å¼ | ç›®æ ‡ç»„ä»¶ | çŠ¶æ€ |
|--------|----------|----------|------|
| è”ç³»äººè¯¦æƒ…é¡µ â†’ ä¸»é¢˜è®¾ç½® | ç‚¹å‡»é¡¶éƒ¨å·¥å…·æ ä¸»é¢˜å›¾æ ‡ | TopicSettingDialog | âœ… å·²å®šä¹‰ |
| æ‚¬æµ®çª— â†’ ä¸»é¢˜è®¾ç½® | ç‚¹å‡»ä¸»é¢˜å¾½ç«  | TopicSettingDialog | âœ… å·²å®šä¹‰ |
| ä¸»é¢˜è®¾ç½® â†’ ä¿å­˜ | ç‚¹å‡»ä¿å­˜æŒ‰é’® | SetTopicUseCase | âœ… å·²å®šä¹‰ |
| ä¸»é¢˜è®¾ç½® â†’ æ¸…é™¤ | ç‚¹å‡»æ¸…é™¤æŒ‰é’® | ClearTopicUseCase | âœ… å·²å®šä¹‰ |
| ä¸»é¢˜è®¾ç½® â†’ å†å²é€‰æ‹© | ç‚¹å‡»å†å²è®°å½•é¡¹ | TopicHistorySection | âœ… å·²å®šä¹‰ |

### 5. ç”¨æˆ·æ“ä½œåˆ°AIå“åº”çš„å®Œæ•´è°ƒç”¨é“¾

```
ç”¨æˆ·æ“ä½œ                    ç³»ç»Ÿå¤„ç†                      AIå“åº”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. è®¾ç½®ä¸»é¢˜
   â”‚
   â”œâ”€â†’ TopicSettingDialog
   â”‚       â”‚
   â”‚       â”œâ”€â†’ TopicViewModel.saveTopic()
   â”‚       â”‚       â”‚
   â”‚       â”‚       â”œâ”€â†’ SetTopicUseCase()
   â”‚       â”‚       â”‚       â”‚
   â”‚       â”‚       â”‚       â””â”€â†’ TopicRepository.setTopic()
   â”‚       â”‚       â”‚               â”‚
   â”‚       â”‚       â”‚               â””â”€â†’ ConversationTopicDao.insert()
   â”‚       â”‚       â”‚
   â”‚       â”‚       â””â”€â†’ æ›´æ–°UIçŠ¶æ€
   â”‚       â”‚
   â”‚       â””â”€â†’ å…³é—­å¯¹è¯æ¡†
   â”‚
2. ä½¿ç”¨AIåŠŸèƒ½ï¼ˆåˆ†æ/æ¶¦è‰²/å›å¤ï¼‰
   â”‚
   â”œâ”€â†’ FloatingWindowService.executeAiAction()
   â”‚       â”‚
   â”‚       â”œâ”€â†’ TopicRepository.getActiveTopic(contactId)
   â”‚       â”‚       â”‚
   â”‚       â”‚       â””â”€â†’ è¿”å›å½“å‰ä¸»é¢˜
   â”‚       â”‚
   â”‚       â”œâ”€â†’ PromptBuilder.buildWithTopic()
   â”‚       â”‚       â”‚
   â”‚       â”‚       â””â”€â†’ å°†ä¸»é¢˜æ³¨å…¥ç³»ç»Ÿæç¤ºè¯
   â”‚       â”‚
   â”‚       â””â”€â†’ AiRepository.analyze/polish/reply()
   â”‚               â”‚
   â”‚               â””â”€â†’ AIæ ¹æ®ä¸»é¢˜æä¾›ç›¸å…³å›å¤
   â”‚
3. æ˜¾ç¤ºç»“æœ
   â”‚
   â””â”€â†’ FloatingViewV2.showResult()
           â”‚
           â””â”€â†’ ç”¨æˆ·çœ‹åˆ°ä¸ä¸»é¢˜ç›¸å…³çš„AIå›å¤
```

---

## âš ï¸ é”™è¯¯å¤„ç†æœºåˆ¶

### 1. é”™è¯¯ç±»å‹å®šä¹‰

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜ç›¸å…³é”™è¯¯
 */
sealed class TopicError : Exception() {
    /** ä¸»é¢˜å†…å®¹ä¸ºç©º */
    object EmptyContent : TopicError() {
        override val message: String = "ä¸»é¢˜å†…å®¹ä¸èƒ½ä¸ºç©º"
    }
    
    /** ä¸»é¢˜å†…å®¹è¶…å‡ºé•¿åº¦é™åˆ¶ */
    data class ContentTooLong(val maxLength: Int) : TopicError() {
        override val message: String = "ä¸»é¢˜å†…å®¹ä¸èƒ½è¶…è¿‡${maxLength}å­—ç¬¦"
    }
    
    /** è”ç³»äººIDæ— æ•ˆ */
    object InvalidContactId : TopicError() {
        override val message: String = "æ— æ•ˆçš„è”ç³»äººID"
    }
    
    /** æ•°æ®åº“æ“ä½œå¤±è´¥ */
    data class DatabaseError(override val cause: Throwable?) : TopicError() {
        override val message: String = "æ•°æ®åº“æ“ä½œå¤±è´¥: ${cause?.message}"
    }
    
    /** æœªçŸ¥é”™è¯¯ */
    data class Unknown(override val cause: Throwable?) : TopicError() {
        override val message: String = cause?.message ?: "æœªçŸ¥é”™è¯¯"
    }
}
```

### 2. é”™è¯¯å¤„ç†ç­–ç•¥

| é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·æç¤º | é‡è¯•æ¬¡æ•° |
|----------|----------|----------|----------|
| å†…å®¹ä¸ºç©º | é˜»æ­¢ä¿å­˜ | "ä¸»é¢˜å†…å®¹ä¸èƒ½ä¸ºç©º" | 0 |
| å†…å®¹è¿‡é•¿ | é˜»æ­¢ä¿å­˜ | "ä¸»é¢˜å†…å®¹ä¸èƒ½è¶…è¿‡500å­—ç¬¦" | 0 |
| è”ç³»äººIDæ— æ•ˆ | é˜»æ­¢æ“ä½œ | "æ— æ³•è¯†åˆ«å½“å‰è”ç³»äºº" | 0 |
| æ•°æ®åº“é”™è¯¯ | é‡è¯•åæç¤º | "ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" | 3 |
| æœªçŸ¥é”™è¯¯ | è®°å½•æ—¥å¿— | "æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" | 1 |

### 3. é”™è¯¯æ¢å¤æµç¨‹

```kotlin
/**
 * å¸¦é‡è¯•çš„ä¸»é¢˜ä¿å­˜æ“ä½œ
 */
private suspend fun saveTopicWithRetry(
    topic: ConversationTopic,
    maxRetries: Int = 3
): Result<Unit> {
    var lastError: Throwable? = null
    
    repeat(maxRetries) { attempt ->
        topicRepository.setTopic(topic)
            .onSuccess { return Result.success(Unit) }
            .onFailure { error ->
                lastError = error
                // å¦‚æœæ˜¯éé‡è¯•ç±»é”™è¯¯ï¼Œç›´æ¥è¿”å›
                if (error is TopicError.EmptyContent || 
                    error is TopicError.ContentTooLong ||
                    error is TopicError.InvalidContactId) {
                    return Result.failure(error)
                }
                // ç­‰å¾…åé‡è¯•
                delay(100L * (attempt + 1))
            }
    }
    
    return Result.failure(lastError ?: TopicError.Unknown(null))
}
```

---

## ğŸ“ˆ æ€§èƒ½å½±å“è¯„ä¼°

### 1. æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | é¢„æœŸå€¼ | è¯´æ˜ |
|------|--------|--------|------|
| ä¸»é¢˜åŠ è½½æ—¶é—´ | <100ms | ~50ms | å•æ¡è®°å½•æŸ¥è¯¢ |
| ä¸»é¢˜ä¿å­˜æ—¶é—´ | <200ms | ~100ms | åŒ…å«æ—§ä¸»é¢˜åœç”¨ |
| å†…å­˜å ç”¨å¢é‡ | <1MB | ~500KB | ä¸»é¢˜æ•°æ®ç¼“å­˜ |
| æ•°æ®åº“å­˜å‚¨å¢é‡ | <100KB/è”ç³»äºº | ~10KB/è”ç³»äºº | å†å²è®°å½•é™åˆ¶10æ¡ |

### 2. ä¼˜åŒ–ç­–ç•¥

> **æ³¨æ„**: æ ¹æ®DR-00016å®¡æŸ¥å»ºè®®ï¼Œç®€åŒ–ç¼“å­˜ç­–ç•¥ï¼Œä½¿ç”¨Repositoryæ¨¡å¼çš„Flowå“åº”å¼æ•°æ®æµå³å¯æ»¡è¶³éœ€æ±‚ï¼Œæ— éœ€é¢å¤–çš„TopicCacheç»„ä»¶ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨Roomçš„Flowæ”¯æŒå®ç°å“åº”å¼æ•°æ®æ›´æ–°
- é€šè¿‡`observeActiveTopic()`æ–¹æ³•å®ç°å®æ—¶ä¸»é¢˜çŠ¶æ€åŒæ­¥
- é¿å…å¼•å…¥é¢å¤–çš„ç¼“å­˜å±‚ï¼Œä¿æŒå•ä¸€æ•°æ®æºåŸåˆ™

```kotlin
// åœ¨ViewModelä¸­ä½¿ç”¨Flowè§‚å¯Ÿä¸»é¢˜å˜åŒ–
private fun observeTopic() {
    viewModelScope.launch {
        getTopicUseCase.observe(contactId)
            .distinctUntilChanged()  // é¿å…é‡å¤æ›´æ–°
            .collect { topic ->
                _uiState.update { it.copy(currentTopic = topic) }
            }
    }
}
```

### 3. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

```sql
-- å·²åœ¨å®ä½“å®šä¹‰ä¸­åŒ…å«çš„ç´¢å¼•
CREATE INDEX index_conversation_topics_contact_id 
    ON conversation_topics(contact_id);

CREATE INDEX index_conversation_topics_contact_id_is_active 
    ON conversation_topics(contact_id, is_active);
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

#### é¢†åŸŸå±‚æµ‹è¯•

```kotlin
class SetTopicUseCaseTest {
    
    @Test
    fun `è®¾ç½®ä¸»é¢˜_å†…å®¹æœ‰æ•ˆ_è¿”å›æˆåŠŸ`() = runTest {
        // Given
        val contactId = "contact-1"
        val content = "è®¨è®ºé¡¹ç›®è¿›åº¦"
        
        // When
        val result = setTopicUseCase(contactId, content)
        
        // Then
        assertTrue(result.isSuccess)
        assertEquals(content, result.getOrNull()?.content)
    }
    
    @Test
    fun `è®¾ç½®ä¸»é¢˜_å†…å®¹ä¸ºç©º_è¿”å›å¤±è´¥`() = runTest {
        // Given
        val contactId = "contact-1"
        val content = ""
        
        // When
        val result = setTopicUseCase(contactId, content)
        
        // Then
        assertTrue(result.isFailure)
    }
    
    @Test
    fun `è®¾ç½®ä¸»é¢˜_å†…å®¹è¶…é•¿_è¿”å›å¤±è´¥`() = runTest {
        // Given
        val contactId = "contact-1"
        val content = "a".repeat(501)
        
        // When
        val result = setTopicUseCase(contactId, content)
        
        // Then
        assertTrue(result.isFailure)
    }
}
```

#### æ•°æ®å±‚æµ‹è¯•

```kotlin
class TopicRepositoryImplTest {
    
    @Test
    fun `ä¿å­˜ä¸»é¢˜åå¯ä»¥è·å–`() = runTest {
        // Given
        val topic = ConversationTopic(
            contactId = "contact-1",
            content = "æµ‹è¯•ä¸»é¢˜"
        )
        
        // When
        repository.setTopic(topic)
        val result = repository.getActiveTopic("contact-1")
        
        // Then
        assertNotNull(result)
        assertEquals("æµ‹è¯•ä¸»é¢˜", result?.content)
    }
    
    @Test
    fun `æ¸…é™¤ä¸»é¢˜åè·å–è¿”å›null`() = runTest {
        // Given
        val topic = ConversationTopic(
            contactId = "contact-1",
            content = "æµ‹è¯•ä¸»é¢˜"
        )
        repository.setTopic(topic)
        
        // When
        repository.clearTopic("contact-1")
        val result = repository.getActiveTopic("contact-1")
        
        // Then
        assertNull(result)
    }
}
```

### 2. UIæµ‹è¯•

```kotlin
class TopicSettingDialogTest {
    
    @get:Rule
    val composeTestRule = createComposeRule()
    
    @Test
    fun `æ˜¾ç¤ºå¯¹è¯æ¡†æ—¶è¾“å…¥æ¡†å¯è§`() {
        // Given
        val uiState = TopicUiState(showSettingDialog = true)
        
        // When
        composeTestRule.setContent {
            TopicSettingDialog(
                uiState = uiState,
                onEvent = {}
            )
        }
        
        // Then
        composeTestRule.onNodeWithText("ä¸»é¢˜æè¿°").assertIsDisplayed()
    }
    
    @Test
    fun `è¾“å…¥è¶…é•¿å†…å®¹æ˜¾ç¤ºé”™è¯¯`() {
        // Given
        val uiState = TopicUiState(
            showSettingDialog = true,
            inputContent = "a".repeat(501)
        )
        
        // When
        composeTestRule.setContent {
            TopicSettingDialog(
                uiState = uiState,
                onEvent = {}
            )
        }
        
        // Then
        composeTestRule.onNodeWithText("å·²è¶…å‡ºå­—ç¬¦é™åˆ¶").assertIsDisplayed()
    }
}
```

### 3. é›†æˆæµ‹è¯•

```kotlin
class TopicIntegrationTest {
    
    @Test
    fun `ä¸»é¢˜è®¾ç½®åAIè¯·æ±‚åŒ…å«ä¸»é¢˜å†…å®¹`() = runTest {
        // Given
        val contactId = "contact-1"
        val topicContent = "è®¨è®ºç¼–ç¨‹å­¦ä¹ "
        setTopicUseCase(contactId, topicContent)
        
        // When
        val systemPrompt = promptBuilder.buildWithTopic(
            scene = PromptScene.ANALYZE,
            context = mockContext,
            topic = topicRepository.getActiveTopic(contactId)
        )
        
        // Then
        assertTrue(systemPrompt.contains(topicContent))
        assertTrue(systemPrompt.contains("å½“å‰å¯¹è¯ä¸»é¢˜"))
    }
}
```

---

## ğŸ“… å®æ–½è®¡åˆ’

### é˜¶æ®µåˆ’åˆ†

| é˜¶æ®µ | å†…å®¹ | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|----------|--------|
| é˜¶æ®µ1 | æ•°æ®æ¨¡å‹å’Œæ•°æ®åº“è¿ç§» | 4h | P0 |
| é˜¶æ®µ2 | é¢†åŸŸå±‚å®ç°ï¼ˆRepositoryã€UseCaseï¼‰ | 4h | P0 |
| é˜¶æ®µ3 | æ•°æ®å±‚å®ç°ï¼ˆDAOã€RepositoryImplï¼‰ | 4h | P0 |
| é˜¶æ®µ4 | è¡¨ç°å±‚å®ç°ï¼ˆViewModelã€UIç»„ä»¶ï¼‰ | 6h | P0 |
| é˜¶æ®µ5 | ç³»ç»Ÿæç¤ºè¯é›†æˆ | 4h | P0 |
| é˜¶æ®µ6 | æ‚¬æµ®çª—é›†æˆ | 4h | P1 |
| é˜¶æ®µ7 | å•å…ƒæµ‹è¯• | 4h | P0 |
| é˜¶æ®µ8 | é›†æˆæµ‹è¯•å’ŒUIæµ‹è¯• | 4h | P1 |

**æ€»é¢„è®¡å·¥æ—¶**: 34å°æ—¶

### è¯¦ç»†ä»»åŠ¡æ¸…å•

#### é˜¶æ®µ1: æ•°æ®æ¨¡å‹å’Œæ•°æ®åº“è¿ç§» (4h)

- [ ] 1.1 åˆ›å»º `ConversationTopic` é¢†åŸŸæ¨¡å‹
- [ ] 1.2 åˆ›å»º `ConversationTopicEntity` æ•°æ®åº“å®ä½“
- [ ] 1.3 ç¼–å†™ `MIGRATION_10_11` æ•°æ®åº“è¿ç§»è„šæœ¬
- [ ] 1.4 æ›´æ–° `AppDatabase` æ·»åŠ æ–°è¡¨å’ŒDAO
- [ ] 1.5 ç¼–å†™æ•°æ®åº“è¿ç§»æµ‹è¯•

#### é˜¶æ®µ2: é¢†åŸŸå±‚å®ç° (4h)

- [ ] 2.1 åˆ›å»º `TopicRepository` æ¥å£
- [ ] 2.2 å®ç° `SetTopicUseCase`
- [ ] 2.3 å®ç° `GetTopicUseCase`
- [ ] 2.4 å®ç° `ClearTopicUseCase`
- [ ] 2.5 åˆ›å»º `TopicError` é”™è¯¯ç±»å‹

#### é˜¶æ®µ3: æ•°æ®å±‚å®ç° (4h)

- [ ] 3.1 åˆ›å»º `ConversationTopicDao`
- [ ] 3.2 å®ç° `TopicRepositoryImpl`
- [ ] 3.3 åˆ›å»º `TopicModule` ä¾èµ–æ³¨å…¥æ¨¡å—
- [ ] 3.4 æ›´æ–° `DatabaseModule` æ·»åŠ DAOæä¾›æ–¹æ³•

#### é˜¶æ®µ4: è¡¨ç°å±‚å®ç° (6h)

- [ ] 4.1 åˆ›å»º `TopicUiState` å’Œ `TopicUiEvent`
- [ ] 4.2 å®ç° `TopicViewModel`
- [ ] 4.3 å®ç° `TopicSettingDialog` ç»„ä»¶
- [ ] 4.4 å®ç° `TopicInputField` ç»„ä»¶
- [ ] 4.5 å®ç° `TopicBadge` ç»„ä»¶
- [ ] 4.6 å®ç° `TopicHistorySection` ç»„ä»¶

#### é˜¶æ®µ5: ç³»ç»Ÿæç¤ºè¯é›†æˆ (4h)

- [ ] 5.1 æ›´æ–° `PromptBuilder` æ·»åŠ ä¸»é¢˜æ”¯æŒ
- [ ] 5.2 æ›´æ–° `AnalyzeChatUseCase` é›†æˆä¸»é¢˜
- [ ] 5.3 æ›´æ–° `PolishDraftUseCase` é›†æˆä¸»é¢˜
- [ ] 5.4 æ›´æ–° `GenerateReplyUseCase` é›†æˆä¸»é¢˜
- [ ] 5.5 æ›´æ–° `SummarizeDailyConversationsUseCase` é›†æˆä¸»é¢˜

#### é˜¶æ®µ6: æ‚¬æµ®çª—é›†æˆ (4h)

- [ ] 6.1 æ›´æ–° `FloatingViewV2` æ·»åŠ ä¸»é¢˜æ˜¾ç¤º
- [ ] 6.2 æ›´æ–° `FloatingWindowService` é›†æˆä¸»é¢˜
- [ ] 6.3 å®ç°æ‚¬æµ®çª—å†…ä¸»é¢˜å¿«æ·è®¾ç½®å…¥å£
- [ ] 6.4 å®ç°ä¸»é¢˜çŠ¶æ€å®æ—¶åŒæ­¥

#### é˜¶æ®µ7: å•å…ƒæµ‹è¯• (4h)

- [ ] 7.1 ç¼–å†™ `SetTopicUseCaseTest`
- [ ] 7.2 ç¼–å†™ `GetTopicUseCaseTest`
- [ ] 7.3 ç¼–å†™ `ClearTopicUseCaseTest`
- [ ] 7.4 ç¼–å†™ `TopicRepositoryImplTest`
- [ ] 7.5 ç¼–å†™ `TopicViewModelTest`

#### é˜¶æ®µ8: é›†æˆæµ‹è¯•å’ŒUIæµ‹è¯• (4h)

- [ ] 8.1 ç¼–å†™ `TopicSettingDialogTest`
- [ ] 8.2 ç¼–å†™ `TopicBadgeTest`
- [ ] 8.3 ç¼–å†™ `TopicIntegrationTest`
- [ ] 8.4 ç¼–å†™æ•°æ®åº“è¿ç§»é›†æˆæµ‹è¯•

---

## ğŸ“ é™„å½•

### A. æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ç±»å‹ | è¯´æ˜ |
|----------|------|------|
| `domain/model/ConversationTopic.kt` | æ–°å¢ | å¯¹è¯ä¸»é¢˜é¢†åŸŸæ¨¡å‹ |
| `domain/repository/TopicRepository.kt` | æ–°å¢ | ä¸»é¢˜ä»“åº“æ¥å£ |
| `domain/usecase/SetTopicUseCase.kt` | æ–°å¢ | è®¾ç½®ä¸»é¢˜ç”¨ä¾‹ |
| `domain/usecase/GetTopicUseCase.kt` | æ–°å¢ | è·å–ä¸»é¢˜ç”¨ä¾‹ |
| `domain/usecase/ClearTopicUseCase.kt` | æ–°å¢ | æ¸…é™¤ä¸»é¢˜ç”¨ä¾‹ |
| `data/local/entity/ConversationTopicEntity.kt` | æ–°å¢ | ä¸»é¢˜æ•°æ®åº“å®ä½“ |
| `data/local/dao/ConversationTopicDao.kt` | æ–°å¢ | ä¸»é¢˜DAO |
| `data/repository/TopicRepositoryImpl.kt` | æ–°å¢ | ä¸»é¢˜ä»“åº“å®ç° |
| `di/TopicModule.kt` | æ–°å¢ | ä¸»é¢˜ä¾èµ–æ³¨å…¥æ¨¡å— |
| `presentation/viewmodel/TopicViewModel.kt` | æ–°å¢ | ä¸»é¢˜ViewModel |
| `presentation/viewmodel/TopicUiState.kt` | æ–°å¢ | ä¸»é¢˜UIçŠ¶æ€ |
| `presentation/viewmodel/TopicUiEvent.kt` | æ–°å¢ | ä¸»é¢˜UIäº‹ä»¶ |
| `presentation/ui/component/topic/TopicSettingDialog.kt` | æ–°å¢ | ä¸»é¢˜è®¾ç½®å¯¹è¯æ¡† |
| `presentation/ui/component/topic/TopicInputField.kt` | æ–°å¢ | ä¸»é¢˜è¾“å…¥æ¡† |
| `presentation/ui/component/topic/TopicBadge.kt` | æ–°å¢ | ä¸»é¢˜çŠ¶æ€å¾½ç«  |
| `presentation/ui/component/topic/TopicHistorySection.kt` | æ–°å¢ | ä¸»é¢˜å†å²åŒºåŸŸ |
| `domain/util/PromptBuilder.kt` | æ›´æ–° | æ·»åŠ ä¸»é¢˜æ”¯æŒ |
| `domain/usecase/AnalyzeChatUseCase.kt` | æ›´æ–° | é›†æˆä¸»é¢˜ |
| `domain/usecase/PolishDraftUseCase.kt` | æ›´æ–° | é›†æˆä¸»é¢˜ |
| `domain/usecase/GenerateReplyUseCase.kt` | æ›´æ–° | é›†æˆä¸»é¢˜ |
| `presentation/ui/floating/FloatingViewV2.kt` | æ›´æ–° | æ·»åŠ ä¸»é¢˜æ˜¾ç¤º |
| `data/local/AppDatabase.kt` | æ›´æ–° | æ·»åŠ æ–°è¡¨å’Œè¿ç§» |

### B. æ•°æ®åº“Schemaå˜æ›´

```sql
-- æ–°å¢è¡¨: conversation_topics
CREATE TABLE conversation_topics (
    id TEXT PRIMARY KEY NOT NULL,
    contact_id TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    is_active INTEGER NOT NULL DEFAULT 1,
    FOREIGN KEY (contact_id) REFERENCES contact_profiles(id) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX index_conversation_topics_contact_id 
    ON conversation_topics(contact_id);
CREATE INDEX index_conversation_topics_contact_id_is_active 
    ON conversation_topics(contact_id, is_active);
```

### C. APIå˜æ›´

æ— å¤–éƒ¨APIå˜æ›´ï¼Œæ‰€æœ‰åŠŸèƒ½å‡ä¸ºæœ¬åœ°å®ç°ã€‚

### D. å…¼å®¹æ€§è¯´æ˜

- **å‘åå…¼å®¹**: æ–°åŠŸèƒ½ä¸å½±å“ç°æœ‰åŠŸèƒ½
- **æ•°æ®è¿ç§»**: Roomè‡ªåŠ¨å¤„ç†æ•°æ®åº“å‡çº§
- **é™çº§å¤„ç†**: ä¸æ”¯æŒé™çº§ï¼Œéœ€ä¿æŒæ•°æ®åº“ç‰ˆæœ¬å•è°ƒé€’å¢

---

## ğŸ“ å®¡æŸ¥è®°å½•

| æ—¥æœŸ | å®¡æŸ¥äºº | å®¡æŸ¥ç»“æœ | å¤‡æ³¨ |
|------|--------|----------|------|
| 2025-12-22 | Claude | âš ï¸ éœ€æ”¹è¿› | DR-00016ï¼šæŠ€æœ¯è®¾è®¡è¯¦å°½ï¼Œä½†é›†æˆå®Œæ•´æ€§ä¸¥é‡ä¸è¶³ |
| 2025-12-22 | Kiro | âœ… å·²ä¿®å¤ | æ ¹æ®DR-00016è¡¥å……ï¼šç³»ç»Ÿé›†æˆè®¾è®¡ã€ç”¨æˆ·å…¥å£ç‚¹ã€æ•°æ®åº“é›†æˆ |

---

*æ–‡æ¡£ç»“æŸ*
