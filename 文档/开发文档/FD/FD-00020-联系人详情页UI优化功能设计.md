# FD-00020: 联系人详情页UI优化功能设计

> **文档类型**: 功能设计文档 (FD)
> **版本**: 1.1
> **创建日期**: 2025-12-25
> **最后更新**: 2025-12-25
> **负责人**: Kiro
> **状态**: ✅ 已完成
> **优先级**: 🔴 高
> **关联PRD**: PRD-00020
> **关联调研**: RESEARCH-00053
> **审查报告**: CR-00020

---

## 📜 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| 1.0 | 2025-12-25 | 初始版本，包含5个页面的完整设计 | Kiro |
| 1.1 | 2025-12-25 | 根据CR-00020审查报告修订：添加版本控制、性能优化策略、国际化支持 | Kiro |

---

## 📋 文档概述

### 设计目标
基于HTML设计稿，对联系人详情页5个页面进行完全重写，采用iOS原生风格。

### 设计原则
- **iOS原生风格** - 分段控制器、毛玻璃效果、系统色彩
- **完全重写** - 不修改现有代码，全部重新实现
- **设计稿一致** - 严格按照HTML设计稿实现

### 关联文档
- PRD-00020-联系人详情页优化
- RESEARCH-00053-前置调研报告
- FD-00019-UI视觉美观化改造功能设计
- CR-00020-FD00020联系人详情页UI优化功能设计审查报告

### 🔴 设计稿强制引用

| 页面 | 设计稿路径 |
|------|-----------|
| 概览页 | `文档/开发文档/UI-原型/PRD20/联系人详情/概览页.html` |
| 事实流页 | `文档/开发文档/UI-原型/PRD20/联系人详情/事实流页.html` |
| 画像库页 | `文档/开发文档/UI-原型/PRD20/联系人详情/画像库页.html` |
| 资料库页 | `文档/开发文档/UI-原型/PRD20/联系人详情/资料库页.html` |
| 新建联系人页 | `文档/开发文档/UI-原型/PRD20/联系人详情/新建联系人页.html` |



---

## 🎨 色彩系统设计

### iOS系统色常量

**修改文件**: `presentation/.../theme/Color.kt`

```kotlin
// iOS系统背景色
val iOSSystemGroupedBackground = Color(0xFFF2F2F7)
val iOSLightGrayBackground = Color(0xFFF5F5F7)
val iOSCardBackground = Color(0xFFFFFFFF)

// iOS系统色
val iOSBlue = Color(0xFF007AFF)      // 链接、按钮
val iOSGreen = Color(0xFF34C759)     // 成功、开关
val iOSRed = Color(0xFFFF3B30)       // 删除、警告
val iOSOrange = Color(0xFFFF9500)    // 中风险
val iOSPurple = Color(0xFFAF52DE)    // AI功能
val iOSIndigo = Color(0xFF5856D6)    // 资料库

// iOS文字色
val iOSTextPrimary = Color(0xFF000000)
val iOSTextSecondary = Color(0xFF8E8E93)
val iOSTextTertiary = Color(0xFFC7C7CC)

// iOS分隔线
val iOSSeparator = Color(0xFFE5E5EA)
```

### 情绪类型颜色映射

```kotlin
object EmotionColors {
    val Sweet = listOf(Color(0xFFFFB6C1), Color(0xFFFF69B4))      // 甜蜜
    val Conflict = listOf(Color(0xFFFFA07A), Color(0xFFFF6347))   // 冲突
    val Neutral = listOf(Color(0xFFB0C4DE), Color(0xFF87CEEB))    // 中性
    val Gift = listOf(Color(0xFFFFD700), Color(0xFFFFA500))       // 礼物
    val Date = listOf(Color(0xFFDDA0DD), Color(0xFFBA55D3))       // 约会
    val DeepTalk = listOf(Color(0xFF98D8C8), Color(0xFF20B2AA))   // 深谈
}
```

### 马卡龙色系标签

```kotlin
object MacaronTagColors {
    val Pink = Color(0xFFFFF0F3) to Color(0xFFC41E3A)
    val Yellow = Color(0xFFFFF8E1) to Color(0xFFB8860B)
    val Cyan = Color(0xFFE0F7FA) to Color(0xFF00838F)
    val Purple = Color(0xFFF3E5F5) to Color(0xFF7B1FA2)
    val Green = Color(0xFFE8F5E9) to Color(0xFF2E7D32)
    val Blue = Color(0xFFE3F2FD) to Color(0xFF1565C0)
}
```

### 分类卡片色条颜色

```kotlin
object CategoryBarColors {
    val Orange = Color(0xFFF97316)   // 兴趣爱好
    val Blue = Color(0xFF3B82F6)     // 工作信息
    val Green = Color(0xFF10B981)    // 沟通策略
    val Red = Color(0xFFEF4444)      // 雷区标签
}
```

---

## 📱 模块1：概览页设计 (OverviewTab)

**设计稿**: `文档/开发文档/UI-原型/PRD20/联系人详情/概览页.html`

### 1.1 布局结构

```
┌─────────────────────────────────────────┐
│  [←]                      [主题] [编辑] │  毛玻璃导航栏
├─────────────────────────────────────────┤
│  [概览] [事实流] [标签画像] [资料库]    │  iOS分段控制器
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐  │
│  │ [头像] 小红  女朋友·上海 [105天]  │  │  个人信息卡片
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │ [圆环85] 关系良好    [趋势图↑]    │  │  关系分数卡片
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │ 核心标签: [🔥吃辣][🐱猫奴][💼]   │  │  核心标签卡片
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │ [❤️] 新发现: 喜欢爬山...    [>]   │  │  最新动态卡片
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │ [✨] 设置专属AI分析指令      [>]  │  │  专属指令卡片
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 1.2 核心组件

#### iOS分段控制器

**新增**: `IOSSegmentedControl.kt`

- 背景: `rgba(118, 118, 128, 0.12)`
- 滑块: 白色带投影，圆角7dp
- 动画: 250ms滑动过渡

#### Apple Health圆环图

**新增**: `HealthRingChart.kt`

- 尺寸: 72x72dp
- 描边: 8dp
- 渐变: `#FF6B9D → #FF8A80 → #FFC371`
- 圆头末端: `StrokeCap.Round`

#### Sparkline趋势图

**新增**: `SparklineChart.kt`

- 尺寸: 60x28dp
- 颜色: `#34C759` (iOS绿)
- 平滑曲线: 二次贝塞尔

### 1.3 样式规范

| 元素 | 规格 |
|------|------|
| 页面背景 | `#F2F2F7` |
| 卡片圆角 | 14dp |
| 卡片边距 | 16dp |
| 头像尺寸 | 60x60dp |
| 分段控制器高度 | 32dp |

### 1.4 代码映射

| 组件 | 文件 | 状态 |
|------|------|------|
| 分段控制器 | IOSSegmentedControl.kt | 新增 |
| 个人信息卡片 | ProfileInfoCard.kt | 新增 |
| 关系分数卡片 | RelationshipScoreCard.kt | 重写 |
| 核心标签卡片 | CoreTagsCard.kt | 新增 |
| 最新动态卡片 | LatestDiscoveryCard.kt | 重写 |
| 专属指令卡片 | CustomPromptCard.kt | 重写 |



---

## 📱 模块2：事实流页设计 (FactStreamTab)

**设计稿**: `文档/开发文档/UI-原型/PRD20/联系人详情/事实流页.html`

### 2.1 布局结构

```
┌─────────────────────────────────────────┐
│  [←]        小红        [+] [筛选]      │  导航栏
├─────────────────────────────────────────┤
│  [概览] [事实流] [标签画像] [资料库]    │  标签页导航
├─────────────────────────────────────────┤
│  ┌─────────────┬─────────────┐          │
│  │   时光轴    │    清单     │          │  视图切换
│  └─────────────┴─────────────┘          │
│  [全部] [❤️甜蜜] [⛈️冲突] [🍽️约会]     │  筛选胶囊
├─────────────────────────────────────────┤
│  ○──┬─────────────────────────────────  │
│  ❤️ │ 今天 14:30                        │
│     │ 我：今天想约她出去吃饭...         │  时光轴视图
│     │ ┌─AI建议─────────────────┐        │
│     │ │ 建议选择川菜馆...      │        │
│     │ └────────────────────────┘        │
│  ○──┼─────────────────────────────────  │
│  🧠 │ AI日总结 - 昨天                   │
│     │ 今天的互动整体氛围不错...         │
│     │ [讨论周末计划] [户外活动兴趣]     │
│     │ 关系分数 +2                       │
│  ○──┼─────────────────────────────────  │
│  📝 │ 兴趣爱好 - 12-20                  │
│     │ 喜欢周末去爬山...                 │
│  ○──┴─────────────────────────────────  │
└─────────────────────────────────────────┘
        [🤖 手动总结]  ← 悬浮按钮
```

### 2.2 核心组件

#### 情绪节点时光轴

**新增**: `EmotionTimelineView.kt`

```kotlin
@Composable
fun EmotionTimelineView(
    items: List<TimelineItem>,
    modifier: Modifier = Modifier
) {
    LazyColumn(modifier = modifier) {
        itemsIndexed(items) { index, item ->
            Row(modifier = Modifier.fillMaxWidth()) {
                // 左侧：情绪节点 + 连接线
                Column(
                    modifier = Modifier.width(48.dp),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    EmotionNode(emotionType = item.emotionType)
                    if (index < items.lastIndex) {
                        TimelineLine()
                    }
                }
                // 右侧：内容卡片
                TimelineCard(item = item)
            }
        }
    }
}
```

#### 情绪节点组件

**新增**: `EmotionNode.kt`

- 尺寸: 40x40dp
- 渐变背景: 根据EmotionType
- 白色环形边框: 4dp
- 投影: shadow-lg

#### 筛选胶囊组件

**新增**: `FilterChipRow.kt`

- 激活态: `#007AFF` 背景，白色文字
- 未激活: 白色背景，灰色边框
- 圆角: 20dp (rounded-full)

### 2.3 情绪类型枚举

```kotlin
enum class EmotionType(
    val emoji: String,
    val gradientColors: List<Color>,
    val displayName: String
) {
    SWEET("❤️", EmotionColors.Sweet, "甜蜜"),
    CONFLICT("⛈️", EmotionColors.Conflict, "冲突"),
    NEUTRAL("💭", EmotionColors.Neutral, "中性"),
    GIFT("🎁", EmotionColors.Gift, "礼物"),
    DATE("🍽️", EmotionColors.Date, "约会"),
    DEEP_TALK("💬", EmotionColors.DeepTalk, "深谈")
}
```

### 2.4 样式规范

| 元素 | 规格 |
|------|------|
| 页面背景 | `#F5F5F7` |
| 卡片圆角 | 16dp |
| 情绪节点 | 40x40dp |
| 连接线宽度 | 2dp |
| 筛选胶囊高度 | 36dp |
| 悬浮按钮 | 56dp, 紫粉渐变 |

### 2.5 代码映射

| 组件 | 文件 | 状态 |
|------|------|------|
| 时光轴视图 | EmotionTimelineView.kt | 新增 |
| 情绪节点 | EmotionNode.kt | 新增 |
| 时光轴卡片 | TimelineCard.kt | 新增 |
| 清单视图 | FactListView.kt | 重写 |
| 筛选胶囊 | FilterChipRow.kt | 新增 |
| AI日总结卡片 | AiSummaryCard.kt | 新增 |

---

## 📱 模块3：画像库页设计 (PersonaTab)

**设计稿**: `文档/开发文档/UI-原型/PRD20/联系人详情/画像库页.html`

### 3.1 布局结构

```
┌─────────────────────────────────────────┐
│  [←]        小红              [编辑]    │  导航栏
├─────────────────────────────────────────┤
│  [概览] [事实流] [画像] [资料库]        │  标签页导航
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐  │
│  │ 🔍 搜索标签或分类...              │  │  搜索栏
│  └───────────────────────────────────┘  │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │▌兴趣爱好                    3个 ▼│  │
│  │ [打羽毛球] [喜欢爬山] [猫奴] [+]  │  │  分类卡片
│  └───────────────────────────────────┘  │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │▌工作信息                    2个 ▼│  │
│  │ [大厂员工] [产品经理] [+]        │  │  分类卡片
│  └───────────────────────────────────┘  │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │▌雷区标签                    2个 ▼│  │
│  │ ┌─────────────────────────────┐  │  │
│  │ │ ⚠️ 不要提前任      [高风险] │  │  │  雷区标签项
│  │ │    对方对这个话题非常敏感   │  │  │
│  │ └─────────────────────────────┘  │  │
│  └───────────────────────────────────┘  │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ 🧠 AI自动推测          [全部采纳]│  │
│  │ ├─ 咖啡爱好者        [✗] [✓] │  │  │  AI推测区域
│  │ ├─ 摄影发烧友        [✗] [✓] │  │  │
│  │ └─ 夜猫子            [✗] [✓] │  │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
        [+ 添加标签]  ← 悬浮按钮
```

### 3.2 核心组件

#### 分类卡片组件

**新增**: `CategoryCard.kt`

```kotlin
@Composable
fun CategoryCard(
    category: TagCategory,
    tags: List<BrainTag>,
    isExpanded: Boolean,
    onToggle: () -> Unit,
    onAddTag: () -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier
            .fillMaxWidth()
            .drawBehind {
                // 左侧4px色条
                drawRect(
                    color = category.barColor,
                    topLeft = Offset.Zero,
                    size = Size(4.dp.toPx(), size.height)
                )
            },
        shape = RoundedCornerShape(16.dp),
        colors = CardDefaults.cardColors(containerColor = Color.White)
    ) {
        // 头部：分类名 + 数量 + 折叠图标
        // 内容：标签胶囊列表 + 添加按钮
    }
}
```

#### 雷区/策略标签项

**新增**: `RiskTagItem.kt` / `StrategyTagItem.kt`

- 左侧圆形图标: 36dp
- 风险等级徽标: 高/中/低
- 描述文字: 13sp灰色

#### AI推测区域

**新增**: `AiInferenceSection.kt`

- 列表样式，分隔线分隔
- 确认按钮: 绿色圆形
- 拒绝按钮: 灰色圆形

### 3.3 样式规范

| 元素 | 规格 |
|------|------|
| 页面背景 | `#F5F5F7` |
| 卡片圆角 | 16dp |
| 左侧色条 | 4dp宽 |
| 标签胶囊 | rounded-full |
| 添加按钮 | 虚线边框 |
| 悬浮按钮 | 56dp, `#07C160` |

### 3.4 代码映射

| 组件 | 文件 | 状态 |
|------|------|------|
| 分类卡片 | CategoryCard.kt | 新增 |
| 标签胶囊 | MacaronTagChip.kt | 新增 |
| 雷区标签项 | RiskTagItem.kt | 新增 |
| 策略标签项 | StrategyTagItem.kt | 新增 |
| AI推测区域 | AiInferenceSection.kt | 重写 |



---

## 📱 模块4：资料库页设计 (DataVaultTab)

**设计稿**: `文档/开发文档/UI-原型/PRD20/联系人详情/资料库页.html`

### 4.1 布局结构

```
┌─────────────────────────────────────────┐
│  [←]        小红              [更多]    │  导航栏
├─────────────────────────────────────────┤
│  [概览] [事实流] [标签画像] [资料库]    │  标签页导航
├─────────────────────────────────────────┤
│  数据来源                               │
│  管理与该联系人相关的所有数据           │  标题区域
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ 数据总量                          │  │
│  │ 854 条                    [📊]    │  │  统计卡片
│  └───────────────────────────────────┘  │
│                                         │
│  ┌───────────────┐ ┌───────────────┐   │
│  │ [💬] 842      │ │ [✨] 12       │   │
│  │ 聊天记录      │ │ AI总结       │   │  数据网格
│  │ 对话历史      │ │ 智能分析     │   │
│  └───────────────┘ └───────────────┘   │
│  ┌───────────────┐ ┌───────────────┐   │
│  │ [🖼️] 0  ●    │ │ [🎤] 0  ●    │   │
│  │ 图片          │ │ 语音消息     │   │
│  │ 媒体文件      │ │ 音频记录     │   │
│  └───────────────┘ └───────────────┘   │
│  ┌───────────────┐ ┌───────────────┐   │
│  │ [📹] 0  ●    │ │ [📁] 0  ●    │   │
│  │ 视频          │ │ 文件         │   │
│  │ 视频动态      │ │ 其他文档     │   │
│  └───────────────┘ └───────────────┘   │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ ⚠️ 媒体功能开发中                 │  │  提示区域
│  │ 图片、语音、视频功能正在开发...   │  │
│  └───────────────────────────────────┘  │
│                                         │
│  状态说明                               │
│  ┌───────────────────────────────────┐  │
│  │ ● 已完成 - 数据已同步             │  │
│  │ ● 处理中 - 正在同步数据           │  │  状态说明
│  │ ● 不可用 - 功能开发中             │  │
│  │ ● 失败 - 同步出错                 │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 4.2 核心组件

#### 数据统计卡片

**新增**: `DataStatisticsCard.kt`

- 装饰性背景: 渐变圆形blur
- 数字: 32sp Bold
- 图标: 48dp圆形背景

#### 数据来源卡片

**新增**: `DataSourceGridCard.kt`

```kotlin
@Composable
fun DataSourceGridCard(
    icon: ImageVector,
    iconColor: Color,
    iconBgColor: Color,
    count: Int,
    title: String,
    subtitle: String,
    status: DataStatus,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier
            .clickable(onClick = onClick)
            .scale(if (pressed) 0.98f else 1f),
        shape = RoundedCornerShape(20.dp),
        colors = CardDefaults.cardColors(containerColor = Color.White)
    ) {
        // 图标 + 数量徽标
        // 标题 + 副标题
        // 状态角标
    }
}
```

#### 状态角标

**新增**: `StatusBadge.kt`

```kotlin
enum class DataStatus(val color: Color, val displayName: String) {
    COMPLETED(Color(0xFF10B981), "已完成"),
    PROCESSING(Color(0xFF3B82F6), "处理中"),
    NOT_AVAILABLE(Color(0xFFD1D5DB), "不可用"),
    FAILED(Color(0xFFEF4444), "失败")
}
```

### 4.3 样式规范

| 元素 | 规格 |
|------|------|
| 页面背景 | `#F2F2F7` |
| 卡片圆角 | 20dp |
| 网格列数 | 2列 |
| 网格间距 | 12dp |
| 图标容器 | 44dp |
| 状态角标 | 8dp圆点 |

### 4.4 数据来源配置

| 数据源 | 图标 | 颜色 | 状态 |
|--------|------|------|------|
| 聊天记录 | chat_bubble | 蓝色 | 已实现 |
| AI总结 | auto_awesome | 紫色 | 已实现 |
| 图片 | image | 粉色 | 不可用 |
| 语音 | mic | 青色 | 不可用 |
| 视频 | videocam | 橙色 | 不可用 |
| 文件 | folder | 绿色 | 不可用 |

### 4.5 代码映射

| 组件 | 文件 | 状态 |
|------|------|------|
| 统计卡片 | DataStatisticsCard.kt | 新增 |
| 数据网格 | DataSourceGrid.kt | 新增 |
| 数据卡片 | DataSourceGridCard.kt | 新增 |
| 状态角标 | StatusBadge.kt | 新增 |
| 提示区域 | DevelopmentHintCard.kt | 新增 |

---

## 📱 模块5：新建联系人页设计 (CreateContactScreen)

**设计稿**: `文档/开发文档/UI-原型/PRD20/联系人详情/新建联系人页.html`

### 5.1 布局结构

```
┌─────────────────────────────────────────┐
│  取消        新建联系人          完成   │  iOS导航栏
├─────────────────────────────────────────┤
│                                         │
│              ┌─────────┐                │
│              │  [👤]   │                │
│              │ 100x100 │                │  头像区域
│              └─────────┘                │
│              添加照片                    │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ 姓名                              │  │
│  │ ┌─────────────────────────────┐  │  │
│  │ │ 输入姓名                    │  │  │  基本信息卡片
│  │ └─────────────────────────────┘  │  │
│  │ 沟通目标                          │  │
│  │ ┌─────────────────────────────┐  │  │
│  │ │ 例如：建立初步信任          │  │  │
│  │ └─────────────────────────────┘  │  │
│  └───────────────────────────────────┘  │
│  设定明确的沟通目标有助于AI提供建议     │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ [+] 添加画像事实                  │  │  添加事实按钮
│  └───────────────────────────────────┘  │
│  添加关于此联系人的事实...              │
│                                         │
└─────────────────────────────────────────┘
```

### 5.2 核心组件

#### iOS导航栏

**新增**: `IOSNavigationBar.kt`

```kotlin
@Composable
fun IOSNavigationBar(
    title: String,
    onCancel: () -> Unit,
    onDone: () -> Unit,
    isDoneEnabled: Boolean = true,
    modifier: Modifier = Modifier
) {
    Row(
        modifier = modifier
            .fillMaxWidth()
            .height(52.dp)
            .background(iOSLightGrayBackground.copy(alpha = 0.95f))
            .padding(horizontal = 16.dp),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        TextButton(onClick = onCancel) {
            Text("取消", color = iOSBlue, fontSize = 17.sp)
        }
        Text(
            text = title,
            fontSize = 17.sp,
            fontWeight = FontWeight.Bold
        )
        TextButton(
            onClick = onDone,
            enabled = isDoneEnabled
        ) {
            Text(
                "完成",
                color = if (isDoneEnabled) iOSBlue else iOSTextSecondary,
                fontSize = 17.sp,
                fontWeight = FontWeight.SemiBold
            )
        }
    }
}
```

#### 头像选择器

**新增**: `AvatarPicker.kt`

- 尺寸: 100x100dp
- 占位符: 渐变灰色背景 + 人物图标
- 白色边框: 3dp
- 外层投影容器

#### iOS风格表单

**复用**: `IOSSettingsSection.kt`

- 输入框背景: `#F8F8FA`
- 圆角: 10dp
- 标签: 13sp灰色

### 5.3 样式规范

| 元素 | 规格 |
|------|------|
| 页面背景 | `#F5F5F7` |
| 导航栏高度 | 52dp |
| 头像尺寸 | 100x100dp |
| 卡片圆角 | 16dp |
| 输入框圆角 | 10dp |
| 输入框背景 | `#F8F8FA` |

### 5.4 代码映射

| 组件 | 文件 | 状态 |
|------|------|------|
| iOS导航栏 | IOSNavigationBar.kt | 新增 |
| 头像选择器 | AvatarPicker.kt | 新增 |
| 表单卡片 | ContactFormCard.kt | 新增 |
| 添加事实按钮 | AddFactButton.kt | 新增 |



---

## 🧪 测试用例

### 6.1 概览页测试

| 测试ID | 测试场景 | 预期结果 |
|--------|----------|----------|
| OV-001 | 分段控制器切换 | 滑块平滑移动，内容正确切换 |
| OV-002 | 圆环图动画 | 进度从0动画填充到目标值 |
| OV-003 | 趋势图渲染 | 曲线平滑，终点圆点显示 |
| OV-004 | 核心标签展示 | Emoji+马卡龙色正确显示 |
| OV-005 | 最新动态点击 | 跳转到事实流页 |
| OV-006 | 专属指令点击 | 跳转到提示词编辑器 |
| OV-007 | 空状态展示 | 无标签时显示"AI正在学习中" |

### 6.2 事实流页测试

| 测试ID | 测试场景 | 预期结果 |
|--------|----------|----------|
| FS-001 | 视图切换 | 时光轴/清单视图正确切换 |
| FS-002 | 筛选功能 | 点击筛选胶囊正确过滤内容 |
| FS-003 | 情绪节点颜色 | 6种情绪类型颜色正确 |
| FS-004 | 连接线渲染 | 节点间连接线正确显示 |
| FS-005 | AI日总结卡片 | 紫色边框，关系分数变化显示 |
| FS-006 | 手动总结按钮 | 悬浮按钮点击触发总结流程 |
| FS-007 | 淡入动画 | 卡片错落淡入效果 |

### 6.3 画像库页测试

| 测试ID | 测试场景 | 预期结果 |
|--------|----------|----------|
| PS-001 | 分类卡片折叠 | 点击头部折叠/展开内容 |
| PS-002 | 左侧色条 | 不同分类显示对应颜色 |
| PS-003 | 标签添加 | 点击虚线按钮弹出添加对话框 |
| PS-004 | 雷区标签 | 风险等级徽标正确显示 |
| PS-005 | AI推测确认 | 点击确认按钮标签移入正式区 |
| PS-006 | AI推测拒绝 | 点击拒绝按钮标签消失 |
| PS-007 | 全部采纳 | 一键采纳所有AI推测 |

### 6.4 资料库页测试

| 测试ID | 测试场景 | 预期结果 |
|--------|----------|----------|
| DV-001 | 统计卡片 | 数据总量正确显示 |
| DV-002 | 网格布局 | 2列网格正确排列 |
| DV-003 | 状态角标 | 不可用数据源显示灰色角标 |
| DV-004 | 卡片点击 | 已实现数据源可点击进入 |
| DV-005 | 提示区域 | 开发中提示正确显示 |

### 6.5 新建联系人页测试

| 测试ID | 测试场景 | 预期结果 |
|--------|----------|----------|
| CC-001 | 取消按钮 | 返回上一页，不保存数据 |
| CC-002 | 完成按钮 | 验证通过后保存并返回 |
| CC-003 | 姓名验证 | 空姓名时完成按钮禁用 |
| CC-004 | 头像选择 | 点击头像弹出选择器 |
| CC-005 | 添加事实 | 点击按钮跳转到事实添加页 |

---

## 📅 实施计划

### 7.1 开发阶段

| 阶段 | 内容 | 预估时间 | 依赖 |
|------|------|----------|------|
| 阶段1 | 色彩系统和通用组件 | 2小时 | 无 |
| 阶段2 | 概览页重写 | 8小时 | 阶段1 |
| 阶段3 | 事实流页重写 | 6小时 | 阶段1 |
| 阶段4 | 画像库页重写 | 6小时 | 阶段1 |
| 阶段5 | 资料库页重写 | 4小时 | 阶段1 |
| 阶段6 | 新建联系人页重写 | 3小时 | 阶段1 |
| 阶段7 | 集成测试和修复 | 4小时 | 阶段2-6 |

**总计**: 约33小时

### 7.2 新增组件清单

| 组件 | 文件路径 | 优先级 |
|------|----------|--------|
| IOSSegmentedControl | component/ios/ | P0 |
| HealthRingChart | component/chart/ | P0 |
| SparklineChart | component/chart/ | P1 |
| EmotionNode | component/timeline/ | P0 |
| EmotionTimelineView | component/timeline/ | P0 |
| FilterChipRow | component/filter/ | P1 |
| CategoryCard | component/persona/ | P0 |
| MacaronTagChip | component/tag/ | P1 |
| RiskTagItem | component/persona/ | P1 |
| StrategyTagItem | component/persona/ | P1 |
| AiInferenceSection | component/persona/ | P1 |
| DataStatisticsCard | component/vault/ | P1 |
| DataSourceGridCard | component/vault/ | P1 |
| IOSNavigationBar | component/ios/ | P0 |
| AvatarPicker | component/contact/ | P1 |

### 7.3 修改文件清单

| 文件 | 修改类型 | 说明 |
|------|----------|------|
| Color.kt | 新增 | iOS系统色常量 |
| OverviewTab.kt | 重写 | 概览页完全重写 |
| FactStreamTab.kt | 重写 | 事实流页完全重写 |
| PersonaTab.kt | 重写 | 画像库页完全重写 |
| DataVaultTab.kt | 重写 | 资料库页完全重写 |
| CreateContactScreen.kt | 重写 | 新建联系人页重写 |
| ContactDetailTabScreen.kt | 修改 | 集成分段控制器 |

---

## ✅ 验收标准

### 8.1 视觉验收

- [ ] 所有页面背景色统一为`#F2F2F7`或`#F5F5F7`
- [ ] 卡片圆角统一为14dp或16dp
- [ ] 分段控制器样式与设计稿一致
- [ ] 圆环图渐变和动画效果正确
- [ ] 情绪节点颜色与EmotionType对应
- [ ] 马卡龙色标签样式正确
- [ ] 左侧色条颜色与分类对应
- [ ] 状态角标颜色与DataStatus对应

### 8.2 交互验收

- [ ] 分段控制器滑块动画流畅
- [ ] 卡片点击有缩放反馈
- [ ] 淡入动画错落有致
- [ ] 折叠/展开动画平滑
- [ ] 筛选切换响应及时
- [ ] 视图切换无闪烁

### 8.3 功能验收

- [ ] 所有原有功能正常工作
- [ ] 数据正确展示
- [ ] 导航跳转正确
- [ ] 表单验证有效
- [ ] 空状态正确显示

### 8.4 性能验收

- [ ] 页面加载时间 < 500ms
- [ ] 动画帧率 ≥ 60fps
- [ ] 内存占用无明显增加
- [ ] 无ANR或崩溃

---

## ⚡ 性能优化策略

### 10.1 Canvas绑制优化

#### HealthRingChart圆环图优化

```kotlin
@Composable
fun HealthRingChart(
    progress: Float,
    score: Int,
    modifier: Modifier = Modifier
) {
    // 1. 使用remember缓存渐变Brush，避免重复创建
    val gradientBrush = remember {
        Brush.sweepGradient(
            colors = listOf(
                Color(0xFFFF6B9D),
                Color(0xFFFF8A80),
                Color(0xFFFFC371)
            )
        )
    }
    
    // 2. 使用derivedStateOf减少不必要的重组
    val animatedProgress by animateFloatAsState(
        targetValue = progress,
        animationSpec = tween(1000, easing = FastOutSlowInEasing),
        label = "progress"
    )
    
    // 3. 使用drawWithCache缓存绑制结果
    Canvas(
        modifier = modifier
            .size(72.dp)
            .drawWithCache {
                onDrawBehind {
                    // 绘制逻辑
                }
            }
    ) {
        // Canvas绑制代码
    }
}
```

#### SparklineChart趋势图优化

```kotlin
@Composable
fun SparklineChart(
    data: List<Float>,
    modifier: Modifier = Modifier
) {
    // 1. 缓存Path对象，避免每次重组都创建新Path
    val path = remember { Path() }
    
    // 2. 使用remember缓存计算结果
    val normalizedData = remember(data) {
        val max = data.maxOrNull() ?: 1f
        val min = data.minOrNull() ?: 0f
        data.map { (it - min) / (max - min).coerceAtLeast(1f) }
    }
    
    Canvas(modifier = modifier) {
        path.reset()
        // 使用缓存的path绑制
    }
}
```

### 10.2 动画性能优化

#### 分段控制器滑块动画

```kotlin
// 1. 使用animateDpAsState而非animateOffsetAsState，减少计算量
val sliderOffset by animateDpAsState(
    targetValue = (itemWidth * selectedIndex),
    animationSpec = tween(250, easing = FastOutSlowInEasing),
    label = "sliderOffset"
)

// 2. 使用graphicsLayer进行硬件加速
Box(
    modifier = Modifier
        .graphicsLayer {
            translationX = sliderOffset.toPx()
        }
)
```

#### 淡入动画优化

```kotlin
// 1. 使用LaunchedEffect控制动画触发时机
LaunchedEffect(Unit) {
    delay(index * 50L) // 错落延迟
    visible = true
}

// 2. 使用AnimatedVisibility的enter/exit参数
AnimatedVisibility(
    visible = visible,
    enter = fadeIn(animationSpec = tween(400)) + 
            slideInVertically(initialOffsetY = { 10 }),
    exit = fadeOut()
)
```

### 10.3 列表性能优化

#### 时光轴LazyColumn优化

```kotlin
LazyColumn(
    modifier = modifier,
    // 1. 设置contentPadding避免边缘裁剪
    contentPadding = PaddingValues(vertical = 16.dp),
    // 2. 设置verticalArrangement优化间距计算
    verticalArrangement = Arrangement.spacedBy(16.dp)
) {
    items(
        items = timelineItems,
        // 3. 提供稳定的key，优化diff算法
        key = { it.id }
    ) { item ->
        // 4. 使用remember缓存item状态
        val itemState = remember(item) { TimelineItemState(item) }
        TimelineItemCard(state = itemState)
    }
}
```

### 10.4 降级方案

| 场景 | 检测条件 | 降级策略 |
|------|----------|----------|
| 低端设备 | `Build.VERSION.SDK_INT < 26` | 禁用渐变，使用纯色 |
| 动画卡顿 | 帧率 < 30fps | 减少动画时长至100ms |
| 内存不足 | `Runtime.freeMemory() < 50MB` | 禁用Canvas缓存 |
| 列表过长 | items > 100 | 启用分页加载 |

---

## 🌐 国际化支持

### 11.1 字符串资源定义

**新增文件**: `presentation/src/main/res/values/strings_contact_detail.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <!-- 概览页 -->
    <string name="tab_overview">概览</string>
    <string name="tab_fact_stream">事实流</string>
    <string name="tab_persona">标签画像</string>
    <string name="tab_data_vault">资料库</string>
    
    <string name="label_days_known">已相识 %d 天</string>
    <string name="label_relationship_good">关系良好</string>
    <string name="label_relationship_potential">有进一步发展的空间</string>
    <string name="label_trend_up">稳步上升</string>
    <string name="label_core_tags">核心标签</string>
    <string name="label_new_discovery">新发现</string>
    <string name="label_ai_analysis">AI 智能分析</string>
    <string name="label_custom_prompt">为%s设置专属AI分析指令</string>
    <string name="label_ai_learning">AI正在学习中...</string>
    
    <!-- 事实流页 -->
    <string name="view_timeline">时光轴</string>
    <string name="view_list">清单</string>
    <string name="filter_all">全部</string>
    <string name="filter_sweet">甜蜜</string>
    <string name="filter_conflict">冲突</string>
    <string name="filter_date">约会</string>
    <string name="filter_ai_summary">AI总结</string>
    <string name="label_ai_suggestion">AI 建议</string>
    <string name="label_ai_daily_summary">AI 日总结</string>
    <string name="label_score_change">关系分数 %+d</string>
    <string name="label_manual_add">手动添加</string>
    <string name="btn_manual_summary">手动总结</string>
    
    <!-- 画像库页 -->
    <string name="search_tags_hint">搜索标签或分类...</string>
    <string name="category_interests">兴趣爱好</string>
    <string name="category_work">工作信息</string>
    <string name="category_strategy">沟通策略</string>
    <string name="category_risk">雷区标签</string>
    <string name="category_strategy_tags">策略标签</string>
    <string name="label_tag_count">%d个</string>
    <string name="btn_add">添加</string>
    <string name="risk_high">高风险</string>
    <string name="risk_medium">中风险</string>
    <string name="risk_low">低风险</string>
    <string name="label_recommended">推荐</string>
    <string name="label_ai_inference">AI 自动推测</string>
    <string name="btn_accept_all">全部采纳</string>
    <string name="label_inference_source">基于%s推测</string>
    <string name="label_ai_learning_persona">AI 会持续根据对话自动完善画像</string>
    <string name="btn_add_tag">添加标签</string>
    
    <!-- 资料库页 -->
    <string name="title_data_source">数据来源</string>
    <string name="subtitle_data_source">管理与该联系人相关的所有数据</string>
    <string name="label_total_count">数据总量</string>
    <string name="label_count_unit">条</string>
    <string name="data_chat">聊天记录</string>
    <string name="data_chat_desc">对话历史</string>
    <string name="data_summary">AI 总结</string>
    <string name="data_summary_desc">智能分析</string>
    <string name="data_image">图片</string>
    <string name="data_image_desc">媒体文件</string>
    <string name="data_voice">语音消息</string>
    <string name="data_voice_desc">音频记录</string>
    <string name="data_video">视频</string>
    <string name="data_video_desc">视频动态</string>
    <string name="data_file">文件</string>
    <string name="data_file_desc">其他文档</string>
    <string name="hint_media_developing">媒体功能开发中</string>
    <string name="hint_media_developing_desc">图片、语音、视频和文件功能正在开发中，敬请期待。</string>
    <string name="label_status_legend">状态说明</string>
    <string name="status_completed">已完成 - 数据已同步</string>
    <string name="status_processing">处理中 - 正在同步数据</string>
    <string name="status_not_available">不可用 - 功能开发中</string>
    <string name="status_failed">失败 - 同步出错</string>
    
    <!-- 新建联系人页 -->
    <string name="title_new_contact">新建联系人</string>
    <string name="btn_cancel">取消</string>
    <string name="btn_done">完成</string>
    <string name="btn_add_photo">添加照片</string>
    <string name="label_name">姓名</string>
    <string name="hint_name">输入姓名</string>
    <string name="label_goal">沟通目标</string>
    <string name="hint_goal">例如：建立初步信任</string>
    <string name="hint_goal_desc">设定明确的沟通目标有助于 AI 提供更精准的建议。</string>
    <string name="btn_add_fact">添加画像事实</string>
    <string name="hint_add_fact_desc">添加关于此联系人的事实，帮助 AI 更好地理解你们的关系。</string>
</resources>
```

### 11.2 代码中使用字符串资源

```kotlin
// 使用stringResource获取字符串
Text(
    text = stringResource(R.string.tab_overview),
    fontSize = 13.sp
)

// 带参数的字符串
Text(
    text = stringResource(R.string.label_days_known, daysKnown),
    fontSize = 11.sp
)

// 在ViewModel中使用
class ContactDetailViewModel @Inject constructor(
    @ApplicationContext private val context: Context
) {
    fun getTabTitle(tab: DetailTab): String {
        return when (tab) {
            DetailTab.Overview -> context.getString(R.string.tab_overview)
            DetailTab.FactStream -> context.getString(R.string.tab_fact_stream)
            DetailTab.Persona -> context.getString(R.string.tab_persona)
            DetailTab.DataVault -> context.getString(R.string.tab_data_vault)
        }
    }
}
```

### 11.3 国际化注意事项

| 注意事项 | 说明 |
|----------|------|
| 避免字符串拼接 | 使用带参数的字符串资源，如`%s`、`%d` |
| 考虑文本长度 | 不同语言文本长度差异大，UI需要自适应 |
| 日期格式 | 使用`DateFormat.getDateInstance()`获取本地化日期格式 |
| 数字格式 | 使用`NumberFormat.getInstance()`获取本地化数字格式 |
| RTL支持 | 使用`start`/`end`代替`left`/`right` |

---

## ⚠️ 风险与缓解

### 9.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| Canvas绑制复杂度高 | 中 | 中 | 参考FD-00019实现方案 |
| 动画性能问题 | 低 | 中 | 使用remember缓存状态 |
| 回归问题 | 中 | 高 | 分阶段测试，保留旧代码 |

### 9.2 设计风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 设计稿还原度不足 | 中 | 中 | 严格对照HTML设计稿 |
| 交互体验不一致 | 低 | 中 | 统一动画参数 |

---

## 📎 附录

### A. 文件结构

```
presentation/src/main/kotlin/com/empathy/ai/presentation/
├── theme/
│   └── Color.kt                    # 新增iOS系统色
├── ui/
│   ├── component/
│   │   ├── ios/
│   │   │   ├── IOSSegmentedControl.kt
│   │   │   └── IOSNavigationBar.kt
│   │   ├── chart/
│   │   │   ├── HealthRingChart.kt
│   │   │   └── SparklineChart.kt
│   │   ├── timeline/
│   │   │   ├── EmotionNode.kt
│   │   │   └── EmotionTimelineView.kt
│   │   ├── filter/
│   │   │   └── FilterChipRow.kt
│   │   ├── persona/
│   │   │   ├── CategoryCard.kt
│   │   │   ├── RiskTagItem.kt
│   │   │   ├── StrategyTagItem.kt
│   │   │   └── AiInferenceSection.kt
│   │   ├── tag/
│   │   │   └── MacaronTagChip.kt
│   │   ├── vault/
│   │   │   ├── DataStatisticsCard.kt
│   │   │   └── DataSourceGridCard.kt
│   │   └── contact/
│   │       └── AvatarPicker.kt
│   └── screen/
│       └── contact/
│           ├── overview/
│           │   └── OverviewTab.kt      # 重写
│           ├── factstream/
│           │   └── FactStreamTab.kt    # 重写
│           ├── persona/
│           │   └── PersonaTab.kt       # 重写
│           ├── vault/
│           │   └── DataVaultTab.kt     # 重写
│           └── CreateContactScreen.kt  # 重写
```

### B. 设计稿引用

| 页面 | 设计稿 | 关键行号 |
|------|--------|----------|
| 概览页 | 概览页.html | 58-78(分段控制器), 83-108(个人信息), 111-165(圆环图) |
| 事实流页 | 事实流页.html | 100-200(时光轴), 350-450(清单视图) |
| 画像库页 | 画像库页.html | 80-130(分类卡片), 150-220(雷区标签) |
| 资料库页 | 资料库页.html | 45-65(统计卡片), 70-150(数据网格) |
| 新建联系人页 | 新建联系人页.html | 20-25(导航栏), 30-45(头像), 50-75(表单) |

---

**文档版本**: 1.1
**创建日期**: 2025-12-25
**最后更新**: 2025-12-25
**负责人**: Kiro
**审核人**: PE (产品经理)
**审查报告**: CR-00020

