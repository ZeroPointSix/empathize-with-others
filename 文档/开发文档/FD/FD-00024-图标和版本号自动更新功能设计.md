# FD-00024: å›¾æ ‡å’Œç‰ˆæœ¬å·è‡ªåŠ¨æ›´æ–°åŠŸèƒ½è®¾è®¡

> **æ–‡æ¡£ç±»å‹**: åŠŸèƒ½è®¾è®¡æ–‡æ¡£ (FD)
> **ç‰ˆæœ¬**: 1.1
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-31
> **æœ€åæ›´æ–°**: 2025-12-31
> **è´Ÿè´£äºº**: Kiro
> **çŠ¶æ€**: âœ… å®¡æŸ¥é€šè¿‡
> **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­
> **å…³è”PRD**: PRD-00024
> **å…³è”TDD**: TDD-00024ï¼ˆå¾…åˆ›å»ºï¼‰
> **å…³è”TD**: TD-00024ï¼ˆå¾…åˆ›å»ºï¼‰

---

## ğŸ“œ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-31 | Kiro | åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«ç‰ˆæœ¬å·è‡ªåŠ¨æ›´æ–°å’Œå›¾æ ‡åˆ‡æ¢åŠŸèƒ½è®¾è®¡ |
| 1.1 | 2025-12-31 | Kiro | æ ¹æ®DR-00024å®¡æŸ¥æŠ¥å‘Šä¿®æ”¹ï¼šæ–°å¢ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ(ç¬¬12ç« )ã€é£é™©è¯„ä¼°(ç¬¬13ç« )ã€åŠŸèƒ½é›†æˆè®¾è®¡(ç¬¬14ç« )ï¼›å®Œå–„æµ‹è¯•ç­–ç•¥ï¼Œæ·»åŠ æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡(â‰¥80%)ã€æ€§èƒ½åŸºå‡†æµ‹è¯•æ–¹æ¡ˆã€å¤šå¹³å°å…¼å®¹æ€§æµ‹è¯•æ–¹æ³• |

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°å›¾æ ‡å’Œç‰ˆæœ¬å·è‡ªåŠ¨æ›´æ–°åŠŸèƒ½çš„æŠ€æœ¯æ¶æ„ã€ç»„ä»¶è®¾è®¡ã€æ•°æ®æµå’Œå®ç°ç»†èŠ‚ã€‚

**è®¾è®¡ç›®æ ‡**ï¼š
- å®ç°åŸºäºGradleä»»åŠ¡çš„ç‰ˆæœ¬å·è‡ªåŠ¨é€’å¢
- æ”¯æŒæ ¹æ®å‘å¸ƒé˜¶æ®µè‡ªåŠ¨åˆ‡æ¢åº”ç”¨å›¾æ ‡
- åŸºäºGitæäº¤ä¿¡æ¯è‡ªåŠ¨è¯†åˆ«ç‰ˆæœ¬å˜æ›´ç±»å‹
- ç¡®ä¿å¤šæ¨¡å—æ¶æ„ä¸‹ç‰ˆæœ¬å·çš„ä¸€è‡´æ€§
- æä¾›å®Œå–„çš„å¤‡ä»½å’Œå›æ»šæœºåˆ¶

**ä¾èµ–å·¥å…·ç‰ˆæœ¬**ï¼š
- Gradle: 8.13
- AGP: 8.7.3
- Kotlin: 2.0.21
- Git: 2.30+
- JDK: 17

---

## ğŸ“‘ ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [ç‰ˆæœ¬å·ç®¡ç†è®¾è®¡](#ç‰ˆæœ¬å·ç®¡ç†è®¾è®¡)
3. [å›¾æ ‡ç®¡ç†è®¾è®¡](#å›¾æ ‡ç®¡ç†è®¾è®¡)
4. [Gradleä»»åŠ¡è®¾è®¡](#gradleä»»åŠ¡è®¾è®¡)
5. [é…ç½®æ–‡ä»¶è®¾è®¡](#é…ç½®æ–‡ä»¶è®¾è®¡)
6. [å¤šæ¨¡å—åè°ƒæœºåˆ¶](#å¤šæ¨¡å—åè°ƒæœºåˆ¶)
7. [å¤‡ä»½ä¸å›æ»šæœºåˆ¶](#å¤‡ä»½ä¸å›æ»šæœºåˆ¶)
8. [é”™è¯¯å¤„ç†æœºåˆ¶](#é”™è¯¯å¤„ç†æœºåˆ¶)
9. [CI/CDé›†æˆè®¾è®¡](#cicdé›†æˆè®¾è®¡)
10. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
11. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
12. [ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ](#ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ)
13. [é£é™©è¯„ä¼°](#é£é™©è¯„ä¼°)
14. [åŠŸèƒ½é›†æˆè®¾è®¡](#åŠŸèƒ½é›†æˆè®¾è®¡)


---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç‰ˆæœ¬æ›´æ–°ç³»ç»Ÿæ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Gitä»“åº“   â”‚â”€â”€â”€â–¶â”‚  æäº¤åˆ†æå™¨  â”‚â”€â”€â”€â–¶â”‚  ç‰ˆæœ¬è®¡ç®—å™¨  â”‚         â”‚
â”‚  â”‚  Commits    â”‚    â”‚ CommitParserâ”‚    â”‚VersionCalc â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                               â”‚                 â”‚
â”‚                                               â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  é…ç½®æ–‡ä»¶   â”‚â—€â”€â”€â”€â”‚  ç‰ˆæœ¬æ›´æ–°å™¨  â”‚â—€â”€â”€â”€â”‚  å‘å¸ƒé˜¶æ®µ   â”‚         â”‚
â”‚  â”‚ build.gradleâ”‚    â”‚VersionUpdateâ”‚    â”‚ ReleaseStageâ”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                            â”‚                                    â”‚
â”‚                            â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  å›¾æ ‡èµ„æº   â”‚â—€â”€â”€â”€â”‚  å›¾æ ‡åˆ‡æ¢å™¨  â”‚â”€â”€â”€â–¶â”‚  å¤‡ä»½ç®¡ç†å™¨  â”‚         â”‚
â”‚  â”‚ mipmap-*    â”‚    â”‚ IconSwitcherâ”‚    â”‚ BackupMgr  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—èŒè´£åˆ†é…

| æ¨¡å— | èŒè´£ | è¾“å…¥ | è¾“å‡º |
|------|------|------|------|
| CommitParser | è§£æGitæäº¤ä¿¡æ¯ | Git log | å˜æ›´ç±»å‹åˆ—è¡¨ |
| VersionCalculator | è®¡ç®—æ–°ç‰ˆæœ¬å· | å½“å‰ç‰ˆæœ¬+å˜æ›´ç±»å‹ | æ–°ç‰ˆæœ¬å· |
| VersionUpdater | æ›´æ–°ç‰ˆæœ¬é…ç½® | æ–°ç‰ˆæœ¬å· | æ›´æ–°åçš„é…ç½®æ–‡ä»¶ |
| IconSwitcher | åˆ‡æ¢åº”ç”¨å›¾æ ‡ | å‘å¸ƒé˜¶æ®µ | æ›´æ–°åçš„å›¾æ ‡èµ„æº |
| BackupManager | ç®¡ç†å¤‡ä»½å’Œå›æ»š | åŸå§‹æ–‡ä»¶ | å¤‡ä»½æ–‡ä»¶ |

### æ–‡ä»¶ç»“æ„è®¾è®¡

```
project/
â”œâ”€â”€ buildSrc/                           # ğŸ†• Gradleæ„å»ºé€»è¾‘
â”‚   â”œâ”€â”€ build.gradle.kts
â”‚   â””â”€â”€ src/main/kotlin/
â”‚       â””â”€â”€ com/empathy/ai/build/
â”‚           â”œâ”€â”€ VersionManager.kt       # ç‰ˆæœ¬ç®¡ç†æ ¸å¿ƒç±»
â”‚           â”œâ”€â”€ CommitParser.kt         # Gitæäº¤è§£æå™¨
â”‚           â”œâ”€â”€ IconManager.kt          # å›¾æ ‡ç®¡ç†å™¨
â”‚           â”œâ”€â”€ BackupManager.kt        # å¤‡ä»½ç®¡ç†å™¨
â”‚           â””â”€â”€ ReleaseStage.kt         # å‘å¸ƒé˜¶æ®µæšä¸¾
â”œâ”€â”€ config/                             # ğŸ†• é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ version-config.json             # ç‰ˆæœ¬é…ç½®
â”‚   â””â”€â”€ icon-mapping.json               # å›¾æ ‡æ˜ å°„é…ç½®
â”œâ”€â”€ assets/                             # ğŸ†• å›¾æ ‡èµ„æºç›®å½•
â”‚   â””â”€â”€ icons/
â”‚       â”œâ”€â”€ dev/                        # å¼€å‘ç‰ˆå›¾æ ‡
â”‚       â”œâ”€â”€ test/                       # æµ‹è¯•ç‰ˆå›¾æ ‡
â”‚       â”œâ”€â”€ beta/                       # é¢„å‘å¸ƒç‰ˆå›¾æ ‡
â”‚       â””â”€â”€ production/                 # æ­£å¼ç‰ˆå›¾æ ‡
â”œâ”€â”€ backups/                            # ğŸ†• å¤‡ä»½ç›®å½•
â”‚   â””â”€â”€ version-update/
â””â”€â”€ app/
    â”œâ”€â”€ build.gradle.kts                # åº”ç”¨ç‰ˆæœ¬å·å®šä¹‰
    â””â”€â”€ src/main/res/
        â””â”€â”€ mipmap-*/                   # åº”ç”¨å›¾æ ‡
```


---

## ğŸ”¢ ç‰ˆæœ¬å·ç®¡ç†è®¾è®¡

### 1. è¯­ä¹‰åŒ–ç‰ˆæœ¬è§„åˆ™

é‡‡ç”¨ [Semantic Versioning 2.0.0](https://semver.org/) è§„èŒƒï¼š

```
major.minor.patch[-prerelease][+build]
ä¾‹å¦‚: 1.2.3-beta.1+20251231
```

| ç‰ˆæœ¬æ®µ | å«ä¹‰ | é€’å¢æ¡ä»¶ |
|--------|------|----------|
| major | ä¸»ç‰ˆæœ¬å· | ä¸å…¼å®¹çš„APIä¿®æ”¹ã€é‡å¤§æ¶æ„å˜æ›´ |
| minor | æ¬¡ç‰ˆæœ¬å· | å‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢ |
| patch | ä¿®è®¢å· | å‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£ |
| prerelease | é¢„å‘å¸ƒæ ‡è¯† | dev/alpha/beta/rc |
| build | æ„å»ºå…ƒæ•°æ® | æ—¶é—´æˆ³æˆ–Git SHA |

### 2. Gitæäº¤ä¿¡æ¯è§£æè§„åˆ™

åŸºäº [Conventional Commits](https://www.conventionalcommits.org/) è§„èŒƒï¼š

```kotlin
/**
 * æäº¤ç±»å‹ä¸ç‰ˆæœ¬å˜æ›´æ˜ å°„
 */
enum class CommitType(
    val prefix: String,
    val versionBump: VersionBump,
    val description: String
) {
    // Majorç‰ˆæœ¬é€’å¢
    BREAKING_CHANGE("feat!", VersionBump.MAJOR, "ç ´åæ€§å˜æ›´"),
    BREAKING_FIX("fix!", VersionBump.MAJOR, "ç ´åæ€§ä¿®å¤"),
    
    // Minorç‰ˆæœ¬é€’å¢
    FEATURE("feat", VersionBump.MINOR, "æ–°åŠŸèƒ½"),
    
    // Patchç‰ˆæœ¬é€’å¢
    FIX("fix", VersionBump.PATCH, "Bugä¿®å¤"),
    PERF("perf", VersionBump.PATCH, "æ€§èƒ½ä¼˜åŒ–"),
    
    // ä¸å½±å“ç‰ˆæœ¬å·
    DOCS("docs", VersionBump.NONE, "æ–‡æ¡£æ›´æ–°"),
    STYLE("style", VersionBump.NONE, "ä»£ç æ ¼å¼"),
    REFACTOR("refactor", VersionBump.NONE, "ä»£ç é‡æ„"),
    TEST("test", VersionBump.NONE, "æµ‹è¯•ç›¸å…³"),
    CHORE("chore", VersionBump.NONE, "æ„å»º/å·¥å…·"),
    CI("ci", VersionBump.NONE, "CIé…ç½®");
}

enum class VersionBump {
    MAJOR, MINOR, PATCH, NONE
}
```

### 3. ç‰ˆæœ¬è®¡ç®—é€»è¾‘

```kotlin
/**
 * ç‰ˆæœ¬è®¡ç®—å™¨
 * æ ¹æ®Gitæäº¤å†å²è®¡ç®—æ–°ç‰ˆæœ¬å·
 */
class VersionCalculator {
    
    /**
     * è®¡ç®—æ–°ç‰ˆæœ¬å·
     * @param currentVersion å½“å‰ç‰ˆæœ¬
     * @param commits è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„æäº¤åˆ—è¡¨
     * @return æ–°ç‰ˆæœ¬å·
     */
    fun calculateNextVersion(
        currentVersion: SemanticVersion,
        commits: List<ParsedCommit>
    ): SemanticVersion {
        // ç¡®å®šæœ€é«˜ä¼˜å…ˆçº§çš„ç‰ˆæœ¬å˜æ›´ç±»å‹
        val highestBump = commits
            .map { it.type.versionBump }
            .maxByOrNull { it.ordinal }
            ?: VersionBump.NONE
        
        return when (highestBump) {
            VersionBump.MAJOR -> currentVersion.bumpMajor()
            VersionBump.MINOR -> currentVersion.bumpMinor()
            VersionBump.PATCH -> currentVersion.bumpPatch()
            VersionBump.NONE -> currentVersion
        }
    }
}

/**
 * è¯­ä¹‰åŒ–ç‰ˆæœ¬æ•°æ®ç±»
 */
data class SemanticVersion(
    val major: Int,
    val minor: Int,
    val patch: Int,
    val prerelease: String? = null,
    val build: String? = null
) {
    fun bumpMajor() = copy(major = major + 1, minor = 0, patch = 0)
    fun bumpMinor() = copy(minor = minor + 1, patch = 0)
    fun bumpPatch() = copy(patch = patch + 1)
    
    override fun toString(): String {
        val base = "$major.$minor.$patch"
        val pre = prerelease?.let { "-$it" } ?: ""
        val bld = build?.let { "+$it" } ?: ""
        return "$base$pre$bld"
    }
    
    companion object {
        fun parse(version: String): SemanticVersion {
            val regex = """(\d+)\.(\d+)\.(\d+)(?:-([^+]+))?(?:\+(.+))?""".toRegex()
            val match = regex.matchEntire(version)
                ?: throw IllegalArgumentException("Invalid version: $version")
            
            return SemanticVersion(
                major = match.groupValues[1].toInt(),
                minor = match.groupValues[2].toInt(),
                patch = match.groupValues[3].toInt(),
                prerelease = match.groupValues[4].takeIf { it.isNotEmpty() },
                build = match.groupValues[5].takeIf { it.isNotEmpty() }
            )
        }
    }
}
```

### 4. ç‰ˆæœ¬å·å­˜å‚¨ä½ç½®

**ä¸»ç‰ˆæœ¬å®šä¹‰ä½ç½®**ï¼š`app/build.gradle.kts`

```kotlin
android {
    defaultConfig {
        versionCode = 10203  // è®¡ç®—å…¬å¼: major*10000 + minor*100 + patch
        versionName = "1.2.3"
    }
}
```

**ç‰ˆæœ¬å†å²è®°å½•**ï¼š`config/version-history.json`

```json
{
  "currentVersion": "1.2.3",
  "versionCode": 10203,
  "lastUpdated": "2025-12-31T10:00:00Z",
  "history": [
    {
      "version": "1.2.3",
      "versionCode": 10203,
      "date": "2025-12-31T10:00:00Z",
      "stage": "production",
      "commits": ["abc1234", "def5678"]
    }
  ]
}
```


---

## ğŸ¨ å›¾æ ‡ç®¡ç†è®¾è®¡

### 1. å‘å¸ƒé˜¶æ®µå®šä¹‰

```kotlin
/**
 * å‘å¸ƒé˜¶æ®µæšä¸¾
 */
enum class ReleaseStage(
    val displayName: String,
    val iconSuffix: String,
    val badgeText: String?,
    val badgeColor: String
) {
    DEV(
        displayName = "å¼€å‘ç‰ˆ",
        iconSuffix = "dev",
        badgeText = "DEV",
        badgeColor = "#FF9800"  // æ©™è‰²
    ),
    TEST(
        displayName = "æµ‹è¯•ç‰ˆ",
        iconSuffix = "test",
        badgeText = "TEST",
        badgeColor = "#2196F3"  // è“è‰²
    ),
    BETA(
        displayName = "é¢„å‘å¸ƒç‰ˆ",
        iconSuffix = "beta",
        badgeText = "BETA",
        badgeColor = "#9C27B0"  // ç´«è‰²
    ),
    PRODUCTION(
        displayName = "æ­£å¼ç‰ˆ",
        iconSuffix = "production",
        badgeText = null,       // æ­£å¼ç‰ˆæ— æ ‡è¯†
        badgeColor = "#4CAF50"  // ç»¿è‰²
    );
    
    companion object {
        fun fromString(value: String): ReleaseStage {
            return entries.find { 
                it.name.equals(value, ignoreCase = true) ||
                it.iconSuffix.equals(value, ignoreCase = true)
            } ?: PRODUCTION
        }
    }
}
```

### 2. å›¾æ ‡èµ„æºç»“æ„

```
assets/icons/
â”œâ”€â”€ dev/                          # å¼€å‘ç‰ˆå›¾æ ‡ï¼ˆå¸¦DEVæ ‡è¯†ï¼‰
â”‚   â”œâ”€â”€ ic_launcher.png           # åŸºç¡€å›¾æ ‡
â”‚   â”œâ”€â”€ ic_launcher_round.png     # åœ†å½¢å›¾æ ‡
â”‚   â””â”€â”€ ic_launcher_foreground.png # è‡ªé€‚åº”å›¾æ ‡å‰æ™¯
â”œâ”€â”€ test/                         # æµ‹è¯•ç‰ˆå›¾æ ‡ï¼ˆå¸¦TESTæ ‡è¯†ï¼‰
â”‚   â”œâ”€â”€ ic_launcher.png
â”‚   â”œâ”€â”€ ic_launcher_round.png
â”‚   â””â”€â”€ ic_launcher_foreground.png
â”œâ”€â”€ beta/                         # é¢„å‘å¸ƒç‰ˆå›¾æ ‡ï¼ˆå¸¦BETAæ ‡è¯†ï¼‰
â”‚   â”œâ”€â”€ ic_launcher.png
â”‚   â”œâ”€â”€ ic_launcher_round.png
â”‚   â””â”€â”€ ic_launcher_foreground.png
â””â”€â”€ production/                   # æ­£å¼ç‰ˆå›¾æ ‡ï¼ˆæ— æ ‡è¯†ï¼‰
    â”œâ”€â”€ ic_launcher.png
    â”œâ”€â”€ ic_launcher_round.png
    â””â”€â”€ ic_launcher_foreground.png
```

### 3. å›¾æ ‡æ˜ å°„é…ç½®

**é…ç½®æ–‡ä»¶**ï¼š`config/icon-mapping.json`

```json
{
  "version": 1,
  "defaultStage": "production",
  "iconSets": {
    "dev": {
      "sourceDir": "assets/icons/dev",
      "targetDirs": [
        "app/src/main/res/mipmap-mdpi",
        "app/src/main/res/mipmap-hdpi",
        "app/src/main/res/mipmap-xhdpi",
        "app/src/main/res/mipmap-xxhdpi",
        "app/src/main/res/mipmap-xxxhdpi"
      ],
      "files": [
        {"source": "ic_launcher.png", "target": "ic_launcher.png"},
        {"source": "ic_launcher_round.png", "target": "ic_launcher_round.png"}
      ]
    },
    "test": {
      "sourceDir": "assets/icons/test",
      "targetDirs": ["...åŒä¸Š..."],
      "files": ["...åŒä¸Š..."]
    },
    "beta": {
      "sourceDir": "assets/icons/beta",
      "targetDirs": ["...åŒä¸Š..."],
      "files": ["...åŒä¸Š..."]
    },
    "production": {
      "sourceDir": "assets/icons/production",
      "targetDirs": ["...åŒä¸Š..."],
      "files": ["...åŒä¸Š..."]
    }
  },
  "adaptiveIcon": {
    "foregroundFile": "ic_launcher_foreground.png",
    "backgroundFile": "ic_launcher_background.png",
    "targetDir": "app/src/main/res/drawable-v26"
  }
}
```

### 4. å›¾æ ‡åˆ‡æ¢å™¨å®ç°

```kotlin
/**
 * å›¾æ ‡ç®¡ç†å™¨
 * è´Ÿè´£æ ¹æ®å‘å¸ƒé˜¶æ®µåˆ‡æ¢åº”ç”¨å›¾æ ‡
 */
class IconManager(
    private val projectDir: File,
    private val backupManager: BackupManager
) {
    private val iconMapping: IconMapping by lazy {
        loadIconMapping()
    }
    
    /**
     * åˆ‡æ¢åˆ°æŒ‡å®šå‘å¸ƒé˜¶æ®µçš„å›¾æ ‡
     * @param stage ç›®æ ‡å‘å¸ƒé˜¶æ®µ
     * @return åˆ‡æ¢ç»“æœ
     */
    fun switchToStage(stage: ReleaseStage): Result<IconSwitchResult> {
        return try {
            // 1. å¤‡ä»½å½“å‰å›¾æ ‡
            backupManager.backupIcons()
            
            // 2. è·å–å›¾æ ‡é…ç½®
            val iconSet = iconMapping.iconSets[stage.iconSuffix]
                ?: return Result.failure(Exception("æœªæ‰¾åˆ°${stage.displayName}çš„å›¾æ ‡é…ç½®"))
            
            // 3. å¤åˆ¶å›¾æ ‡æ–‡ä»¶
            val copiedFiles = mutableListOf<String>()
            iconSet.targetDirs.forEach { targetDir ->
                iconSet.files.forEach { fileMapping ->
                    val source = File(projectDir, "${iconSet.sourceDir}/${fileMapping.source}")
                    val target = File(projectDir, "$targetDir/${fileMapping.target}")
                    
                    if (!source.exists()) {
                        return Result.failure(Exception("æºå›¾æ ‡æ–‡ä»¶ä¸å­˜åœ¨: ${source.path}"))
                    }
                    
                    source.copyTo(target, overwrite = true)
                    copiedFiles.add(target.path)
                }
            }
            
            // 4. æ›´æ–°è‡ªé€‚åº”å›¾æ ‡ï¼ˆAndroid 8.0+ï¼‰
            updateAdaptiveIcon(stage)
            
            Result.success(IconSwitchResult(
                stage = stage,
                copiedFiles = copiedFiles,
                timestamp = System.currentTimeMillis()
            ))
        } catch (e: Exception) {
            // å›æ»š
            backupManager.restoreIcons()
            Result.failure(e)
        }
    }
    
    private fun updateAdaptiveIcon(stage: ReleaseStage) {
        val adaptiveConfig = iconMapping.adaptiveIcon
        val sourceDir = File(projectDir, "assets/icons/${stage.iconSuffix}")
        val targetDir = File(projectDir, adaptiveConfig.targetDir)
        
        // å¤åˆ¶å‰æ™¯å›¾
        File(sourceDir, adaptiveConfig.foregroundFile)
            .copyTo(File(targetDir, adaptiveConfig.foregroundFile), overwrite = true)
    }
}

data class IconSwitchResult(
    val stage: ReleaseStage,
    val copiedFiles: List<String>,
    val timestamp: Long
)
```


---

## âš™ï¸ Gradleä»»åŠ¡è®¾è®¡

### 1. ä»»åŠ¡å±‚æ¬¡ç»“æ„

```
updateVersionAndIcon (ä¸»ä»»åŠ¡)
â”œâ”€â”€ analyzeCommits        # åˆ†æGitæäº¤
â”œâ”€â”€ calculateVersion      # è®¡ç®—æ–°ç‰ˆæœ¬å·
â”œâ”€â”€ backupFiles          # å¤‡ä»½åŸå§‹æ–‡ä»¶
â”œâ”€â”€ updateVersion        # æ›´æ–°ç‰ˆæœ¬å·
â”œâ”€â”€ updateIcon           # æ›´æ–°å›¾æ ‡
â”œâ”€â”€ updateVersionHistory # æ›´æ–°ç‰ˆæœ¬å†å²
â””â”€â”€ verifyUpdate         # éªŒè¯æ›´æ–°ç»“æœ
```

### 2. ä¸»ä»»åŠ¡å®šä¹‰

**æ–‡ä»¶ä½ç½®**ï¼š`buildSrc/src/main/kotlin/VersionUpdatePlugin.kt`

```kotlin
/**
 * ç‰ˆæœ¬æ›´æ–°Gradleæ’ä»¶
 */
class VersionUpdatePlugin : Plugin<Project> {
    override fun apply(project: Project) {
        // æ³¨å†Œæ‰©å±•é…ç½®
        val extension = project.extensions.create(
            "versionUpdate",
            VersionUpdateExtension::class.java
        )
        
        // æ³¨å†Œä¸»ä»»åŠ¡
        project.tasks.register("updateVersionAndIcon", UpdateVersionAndIconTask::class.java) {
            group = "release"
            description = "æ›´æ–°ç‰ˆæœ¬å·å’Œåº”ç”¨å›¾æ ‡"
            
            // é…ç½®ä»»åŠ¡å±æ€§
            stage.set(extension.stage)
            force.set(extension.force)
            dryRun.set(extension.dryRun)
        }
        
        // æ³¨å†Œå­ä»»åŠ¡
        registerSubTasks(project, extension)
    }
    
    private fun registerSubTasks(project: Project, extension: VersionUpdateExtension) {
        project.tasks.register("updateVersion", UpdateVersionTask::class.java) {
            group = "release"
            description = "ä»…æ›´æ–°ç‰ˆæœ¬å·"
        }
        
        project.tasks.register("updateIcon", UpdateIconTask::class.java) {
            group = "release"
            description = "ä»…æ›´æ–°åº”ç”¨å›¾æ ‡"
            stage.set(extension.stage)
        }
        
        project.tasks.register("analyzeCommits", AnalyzeCommitsTask::class.java) {
            group = "release"
            description = "åˆ†æGitæäº¤ä¿¡æ¯"
        }
    }
}

/**
 * æ’ä»¶æ‰©å±•é…ç½®
 */
open class VersionUpdateExtension {
    var stage: Property<String> = ObjectFactory.property(String::class.java)
        .convention("production")
    var force: Property<Boolean> = ObjectFactory.property(Boolean::class.java)
        .convention(false)
    var dryRun: Property<Boolean> = ObjectFactory.property(Boolean::class.java)
        .convention(false)
}
```

### 3. ä¸»ä»»åŠ¡å®ç°

```kotlin
/**
 * ç‰ˆæœ¬å’Œå›¾æ ‡æ›´æ–°ä¸»ä»»åŠ¡
 */
abstract class UpdateVersionAndIconTask : DefaultTask() {
    
    @get:Input
    abstract val stage: Property<String>
    
    @get:Input
    abstract val force: Property<Boolean>
    
    @get:Input
    abstract val dryRun: Property<Boolean>
    
    @get:Inject
    abstract val execOperations: ExecOperations
    
    private val versionManager = VersionManager(project.rootDir)
    private val iconManager = IconManager(project.rootDir, BackupManager(project.rootDir))
    private val commitParser = CommitParser(project.rootDir)
    
    @TaskAction
    fun execute() {
        val releaseStage = ReleaseStage.fromString(stage.get())
        
        logger.lifecycle("========================================")
        logger.lifecycle("å¼€å§‹ç‰ˆæœ¬æ›´æ–°æµç¨‹")
        logger.lifecycle("å‘å¸ƒé˜¶æ®µ: ${releaseStage.displayName}")
        logger.lifecycle("å¼ºåˆ¶æ›´æ–°: ${force.get()}")
        logger.lifecycle("é¢„æ¼”æ¨¡å¼: ${dryRun.get()}")
        logger.lifecycle("========================================")
        
        // 1. åˆ†æGitæäº¤
        logger.lifecycle("\n[1/6] åˆ†æGitæäº¤...")
        val commits = commitParser.parseCommitsSinceLastTag()
        logger.lifecycle("å‘ç° ${commits.size} ä¸ªæ–°æäº¤")
        commits.forEach { commit ->
            logger.lifecycle("  - ${commit.type.prefix}: ${commit.subject}")
        }
        
        // 2. è®¡ç®—æ–°ç‰ˆæœ¬å·
        logger.lifecycle("\n[2/6] è®¡ç®—æ–°ç‰ˆæœ¬å·...")
        val currentVersion = versionManager.getCurrentVersion()
        val calculator = VersionCalculator()
        val newVersion = calculator.calculateNextVersion(currentVersion, commits)
        logger.lifecycle("å½“å‰ç‰ˆæœ¬: $currentVersion")
        logger.lifecycle("æ–°ç‰ˆæœ¬: $newVersion")
        
        if (currentVersion == newVersion && !force.get()) {
            logger.lifecycle("\nç‰ˆæœ¬å·æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°")
            return
        }
        
        // é¢„æ¼”æ¨¡å¼æ£€æŸ¥
        if (dryRun.get()) {
            logger.lifecycle("\n[é¢„æ¼”æ¨¡å¼] å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œ:")
            logger.lifecycle("  - æ›´æ–°ç‰ˆæœ¬å·: $currentVersion -> $newVersion")
            logger.lifecycle("  - åˆ‡æ¢å›¾æ ‡: ${releaseStage.displayName}")
            logger.lifecycle("\né¢„æ¼”å®Œæˆï¼Œæœªæ‰§è¡Œå®é™…æ“ä½œ")
            return
        }
        
        // 3. å¤‡ä»½æ–‡ä»¶
        logger.lifecycle("\n[3/6] å¤‡ä»½åŸå§‹æ–‡ä»¶...")
        val backupManager = BackupManager(project.rootDir)
        val backupResult = backupManager.createBackup()
        logger.lifecycle("å¤‡ä»½å®Œæˆ: ${backupResult.backupPath}")
        
        try {
            // 4. æ›´æ–°ç‰ˆæœ¬å·
            logger.lifecycle("\n[4/6] æ›´æ–°ç‰ˆæœ¬å·...")
            versionManager.updateVersion(newVersion, releaseStage)
            logger.lifecycle("ç‰ˆæœ¬å·æ›´æ–°å®Œæˆ")
            
            // 5. æ›´æ–°å›¾æ ‡
            logger.lifecycle("\n[5/6] æ›´æ–°åº”ç”¨å›¾æ ‡...")
            val iconResult = iconManager.switchToStage(releaseStage)
            iconResult.onSuccess { result ->
                logger.lifecycle("å›¾æ ‡æ›´æ–°å®Œæˆï¼Œå¤åˆ¶äº† ${result.copiedFiles.size} ä¸ªæ–‡ä»¶")
            }.onFailure { error ->
                throw error
            }
            
            // 6. æ›´æ–°ç‰ˆæœ¬å†å²
            logger.lifecycle("\n[6/6] æ›´æ–°ç‰ˆæœ¬å†å²...")
            versionManager.updateVersionHistory(newVersion, releaseStage, commits)
            logger.lifecycle("ç‰ˆæœ¬å†å²æ›´æ–°å®Œæˆ")
            
            logger.lifecycle("\n========================================")
            logger.lifecycle("âœ… ç‰ˆæœ¬æ›´æ–°å®Œæˆ!")
            logger.lifecycle("æ–°ç‰ˆæœ¬: $newVersion")
            logger.lifecycle("å‘å¸ƒé˜¶æ®µ: ${releaseStage.displayName}")
            logger.lifecycle("========================================")
            
        } catch (e: Exception) {
            logger.error("\nâŒ æ›´æ–°å¤±è´¥: ${e.message}")
            logger.lifecycle("æ­£åœ¨å›æ»š...")
            backupManager.restore(backupResult)
            logger.lifecycle("å›æ»šå®Œæˆ")
            throw e
        }
    }
}
```

### 4. å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ

```bash
# åŸºæœ¬ç”¨æ³•
./gradlew updateVersionAndIcon

# æŒ‡å®šå‘å¸ƒé˜¶æ®µ
./gradlew updateVersionAndIcon --stage=beta

# å¼ºåˆ¶æ›´æ–°ï¼ˆå³ä½¿ç‰ˆæœ¬å·æ— å˜åŒ–ï¼‰
./gradlew updateVersionAndIcon --force

# é¢„æ¼”æ¨¡å¼ï¼ˆåªæ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„æ“ä½œï¼‰
./gradlew updateVersionAndIcon --dry-run

# ç»„åˆä½¿ç”¨
./gradlew updateVersionAndIcon --stage=production --force

# ä»…æ›´æ–°ç‰ˆæœ¬å·
./gradlew updateVersion

# ä»…æ›´æ–°å›¾æ ‡
./gradlew updateIcon --stage=dev

# åˆ†ææäº¤ä¿¡æ¯
./gradlew analyzeCommits
```


---

## ğŸ“ é…ç½®æ–‡ä»¶è®¾è®¡

### 1. ç‰ˆæœ¬é…ç½®æ–‡ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`config/version-config.json`

```json
{
  "version": 1,
  "settings": {
    "versionFormat": "semantic",
    "versionCodeFormula": "major*10000 + minor*100 + patch",
    "prereleaseFormat": "{stage}.{buildNumber}",
    "buildMetadataFormat": "{timestamp}"
  },
  "commitParsing": {
    "conventionalCommits": true,
    "breakingChangeIndicators": ["!", "BREAKING CHANGE:"],
    "typeMapping": {
      "feat": "minor",
      "fix": "patch",
      "perf": "patch",
      "docs": "none",
      "style": "none",
      "refactor": "none",
      "test": "none",
      "chore": "none",
      "ci": "none"
    }
  },
  "gitSettings": {
    "tagPrefix": "v",
    "tagFormat": "v{version}",
    "commitMessageFormat": "chore(release): {version}"
  },
  "validation": {
    "requireCleanWorkingTree": true,
    "requireMainBranch": false,
    "allowedBranches": ["main", "master", "develop", "release/*"]
  }
}
```

### 2. ç‰ˆæœ¬å†å²æ–‡ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`config/version-history.json`

```json
{
  "schemaVersion": 1,
  "currentVersion": {
    "version": "1.2.3",
    "versionCode": 10203,
    "stage": "production",
    "updatedAt": "2025-12-31T10:00:00Z",
    "updatedBy": "gradle-task"
  },
  "history": [
    {
      "version": "1.2.3",
      "versionCode": 10203,
      "stage": "production",
      "date": "2025-12-31T10:00:00Z",
      "commits": [
        {
          "sha": "abc1234",
          "type": "feat",
          "subject": "æ·»åŠ æ–°åŠŸèƒ½"
        }
      ],
      "changelog": "- æ·»åŠ æ–°åŠŸèƒ½\n- ä¿®å¤è‹¥å¹²é—®é¢˜"
    },
    {
      "version": "1.2.2",
      "versionCode": 10202,
      "stage": "production",
      "date": "2025-12-30T10:00:00Z",
      "commits": [],
      "changelog": ""
    }
  ]
}
```

### 3. å˜æ›´æ—¥å¿—ç”Ÿæˆ

```kotlin
/**
 * å˜æ›´æ—¥å¿—ç”Ÿæˆå™¨
 */
class ChangelogGenerator {
    
    /**
     * æ ¹æ®æäº¤ä¿¡æ¯ç”Ÿæˆå˜æ›´æ—¥å¿—
     */
    fun generate(commits: List<ParsedCommit>): String {
        val grouped = commits.groupBy { it.type }
        
        return buildString {
            // æ–°åŠŸèƒ½
            grouped[CommitType.FEATURE]?.let { features ->
                appendLine("### âœ¨ æ–°åŠŸèƒ½")
                features.forEach { appendLine("- ${it.subject}") }
                appendLine()
            }
            
            // Bugä¿®å¤
            grouped[CommitType.FIX]?.let { fixes ->
                appendLine("### ğŸ› Bugä¿®å¤")
                fixes.forEach { appendLine("- ${it.subject}") }
                appendLine()
            }
            
            // æ€§èƒ½ä¼˜åŒ–
            grouped[CommitType.PERF]?.let { perfs ->
                appendLine("### âš¡ æ€§èƒ½ä¼˜åŒ–")
                perfs.forEach { appendLine("- ${it.subject}") }
                appendLine()
            }
            
            // ç ´åæ€§å˜æ›´
            val breaking = commits.filter { it.isBreaking }
            if (breaking.isNotEmpty()) {
                appendLine("### âš ï¸ ç ´åæ€§å˜æ›´")
                breaking.forEach { appendLine("- ${it.subject}") }
                appendLine()
            }
        }
    }
}
```

---

## ğŸ”— å¤šæ¨¡å—åè°ƒæœºåˆ¶

### 1. ç‰ˆæœ¬å·åŒæ­¥ç­–ç•¥

ç”±äºé¡¹ç›®é‡‡ç”¨Clean Architectureå¤šæ¨¡å—è®¾è®¡ï¼Œéœ€è¦ç¡®ä¿å„æ¨¡å—ç‰ˆæœ¬å·çš„ä¸€è‡´æ€§ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç‰ˆæœ¬å·åŒæ­¥æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              gradle.properties (ç‰ˆæœ¬æº)              â”‚   â”‚
â”‚  â”‚  APP_VERSION_NAME=1.2.3                             â”‚   â”‚
â”‚  â”‚  APP_VERSION_CODE=10203                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                   â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚         â–¼               â–¼               â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  :app    â”‚    â”‚  :data   â”‚    â”‚:presentation â”‚         â”‚
â”‚  â”‚ versionNameâ”‚   â”‚ version  â”‚    â”‚   version    â”‚         â”‚
â”‚  â”‚ versionCodeâ”‚   â”‚ (å¼•ç”¨)   â”‚    â”‚   (å¼•ç”¨)     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. gradle.propertiesç‰ˆæœ¬å®šä¹‰

**æ–‡ä»¶ä½ç½®**ï¼š`gradle.properties`

```properties
# åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç»Ÿä¸€ç‰ˆæœ¬æºï¼‰
APP_VERSION_NAME=1.2.3
APP_VERSION_CODE=10203

# å‘å¸ƒé˜¶æ®µ
APP_RELEASE_STAGE=production
```

### 3. æ¨¡å—å¼•ç”¨ç‰ˆæœ¬

**app/build.gradle.kts**ï¼š

```kotlin
android {
    defaultConfig {
        versionCode = property("APP_VERSION_CODE").toString().toInt()
        versionName = property("APP_VERSION_NAME").toString()
    }
}
```

**å…¶ä»–æ¨¡å—ï¼ˆdata/presentationï¼‰**ï¼š

```kotlin
// åº“æ¨¡å—ä¸éœ€è¦versionCode/versionName
// ä½†å¯ä»¥åœ¨BuildConfigä¸­å¼•ç”¨ç‰ˆæœ¬ä¿¡æ¯ç”¨äºæ—¥å¿—ç­‰
android {
    buildFeatures {
        buildConfig = true
    }
    
    defaultConfig {
        buildConfigField(
            "String",
            "APP_VERSION",
            "\"${property("APP_VERSION_NAME")}\""
        )
    }
}
```

### 4. ç‰ˆæœ¬æ›´æ–°å™¨å®ç°

```kotlin
/**
 * ç‰ˆæœ¬ç®¡ç†å™¨
 * è´Ÿè´£æ›´æ–°gradle.propertiesä¸­çš„ç‰ˆæœ¬ä¿¡æ¯
 */
class VersionManager(private val projectDir: File) {
    
    private val gradlePropertiesFile = File(projectDir, "gradle.properties")
    
    /**
     * è·å–å½“å‰ç‰ˆæœ¬
     */
    fun getCurrentVersion(): SemanticVersion {
        val properties = Properties().apply {
            gradlePropertiesFile.inputStream().use { load(it) }
        }
        val versionName = properties.getProperty("APP_VERSION_NAME")
            ?: throw IllegalStateException("APP_VERSION_NAME not found")
        return SemanticVersion.parse(versionName)
    }
    
    /**
     * æ›´æ–°ç‰ˆæœ¬å·
     */
    fun updateVersion(newVersion: SemanticVersion, stage: ReleaseStage) {
        val content = gradlePropertiesFile.readText()
        val versionCode = calculateVersionCode(newVersion)
        
        val updatedContent = content
            .replace(
                Regex("""APP_VERSION_NAME=.+"""),
                "APP_VERSION_NAME=$newVersion"
            )
            .replace(
                Regex("""APP_VERSION_CODE=\d+"""),
                "APP_VERSION_CODE=$versionCode"
            )
            .replace(
                Regex("""APP_RELEASE_STAGE=.+"""),
                "APP_RELEASE_STAGE=${stage.name.lowercase()}"
            )
        
        gradlePropertiesFile.writeText(updatedContent)
    }
    
    /**
     * è®¡ç®—versionCode
     * å…¬å¼: major*10000 + minor*100 + patch
     */
    private fun calculateVersionCode(version: SemanticVersion): Int {
        return version.major * 10000 + version.minor * 100 + version.patch
    }
}
```


---

## ğŸ’¾ å¤‡ä»½ä¸å›æ»šæœºåˆ¶

### 1. å¤‡ä»½ç­–ç•¥

```kotlin
/**
 * å¤‡ä»½ç®¡ç†å™¨
 * è´Ÿè´£æ–‡ä»¶å¤‡ä»½å’Œå›æ»šæ“ä½œ
 */
class BackupManager(private val projectDir: File) {
    
    companion object {
        private const val BACKUP_DIR = "backups/version-update"
        private const val MAX_BACKUPS = 50
        private const val RETENTION_DAYS = 30
    }
    
    private val backupDir = File(projectDir, BACKUP_DIR)
    
    /**
     * åˆ›å»ºå®Œæ•´å¤‡ä»½
     */
    fun createBackup(): BackupResult {
        val timestamp = SimpleDateFormat("yyyy-MM-dd-HH-mm-ss").format(Date())
        val backupName = "backup-$timestamp"
        val backupPath = File(backupDir, backupName)
        
        backupPath.mkdirs()
        
        // å¤‡ä»½æ–‡ä»¶åˆ—è¡¨
        val filesToBackup = listOf(
            "gradle.properties",
            "app/build.gradle.kts",
            "config/version-history.json"
        )
        
        // å¤‡ä»½å›¾æ ‡ç›®å½•
        val iconDirs = listOf(
            "app/src/main/res/mipmap-mdpi",
            "app/src/main/res/mipmap-hdpi",
            "app/src/main/res/mipmap-xhdpi",
            "app/src/main/res/mipmap-xxhdpi",
            "app/src/main/res/mipmap-xxxhdpi"
        )
        
        // å¤åˆ¶æ–‡ä»¶
        filesToBackup.forEach { relativePath ->
            val source = File(projectDir, relativePath)
            if (source.exists()) {
                val target = File(backupPath, relativePath)
                target.parentFile.mkdirs()
                source.copyTo(target, overwrite = true)
            }
        }
        
        // å¤åˆ¶å›¾æ ‡ç›®å½•
        iconDirs.forEach { relativePath ->
            val source = File(projectDir, relativePath)
            if (source.exists() && source.isDirectory) {
                val target = File(backupPath, relativePath)
                source.copyRecursively(target, overwrite = true)
            }
        }
        
        // åˆ›å»ºå¤‡ä»½å…ƒæ•°æ®
        val metadata = BackupMetadata(
            timestamp = timestamp,
            files = filesToBackup + iconDirs,
            createdAt = System.currentTimeMillis()
        )
        File(backupPath, "metadata.json").writeText(
            Json.encodeToString(metadata)
        )
        
        // æ¸…ç†æ—§å¤‡ä»½
        cleanupOldBackups()
        
        return BackupResult(
            backupPath = backupPath.absolutePath,
            timestamp = timestamp,
            fileCount = filesToBackup.size + iconDirs.size
        )
    }
    
    /**
     * ä»å¤‡ä»½æ¢å¤
     */
    fun restore(backupResult: BackupResult): RestoreResult {
        val backupPath = File(backupResult.backupPath)
        if (!backupPath.exists()) {
            throw IllegalStateException("å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: ${backupResult.backupPath}")
        }
        
        val metadata = Json.decodeFromString<BackupMetadata>(
            File(backupPath, "metadata.json").readText()
        )
        
        var restoredCount = 0
        metadata.files.forEach { relativePath ->
            val source = File(backupPath, relativePath)
            val target = File(projectDir, relativePath)
            
            if (source.exists()) {
                if (source.isDirectory) {
                    source.copyRecursively(target, overwrite = true)
                } else {
                    target.parentFile.mkdirs()
                    source.copyTo(target, overwrite = true)
                }
                restoredCount++
            }
        }
        
        return RestoreResult(
            restoredFiles = restoredCount,
            timestamp = backupResult.timestamp
        )
    }
    
    /**
     * æ¸…ç†æ—§å¤‡ä»½
     */
    private fun cleanupOldBackups() {
        if (!backupDir.exists()) return
        
        val backups = backupDir.listFiles()
            ?.filter { it.isDirectory && it.name.startsWith("backup-") }
            ?.sortedByDescending { it.name }
            ?: return
        
        // ä¿ç•™æœ€è¿‘Nä¸ªå¤‡ä»½
        if (backups.size > MAX_BACKUPS) {
            backups.drop(MAX_BACKUPS).forEach { it.deleteRecursively() }
        }
        
        // åˆ é™¤è¶…è¿‡ä¿ç•™æœŸé™çš„å¤‡ä»½
        val cutoffTime = System.currentTimeMillis() - RETENTION_DAYS * 24 * 60 * 60 * 1000L
        backups.forEach { backup ->
            val metadataFile = File(backup, "metadata.json")
            if (metadataFile.exists()) {
                val metadata = Json.decodeFromString<BackupMetadata>(metadataFile.readText())
                if (metadata.createdAt < cutoffTime) {
                    backup.deleteRecursively()
                }
            }
        }
    }
}

@Serializable
data class BackupMetadata(
    val timestamp: String,
    val files: List<String>,
    val createdAt: Long
)

data class BackupResult(
    val backupPath: String,
    val timestamp: String,
    val fileCount: Int
)

data class RestoreResult(
    val restoredFiles: Int,
    val timestamp: String
)
```

### 2. å›æ»šå‘½ä»¤

```bash
# åˆ—å‡ºå¯ç”¨å¤‡ä»½
./gradlew listBackups

# å›æ»šåˆ°æœ€è¿‘çš„å¤‡ä»½
./gradlew rollbackVersion

# å›æ»šåˆ°æŒ‡å®šå¤‡ä»½
./gradlew rollbackVersion --backup=backup-2025-12-31-10-00-00
```

---

## âš ï¸ é”™è¯¯å¤„ç†æœºåˆ¶

### 1. é”™è¯¯ç±»å‹å®šä¹‰

```kotlin
/**
 * ç‰ˆæœ¬æ›´æ–°é”™è¯¯ç±»å‹
 */
sealed class VersionUpdateError : Exception() {
    
    // Gitç›¸å…³é”™è¯¯
    data class GitNotFound(override val message: String = "Gitæœªå®‰è£…æˆ–ä¸åœ¨PATHä¸­") 
        : VersionUpdateError()
    data class GitOperationFailed(val operation: String, val output: String) 
        : VersionUpdateError() {
        override val message = "Gitæ“ä½œå¤±è´¥: $operation\n$output"
    }
    data class NoCommitsFound(override val message: String = "æœªæ‰¾åˆ°æ–°çš„æäº¤") 
        : VersionUpdateError()
    
    // æ–‡ä»¶ç›¸å…³é”™è¯¯
    data class FileNotFound(val path: String) : VersionUpdateError() {
        override val message = "æ–‡ä»¶ä¸å­˜åœ¨: $path"
    }
    data class FileWriteFailed(val path: String, val cause: Throwable) 
        : VersionUpdateError() {
        override val message = "æ–‡ä»¶å†™å…¥å¤±è´¥: $path - ${cause.message}"
    }
    data class IconNotFound(val stage: String) : VersionUpdateError() {
        override val message = "æœªæ‰¾åˆ°${stage}é˜¶æ®µçš„å›¾æ ‡èµ„æº"
    }
    
    // é…ç½®ç›¸å…³é”™è¯¯
    data class ConfigParseError(val file: String, val cause: Throwable) 
        : VersionUpdateError() {
        override val message = "é…ç½®æ–‡ä»¶è§£æå¤±è´¥: $file - ${cause.message}"
    }
    data class InvalidVersion(val version: String) : VersionUpdateError() {
        override val message = "æ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼: $version"
    }
    
    // å¤‡ä»½ç›¸å…³é”™è¯¯
    data class BackupFailed(val cause: Throwable) : VersionUpdateError() {
        override val message = "å¤‡ä»½å¤±è´¥: ${cause.message}"
    }
    data class RestoreFailed(val cause: Throwable) : VersionUpdateError() {
        override val message = "æ¢å¤å¤±è´¥: ${cause.message}"
    }
    
    // å¹¶å‘ç›¸å…³é”™è¯¯
    data class LockAcquisitionFailed(override val message: String = "æ— æ³•è·å–æ–‡ä»¶é”ï¼Œå¯èƒ½æœ‰å…¶ä»–è¿›ç¨‹æ­£åœ¨æ‰§è¡Œæ›´æ–°") 
        : VersionUpdateError()
}
```

### 2. é”™è¯¯å¤„ç†ç­–ç•¥

| é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | é‡è¯•æ¬¡æ•° | ç”¨æˆ·æç¤º |
|----------|----------|----------|----------|
| GitNotFound | ç»ˆæ­¢æ‰§è¡Œ | 0 | è¯·å®‰è£…Gitå¹¶æ·»åŠ åˆ°PATH |
| GitOperationFailed | é‡è¯•åç»ˆæ­¢ | 3 | æ˜¾ç¤ºGité”™è¯¯è¾“å‡º |
| FileNotFound | ç»ˆæ­¢æ‰§è¡Œ | 0 | æ˜¾ç¤ºç¼ºå¤±æ–‡ä»¶è·¯å¾„ |
| FileWriteFailed | é‡è¯•åå›æ»š | 3 | æ£€æŸ¥æ–‡ä»¶æƒé™ |
| IconNotFound | ç»ˆæ­¢æ‰§è¡Œ | 0 | è¯·å‡†å¤‡å¯¹åº”é˜¶æ®µçš„å›¾æ ‡ |
| ConfigParseError | ä½¿ç”¨é»˜è®¤é…ç½® | 0 | é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ |
| BackupFailed | ç»ˆæ­¢æ‰§è¡Œ | 1 | æ£€æŸ¥ç£ç›˜ç©ºé—´ |
| LockAcquisitionFailed | ç­‰å¾…åé‡è¯• | 5 | ç­‰å¾…å…¶ä»–è¿›ç¨‹å®Œæˆ |

### 3. æ–‡ä»¶é”æœºåˆ¶

```kotlin
/**
 * æ–‡ä»¶é”ç®¡ç†å™¨
 * é˜²æ­¢å¤šä¸ªè¿›ç¨‹åŒæ—¶æ‰§è¡Œç‰ˆæœ¬æ›´æ–°
 */
class FileLockManager(private val projectDir: File) {
    
    private val lockFile = File(projectDir, ".version-update.lock")
    private var fileLock: FileLock? = null
    private var channel: FileChannel? = null
    
    /**
     * è·å–é”
     * @param timeout è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     * @return æ˜¯å¦æˆåŠŸè·å–é”
     */
    fun acquireLock(timeout: Long = 5 * 60 * 1000): Boolean {
        val startTime = System.currentTimeMillis()
        
        while (System.currentTimeMillis() - startTime < timeout) {
            try {
                channel = FileChannel.open(
                    lockFile.toPath(),
                    StandardOpenOption.CREATE,
                    StandardOpenOption.WRITE
                )
                fileLock = channel?.tryLock()
                
                if (fileLock != null) {
                    // å†™å…¥é”ä¿¡æ¯
                    val lockInfo = """
                        |pid=${ProcessHandle.current().pid()}
                        |timestamp=${System.currentTimeMillis()}
                        |user=${System.getProperty("user.name")}
                    """.trimMargin()
                    channel?.write(ByteBuffer.wrap(lockInfo.toByteArray()))
                    return true
                }
            } catch (e: OverlappingFileLockException) {
                // é”å·²è¢«å½“å‰JVMæŒæœ‰
            }
            
            Thread.sleep(1000)
        }
        
        return false
    }
    
    /**
     * é‡Šæ”¾é”
     */
    fun releaseLock() {
        try {
            fileLock?.release()
            channel?.close()
            lockFile.delete()
        } catch (e: Exception) {
            // å¿½ç•¥é‡Šæ”¾é”™è¯¯
        } finally {
            fileLock = null
            channel = null
        }
    }
}
```


---

## ğŸ”„ CI/CDé›†æˆè®¾è®¡

### 1. GitHub Actionså·¥ä½œæµ

**æ–‡ä»¶ä½ç½®**ï¼š`.github/workflows/release.yml`

```yaml
name: Release

on:
  push:
    branches:
      - main
      - 'release/*'
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      stage:
        description: 'å‘å¸ƒé˜¶æ®µ'
        required: true
        default: 'production'
        type: choice
        options:
          - dev
          - test
          - beta
          - production
      force:
        description: 'å¼ºåˆ¶æ›´æ–°ç‰ˆæœ¬å·'
        required: false
        default: false
        type: boolean

jobs:
  version-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬è®¡ç®—
      
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
      
      - name: Determine Stage
        id: stage
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "stage=${{ github.event.inputs.stage }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "stage=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/heads/release/* ]]; then
            echo "stage=beta" >> $GITHUB_OUTPUT
          else
            echo "stage=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Update Version and Icon
        run: |
          ./gradlew updateVersionAndIcon \
            --stage=${{ steps.stage.outputs.stage }} \
            ${{ github.event.inputs.force == 'true' && '--force' || '' }}
      
      - name: Build APK
        run: ./gradlew assembleRelease
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ steps.stage.outputs.stage }}
          path: app/build/outputs/apk/release/*.apk
      
      - name: Create Release (Production only)
        if: steps.stage.outputs.stage == 'production'
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/release/*.apk
          generate_release_notes: true
```

### 2. æœ¬åœ°å¼€å‘è„šæœ¬

**æ–‡ä»¶ä½ç½®**ï¼š`scripts/release.bat` (Windows)

```batch
@echo off
setlocal enabledelayedexpansion

echo ========================================
echo ç‰ˆæœ¬å‘å¸ƒè„šæœ¬
echo ========================================

:: å‚æ•°è§£æ
set STAGE=production
set FORCE=
set DRY_RUN=

:parse_args
if "%~1"=="" goto :end_parse
if /i "%~1"=="--stage" (
    set STAGE=%~2
    shift
    shift
    goto :parse_args
)
if /i "%~1"=="--force" (
    set FORCE=--force
    shift
    goto :parse_args
)
if /i "%~1"=="--dry-run" (
    set DRY_RUN=--dry-run
    shift
    goto :parse_args
)
shift
goto :parse_args
:end_parse

echo å‘å¸ƒé˜¶æ®µ: %STAGE%
echo å¼ºåˆ¶æ›´æ–°: %FORCE%
echo é¢„æ¼”æ¨¡å¼: %DRY_RUN%
echo.

:: æ£€æŸ¥GitçŠ¶æ€
echo [1/4] æ£€æŸ¥GitçŠ¶æ€...
git status --porcelain > nul 2>&1
if errorlevel 1 (
    echo é”™è¯¯: ä¸æ˜¯Gitä»“åº“
    exit /b 1
)

:: æ‰§è¡Œç‰ˆæœ¬æ›´æ–°
echo [2/4] æ‰§è¡Œç‰ˆæœ¬æ›´æ–°...
call gradlew.bat updateVersionAndIcon --stage=%STAGE% %FORCE% %DRY_RUN%
if errorlevel 1 (
    echo é”™è¯¯: ç‰ˆæœ¬æ›´æ–°å¤±è´¥
    exit /b 1
)

:: æ„å»ºAPK
if "%DRY_RUN%"=="" (
    echo [3/4] æ„å»ºAPK...
    call gradlew.bat assembleRelease
    if errorlevel 1 (
        echo é”™è¯¯: APKæ„å»ºå¤±è´¥
        exit /b 1
    )
    
    echo [4/4] å®Œæˆ!
    echo APKä½ç½®: app\build\outputs\apk\release\
) else (
    echo [3/4] è·³è¿‡æ„å»º (é¢„æ¼”æ¨¡å¼)
    echo [4/4] é¢„æ¼”å®Œæˆ!
)

echo ========================================
echo å‘å¸ƒæµç¨‹å®Œæˆ
echo ========================================
```

**æ–‡ä»¶ä½ç½®**ï¼š`scripts/release.sh` (Linux/macOS)

```bash
#!/bin/bash

echo "========================================"
echo "ç‰ˆæœ¬å‘å¸ƒè„šæœ¬"
echo "========================================"

# é»˜è®¤å‚æ•°
STAGE="production"
FORCE=""
DRY_RUN=""

# å‚æ•°è§£æ
while [[ $# -gt 0 ]]; do
    case $1 in
        --stage)
            STAGE="$2"
            shift 2
            ;;
        --force)
            FORCE="--force"
            shift
            ;;
        --dry-run)
            DRY_RUN="--dry-run"
            shift
            ;;
        *)
            shift
            ;;
    esac
done

echo "å‘å¸ƒé˜¶æ®µ: $STAGE"
echo "å¼ºåˆ¶æ›´æ–°: $FORCE"
echo "é¢„æ¼”æ¨¡å¼: $DRY_RUN"
echo ""

# æ£€æŸ¥GitçŠ¶æ€
echo "[1/4] æ£€æŸ¥GitçŠ¶æ€..."
if ! git status --porcelain > /dev/null 2>&1; then
    echo "é”™è¯¯: ä¸æ˜¯Gitä»“åº“"
    exit 1
fi

# æ‰§è¡Œç‰ˆæœ¬æ›´æ–°
echo "[2/4] æ‰§è¡Œç‰ˆæœ¬æ›´æ–°..."
./gradlew updateVersionAndIcon --stage="$STAGE" $FORCE $DRY_RUN
if [ $? -ne 0 ]; then
    echo "é”™è¯¯: ç‰ˆæœ¬æ›´æ–°å¤±è´¥"
    exit 1
fi

# æ„å»ºAPK
if [ -z "$DRY_RUN" ]; then
    echo "[3/4] æ„å»ºAPK..."
    ./gradlew assembleRelease
    if [ $? -ne 0 ]; then
        echo "é”™è¯¯: APKæ„å»ºå¤±è´¥"
        exit 1
    fi
    
    echo "[4/4] å®Œæˆ!"
    echo "APKä½ç½®: app/build/outputs/apk/release/"
else
    echo "[3/4] è·³è¿‡æ„å»º (é¢„æ¼”æ¨¡å¼)"
    echo "[4/4] é¢„æ¼”å®Œæˆ!"
fi

echo "========================================"
echo "å‘å¸ƒæµç¨‹å®Œæˆ"
echo "========================================"
```


---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

| æµ‹è¯•ç±» | æµ‹è¯•å†…å®¹ | æµ‹è¯•ç”¨ä¾‹æ•° |
|--------|----------|------------|
| SemanticVersionTest | ç‰ˆæœ¬å·è§£æå’Œè®¡ç®— | 15 |
| CommitParserTest | Gitæäº¤ä¿¡æ¯è§£æ | 12 |
| VersionCalculatorTest | ç‰ˆæœ¬å·é€’å¢é€»è¾‘ | 10 |
| IconManagerTest | å›¾æ ‡åˆ‡æ¢é€»è¾‘ | 8 |
| BackupManagerTest | å¤‡ä»½å’Œæ¢å¤é€»è¾‘ | 10 |
| ChangelogGeneratorTest | å˜æ›´æ—¥å¿—ç”Ÿæˆ | 6 |

**ç¤ºä¾‹æµ‹è¯•ç”¨ä¾‹**ï¼š

```kotlin
class SemanticVersionTest {
    
    @Test
    fun `parse valid version string`() {
        val version = SemanticVersion.parse("1.2.3")
        assertEquals(1, version.major)
        assertEquals(2, version.minor)
        assertEquals(3, version.patch)
        assertNull(version.prerelease)
        assertNull(version.build)
    }
    
    @Test
    fun `parse version with prerelease`() {
        val version = SemanticVersion.parse("1.2.3-beta.1")
        assertEquals("beta.1", version.prerelease)
    }
    
    @Test
    fun `parse version with build metadata`() {
        val version = SemanticVersion.parse("1.2.3+20251231")
        assertEquals("20251231", version.build)
    }
    
    @Test
    fun `bump major version`() {
        val version = SemanticVersion(1, 2, 3)
        val bumped = version.bumpMajor()
        assertEquals(SemanticVersion(2, 0, 0), bumped)
    }
    
    @Test
    fun `bump minor version`() {
        val version = SemanticVersion(1, 2, 3)
        val bumped = version.bumpMinor()
        assertEquals(SemanticVersion(1, 3, 0), bumped)
    }
    
    @Test
    fun `bump patch version`() {
        val version = SemanticVersion(1, 2, 3)
        val bumped = version.bumpPatch()
        assertEquals(SemanticVersion(1, 2, 4), bumped)
    }
    
    @Test(expected = IllegalArgumentException::class)
    fun `parse invalid version throws exception`() {
        SemanticVersion.parse("invalid")
    }
}

class CommitParserTest {
    
    @Test
    fun `parse feat commit`() {
        val commit = CommitParser.parseCommitMessage("feat: æ·»åŠ æ–°åŠŸèƒ½")
        assertEquals(CommitType.FEATURE, commit.type)
        assertEquals("æ·»åŠ æ–°åŠŸèƒ½", commit.subject)
        assertFalse(commit.isBreaking)
    }
    
    @Test
    fun `parse breaking change commit`() {
        val commit = CommitParser.parseCommitMessage("feat!: ç ´åæ€§å˜æ›´")
        assertEquals(CommitType.BREAKING_CHANGE, commit.type)
        assertTrue(commit.isBreaking)
    }
    
    @Test
    fun `parse fix commit with scope`() {
        val commit = CommitParser.parseCommitMessage("fix(ui): ä¿®å¤æŒ‰é’®æ ·å¼")
        assertEquals(CommitType.FIX, commit.type)
        assertEquals("ui", commit.scope)
        assertEquals("ä¿®å¤æŒ‰é’®æ ·å¼", commit.subject)
    }
}

class VersionCalculatorTest {
    
    private val calculator = VersionCalculator()
    
    @Test
    fun `breaking change bumps major`() {
        val current = SemanticVersion(1, 2, 3)
        val commits = listOf(
            ParsedCommit(CommitType.BREAKING_CHANGE, "ç ´åæ€§å˜æ›´", isBreaking = true)
        )
        val next = calculator.calculateNextVersion(current, commits)
        assertEquals(SemanticVersion(2, 0, 0), next)
    }
    
    @Test
    fun `feature bumps minor`() {
        val current = SemanticVersion(1, 2, 3)
        val commits = listOf(
            ParsedCommit(CommitType.FEATURE, "æ–°åŠŸèƒ½")
        )
        val next = calculator.calculateNextVersion(current, commits)
        assertEquals(SemanticVersion(1, 3, 0), next)
    }
    
    @Test
    fun `fix bumps patch`() {
        val current = SemanticVersion(1, 2, 3)
        val commits = listOf(
            ParsedCommit(CommitType.FIX, "ä¿®å¤é—®é¢˜")
        )
        val next = calculator.calculateNextVersion(current, commits)
        assertEquals(SemanticVersion(1, 2, 4), next)
    }
    
    @Test
    fun `highest bump wins`() {
        val current = SemanticVersion(1, 2, 3)
        val commits = listOf(
            ParsedCommit(CommitType.FIX, "ä¿®å¤é—®é¢˜"),
            ParsedCommit(CommitType.FEATURE, "æ–°åŠŸèƒ½"),
            ParsedCommit(CommitType.FIX, "å¦ä¸€ä¸ªä¿®å¤")
        )
        val next = calculator.calculateNextVersion(current, commits)
        assertEquals(SemanticVersion(1, 3, 0), next)  // minor wins
    }
}
```

### 2. é›†æˆæµ‹è¯•

```kotlin
class VersionUpdateIntegrationTest {
    
    @TempDir
    lateinit var tempDir: File
    
    private lateinit var versionManager: VersionManager
    private lateinit var iconManager: IconManager
    private lateinit var backupManager: BackupManager
    
    @BeforeEach
    fun setup() {
        // åˆ›å»ºæµ‹è¯•é¡¹ç›®ç»“æ„
        setupTestProject(tempDir)
        
        backupManager = BackupManager(tempDir)
        versionManager = VersionManager(tempDir)
        iconManager = IconManager(tempDir, backupManager)
    }
    
    @Test
    fun `full update flow succeeds`() {
        // Given
        val initialVersion = versionManager.getCurrentVersion()
        assertEquals(SemanticVersion(1, 0, 0), initialVersion)
        
        // When
        versionManager.updateVersion(SemanticVersion(1, 1, 0), ReleaseStage.BETA)
        iconManager.switchToStage(ReleaseStage.BETA)
        
        // Then
        val updatedVersion = versionManager.getCurrentVersion()
        assertEquals(SemanticVersion(1, 1, 0), updatedVersion)
        
        // éªŒè¯å›¾æ ‡å·²æ›´æ–°
        val iconFile = File(tempDir, "app/src/main/res/mipmap-hdpi/ic_launcher.png")
        assertTrue(iconFile.exists())
    }
    
    @Test
    fun `rollback restores original state`() {
        // Given
        val initialVersion = versionManager.getCurrentVersion()
        val backup = backupManager.createBackup()
        
        // When
        versionManager.updateVersion(SemanticVersion(2, 0, 0), ReleaseStage.PRODUCTION)
        backupManager.restore(backup)
        
        // Then
        val restoredVersion = versionManager.getCurrentVersion()
        assertEquals(initialVersion, restoredVersion)
    }
    
    private fun setupTestProject(dir: File) {
        // åˆ›å»ºgradle.properties
        File(dir, "gradle.properties").writeText("""
            APP_VERSION_NAME=1.0.0
            APP_VERSION_CODE=10000
            APP_RELEASE_STAGE=dev
        """.trimIndent())
        
        // åˆ›å»ºå›¾æ ‡ç›®å½•å’Œæ–‡ä»¶
        listOf("mdpi", "hdpi", "xhdpi", "xxhdpi", "xxxhdpi").forEach { density ->
            val iconDir = File(dir, "app/src/main/res/mipmap-$density")
            iconDir.mkdirs()
            File(iconDir, "ic_launcher.png").writeBytes(ByteArray(100))
        }
        
        // åˆ›å»ºæºå›¾æ ‡
        ReleaseStage.entries.forEach { stage ->
            val sourceDir = File(dir, "assets/icons/${stage.iconSuffix}")
            sourceDir.mkdirs()
            File(sourceDir, "ic_launcher.png").writeBytes(ByteArray(100))
        }
    }
}
```

### 3. ç«¯åˆ°ç«¯æµ‹è¯•

```kotlin
class VersionUpdateE2ETest {
    
    @Test
    fun `gradle task executes successfully`() {
        // ä½¿ç”¨GradleRunneræ‰§è¡Œä»»åŠ¡
        val result = GradleRunner.create()
            .withProjectDir(testProjectDir)
            .withArguments("updateVersionAndIcon", "--stage=dev", "--dry-run")
            .withPluginClasspath()
            .build()
        
        assertEquals(TaskOutcome.SUCCESS, result.task(":updateVersionAndIcon")?.outcome)
        assertTrue(result.output.contains("é¢„æ¼”å®Œæˆ"))
    }
    
    @Test
    fun `version update with real git history`() {
        // åˆå§‹åŒ–Gitä»“åº“
        ProcessBuilder("git", "init").directory(testProjectDir).start().waitFor()
        ProcessBuilder("git", "add", ".").directory(testProjectDir).start().waitFor()
        ProcessBuilder("git", "commit", "-m", "feat: initial commit")
            .directory(testProjectDir).start().waitFor()
        ProcessBuilder("git", "tag", "v1.0.0").directory(testProjectDir).start().waitFor()
        
        // æ·»åŠ æ–°æäº¤
        File(testProjectDir, "test.txt").writeText("test")
        ProcessBuilder("git", "add", ".").directory(testProjectDir).start().waitFor()
        ProcessBuilder("git", "commit", "-m", "feat: add new feature")
            .directory(testProjectDir).start().waitFor()
        
        // æ‰§è¡Œç‰ˆæœ¬æ›´æ–°
        val result = GradleRunner.create()
            .withProjectDir(testProjectDir)
            .withArguments("updateVersionAndIcon", "--stage=production")
            .withPluginClasspath()
            .build()
        
        assertEquals(TaskOutcome.SUCCESS, result.task(":updateVersionAndIcon")?.outcome)
        
        // éªŒè¯ç‰ˆæœ¬å·å·²æ›´æ–°ä¸º1.1.0
        val properties = Properties().apply {
            File(testProjectDir, "gradle.properties").inputStream().use { load(it) }
        }
        assertEquals("1.1.0", properties.getProperty("APP_VERSION_NAME"))
    }
}
```

### 4. æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | å…³é”®æŒ‡æ ‡ |
|------|------------|----------|
| VersionManager | â‰¥ 85% | è¡Œè¦†ç›–ç‡ã€åˆ†æ”¯è¦†ç›–ç‡ |
| CommitParser | â‰¥ 90% | è¡Œè¦†ç›–ç‡ã€åˆ†æ”¯è¦†ç›–ç‡ |
| IconManager | â‰¥ 80% | è¡Œè¦†ç›–ç‡ |
| BackupManager | â‰¥ 85% | è¡Œè¦†ç›–ç‡ã€åˆ†æ”¯è¦†ç›–ç‡ |
| VersionCalculator | â‰¥ 95% | è¡Œè¦†ç›–ç‡ã€åˆ†æ”¯è¦†ç›–ç‡ |
| **æ•´ä½“ç›®æ ‡** | **â‰¥ 80%** | è¡Œè¦†ç›–ç‡ |

**è¦†ç›–ç‡æ£€æŸ¥é…ç½®**ï¼š

```kotlin
// buildSrc/build.gradle.kts
plugins {
    kotlin("jvm")
    id("jacoco")
}

jacoco {
    toolVersion = "0.8.11"
}

tasks.jacocoTestReport {
    reports {
        xml.required.set(true)
        html.required.set(true)
    }
}

tasks.jacocoTestCoverageVerification {
    violationRules {
        rule {
            limit {
                minimum = "0.80".toBigDecimal()
            }
        }
        rule {
            element = "CLASS"
            includes = listOf("com.empathy.ai.build.VersionCalculator")
            limit {
                minimum = "0.95".toBigDecimal()
            }
        }
    }
}

tasks.check {
    dependsOn(tasks.jacocoTestCoverageVerification)
}
```

### 5. æ€§èƒ½åŸºå‡†æµ‹è¯•æ–¹æ¡ˆ

#### 5.1 æ€§èƒ½æŒ‡æ ‡å®šä¹‰

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|----------|
| ç‰ˆæœ¬æ›´æ–°æ€»è€—æ—¶ | < 30ç§’ | ä»ä»»åŠ¡å¼€å§‹åˆ°å®Œæˆçš„æ—¶é—´ |
| Gitæäº¤åˆ†æè€—æ—¶ | < 5ç§’ | CommitParseræ‰§è¡Œæ—¶é—´ |
| å›¾æ ‡åˆ‡æ¢è€—æ—¶ | < 10ç§’ | IconManageræ‰§è¡Œæ—¶é—´ |
| å¤‡ä»½åˆ›å»ºè€—æ—¶ | < 5ç§’ | BackupManager.createBackup()æ‰§è¡Œæ—¶é—´ |
| å†…å­˜å³°å€¼ | < 100MB | JVMå †å†…å­˜ä½¿ç”¨å³°å€¼ |
| ç£ç›˜IO | < 50MB | å¤‡ä»½å’Œå›¾æ ‡å¤åˆ¶çš„æ€»å†™å…¥é‡ |

#### 5.2 æ€§èƒ½æµ‹è¯•ç”¨ä¾‹

```kotlin
class VersionUpdatePerformanceTest {
    
    @Test
    fun `version update completes within 30 seconds`() {
        val startTime = System.currentTimeMillis()
        
        val result = GradleRunner.create()
            .withProjectDir(testProjectDir)
            .withArguments("updateVersionAndIcon", "--stage=production")
            .withPluginClasspath()
            .build()
        
        val duration = System.currentTimeMillis() - startTime
        
        assertEquals(TaskOutcome.SUCCESS, result.task(":updateVersionAndIcon")?.outcome)
        assertTrue(duration < 30_000, "æ›´æ–°è€—æ—¶ ${duration}ms è¶…è¿‡30ç§’é™åˆ¶")
    }
    
    @Test
    fun `commit parsing completes within 5 seconds`() {
        // åˆ›å»º100ä¸ªæµ‹è¯•æäº¤
        repeat(100) { i ->
            File(testProjectDir, "test$i.txt").writeText("test$i")
            ProcessBuilder("git", "add", ".").directory(testProjectDir).start().waitFor()
            ProcessBuilder("git", "commit", "-m", "feat: feature $i")
                .directory(testProjectDir).start().waitFor()
        }
        
        val parser = CommitParser(testProjectDir)
        val startTime = System.currentTimeMillis()
        
        val commits = parser.parseCommitsSinceLastTag()
        
        val duration = System.currentTimeMillis() - startTime
        
        assertEquals(100, commits.size)
        assertTrue(duration < 5_000, "æäº¤åˆ†æè€—æ—¶ ${duration}ms è¶…è¿‡5ç§’é™åˆ¶")
    }
    
    @Test
    fun `memory usage stays below 100MB`() {
        val runtime = Runtime.getRuntime()
        runtime.gc()
        val beforeMemory = runtime.totalMemory() - runtime.freeMemory()
        
        // æ‰§è¡Œç‰ˆæœ¬æ›´æ–°
        val versionManager = VersionManager(testProjectDir)
        val iconManager = IconManager(testProjectDir, BackupManager(testProjectDir))
        
        versionManager.updateVersion(SemanticVersion(2, 0, 0), ReleaseStage.PRODUCTION)
        iconManager.switchToStage(ReleaseStage.PRODUCTION)
        
        val afterMemory = runtime.totalMemory() - runtime.freeMemory()
        val memoryUsed = (afterMemory - beforeMemory) / (1024 * 1024)
        
        assertTrue(memoryUsed < 100, "å†…å­˜ä½¿ç”¨ ${memoryUsed}MB è¶…è¿‡100MBé™åˆ¶")
    }
    
    @Test
    fun `stress test - 100 consecutive updates succeed`() {
        var successCount = 0
        var failCount = 0
        
        repeat(100) { i ->
            try {
                val version = SemanticVersion(1, 0, i)
                versionManager.updateVersion(version, ReleaseStage.DEV)
                successCount++
            } catch (e: Exception) {
                failCount++
            }
        }
        
        val successRate = successCount.toDouble() / 100
        assertTrue(successRate >= 0.99, "æˆåŠŸç‡ ${successRate * 100}% ä½äº99%è¦æ±‚")
    }
}
```

#### 5.3 æ€§èƒ½ç›‘æ§é›†æˆ

```kotlin
/**
 * æ€§èƒ½ç›‘æ§å™¨
 * ç”¨äºæ”¶é›†å’ŒæŠ¥å‘Šç‰ˆæœ¬æ›´æ–°è¿‡ç¨‹ä¸­çš„æ€§èƒ½æŒ‡æ ‡
 */
class PerformanceMonitor {
    
    private val metrics = mutableMapOf<String, Long>()
    private var startMemory: Long = 0
    
    fun startMonitoring() {
        val runtime = Runtime.getRuntime()
        runtime.gc()
        startMemory = runtime.totalMemory() - runtime.freeMemory()
    }
    
    fun recordMetric(name: String, durationMs: Long) {
        metrics[name] = durationMs
    }
    
    fun <T> measureTime(name: String, block: () -> T): T {
        val start = System.currentTimeMillis()
        val result = block()
        val duration = System.currentTimeMillis() - start
        recordMetric(name, duration)
        return result
    }
    
    fun generateReport(): PerformanceReport {
        val runtime = Runtime.getRuntime()
        val endMemory = runtime.totalMemory() - runtime.freeMemory()
        val memoryUsed = (endMemory - startMemory) / (1024 * 1024)
        
        return PerformanceReport(
            metrics = metrics.toMap(),
            memoryUsedMB = memoryUsed,
            timestamp = System.currentTimeMillis()
        )
    }
}

data class PerformanceReport(
    val metrics: Map<String, Long>,
    val memoryUsedMB: Long,
    val timestamp: Long
) {
    fun toJson(): String = Json.encodeToString(this)
    
    fun printSummary() {
        println("========== æ€§èƒ½æŠ¥å‘Š ==========")
        metrics.forEach { (name, duration) ->
            println("$name: ${duration}ms")
        }
        println("å†…å­˜ä½¿ç”¨: ${memoryUsedMB}MB")
        println("==============================")
    }
}
```

### 6. å¤šå¹³å°å…¼å®¹æ€§æµ‹è¯•

#### 6.1 æµ‹è¯•å¹³å°çŸ©é˜µ

| å¹³å° | æ“ä½œç³»ç»Ÿç‰ˆæœ¬ | JDKç‰ˆæœ¬ | Gradleç‰ˆæœ¬ | Gitç‰ˆæœ¬ |
|------|-------------|---------|------------|---------|
| Windows | Windows 10/11 | JDK 17 | 8.13 | 2.30+ |
| macOS | macOS 12+ | JDK 17 | 8.13 | 2.30+ |
| Linux | Ubuntu 20.04/22.04 | JDK 17 | 8.13 | 2.30+ |

#### 6.2 å¹³å°ç‰¹å®šæµ‹è¯•ç”¨ä¾‹

```kotlin
class PlatformCompatibilityTest {
    
    @Test
    fun `file paths work correctly on current platform`() {
        val projectDir = File(System.getProperty("user.dir"))
        val versionManager = VersionManager(projectDir)
        
        // éªŒè¯è·¯å¾„åˆ†éš”ç¬¦å¤„ç†æ­£ç¡®
        val gradleProperties = File(projectDir, "gradle.properties")
        assertTrue(gradleProperties.exists() || !gradleProperties.exists())
        
        // éªŒè¯è·¯å¾„è§„èŒƒåŒ–
        val normalizedPath = gradleProperties.canonicalPath
        assertFalse(normalizedPath.contains("//"))
        assertFalse(normalizedPath.contains("\\\\"))
    }
    
    @Test
    fun `git commands execute correctly on current platform`() {
        val parser = CommitParser(testProjectDir)
        
        // éªŒè¯Gitå‘½ä»¤å¯ä»¥æ‰§è¡Œ
        val gitVersion = ProcessBuilder("git", "--version")
            .directory(testProjectDir)
            .start()
            .inputStream
            .bufferedReader()
            .readText()
        
        assertTrue(gitVersion.contains("git version"))
    }
    
    @Test
    fun `line endings are handled correctly`() {
        val testFile = File(testProjectDir, "test.properties")
        testFile.writeText("key=value\n")
        
        val content = testFile.readText()
        
        // éªŒè¯è¯»å–çš„å†…å®¹ä¸å—å¹³å°å½±å“
        assertTrue(content.contains("key=value"))
    }
    
    @Test
    fun `file permissions are set correctly`() {
        val scriptFile = File(testProjectDir, "scripts/release.sh")
        scriptFile.parentFile.mkdirs()
        scriptFile.writeText("#!/bin/bash\necho 'test'")
        
        if (!System.getProperty("os.name").lowercase().contains("windows")) {
            // Unixç³»ç»Ÿè®¾ç½®æ‰§è¡Œæƒé™
            scriptFile.setExecutable(true)
            assertTrue(scriptFile.canExecute())
        }
    }
}
```

#### 6.3 CI/CDå¤šå¹³å°æµ‹è¯•é…ç½®

```yaml
# .github/workflows/test-multiplatform.yml
name: Multi-Platform Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        java: ['17']
        gradle: ['8.13']
        
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: ${{ matrix.gradle }}
          
      - name: Run Tests
        run: ./gradlew test --info
        
      - name: Run Version Update (Dry Run)
        run: ./gradlew updateVersionAndIcon --stage=dev --dry-run
        
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}
          path: '**/build/reports/tests/'
```

---

## ğŸ“… å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€æ¶æ„æ­å»ºï¼ˆ2å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ | ä¾èµ– |
|--------|----------|----------|--------|------|
| T1-01 | åˆ›å»ºbuildSrcæ¨¡å—ç»“æ„ | 2h | P0 | - |
| T1-02 | å®ç°SemanticVersionæ•°æ®ç±» | 2h | P0 | T1-01 |
| T1-03 | å®ç°CommitParseræäº¤è§£æå™¨ | 3h | P0 | T1-01 |
| T1-04 | å®ç°VersionCalculatorç‰ˆæœ¬è®¡ç®—å™¨ | 2h | P0 | T1-02 |
| T1-05 | å®ç°VersionManagerç‰ˆæœ¬ç®¡ç†å™¨ | 3h | P0 | T1-02 |
| T1-06 | ç¼–å†™Phase 1å•å…ƒæµ‹è¯• | 2h | P0 | T1-02~T1-05 |

### Phase 2: å›¾æ ‡ç®¡ç†å®ç°ï¼ˆ1.5å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ | ä¾èµ– |
|--------|----------|----------|--------|------|
| T2-01 | å®šä¹‰ReleaseStageæšä¸¾ | 1h | P0 | - |
| T2-02 | åˆ›å»ºå›¾æ ‡èµ„æºç›®å½•ç»“æ„ | 2h | P0 | - |
| T2-03 | è®¾è®¡å¹¶å‡†å¤‡4å¥—å›¾æ ‡èµ„æº | 4h | P0 | T2-01 |
| T2-04 | å®ç°IconManagerå›¾æ ‡ç®¡ç†å™¨ | 3h | P0 | T2-01, T2-02 |
| T2-05 | åˆ›å»ºicon-mapping.jsoné…ç½® | 1h | P0 | T2-02 |
| T2-06 | ç¼–å†™Phase 2å•å…ƒæµ‹è¯• | 2h | P0 | T2-04 |

### Phase 3: å¤‡ä»½ä¸é”™è¯¯å¤„ç†ï¼ˆ1å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ | ä¾èµ– |
|--------|----------|----------|--------|------|
| T3-01 | å®ç°BackupManagerå¤‡ä»½ç®¡ç†å™¨ | 3h | P0 | - |
| T3-02 | å®ç°FileLockManageræ–‡ä»¶é” | 2h | P0 | - |
| T3-03 | å®šä¹‰VersionUpdateErroré”™è¯¯ç±»å‹ | 1h | P0 | - |
| T3-04 | å®ç°é”™è¯¯å¤„ç†å’Œå›æ»šé€»è¾‘ | 2h | P0 | T3-01, T3-03 |
| T3-05 | ç¼–å†™Phase 3å•å…ƒæµ‹è¯• | 2h | P0 | T3-01~T3-04 |

### Phase 4: Gradleä»»åŠ¡é›†æˆï¼ˆ1.5å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ | ä¾èµ– |
|--------|----------|----------|--------|------|
| T4-01 | å®ç°VersionUpdatePluginæ’ä»¶ | 2h | P0 | Phase 1-3 |
| T4-02 | å®ç°UpdateVersionAndIconTaskä¸»ä»»åŠ¡ | 3h | P0 | T4-01 |
| T4-03 | å®ç°å­ä»»åŠ¡ï¼ˆupdateVersion, updateIconç­‰ï¼‰ | 2h | P1 | T4-01 |
| T4-04 | æ·»åŠ å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ | 1h | P0 | T4-02 |
| T4-05 | åˆ›å»ºversion-config.jsoné…ç½® | 1h | P0 | - |
| T4-06 | ç¼–å†™Phase 4é›†æˆæµ‹è¯• | 2h | P0 | T4-01~T4-05 |

### Phase 5: CI/CDä¸æ–‡æ¡£ï¼ˆ1å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ | ä¾èµ– |
|--------|----------|----------|--------|------|
| T5-01 | åˆ›å»ºGitHub Actionså·¥ä½œæµ | 2h | P1 | Phase 4 |
| T5-02 | åˆ›å»ºæœ¬åœ°å‘å¸ƒè„šæœ¬ | 1h | P1 | Phase 4 |
| T5-03 | å®ç°ChangelogGenerator | 2h | P2 | Phase 1 |
| T5-04 | ç¼–å†™ä½¿ç”¨æ–‡æ¡£ | 2h | P1 | Phase 4 |
| T5-05 | ç«¯åˆ°ç«¯æµ‹è¯• | 2h | P0 | Phase 4 |

### æ€»å·¥æœŸä¼°ç®—

| é˜¶æ®µ | å·¥æœŸ | ç´¯è®¡ |
|------|------|------|
| Phase 1: åŸºç¡€æ¶æ„ | 2å¤© | 2å¤© |
| Phase 2: å›¾æ ‡ç®¡ç† | 1.5å¤© | 3.5å¤© |
| Phase 3: å¤‡ä»½ä¸é”™è¯¯å¤„ç† | 1å¤© | 4.5å¤© |
| Phase 4: Gradleä»»åŠ¡é›†æˆ | 1.5å¤© | 6å¤© |
| Phase 5: CI/CDä¸æ–‡æ¡£ | 1å¤© | 7å¤© |
| **æ€»è®¡** | **7å¤©** | - |

---

## ğŸ”— ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ

### 12.1 ä¸ç°æœ‰æ„å»ºç³»ç»Ÿé›†æˆ

#### 12.1.1 Gradleæ„å»ºé›†æˆ

**é›†æˆæ–¹å¼**ï¼šé€šè¿‡buildSrcæ¨¡å—å°†ç‰ˆæœ¬æ›´æ–°åŠŸèƒ½é›†æˆåˆ°ç°æœ‰Gradleæ„å»ºç³»ç»Ÿ

```kotlin
// settings.gradle.kts - å¯ç”¨buildSrc
includeBuild("buildSrc")

// app/build.gradle.kts - åº”ç”¨ç‰ˆæœ¬æ›´æ–°æ’ä»¶
plugins {
    id("com.empathy.ai.version-update")
}

versionUpdate {
    stage.set("production")
    force.set(false)
    dryRun.set(false)
}
```

**ä»»åŠ¡ä¾èµ–å…³ç³»**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Gradleä»»åŠ¡ä¾èµ–å›¾                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  preBuild â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚      â”‚                                                  â”‚   â”‚
â”‚      â–¼                                                  â”‚   â”‚
â”‚  updateVersionAndIcon (å¯é€‰ï¼Œæ‰‹åŠ¨è§¦å‘)                   â”‚   â”‚
â”‚      â”‚                                                  â”‚   â”‚
â”‚      â”œâ”€â”€ analyzeCommits                                 â”‚   â”‚
â”‚      â”‚       â”‚                                          â”‚   â”‚
â”‚      â”‚       â–¼                                          â”‚   â”‚
â”‚      â”œâ”€â”€ calculateVersion                               â”‚   â”‚
â”‚      â”‚       â”‚                                          â”‚   â”‚
â”‚      â”‚       â–¼                                          â”‚   â”‚
â”‚      â”œâ”€â”€ backupFiles                                    â”‚   â”‚
â”‚      â”‚       â”‚                                          â”‚   â”‚
â”‚      â”‚       â–¼                                          â”‚   â”‚
â”‚      â”œâ”€â”€ updateVersion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚      â”‚       â”‚                                     â”‚    â”‚   â”‚
â”‚      â”‚       â–¼                                     â”‚    â”‚   â”‚
â”‚      â”œâ”€â”€ updateIcon                                â”‚    â”‚   â”‚
â”‚      â”‚       â”‚                                     â”‚    â”‚   â”‚
â”‚      â”‚       â–¼                                     â”‚    â”‚   â”‚
â”‚      â””â”€â”€ verifyUpdate                              â”‚    â”‚   â”‚
â”‚              â”‚                                     â”‚    â”‚   â”‚
â”‚              â–¼                                     â–¼    â”‚   â”‚
â”‚  assembleDebug / assembleRelease â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 12.1.2 ä¸ç°æœ‰æ¨¡å—çš„é›†æˆ

| æ¨¡å— | é›†æˆæ–¹å¼ | å½±å“èŒƒå›´ |
|------|----------|----------|
| :app | ç‰ˆæœ¬å·å®šä¹‰ã€å›¾æ ‡èµ„æº | versionCode/versionNameã€mipmapèµ„æº |
| :domain | æ— ç›´æ¥å½±å“ | - |
| :data | BuildConfigç‰ˆæœ¬å¼•ç”¨ | æ—¥å¿—è®°å½•ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯ |
| :presentation | BuildConfigç‰ˆæœ¬å¼•ç”¨ | å…³äºé¡µé¢ç‰ˆæœ¬æ˜¾ç¤º |

### 12.2 ä¸CI/CDç³»ç»Ÿé›†æˆ

#### 12.2.1 GitHub Actionsé›†æˆå¢å¼º

```yaml
# .github/workflows/release.yml - å¢å¼ºç‰ˆ
name: Release with Version Update

on:
  push:
    branches: [main, 'release/*']
    tags: ['v*']
  workflow_dispatch:
    inputs:
      stage:
        description: 'å‘å¸ƒé˜¶æ®µ'
        required: true
        default: 'production'
        type: choice
        options: [dev, test, beta, production]

env:
  JAVA_VERSION: '17'
  GRADLE_VERSION: '8.13'

jobs:
  version-update:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          
      - name: Update Version
        id: version
        run: |
          ./gradlew updateVersionAndIcon --stage=${{ github.event.inputs.stage || 'production' }}
          VERSION=$(grep 'APP_VERSION_NAME' gradle.properties | cut -d'=' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Build APK
        run: ./gradlew assembleRelease
        
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ steps.version.outputs.version }}
          path: app/build/outputs/apk/release/*.apk
          
  # é”™è¯¯å¤„ç†å’Œå›æ»š
  rollback:
    runs-on: ubuntu-latest
    needs: version-update
    if: failure()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Rollback Version
        run: |
          ./gradlew rollbackVersion
          echo "ç‰ˆæœ¬å·²å›æ»š"
```

#### 12.2.2 æœ¬åœ°å¼€å‘é›†æˆ

**å¼€å‘è€…å·¥ä½œæµ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¼€å‘è€…å·¥ä½œæµ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. å¼€å‘é˜¶æ®µ                                                â”‚
â”‚     git commit -m "feat: æ·»åŠ æ–°åŠŸèƒ½"                        â”‚
â”‚     git commit -m "fix: ä¿®å¤é—®é¢˜"                           â”‚
â”‚                                                             â”‚
â”‚  2. å‡†å¤‡å‘å¸ƒ                                                â”‚
â”‚     ./gradlew updateVersionAndIcon --stage=beta --dry-run   â”‚
â”‚     # é¢„è§ˆå°†è¦æ‰§è¡Œçš„å˜æ›´                                     â”‚
â”‚                                                             â”‚
â”‚  3. æ‰§è¡Œå‘å¸ƒ                                                â”‚
â”‚     ./gradlew updateVersionAndIcon --stage=beta             â”‚
â”‚     # æ›´æ–°ç‰ˆæœ¬å·å’Œå›¾æ ‡                                       â”‚
â”‚                                                             â”‚
â”‚  4. æ„å»ºAPK                                                 â”‚
â”‚     ./gradlew assembleRelease                               â”‚
â”‚                                                             â”‚
â”‚  5. æäº¤å˜æ›´                                                â”‚
â”‚     git add .                                               â”‚
â”‚     git commit -m "chore(release): v1.2.0-beta"             â”‚
â”‚     git tag v1.2.0-beta                                     â”‚
â”‚     git push origin main --tags                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.3 ä¸å¼€å‘å·¥å…·é›†æˆ

#### 12.3.1 Android Studioé›†æˆ

**Run Configurationé…ç½®**ï¼š

```xml
<!-- .idea/runConfigurations/Update_Version.xml -->
<component name="ProjectRunConfigurationManager">
  <configuration name="Update Version" type="GradleRunConfiguration">
    <ExternalSystemSettings>
      <option name="executionName" />
      <option name="externalProjectPath" value="$PROJECT_DIR$" />
      <option name="externalSystemIdString" value="GRADLE" />
      <option name="scriptParameters" value="--stage=dev" />
      <option name="taskDescriptions">
        <list />
      </option>
      <option name="taskNames">
        <list>
          <option value="updateVersionAndIcon" />
        </list>
      </option>
    </ExternalSystemSettings>
  </configuration>
</component>
```

#### 12.3.2 å‘½ä»¤è¡Œå·¥å…·é›†æˆ

**å¿«æ·è„šæœ¬**ï¼š`scripts/version.bat` (Windows)

```batch
@echo off
setlocal

if "%1"=="" (
    echo ç”¨æ³•: version.bat [å‘½ä»¤] [é€‰é¡¹]
    echo.
    echo å‘½ä»¤:
    echo   update    æ›´æ–°ç‰ˆæœ¬å·å’Œå›¾æ ‡
    echo   rollback  å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
    echo   history   æŸ¥çœ‹ç‰ˆæœ¬å†å²
    echo   current   æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬
    echo.
    echo é€‰é¡¹:
    echo   --stage=dev^|test^|beta^|production
    echo   --force
    echo   --dry-run
    exit /b 1
)

if "%1"=="update" (
    call gradlew.bat updateVersionAndIcon %2 %3 %4
) else if "%1"=="rollback" (
    call gradlew.bat rollbackVersion
) else if "%1"=="history" (
    call gradlew.bat showVersionHistory
) else if "%1"=="current" (
    call gradlew.bat showCurrentVersion
) else (
    echo æœªçŸ¥å‘½ä»¤: %1
    exit /b 1
)
```

---

## âš ï¸ é£é™©è¯„ä¼°

### 13.1 æŠ€æœ¯é£é™©

| é£é™©ID | é£é™©æè¿° | æ¦‚ç‡ | å½±å“ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|--------|----------|------|------|----------|----------|
| TR-01 | Gitæäº¤ä¿¡æ¯ä¸è§„èŒƒå¯¼è‡´ç‰ˆæœ¬å·è®¡ç®—é”™è¯¯ | é«˜ | ä¸­ | ğŸŸ¡ ä¸­ | æä¾›æäº¤ä¿¡æ¯æ ¡éªŒé’©å­ï¼Œå¼ºåˆ¶è§„èŒƒæ ¼å¼ |
| TR-02 | å›¾æ ‡æ–‡ä»¶æŸåå¯¼è‡´åº”ç”¨æ— æ³•å¯åŠ¨ | ä½ | é«˜ | ğŸŸ¡ ä¸­ | å¤‡ä»½æœºåˆ¶ + å›¾æ ‡å®Œæ•´æ€§æ ¡éªŒ |
| TR-03 | å¹¶å‘æ‰§è¡Œå¯¼è‡´æ–‡ä»¶å†²çª | ä¸­ | ä¸­ | ğŸŸ¡ ä¸­ | æ–‡ä»¶é”æœºåˆ¶ + é˜Ÿåˆ—å¤„ç† |
| TR-04 | Gradleç‰ˆæœ¬ä¸å…¼å®¹ | ä½ | é«˜ | ğŸŸ¡ ä¸­ | ç‰ˆæœ¬æ£€æŸ¥ + å…¼å®¹æ€§æµ‹è¯• |
| TR-05 | å¤‡ä»½æ¢å¤å¤±è´¥ | ä½ | é«˜ | ğŸŸ¡ ä¸­ | å¤šçº§å¤‡ä»½ + æ¢å¤æµ‹è¯• |

### 13.2 ä¸šåŠ¡é£é™©

| é£é™©ID | é£é™©æè¿° | æ¦‚ç‡ | å½±å“ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|--------|----------|------|------|----------|----------|
| BR-01 | ç‰ˆæœ¬å·è·³è·ƒå¯¼è‡´ç”¨æˆ·å›°æƒ‘ | ä¸­ | ä½ | ğŸŸ¢ ä½ | ç‰ˆæœ¬å·å˜æ›´æ—¥å¿— + ç”¨æˆ·é€šçŸ¥ |
| BR-02 | é”™è¯¯çš„å‘å¸ƒé˜¶æ®µå›¾æ ‡ | ä½ | ä¸­ | ğŸŸ¢ ä½ | å‘å¸ƒå‰é¢„è§ˆ + äººå·¥ç¡®è®¤ |
| BR-03 | è‡ªåŠ¨åŒ–æµç¨‹ä¸­æ–­å½±å“å‘å¸ƒ | ä¸­ | é«˜ | ğŸŸ¡ ä¸­ | æ‰‹åŠ¨å›é€€æ–¹æ¡ˆ + ç›‘æ§å‘Šè­¦ |
| BR-04 | å›¢é˜Ÿæˆå‘˜ä¸ç†Ÿæ‚‰æ–°æµç¨‹ | é«˜ | ä¸­ | ğŸŸ¡ ä¸­ | åŸ¹è®­æ–‡æ¡£ + æ“ä½œæŒ‡å— |

### 13.3 ç¼“è§£æªæ–½è¯¦ç»†æ–¹æ¡ˆ

#### TR-01: Gitæäº¤ä¿¡æ¯è§„èŒƒåŒ–

**è§£å†³æ–¹æ¡ˆ**ï¼šæ·»åŠ Gitæäº¤é’©å­

```bash
# .git/hooks/commit-msg
#!/bin/bash

commit_msg=$(cat "$1")
pattern="^(feat|fix|docs|style|refactor|perf|test|chore|ci)(\(.+\))?(!)?: .+"

if ! echo "$commit_msg" | grep -qE "$pattern"; then
    echo "âŒ æäº¤ä¿¡æ¯æ ¼å¼é”™è¯¯!"
    echo "æ­£ç¡®æ ¼å¼: <type>(<scope>): <subject>"
    echo "ç¤ºä¾‹: feat(version): æ·»åŠ ç‰ˆæœ¬è‡ªåŠ¨æ›´æ–°åŠŸèƒ½"
    echo ""
    echo "å…è®¸çš„type: feat, fix, docs, style, refactor, perf, test, chore, ci"
    exit 1
fi
```

#### TR-02: å›¾æ ‡å®Œæ•´æ€§æ ¡éªŒ

```kotlin
/**
 * å›¾æ ‡å®Œæ•´æ€§æ ¡éªŒå™¨
 */
class IconValidator {
    
    /**
     * æ ¡éªŒå›¾æ ‡æ–‡ä»¶å®Œæ•´æ€§
     */
    fun validateIcon(iconFile: File): ValidationResult {
        // 1. æ£€æŸ¥æ–‡ä»¶å­˜åœ¨
        if (!iconFile.exists()) {
            return ValidationResult.Error("æ–‡ä»¶ä¸å­˜åœ¨: ${iconFile.path}")
        }
        
        // 2. æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (iconFile.length() < 100) {
            return ValidationResult.Error("æ–‡ä»¶è¿‡å°ï¼Œå¯èƒ½å·²æŸå: ${iconFile.path}")
        }
        
        // 3. æ£€æŸ¥PNGæ ¼å¼
        val header = iconFile.inputStream().use { it.readNBytes(8) }
        val pngSignature = byteArrayOf(
            0x89.toByte(), 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A
        )
        if (!header.contentEquals(pngSignature)) {
            return ValidationResult.Error("ä¸æ˜¯æœ‰æ•ˆçš„PNGæ–‡ä»¶: ${iconFile.path}")
        }
        
        return ValidationResult.Success
    }
}
```

#### BR-03: æ‰‹åŠ¨å›é€€æ–¹æ¡ˆ

```markdown
## ç´§æ€¥å›é€€æµç¨‹

å½“è‡ªåŠ¨åŒ–æµç¨‹å¤±è´¥æ—¶ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨å›é€€ï¼š

1. **åœæ­¢å½“å‰æ„å»º**
   ```bash
   ./gradlew --stop
   ```

2. **æ¢å¤å¤‡ä»½**
   ```bash
   ./gradlew rollbackVersion --backup=latest
   ```

3. **éªŒè¯æ¢å¤ç»“æœ**
   ```bash
   ./gradlew showCurrentVersion
   ```

4. **å¦‚æœè‡ªåŠ¨æ¢å¤å¤±è´¥ï¼Œæ‰‹åŠ¨æ¢å¤**
   ```bash
   # ä»å¤‡ä»½ç›®å½•å¤åˆ¶æ–‡ä»¶
   cp backups/version-update/latest/gradle.properties .
   cp -r backups/version-update/latest/app/src/main/res/mipmap-* app/src/main/res/
   ```

5. **é€šçŸ¥å›¢é˜Ÿ**
   - å‘é€é‚®ä»¶/æ¶ˆæ¯é€šçŸ¥ç›¸å…³äººå‘˜
   - è®°å½•é—®é¢˜åˆ°Issueè·Ÿè¸ªç³»ç»Ÿ
```

---

## ğŸ”Œ åŠŸèƒ½é›†æˆè®¾è®¡

### 14.1 å¯¼èˆªé›†æˆæ–¹æ¡ˆ

ç”±äºç‰ˆæœ¬æ›´æ–°åŠŸèƒ½ä¸»è¦æ˜¯æ„å»ºæ—¶å·¥å…·ï¼Œä¸éœ€è¦åœ¨åº”ç”¨UIä¸­é›†æˆå¯¼èˆªã€‚ä½†ç‰ˆæœ¬ä¿¡æ¯éœ€è¦åœ¨åº”ç”¨ä¸­å±•ç¤ºï¼š

**ç‰ˆæœ¬ä¿¡æ¯å±•ç¤ºä½ç½®**ï¼š

```kotlin
// presentation/ui/screen/settings/SettingsScreen.kt
@Composable
fun SettingsScreen() {
    // ... å…¶ä»–è®¾ç½®é¡¹
    
    // å…³äºä¿¡æ¯åŒºåŸŸ
    IOSSettingsSection(title = "å…³äº") {
        IOSSettingsItem(
            title = "ç‰ˆæœ¬",
            value = BuildConfig.VERSION_NAME,
            showArrow = false
        )
        IOSSettingsItem(
            title = "æ„å»ºå·",
            value = BuildConfig.VERSION_CODE.toString(),
            showArrow = false
        )
        IOSSettingsItem(
            title = "å‘å¸ƒé˜¶æ®µ",
            value = BuildConfig.RELEASE_STAGE,
            showArrow = false
        )
    }
}
```

### 14.2 DIæ¨¡å—é›†æˆæ–¹æ¡ˆ

**ç‰ˆæœ¬ä¿¡æ¯æä¾›æ¨¡å—**ï¼š

```kotlin
// app/src/main/kotlin/com/empathy/ai/di/VersionModule.kt
@Module
@InstallIn(SingletonComponent::class)
object VersionModule {
    
    @Provides
    @Singleton
    fun provideVersionInfo(): VersionInfo {
        return VersionInfo(
            versionName = BuildConfig.VERSION_NAME,
            versionCode = BuildConfig.VERSION_CODE,
            releaseStage = BuildConfig.RELEASE_STAGE,
            buildTime = BuildConfig.BUILD_TIME
        )
    }
}

/**
 * ç‰ˆæœ¬ä¿¡æ¯æ•°æ®ç±»
 */
data class VersionInfo(
    val versionName: String,
    val versionCode: Int,
    val releaseStage: String,
    val buildTime: String
)
```

**BuildConfigé…ç½®**ï¼š

```kotlin
// app/build.gradle.kts
android {
    buildFeatures {
        buildConfig = true
    }
    
    defaultConfig {
        buildConfigField("String", "RELEASE_STAGE", 
            "\"${property("APP_RELEASE_STAGE")}\"")
        buildConfigField("String", "BUILD_TIME", 
            "\"${java.time.Instant.now()}\"")
    }
}
```

### 14.3 æ•°æ®åº“é›†æˆæ–¹æ¡ˆ

**ç‰ˆæœ¬å†å²è®°å½•è¡¨è®¾è®¡**ï¼ˆå¯é€‰ï¼Œç”¨äºåº”ç”¨å†…å±•ç¤ºç‰ˆæœ¬å†å²ï¼‰ï¼š

```kotlin
// data/src/main/kotlin/com/empathy/ai/data/local/entity/VersionHistoryEntity.kt
@Entity(tableName = "version_history")
data class VersionHistoryEntity(
    @PrimaryKey
    @ColumnInfo(name = "version")
    val version: String,
    
    @ColumnInfo(name = "version_code")
    val versionCode: Int,
    
    @ColumnInfo(name = "release_stage")
    val releaseStage: String,
    
    @ColumnInfo(name = "release_date")
    val releaseDate: Long,
    
    @ColumnInfo(name = "changelog")
    val changelog: String
)

// data/src/main/kotlin/com/empathy/ai/data/local/dao/VersionHistoryDao.kt
@Dao
interface VersionHistoryDao {
    
    @Query("SELECT * FROM version_history ORDER BY release_date DESC")
    fun getAllVersions(): Flow<List<VersionHistoryEntity>>
    
    @Query("SELECT * FROM version_history WHERE version = :version")
    suspend fun getVersion(version: String): VersionHistoryEntity?
    
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertVersion(version: VersionHistoryEntity)
}
```

**æ•°æ®åº“è¿ç§»**ï¼š

```kotlin
// data/src/main/kotlin/com/empathy/ai/data/local/AppDatabase.kt
@Database(
    entities = [
        // ... ç°æœ‰å®ä½“
        VersionHistoryEntity::class  // æ–°å¢
    ],
    version = 12,  // ç‰ˆæœ¬å·é€’å¢
    exportSchema = true
)
abstract class AppDatabase : RoomDatabase() {
    // ... ç°æœ‰DAO
    abstract fun versionHistoryDao(): VersionHistoryDao
}

// è¿ç§»è„šæœ¬
val MIGRATION_11_12 = object : Migration(11, 12) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS version_history (
                version TEXT PRIMARY KEY NOT NULL,
                version_code INTEGER NOT NULL,
                release_stage TEXT NOT NULL,
                release_date INTEGER NOT NULL,
                changelog TEXT NOT NULL
            )
        """)
    }
}
```

### 14.4 å…¥å£ç‚¹å®šä¹‰

| å…¥å£ç‚¹ | è§¦å‘æ–¹å¼ | ä½¿ç”¨åœºæ™¯ |
|--------|----------|----------|
| Gradleå‘½ä»¤è¡Œ | `./gradlew updateVersionAndIcon` | å¼€å‘è€…æœ¬åœ°å‘å¸ƒ |
| GitHub Actions | Pushåˆ°main/releaseåˆ†æ”¯ | CI/CDè‡ªåŠ¨å‘å¸ƒ |
| Android Studio | Run Configuration | IDEå†…å¿«æ·æ“ä½œ |
| å¿«æ·è„šæœ¬ | `scripts/version.bat update` | ç®€åŒ–å‘½ä»¤è¡Œæ“ä½œ |

### 14.5 è°ƒç”¨é“¾å®Œæ•´æ€§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®Œæ•´è°ƒç”¨é“¾                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  è§¦å‘å…¥å£                                                        â”‚
â”‚  â”œâ”€â”€ Gradle CLI: ./gradlew updateVersionAndIcon                 â”‚
â”‚  â”œâ”€â”€ GitHub Actions: workflow_dispatch / push                   â”‚
â”‚  â””â”€â”€ Android Studio: Run Configuration                          â”‚
â”‚          â”‚                                                      â”‚
â”‚          â–¼                                                      â”‚
â”‚  VersionUpdatePlugin.apply()                                    â”‚
â”‚          â”‚                                                      â”‚
â”‚          â–¼                                                      â”‚
â”‚  UpdateVersionAndIconTask.execute()                             â”‚
â”‚          â”‚                                                      â”‚
â”‚          â”œâ”€â”€ CommitParser.parseCommitsSinceLastTag()            â”‚
â”‚          â”‚       â”‚                                              â”‚
â”‚          â”‚       â””â”€â”€ Gitå‘½ä»¤: git log --oneline                 â”‚
â”‚          â”‚                                                      â”‚
â”‚          â”œâ”€â”€ VersionCalculator.calculateNextVersion()           â”‚
â”‚          â”‚       â”‚                                              â”‚
â”‚          â”‚       â””â”€â”€ è¯­ä¹‰åŒ–ç‰ˆæœ¬è®¡ç®—                              â”‚
â”‚          â”‚                                                      â”‚
â”‚          â”œâ”€â”€ BackupManager.createBackup()                       â”‚
â”‚          â”‚       â”‚                                              â”‚
â”‚          â”‚       â””â”€â”€ æ–‡ä»¶ç³»ç»Ÿæ“ä½œ                                â”‚
â”‚          â”‚                                                      â”‚
â”‚          â”œâ”€â”€ VersionManager.updateVersion()                     â”‚
â”‚          â”‚       â”‚                                              â”‚
â”‚          â”‚       â””â”€â”€ æ›´æ–°gradle.properties                      â”‚
â”‚          â”‚                                                      â”‚
â”‚          â”œâ”€â”€ IconManager.switchToStage()                        â”‚
â”‚          â”‚       â”‚                                              â”‚
â”‚          â”‚       â””â”€â”€ å¤åˆ¶å›¾æ ‡æ–‡ä»¶åˆ°mipmapç›®å½•                    â”‚
â”‚          â”‚                                                      â”‚
â”‚          â””â”€â”€ VersionManager.updateVersionHistory()              â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â””â”€â”€ æ›´æ–°version-history.json                   â”‚
â”‚                                                                 â”‚
â”‚  åç»­æ„å»º                                                        â”‚
â”‚  â””â”€â”€ assembleRelease                                            â”‚
â”‚          â”‚                                                      â”‚
â”‚          â”œâ”€â”€ è¯»å–gradle.propertiesä¸­çš„ç‰ˆæœ¬å·                     â”‚
â”‚          â”œâ”€â”€ ä½¿ç”¨æ›´æ–°åçš„å›¾æ ‡èµ„æº                                â”‚
â”‚          â””â”€â”€ ç”Ÿæˆå¸¦æ­£ç¡®ç‰ˆæœ¬ä¿¡æ¯çš„APK                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] æ‰§è¡Œ`./gradlew updateVersionAndIcon`èƒ½å¤Ÿæ­£ç¡®æ›´æ–°ç‰ˆæœ¬å·å’Œå›¾æ ‡
- [ ] ç‰ˆæœ¬å·æ ¹æ®Gitæäº¤ä¿¡æ¯æ­£ç¡®é€’å¢ï¼ˆfeatâ†’minor, fixâ†’patch, feat!â†’majorï¼‰
- [ ] ä¸åŒå‘å¸ƒé˜¶æ®µçš„å›¾æ ‡èƒ½å¤Ÿæ­£ç¡®åˆ‡æ¢
- [ ] `--dry-run`æ¨¡å¼åªæ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„æ“ä½œï¼Œä¸å®é™…ä¿®æ”¹æ–‡ä»¶
- [ ] `--force`æ¨¡å¼èƒ½å¤Ÿå¼ºåˆ¶æ›´æ–°ç‰ˆæœ¬å·
- [ ] å¤šæ¨¡å—ç‰ˆæœ¬å·ä¿æŒä¸€è‡´

### æ€§èƒ½éªŒæ”¶

- [ ] æ›´æ–°æµç¨‹å®Œæˆæ—¶é—´ < 30ç§’
- [ ] å†…å­˜å ç”¨å³°å€¼ < 100MB
- [ ] è¿ç»­æ‰§è¡Œ100æ¬¡æ›´æ–°ï¼ŒæˆåŠŸç‡ > 99%

### å¯é æ€§éªŒæ”¶

- [ ] æ›´æ–°å¤±è´¥æ—¶èƒ½å¤Ÿè‡ªåŠ¨å›æ»š
- [ ] å¤‡ä»½æ–‡ä»¶èƒ½å¤Ÿæ­£ç¡®æ¢å¤
- [ ] æ–‡ä»¶é”æœºåˆ¶èƒ½å¤Ÿé˜²æ­¢å¹¶å‘å†²çª
- [ ] é”™è¯¯ä¿¡æ¯æ¸…æ™°æ˜ç¡®

### å…¼å®¹æ€§éªŒæ”¶

- [ ] åœ¨Windowsã€macOSã€Linuxä¸‰ä¸ªå¹³å°ä¸Šéƒ½èƒ½æ­£å¸¸è¿è¡Œ
- [ ] å…¼å®¹Gradle 8.0åŠä»¥ä¸Šç‰ˆæœ¬
- [ ] å…¼å®¹Git 2.30åŠä»¥ä¸Šç‰ˆæœ¬

### æµ‹è¯•éªŒæ”¶

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] é›†æˆæµ‹è¯•è¦†ç›–å…³é”®æµç¨‹
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡

---

## ğŸ“ é™„å½•

### A. ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| PRD-00024 | `æ–‡æ¡£/å¼€å‘æ–‡æ¡£/PRD/PRD-00024-å›¾æ ‡å’Œç‰ˆæœ¬å·è‡ªåŠ¨æ›´æ–°.md` | äº§å“éœ€æ±‚æ–‡æ¡£ |
| TDD-00024 | `æ–‡æ¡£/å¼€å‘æ–‡æ¡£/TDD/TDD-00024-å›¾æ ‡å’Œç‰ˆæœ¬å·è‡ªåŠ¨æ›´æ–°æŠ€æœ¯è®¾è®¡.md` | æŠ€æœ¯è®¾è®¡æ–‡æ¡£ï¼ˆå¾…åˆ›å»ºï¼‰ |
| TD-00024 | `æ–‡æ¡£/å¼€å‘æ–‡æ¡£/TD/TD-00024-å›¾æ ‡å’Œç‰ˆæœ¬å·è‡ªåŠ¨æ›´æ–°ä»»åŠ¡æ¸…å•.md` | ä»»åŠ¡æ¸…å•ï¼ˆå¾…åˆ›å»ºï¼‰ |

### B. å‚è€ƒèµ„æ–™

- [Semantic Versioning 2.0.0](https://semver.org/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Gradle Custom Plugins](https://docs.gradle.org/current/userguide/custom_plugins.html)
- [Android App Versioning](https://developer.android.com/studio/publish/versioning)

### C. æœ¯è¯­è¡¨

| æœ¯è¯­ | è§£é‡Š |
|------|------|
| Semantic Versioning | è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶ï¼Œæ ¼å¼ä¸ºmajor.minor.patch |
| Conventional Commits | çº¦å®šå¼æäº¤ï¼Œè§„èŒƒåŒ–çš„Gitæäº¤ä¿¡æ¯æ ¼å¼ |
| buildSrc | Gradleç‰¹æ®Šç›®å½•ï¼Œç”¨äºå­˜æ”¾æ„å»ºé€»è¾‘ä»£ç  |
| versionCode | Androidåº”ç”¨çš„æ•´æ•°ç‰ˆæœ¬å·ï¼Œç”¨äºåº”ç”¨å•†åº—ç‰ˆæœ¬æ¯”è¾ƒ |
| versionName | Androidåº”ç”¨çš„å­—ç¬¦ä¸²ç‰ˆæœ¬å·ï¼Œç”¨äºç”¨æˆ·å±•ç¤º |

---

## ğŸ“ å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | å˜æ›´äºº |
|------|------|----------|--------|
| v1.0 | 2025-12-31 | åˆå§‹ç‰ˆæœ¬ | Kiro |
| v1.1 | 2025-12-31 | æ ¹æ®DR-00024å®¡æŸ¥æŠ¥å‘Šä¿®æ”¹ï¼š<br>- æ–°å¢ç¬¬12ç« ï¼šç³»ç»Ÿé›†æˆæ–¹æ¡ˆ<br>- æ–°å¢ç¬¬13ç« ï¼šé£é™©è¯„ä¼°<br>- æ–°å¢ç¬¬14ç« ï¼šåŠŸèƒ½é›†æˆè®¾è®¡<br>- å®Œå–„æµ‹è¯•ç­–ç•¥ï¼šæ·»åŠ æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡(â‰¥80%)ã€æ€§èƒ½åŸºå‡†æµ‹è¯•æ–¹æ¡ˆã€å¤šå¹³å°å…¼å®¹æ€§æµ‹è¯•æ–¹æ³• | Kiro |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.1
**æœ€åæ›´æ–°**: 2025-12-31
**æ–‡æ¡£çŠ¶æ€**: âœ… å®¡æŸ¥é€šè¿‡
