# FD-00026 AIå†›å¸ˆå¯¹è¯åŠŸèƒ½è®¾è®¡

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç¼–å· | FD-00026 |
| åˆ›å»ºæ—¥æœŸ | 2026-01-01 |
| æ›´æ–°æ—¥æœŸ | 2026-01-01 |
| çŠ¶æ€ | è‰ç¨¿ |
| å…³è”PRD | PRD-00026 |
| å…³è”æ–‡æ¡£ | PRD-00007ã€PRD-00008ã€FD-00007ã€FD-00008 |

---

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 åŠŸèƒ½ç›®æ ‡

æ„å»ºä¸€ä¸ªç‹¬ç«‹çš„AIå†›å¸ˆå¯¹è¯ç³»ç»Ÿï¼Œæä¾›"èµ›å‰èµ›åå¤ç›˜"å¼çš„æ·±åº¦åˆ†æåŠŸèƒ½ï¼ŒåŒºåˆ«äºç°æœ‰çš„"å³æ—¶ååº”å¼"æ‚¬æµ®çª—åŠŸèƒ½ã€‚

### 1.2 æ ¸å¿ƒåŠŸèƒ½ç‚¹

| åŠŸèƒ½ç‚¹ | æè¿° |
|-------|------|
| ç‹¬ç«‹å¯¹è¯ç•Œé¢ | ç±»ä¼¼æ™®é€šAIå¯¹è¯åº”ç”¨çš„äº¤äº’ç•Œé¢ï¼ŒAIæ¶ˆæ¯å·¦ä¾§ï¼Œç”¨æˆ·æ¶ˆæ¯å³ä¾§ |
| è”ç³»äººé€‰æ‹©ä¸åˆ‡æ¢ | é¡¶éƒ¨å¯¼èˆªæ è”ç³»äººé€‰æ‹©å™¨ï¼Œæ”¯æŒåˆ‡æ¢ä¸åŒè”ç³»äºº |
| å¯¹è¯ä¼šè¯ç®¡ç† | æ¯ä¸ªè”ç³»äººç‹¬ç«‹çš„å¯¹è¯ä¼šè¯ï¼Œæ”¯æŒå¤šä¼šè¯ |
| å¯¹è¯å†å²æ•°æ®æº | åŸºäºconversation_logsè¡¨çš„å®Œæ•´å¯¹è¯å†å²è¿›è¡Œåˆ†æ |
| è”ç³»äººç”»åƒé›†æˆ | ç»“åˆè”ç³»äººçš„factsã€tagsã€ç›®æ ‡ç­‰ä¿¡æ¯ |
| ä¸“ç”¨æç¤ºè¯ç³»ç»Ÿ | ç¡¬ç¼–ç çš„AIå†›å¸ˆæç¤ºè¯ï¼Œå¼ºè°ƒå®¢è§‚å…¬æ­£ç«‹åœº |

### 1.3 ä¸ç°æœ‰åŠŸèƒ½çš„åŒºåˆ«

| ç»´åº¦ | æ‚¬æµ®çª—åŠŸèƒ½ | AIå†›å¸ˆå¯¹è¯åŠŸèƒ½ |
|------|----------|---------------|
| å®šä½ | å³æ—¶ååº”å¼ | æ·±åº¦æ€è€ƒå¼ |
| ä½¿ç”¨åœºæ™¯ | èŠå¤©è¿‡ç¨‹ä¸­å®æ—¶åˆ†æ | èµ›å‰è§„åˆ’/èµ›åå¤ç›˜ |
| æ•°æ®èŒƒå›´ | å½“å‰è¾“å…¥å†…å®¹ | å®Œæ•´å¯¹è¯å†å² |
| äº¤äº’æ–¹å¼ | æ‚¬æµ®çª—å¿«æ·æ“ä½œ | ç‹¬ç«‹å¯¹è¯ç•Œé¢ |
| å…¥å£ä½ç½® | æ‚¬æµ®çƒ | åº•éƒ¨å¯¼èˆªæ  |

---

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ¨¡å—åˆ†å¸ƒï¼ˆéµå¾ªClean Architectureï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      :app æ¨¡å—                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ AiAdvisorModule.kt (DIæ¨¡å—)                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   :domain æ¨¡å—   â”‚ â”‚   :data æ¨¡å—    â”‚ â”‚  :presentation æ¨¡å—  â”‚
â”‚                 â”‚ â”‚                 â”‚ â”‚                     â”‚
â”‚ â€¢ AiAdvisorConversation â”‚ â€¢ AiAdvisorDao â”‚ â€¢ AiAdvisorScreen    â”‚
â”‚ â€¢ AiAdvisorSession      â”‚ â€¢ AiAdvisorEntity â”‚ â€¢ AiAdvisorViewModel â”‚
â”‚ â€¢ AiAdvisorRepository   â”‚ â€¢ AiAdvisorRepositoryImpl â”‚ â€¢ å¯¹è¯ç»„ä»¶  â”‚
â”‚ â€¢ SendAdvisorMessageUseCase â”‚           â”‚                     â”‚
â”‚ â€¢ CreateAdvisorSessionUseCase â”‚         â”‚                     â”‚
â”‚ â€¢ GetAdvisorHistoryUseCase â”‚            â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµè®¾è®¡

```
ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AiAdvisorViewModel                                          â”‚
â”‚ â”œâ”€â”€ 1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°ai_advisor_conversationsè¡¨             â”‚
â”‚ â”œâ”€â”€ 2. è°ƒç”¨SendAdvisorMessageUseCase                        â”‚
â”‚ â””â”€â”€ 3. æ›´æ–°UIçŠ¶æ€                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SendAdvisorMessageUseCase                                   â”‚
â”‚ â”œâ”€â”€ 1. è·å–è”ç³»äººç”»åƒ (ContactRepository)                   â”‚
â”‚ â”œâ”€â”€ 2. è·å–å¯¹è¯å†å² (ConversationRepository)                â”‚
â”‚ â”œâ”€â”€ 3. æ„å»ºAIå†›å¸ˆæç¤ºè¯ (SystemPrompts.AI_ADVISOR)          â”‚
â”‚ â”œâ”€â”€ 4. è°ƒç”¨AIæœåŠ¡ (AiRepository)                            â”‚
â”‚ â””â”€â”€ 5. ä¿å­˜AIå›å¤åˆ°ai_advisor_conversationsè¡¨               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
AIå›å¤æ˜¾ç¤ºåœ¨å¯¹è¯ç•Œé¢
```


---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 é¢†åŸŸæ¨¡å‹ï¼ˆ:domainæ¨¡å—ï¼‰

#### 3.1.1 AiAdvisorSessionï¼ˆä¼šè¯æ¨¡å‹ï¼‰

```kotlin
/**
 * AIå†›å¸ˆä¼šè¯
 *
 * æ¯ä¸ªè”ç³»äººå¯ä»¥æœ‰å¤šä¸ªä¼šè¯ï¼Œæ¯ä¸ªä¼šè¯åŒ…å«å¤šæ¡å¯¹è¯è®°å½•
 */
data class AiAdvisorSession(
    val id: String,                    // ä¼šè¯IDï¼ˆUUIDï¼‰
    val contactId: String,             // è”ç³»äººID
    val title: String,                 // ä¼šè¯æ ‡é¢˜
    val createdAt: Long,               // åˆ›å»ºæ—¶é—´
    val updatedAt: Long,               // æœ€åæ›´æ–°æ—¶é—´
    val messageCount: Int = 0,         // æ¶ˆæ¯æ•°é‡
    val isActive: Boolean = true       // æ˜¯å¦ä¸ºæ´»è·ƒä¼šè¯
)
```

#### 3.1.2 AiAdvisorConversationï¼ˆå¯¹è¯è®°å½•æ¨¡å‹ï¼‰

```kotlin
/**
 * AIå†›å¸ˆå¯¹è¯è®°å½•
 *
 * å­˜å‚¨ç”¨æˆ·ä¸AIå†›å¸ˆçš„å¯¹è¯å†…å®¹
 */
data class AiAdvisorConversation(
    val id: String,                    // å¯¹è¯IDï¼ˆUUIDï¼‰
    val contactId: String,             // è”ç³»äººID
    val sessionId: String,             // ä¼šè¯ID
    val messageType: MessageType,      // æ¶ˆæ¯ç±»å‹ï¼šUSERæˆ–AI
    val content: String,               // æ¶ˆæ¯å†…å®¹
    val timestamp: Long,               // æ—¶é—´æˆ³
    val createdAt: Long = System.currentTimeMillis()
)

/**
 * æ¶ˆæ¯ç±»å‹æšä¸¾
 */
enum class MessageType {
    USER,   // ç”¨æˆ·æ¶ˆæ¯
    AI      // AIå›å¤
}
```

### 3.2 æ•°æ®åº“å®ä½“ï¼ˆ:dataæ¨¡å—ï¼‰

#### 3.2.1 AiAdvisorSessionEntity

```kotlin
@Entity(
    tableName = "ai_advisor_sessions",
    foreignKeys = [
        ForeignKey(
            entity = ContactProfileEntity::class,
            parentColumns = ["id"],
            childColumns = ["contact_id"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [
        Index(value = ["contact_id"]),
        Index(value = ["created_at"])
    ]
)
data class AiAdvisorSessionEntity(
    @PrimaryKey
    @ColumnInfo(name = "id")
    val id: String,
    
    @ColumnInfo(name = "contact_id")
    val contactId: String,
    
    @ColumnInfo(name = "title")
    val title: String,
    
    @ColumnInfo(name = "created_at")
    val createdAt: Long,
    
    @ColumnInfo(name = "updated_at")
    val updatedAt: Long,
    
    @ColumnInfo(name = "message_count")
    val messageCount: Int = 0,
    
    @ColumnInfo(name = "is_active")
    val isActive: Boolean = true
)
```

#### 3.2.2 AiAdvisorConversationEntity

```kotlin
@Entity(
    tableName = "ai_advisor_conversations",
    foreignKeys = [
        ForeignKey(
            entity = ContactProfileEntity::class,
            parentColumns = ["id"],
            childColumns = ["contact_id"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [
        Index(value = ["contact_id"]),
        Index(value = ["session_id"]),
        Index(value = ["timestamp"])
    ]
)
data class AiAdvisorConversationEntity(
    @PrimaryKey
    @ColumnInfo(name = "id")
    val id: String,
    
    @ColumnInfo(name = "contact_id")
    val contactId: String,
    
    @ColumnInfo(name = "session_id")
    val sessionId: String,
    
    @ColumnInfo(name = "message_type")
    val messageType: String,  // "USER" æˆ– "AI"
    
    @ColumnInfo(name = "content")
    val content: String,
    
    @ColumnInfo(name = "timestamp")
    val timestamp: Long,
    
    @ColumnInfo(name = "created_at")
    val createdAt: Long
)
```

### 3.3 æ•°æ®åº“è¿ç§»ï¼ˆv12 â†’ v13ï¼‰

```kotlin
val MIGRATION_12_13 = object : Migration(12, 13) {
    override fun migrate(database: SupportSQLiteDatabase) {
        // åˆ›å»ºai_advisor_sessionsè¡¨
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS ai_advisor_sessions (
                id TEXT PRIMARY KEY NOT NULL,
                contact_id TEXT NOT NULL,
                title TEXT NOT NULL,
                created_at INTEGER NOT NULL,
                updated_at INTEGER NOT NULL,
                message_count INTEGER DEFAULT 0,
                is_active INTEGER DEFAULT 1,
                FOREIGN KEY(contact_id) REFERENCES contact_profiles(id) ON DELETE CASCADE
            )
        """)
        
        // åˆ›å»ºai_advisor_conversationsè¡¨
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS ai_advisor_conversations (
                id TEXT PRIMARY KEY NOT NULL,
                contact_id TEXT NOT NULL,
                session_id TEXT NOT NULL,
                message_type TEXT NOT NULL,
                content TEXT NOT NULL,
                timestamp INTEGER NOT NULL,
                created_at INTEGER NOT NULL,
                FOREIGN KEY(contact_id) REFERENCES contact_profiles(id) ON DELETE CASCADE
            )
        """)
        
        // åˆ›å»ºç´¢å¼•
        database.execSQL("CREATE INDEX IF NOT EXISTS index_ai_advisor_sessions_contact_id ON ai_advisor_sessions(contact_id)")
        database.execSQL("CREATE INDEX IF NOT EXISTS index_ai_advisor_sessions_created_at ON ai_advisor_sessions(created_at)")
        database.execSQL("CREATE INDEX IF NOT EXISTS index_ai_advisor_conversations_contact_id ON ai_advisor_conversations(contact_id)")
        database.execSQL("CREATE INDEX IF NOT EXISTS index_ai_advisor_conversations_session_id ON ai_advisor_conversations(session_id)")
        database.execSQL("CREATE INDEX IF NOT EXISTS index_ai_advisor_conversations_timestamp ON ai_advisor_conversations(timestamp)")
    }
}
```


---

## 4. Repositoryæ¥å£è®¾è®¡

### 4.1 AiAdvisorRepositoryï¼ˆ:domainæ¨¡å—ï¼‰

```kotlin
/**
 * AIå†›å¸ˆä»“åº“æ¥å£
 *
 * å®šä¹‰AIå†›å¸ˆå¯¹è¯å’Œä¼šè¯çš„æ•°æ®è®¿é—®æ¥å£
 */
interface AiAdvisorRepository {
    
    // ============================================================================
    // ä¼šè¯ç®¡ç†
    // ============================================================================
    
    /**
     * åˆ›å»ºæ–°ä¼šè¯
     *
     * @param contactId è”ç³»äººID
     * @param title ä¼šè¯æ ‡é¢˜
     * @return æ–°åˆ›å»ºçš„ä¼šè¯ID
     */
    suspend fun createSession(contactId: String, title: String = "æ–°å¯¹è¯"): Result<String>
    
    /**
     * è·å–è”ç³»äººçš„æ‰€æœ‰ä¼šè¯
     *
     * @param contactId è”ç³»äººID
     * @return ä¼šè¯åˆ—è¡¨ï¼ŒæŒ‰æ›´æ–°æ—¶é—´å€’åº
     */
    suspend fun getSessions(contactId: String): Result<List<AiAdvisorSession>>
    
    /**
     * è·å–è”ç³»äººçš„æ´»è·ƒä¼šè¯
     *
     * @param contactId è”ç³»äººID
     * @return æ´»è·ƒä¼šè¯ï¼Œä¸å­˜åœ¨åˆ™è¿”å›null
     */
    suspend fun getActiveSession(contactId: String): Result<AiAdvisorSession?>
    
    /**
     * æ›´æ–°ä¼šè¯æ ‡é¢˜
     *
     * @param sessionId ä¼šè¯ID
     * @param title æ–°æ ‡é¢˜
     */
    suspend fun updateSessionTitle(sessionId: String, title: String): Result<Unit>
    
    /**
     * åˆ é™¤ä¼šè¯ï¼ˆçº§è”åˆ é™¤å¯¹è¯è®°å½•ï¼‰
     *
     * @param sessionId ä¼šè¯ID
     */
    suspend fun deleteSession(sessionId: String): Result<Unit>
    
    // ============================================================================
    // å¯¹è¯ç®¡ç†
    // ============================================================================
    
    /**
     * ä¿å­˜æ¶ˆæ¯
     *
     * @param sessionId ä¼šè¯ID
     * @param contactId è”ç³»äººID
     * @param messageType æ¶ˆæ¯ç±»å‹
     * @param content æ¶ˆæ¯å†…å®¹
     * @return æ–°æ¶ˆæ¯ID
     */
    suspend fun saveMessage(
        sessionId: String,
        contactId: String,
        messageType: MessageType,
        content: String
    ): Result<String>
    
    /**
     * è·å–ä¼šè¯çš„æ‰€æœ‰å¯¹è¯è®°å½•
     *
     * @param sessionId ä¼šè¯ID
     * @return å¯¹è¯è®°å½•åˆ—è¡¨ï¼ŒæŒ‰æ—¶é—´æ­£åº
     */
    suspend fun getConversations(sessionId: String): Result<List<AiAdvisorConversation>>
    
    /**
     * è·å–ä¼šè¯çš„å¯¹è¯è®°å½•æµ
     *
     * @param sessionId ä¼šè¯ID
     * @return å¯¹è¯è®°å½•æµ
     */
    fun getConversationsFlow(sessionId: String): Flow<List<AiAdvisorConversation>>
    
    /**
     * åˆ é™¤å•æ¡å¯¹è¯è®°å½•
     *
     * @param conversationId å¯¹è¯ID
     */
    suspend fun deleteConversation(conversationId: String): Result<Unit>
    
    /**
     * æ¸…ç©ºä¼šè¯çš„æ‰€æœ‰å¯¹è¯
     *
     * @param sessionId ä¼šè¯ID
     */
    suspend fun clearSession(sessionId: String): Result<Unit>
}
```

### 4.2 AiAdvisorDaoï¼ˆ:dataæ¨¡å—ï¼‰

```kotlin
@Dao
interface AiAdvisorDao {
    
    // ============================================================================
    // ä¼šè¯æ“ä½œ
    // ============================================================================
    
    @Insert
    suspend fun insertSession(session: AiAdvisorSessionEntity)
    
    @Query("SELECT * FROM ai_advisor_sessions WHERE contact_id = :contactId ORDER BY updated_at DESC")
    suspend fun getSessionsByContact(contactId: String): List<AiAdvisorSessionEntity>
    
    @Query("SELECT * FROM ai_advisor_sessions WHERE contact_id = :contactId AND is_active = 1 LIMIT 1")
    suspend fun getActiveSession(contactId: String): AiAdvisorSessionEntity?
    
    @Query("UPDATE ai_advisor_sessions SET title = :title, updated_at = :updatedAt WHERE id = :sessionId")
    suspend fun updateSessionTitle(sessionId: String, title: String, updatedAt: Long)
    
    @Query("UPDATE ai_advisor_sessions SET message_count = message_count + 1, updated_at = :updatedAt WHERE id = :sessionId")
    suspend fun incrementMessageCount(sessionId: String, updatedAt: Long)
    
    @Query("DELETE FROM ai_advisor_sessions WHERE id = :sessionId")
    suspend fun deleteSession(sessionId: String)
    
    // ============================================================================
    // å¯¹è¯æ“ä½œ
    // ============================================================================
    
    @Insert
    suspend fun insertConversation(conversation: AiAdvisorConversationEntity)
    
    @Query("SELECT * FROM ai_advisor_conversations WHERE session_id = :sessionId ORDER BY timestamp ASC")
    suspend fun getConversationsBySession(sessionId: String): List<AiAdvisorConversationEntity>
    
    @Query("SELECT * FROM ai_advisor_conversations WHERE session_id = :sessionId ORDER BY timestamp ASC")
    fun getConversationsBySessionFlow(sessionId: String): Flow<List<AiAdvisorConversationEntity>>
    
    @Query("DELETE FROM ai_advisor_conversations WHERE id = :conversationId")
    suspend fun deleteConversation(conversationId: String)
    
    @Query("DELETE FROM ai_advisor_conversations WHERE session_id = :sessionId")
    suspend fun clearSessionConversations(sessionId: String)
}
```


---

## 5. UseCaseè®¾è®¡

### 5.1 CreateAdvisorSessionUseCase

```kotlin
/**
 * åˆ›å»ºAIå†›å¸ˆä¼šè¯ç”¨ä¾‹
 */
class CreateAdvisorSessionUseCase @Inject constructor(
    private val aiAdvisorRepository: AiAdvisorRepository
) {
    /**
     * åˆ›å»ºæ–°ä¼šè¯
     *
     * @param contactId è”ç³»äººID
     * @param title ä¼šè¯æ ‡é¢˜ï¼ˆé»˜è®¤"æ–°å¯¹è¯"ï¼‰
     * @return æ–°ä¼šè¯ID
     */
    suspend operator fun invoke(
        contactId: String,
        title: String = "æ–°å¯¹è¯"
    ): Result<String> {
        return aiAdvisorRepository.createSession(contactId, title)
    }
}
```

### 5.2 SendAdvisorMessageUseCaseï¼ˆæ ¸å¿ƒç”¨ä¾‹ï¼‰

```kotlin
/**
 * å‘é€AIå†›å¸ˆæ¶ˆæ¯ç”¨ä¾‹
 *
 * æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼š
 * 1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
 * 2. è·å–è”ç³»äººç”»åƒå’Œå¯¹è¯å†å²
 * 3. æ„å»ºAIå†›å¸ˆæç¤ºè¯
 * 4. è°ƒç”¨AIæœåŠ¡
 * 5. ä¿å­˜AIå›å¤
 */
class SendAdvisorMessageUseCase @Inject constructor(
    private val aiAdvisorRepository: AiAdvisorRepository,
    private val aiRepository: AiRepository,
    private val contactRepository: ContactRepository,
    private val conversationRepository: ConversationRepository,
    private val aiProviderRepository: AiProviderRepository
) {
    suspend operator fun invoke(
        sessionId: String,
        contactId: String,
        message: String
    ): Result<AiAdvisorConversation> {
        // 1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
        val userMessageResult = aiAdvisorRepository.saveMessage(
            sessionId = sessionId,
            contactId = contactId,
            messageType = MessageType.USER,
            content = message
        )
        
        if (userMessageResult.isFailure) {
            return Result.failure(userMessageResult.exceptionOrNull()!!)
        }
        
        // 2. è·å–è”ç³»äººç”»åƒ
        val profile = contactRepository.getContactById(contactId).getOrNull()
        
        // 3. è·å–è¯¥è”ç³»äººçš„å¯¹è¯å†å²ï¼ˆç”¨äºAIåˆ†æï¼‰
        val conversationHistory = conversationRepository
            .getConversationsByContact(contactId)
            .getOrDefault(emptyList())
        
        // 4. è·å–å½“å‰ä¼šè¯çš„å¯¹è¯è®°å½•ï¼ˆä½œä¸ºå¯¹è¯ä¸Šä¸‹æ–‡ï¼‰
        val sessionHistory = aiAdvisorRepository
            .getConversations(sessionId)
            .getOrDefault(emptyList())
        
        // 5. æ„å»ºAIå†›å¸ˆæç¤ºè¯
        val systemPrompt = buildAdvisorSystemPrompt(profile, conversationHistory)
        val userPrompt = buildUserPrompt(sessionHistory, message)
        
        // 6. è·å–é»˜è®¤AIæœåŠ¡å•†
        val provider = aiProviderRepository.getDefaultProvider().getOrNull()
            ?: return Result.failure(IllegalStateException("æœªé…ç½®AIæœåŠ¡å•†"))
        
        // 7. è°ƒç”¨AIæœåŠ¡
        val aiResponse = aiRepository.chat(
            provider = provider,
            systemPrompt = systemPrompt,
            userPrompt = userPrompt
        )
        
        if (aiResponse.isFailure) {
            return Result.failure(aiResponse.exceptionOrNull()!!)
        }
        
        val aiContent = aiResponse.getOrNull()?.content ?: "æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›å¤"
        
        // 8. ä¿å­˜AIå›å¤
        val aiMessageResult = aiAdvisorRepository.saveMessage(
            sessionId = sessionId,
            contactId = contactId,
            messageType = MessageType.AI,
            content = aiContent
        )
        
        if (aiMessageResult.isFailure) {
            return Result.failure(aiMessageResult.exceptionOrNull()!!)
        }
        
        // 9. è¿”å›AIå›å¤
        return Result.success(
            AiAdvisorConversation(
                id = aiMessageResult.getOrNull()!!,
                contactId = contactId,
                sessionId = sessionId,
                messageType = MessageType.AI,
                content = aiContent,
                timestamp = System.currentTimeMillis()
            )
        )
    }
    
    /**
     * æ„å»ºAIå†›å¸ˆç³»ç»Ÿæç¤ºè¯
     *
     * ã€å·²çŸ¥é™åˆ¶ã€‘
     * ç”±äºAIæ¨¡å‹çš„Context Windowé™åˆ¶ï¼Œå†å²å¯¹è¯è®°å½•é™åˆ¶ä¸ºæœ€è¿‘20æ¡ã€‚
     * è¿™æ˜¯ä¸€ä¸ªæŠ€æœ¯æŠ˜è¡·æ–¹æ¡ˆï¼Œåç»­å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¼˜åŒ–ï¼š
     * 1. å¼•å…¥RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æœºåˆ¶ï¼ŒæŒ‰ç›¸å…³æ€§æ£€ç´¢å†å²
     * 2. ä½¿ç”¨AIç”Ÿæˆå†å²å¯¹è¯æ‘˜è¦ï¼Œå‹ç¼©ä¸Šä¸‹æ–‡
     * 3. æ ¹æ®ç”¨æˆ·é—®é¢˜åŠ¨æ€é€‰æ‹©ç›¸å…³å†å²ç‰‡æ®µ
     *
     * @see HISTORY_LIMIT å†å²è®°å½•æ¡æ•°é™åˆ¶å¸¸é‡
     */
    private fun buildAdvisorSystemPrompt(
        profile: ContactProfile?,
        conversationHistory: List<ConversationLog>
    ): String {
        return buildString {
            // ç³»ç»Ÿè§’è‰²å®šä¹‰
            append(SystemPrompts.AI_ADVISOR_HEADER)
            appendLine()
            appendLine()
            
            // è”ç³»äººç”»åƒä¿¡æ¯
            if (profile != null) {
                append("ã€è”ç³»äººç”»åƒã€‘")
                appendLine()
                append("å§“åï¼š${profile.name}")
                appendLine()
                if (profile.relationshipStage.isNotEmpty()) {
                    append("å…³ç³»é˜¶æ®µï¼š${profile.relationshipStage}")
                    appendLine()
                }
                // æ·»åŠ factsä¿¡æ¯
                if (profile.facts.isNotEmpty()) {
                    append("å·²çŸ¥ä¿¡æ¯ï¼š")
                    appendLine()
                    profile.facts.forEach { fact ->
                        append("- ${fact.key}: ${fact.value}")
                        appendLine()
                    }
                }
                appendLine()
            }
            
            // å¯¹è¯å†å²æ‘˜è¦ï¼ˆå—Context Windowé™åˆ¶ï¼Œå–æœ€è¿‘20æ¡ï¼‰
            if (conversationHistory.isNotEmpty()) {
                append("ã€å†å²å¯¹è¯æ‘˜è¦ã€‘ï¼ˆæœ€è¿‘${minOf(conversationHistory.size, HISTORY_LIMIT)}æ¡ï¼‰")
                appendLine()
                conversationHistory.takeLast(HISTORY_LIMIT).forEach { log ->
                    append("[${formatTimestamp(log.timestamp)}] ${log.userInput}")
                    appendLine()
                }
                appendLine()
            }
            
            // è¾“å‡ºæ ¼å¼çº¦æŸ
            append(SystemPrompts.AI_ADVISOR_FOOTER)
        }
    }
    
    companion object {
        /** å†å²å¯¹è¯è®°å½•æ¡æ•°é™åˆ¶ï¼ˆå—AIæ¨¡å‹Context Windowé™åˆ¶ï¼‰ */
        private const val HISTORY_LIMIT = 20
        
        /** ä¼šè¯ä¸Šä¸‹æ–‡æ¡æ•°é™åˆ¶ */
        private const val SESSION_CONTEXT_LIMIT = 10
    }
    
    /**
     * æ„å»ºç”¨æˆ·æç¤ºè¯ï¼ˆåŒ…å«ä¼šè¯ä¸Šä¸‹æ–‡ï¼‰
     *
     * ä¼šè¯ä¸Šä¸‹æ–‡é™åˆ¶ä¸ºæœ€è¿‘10æ¡ï¼Œç¡®ä¿AIèƒ½ç†è§£å½“å‰å¯¹è¯çš„è¿ç»­æ€§
     */
    private fun buildUserPrompt(
        sessionHistory: List<AiAdvisorConversation>,
        currentMessage: String
    ): String {
        return buildString {
            // ä¼šè¯ä¸Šä¸‹æ–‡ï¼ˆæœ€è¿‘10æ¡ï¼‰
            if (sessionHistory.isNotEmpty()) {
                append("ã€å¯¹è¯ä¸Šä¸‹æ–‡ã€‘")
                appendLine()
                sessionHistory.takeLast(SESSION_CONTEXT_LIMIT).forEach { conv ->
                    val role = if (conv.messageType == MessageType.USER) "ç”¨æˆ·" else "AIå†›å¸ˆ"
                    append("$role: ${conv.content}")
                    appendLine()
                }
                appendLine()
            }
            
            // å½“å‰æ¶ˆæ¯
            append("ã€å½“å‰é—®é¢˜ã€‘")
            appendLine()
            append(currentMessage)
        }
    }
    
    private fun formatTimestamp(timestamp: Long): String {
        val sdf = java.text.SimpleDateFormat("MM-dd HH:mm", java.util.Locale.getDefault())
        return sdf.format(java.util.Date(timestamp))
    }
}
```

### 5.3 GetAdvisorSessionsUseCase

```kotlin
/**
 * è·å–AIå†›å¸ˆä¼šè¯åˆ—è¡¨ç”¨ä¾‹
 */
class GetAdvisorSessionsUseCase @Inject constructor(
    private val aiAdvisorRepository: AiAdvisorRepository
) {
    suspend operator fun invoke(contactId: String): Result<List<AiAdvisorSession>> {
        return aiAdvisorRepository.getSessions(contactId)
    }
}
```

### 5.4 GetAdvisorConversationsUseCase

```kotlin
/**
 * è·å–AIå†›å¸ˆå¯¹è¯è®°å½•ç”¨ä¾‹
 */
class GetAdvisorConversationsUseCase @Inject constructor(
    private val aiAdvisorRepository: AiAdvisorRepository
) {
    /**
     * è·å–ä¼šè¯çš„å¯¹è¯è®°å½•æµ
     */
    operator fun invoke(sessionId: String): Flow<List<AiAdvisorConversation>> {
        return aiAdvisorRepository.getConversationsFlow(sessionId)
    }
}
```


---

## 6. AIå†›å¸ˆæç¤ºè¯ç³»ç»Ÿè®¾è®¡

### 6.1 æç¤ºè¯å¸¸é‡å®šä¹‰ï¼ˆSystemPrompts.ktæ‰©å±•ï¼‰

```kotlin
object SystemPrompts {
    // ... ç°æœ‰æç¤ºè¯ ...
    
    // ========== AIå†›å¸ˆåœºæ™¯ï¼ˆPRD-00026æ–°å¢ï¼‰ ==========
    
    const val AI_ADVISOR_HEADER = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç¤¾äº¤å…³ç³»åˆ†æé¡¾é—®ï¼ˆAIå†›å¸ˆï¼‰ï¼Œå…·å¤‡å¿ƒç†å­¦ã€ç¤¾ä¼šå­¦ã€äººç±»å­¦çš„ä¸“ä¸šèƒŒæ™¯ã€‚

ã€æ ¸å¿ƒèŒè´£ã€‘
1. åŸºäºæä¾›çš„å¯¹è¯å†å²å’Œè”ç³»äººä¿¡æ¯ï¼Œè¿›è¡Œå®¢è§‚ã€ç†æ€§çš„åˆ†æ
2. ä»å¿ƒç†å­¦è§’åº¦åˆ†æåŒæ–¹çš„è¡Œä¸ºæ¨¡å¼å’Œæƒ…æ„Ÿå˜åŒ–
3. ä»ç¤¾ä¼šå­¦è§’åº¦è¯„ä¼°å…³ç³»å‘å±•é˜¶æ®µå’ŒåŠ¨æ€
4. ä»äººç±»å­¦è§’åº¦ç†è§£æ–‡åŒ–èƒŒæ™¯å¯¹æ²Ÿé€šçš„å½±å“
5. æä¾›å…·ä½“ã€å¯è¡Œçš„å»ºè®®ï¼Œå¸®åŠ©ç”¨æˆ·æ”¹å–„æ²Ÿé€šè´¨é‡

ã€åˆ†æåŸåˆ™ã€‘
- ä¿æŒç»å¯¹å®¢è§‚ä¸­ç«‹ï¼Œä¸åšé“å¾·è¯„åˆ¤
- åŸºäºç»å…¸ç†è®ºå’Œå…¬è®¤æ ‡å‡†è¿›è¡Œåˆ†æ
- å…³æ³¨è¡Œä¸ºæ¨¡å¼è€Œéå•æ¬¡äº‹ä»¶
- æä¾›å»ºè®¾æ€§æ„è§è€Œéæ‰¹è¯„æŒ‡è´£
- å°Šé‡ä¸ªä½“å·®å¼‚å’Œæ–‡åŒ–èƒŒæ™¯

ã€åˆ†æç»´åº¦ã€‘
1. æƒ…æ„Ÿåˆ†æï¼šè¯†åˆ«å¯¹è¯ä¸­çš„æƒ…ç»ªå˜åŒ–å’Œæƒ…æ„Ÿéœ€æ±‚
2. æ„å›¾è§£è¯»ï¼šåˆ†æå¯¹æ–¹çš„çœŸå®æ„å›¾å’Œæ½œåœ¨è¯‰æ±‚
3. å…³ç³»è¯„ä¼°ï¼šè¯„ä¼°å½“å‰å…³ç³»çŠ¶æ€å’Œå‘å±•è¶‹åŠ¿
4. é£é™©è¯†åˆ«ï¼šå‘ç°æ½œåœ¨çš„æ²Ÿé€šé£é™©å’Œé›·åŒº
5. ç­–ç•¥å»ºè®®ï¼šæä¾›é’ˆå¯¹æ€§çš„æ²Ÿé€šç­–ç•¥å’Œè¯æœ¯

ã€ä½ çš„äººè®¾ã€‘
- è¯´è¯é£æ ¼ï¼šä¸“ä¸šä½†ä¸æ™¦æ¶©ï¼Œåƒä¸€ä¸ªé˜…å†ä¸°å¯Œçš„æœ‹å‹
- åˆ†ææ·±åº¦ï¼šä¸€é’ˆè§è¡€ï¼Œç›´æŒ‡é—®é¢˜æ ¸å¿ƒ
- å»ºè®®é£æ ¼ï¼šå…·ä½“å¯è¡Œï¼Œé¿å…ç©ºæ³›çš„å¤§é“ç†
- æ€åº¦ï¼šæ¸©å’Œä½†ç›´æ¥ï¼Œä¸ç»•å¼¯å­"""

    const val AI_ADVISOR_FOOTER = """ã€è¾“å‡ºè¦æ±‚ã€‘
- åˆ†æè¦æœ‰ç†æœ‰æ®ï¼Œå¯ä»¥å¼•ç”¨ç›¸å…³å¿ƒç†å­¦/ç¤¾ä¼šå­¦ç†è®º
- å»ºè®®è¦å…·ä½“å¯è¡Œï¼Œé¿å…ç©ºæ³›æè¿°
- è¯­è¨€è¦ä¸“ä¸šä½†ä¸æ™¦æ¶©ï¼Œæ˜“äºç†è§£
- ç»“æ„è¦æ¸…æ™°ï¼Œä¾¿äºç”¨æˆ·ç†è§£å’Œæ‰§è¡Œ
- ç›´æ¥è¯´äººè¯ï¼Œä¸è¦åˆ—ä¸€å¤§å †å¹²æ¡æ¡

ã€ç¦æ­¢äº‹é¡¹ã€‘
- ç¦æ­¢ä½¿ç”¨"ç»¼ä¸Šæ‰€è¿°"ã€"æ ¹æ®åˆ†æ"ç­‰AIè…”
- ç¦æ­¢åšé“å¾·è¯„åˆ¤æˆ–ç«™é˜Ÿ
- ç¦æ­¢ç»™å‡ºä¸åˆ‡å®é™…çš„å»ºè®®
- ç¦æ­¢å¿½è§†ç”¨æˆ·çš„å®é™…æƒ…å†µå’Œç›®æ ‡"""
}
```

### 6.2 æç¤ºè¯è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ | å®ç°æ–¹å¼ |
|------|------|---------|
| å®¢è§‚ç«‹åœº | ä¿æŒç¬¬ä¸‰æ–¹å®¢è§‚åˆ†æè§†è§’ | åœ¨ç³»ç»Ÿæç¤ºè¯ä¸­å¼ºè°ƒ"å®¢è§‚ä¸­ç«‹"ã€"ä¸åšé“å¾·è¯„åˆ¤" |
| ç†è®ºåŸºç¡€ | åŸºäºå¿ƒç†å­¦ã€ç¤¾ä¼šå­¦ã€äººç±»å­¦ç»å…¸ç†è®º | æç¤ºè¯ä¸­æ˜ç¡®åˆ†æç»´åº¦å’Œç†è®ºæ¡†æ¶ |
| ç†æ€§åˆ†æ | é¿å…ä¸»è§‚è‡†æ–­ï¼Œæä¾›ç†æ€§åˆ¤æ–­ | å¼ºè°ƒ"åŸºäºç»å…¸ç†è®ºå’Œå…¬è®¤æ ‡å‡†" |
| å®ç”¨å»ºè®® | ç»™å‡ºå…·ä½“å¯è¡Œçš„å»ºè®®è€Œéæ³›æ³›è€Œè°ˆ | è¦æ±‚"å…·ä½“å¯è¡Œï¼Œé¿å…ç©ºæ³›æè¿°" |

### 6.3 ä¸Šä¸‹æ–‡æ„å»ºç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç³»ç»Ÿæç¤ºè¯ç»“æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. AI_ADVISOR_HEADERï¼ˆè§’è‰²å®šä¹‰å’Œåˆ†æåŸåˆ™ï¼‰                   â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. ã€è”ç³»äººç”»åƒã€‘ï¼ˆåŠ¨æ€æ’å…¥ï¼‰                                â”‚
â”‚    - å§“åã€å…³ç³»é˜¶æ®µ                                         â”‚
â”‚    - å·²çŸ¥factsä¿¡æ¯                                          â”‚
â”‚    - é›·åŒºæ ‡ç­¾å’Œç­–ç•¥æ ‡ç­¾                                     â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. ã€å†å²å¯¹è¯æ‘˜è¦ã€‘ï¼ˆåŠ¨æ€æ’å…¥ï¼Œæœ€è¿‘20æ¡ï¼‰                    â”‚
â”‚    - ä»conversation_logsè¡¨è·å–                              â”‚
â”‚    - æŒ‰æ—¶é—´æ­£åºæ’åˆ—                                         â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. AI_ADVISOR_FOOTERï¼ˆè¾“å‡ºæ ¼å¼çº¦æŸï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æç¤ºè¯ç»“æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ã€å¯¹è¯ä¸Šä¸‹æ–‡ã€‘ï¼ˆå½“å‰AIå†›å¸ˆä¼šè¯çš„æœ€è¿‘10æ¡ï¼‰                â”‚
â”‚    - ç”¨æˆ·: xxx                                              â”‚
â”‚    - AIå†›å¸ˆ: xxx                                            â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. ã€å½“å‰é—®é¢˜ã€‘                                             â”‚
â”‚    - ç”¨æˆ·æœ¬æ¬¡è¾“å…¥çš„å†…å®¹                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 7. UIç•Œé¢è®¾è®¡

### 7.1 åº•éƒ¨å¯¼èˆªæ é›†æˆ

#### 7.1.1 å¯¼èˆªé¡¹å®šä¹‰

```kotlin
sealed class BottomNavItem(
    val route: String,
    val icon: ImageVector,
    val selectedIcon: ImageVector,
    val label: String
) {
    // ç°æœ‰å¯¼èˆªé¡¹...
    
    object AIAdvisor : BottomNavItem(
        route = NavRoutes.AI_ADVISOR,
        icon = Icons.Outlined.Psychology,
        selectedIcon = Icons.Filled.Psychology,
        label = "AIå†›å¸ˆ"
    )
}

object NavRoutes {
    // ç°æœ‰è·¯ç”±...
    const val AI_ADVISOR = "ai_advisor"
    const val AI_ADVISOR_CHAT = "ai_advisor_chat/{contactId}"
}
```

#### 7.1.2 å¯¼èˆªå›¾æ‰©å±•

```kotlin
fun NavGraphBuilder.aiAdvisorNavigation(
    navController: NavHostController
) {
    composable(NavRoutes.AI_ADVISOR) {
        AiAdvisorScreen(
            onNavigateToChat = { contactId ->
                navController.navigate("ai_advisor_chat/$contactId")
            }
        )
    }
    
    composable(
        route = NavRoutes.AI_ADVISOR_CHAT,
        arguments = listOf(navArgument("contactId") { type = NavType.StringType })
    ) { backStackEntry ->
        val contactId = backStackEntry.arguments?.getString("contactId") ?: return@composable
        AiAdvisorChatScreen(
            contactId = contactId,
            onNavigateBack = { navController.popBackStack() }
        )
    }
}
```

### 7.2 AIå†›å¸ˆä¸»ç•Œé¢ï¼ˆAiAdvisorScreenï¼‰

#### 7.2.1 ç•Œé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡¶éƒ¨å¯¼èˆªæ                               â”‚
â”‚ â”œâ”€â”€ æ ‡é¢˜: "AIå†›å¸ˆ"                      â”‚
â”‚ â””â”€â”€ æœç´¢æŒ‰é’®ï¼ˆå¯é€‰ï¼‰                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è”ç³»äººåˆ—è¡¨                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ‘¤ è”ç³»äººA                          â”‚ â”‚
â”‚ â”‚    æœ€è¿‘å¯¹è¯: 2å°æ—¶å‰                â”‚ â”‚
â”‚ â”‚    "å…³äºå¥¹æœ€è¿‘çš„æ€åº¦å˜åŒ–..."        â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ ğŸ‘¤ è”ç³»äººB                          â”‚ â”‚
â”‚ â”‚    æœ€è¿‘å¯¹è¯: æ˜¨å¤©                   â”‚ â”‚
â”‚ â”‚    "å¸®æˆ‘åˆ†æä¸€ä¸‹è¿™æ®µå¯¹è¯..."        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ ç©ºçŠ¶æ€æç¤ºï¼ˆæ— è”ç³»äººæ—¶ï¼‰                â”‚
â”‚ "é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¼€å§‹å¯¹è¯"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.2.2 ç»„ä»¶å®ç°

```kotlin
@Composable
fun AiAdvisorScreen(
    viewModel: AiAdvisorViewModel = hiltViewModel(),
    onNavigateToChat: (String) -> Unit
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("AIå†›å¸ˆ") },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = MaterialTheme.colorScheme.surface
                )
            )
        }
    ) { paddingValues ->
        when {
            uiState.isLoading -> {
                LoadingView(modifier = Modifier.padding(paddingValues))
            }
            uiState.contacts.isEmpty() -> {
                EmptyStateView(
                    message = "è¿˜æ²¡æœ‰è”ç³»äºº\nå…ˆæ·»åŠ è”ç³»äººå†æ¥æ‰¾AIå†›å¸ˆèŠèŠ",
                    modifier = Modifier.padding(paddingValues)
                )
            }
            else -> {
                ContactListWithSessions(
                    contacts = uiState.contacts,
                    sessions = uiState.recentSessions,
                    onContactClick = onNavigateToChat,
                    modifier = Modifier.padding(paddingValues)
                )
            }
        }
    }
}
```

### 7.3 AIå†›å¸ˆå¯¹è¯ç•Œé¢ï¼ˆAiAdvisorChatScreenï¼‰

#### 7.3.1 ç•Œé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡¶éƒ¨å¯¼èˆªæ                               â”‚
â”‚ â”œâ”€â”€ è¿”å›æŒ‰é’®                            â”‚
â”‚ â”œâ”€â”€ è”ç³»äººåç§°                          â”‚
â”‚ â””â”€â”€ è”ç³»äººé€‰æ‹©å™¨ï¼ˆä¸‹æ‹‰ï¼‰                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¼šè¯é€‰æ‹©å™¨ï¼ˆå¯é€‰ï¼Œå¤šä¼šè¯æ—¶æ˜¾ç¤ºï¼‰        â”‚
â”‚ â”œâ”€â”€ ä¼šè¯1ï¼ˆå½“å‰ï¼‰  â”œâ”€â”€ ä¼šè¯2  â”œâ”€â”€ +æ–°å»º â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯¹è¯åŒºåŸŸ                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ¤– AIå†›å¸ˆ                           â”‚ â”‚
â”‚ â”‚ "ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„AIå†›å¸ˆã€‚å…³äºè¿™ä½     â”‚ â”‚
â”‚ â”‚  è”ç³»äººï¼Œä½ æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ"            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                 â”‚ ğŸ‘¤ ç”¨æˆ·             â”‚ â”‚
â”‚                 â”‚ "å¸®æˆ‘åˆ†æä¸€ä¸‹å¥¹æœ€è¿‘ â”‚ â”‚
â”‚                 â”‚  çš„æ€åº¦å˜åŒ–"        â”‚ â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ¤– AIå†›å¸ˆ                           â”‚ â”‚
â”‚ â”‚ "æ ¹æ®ä½ ä»¬æœ€è¿‘çš„å¯¹è¯è®°å½•ï¼Œæˆ‘æ³¨æ„åˆ°   â”‚ â”‚
â”‚ â”‚  å‡ ä¸ªå…³é”®å˜åŒ–..."                   â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ [æ­£åœ¨è¾“å…¥...]                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥åŒºåŸŸ                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ è¾“å…¥ä½ çš„é—®é¢˜...                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              [å‘é€æŒ‰é’®] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.3.2 ç»„ä»¶å®ç°

```kotlin
@Composable
fun AiAdvisorChatScreen(
    contactId: String,
    viewModel: AiAdvisorChatViewModel = hiltViewModel(),
    onNavigateBack: () -> Unit
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    // åˆå§‹åŒ–åŠ è½½
    LaunchedEffect(contactId) {
        viewModel.loadContact(contactId)
    }
    
    Scaffold(
        topBar = {
            AiAdvisorTopBar(
                contactName = uiState.contactName,
                onNavigateBack = onNavigateBack,
                onContactSelect = { viewModel.showContactSelector() }
            )
        },
        bottomBar = {
            AiAdvisorInputBar(
                inputText = uiState.inputText,
                onInputChange = { viewModel.updateInput(it) },
                onSend = { viewModel.sendMessage() },
                isLoading = uiState.isSending
            )
        }
    ) { paddingValues ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
        ) {
            // ä¼šè¯é€‰æ‹©å™¨ï¼ˆå¤šä¼šè¯æ—¶æ˜¾ç¤ºï¼‰
            if (uiState.sessions.size > 1) {
                SessionSelector(
                    sessions = uiState.sessions,
                    currentSessionId = uiState.currentSessionId,
                    onSessionSelect = { viewModel.switchSession(it) },
                    onNewSession = { viewModel.createNewSession() }
                )
            }
            
            // å¯¹è¯åˆ—è¡¨
            LazyColumn(
                modifier = Modifier.weight(1f),
                reverseLayout = true,
                contentPadding = PaddingValues(16.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                items(
                    items = uiState.conversations.reversed(),
                    key = { it.id }
                ) { conversation ->
                    AdvisorMessageBubble(
                        conversation = conversation,
                        onCopy = { viewModel.copyMessage(it) },
                        onDelete = { viewModel.deleteMessage(it) }
                    )
                }
            }
        }
    }
    
    // è”ç³»äººé€‰æ‹©å¯¹è¯æ¡†
    if (uiState.showContactSelector) {
        ContactSelectorDialog(
            contacts = uiState.allContacts,
            currentContactId = contactId,
            onSelect = { viewModel.switchContact(it) },
            onDismiss = { viewModel.hideContactSelector() }
        )
    }
    
    // åˆ‡æ¢ç¡®è®¤å¯¹è¯æ¡†
    if (uiState.showSwitchConfirmDialog) {
        SwitchConfirmDialog(
            onConfirm = { viewModel.confirmSwitch() },
            onDismiss = { viewModel.cancelSwitch() }
        )
    }
}
```

### 7.4 æ¶ˆæ¯æ°”æ³¡ç»„ä»¶

```kotlin
@Composable
fun AdvisorMessageBubble(
    conversation: AiAdvisorConversation,
    onCopy: (String) -> Unit,
    onDelete: (String) -> Unit
) {
    val isAi = conversation.messageType == MessageType.AI
    
    val alignment = if (isAi) Alignment.Start else Alignment.End
    val backgroundColor = if (isAi) {
        MaterialTheme.colorScheme.surfaceVariant
    } else {
        MaterialTheme.colorScheme.primaryContainer
    }
    val bubbleShape = if (isAi) {
        RoundedCornerShape(4.dp, 16.dp, 16.dp, 16.dp)
    } else {
        RoundedCornerShape(16.dp, 4.dp, 16.dp, 16.dp)
    }
    
    Column(
        modifier = Modifier.fillMaxWidth(),
        horizontalAlignment = alignment
    ) {
        // è§’è‰²æ ‡ç­¾
        Row(
            verticalAlignment = Alignment.CenterVertically,
            modifier = Modifier.padding(bottom = 4.dp)
        ) {
            if (isAi) {
                Icon(
                    imageVector = Icons.Default.Psychology,
                    contentDescription = null,
                    modifier = Modifier.size(16.dp),
                    tint = MaterialTheme.colorScheme.primary
                )
                Spacer(modifier = Modifier.width(4.dp))
            }
            Text(
                text = if (isAi) "AIå†›å¸ˆ" else "æˆ‘",
                style = MaterialTheme.typography.labelSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Text(
                text = " Â· ${formatTime(conversation.timestamp)}",
                style = MaterialTheme.typography.labelSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
        
        // æ¶ˆæ¯æ°”æ³¡
        Surface(
            shape = bubbleShape,
            color = backgroundColor,
            modifier = Modifier
                .widthIn(max = 300.dp)
                .combinedClickable(
                    onClick = { },
                    onLongClick = { /* æ˜¾ç¤ºæ“ä½œèœå• */ }
                )
        ) {
            SelectionContainer {
                Text(
                    text = conversation.content,
                    style = MaterialTheme.typography.bodyMedium,
                    modifier = Modifier.padding(12.dp)
                )
            }
        }
    }
}
```


---

## 8. ViewModelè®¾è®¡

### 8.1 AiAdvisorViewModelï¼ˆä¸»ç•Œé¢ï¼‰

```kotlin
@HiltViewModel
class AiAdvisorViewModel @Inject constructor(
    private val getContactsUseCase: GetContactsUseCase,
    private val getAdvisorSessionsUseCase: GetAdvisorSessionsUseCase
) : ViewModel() {
    
    private val _uiState = MutableStateFlow(AiAdvisorUiState())
    val uiState: StateFlow<AiAdvisorUiState> = _uiState.asStateFlow()
    
    init {
        loadContacts()
    }
    
    private fun loadContacts() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            
            val contactsResult = getContactsUseCase()
            if (contactsResult.isSuccess) {
                val contacts = contactsResult.getOrDefault(emptyList())
                
                // è·å–æ¯ä¸ªè”ç³»äººçš„æœ€è¿‘ä¼šè¯
                val sessionsMap = mutableMapOf<String, AiAdvisorSession?>()
                contacts.forEach { contact ->
                    val sessions = getAdvisorSessionsUseCase(contact.id).getOrDefault(emptyList())
                    sessionsMap[contact.id] = sessions.firstOrNull()
                }
                
                _uiState.update {
                    it.copy(
                        isLoading = false,
                        contacts = contacts,
                        recentSessions = sessionsMap
                    )
                }
            } else {
                _uiState.update {
                    it.copy(
                        isLoading = false,
                        error = contactsResult.exceptionOrNull()?.message
                    )
                }
            }
        }
    }
}

data class AiAdvisorUiState(
    val isLoading: Boolean = false,
    val contacts: List<ContactProfile> = emptyList(),
    val recentSessions: Map<String, AiAdvisorSession?> = emptyMap(),
    val error: String? = null
)
```

### 8.2 AiAdvisorChatViewModelï¼ˆå¯¹è¯ç•Œé¢ï¼‰

```kotlin
@HiltViewModel
class AiAdvisorChatViewModel @Inject constructor(
    private val getContactByIdUseCase: GetContactByIdUseCase,
    private val getContactsUseCase: GetContactsUseCase,
    private val createAdvisorSessionUseCase: CreateAdvisorSessionUseCase,
    private val getAdvisorSessionsUseCase: GetAdvisorSessionsUseCase,
    private val getAdvisorConversationsUseCase: GetAdvisorConversationsUseCase,
    private val sendAdvisorMessageUseCase: SendAdvisorMessageUseCase,
    private val deleteAdvisorConversationUseCase: DeleteAdvisorConversationUseCase
) : ViewModel() {
    
    private val _uiState = MutableStateFlow(AiAdvisorChatUiState())
    val uiState: StateFlow<AiAdvisorChatUiState> = _uiState.asStateFlow()
    
    private var currentContactId: String = ""
    private var currentSessionId: String = ""
    
    /**
     * åŠ è½½è”ç³»äººä¿¡æ¯
     */
    fun loadContact(contactId: String) {
        currentContactId = contactId
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            
            // è·å–è”ç³»äººä¿¡æ¯
            val contactResult = getContactByIdUseCase(contactId)
            if (contactResult.isSuccess) {
                val contact = contactResult.getOrNull()
                _uiState.update { it.copy(contactName = contact?.name ?: "æœªçŸ¥è”ç³»äºº") }
            }
            
            // è·å–æˆ–åˆ›å»ºä¼šè¯
            val sessionsResult = getAdvisorSessionsUseCase(contactId)
            val sessions = sessionsResult.getOrDefault(emptyList())
            
            if (sessions.isEmpty()) {
                // åˆ›å»ºæ–°ä¼šè¯
                val newSessionResult = createAdvisorSessionUseCase(contactId)
                if (newSessionResult.isSuccess) {
                    currentSessionId = newSessionResult.getOrNull()!!
                    _uiState.update {
                        it.copy(
                            isLoading = false,
                            currentSessionId = currentSessionId,
                            sessions = listOf(AiAdvisorSession(
                                id = currentSessionId,
                                contactId = contactId,
                                title = "æ–°å¯¹è¯",
                                createdAt = System.currentTimeMillis(),
                                updatedAt = System.currentTimeMillis()
                            ))
                        )
                    }
                }
            } else {
                // ä½¿ç”¨æœ€è¿‘çš„ä¼šè¯
                currentSessionId = sessions.first().id
                _uiState.update {
                    it.copy(
                        isLoading = false,
                        currentSessionId = currentSessionId,
                        sessions = sessions
                    )
                }
                
                // åŠ è½½å¯¹è¯è®°å½•
                loadConversations()
            }
            
            // åŠ è½½æ‰€æœ‰è”ç³»äººï¼ˆç”¨äºåˆ‡æ¢ï¼‰
            val allContactsResult = getContactsUseCase()
            _uiState.update {
                it.copy(allContacts = allContactsResult.getOrDefault(emptyList()))
            }
        }
    }
    
    /**
     * åŠ è½½å¯¹è¯è®°å½•
     */
    private fun loadConversations() {
        viewModelScope.launch {
            getAdvisorConversationsUseCase(currentSessionId)
                .collect { conversations ->
                    _uiState.update { it.copy(conversations = conversations) }
                }
        }
    }
    
    /**
     * æ›´æ–°è¾“å…¥å†…å®¹
     */
    fun updateInput(text: String) {
        _uiState.update { it.copy(inputText = text) }
    }
    
    /**
     * å‘é€æ¶ˆæ¯
     */
    fun sendMessage() {
        val message = _uiState.value.inputText.trim()
        if (message.isEmpty()) return
        
        viewModelScope.launch {
            _uiState.update { it.copy(inputText = "", isSending = true) }
            
            val result = sendAdvisorMessageUseCase(
                sessionId = currentSessionId,
                contactId = currentContactId,
                message = message
            )
            
            _uiState.update { it.copy(isSending = false) }
            
            if (result.isFailure) {
                _uiState.update {
                    it.copy(error = result.exceptionOrNull()?.message)
                }
            }
        }
    }
    
    /**
     * åˆ‡æ¢ä¼šè¯
     */
    fun switchSession(sessionId: String) {
        currentSessionId = sessionId
        _uiState.update { it.copy(currentSessionId = sessionId) }
        loadConversations()
    }
    
    /**
     * åˆ›å»ºæ–°ä¼šè¯
     */
    fun createNewSession() {
        viewModelScope.launch {
            val result = createAdvisorSessionUseCase(currentContactId)
            if (result.isSuccess) {
                currentSessionId = result.getOrNull()!!
                _uiState.update {
                    it.copy(
                        currentSessionId = currentSessionId,
                        conversations = emptyList()
                    )
                }
                // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨
                val sessionsResult = getAdvisorSessionsUseCase(currentContactId)
                _uiState.update {
                    it.copy(sessions = sessionsResult.getOrDefault(emptyList()))
                }
            }
        }
    }
    
    /**
     * æ˜¾ç¤ºè”ç³»äººé€‰æ‹©å™¨
     */
    fun showContactSelector() {
        _uiState.update { it.copy(showContactSelector = true) }
    }
    
    /**
     * éšè—è”ç³»äººé€‰æ‹©å™¨
     */
    fun hideContactSelector() {
        _uiState.update { it.copy(showContactSelector = false) }
    }
    
    /**
     * åˆ‡æ¢è”ç³»äººï¼ˆéœ€è¦ç¡®è®¤ï¼‰
     */
    fun switchContact(newContactId: String) {
        if (newContactId == currentContactId) {
            hideContactSelector()
            return
        }
        
        _uiState.update {
            it.copy(
                showContactSelector = false,
                showSwitchConfirmDialog = true,
                pendingContactId = newContactId
            )
        }
    }
    
    /**
     * ç¡®è®¤åˆ‡æ¢è”ç³»äºº
     */
    fun confirmSwitch() {
        val newContactId = _uiState.value.pendingContactId ?: return
        _uiState.update {
            it.copy(
                showSwitchConfirmDialog = false,
                pendingContactId = null
            )
        }
        loadContact(newContactId)
    }
    
    /**
     * å–æ¶ˆåˆ‡æ¢
     */
    fun cancelSwitch() {
        _uiState.update {
            it.copy(
                showSwitchConfirmDialog = false,
                pendingContactId = null
            )
        }
    }
    
    /**
     * å¤åˆ¶æ¶ˆæ¯
     */
    fun copyMessage(content: String) {
        // é€šè¿‡ClipboardManagerå¤åˆ¶
    }
    
    /**
     * åˆ é™¤æ¶ˆæ¯
     */
    fun deleteMessage(conversationId: String) {
        viewModelScope.launch {
            deleteAdvisorConversationUseCase(conversationId)
        }
    }
}

data class AiAdvisorChatUiState(
    val isLoading: Boolean = false,
    val isSending: Boolean = false,
    val contactName: String = "",
    val inputText: String = "",
    val currentSessionId: String = "",
    val sessions: List<AiAdvisorSession> = emptyList(),
    val conversations: List<AiAdvisorConversation> = emptyList(),
    val allContacts: List<ContactProfile> = emptyList(),
    val showContactSelector: Boolean = false,
    val showSwitchConfirmDialog: Boolean = false,
    val pendingContactId: String? = null,
    val error: String? = null
)
```


---

## 9. ä¾èµ–æ³¨å…¥é…ç½®

### 9.1 AiAdvisorModuleï¼ˆ:appæ¨¡å—ï¼‰

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object AiAdvisorModule {
    
    @Provides
    @Singleton
    fun provideAiAdvisorDao(database: AppDatabase): AiAdvisorDao {
        return database.aiAdvisorDao()
    }
    
    @Provides
    @Singleton
    fun provideAiAdvisorRepository(
        dao: AiAdvisorDao,
        @IoDispatcher dispatcher: CoroutineDispatcher
    ): AiAdvisorRepository {
        return AiAdvisorRepositoryImpl(dao, dispatcher)
    }
    
    @Provides
    fun provideCreateAdvisorSessionUseCase(
        repository: AiAdvisorRepository
    ): CreateAdvisorSessionUseCase {
        return CreateAdvisorSessionUseCase(repository)
    }
    
    @Provides
    fun provideSendAdvisorMessageUseCase(
        aiAdvisorRepository: AiAdvisorRepository,
        aiRepository: AiRepository,
        contactRepository: ContactRepository,
        conversationRepository: ConversationRepository,
        aiProviderRepository: AiProviderRepository
    ): SendAdvisorMessageUseCase {
        return SendAdvisorMessageUseCase(
            aiAdvisorRepository,
            aiRepository,
            contactRepository,
            conversationRepository,
            aiProviderRepository
        )
    }
    
    @Provides
    fun provideGetAdvisorSessionsUseCase(
        repository: AiAdvisorRepository
    ): GetAdvisorSessionsUseCase {
        return GetAdvisorSessionsUseCase(repository)
    }
    
    @Provides
    fun provideGetAdvisorConversationsUseCase(
        repository: AiAdvisorRepository
    ): GetAdvisorConversationsUseCase {
        return GetAdvisorConversationsUseCase(repository)
    }
}
```

---

## 10. æ–‡ä»¶æ¸…å•

### 10.1 æ–°å¢æ–‡ä»¶

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|---------|------|
| :domain | `model/AiAdvisorSession.kt` | ä¼šè¯é¢†åŸŸæ¨¡å‹ |
| :domain | `model/AiAdvisorConversation.kt` | å¯¹è¯è®°å½•é¢†åŸŸæ¨¡å‹ |
| :domain | `model/MessageType.kt` | æ¶ˆæ¯ç±»å‹æšä¸¾ |
| :domain | `repository/AiAdvisorRepository.kt` | ä»“åº“æ¥å£ |
| :domain | `usecase/CreateAdvisorSessionUseCase.kt` | åˆ›å»ºä¼šè¯ç”¨ä¾‹ |
| :domain | `usecase/SendAdvisorMessageUseCase.kt` | å‘é€æ¶ˆæ¯ç”¨ä¾‹ |
| :domain | `usecase/GetAdvisorSessionsUseCase.kt` | è·å–ä¼šè¯åˆ—è¡¨ç”¨ä¾‹ |
| :domain | `usecase/GetAdvisorConversationsUseCase.kt` | è·å–å¯¹è¯è®°å½•ç”¨ä¾‹ |
| :domain | `usecase/DeleteAdvisorConversationUseCase.kt` | åˆ é™¤å¯¹è¯ç”¨ä¾‹ |
| :data | `local/entity/AiAdvisorSessionEntity.kt` | ä¼šè¯æ•°æ®åº“å®ä½“ |
| :data | `local/entity/AiAdvisorConversationEntity.kt` | å¯¹è¯æ•°æ®åº“å®ä½“ |
| :data | `local/dao/AiAdvisorDao.kt` | æ•°æ®è®¿é—®å¯¹è±¡ |
| :data | `repository/AiAdvisorRepositoryImpl.kt` | ä»“åº“å®ç° |
| :presentation | `ui/screen/advisor/AiAdvisorScreen.kt` | ä¸»ç•Œé¢ |
| :presentation | `ui/screen/advisor/AiAdvisorChatScreen.kt` | å¯¹è¯ç•Œé¢ |
| :presentation | `ui/screen/advisor/component/AdvisorMessageBubble.kt` | æ¶ˆæ¯æ°”æ³¡ç»„ä»¶ |
| :presentation | `ui/screen/advisor/component/SessionSelector.kt` | ä¼šè¯é€‰æ‹©å™¨ç»„ä»¶ |
| :presentation | `ui/screen/advisor/component/ContactSelectorDialog.kt` | è”ç³»äººé€‰æ‹©å¯¹è¯æ¡† |
| :presentation | `ui/screen/advisor/component/AiAdvisorInputBar.kt` | è¾“å…¥æ ç»„ä»¶ |
| :presentation | `viewmodel/AiAdvisorViewModel.kt` | ä¸»ç•Œé¢ViewModel |
| :presentation | `viewmodel/AiAdvisorChatViewModel.kt` | å¯¹è¯ç•Œé¢ViewModel |
| :app | `di/AiAdvisorModule.kt` | ä¾èµ–æ³¨å…¥æ¨¡å— |

### 10.2 ä¿®æ”¹æ–‡ä»¶

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|------|---------|---------|
| :domain | `util/SystemPrompts.kt` | æ–°å¢AI_ADVISOR_HEADERå’ŒAI_ADVISOR_FOOTERå¸¸é‡ |
| :data | `local/AppDatabase.kt` | æ–°å¢AiAdvisorDaoã€Entityï¼Œç‰ˆæœ¬å‡çº§åˆ°v13 |
| :data | `local/DatabaseMigrations.kt` | æ–°å¢MIGRATION_12_13 |
| :presentation | `navigation/NavGraph.kt` | æ–°å¢AIå†›å¸ˆå¯¼èˆªè·¯ç”± |
| :presentation | `navigation/NavRoutes.kt` | æ–°å¢AI_ADVISORè·¯ç”±å¸¸é‡ |
| :presentation | `ui/component/BottomNavBar.kt` | æ–°å¢AIå†›å¸ˆå¯¼èˆªé¡¹ |

---

## 11. æµ‹è¯•è®¾è®¡

### 11.1 å•å…ƒæµ‹è¯•

| æµ‹è¯•ç±» | æµ‹è¯•å†…å®¹ |
|-------|---------|
| `CreateAdvisorSessionUseCaseTest` | åˆ›å»ºä¼šè¯æˆåŠŸ/å¤±è´¥åœºæ™¯ |
| `SendAdvisorMessageUseCaseTest` | å‘é€æ¶ˆæ¯å®Œæ•´æµç¨‹ã€AIè°ƒç”¨å¤±è´¥å¤„ç† |
| `GetAdvisorSessionsUseCaseTest` | è·å–ä¼šè¯åˆ—è¡¨ã€ç©ºåˆ—è¡¨å¤„ç† |
| `AiAdvisorRepositoryImplTest` | æ•°æ®åº“CRUDæ“ä½œ |
| `AiAdvisorViewModelTest` | UIçŠ¶æ€ç®¡ç†ã€è”ç³»äººåŠ è½½ |
| `AiAdvisorChatViewModelTest` | å¯¹è¯æµç¨‹ã€ä¼šè¯åˆ‡æ¢ã€è”ç³»äººåˆ‡æ¢ |

### 11.2 é›†æˆæµ‹è¯•

| æµ‹è¯•åœºæ™¯ | éªŒè¯ç‚¹ |
|---------|-------|
| å®Œæ•´å¯¹è¯æµç¨‹ | åˆ›å»ºä¼šè¯ â†’ å‘é€æ¶ˆæ¯ â†’ AIå›å¤ â†’ æ˜¾ç¤ºå¯¹è¯ |
| è”ç³»äººåˆ‡æ¢ | åˆ‡æ¢ç¡®è®¤ â†’ ä¿å­˜å½“å‰å¯¹è¯ â†’ åŠ è½½æ–°è”ç³»äººå¯¹è¯ |
| ä¼šè¯ç®¡ç† | åˆ›å»ºæ–°ä¼šè¯ â†’ åˆ‡æ¢ä¼šè¯ â†’ åˆ é™¤ä¼šè¯ |
| æ•°æ®æŒä¹…åŒ– | é€€å‡ºåº”ç”¨ â†’ é‡æ–°è¿›å…¥ â†’ å¯¹è¯å†å²æ¢å¤ |

### 11.3 UIæµ‹è¯•

| æµ‹è¯•åœºæ™¯ | éªŒè¯ç‚¹ |
|---------|-------|
| åº•éƒ¨å¯¼èˆª | ç‚¹å‡»AIå†›å¸ˆå›¾æ ‡ â†’ æ­£ç¡®è·³è½¬ |
| è”ç³»äººé€‰æ‹© | ç‚¹å‡»è”ç³»äºº â†’ è¿›å…¥å¯¹è¯ç•Œé¢ |
| æ¶ˆæ¯å‘é€ | è¾“å…¥æ–‡æœ¬ â†’ ç‚¹å‡»å‘é€ â†’ æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ â†’ æ˜¾ç¤ºAIå›å¤ |
| æ¶ˆæ¯æ“ä½œ | é•¿æŒ‰æ¶ˆæ¯ â†’ æ˜¾ç¤ºæ“ä½œèœå• â†’ å¤åˆ¶/åˆ é™¤ |

---

## 12. æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|-------|---------|
| å¯¹è¯åŠ è½½æ—¶é—´ | < 200ms | ä»ç‚¹å‡»è”ç³»äººåˆ°æ˜¾ç¤ºå¯¹è¯åˆ—è¡¨ |
| æ¶ˆæ¯å‘é€å“åº”æ—¶é—´ | < 500ms | ä»ç‚¹å‡»å‘é€åˆ°æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ |
| AIå›å¤æ—¶é—´ | < 5s | ä»å‘é€åˆ°æ˜¾ç¤ºAIå›å¤ï¼ˆå–å†³äºAIæœåŠ¡ï¼‰ |
| è”ç³»äººåˆ‡æ¢æ—¶é—´ | < 300ms | ä»ç¡®è®¤åˆ‡æ¢åˆ°æ˜¾ç¤ºæ–°è”ç³»äººå¯¹è¯ |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | < 100ms | å•æ¬¡æŸ¥è¯¢æ“ä½œ |
| å†…å­˜å ç”¨ | < 50MB | AIå†›å¸ˆåŠŸèƒ½è¿è¡Œæ—¶å¢é‡å†…å­˜ |

---

## 13. é”™è¯¯å¤„ç†è®¾è®¡

### 13.1 é”™è¯¯åœºæ™¯ä¸å¤„ç†

| é”™è¯¯åœºæ™¯ | å¤„ç†æ–¹å¼ | ç”¨æˆ·æç¤º |
|---------|---------|---------|
| æœªé…ç½®AIæœåŠ¡å•† | å¼•å¯¼ç”¨æˆ·é…ç½® | "è¯·å…ˆé…ç½®AIæœåŠ¡å•†" |
| AIè°ƒç”¨å¤±è´¥ | æ˜¾ç¤ºé”™è¯¯ï¼Œå…è®¸é‡è¯• | "AIæš‚æ—¶æ— æ³•å›å¤ï¼Œè¯·ç¨åé‡è¯•" |
| ç½‘ç»œé”™è¯¯ | æ˜¾ç¤ºé”™è¯¯ï¼Œå…è®¸é‡è¯• | "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ" |
| æ•°æ®åº“é”™è¯¯ | è®°å½•æ—¥å¿—ï¼Œæ˜¾ç¤ºé€šç”¨é”™è¯¯ | "æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•" |
| è”ç³»äººä¸å­˜åœ¨ | è¿”å›ä¸Šä¸€é¡µ | "è”ç³»äººä¸å­˜åœ¨" |
| AIå“åº”è¶…æ—¶ | æ˜¾ç¤ºè¶…æ—¶æç¤ºï¼Œå…è®¸é‡è¯• | "AIå“åº”è¶…æ—¶ï¼Œè¯·é‡è¯•" |
| APIå¯†é’¥æ— æ•ˆ | å¼•å¯¼ç”¨æˆ·æ£€æŸ¥é…ç½® | "APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®" |

### 13.2 é”™è¯¯çŠ¶æ€UIç»„ä»¶

```kotlin
/**
 * é”™è¯¯çŠ¶æ€å±•ç¤ºç»„ä»¶
 *
 * æä¾›ç»Ÿä¸€çš„é”™è¯¯å±•ç¤ºå’Œé‡è¯•æœºåˆ¶
 */
@Composable
fun ErrorStateView(
    error: AiAdvisorError,
    onRetry: () -> Unit,
    onNavigateToSettings: () -> Unit,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxWidth()
            .padding(16.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        // é”™è¯¯å›¾æ ‡
        Icon(
            imageVector = when (error) {
                is AiAdvisorError.NetworkError -> Icons.Default.WifiOff
                is AiAdvisorError.ApiError -> Icons.Default.Error
                is AiAdvisorError.ConfigError -> Icons.Default.Settings
                else -> Icons.Default.Warning
            },
            contentDescription = null,
            modifier = Modifier.size(48.dp),
            tint = MaterialTheme.colorScheme.error
        )
        
        Spacer(modifier = Modifier.height(16.dp))
        
        // é”™è¯¯æ¶ˆæ¯
        Text(
            text = error.message,
            style = MaterialTheme.typography.bodyLarge,
            textAlign = TextAlign.Center,
            color = MaterialTheme.colorScheme.onSurface
        )
        
        Spacer(modifier = Modifier.height(24.dp))
        
        // æ“ä½œæŒ‰é’®
        when (error) {
            is AiAdvisorError.ConfigError -> {
                // é…ç½®é”™è¯¯ï¼šæ˜¾ç¤º"å»é…ç½®"æŒ‰é’®
                Button(onClick = onNavigateToSettings) {
                    Icon(Icons.Default.Settings, contentDescription = null)
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("å»é…ç½®")
                }
            }
            else -> {
                // å…¶ä»–é”™è¯¯ï¼šæ˜¾ç¤º"é‡è¯•"æŒ‰é’®
                Button(onClick = onRetry) {
                    Icon(Icons.Default.Refresh, contentDescription = null)
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("é‡è¯•")
                }
            }
        }
    }
}

/**
 * AIå†›å¸ˆé”™è¯¯ç±»å‹
 */
sealed class AiAdvisorError(val message: String) {
    class NetworkError(message: String = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ") : AiAdvisorError(message)
    class ApiError(message: String = "AIæš‚æ—¶æ— æ³•å›å¤ï¼Œè¯·ç¨åé‡è¯•") : AiAdvisorError(message)
    class ConfigError(message: String = "è¯·å…ˆé…ç½®AIæœåŠ¡å•†") : AiAdvisorError(message)
    class TimeoutError(message: String = "AIå“åº”è¶…æ—¶ï¼Œè¯·é‡è¯•") : AiAdvisorError(message)
    class DatabaseError(message: String = "æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•") : AiAdvisorError(message)
    class UnknownError(message: String = "å‘ç”ŸæœªçŸ¥é”™è¯¯") : AiAdvisorError(message)
}
```

### 13.3 æ¶ˆæ¯å‘é€å¤±è´¥çŠ¶æ€

```kotlin
/**
 * å‘é€å¤±è´¥çš„æ¶ˆæ¯æ°”æ³¡
 *
 * æ˜¾ç¤ºå‘é€å¤±è´¥çŠ¶æ€å’Œé‡è¯•æŒ‰é’®
 */
@Composable
fun FailedMessageBubble(
    content: String,
    onRetry: () -> Unit,
    onDelete: () -> Unit,
    modifier: Modifier = Modifier
) {
    Row(
        modifier = modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.End,
        verticalAlignment = Alignment.CenterVertically
    ) {
        // é‡è¯•æŒ‰é’®
        IconButton(onClick = onRetry) {
            Icon(
                imageVector = Icons.Default.Refresh,
                contentDescription = "é‡è¯•",
                tint = MaterialTheme.colorScheme.error
            )
        }
        
        // æ¶ˆæ¯æ°”æ³¡ï¼ˆå¸¦é”™è¯¯è¾¹æ¡†ï¼‰
        Surface(
            shape = RoundedCornerShape(16.dp, 4.dp, 16.dp, 16.dp),
            color = MaterialTheme.colorScheme.errorContainer,
            border = BorderStroke(1.dp, MaterialTheme.colorScheme.error),
            modifier = Modifier.widthIn(max = 280.dp)
        ) {
            Column(modifier = Modifier.padding(12.dp)) {
                Text(
                    text = content,
                    style = MaterialTheme.typography.bodyMedium
                )
                Spacer(modifier = Modifier.height(4.dp))
                Text(
                    text = "å‘é€å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•",
                    style = MaterialTheme.typography.labelSmall,
                    color = MaterialTheme.colorScheme.error
                )
            }
        }
    }
}
```

### 13.4 é”™è¯¯æ—¥å¿—

```kotlin
companion object {
    private const val TAG = "AiAdvisor"
}

// é”™è¯¯æ—¥å¿—è®°å½•
try {
    // æ“ä½œ
} catch (e: Exception) {
    Log.e(TAG, "æ“ä½œå¤±è´¥: ${e.message}", e)
    // è¿”å›é”™è¯¯ç»“æœ
}
```

---

## 14. ç›¸å…³æ–‡æ¡£

- [PRD-00026-AIå†›å¸ˆå¯¹è¯åŠŸèƒ½éœ€æ±‚](../PRD/PRD-00026-AIå†›å¸ˆå¯¹è¯åŠŸèƒ½éœ€æ±‚.md)
- [PRD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºéœ€æ±‚](../PRD/PRD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºéœ€æ±‚.md)
- [PRD-00008-è¾“å…¥å†…å®¹èº«ä»½è¯†åˆ«ä¸åŒå‘å¯¹è¯å†å²éœ€æ±‚](../PRD/PRD-00008-è¾“å…¥å†…å®¹èº«ä»½è¯†åˆ«ä¸åŒå‘å¯¹è¯å†å²éœ€æ±‚.md)
- [FD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºåŠŸèƒ½è®¾è®¡](./FD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºåŠŸèƒ½è®¾è®¡.md)
- [FD-00008-è¾“å…¥å†…å®¹èº«ä»½è¯†åˆ«ä¸åŒå‘å¯¹è¯å†å²åŠŸèƒ½è®¾è®¡](./FD-00008-è¾“å…¥å†…å®¹èº«ä»½è¯†åˆ«ä¸åŒå‘å¯¹è¯å†å²åŠŸèƒ½è®¾è®¡.md)

---

## 15. å®ç°è®¡åˆ’

### é˜¶æ®µ1ï¼šæ•°æ®å±‚å®ç°ï¼ˆé¢„è®¡1å¤©ï¼‰

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| åˆ›å»ºé¢†åŸŸæ¨¡å‹ï¼ˆAiAdvisorSessionã€AiAdvisorConversationã€MessageTypeï¼‰ | 1h | P0 |
| åˆ›å»ºæ•°æ®åº“å®ä½“å’ŒDAO | 2h | P0 |
| å®ç°æ•°æ®åº“è¿ç§»è„šæœ¬ | 1h | P0 |
| åˆ›å»ºRepositoryæ¥å£å’Œå®ç° | 2h | P0 |
| ç¼–å†™æ•°æ®å±‚å•å…ƒæµ‹è¯• | 2h | P1 |

### é˜¶æ®µ2ï¼šé¢†åŸŸå±‚å®ç°ï¼ˆé¢„è®¡1å¤©ï¼‰

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| å®ç°CreateAdvisorSessionUseCase | 1h | P0 |
| å®ç°SendAdvisorMessageUseCaseï¼ˆæ ¸å¿ƒï¼‰ | 3h | P0 |
| å®ç°GetAdvisorSessionsUseCase | 0.5h | P0 |
| å®ç°GetAdvisorConversationsUseCase | 0.5h | P0 |
| æ‰©å±•SystemPromptsæ·»åŠ AIå†›å¸ˆæç¤ºè¯ | 1h | P0 |
| ç¼–å†™é¢†åŸŸå±‚å•å…ƒæµ‹è¯• | 2h | P1 |

### é˜¶æ®µ3ï¼šç•Œé¢å±‚å®ç°ï¼ˆé¢„è®¡1.5å¤©ï¼‰

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| å®ç°AiAdvisorScreenä¸»ç•Œé¢ | 2h | P0 |
| å®ç°AiAdvisorChatScreenå¯¹è¯ç•Œé¢ | 3h | P0 |
| å®ç°æ¶ˆæ¯æ°”æ³¡ç»„ä»¶ | 1h | P0 |
| å®ç°ä¼šè¯é€‰æ‹©å™¨ç»„ä»¶ | 1h | P1 |
| å®ç°è”ç³»äººé€‰æ‹©å¯¹è¯æ¡† | 1h | P0 |
| å®ç°è¾“å…¥æ ç»„ä»¶ | 1h | P0 |
| é›†æˆåˆ°åº•éƒ¨å¯¼èˆªæ  | 1h | P0 |
| ç¼–å†™ViewModel | 2h | P0 |

### é˜¶æ®µ4ï¼šé›†æˆæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆé¢„è®¡0.5å¤©ï¼‰

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯• | 2h | P0 |
| æ€§èƒ½ä¼˜åŒ– | 1h | P1 |
| é”™è¯¯å¤„ç†å®Œå–„ | 1h | P0 |
| ç”¨æˆ·ä½“éªŒä¼˜åŒ– | 1h | P1 |

**æ€»é¢„è®¡å·¥ä½œé‡**ï¼š4å¤©

---

## 16. å·²çŸ¥é™åˆ¶ä¸åç»­ä¼˜åŒ–

### 16.1 å½“å‰ç‰ˆæœ¬é™åˆ¶

| é™åˆ¶é¡¹ | å½“å‰å®ç° | åŸå›  | å½±å“ |
|-------|---------|------|------|
| å†å²å¯¹è¯è®°å½•æ¡æ•° | æœ€è¿‘20æ¡ | AIæ¨¡å‹Context Windowé™åˆ¶ | æ— æ³•åˆ†æå®Œæ•´å¯¹è¯å†å² |
| ä¼šè¯ä¸Šä¸‹æ–‡æ¡æ•° | æœ€è¿‘10æ¡ | æ§åˆ¶Tokenæ¶ˆè€— | é•¿å¯¹è¯å¯èƒ½ä¸¢å¤±æ—©æœŸä¸Šä¸‹æ–‡ |
| å•æ¬¡åˆ†ææ·±åº¦ | åŸºäºæ–‡æœ¬æ‘˜è¦ | æ— RAGæ”¯æŒ | æ— æ³•è¿›è¡Œè¯­ä¹‰ç›¸å…³æ€§æ£€ç´¢ |

### 16.2 åç»­ä¼˜åŒ–æ–¹å‘

#### 16.2.1 çŸ­æœŸä¼˜åŒ–ï¼ˆv1.1ï¼‰

| ä¼˜åŒ–é¡¹ | æè¿° | é¢„æœŸæ”¶ç›Š |
|-------|------|---------|
| æ™ºèƒ½å†å²é€‰æ‹© | æ ¹æ®ç”¨æˆ·é—®é¢˜å…³é”®è¯ï¼ŒåŠ¨æ€é€‰æ‹©ç›¸å…³å†å²è®°å½• | æé«˜åˆ†æç›¸å…³æ€§ |
| å†å²æ‘˜è¦ç”Ÿæˆ | ä½¿ç”¨AIç”Ÿæˆå†å²å¯¹è¯æ‘˜è¦ï¼Œå‹ç¼©ä¸Šä¸‹æ–‡ | åœ¨æœ‰é™Tokenå†…åŒ…å«æ›´å¤šä¿¡æ¯ |
| åˆ†é¡µåŠ è½½ä¼˜åŒ– | å¯¹è¯åˆ—è¡¨åˆ†é¡µåŠ è½½ï¼Œå‡å°‘å†…å­˜å ç”¨ | æå‡å¤§é‡å¯¹è¯æ—¶çš„æ€§èƒ½ |

#### 16.2.2 ä¸­æœŸä¼˜åŒ–ï¼ˆv2.0ï¼‰

| ä¼˜åŒ–é¡¹ | æè¿° | é¢„æœŸæ”¶ç›Š |
|-------|------|---------|
| RAGé›†æˆ | å¼•å…¥æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ŒæŒ‰è¯­ä¹‰ç›¸å…³æ€§æ£€ç´¢å†å² | çªç ´Context Windowé™åˆ¶ |
| å‘é‡æ•°æ®åº“ | ä½¿ç”¨æœ¬åœ°å‘é‡æ•°æ®åº“å­˜å‚¨å¯¹è¯åµŒå…¥ | æ”¯æŒè¯­ä¹‰æœç´¢ |
| å¤šè½®å¯¹è¯ä¼˜åŒ– | ä¼˜åŒ–é•¿å¯¹è¯çš„ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥ | æå‡é•¿å¯¹è¯ä½“éªŒ |

#### 16.2.3 é•¿æœŸä¼˜åŒ–ï¼ˆv3.0ï¼‰

| ä¼˜åŒ–é¡¹ | æè¿° | é¢„æœŸæ”¶ç›Š |
|-------|------|---------|
| æœ¬åœ°æ¨¡å‹æ”¯æŒ | æ”¯æŒæœ¬åœ°è¿è¡Œçš„å°å‹LLM | ç¦»çº¿ä½¿ç”¨ã€éšç§å¢å¼º |
| å¤šæ¨¡æ€åˆ†æ | æ”¯æŒå›¾ç‰‡ã€è¯­éŸ³ç­‰å¤šæ¨¡æ€è¾“å…¥ | æ›´ä¸°å¯Œçš„åˆ†æèƒ½åŠ› |
| å…³ç³»å›¾è°± | æ„å»ºè”ç³»äººå…³ç³»çŸ¥è¯†å›¾è°± | æ›´æ·±åº¦çš„å…³ç³»æ´å¯Ÿ |

### 16.3 æŠ€æœ¯å€ºåŠ¡è®°å½•

| å€ºåŠ¡é¡¹ | æè¿° | ä¼˜å…ˆçº§ | è®¡åˆ’è§£å†³ç‰ˆæœ¬ |
|-------|------|-------|-------------|
| ç¡¬ç¼–ç é™åˆ¶å¸¸é‡ | HISTORY_LIMITç­‰å¸¸é‡åº”å¯é…ç½® | P2 | v1.1 |
| ç¼ºå°‘ç¼“å­˜æœºåˆ¶ | è”ç³»äººç”»åƒæ¯æ¬¡éƒ½é‡æ–°æŸ¥è¯¢ | P2 | v1.1 |
| æ— ç¦»çº¿æ”¯æŒ | ç½‘ç»œä¸å¯ç”¨æ—¶æ— æ³•ä½¿ç”¨ | P3 | v2.0 |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.1
**æœ€åæ›´æ–°**: 2026-01-01
**æ›´æ–°å†…å®¹**: 
- æ ¹æ®DR-00026å®¡æŸ¥æŠ¥å‘Šï¼Œæ˜ç¡®å†å²è®°å½•é™åˆ¶è¯´æ˜
- æ–°å¢é”™è¯¯çŠ¶æ€UIç»„ä»¶è®¾è®¡
- æ–°å¢"å·²çŸ¥é™åˆ¶ä¸åç»­ä¼˜åŒ–"ç« èŠ‚
