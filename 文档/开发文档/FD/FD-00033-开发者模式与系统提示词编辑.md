# 功能文档 (FD): 开发者模式与系统提示词编辑

**文档编号**: FD-00033-开发者模式与系统提示词编辑  
**创建日期**: 2026-01-08  
**需求文档**: `文档/开发文档/PRD/PRD-00033-开发者模式与系统提示词编辑.md`  
**技术设计**: `文档/开发文档/TDD/TDD-00033-开发者模式与系统提示词编辑技术设计.md`  
**状态**: 待开始  
**负责人**: Kiro

---

## 任务格式说明

- **[P]**: 可并行执行（不同文件，无依赖）
- **[US?]**: 所属用户故事
  - US1: 开发者模式入口
  - US2: 系统提示词编辑
  - US3: 导入导出功能

> **说明**：开发者模式支持编辑5个AI场景的系统提示词（ANALYZE、POLISH、REPLY、SUMMARY、AI_ADVISOR）。
> CHECK和EXTRACT场景已废弃（TD-00015），不在开发者模式中显示。

---

## 路径约定

基于项目多模块结构：
- **领域层**: `domain/src/main/kotlin/com/empathy/ai/domain/`
- **数据层**: `data/src/main/kotlin/com/empathy/ai/data/`
- **表现层**: `presentation/src/main/kotlin/com/empathy/ai/presentation/`
- **应用层**: `app/src/main/java/com/empathy/ai/`

---

## 阶段 1: 基础设置

**目标**: 创建数据模型和基础结构

- [ ] T001 [P] 创建 `SystemPromptScene` 枚举 `domain/model/SystemPromptScene.kt`
- [ ] T002 [P] 创建 `SystemPromptConfig` 数据模型 `domain/model/SystemPromptConfig.kt`
- [ ] T003 [P] 创建 `SceneSystemPrompt` 数据模型 `domain/model/SystemPromptConfig.kt`
- [ ] T004 [P] 创建 `SystemPromptExport` 导出模型 `domain/model/SystemPromptExport.kt`

**检查点**: 领域模型创建完成，可编译通过

---

## 阶段 2: 基础架构（阻塞性前置条件）

**目标**: 必须在任何用户故事开始前完成的核心基础设施

**⚠️ 关键**: 此阶段完成前不能开始任何用户故事

- [ ] T005 创建 `SystemPromptRepository` 接口 `domain/repository/SystemPromptRepository.kt`
- [ ] T006 创建 `SystemPromptStorage` 存储类 `data/local/SystemPromptStorage.kt`
- [ ] T007 实现 `SystemPromptRepositoryImpl` `data/repository/SystemPromptRepositoryImpl.kt`
- [ ] T008 更新 `PromptModule` 添加DI配置 `data/di/PromptModule.kt`
- [ ] T009 添加 `SystemPromptSceneAdapter` Moshi适配器 `data/di/NetworkModule.kt`

**检查点**: 基础架构就绪，Repository可正常注入和使用

---

## 阶段 3: 用户故事 1 - 开发者模式入口 (优先级: P0) 🎯 MVP

**目标**: 实现点击版本号7次解锁开发者模式

**独立测试**: 点击版本号7次后，设置页面显示"开发者选项"区域

### 用户故事 1 的实现

- [ ] T010 [US1] 创建 `DeveloperModeViewModel` `presentation/viewmodel/DeveloperModeViewModel.kt`
- [ ] T011 [US1] 创建 `DeveloperOptionsSection` 组件 `presentation/ui/screen/settings/component/DeveloperOptionsSection.kt`
- [ ] T012 [US1] 修改 `SettingsScreen` 添加版本号点击逻辑 `presentation/ui/screen/settings/SettingsScreen.kt`
- [ ] T013 [US1] 修改 `SettingsViewModel` 集成开发者模式状态 `presentation/viewmodel/SettingsViewModel.kt`

**检查点**: 用户故事 1 完成
- ✅ 点击版本号7次能解锁开发者模式
- ✅ 解锁后显示"开发者选项"区域
- ✅ App重启后需要重新解锁

---

## 阶段 4: 用户故事 2 - 系统提示词编辑 (优先级: P0) 🎯 MVP

**目标**: 实现5个核心场景的Header/Footer编辑功能

**独立测试**: 可以编辑任意场景的提示词并保存，修改后立即生效

### 用户故事 2 的实现

- [ ] T014 [US2] 创建 `SystemPromptListViewModel` `presentation/viewmodel/SystemPromptListViewModel.kt`
- [ ] T015 [US2] 创建 `SystemPromptListUiState` `presentation/viewmodel/SystemPromptListViewModel.kt`
- [ ] T016 [US2] 创建 `SystemPromptListScreen` `presentation/ui/screen/developer/SystemPromptListScreen.kt`
- [ ] T017 [P] [US2] 创建 `SceneListItem` 组件 `presentation/ui/screen/developer/SystemPromptListScreen.kt`
- [ ] T018 [US2] 创建 `SystemPromptEditViewModel` `presentation/viewmodel/SystemPromptEditViewModel.kt`
- [ ] T019 [US2] 创建 `SystemPromptEditUiState` `presentation/viewmodel/SystemPromptEditViewModel.kt`
- [ ] T020 [US2] 创建 `SystemPromptEditScreen` `presentation/ui/screen/developer/SystemPromptEditScreen.kt`
- [ ] T021 [P] [US2] 创建 `PromptEditSection` 组件 `presentation/ui/screen/developer/SystemPromptEditScreen.kt`
- [ ] T022 [US2] 添加导航路由定义 `presentation/navigation/NavRoutes.kt`
- [ ] T023 [US2] 配置导航图 `presentation/navigation/NavGraph.kt`

**检查点**: 用户故事 2 完成
- ✅ 可以查看5个核心场景列表
- ✅ 可以编辑每个场景的Header和Footer
- ✅ 保存后立即生效
- ✅ 支持恢复单个场景默认值

---

## 阶段 5: 核心集成

**目标**: 将自定义配置集成到现有提示词系统

- [ ] T024 修改 `SystemPrompts.kt` 支持自定义配置 `domain/util/SystemPrompts.kt`
  - 添加 `setCustomConfigProvider` 方法
  - 修改 `getHeader` 和 `getFooter` 方法优先读取自定义配置
  - 实现 fallback 到默认值逻辑
- [ ] T025 更新 `EmpathyApplication` 初始化配置提供者 `app/EmpathyApplication.kt`

**检查点**: 核心集成完成
- ✅ 自定义配置能覆盖默认值
- ✅ 配置损坏时能fallback到默认值
- ✅ AI调用使用新配置

---

## 阶段 6: 用户故事 3 - 导入导出功能 (优先级: P1)

**目标**: 实现配置的导入导出功能

**独立测试**: 可以导出配置为JSON/MD格式，可以从文件导入配置

### 用户故事 3 的实现

- [ ] T026 [US3] 实现 `exportToJson` 方法 `data/repository/SystemPromptRepositoryImpl.kt`
- [ ] T027 [P] [US3] 实现 `exportToMarkdown` 方法 `data/repository/SystemPromptRepositoryImpl.kt`
- [ ] T028 [US3] 实现 `importFromJson` 方法 `data/repository/SystemPromptRepositoryImpl.kt`
- [ ] T029 [US3] 创建 `ExportDialog` 组件 `presentation/ui/screen/developer/ExportDialog.kt`
- [ ] T030 [P] [US3] 创建 `ImportDialog` 组件 `presentation/ui/screen/developer/ImportDialog.kt`
- [ ] T031 [US3] 在 `SystemPromptListScreen` 集成导入导出功能

**检查点**: 用户故事 3 完成
- ✅ 支持导出为JSON格式
- ✅ 支持导出为Markdown格式
- ✅ 支持从JSON文件导入
- ✅ 导入前显示预览确认

---

## 阶段 7: 收尾与优化

**目标**: 测试、文档和代码优化

- [ ] T032 [P] 编写 `SystemPromptConfigTest` 单元测试 `domain/src/test/.../model/SystemPromptConfigTest.kt`
- [ ] T033 [P] 编写 `SystemPromptRepositoryImplTest` 单元测试 `data/src/test/.../repository/SystemPromptRepositoryImplTest.kt`
- [ ] T034 [P] 编写 `DeveloperModeViewModelTest` 单元测试 `presentation/src/test/.../viewmodel/DeveloperModeViewModelTest.kt`
- [ ] T035 [P] 编写 `SystemPromptEditViewModelTest` 单元测试 `presentation/src/test/.../viewmodel/SystemPromptEditViewModelTest.kt`
- [ ] T036 代码审查和重构
- [ ] T037 更新相关文档

**检查点**: 功能完整可用
- ✅ 所有单元测试通过
- ✅ 代码符合Clean Architecture规范
- ✅ 无编译错误和警告

---

## 依赖关系与执行顺序

### 阶段依赖

- **阶段 1 (基础设置)**: 无依赖 - 可立即开始
- **阶段 2 (基础架构)**: 依赖阶段1完成 - 阻塞所有用户故事
- **阶段 3 (US1 开发者模式入口)**: 依赖阶段2完成
- **阶段 4 (US2 系统提示词编辑)**: 依赖阶段2完成，可与阶段3并行
- **阶段 5 (核心集成)**: 依赖阶段4完成
- **阶段 6 (US3 导入导出)**: 依赖阶段4完成
- **阶段 7 (收尾)**: 依赖所有用户故事完成

### 并行机会

```
阶段1: T001 ─┬─ T002 ─┬─ T003 ─┬─ T004
             │        │        │
             └────────┴────────┴──→ 阶段2

阶段2: T005 → T006 → T007 → T008 → T009

阶段3和阶段4可并行:
  阶段3: T010 → T011 → T012 → T013
  阶段4: T014 → T015 → T016 → ... → T023

阶段7测试任务可并行:
  T032 ─┬─ T033 ─┬─ T034 ─┬─ T035
        │        │        │
        └────────┴────────┴──→ T036 → T037
```

---

## 实施策略

### MVP 优先（用户故事 1 + 2）

1. 完成阶段 1: 基础设置
2. 完成阶段 2: 基础架构（关键 - 阻塞所有故事）
3. 完成阶段 3: 用户故事 1（开发者模式入口）
4. 完成阶段 4: 用户故事 2（系统提示词编辑）
5. 完成阶段 5: 核心集成
6. **停止并验证**: 独立测试MVP功能
7. 如果就绪则部署/演示

### 增量交付

1. 完成设置 + 基础架构 → 基础就绪
2. 添加用户故事 1 → 独立测试 → 开发者模式可用
3. 添加用户故事 2 + 核心集成 → 独立测试 → 编辑功能可用 (MVP!)
4. 添加用户故事 3 → 独立测试 → 导入导出可用
5. 每个故事增加价值而不破坏之前的故事

---

## 任务统计

| 阶段 | 任务数 | 预估工时 |
|------|--------|---------|
| 阶段 1: 基础设置 | 4 | 2h |
| 阶段 2: 基础架构 | 5 | 4h |
| 阶段 3: US1 开发者模式入口 | 4 | 3h |
| 阶段 4: US2 系统提示词编辑 | 10 | 6h |
| 阶段 5: 核心集成 | 2 | 1.5h |
| 阶段 6: US3 导入导出 | 6 | 3.5h |
| 阶段 7: 收尾与优化 | 6 | 4h |
| **总计** | **37** | **24h** |

---

## 验收标准

### 功能验收（P0 - 核心功能）

- [ ] **AC-001** 点击版本号7次能解锁开发者模式
- [ ] **AC-002** 解锁后设置页面显示"开发者选项"区域
- [ ] **AC-003** 可以编辑5个核心场景的Header和Footer（ANALYZE、POLISH、REPLY、SUMMARY、AI_ADVISOR）
- [ ] **AC-004** 保存后立即生效，无需重启App
- [ ] **AC-005** App重启后需要重新解锁开发者模式

### 功能验收（P1 - 扩展功能）

- [ ] **AC-006** 支持导出为JSON格式
- [ ] **AC-007** 支持导出为Markdown格式
- [ ] **AC-008** 支持从文件导入配置
- [ ] **AC-009** 导入前显示预览确认
- [ ] **AC-010** 支持恢复单个场景的默认配置
- [ ] **AC-011** 支持恢复全部场景的默认配置

### 技术验收

- [ ] **TC-001** 代码符合Clean Architecture规范
- [ ] **TC-002** 新组件放置在正确目录
- [ ] **TC-003** 无编译错误和警告
- [ ] **TC-004** 单元测试覆盖核心逻辑

---

**文档版本**: 1.2  
**最后更新**: 2026-01-08  
**更新者**: Kiro  
**更新说明**: 
- v1.1: 根据SUMMARY-00001审查报告，将场景数量从6个调整为4个核心场景
- v1.2: 添加第5个场景AI_ADVISOR（AI军师），支持AI军师对话模式的系统提示词编辑
