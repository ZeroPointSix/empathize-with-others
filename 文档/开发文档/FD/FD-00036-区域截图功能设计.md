# FD-00036-区域截图功能设计

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | FD (Functional Document) |
| 文档编号 | FD-00036 |
| 功能名称 | 悬浮窗区域截图输入 |
| 版本 | 1.2 |
| 创建日期 | 2026-01-12 |
| 作者 | Codex |
| 审核人 | 待定 |
| 状态 | 草稿 |
| 关联PRD | PRD-00036-区域截图功能需求 |

## 版本历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| 1.0 | 2026-01-12 | Codex | 初始版本 |
| 1.1 | 2026-01-12 | Codex | 对齐审查建议，补充权限/集成/失败处理并收敛交互范围 |
| 1.2 | 2026-01-12 | Codex | 同步实现落点，更新悬浮窗接入路径与权限组件 |

## 1. 设计目标

1. 任意 App 内通过悬浮窗快速截取区域并插入当前会话输入框  
2. 截图作为临时附件，发送后自动清理  
3. 连续截屏默认关闭，用户可选开启  

## 2. 设计范围

### 2.1 包含范围

- 悬浮窗新增区域截图入口  
- 全屏半透明遮罩 + 矩形取景框交互  
- 1.5s 连续截屏模式  
- 输入框上方缩略图列表与删除  
- 模型不支持图片的降级提示与请求过滤  
- 图片压缩与上传前处理  
- 发送后自动清理  

### 2.2 不包含范围

- 录屏或视频上传  
- 图片编辑/标注/涂鸦  
- 事实流长期保存  

## 3. 功能设计

### 3.1 入口与权限

- 悬浮窗新增“区域截图”图标  
- 首次启用引导用户到设置页授权 MediaProjection  
- 若系统限制导致每次都需确认，允许弹窗确认的降级体验  
- 兼容 Android 10+  

### 3.2 截图遮罩与框选

#### 3.2.1 遮罩层

- 全屏半透明遮罩覆盖  
- 取景框区域挖空，边框高亮  
- 截图时悬浮窗自动隐藏  
- 截图前短暂隐藏遮罩，避免遮罩被截入  

#### 3.2.2 框选交互

- 用户在空白区域拖拽生成矩形，松手即截图  
- 不记忆上次取景框位置和大小  

### 3.3 连续截屏（设置项）

- 设置项：连续截屏（默认关闭）  
- 开启后：截图完成后遮罩保留 1.5s  
- 1.5s 内可再次拖拽继续截图  
- 遮罩顶部提示“继续拖拽可截下一张”  
- 超时自动退出截图模式  

### 3.4 输入框缩略图列表

- 截图完成后插入当前悬浮窗会话输入框  
- 输入框上方横向缩略图列表  
- 每个缩略图带删除按钮  
- 单次消息最多 5 张  
- 超过上限时丢弃最新截图  
- 可选轻提示：已达上限  

### 3.5 模型兼容与降级

- 用户可选择模型  
- 本地判断模型是否支持图片理解  
- 预置模型支持能力在配置中标记，用户自定义模型默认不支持，可在 AI 配置页设置  
- 不支持图片时：请求不携带截图  
- 提示文案：当前模型不支持图片理解，已仅发送文字内容  

### 3.6 发送与清理

- 截图仅作为当前消息临时附件  
- 发送成功后清理本地截图文件  
- 用户手动删除缩略图时同步删除本地文件  
- 发送失败时保留附件，允许用户重试或手动删除  
- 悬浮窗关闭时清理残留截图文件  

### 3.7 图片压缩策略

- 上传前压缩  
- 长边限制 1280px  
- 质量 0.85，目标体积 <= 1MB  
- 若仍超标，质量降至 0.7  

### 3.8 取消与退出

- 无操作 1.5s 自动退出截图模式  
- 退出后悬浮窗自动恢复显示  

## 4. 交互流程

1. 点击悬浮窗“区域截图”图标  
2. 校验权限并引导授权  
3. 全屏遮罩显示，用户拖拽框选  
4. 松手截图 → 压缩 → 插入输入框缩略图列表  
5. 连续截屏开启时保留遮罩 1.5s 可继续  
6. 用户补充文字并发送  
7. 发送成功后清理本地截图  

## 5. UI 设计

### 5.1 遮罩层示意

```
全屏半透明遮罩 + 矩形取景框挖空
```

### 5.2 输入框缩略图列表

```
┌─────────────────────────────────────────┐
│ [缩略图1][缩略图2][缩略图3]  (×可删)    │
├─────────────────────────────────────────┤
│ 输入框（用户补充文字）                  │
└─────────────────────────────────────────┘
```

## 6. 状态与数据设计

### 6.1 状态机（截图流程）

- Idle：未进入截图  
- Selecting：遮罩显示，等待拖拽框选  
- Captured：完成截图并进入压缩处理  
- WaitingNext：连续截屏开启后的等待窗口  
- Done：退出截图模式  

### 6.2 数据结构（示意）

```kotlin
data class ScreenshotAttachment(
    val id: String,
    val localPath: String,
    val width: Int,
    val height: Int,
    val sizeBytes: Long,
    val createdAt: Long
)

data class ChatInputState(
    val inputText: String,
    val attachments: List<ScreenshotAttachment>
)
```

## 7. 异常与边界处理

- 权限未授权：提示引导并退出截图模式  
- 截图失败：提示失败并退出  
- 压缩失败：提示失败并退出  
- 附件已达上限：丢弃最新截图  
- 发送失败：保留附件供重试  

## 8. 集成点

- 悬浮窗 UI：`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/floating/FloatingViewV2.kt`  
  - 新增区域截图按钮与缩略图列表  
- 悬浮窗布局：`app/src/main/res/layout/floating_tab_content.xml`、`presentation/src/main/res/layout/floating_tab_content.xml`  
- 截图授权入口：`app/src/main/java/com/empathy/ai/ui/ScreenshotPermissionActivity.kt`  
- 悬浮窗 Service：`app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt`  
  - 截图入口、权限引导、遮罩显示、附件管理  
- 发送流程：`data/src/main/kotlin/com/empathy/ai/data/remote/model/*`  
  - 携带附件或降级过滤  
- 模型管理：`domain/src/main/kotlin/com/empathy/ai/domain/model/AiModel.kt`  
  - 标记模型是否支持图片理解  
- 文案与权限：  
  - `app/src/main/res/values/strings.xml`  
  - `app/src/main/AndroidManifest.xml`  

## 9. 验收标准

- 入口可触发区域截图  
- 遮罩拖拽框选，松手即截图  
- 缩略图列表可删除  
- 单次最多 5 张，超出丢弃最新  
- 连续截屏开启时 1.5s 内可继续  
- 不支持图片模型不发送截图并提示  
- 发送成功后清理本地截图  
- Android 10+ 可用  

## 10. 待确认

- 压缩与上传耗时过长时是否需要显示“处理中”状态  
