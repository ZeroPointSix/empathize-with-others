# 悬浮窗权限修复说明

## 问题描述

用户反馈：设置界面的悬浮窗功能无法开启，无法在系统的设置权限中找到"共情AI"应用。

## 根本原因

`AndroidManifest.xml` 中缺少必要的权限声明和服务注册。

## 解决方案

### 1. 添加悬浮窗权限声明

在 `AndroidManifest.xml` 中添加了以下权限：

```xml
<!-- 悬浮窗权限 (用于悬浮窗功能) -->
<uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />

<!-- 前台服务权限 (Android 9.0+) -->
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />

<!-- 前台服务类型 (Android 14+) -->
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />
```

### 2. 注册悬浮窗服务

在 `AndroidManifest.xml` 的 `<application>` 标签中添加了服务声明：

```xml
<!-- 悬浮窗服务 -->
<service
    android:name=".domain.service.FloatingWindowService"
    android:enabled="true"
    android:exported="false"
    android:foregroundServiceType="specialUse">
    <property
        android:name="android.app.PROPERTY_SPECIAL_USE_FGS_SUBTYPE"
        android:value="AI助手悬浮窗服务" />
</service>
```

## 权限说明

### SYSTEM_ALERT_WINDOW
- **用途**: 允许应用在其他应用上层显示悬浮窗
- **权限级别**: 特殊权限（需要用户手动授权）
- **授权方式**: 通过系统设置页面授权

### FOREGROUND_SERVICE
- **用途**: 允许应用运行前台服务
- **权限级别**: 普通权限（安装时自动授予）
- **Android 版本**: Android 9.0 (API 28) 及以上需要

### FOREGROUND_SERVICE_SPECIAL_USE
- **用途**: 声明前台服务的特殊用途类型
- **权限级别**: 普通权限
- **Android 版本**: Android 14 (API 34) 及以上需要

## 测试步骤

### 1. 重新编译安装应用

```bash
./gradlew clean
./gradlew assembleDebug
./gradlew installDebug
```

或者在 Android Studio 中点击 "Run" 按钮。

### 2. 检查权限是否正确声明

打开应用后，进入设置页面，查看悬浮窗设置区域：

- ✅ 如果显示"需要悬浮窗权限"，说明权限声明成功
- ❌ 如果没有任何提示，说明权限声明失败

### 3. 授权悬浮窗权限

#### 方法一：通过应用内引导（推荐）

1. 打开"共情AI"应用
2. 进入"设置"页面
3. 找到"悬浮窗功能"区域
4. 点击"需要悬浮窗权限"卡片中的箭头图标
5. 在弹出的对话框中点击"前往设置"
6. 系统会自动跳转到悬浮窗权限设置页面
7. 开启"允许显示在其他应用的上层"开关
8. 返回应用，悬浮窗开关应该可以正常使用了

#### 方法二：通过系统设置手动授权

1. 打开手机的"设置"应用
2. 进入"应用管理"或"应用"
3. 找到并点击"共情AI"
4. 进入"权限管理"或"权限"
5. 找到"显示在其他应用的上层"或"悬浮窗"权限
6. 开启该权限
7. 返回应用，悬浮窗开关应该可以正常使用了

### 4. 测试悬浮窗功能

授权后，在设置页面：

1. 开启"启用悬浮窗"开关
2. 应该看到成功提示："悬浮窗服务已启动"
3. 切换到其他应用（如微信），应该能看到悬浮窗按钮
4. 返回设置页面，关闭"启用悬浮窗"开关
5. 应该看到成功提示："悬浮窗服务已停止"

## 不同 Android 版本的差异

### Android 6.0 - 8.1 (API 23-27)
- 只需要 `SYSTEM_ALERT_WINDOW` 权限
- 不需要前台服务权限

### Android 9.0 - 13 (API 28-33)
- 需要 `SYSTEM_ALERT_WINDOW` 权限
- 需要 `FOREGROUND_SERVICE` 权限

### Android 14+ (API 34+)
- 需要 `SYSTEM_ALERT_WINDOW` 权限
- 需要 `FOREGROUND_SERVICE` 权限
- 需要 `FOREGROUND_SERVICE_SPECIAL_USE` 权限
- 需要在服务声明中指定 `foregroundServiceType="specialUse"`

## 常见问题

### Q1: 为什么在系统设置中找不到"共情AI"应用？

**A**: 可能的原因：
1. 应用没有正确安装（尝试卸载后重新安装）
2. 权限声明有误（检查 `AndroidManifest.xml`）
3. 应用包名不匹配（检查 `build.gradle.kts` 中的 `applicationId`）

### Q2: 授权后悬浮窗开关仍然无法开启？

**A**: 可能的原因：
1. 服务没有正确注册（检查 `AndroidManifest.xml` 中的 `<service>` 声明）
2. 服务启动失败（查看 Logcat 日志）
3. 权限检查逻辑有误（检查 `FloatingWindowManager.hasPermission()` 方法）

### Q3: 悬浮窗开启后立即崩溃？

**A**: 可能的原因：
1. 前台服务通知创建失败（检查通知渠道是否正确创建）
2. 悬浮窗视图创建失败（检查 `FloatingView` 的实现）
3. 内存不足（检查设备可用内存）

## 验证清单

- ✅ `AndroidManifest.xml` 中声明了 `SYSTEM_ALERT_WINDOW` 权限
- ✅ `AndroidManifest.xml` 中声明了 `FOREGROUND_SERVICE` 权限
- ✅ `AndroidManifest.xml` 中声明了 `FOREGROUND_SERVICE_SPECIAL_USE` 权限
- ✅ `AndroidManifest.xml` 中注册了 `FloatingWindowService` 服务
- ✅ 服务声明中指定了 `foregroundServiceType="specialUse"`
- ✅ 服务声明中添加了 `PROPERTY_SPECIAL_USE_FGS_SUBTYPE` 属性
- ✅ 代码通过编译检查（无诊断错误）

## 相关文件

- `app/src/main/AndroidManifest.xml` - 权限和服务声明
- `app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt` - 悬浮窗服务实现
- `app/src/main/java/com/empathy/ai/domain/util/FloatingWindowManager.kt` - 悬浮窗管理工具
- `app/src/main/java/com/empathy/ai/presentation/viewmodel/SettingsViewModel.kt` - 设置页面逻辑
- `app/src/main/java/com/empathy/ai/presentation/ui/screen/settings/SettingsScreen.kt` - 设置页面UI

## 修改记录

| 日期 | 修改内容 | 修改人 |
|------|----------|--------|
| 2024-12-13 | 添加悬浮窗权限声明和服务注册 | Kiro |
