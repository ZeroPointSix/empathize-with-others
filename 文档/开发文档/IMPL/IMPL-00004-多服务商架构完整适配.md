# IMPL-00004: å¤šæœåŠ¡å•†æ¶æ„å®Œæ•´é€‚é…

## ğŸ“‹ é—®é¢˜æè¿°

### é”™è¯¯ç°è±¡
```
FloatingWindowService: åˆ†æå¤±è´¥ (Ask Gemini)
java.lang.Exception: API Key not found. Please configure your API Key in settings.
at com.empathy.ai.data.repository.settings.SettingsRepositoryImpl.getProviderHeaders:180
at com.empathy.ai.data.repository.AiRepositoryImpl.analyzeChat:89
```

### æ ¹æœ¬åŸå› 

**ç¬¬äºŒå±‚æ¶æ„é—ç•™é—®é¢˜**ï¼šè™½ç„¶UseCaseå±‚å·²ç»ä¿®å¤ï¼ˆIMPL-00003ï¼‰ï¼Œä½†Repositoryå±‚ä»åœ¨ä½¿ç”¨æ—§çš„é…ç½®ç³»ç»Ÿã€‚

#### é—®é¢˜é“¾è·¯

```
AnalyzeChatUseCase (å·²ä¿®å¤ âœ…)
  â†“ æ£€æŸ¥ defaultProvider
  â†“ è°ƒç”¨ aiRepository.analyzeChat(promptContext, systemInstruction)
  â†“
AiRepositoryImpl (æœªä¿®å¤ âŒ)
  â†“ ä»è°ƒç”¨ settingsRepository.getProviderHeaders()
  â†“
SettingsRepositoryImpl (æ—§ç³»ç»Ÿ)
  â†“ æŸ¥æ‰¾æ—§çš„å•ä¸€ API Key
  â†“ æ‰¾ä¸åˆ° â†’ æŠ›å‡ºå¼‚å¸¸ âŒ
```

#### æ ¸å¿ƒé—®é¢˜

1. **UseCaseè·å–äº†defaultProviderï¼Œä½†æœªä¼ é€’ç»™Repository**
2. **Repositoryä¸çŸ¥é“åº”è¯¥ç”¨å“ªä¸ªæœåŠ¡å•†çš„é…ç½®**
3. **Repositoryå›é€€åˆ°æ—§çš„å•ä¸€API KeyæŸ¥æ‰¾é€»è¾‘**

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**è®©æ•´ä¸ªè°ƒç”¨é“¾è·¯éƒ½ä½¿ç”¨å¤šæœåŠ¡å•†æ¶æ„ï¼Œä»UseCaseåˆ°Repositoryå®Œæ•´ä¼ é€’providerä¿¡æ¯**

### ä¿®æ”¹æ–‡ä»¶æ¸…å•

#### 1. AiRepository.ktï¼ˆæ¥å£å±‚ï¼‰âœ…

**ä¿®æ”¹å†…å®¹ï¼š** æ‰€æœ‰æ–¹æ³•æ·»åŠ  `provider` å‚æ•°

```kotlin
interface AiRepository {
    // âœ… æ·»åŠ  provider å‚æ•°
    suspend fun analyzeChat(
        provider: AiProvider,  // ğŸ†• æ–°å¢
        promptContext: String,
        systemInstruction: String
    ): Result<AnalysisResult>
    
    suspend fun checkDraftSafety(
        provider: AiProvider,  // ğŸ†• æ–°å¢
        draft: String,
        riskRules: List<String>
    ): Result<SafetyCheckResult>
    
    suspend fun extractTextInfo(
        provider: AiProvider,  // ğŸ†• æ–°å¢
        inputText: String
    ): Result<ExtractedData>
}
```

#### 2. AiRepositoryImpl.ktï¼ˆå®ç°å±‚ï¼‰âœ…

**ä¿®æ”¹å‰ï¼ˆanalyzeChatæ–¹æ³•ï¼‰ï¼š**
```kotlin
override suspend fun analyzeChat(
    promptContext: String,
    systemInstruction: String
): Result<AnalysisResult> {
    // âŒ ä»æ—§é…ç½®ç³»ç»Ÿè·å–
    val urlResult = settingsRepository.getBaseUrl()
    val headersResult = settingsRepository.getProviderHeaders()
    
    val url = urlResult.getOrThrow()
    val headers = headersResult.getOrThrow()
    
    // âŒ ä»æ—§é…ç½®ç³»ç»Ÿæ¨æ–­æ¨¡å‹
    val providerResult = settingsRepository.getAiProvider()
    val provider = providerResult.getOrDefault("OpenAI")
    val model = when (provider) {
        "OpenAI" -> MODEL_OPENAI
        "DeepSeek" -> MODEL_DEEPSEEK
        else -> MODEL_OPENAI
    }
}
```

**ä¿®æ”¹åï¼š**
```kotlin
override suspend fun analyzeChat(
    provider: AiProvider,  // âœ… æ¥æ”¶providerå‚æ•°
    promptContext: String,
    systemInstruction: String
): Result<AnalysisResult> {
    // âœ… ç›´æ¥ä»providerè·å–é…ç½®
    val url = provider.baseUrl
    val headers = mapOf(
        "Authorization" to "Bearer ${provider.apiKey}",
        "Content-Type" to "application/json"
    )
    
    // âœ… ä½¿ç”¨providerçš„æ¨¡å‹é…ç½®
    val model = if (provider.defaultModelId.isNotBlank()) {
        provider.defaultModelId
    } else {
        // æ ¹æ®åç§°æ¨æ–­
        when {
            provider.name.contains("DeepSeek", ignoreCase = true) -> MODEL_DEEPSEEK
            provider.name.contains("OpenAI", ignoreCase = true) -> MODEL_OPENAI
            else -> MODEL_OPENAI
        }
    }
}
```

**åŒæ ·ä¿®æ”¹ï¼š**
- `checkDraftSafety()` æ–¹æ³•
- `extractTextInfo()` æ–¹æ³•

#### 3. AnalyzeChatUseCase.kt âœ…

**ä¿®æ”¹è°ƒç”¨æ–¹å¼ï¼š**
```kotlin
// âŒ æ—§ï¼šæœªä¼ é€’provider
val analysisResult = aiRepository.analyzeChat(prompt, systemInstruction).getOrThrow()

// âœ… æ–°ï¼šä¼ é€’provideré…ç½®
val analysisResult = aiRepository.analyzeChat(
    provider = defaultProvider,
    promptContext = prompt,
    systemInstruction = systemInstruction
).getOrThrow()
```

#### 4. CheckDraftUseCase.kt âœ…

**æ·»åŠ ä¾èµ–æ³¨å…¥ï¼š**
```kotlin
class CheckDraftUseCase @Inject constructor(
    private val brainTagRepository: BrainTagRepository,
    private val privacyRepository: PrivacyRepository,
    private val aiRepository: AiRepository,
    private val settingsRepository: SettingsRepository,
    private val aiProviderRepository: AiProviderRepository  // ğŸ†• æ–°å¢
) {
```

**ä¿®æ”¹AIè°ƒç”¨ï¼š**
```kotlin
// è·å–é»˜è®¤æœåŠ¡å•†
val defaultProvider = aiProviderRepository.getDefaultProvider().getOrNull()
if (defaultProvider == null) {
    return Result.failure(IllegalStateException("æœªé…ç½®é»˜è®¤ AI æœåŠ¡å•†"))
}

// è°ƒç”¨AIæ£€æŸ¥ï¼ˆä¼ é€’providerï¼‰
val deepCheckResult = aiRepository.checkDraftSafety(
    provider = defaultProvider,
    draft = maskedDraft,
    riskRules = riskRules
).getOrThrow()
```

#### 5. FeedTextUseCase.kt âœ…

**æ·»åŠ ä¾èµ–æ³¨å…¥å’Œprovideræ£€æŸ¥ï¼š**
```kotlin
class FeedTextUseCase @Inject constructor(
    private val aiRepository: AiRepository,
    private val privacyRepository: PrivacyRepository,
    private val aiProviderRepository: AiProviderRepository  // ğŸ†• æ–°å¢
) {
    suspend operator fun invoke(
        contactId: String,
        rawText: String
    ): Result<ExtractedData> {
        // 1. è·å–é»˜è®¤æœåŠ¡å•†
        val defaultProvider = aiProviderRepository.getDefaultProvider().getOrNull()
        if (defaultProvider == null) {
            return Result.failure(IllegalStateException("æœªé…ç½®é»˜è®¤ AI æœåŠ¡å•†"))
        }
        
        // 2. è°ƒç”¨AIèƒå–ï¼ˆä¼ é€’providerï¼‰
        val extractResult = aiRepository.extractTextInfo(
            provider = defaultProvider,
            inputText = maskedText
        )
    }
}
```

#### 6. AnalyzeChatUseCaseTest.kt âœ…

**æ›´æ–°æ‰€æœ‰Mockè°ƒç”¨ï¼š**
```kotlin
// âŒ æ—§ï¼šä¸¤ä¸ªå‚æ•°
coEvery { aiRepository.analyzeChat(any(), any()) } returns Result.success(expectedResult)

// âœ… æ–°ï¼šä¸‰ä¸ªå‚æ•°ï¼ˆprovider, promptContext, systemInstructionï¼‰
coEvery { aiRepository.analyzeChat(any(), any(), any()) } returns Result.success(expectedResult)

// éªŒè¯è°ƒç”¨æ—¶ä¹Ÿè¦åŒ¹é…æ–°ç­¾å
coVerify {
    aiRepository.analyzeChat(
        provider = any(),
        promptContext = capture(promptSlot),
        systemInstruction = any()
    )
}
```

---

## ğŸ“Š æ¶æ„åˆ†æ

### ä¿®å¤å‰çš„æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UseCase Layer  â”‚
â”‚  âœ… è·å–provider â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ âŒ æœªä¼ é€’provider
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Repository Layerâ”‚
â”‚ âŒ æŸ¥è¯¢æ—§é…ç½®    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚SettingsRepositoryâ”‚
â”‚ âŒ æ‰¾ä¸åˆ°Key     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¿®å¤åçš„æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UseCase Layer  â”‚
â”‚  âœ… è·å–provider â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ âœ… ä¼ é€’provider
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Repository Layerâ”‚
â”‚ âœ… ä½¿ç”¨provider  â”‚
â”‚    é…ç½®         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ âœ… ç›´æ¥ä½¿ç”¨
         â”‚    provider.apiKey
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AI API Call   â”‚
â”‚ âœ… æˆåŠŸè°ƒç”¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æ”¹è¿›

1. **å®Œæ•´çš„æ•°æ®æµ**ï¼šproviderä»UseCaseä¼ é€’åˆ°Repositoryï¼Œå†åˆ°APIè°ƒç”¨
2. **æ¶ˆé™¤æ—§ä¾èµ–**ï¼šRepositoryä¸å†ä¾èµ–SettingsRepositoryçš„æ—§æ–¹æ³•
3. **é…ç½®ä¸€è‡´æ€§**ï¼šæ•´ä¸ªè°ƒç”¨é“¾ä½¿ç”¨åŒä¸€ä¸ªprovideré…ç½®
4. **ç±»å‹å®‰å…¨**ï¼šé€šè¿‡AiProviderå¯¹è±¡ä¼ é€’ï¼Œè€Œä¸æ˜¯åˆ†æ•£çš„å­—ç¬¦ä¸²

---

## âœ… éªŒè¯æ¸…å•

### ç¼–è¯‘éªŒè¯
- [x] AiRepository.kt æ¥å£ä¿®æ”¹å®Œæˆ
- [x] AiRepositoryImpl.kt å®ç°ä¿®æ”¹å®Œæˆ
- [x] AnalyzeChatUseCase.kt è°ƒç”¨æ›´æ–°å®Œæˆ
- [x] CheckDraftUseCase.kt è°ƒç”¨æ›´æ–°å®Œæˆ
- [x] FeedTextUseCase.kt è°ƒç”¨æ›´æ–°å®Œæˆ
- [x] AnalyzeChatUseCaseTest.kt æµ‹è¯•æ›´æ–°å®Œæˆ
- [ ] ç¼–è¯‘é€šè¿‡ï¼ˆå¾…éªŒè¯ï¼‰

### åŠŸèƒ½éªŒè¯
- [ ] é…ç½®é»˜è®¤æœåŠ¡å•†åï¼Œæ‚¬æµ®çª—åˆ†æåŠŸèƒ½æ­£å¸¸
- [ ] è‰ç¨¿æ£€æŸ¥åŠŸèƒ½æ­£å¸¸
- [ ] æ–‡æœ¬æå–åŠŸèƒ½æ­£å¸¸
- [ ] åˆ‡æ¢æœåŠ¡å•†åï¼ŒåŠŸèƒ½ä½¿ç”¨æ–°é…ç½®

### å›å½’æµ‹è¯•
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] è®¾ç½®ç•Œé¢åŠŸèƒ½æ­£å¸¸

---

## ğŸ“ æ¶æ„ä¼˜åŠ¿

### 1. å•ä¸€çœŸç›¸æºï¼ˆSingle Source of Truthï¼‰

**ä¿®å¤å‰ï¼š**
- UseCaseä»AiProviderRepositoryè·å–é…ç½®
- Repositoryä»SettingsRepositoryè·å–é…ç½®
- ä¸¤ä¸ªé…ç½®æºå¯èƒ½ä¸ä¸€è‡´

**ä¿®å¤åï¼š**
- æ‰€æœ‰å±‚çº§ä½¿ç”¨åŒä¸€ä¸ªproviderå¯¹è±¡
- é…ç½®æ¥æºå”¯ä¸€ï¼Œä¸ä¼šå‡ºç°ä¸ä¸€è‡´

### 2. ä¾èµ–å€’ç½®ï¼ˆDependency Inversionï¼‰

**ä¿®å¤å‰ï¼š**
- Repositoryä¾èµ–å…·ä½“çš„SettingsRepositoryå®ç°
- è€¦åˆåº¦é«˜ï¼Œéš¾ä»¥æµ‹è¯•

**ä¿®å¤åï¼š**
- Repositoryåªä¾èµ–ä¼ å…¥çš„providerå‚æ•°
- è§£è€¦ï¼Œæ˜“äºæµ‹è¯•å’Œæ‰©å±•

### 3. æ˜¾å¼ä¾èµ–ï¼ˆExplicit Dependenciesï¼‰

**ä¿®å¤å‰ï¼š**
- Repositoryéšå¼ä¾èµ–SettingsRepository
- è°ƒç”¨è€…ä¸çŸ¥é“Repositoryéœ€è¦ä»€ä¹ˆé…ç½®

**ä¿®å¤åï¼š**
- providerä½œä¸ºæ–¹æ³•å‚æ•°æ˜¾å¼ä¼ é€’
- è°ƒç”¨è€…æ˜ç¡®çŸ¥é“éœ€è¦æä¾›ä»€ä¹ˆ

### 4. å¯æµ‹è¯•æ€§ï¼ˆTestabilityï¼‰

**ä¿®å¤å‰ï¼š**
- æµ‹è¯•æ—¶éœ€è¦Mock SettingsRepository
- éœ€è¦Mockå¤šä¸ªæ–¹æ³•ï¼ˆgetBaseUrl, getProviderHeadersç­‰ï¼‰

**ä¿®å¤åï¼š**
- æµ‹è¯•æ—¶åªéœ€ä¼ å…¥æµ‹è¯•ç”¨çš„providerå¯¹è±¡
- Mockæ›´ç®€å•ï¼Œæµ‹è¯•æ›´æ¸…æ™°

---

## ğŸ¯ åç»­å»ºè®®

### 1. åºŸå¼ƒæ—§çš„é…ç½®æ–¹æ³•

**å½“å‰çŠ¶æ€ï¼š** SettingsRepositoryä¸­çš„æ—§æ–¹æ³•ä»ç„¶å­˜åœ¨

**å»ºè®®ï¼š** æ ‡è®°ä¸º@Deprecatedï¼Œé€æ­¥è¿ç§»
```kotlin
@Deprecated("Use AiProviderRepository.getDefaultProvider() instead")
suspend fun getApiKey(): Result<String?>

@Deprecated("Use AiProviderRepository.getDefaultProvider() instead")
suspend fun getProviderHeaders(): Result<Map<String, String>>
```

### 2. æ·»åŠ ProvideréªŒè¯å·¥å…·

**å»ºè®®åˆ›å»ºï¼š** `ProviderValidator.kt`
```kotlin
object ProviderValidator {
    fun validate(provider: AiProvider): Result<Unit> {
        if (provider.apiKey.isBlank()) {
            return Result.failure(IllegalStateException("API Keyä¸ºç©º"))
        }
        if (provider.baseUrl.isBlank()) {
            return Result.failure(IllegalStateException("Base URLä¸ºç©º"))
        }
        return Result.success(Unit)
    }
}
```

### 3. ç»Ÿä¸€é”™è¯¯å¤„ç†

**å»ºè®®åˆ›å»ºï¼š** `ProviderErrors.kt`
```kotlin
sealed class ProviderError : Exception() {
    object NoDefaultProvider : ProviderError() {
        override val message = "æœªé…ç½®é»˜è®¤ AI æœåŠ¡å•†ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®"
    }
    
    object EmptyApiKey : ProviderError() {
        override val message = "é»˜è®¤æœåŠ¡å•†çš„ API Key ä¸ºç©ºï¼Œè¯·æ£€æŸ¥é…ç½®"
    }
    
    data class InvalidConfiguration(val reason: String) : ProviderError() {
        override val message = "æœåŠ¡å•†é…ç½®æ— æ•ˆï¼š$reason"
    }
}
```

### 4. æ·»åŠ Providerç¼“å­˜

**é—®é¢˜ï¼š** æ¯æ¬¡è°ƒç”¨éƒ½è¦æŸ¥è¯¢æ•°æ®åº“è·å–defaultProvider

**å»ºè®®ï¼š** åœ¨AiProviderRepositoryä¸­æ·»åŠ å†…å­˜ç¼“å­˜
```kotlin
class AiProviderRepositoryImpl @Inject constructor(
    private val dao: AiProviderDao,
    private val apiKeyStorage: ApiKeyStorage
) : AiProviderRepository {
    
    private var cachedDefaultProvider: AiProvider? = null
    private var cacheTimestamp: Long = 0
    private val CACHE_DURATION = 5000L // 5ç§’ç¼“å­˜
    
    override suspend fun getDefaultProvider(): Result<AiProvider?> {
        val now = System.currentTimeMillis()
        if (cachedDefaultProvider != null && now - cacheTimestamp < CACHE_DURATION) {
            return Result.success(cachedDefaultProvider)
        }
        
        return try {
            val entity = dao.getDefaultProvider().first()
            val provider = entity?.let { entityToDomain(it) }
            cachedDefaultProvider = provider
            cacheTimestamp = now
            Result.success(provider)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [IMPL-00003-API-Keyæ£€æŸ¥ä¿®å¤](./IMPL-00003-API-Keyæ£€æŸ¥ä¿®å¤.md) - ç¬¬ä¸€å±‚ä¿®å¤
- [PRD-00002-è®¾ç½®åŠŸèƒ½éœ€æ±‚](../PRD/PRD-00002-è®¾ç½®åŠŸèƒ½éœ€æ±‚.md)
- [product.md](../../../.kiro/steering/product.md) - äº§å“æ¦‚è§ˆ
- [structure.md](../../../.kiro/steering/structure.md) - é¡¹ç›®ç»“æ„

---

## ğŸ¯ æ€»ç»“

### é—®é¢˜æœ¬è´¨
è¿™æ˜¯ä¸€ä¸ª**åˆ†å±‚æ¶æ„ä¸ä¸€è‡´é—®é¢˜**ã€‚UseCaseå±‚å·²ç»å‡çº§åˆ°å¤šæœåŠ¡å•†æ¶æ„ï¼Œä½†Repositoryå±‚ä»åœ¨ä½¿ç”¨æ—§çš„å•æœåŠ¡å•†é…ç½®ç³»ç»Ÿï¼Œå¯¼è‡´é…ç½®æ— æ³•ä¼ é€’ã€‚

### ä¿®å¤ç­–ç•¥
é‡‡ç”¨**å®Œæ•´çš„æ¶æ„å‡çº§**æ–¹æ¡ˆï¼š
1. ä¿®æ”¹Repositoryæ¥å£ï¼Œæ·»åŠ providerå‚æ•°
2. ä¿®æ”¹Repositoryå®ç°ï¼Œä½¿ç”¨provideré…ç½®
3. ä¿®æ”¹æ‰€æœ‰UseCaseï¼Œä¼ é€’providerç»™Repository
4. åŒæ­¥æ›´æ–°æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹

### æœºåˆ¶ä¿éšœ
é€šè¿‡ä»¥ä¸‹æœºåˆ¶ä»æ ¹æœ¬ä¸Šé¿å…é—®é¢˜ï¼š
1. **å•ä¸€çœŸç›¸æº**ï¼šæ•´ä¸ªè°ƒç”¨é“¾ä½¿ç”¨åŒä¸€ä¸ªprovider
2. **æ˜¾å¼ä¾èµ–**ï¼šproviderä½œä¸ºå‚æ•°æ˜¾å¼ä¼ é€’
3. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨AiProviderå¯¹è±¡è€Œä¸æ˜¯åˆ†æ•£çš„å­—ç¬¦ä¸²
4. **å¯æµ‹è¯•æ€§**ï¼šç®€åŒ–Mockï¼Œæé«˜æµ‹è¯•è´¨é‡

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** 2025-12-13  
**ä¿®å¤äººå‘˜ï¼š** Kiro AI Assistant  
**å½±å“èŒƒå›´ï¼š** AiRepository + 3ä¸ªUseCase + æµ‹è¯•æ–‡ä»¶  
**é£é™©ç­‰çº§ï¼š** ä¸­ï¼ˆæ¥å£ç­¾åå˜æ›´ï¼Œéœ€è¦å…¨é¢æµ‹è¯•ï¼‰
