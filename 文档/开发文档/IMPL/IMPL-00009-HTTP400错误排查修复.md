# IMPL-00009: HTTP 400 é”™è¯¯æ’æŸ¥ä¿®å¤

## ğŸ“‹ é—®é¢˜æè¿°

### é”™è¯¯ç°è±¡
```
retrofit2.HttpException: HTTP 400 Bad Request
<-- END HTTP (307-byte body)
```

### é—®é¢˜åˆ†æ
- âœ… API è°ƒç”¨æˆåŠŸåˆ°è¾¾æœåŠ¡å™¨ï¼ˆä¸æ˜¯ç½‘ç»œé—®é¢˜ï¼‰
- âŒ æœåŠ¡å™¨è¿”å› HTTP 400 Bad Requestï¼ˆè¯·æ±‚æ ¼å¼é—®é¢˜ï¼‰
- ğŸ“Š é”™è¯¯ä½“å¤§å°ï¼š307å­—èŠ‚ï¼ˆåŒ…å«è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼‰

### å¯èƒ½çš„æ ¹å› 

1. **response_format å‚æ•°ä¸å…¼å®¹**
   - æŸäº› AI æœåŠ¡å•†å¯èƒ½ä¸æ”¯æŒ `response_format` å‚æ•°
   - æ—§ç‰ˆæœ¬æ¨¡å‹å¯èƒ½ä¸æ”¯æŒ JSON mode
   - å‚æ•°æ ¼å¼å¯èƒ½ä¸æœåŠ¡å•†è¦æ±‚ä¸ä¸€è‡´

2. **ç³»ç»ŸæŒ‡ä»¤ä¸ response_format å†²çª**
   - ç³»ç»ŸæŒ‡ä»¤å·²ç»è¦æ±‚è¿”å› JSON
   - åŒæ—¶è®¾ç½® `response_format` å¯èƒ½å¯¼è‡´å†²çª

3. **æ¨¡å‹åç§°ä¸æ­£ç¡®**
   - æœåŠ¡å•†ä¸æ”¯æŒæŒ‡å®šçš„æ¨¡å‹åç§°
   - æ¨¡å‹åç§°æ‹¼å†™é”™è¯¯

4. **è¯·æ±‚ä½“æ ¼å¼é—®é¢˜**
   - JSON åºåˆ—åŒ–é—®é¢˜
   - å¿…éœ€å­—æ®µç¼ºå¤±

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### é˜¶æ®µ1ï¼šä¸´æ—¶ç¦ç”¨ response_formatï¼ˆæ’æŸ¥æµ‹è¯•ï¼‰

**ç›®çš„ï¼š** ç¡®å®šæ˜¯å¦æ˜¯ `response_format` å‚æ•°å¯¼è‡´çš„ 400 é”™è¯¯

**ä¿®æ”¹å†…å®¹ï¼š**

#### 1. analyzeChat æ–¹æ³• âœ…

```kotlin
val request = ChatRequestDto(
    model = model,
    messages = messages,
    temperature = 0.7,
    stream = false,
    responseFormat = null  // ğŸ”§ ä¸´æ—¶ç¦ç”¨ï¼Œæµ‹è¯•æ˜¯å¦æ˜¯response_formatå¯¼è‡´çš„400é”™è¯¯
    // responseFormat = com.empathy.ai.data.remote.model.ResponseFormat(type = "json_object")
)
```

#### 2. checkDraftSafety æ–¹æ³• âœ…

```kotlin
val request = ChatRequestDto(
    model = model,
    messages = messages,
    temperature = 0.3,
    stream = false,
    responseFormat = null  // ğŸ”§ ä¸´æ—¶ç¦ç”¨
)
```

#### 3. extractTextInfo æ–¹æ³• âœ…

```kotlin
val request = ChatRequestDto(
    model = model,
    messages = messages,
    temperature = 0.5,
    stream = false,
    responseFormat = null  // ğŸ”§ ä¸´æ—¶ç¦ç”¨
)
```

### é˜¶æ®µ2ï¼šæ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿— âœ…

**ç›®çš„ï¼š** æ•è·æœåŠ¡å™¨è¿”å›çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

#### 1. æ·»åŠ è¯·æ±‚æ—¥å¿—

```kotlin
android.util.Log.d("AiRepositoryImpl", "=== APIè¯·æ±‚è¯¦æƒ… ===")
android.util.Log.d("AiRepositoryImpl", "URL: $url")
android.util.Log.d("AiRepositoryImpl", "Model: $model")
android.util.Log.d("AiRepositoryImpl", "Provider: ${provider.name}")
android.util.Log.d("AiRepositoryImpl", "ResponseFormat: ${request.responseFormat}")
```

#### 2. æ·»åŠ  HTTP é”™è¯¯å¤„ç†

```kotlin
} catch (e: retrofit2.HttpException) {
    // HTTPé”™è¯¯ï¼Œå°è¯•è¯»å–é”™è¯¯è¯¦æƒ…
    val errorBody = try {
        e.response()?.errorBody()?.string() ?: "No error body"
    } catch (ex: Exception) {
        "Failed to read error body: ${ex.message}"
    }
    
    android.util.Log.e("AiRepositoryImpl", "=== HTTPé”™è¯¯è¯¦æƒ… ===")
    android.util.Log.e("AiRepositoryImpl", "çŠ¶æ€ç : ${e.code()}")
    android.util.Log.e("AiRepositoryImpl", "é”™è¯¯ä¿¡æ¯: ${e.message()}")
    android.util.Log.e("AiRepositoryImpl", "é”™è¯¯ä½“: $errorBody")
    android.util.Log.e("AiRepositoryImpl", "Provider: ${provider.name}")
    
    Result.failure(Exception("HTTP ${e.code()}: $errorBody"))
} catch (e: Exception) {
    android.util.Log.e("AiRepositoryImpl", "åˆ†æå¤±è´¥", e)
    Result.failure(e)
}
```

---

## ğŸ“Š æ’æŸ¥æµç¨‹

### æ­¥éª¤1ï¼šæµ‹è¯•ç¦ç”¨ response_format åçš„æ•ˆæœ

**æ“ä½œï¼š**
1. é‡æ–°ç¼–è¯‘åº”ç”¨
2. åœ¨çœŸæœºä¸Šæµ‹è¯• AI åˆ†æåŠŸèƒ½
3. è§‚å¯Ÿæ—¥å¿—è¾“å‡º

**é¢„æœŸç»“æœï¼š**

**æƒ…å†µAï¼šå¦‚æœä»ç„¶ 400 é”™è¯¯**
- è¯´æ˜ä¸æ˜¯ `response_format` çš„é—®é¢˜
- éœ€è¦æŸ¥çœ‹é”™è¯¯ä½“ä¸­çš„è¯¦ç»†ä¿¡æ¯
- å¯èƒ½æ˜¯æ¨¡å‹åç§°ã€URL æˆ–å…¶ä»–å‚æ•°é—®é¢˜

**æƒ…å†µBï¼šå¦‚æœæˆåŠŸè¿”å›**
- è¯´æ˜æ˜¯ `response_format` å¯¼è‡´çš„é—®é¢˜
- è¯¥æœåŠ¡å•†ä¸æ”¯æŒ JSON mode
- éœ€è¦ä¾èµ–ç³»ç»ŸæŒ‡ä»¤å’Œ JSON æ¸…æ´—æœºåˆ¶

### æ­¥éª¤2ï¼šåˆ†æé”™è¯¯ä½“å†…å®¹

æ ¹æ®æœåŠ¡å™¨è¿”å›çš„é”™è¯¯ä½“ï¼Œå¯èƒ½çš„é”™è¯¯ç±»å‹ï¼š

#### é”™è¯¯ç±»å‹1ï¼šä¸æ”¯æŒçš„å‚æ•°
```json
{
  "error": {
    "message": "Invalid parameter: response_format",
    "type": "invalid_request_error"
  }
}
```
**è§£å†³æ–¹æ¡ˆï¼š** ç¦ç”¨ `response_format`ï¼Œä¾èµ–ç³»ç»ŸæŒ‡ä»¤

#### é”™è¯¯ç±»å‹2ï¼šæ¨¡å‹ä¸æ”¯æŒ
```json
{
  "error": {
    "message": "Model 'xxx' does not support response_format",
    "type": "invalid_request_error"
  }
}
```
**è§£å†³æ–¹æ¡ˆï¼š** æ·»åŠ æ¨¡å‹èƒ½åŠ›æ£€æµ‹ï¼ŒåŠ¨æ€å†³å®šæ˜¯å¦ä½¿ç”¨

#### é”™è¯¯ç±»å‹3ï¼šæ¨¡å‹åç§°é”™è¯¯
```json
{
  "error": {
    "message": "Model 'xxx' not found",
    "type": "invalid_request_error"
  }
}
```
**è§£å†³æ–¹æ¡ˆï¼š** æ£€æŸ¥æ¨¡å‹åç§°é…ç½®

#### é”™è¯¯ç±»å‹4ï¼šå…¶ä»–å‚æ•°é—®é¢˜
```json
{
  "error": {
    "message": "Missing required parameter: xxx",
    "type": "invalid_request_error"
  }
}
```
**è§£å†³æ–¹æ¡ˆï¼š** æ ¹æ®å…·ä½“é”™è¯¯è°ƒæ•´è¯·æ±‚å‚æ•°

---

## ğŸ¯ åç»­ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæœåŠ¡å•†èƒ½åŠ›æ£€æµ‹ï¼ˆæ¨èï¼‰

åˆ›å»ºæœåŠ¡å•†èƒ½åŠ›æ£€æµ‹æœºåˆ¶ï¼š

```kotlin
data class ProviderCapabilities(
    val supportsJsonMode: Boolean,
    val supportsStreaming: Boolean,
    val supportedModels: List<String>
)

object ProviderCapabilityDetector {
    fun detect(provider: AiProvider): ProviderCapabilities {
        return when {
            provider.name.contains("GPT-4", ignoreCase = true) -> 
                ProviderCapabilities(
                    supportsJsonMode = true,
                    supportsStreaming = true,
                    supportedModels = listOf("gpt-4", "gpt-4-turbo-preview")
                )
            provider.name.contains("GPT-3.5", ignoreCase = true) -> 
                ProviderCapabilities(
                    supportsJsonMode = true,
                    supportsStreaming = true,
                    supportedModels = listOf("gpt-3.5-turbo")
                )
            provider.name.contains("DeepSeek", ignoreCase = true) -> 
                ProviderCapabilities(
                    supportsJsonMode = false,  // ğŸ”§ æ ¹æ®æµ‹è¯•ç»“æœè°ƒæ•´
                    supportsStreaming = true,
                    supportedModels = listOf("deepseek-chat")
                )
            else -> 
                ProviderCapabilities(
                    supportsJsonMode = false,  // é»˜è®¤ä¸æ”¯æŒ
                    supportsStreaming = false,
                    supportedModels = emptyList()
                )
        }
    }
}
```

**ä½¿ç”¨æ–¹å¼ï¼š**

```kotlin
val capabilities = ProviderCapabilityDetector.detect(provider)

val request = ChatRequestDto(
    model = model,
    messages = messages,
    temperature = 0.7,
    stream = false,
    responseFormat = if (capabilities.supportsJsonMode) {
        ResponseFormat(type = "json_object")
    } else {
        null
    }
)
```

### æ–¹æ¡ˆBï¼šè‡ªåŠ¨é™çº§æœºåˆ¶

å¦‚æœé‡åˆ° 400 é”™è¯¯ï¼Œè‡ªåŠ¨é‡è¯•ä¸å¸¦ `response_format` çš„è¯·æ±‚ï¼š

```kotlin
override suspend fun analyzeChat(
    provider: AiProvider,
    promptContext: String,
    systemInstruction: String
): Result<AnalysisResult> {
    return try {
        // ç¬¬ä¸€æ¬¡å°è¯•ï¼šä½¿ç”¨ response_format
        val result = callApiWithJsonMode(provider, promptContext, systemInstruction)
        result
    } catch (e: retrofit2.HttpException) {
        if (e.code() == 400) {
            android.util.Log.w("AiRepositoryImpl", "JSON mode å¤±è´¥ï¼Œå°è¯•ä¸ä½¿ç”¨ response_format")
            // ç¬¬äºŒæ¬¡å°è¯•ï¼šä¸ä½¿ç”¨ response_format
            callApiWithoutJsonMode(provider, promptContext, systemInstruction)
        } else {
            Result.failure(e)
        }
    }
}
```

### æ–¹æ¡ˆCï¼šé…ç½®åŒ–æ”¯æŒ

åœ¨ `AiProvider` æ¨¡å‹ä¸­æ·»åŠ èƒ½åŠ›å­—æ®µï¼š

```kotlin
data class AiProvider(
    val id: String,
    val name: String,
    val baseUrl: String,
    val apiKey: String,
    val defaultModelId: String,
    val isDefault: Boolean,
    val supportsJsonMode: Boolean = false,  // ğŸ†• æ–°å¢
    val supportsStreaming: Boolean = false  // ğŸ†• æ–°å¢
)
```

ç”¨æˆ·åœ¨é…ç½®æœåŠ¡å•†æ—¶å¯ä»¥æ‰‹åŠ¨æŒ‡å®šæ˜¯å¦æ”¯æŒ JSON modeã€‚

---

## âœ… éªŒè¯æ¸…å•

### ç¼–è¯‘éªŒè¯
- [x] ä¸´æ—¶ç¦ç”¨ response_format
- [x] æ·»åŠ è¯¦ç»†çš„è¯·æ±‚æ—¥å¿—
- [x] æ·»åŠ  HTTP é”™è¯¯å¤„ç†
- [x] ä¸‰ä¸ªæ–¹æ³•éƒ½å·²ä¿®æ”¹
- [ ] ç¼–è¯‘é€šè¿‡ï¼ˆå¾…éªŒè¯ï¼‰

### åŠŸèƒ½éªŒè¯ï¼ˆå¾…çœŸæœºæµ‹è¯•ï¼‰
- [ ] ç¦ç”¨ response_format åæ˜¯å¦ä»ç„¶ 400 é”™è¯¯
- [ ] é”™è¯¯ä½“ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
- [ ] ç¡®å®šå…·ä½“çš„é”™è¯¯åŸå› 
- [ ] AI æ˜¯å¦èƒ½æ­£å¸¸è¿”å›ç»“æœ
- [ ] JSON æ¸…æ´—æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

## ğŸ“ æµ‹è¯•æ­¥éª¤

### 1. é‡æ–°ç¼–è¯‘
```bash
./gradlew assembleDebug
```

### 2. å®‰è£…åˆ°è®¾å¤‡
```bash
./gradlew installDebug
```

### 3. è§¦å‘ AI åˆ†æ

åœ¨æ‚¬æµ®çª—ä¸­è¾“å…¥æµ‹è¯•æ–‡æœ¬å¹¶ç‚¹å‡»åˆ†æã€‚

### 4. æŸ¥çœ‹æ—¥å¿—

ä½¿ç”¨ `adb logcat` æˆ– Android Studio çš„ Logcat æŸ¥çœ‹ï¼š

```bash
adb logcat | grep -E "AiRepositoryImpl|FloatingWindowService"
```

**å…³é”®æ—¥å¿—ï¼š**
- `=== APIè¯·æ±‚è¯¦æƒ… ===` - æŸ¥çœ‹è¯·æ±‚å‚æ•°
- `=== HTTPé”™è¯¯è¯¦æƒ… ===` - æŸ¥çœ‹é”™è¯¯è¯¦æƒ…
- `é”™è¯¯ä½“:` - æŸ¥çœ‹æœåŠ¡å™¨è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯

### 5. è®°å½•ç»“æœ

æ ¹æ®æ—¥å¿—è¾“å‡ºï¼Œè®°å½•ï¼š
- æ˜¯å¦ä»ç„¶ 400 é”™è¯¯
- é”™è¯¯ä½“çš„å…·ä½“å†…å®¹
- ä½¿ç”¨çš„æœåŠ¡å•†åç§°
- ä½¿ç”¨çš„æ¨¡å‹åç§°

---

## ğŸ¯ é¢„æœŸç»“æœ

### æœ€ä½³æƒ…å†µ
- ç¦ç”¨ `response_format` åè¯·æ±‚æˆåŠŸ
- AI è¿”å› JSON æ ¼å¼ï¼ˆå› ä¸ºç³»ç»ŸæŒ‡ä»¤è¦æ±‚ï¼‰
- JSON æ¸…æ´—æœºåˆ¶æ­£å¸¸å·¥ä½œ
- åŠŸèƒ½æ­£å¸¸

### æ¬¡ä¼˜æƒ…å†µ
- ç¦ç”¨ `response_format` åè¯·æ±‚æˆåŠŸ
- AI è¿”å› Markdown æ ¼å¼
- JSON æ¸…æ´—æœºåˆ¶æå–ä¿¡æ¯
- Fallback æœºåˆ¶ç”Ÿæ•ˆ
- åŠŸèƒ½åŸºæœ¬æ­£å¸¸

### æœ€åæƒ…å†µ
- ä»ç„¶ 400 é”™è¯¯
- éœ€è¦æ ¹æ®é”™è¯¯ä½“è°ƒæ•´å…¶ä»–å‚æ•°
- å¯èƒ½æ˜¯æ¨¡å‹åç§°ã€URL æˆ–å…¶ä»–é—®é¢˜

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [IMPL-00008-å¼ºåˆ¶JSONæ ¼å¼å“åº”](./IMPL-00008-å¼ºåˆ¶JSONæ ¼å¼å“åº”.md)
- [IMPL-00007-JSONæ¸…æ´—å’Œå®½æ¾æ¨¡å¼ä¿®å¤](./IMPL-00007-JSONæ¸…æ´—å’Œå®½æ¾æ¨¡å¼ä¿®å¤.md)
- [IMPL-00004-å¤šæœåŠ¡å•†æ¶æ„å®Œæ•´é€‚é…](./IMPL-00004-å¤šæœåŠ¡å•†æ¶æ„å®Œæ•´é€‚é….md)

---

## ğŸ‰ æ€»ç»“

### å½“å‰çŠ¶æ€
- âœ… ä¸´æ—¶ç¦ç”¨ `response_format` å‚æ•°
- âœ… æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… æ·»åŠ  HTTP é”™è¯¯å¤„ç†
- â³ å¾…çœŸæœºæµ‹è¯•éªŒè¯

### ä¸‹ä¸€æ­¥
1. é‡æ–°ç¼–è¯‘å¹¶å®‰è£…åˆ°è®¾å¤‡
2. è§¦å‘ AI åˆ†æåŠŸèƒ½
3. æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
4. æ ¹æ®é”™è¯¯ä¿¡æ¯ç¡®å®šå…·ä½“åŸå› 
5. å®æ–½å¯¹åº”çš„ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ç­–ç•¥
é‡‡ç”¨ **æ’æŸ¥æµ‹è¯• + è¯¦ç»†æ—¥å¿— + çµæ´»é™çº§** çš„ç­–ç•¥ï¼š
1. ä¸´æ—¶ç¦ç”¨å¯ç–‘å‚æ•°ï¼ˆæ’æŸ¥ï¼‰
2. æ•è·è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆè¯Šæ–­ï¼‰
3. æ ¹æ®é”™è¯¯ç±»å‹é€‰æ‹©æ–¹æ¡ˆï¼ˆä¿®å¤ï¼‰
4. æ·»åŠ æœåŠ¡å•†èƒ½åŠ›æ£€æµ‹ï¼ˆé•¿æœŸï¼‰

---

**ä¿®å¤æ—¶é—´ï¼š** 2025-12-13  
**ä¿®å¤äººå‘˜ï¼š** Kiro AI Assistant  
**å½±å“èŒƒå›´ï¼š** AiRepositoryImplï¼ˆ3ä¸ªæ–¹æ³•ï¼‰  
**é£é™©ç­‰çº§ï¼š** ä½ï¼ˆä¸´æ—¶ç¦ç”¨ï¼Œå¯å›æ»šï¼‰
