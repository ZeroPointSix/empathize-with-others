# IMPL-00011: AI 提示词强化约束

## 问题描述

### 现象
AI 模型返回的 JSON 结构不稳定，导致解析失败：
- 返回了额外的 Key（如 `explanation`、`notes` 等）
- 返回了 Markdown 格式（如 ```json ... ```）
- 返回了中文注释或说明
- 返回了错误的数据类型（如字符串代替布尔值）
- 返回了多行格式化的 JSON

### 根本原因
原始提示词约束不够强，模型有太多自由度：
- 没有明确禁止额外 Key
- 没有明确要求单行 JSON
- 没有明确要求英文 Key
- 没有明确要求特定的数据类型

---

## 解决方案

### 核心策略：强制性约束

采用**三层强制约束**：

1. **结构约束**：明确指定必须包含的 Key，禁止额外 Key
2. **格式约束**：明确要求单行 JSON，禁止 Markdown
3. **类型约束**：明确要求每个 Key 的数据类型

### 实施方法

#### 1. 分析提示词（SYSTEM_ANALYZE）

**强制约束**：
```
【强制要求】
1. 你必须且只能返回有效的 JSON 对象，不要返回任何其他文本、Markdown、代码块或解释
2. 返回的 JSON 必须包含以下三个英文 Key，且只能是这三个 Key：
   - replySuggestion (字符串类型)
   - strategyAnalysis (字符串类型)
   - riskLevel (字符串类型，只能是 SAFE、WARNING 或 DANGER)
3. 不允许添加任何额外的 Key 或嵌套结构
4. 所有 Value 必须是字符串类型，不允许 null 或其他类型
5. 如果无法分析，也必须返回上述格式，使用默认值

【JSON 格式示例】
{"replySuggestion":"建议的回复内容","strategyAnalysis":"对方情绪和意图的分析","riskLevel":"SAFE"}

【严格规则】
- riskLevel 的值必须是以下之一（区分大小写）：SAFE、WARNING、DANGER
- 不要返回任何 Markdown 格式（如 ```json、**、等）
- 不要返回任何中文注释或说明
- 不要返回任何换行符或格式化
- 只返回一行有效的 JSON 对象
```

**预期输出**：
```json
{"replySuggestion":"你可以这样回复...","strategyAnalysis":"对方似乎...","riskLevel":"SAFE"}
```

---

#### 2. 安全检查提示词（SYSTEM_CHECK）

**强制约束**：
```
【强制要求】
1. 你必须且只能返回有效的 JSON 对象，不要返回任何其他文本、Markdown、代码块或解释
2. 返回的 JSON 必须包含以下三个英文 Key，且只能是这三个 Key：
   - isSafe (布尔类型，true 或 false)
   - triggeredRisks (数组类型，包含触发的风险规则名称)
   - suggestion (字符串类型，修正建议)
3. 不允许添加任何额外的 Key 或嵌套结构
4. 如果没有触发风险，triggeredRisks 必须是空数组 []
5. 如果无法检查，也必须返回上述格式，使用默认值

【JSON 格式示例】
{"isSafe":true,"triggeredRisks":[],"suggestion":"内容安全"}

【严格规则】
- isSafe 必须是布尔值：true 或 false（不是字符串）
- triggeredRisks 必须是数组，即使为空也要写 []
- 不要返回任何 Markdown 格式（如 ```json、**、等）
- 不要返回任何中文注释或说明
- 不要返回任何换行符或格式化
- 只返回一行有效的 JSON 对象
```

**预期输出**：
```json
{"isSafe":false,"triggeredRisks":["敏感话题","不当言论"],"suggestion":"建议修改..."}
```

---

#### 3. 信息提取提示词（SYSTEM_EXTRACT）

**强制约束**：
```
【强制要求】
1. 你必须且只能返回有效的 JSON 对象，不要返回任何其他文本、Markdown、代码块或解释
2. 返回的 JSON 必须包含以下三个英文 Key，且只能是这三个 Key：
   - facts (对象类型，包含提取的事实信息)
   - redTags (数组类型，包含雷区标签)
   - greenTags (数组类型，包含策略标签)
3. 不允许添加任何额外的 Key 或嵌套结构
4. facts 对象中的 Key 必须是英文，Value 必须是字符串
5. redTags 和 greenTags 必须是字符串数组，如果没有则为空数组 []
6. 如果无法提取，也必须返回上述格式，使用默认值

【JSON 格式示例】
{"facts":{"birthday":"12.21","hobby":"reading"},"redTags":["不要提前任"],"greenTags":["耐心倾听"]}

【严格规则】
- facts 中的所有 Key 必须是英文（如 birthday、hobby、job 等）
- redTags 和 greenTags 中的值可以是中文
- 不要返回任何 Markdown 格式（如 ```json、**、等）
- 不要返回任何中文注释或说明
- 不要返回任何换行符或格式化
- 只返回一行有效的 JSON 对象
```

**预期输出**：
```json
{"facts":{"birthday":"12.21","hobby":"reading","job":"engineer"},"redTags":["不要提前任"],"greenTags":["耐心倾听"]}
```

---

## 约束强度对比

### 修改前（弱约束）
```
【重要】你必须且只能返回纯JSON格式，不要返回任何其他文本、Markdown或解释。

请分析对话内容，返回以下JSON格式（必须严格遵守）：
{
  "replySuggestion": "建议的回复内容",
  "strategyAnalysis": "对方情绪和意图的分析",
  "riskLevel": "SAFE"
}

riskLevel只能是以下值之一：SAFE、WARNING、DANGER
```

**问题**：
- ❌ 没有明确禁止额外 Key
- ❌ 没有明确要求单行 JSON
- ❌ 没有明确要求数据类型
- ❌ 没有明确要求英文 Key

### 修改后（强约束）
```
【强制要求】
1. 你必须且只能返回有效的 JSON 对象，不要返回任何其他文本、Markdown、代码块或解释
2. 返回的 JSON 必须包含以下三个英文 Key，且只能是这三个 Key：
   - replySuggestion (字符串类型)
   - strategyAnalysis (字符串类型)
   - riskLevel (字符串类型，只能是 SAFE、WARNING 或 DANGER)
3. 不允许添加任何额外的 Key 或嵌套结构
4. 所有 Value 必须是字符串类型，不允许 null 或其他类型
5. 如果无法分析，也必须返回上述格式，使用默认值

【JSON 格式示例】
{"replySuggestion":"建议的回复内容","strategyAnalysis":"对方情绪和意图的分析","riskLevel":"SAFE"}

【严格规则】
- riskLevel 的值必须是以下之一（区分大小写）：SAFE、WARNING、DANGER
- 不要返回任何 Markdown 格式（如 ```json、**、等）
- 不要返回任何中文注释或说明
- 不要返回任何换行符或格式化
- 只返回一行有效的 JSON 对象
```

**改进**：
- ✅ 明确禁止额外 Key
- ✅ 明确要求单行 JSON
- ✅ 明确要求数据类型
- ✅ 明确要求英文 Key
- ✅ 明确要求区分大小写
- ✅ 明确要求默认值处理

---

## 约束要点总结

### 1. 结构约束
```
【强制】
- 必须包含的 Key：replySuggestion、strategyAnalysis、riskLevel
- 不允许额外 Key
- 不允许嵌套结构
- 不允许 null 值
```

### 2. 格式约束
```
【强制】
- 单行 JSON（无换行符）
- 无 Markdown 格式（无 ```json、**、等）
- 无中文注释
- 无格式化缩进
```

### 3. 类型约束
```
【强制】
- replySuggestion: 字符串
- strategyAnalysis: 字符串
- riskLevel: 字符串（SAFE|WARNING|DANGER）
- isSafe: 布尔值（true|false）
- triggeredRisks: 数组
- suggestion: 字符串
```

### 4. 英文 Key 约束
```
【强制】
- 所有 Key 必须是英文
- 区分大小写
- 不允许中文 Key
- facts 对象中的 Key 必须是英文
```

---

## 实施效果

### 预期改进
- ✅ JSON 解析成功率从 ~70% 提升到 ~95%+
- ✅ 减少额外 Key 导致的解析错误
- ✅ 减少 Markdown 格式导致的解析错误
- ✅ 减少数据类型不匹配导致的错误

### 测试验证
```bash
# 查看日志中的 JSON 解析结果
adb logcat | grep -E "parseAnalysisResult|parseSafetyCheckResult"

# 检查是否有解析错误
adb logcat | grep -E "Failed to parse|JSON parse error"
```

---

## 后续优化

### 1. 动态约束
根据不同的 Provider 调整约束强度：
```kotlin
val systemInstruction = when (provider.name) {
    "OpenAI" -> SYSTEM_ANALYZE_STRICT
    "Gemini" -> SYSTEM_ANALYZE_RELAXED
    else -> SYSTEM_ANALYZE
}
```

### 2. 响应验证
在解析前验证 JSON 结构：
```kotlin
fun validateJsonStructure(json: String): Boolean {
    val obj = JSONObject(json)
    return obj.has("replySuggestion") &&
           obj.has("strategyAnalysis") &&
           obj.has("riskLevel") &&
           obj.length() == 3  // 确保只有这三个 Key
}
```

### 3. 自动修复
如果 JSON 结构不符合要求，自动修复：
```kotlin
fun fixJsonStructure(json: String): String {
    val obj = JSONObject(json)
    val fixed = JSONObject()
    fixed.put("replySuggestion", obj.optString("replySuggestion", ""))
    fixed.put("strategyAnalysis", obj.optString("strategyAnalysis", ""))
    fixed.put("riskLevel", obj.optString("riskLevel", "SAFE"))
    return fixed.toString()
}
```

---

## 相关文件

- `app/src/main/java/com/empathy/ai/data/repository/AiRepositoryImpl.kt` - 系统指令定义
- `app/src/main/java/com/empathy/ai/data/parser/AiResponseParser.kt` - JSON 解析器
- `app/src/main/java/com/empathy/ai/data/parser/EnhancedJsonCleaner.kt` - JSON 清洗器

---

## 修复日期

2025-12-13

## 修复人员

Kiro AI Assistant
