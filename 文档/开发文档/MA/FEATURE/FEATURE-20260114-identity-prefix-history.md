# åŠŸèƒ½å¼€å‘æ¢ç´¢æŠ¥å‘Š

## åŸºæœ¬ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ—¥æœŸ | 2026-01-14 |
| åˆ†æ”¯ | freedom-feature |
| çŠ¶æ€ | ğŸ“–ä»…å‚è€ƒ |
| æ¢ç´¢è€… | feature-explorer |
| å…³è” PRD | PRD-00008 |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- PRDï¼š`æ–‡æ¡£/å¼€å‘æ–‡æ¡£/PRD/PRD-00008-è¾“å…¥å†…å®¹èº«ä»½è¯†åˆ«ä¸åŒå‘å¯¹è¯å†å²éœ€æ±‚.md`
- å†³ç­–æ—¥å¿—ï¼š`æ–‡æ¡£/å¼€å‘æ–‡æ¡£/MA/FEATURE/FEATURE-20260114-identity-prefix-history-JOURNAL.md`

---

## éœ€æ±‚æ¦‚è¿°

### åŠŸèƒ½æè¿°

PRD-00008 çš„ç›®æ ‡æ˜¯è®© AI èƒ½æ­£ç¡®åŒºåˆ†â€œå¯¹æ–¹è¯´çš„å†…å®¹â€å’Œâ€œæˆ‘æ­£åœ¨å›å¤çš„å†…å®¹â€ï¼Œé¿å…åˆ†æä¸æ£€æŸ¥åœºæ™¯è§’è‰²æ··æ·†ã€‚æœ¬æ¬¡æ¢ç´¢åœ¨æ—¢æœ‰å®ç°åŸºç¡€ä¸Šè¡¥é½äº‹å®æµ UI æ¸²æŸ“ç¼ºå£ï¼Œç¡®ä¿å†å²è®°å½•å±•ç¤ºç¬¦åˆâ€œå·¦å³æ°”æ³¡ + éšè—å‰ç¼€â€çš„äº§å“é¢„æœŸï¼Œå¹¶è¡¥å……èº«ä»½å‰ç¼€å·¥å…·çš„å•å…ƒæµ‹è¯•ï¼Œä»¥é™ä½å›å½’é£é™©ã€‚

### ç”¨æˆ·æ•…äº‹

ä½œä¸ºéœ€è¦åˆ†æèŠå¤©ä¸Šä¸‹æ–‡çš„ç”¨æˆ·ï¼Œæˆ‘å¸Œæœ›ç³»ç»Ÿèƒ½è‡ªåŠ¨è¯†åˆ«è¾“å…¥å†…å®¹çš„èº«ä»½ï¼Œå¹¶åœ¨å†å²è®°å½•ä¸­ä»¥è‡ªç„¶å¯¹è¯æµå±•ç¤ºï¼Œè®©æˆ‘æ— éœ€æ‰‹åŠ¨æ ‡è®°ä¹Ÿèƒ½è·å¾—æ­£ç¡®åˆ†æä¸æ¸…æ™°çš„å›çœ‹ä½“éªŒã€‚

### éªŒæ”¶æ ‡å‡†ï¼ˆä»£ç è¦†ç›–æƒ…å†µè¯´æ˜ï¼‰

- [x] ç‚¹å‡»ã€å¸®æˆ‘åˆ†æã€‘æ—¶ï¼Œå‘é€ç»™ AI çš„å†…å®¹è‡ªåŠ¨æ·»åŠ  `ã€å¯¹æ–¹è¯´ã€‘ï¼š` å‰ç¼€ï¼ˆå·²æœ‰ä»£ç è¦†ç›–ï¼Œæœªåšç«¯åˆ°ç«¯éªŒè¯ï¼‰
- [x] ç‚¹å‡»ã€å¸®æˆ‘æ£€æŸ¥ã€‘æ—¶ï¼Œå‘é€ç»™ AI çš„å†…å®¹è‡ªåŠ¨æ·»åŠ  `ã€æˆ‘æ­£åœ¨å›å¤ã€‘ï¼š` å‰ç¼€ï¼ˆå·²æœ‰ä»£ç è¦†ç›–ï¼Œæœªåšç«¯åˆ°ç«¯éªŒè¯ï¼‰
- [x] ã€å¸®æˆ‘åˆ†æã€‘çš„è¾“å…¥å†…å®¹æ­£ç¡®ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆå¸¦å‰ç¼€ï¼‰ï¼ˆå·²æœ‰ä»£ç è¦†ç›–ï¼‰
- [x] ã€å¸®æˆ‘æ£€æŸ¥ã€‘çš„è¾“å…¥å†…å®¹ä¸ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆå·²æœ‰ä»£ç è¦†ç›–ï¼‰
- [x] å†å²ä¸Šä¸‹æ–‡æ„å»ºæ—¶æ­£ç¡®ä¿ç•™èº«ä»½å‰ç¼€ï¼ˆConversationContextBuilder å·²å®ç°ï¼‰
- [x] AI èƒ½æ­£ç¡®ç†è§£èº«ä»½å‰ç¼€å«ä¹‰ï¼ˆSystemPrompts å·²åŠ å…¥è§„åˆ™ï¼Œæœªåšåœ¨çº¿éªŒè¯ï¼‰
- [x] æ—§æ•°æ®ï¼ˆæ— å‰ç¼€ï¼‰æ­£å¸¸æ˜¾ç¤ºå’Œå¤„ç†ï¼ˆIdentityPrefixHelper å…¼å®¹ + UI æ¸²æŸ“åˆ†æ”¯ï¼‰
- [x] äº‹å®æµç•Œé¢ä»¥è‡ªç„¶å¯¹è¯æµå½¢å¼å±•ç¤ºï¼ˆå·¦å³æ°”æ³¡ï¼‰ä¸” UI éšè—å‰ç¼€ï¼ˆæœ¬æ¬¡å®ç°ï¼Œå¾…æ‰‹åŠ¨éªŒæ”¶ï¼‰

---

## æŠ€æœ¯è®¾è®¡

### æ¶æ„è®¾è®¡

æœ¬æ¬¡ä¸æ”¹åŠ¨æ•°æ®å±‚ä¸é¢†åŸŸå±‚çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ²¿ç”¨å·²å­˜åœ¨çš„èº«ä»½å‰ç¼€ä½“ç³»ï¼ˆIdentityPrefixHelper + Analyze/Check UseCase + SystemPromptsï¼‰ã€‚å®ç°é‡ç‚¹æ”¾åœ¨è¡¨ç°å±‚ï¼šåœ¨äº‹å®æµçš„ ConversationCard ä¸­å¤ç”¨ ConversationBubbleï¼Œä½¿ UI å±‚æŒ‰èº«ä»½å·¦å³å¯¹é½ï¼ŒåŒæ—¶ä¿ç•™åŸæœ‰â€œæ—¶é—´ + æ€»ç»“çŠ¶æ€â€çš„ä¿¡æ¯ç»“æ„ã€‚

### æ•°æ®æ¨¡å‹

- æ— æ–°å¢æ•°æ®æ¨¡å‹ã€‚
- å†å²è®°å½•ä»æ²¿ç”¨ `ConversationLog.userInput` å­˜å‚¨å¸¦å‰ç¼€å†…å®¹ï¼Œå…¼å®¹æ—§æ•°æ®ï¼ˆæ— å‰ç¼€ï¼‰ã€‚

### æ¥å£è®¾è®¡

æ–°å¢å¯é€‰å‚æ•°ä»¥æ”¯æŒäº‹å®æµå¤ç”¨ï¼š

```kotlin
// file: presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/message/ConversationBubble.kt
fun ConversationBubble(
    log: ConversationLog,
    modifier: Modifier = Modifier,
    onClick: (() -> Unit)? = null,
    showHeader: Boolean = true,
    maxLines: Int = Int.MAX_VALUE,
    overflow: TextOverflow = TextOverflow.Clip
)
```

---

## å®ç°è¯¦æƒ…

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| domain/src/test/kotlin/com/empathy/ai/domain/util/IdentityPrefixHelperTest.kt | å•å…ƒæµ‹è¯• | èº«ä»½å‰ç¼€æ·»åŠ /è§£æ/æ¸…ç†æµ‹è¯• |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/message/ConversationBubble.kt | ä¿®æ”¹ | æ”¯æŒéšè—å¤´éƒ¨ã€é™åˆ¶è¡Œæ•°ï¼Œä¾¿äºäº‹å®æµå¤ç”¨ |
| presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/card/ConversationCard.kt | ä¿®æ”¹ | äº‹å®æµå¯¹è¯å¡ç‰‡æ”¹ç”¨èº«ä»½æ°”æ³¡æ¸²æŸ“ |

### ä»£ç ç»Ÿè®¡ï¼ˆä¼°ç®—ï¼‰

- æ–°å¢ä»£ç è¡Œæ•°ï¼šçº¦ 120 è¡Œï¼ˆå«æµ‹è¯•ï¼‰
- ä¿®æ”¹ä»£ç è¡Œæ•°ï¼šçº¦ 60 è¡Œ
- åˆ é™¤ä»£ç è¡Œæ•°ï¼šçº¦ 40 è¡Œ

---

## å…³é”®å˜æ›´ä¸ä»£ç è¯´æ˜

ä¸‹é¢æŒ‰â€œä¿®æ”¹å‰ / ä¿®æ”¹åâ€ç»™å‡ºå®Œæ•´ä»£ç ï¼Œå¹¶é€æ¡è§£é‡ŠåŸå› ã€å½±å“ä¸æ›¿ä»£æ–¹æ¡ˆã€‚

### å˜æ›´ 1ï¼šConversationBubble æ”¯æŒéšè—å¤´éƒ¨ä¸è¡Œæ•°é™åˆ¶

#### ä¿®æ”¹å‰ï¼ˆå®Œæ•´ä»£ç ï¼‰
```kotlin
// file: presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/message/ConversationBubble.kt
// ä¿®æ”¹å‰
package com.empathy.ai.presentation.ui.component.message

import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.widthIn
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import com.empathy.ai.domain.model.ConversationLog
import com.empathy.ai.domain.util.IdentityPrefixHelper
import com.empathy.ai.presentation.theme.EmpathyTheme
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

/**
 * å¯¹è¯æ°”æ³¡ç»„ä»¶
 *
 * æ ¹æ®èº«ä»½å‰ç¼€è‡ªåŠ¨æ¸²æŸ“å·¦å³å¸ƒå±€çš„å¯¹è¯æ°”æ³¡ã€‚
 *
 * å¸ƒå±€è§„åˆ™ï¼ˆPRD-00008ï¼‰ï¼š
 * - CONTACTï¼ˆå¯¹æ–¹è¯´ï¼‰ï¼šé å·¦å¯¹é½ï¼Œæµ…ç°èƒŒæ™¯
 * - USERï¼ˆæˆ‘æ­£åœ¨å›å¤ï¼‰ï¼šé å³å¯¹é½ï¼Œä¸»é¢˜è‰²èƒŒæ™¯
 * - LEGACYï¼ˆæ—§æ•°æ®ï¼‰ï¼šå±…ä¸­å¯¹é½ï¼Œä¸­æ€§èƒŒæ™¯
 *
 * UI éšè—å‰ç¼€ï¼šç”¨æˆ·ä¸ä¼šçœ‹åˆ°ã€å¯¹æ–¹è¯´ã€‘ï¼šç­‰å‰ç¼€æ–‡æœ¬ï¼Œåªæ˜¾ç¤ºçº¯å†…å®¹ã€‚
 *
 * @param log å¯¹è¯è®°å½•
 * @param modifier Modifier
 * @param onClick ç‚¹å‡»å›è°ƒï¼ˆç”¨äºç¼–è¾‘ï¼‰
 */
@Composable
fun ConversationBubble(
    log: ConversationLog,
    modifier: Modifier = Modifier,
    onClick: (() -> Unit)? = null
) {
    // è§£æèº«ä»½å‰ç¼€ï¼Œä½¿ç”¨ remember ç¼“å­˜ç»“æœé¿å…é‡å¤è®¡ç®—
    val parseResult = remember(log.userInput) {
        IdentityPrefixHelper.parse(log.userInput)
    }

    // æ ¹æ®èº«ä»½ç¡®å®šå¯¹é½æ–¹å¼
    val alignment = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT -> Alignment.Start
        IdentityPrefixHelper.IdentityRole.USER -> Alignment.End
        IdentityPrefixHelper.IdentityRole.LEGACY -> Alignment.CenterHorizontally
    }

    // æ ¹æ®èº«ä»½ç¡®å®šèƒŒæ™¯è‰²
    val backgroundColor = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            MaterialTheme.colorScheme.surfaceVariant
        IdentityPrefixHelper.IdentityRole.USER ->
            MaterialTheme.colorScheme.primaryContainer
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            MaterialTheme.colorScheme.surface
    }

    // æ ¹æ®èº«ä»½ç¡®å®šæ°”æ³¡å½¢çŠ¶ï¼ˆä¸åŒè§’çš„åœ†è§’å¤§å°ï¼‰
    val bubbleShape = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            RoundedCornerShape(4.dp, 16.dp, 16.dp, 16.dp)  // å·¦ä¸Šè§’å°
        IdentityPrefixHelper.IdentityRole.USER ->
            RoundedCornerShape(16.dp, 4.dp, 16.dp, 16.dp)  // å³ä¸Šè§’å°
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            RoundedCornerShape(16.dp)  // å…¨åœ†è§’
    }

    // æ ¹æ®èº«ä»½ç¡®å®šæ–‡å­—é¢œè‰²
    val textColor = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            MaterialTheme.colorScheme.onSurfaceVariant
        IdentityPrefixHelper.IdentityRole.USER ->
            MaterialTheme.colorScheme.onPrimaryContainer
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            MaterialTheme.colorScheme.onSurface
    }

    Column(
        modifier = modifier.fillMaxWidth(),
        horizontalAlignment = alignment
    ) {
        // æ ‡ç­¾å’Œæ—¶é—´
        Row(
            verticalAlignment = Alignment.CenterVertically,
            modifier = Modifier.padding(bottom = 4.dp)
        ) {
            Text(
                text = parseResult.role.displayName,
                style = MaterialTheme.typography.labelSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Text(
                text = " Â· ${formatTime(log.timestamp)}",
                style = MaterialTheme.typography.labelSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }

        // æ°”æ³¡
        Surface(
            shape = bubbleShape,
            color = backgroundColor,
            modifier = Modifier
                .widthIn(max = 280.dp)
                .then(
                    if (onClick != null) {
                        Modifier.clickable { onClick() }
                    } else {
                        Modifier
                    }
                )
        ) {
            Text(
                text = parseResult.content,  // æ˜¾ç¤ºçº¯æ–‡æœ¬ï¼Œä¸å«å‰ç¼€
                style = MaterialTheme.typography.bodyMedium,
                color = textColor,
                modifier = Modifier.padding(12.dp)
            )
        }
    }
}

/**
 * ç®€åŒ–ç‰ˆå¯¹è¯æ°”æ³¡ï¼ˆç›´æ¥ä¼ å…¥å†…å®¹å’Œè§’è‰²ï¼‰
 *
 * @param content å¯¹è¯å†…å®¹ï¼ˆå¯èƒ½å¸¦å‰ç¼€ï¼‰
 * @param timestamp æ—¶é—´æˆ³
 * @param modifier Modifier
 * @param onClick ç‚¹å‡»å›è°ƒ
 */
@Composable
fun ConversationBubble(
    content: String,
    timestamp: Long,
    modifier: Modifier = Modifier,
    onClick: (() -> Unit)? = null
) {
    // è§£æèº«ä»½å‰ç¼€
    val parseResult = remember(content) {
        IdentityPrefixHelper.parse(content)
    }

    // æ ¹æ®èº«ä»½ç¡®å®šå¯¹é½æ–¹å¼
    val alignment = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT -> Alignment.Start
        IdentityPrefixHelper.IdentityRole.USER -> Alignment.End
        IdentityPrefixHelper.IdentityRole.LEGACY -> Alignment.CenterHorizontally
    }

    // æ ¹æ®èº«ä»½ç¡®å®šèƒŒæ™¯è‰²
    val backgroundColor = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            MaterialTheme.colorScheme.surfaceVariant
        IdentityPrefixHelper.IdentityRole.USER ->
            MaterialTheme.colorScheme.primaryContainer
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            MaterialTheme.colorScheme.surface
    }

    // æ ¹æ®èº«ä»½ç¡®å®šæ°”æ³¡å½¢çŠ¶
    val bubbleShape = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            RoundedCornerShape(4.dp, 16.dp, 16.dp, 16.dp)
        IdentityPrefixHelper.IdentityRole.USER ->
            RoundedCornerShape(16.dp, 4.dp, 16.dp, 16.dp)
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            RoundedCornerShape(16.dp)
    }

    // æ ¹æ®èº«ä»½ç¡®å®šæ–‡å­—é¢œè‰²
    val textColor = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            MaterialTheme.colorScheme.onSurfaceVariant
        IdentityPrefixHelper.IdentityRole.USER ->
            MaterialTheme.colorScheme.onPrimaryContainer
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            MaterialTheme.colorScheme.onSurface
    }

    Column(
        modifier = modifier.fillMaxWidth(),
        horizontalAlignment = alignment
    ) {
        // æ ‡ç­¾å’Œæ—¶é—´
        Row(
            verticalAlignment = Alignment.CenterVertically,
            modifier = Modifier.padding(bottom = 4.dp)
        ) {
            Text(
                text = parseResult.role.displayName,
                style = MaterialTheme.typography.labelSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Text(
                text = " Â· ${formatTime(timestamp)}",
                style = MaterialTheme.typography.labelSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }

        // æ°”æ³¡
        Surface(
            shape = bubbleShape,
            color = backgroundColor,
            modifier = Modifier
                .widthIn(max = 280.dp)
                .then(
                    if (onClick != null) {
                        Modifier.clickable { onClick() }
                    } else {
                        Modifier
                    }
                )
        ) {
            Text(
                text = parseResult.content,
                style = MaterialTheme.typography.bodyMedium,
                color = textColor,
                modifier = Modifier.padding(12.dp)
            )
        }
    }
}

/**
 * æ ¼å¼åŒ–æ—¶é—´æˆ³
 */
private fun formatTime(timestamp: Long): String {
    val sdf = SimpleDateFormat("MM-dd HH:mm", Locale.getDefault())
    return sdf.format(Date(timestamp))
}

// ==================== Previews ====================

@Preview(name = "å¯¹æ–¹è¯´çš„æ°”æ³¡", showBackground = true)
@Composable
private fun PreviewContactBubble() {
    EmpathyTheme {
        ConversationBubble(
            log = ConversationLog(
                id = 1,
                contactId = "contact_1",
                userInput = "${IdentityPrefixHelper.PREFIX_CONTACT}ä½ æ€ä¹ˆæ‰å›æ¶ˆæ¯ï¼Ÿ",
                aiResponse = null,
                timestamp = System.currentTimeMillis(),
                isSummarized = false
            ),
            modifier = Modifier.padding(16.dp)
        )
    }
}

@Preview(name = "æˆ‘æ­£åœ¨å›å¤çš„æ°”æ³¡", showBackground = true)
@Composable
private fun PreviewUserBubble() {
    EmpathyTheme {
        ConversationBubble(
            log = ConversationLog(
                id = 2,
                contactId = "contact_1",
                userInput = "${IdentityPrefixHelper.PREFIX_USER}åˆšæ‰åœ¨å¼€ä¼šï¼ŒæŠ±æ­‰è®©ä½ ä¹…ç­‰äº†",
                aiResponse = null,
                timestamp = System.currentTimeMillis(),
                isSummarized = false
            ),
            modifier = Modifier.padding(16.dp)
        )
    }
}

@Preview(name = "æ—§æ•°æ®æ°”æ³¡ï¼ˆæ— å‰ç¼€ï¼‰", showBackground = true)
@Composable
private fun PreviewLegacyBubble() {
    EmpathyTheme {
        ConversationBubble(
            log = ConversationLog(
                id = 3,
                contactId = "contact_1",
                userInput = "è¿™æ˜¯ä¸€æ¡æ—§æ•°æ®ï¼Œæ²¡æœ‰èº«ä»½å‰ç¼€",
                aiResponse = null,
                timestamp = System.currentTimeMillis(),
                isSummarized = false
            ),
            modifier = Modifier.padding(16.dp)
        )
    }
}

@Preview(name = "å¯¹è¯æ°”æ³¡ç»„åˆ", showBackground = true)
@Composable
private fun PreviewConversationFlow() {
    EmpathyTheme {
        Column(modifier = Modifier.padding(16.dp)) {
            ConversationBubble(
                content = "${IdentityPrefixHelper.PREFIX_CONTACT}æ—©å®‰",
                timestamp = System.currentTimeMillis() - 3600000
            )
            ConversationBubble(
                content = "${IdentityPrefixHelper.PREFIX_USER}æ—©å‘€ï¼Œä»Šå¤©å¤©æ°”çœŸå¥½",
                timestamp = System.currentTimeMillis() - 3500000,
                modifier = Modifier.padding(top = 8.dp)
            )
            ConversationBubble(
                content = "${IdentityPrefixHelper.PREFIX_CONTACT}æ˜¯å•Šï¼Œè¦ä¸è¦å‡ºå»èµ°èµ°ï¼Ÿ",
                timestamp = System.currentTimeMillis(),
                modifier = Modifier.padding(top = 8.dp)
            )
        }
    }
}
```

#### ä¿®æ”¹åï¼ˆå®Œæ•´ä»£ç ï¼‰

```kotlin
// file: presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/message/ConversationBubble.kt
// ä¿®æ”¹å
package com.empathy.ai.presentation.ui.component.message

import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.widthIn
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import com.empathy.ai.domain.model.ConversationLog
import com.empathy.ai.domain.util.IdentityPrefixHelper
import com.empathy.ai.presentation.theme.EmpathyTheme
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

/**
 * å¯¹è¯æ°”æ³¡ç»„ä»¶
 *
 * æ ¹æ®èº«ä»½å‰ç¼€è‡ªåŠ¨æ¸²æŸ“å·¦å³å¸ƒå±€çš„å¯¹è¯æ°”æ³¡ã€‚
 *
 * å¸ƒå±€è§„åˆ™ï¼ˆPRD-00008ï¼‰ï¼š
 * - CONTACTï¼ˆå¯¹æ–¹è¯´ï¼‰ï¼šé å·¦å¯¹é½ï¼Œæµ…ç°èƒŒæ™¯
 * - USERï¼ˆæˆ‘æ­£åœ¨å›å¤ï¼‰ï¼šé å³å¯¹é½ï¼Œä¸»é¢˜è‰²èƒŒæ™¯
 * - LEGACYï¼ˆæ—§æ•°æ®ï¼‰ï¼šå±…ä¸­å¯¹é½ï¼Œä¸­æ€§èƒŒæ™¯
 *
 * UI éšè—å‰ç¼€ï¼šç”¨æˆ·ä¸ä¼šçœ‹åˆ°ã€å¯¹æ–¹è¯´ã€‘ï¼šç­‰å‰ç¼€æ–‡æœ¬ï¼Œåªæ˜¾ç¤ºçº¯å†…å®¹ã€‚
 *
 * @param log å¯¹è¯è®°å½•
 * @param modifier Modifier
 * @param onClick ç‚¹å‡»å›è°ƒï¼ˆç”¨äºç¼–è¾‘ï¼‰
 */
@Composable
fun ConversationBubble(
    log: ConversationLog,
    modifier: Modifier = Modifier,
    onClick: (() -> Unit)? = null,
    showHeader: Boolean = true,
    maxLines: Int = Int.MAX_VALUE,
    overflow: TextOverflow = TextOverflow.Clip
) {
    // è§£æèº«ä»½å‰ç¼€ï¼Œä½¿ç”¨ remember ç¼“å­˜ç»“æœé¿å…é‡å¤è®¡ç®—
    val parseResult = remember(log.userInput) {
        IdentityPrefixHelper.parse(log.userInput)
    }

    // æ ¹æ®èº«ä»½ç¡®å®šå¯¹é½æ–¹å¼
    val alignment = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT -> Alignment.Start
        IdentityPrefixHelper.IdentityRole.USER -> Alignment.End
        IdentityPrefixHelper.IdentityRole.LEGACY -> Alignment.CenterHorizontally
    }

    // æ ¹æ®èº«ä»½ç¡®å®šèƒŒæ™¯è‰²
    val backgroundColor = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            MaterialTheme.colorScheme.surfaceVariant
        IdentityPrefixHelper.IdentityRole.USER ->
            MaterialTheme.colorScheme.primaryContainer
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            MaterialTheme.colorScheme.surface
    }

    // æ ¹æ®èº«ä»½ç¡®å®šæ°”æ³¡å½¢çŠ¶ï¼ˆä¸åŒè§’çš„åœ†è§’å¤§å°ï¼‰
    val bubbleShape = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            RoundedCornerShape(4.dp, 16.dp, 16.dp, 16.dp)  // å·¦ä¸Šè§’å°
        IdentityPrefixHelper.IdentityRole.USER ->
            RoundedCornerShape(16.dp, 4.dp, 16.dp, 16.dp)  // å³ä¸Šè§’å°
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            RoundedCornerShape(16.dp)  // å…¨åœ†è§’
    }

    // æ ¹æ®èº«ä»½ç¡®å®šæ–‡å­—é¢œè‰²
    val textColor = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            MaterialTheme.colorScheme.onSurfaceVariant
        IdentityPrefixHelper.IdentityRole.USER ->
            MaterialTheme.colorScheme.onPrimaryContainer
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            MaterialTheme.colorScheme.onSurface
    }

    Column(
        modifier = modifier.fillMaxWidth(),
        horizontalAlignment = alignment
    ) {
        if (showHeader) {
            // æ ‡ç­¾å’Œæ—¶é—´
            Row(
                verticalAlignment = Alignment.CenterVertically,
                modifier = Modifier.padding(bottom = 4.dp)
            ) {
                Text(
                    text = parseResult.role.displayName,
                    style = MaterialTheme.typography.labelSmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                Text(
                    text = " Â· ${formatTime(log.timestamp)}",
                    style = MaterialTheme.typography.labelSmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }

        // æ°”æ³¡
        Surface(
            shape = bubbleShape,
            color = backgroundColor,
            modifier = Modifier
                .widthIn(max = 280.dp)
                .then(
                    if (onClick != null) {
                        Modifier.clickable { onClick() }
                    } else {
                        Modifier
                    }
                )
        ) {
            Text(
                text = parseResult.content,  // æ˜¾ç¤ºçº¯æ–‡æœ¬ï¼Œä¸å«å‰ç¼€
                style = MaterialTheme.typography.bodyMedium,
                color = textColor,
                modifier = Modifier.padding(12.dp),
                maxLines = maxLines,
                overflow = overflow
            )
        }
    }
}

/**
 * ç®€åŒ–ç‰ˆå¯¹è¯æ°”æ³¡ï¼ˆç›´æ¥ä¼ å…¥å†…å®¹å’Œè§’è‰²ï¼‰
 *
 * @param content å¯¹è¯å†…å®¹ï¼ˆå¯èƒ½å¸¦å‰ç¼€ï¼‰
 * @param timestamp æ—¶é—´æˆ³
 * @param modifier Modifier
 * @param onClick ç‚¹å‡»å›è°ƒ
 */
@Composable
fun ConversationBubble(
    content: String,
    timestamp: Long,
    modifier: Modifier = Modifier,
    onClick: (() -> Unit)? = null,
    showHeader: Boolean = true,
    maxLines: Int = Int.MAX_VALUE,
    overflow: TextOverflow = TextOverflow.Clip
) {
    // è§£æèº«ä»½å‰ç¼€
    val parseResult = remember(content) {
        IdentityPrefixHelper.parse(content)
    }

    // æ ¹æ®èº«ä»½ç¡®å®šå¯¹é½æ–¹å¼
    val alignment = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT -> Alignment.Start
        IdentityPrefixHelper.IdentityRole.USER -> Alignment.End
        IdentityPrefixHelper.IdentityRole.LEGACY -> Alignment.CenterHorizontally
    }

    // æ ¹æ®èº«ä»½ç¡®å®šèƒŒæ™¯è‰²
    val backgroundColor = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            MaterialTheme.colorScheme.surfaceVariant
        IdentityPrefixHelper.IdentityRole.USER ->
            MaterialTheme.colorScheme.primaryContainer
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            MaterialTheme.colorScheme.surface
    }

    // æ ¹æ®èº«ä»½ç¡®å®šæ°”æ³¡å½¢çŠ¶
    val bubbleShape = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            RoundedCornerShape(4.dp, 16.dp, 16.dp, 16.dp)
        IdentityPrefixHelper.IdentityRole.USER ->
            RoundedCornerShape(16.dp, 4.dp, 16.dp, 16.dp)
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            RoundedCornerShape(16.dp)
    }

    // æ ¹æ®èº«ä»½ç¡®å®šæ–‡å­—é¢œè‰²
    val textColor = when (parseResult.role) {
        IdentityPrefixHelper.IdentityRole.CONTACT ->
            MaterialTheme.colorScheme.onSurfaceVariant
        IdentityPrefixHelper.IdentityRole.USER ->
            MaterialTheme.colorScheme.onPrimaryContainer
        IdentityPrefixHelper.IdentityRole.LEGACY ->
            MaterialTheme.colorScheme.onSurface
    }

    Column(
        modifier = modifier.fillMaxWidth(),
        horizontalAlignment = alignment
    ) {
        if (showHeader) {
            // æ ‡ç­¾å’Œæ—¶é—´
            Row(
                verticalAlignment = Alignment.CenterVertically,
                modifier = Modifier.padding(bottom = 4.dp)
            ) {
                Text(
                    text = parseResult.role.displayName,
                    style = MaterialTheme.typography.labelSmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                Text(
                    text = " Â· ${formatTime(timestamp)}",
                    style = MaterialTheme.typography.labelSmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }

        // æ°”æ³¡
        Surface(
            shape = bubbleShape,
            color = backgroundColor,
            modifier = Modifier
                .widthIn(max = 280.dp)
                .then(
                    if (onClick != null) {
                        Modifier.clickable { onClick() }
                    } else {
                        Modifier
                    }
                )
        ) {
            Text(
                text = parseResult.content,
                style = MaterialTheme.typography.bodyMedium,
                color = textColor,
                modifier = Modifier.padding(12.dp),
                maxLines = maxLines,
                overflow = overflow
            )
        }
    }
}

/**
 * æ ¼å¼åŒ–æ—¶é—´æˆ³
 */
private fun formatTime(timestamp: Long): String {
    val sdf = SimpleDateFormat("MM-dd HH:mm", Locale.getDefault())
    return sdf.format(Date(timestamp))
}

// ==================== Previews ====================

@Preview(name = "å¯¹æ–¹è¯´çš„æ°”æ³¡", showBackground = true)
@Composable
private fun PreviewContactBubble() {
    EmpathyTheme {
        ConversationBubble(
            log = ConversationLog(
                id = 1,
                contactId = "contact_1",
                userInput = "${IdentityPrefixHelper.PREFIX_CONTACT}ä½ æ€ä¹ˆæ‰å›æ¶ˆæ¯ï¼Ÿ",
                aiResponse = null,
                timestamp = System.currentTimeMillis(),
                isSummarized = false
            ),
            modifier = Modifier.padding(16.dp)
        )
    }
}

@Preview(name = "æˆ‘æ­£åœ¨å›å¤çš„æ°”æ³¡", showBackground = true)
@Composable
private fun PreviewUserBubble() {
    EmpathyTheme {
        ConversationBubble(
            log = ConversationLog(
                id = 2,
                contactId = "contact_1",
                userInput = "${IdentityPrefixHelper.PREFIX_USER}åˆšæ‰åœ¨å¼€ä¼šï¼ŒæŠ±æ­‰è®©ä½ ä¹…ç­‰äº†",
                aiResponse = null,
                timestamp = System.currentTimeMillis(),
                isSummarized = false
            ),
            modifier = Modifier.padding(16.dp)
        )
    }
}

@Preview(name = "æ—§æ•°æ®æ°”æ³¡ï¼ˆæ— å‰ç¼€ï¼‰", showBackground = true)
@Composable
private fun PreviewLegacyBubble() {
    EmpathyTheme {
        ConversationBubble(
            log = ConversationLog(
                id = 3,
                contactId = "contact_1",
                userInput = "è¿™æ˜¯ä¸€æ¡æ—§æ•°æ®ï¼Œæ²¡æœ‰èº«ä»½å‰ç¼€",
                aiResponse = null,
                timestamp = System.currentTimeMillis(),
                isSummarized = false
            ),
            modifier = Modifier.padding(16.dp)
        )
    }
}

@Preview(name = "å¯¹è¯æ°”æ³¡ç»„åˆ", showBackground = true)
@Composable
private fun PreviewConversationFlow() {
    EmpathyTheme {
        Column(modifier = Modifier.padding(16.dp)) {
            ConversationBubble(
                content = "${IdentityPrefixHelper.PREFIX_CONTACT}æ—©å®‰",
                timestamp = System.currentTimeMillis() - 3600000
            )
            ConversationBubble(
                content = "${IdentityPrefixHelper.PREFIX_USER}æ—©å‘€ï¼Œä»Šå¤©å¤©æ°”çœŸå¥½",
                timestamp = System.currentTimeMillis() - 3500000,
                modifier = Modifier.padding(top = 8.dp)
            )
            ConversationBubble(
                content = "${IdentityPrefixHelper.PREFIX_CONTACT}æ˜¯å•Šï¼Œè¦ä¸è¦å‡ºå»èµ°èµ°ï¼Ÿ",
                timestamp = System.currentTimeMillis(),
                modifier = Modifier.padding(top = 8.dp)
            )
        }
    }
}
```

**ä¿®æ”¹åŸå› **ï¼šäº‹å®æµéœ€è¦éšè—èº«ä»½å‰ç¼€ï¼Œä½†åŸç»„ä»¶å¼ºåˆ¶æ˜¾ç¤ºâ€œèº«ä»½æ ‡ç­¾ + æ—¶é—´â€ï¼Œå¹¶ä¸”æ–‡æœ¬è¡Œæ•°æ— æ³•ç»Ÿä¸€æ§åˆ¶ï¼Œå¯¼è‡´å¡ç‰‡å±•ç¤ºä¸â€œæ°”æ³¡å‹å¯¹è¯â€ä½“éªŒä¸ä¸€è‡´ã€‚æœ¬æ¬¡æ–°å¢ `showHeader/maxLines/overflow` ä½œä¸ºå¯é€‰å‚æ•°ï¼Œæ—¢èƒ½ä¿ç•™é»˜è®¤è¡Œä¸ºï¼Œåˆèƒ½åœ¨äº‹å®æµå¡ç‰‡ä¸­å¤ç”¨ï¼Œé¿å…å¼•å…¥æ–°çš„ UI ç»„ä»¶ã€‚

**å½±å“åˆ†æ**ï¼š
- å¯¹ç°æœ‰è°ƒç”¨æ–¹ï¼šé»˜è®¤å‚æ•°ä¿æŒåŸè¡Œä¸ºï¼ˆä»æ˜¾ç¤ºå¤´éƒ¨ã€æ— é™è¡Œï¼‰ï¼Œä¸ä¼šå¼•å…¥è¡Œä¸ºå›å½’ã€‚
- å¯¹äº‹å®æµï¼šConversationCard å¯ä»¥éšè—å¤´éƒ¨å¹¶ä¿æŒä¸‰è¡Œçœç•¥ï¼Œé¿å…é•¿æ–‡æœ¬æŠŠå¡ç‰‡æ’‘é«˜ã€‚
- å¯¹æ ·å¼ä¸€è‡´æ€§ï¼šå¤ç”¨ç°æœ‰æ°”æ³¡æ ·å¼ï¼Œå‡å°‘æ–°æ ·å¼å·®å¼‚ã€‚

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
1) æ–°å»ºä¸“ç”¨ `FactStreamConversationBubble`ï¼šå¯å®Œå…¨å®šåˆ¶ï¼Œä½†ä¼šå¢åŠ æ ·å¼ç»´æŠ¤æˆæœ¬ã€‚
2) ç›´æ¥åœ¨ ConversationCard ä¸­è£å‰ªå‰ç¼€æ–‡æœ¬ï¼šé€»è¾‘åˆ†æ•£ä¸”ä¸åˆ©äºå¤ç”¨ã€‚
æœ€ç»ˆé€‰æ‹©å‚æ•°åŒ–å¤ç”¨ï¼Œå…¼é¡¾ä¸€è‡´æ€§ä¸ä½é£é™©ã€‚

---

### å˜æ›´ 2ï¼šConversationCard ä½¿ç”¨æ°”æ³¡æ¸²æŸ“èº«ä»½å†…å®¹

#### ä¿®æ”¹å‰ï¼ˆå®Œæ•´ä»£ç ï¼‰
```kotlin
// file: presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/card/ConversationCard.kt
// ä¿®æ”¹å‰
package com.empathy.ai.presentation.ui.component.card

import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Check
import androidx.compose.material.icons.filled.Schedule
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import com.empathy.ai.domain.model.ConversationLog
import com.empathy.ai.domain.model.EmotionType
import com.empathy.ai.domain.model.TimelineItem
import com.empathy.ai.presentation.theme.AdaptiveDimensions
import com.empathy.ai.presentation.theme.Dimensions
import com.empathy.ai.presentation.theme.EmpathyTheme
import com.empathy.ai.presentation.ui.component.emotion.GlassmorphicCard
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

/**
 * å¯¹è¯è®°å½•å¡ç‰‡ç»„ä»¶
 *
 * å±•ç¤ºå…·ä½“çš„å¯¹è¯å†…å®¹ï¼ŒåŒ…æ‹¬ç”¨æˆ·è¾“å…¥å’ŒAIå“åº”
 * æ”¯æŒé•¿æŒ‰ç¼–è¾‘/åˆ é™¤
 *
 * @param item å¯¹è¯è®°å½•æ•°æ®
 * @param onClick ç‚¹å‡»å›è°ƒ
 * @param onLongClick é•¿æŒ‰å›è°ƒï¼ˆç”¨äºç¼–è¾‘/åˆ é™¤ï¼‰
 * @param modifier Modifier
 */
@Composable
fun ConversationCard(
    item: TimelineItem.Conversation,
    modifier: Modifier = Modifier,
    onClick: (() -> Unit)? = null,
    onLongClick: (() -> Unit)? = null
) {
    val dimensions = AdaptiveDimensions.current
    
    GlassmorphicCard(
        modifier = modifier.fillMaxWidth(),
        onClick = onClick ?: onLongClick // ç‚¹å‡»æ—¶è§¦å‘ç¼–è¾‘
    ) {
        Column(modifier = Modifier.padding(dimensions.spacingMedium)) {
            // æ—¶é—´å’ŒçŠ¶æ€
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = formatTime(item.log.timestamp),
                    style = MaterialTheme.typography.labelSmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                
                // æ€»ç»“çŠ¶æ€
                Row(
                    horizontalArrangement = Arrangement.spacedBy(dimensions.spacingXSmall),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        imageVector = if (item.log.isSummarized) {
                            Icons.Default.Check
                        } else {
                            Icons.Default.Schedule
                        },
                        contentDescription = if (item.log.isSummarized) "å·²æ€»ç»“" else "å¾…æ€»ç»“",
                        modifier = Modifier.size(dimensions.iconSizeSmall - 2.dp),
                        tint = if (item.log.isSummarized) {
                            MaterialTheme.colorScheme.primary
                        } else {
                            MaterialTheme.colorScheme.onSurfaceVariant
                        }
                    )
                    Text(
                        text = if (item.log.isSummarized) "å·²æ€»ç»“" else "å¾…æ€»ç»“",
                        style = MaterialTheme.typography.labelSmall,
                        color = if (item.log.isSummarized) {
                            MaterialTheme.colorScheme.primary
                        } else {
                            MaterialTheme.colorScheme.onSurfaceVariant
                        }
                    )
                }
            }
            
            Spacer(modifier = Modifier.height(dimensions.spacingSmall))
            
            // ç”¨æˆ·è¾“å…¥
            Text(
                text = "ä½ ï¼š${item.log.userInput}",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurface,
                maxLines = 3,
                overflow = TextOverflow.Ellipsis
            )
            
            // AIå“åº”å·²ç§»é™¤ - BUG-00001ä¿®å¤
            // åŸå› ï¼šAIå›å¤æ˜¾ç¤ºä¸ºæ ¼å¼åŒ–æ‘˜è¦è€Œéå®Œæ•´å»ºè®®ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
            // å¯¹è¯è®°å½•åªä¿ç•™ç”¨æˆ·è¾“å…¥ï¼ŒAIå»ºè®®åœ¨åˆ†ææ—¶å®æ—¶ç”Ÿæˆ
        }
    }
}

/**
 * æ ¼å¼åŒ–æ—¶é—´
 */
private fun formatTime(timestamp: Long): String {
    val sdf = SimpleDateFormat("MM-dd HH:mm", Locale.getDefault())
    return sdf.format(Date(timestamp))
}

// ========== é¢„è§ˆ ==========

@Preview(name = "å¯¹è¯å¡ç‰‡ - å·²æ€»ç»“", showBackground = true)
@Composable
private fun PreviewConversationCardSummarized() {
    EmpathyTheme {
        ConversationCard(
            item = TimelineItem.Conversation(
                id = "1",
                timestamp = System.currentTimeMillis(),
                emotionType = EmotionType.NEUTRAL,
                log = ConversationLog(
                    id = 1,
                    contactId = "contact_1",
                    userInput = "ä»Šå¤©æƒ³çº¦å¥¹å‡ºå»åƒé¥­ï¼Œä½†ä¸çŸ¥é“æ€ä¹ˆå¼€å£æ¯”è¾ƒå¥½",
                    aiResponse = "å»ºè®®ç”¨è½»æ¾çš„æ–¹å¼é‚€è¯·ï¼Œæ¯”å¦‚è¯´å‘ç°äº†ä¸€å®¶ä¸é”™çš„é¤å…æƒ³ä¸€èµ·å»å°å°",
                    timestamp = System.currentTimeMillis(),
                    isSummarized = true
                )
            ),
            modifier = Modifier.padding(16.dp)
        )
    }
}

@Preview(name = "å¯¹è¯å¡ç‰‡ - å¾…æ€»ç»“", showBackground = true)
@Composable
private fun PreviewConversationCardPending() {
    EmpathyTheme {
        ConversationCard(
            item = TimelineItem.Conversation(
                id = "2",
                timestamp = System.currentTimeMillis(),
                emotionType = EmotionType.SWEET,
                log = ConversationLog(
                    id = 2,
                    contactId = "contact_1",
                    userInput = "å¥¹è¯´å–œæ¬¢æˆ‘é€çš„ç¤¼ç‰©ï¼Œæ„Ÿè§‰å¾ˆå¼€å¿ƒ",
                    aiResponse = null,
                    timestamp = System.currentTimeMillis(),
                    isSummarized = false
                )
            ),
            modifier = Modifier.padding(16.dp)
        )
    }
}
```

#### ä¿®æ”¹åï¼ˆå®Œæ•´ä»£ç ï¼‰

```kotlin
// file: presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/card/ConversationCard.kt
// ä¿®æ”¹å
package com.empathy.ai.presentation.ui.component.card

import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Check
import androidx.compose.material.icons.filled.Schedule
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import com.empathy.ai.domain.model.ConversationLog
import com.empathy.ai.domain.model.EmotionType
import com.empathy.ai.domain.model.TimelineItem
import com.empathy.ai.domain.util.IdentityPrefixHelper
import com.empathy.ai.presentation.theme.AdaptiveDimensions
import com.empathy.ai.presentation.theme.Dimensions
import com.empathy.ai.presentation.theme.EmpathyTheme
import com.empathy.ai.presentation.ui.component.emotion.GlassmorphicCard
import com.empathy.ai.presentation.ui.component.message.ConversationBubble
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

/**
 * å¯¹è¯è®°å½•å¡ç‰‡ç»„ä»¶
 *
 * å±•ç¤ºå…·ä½“çš„å¯¹è¯å†…å®¹ï¼ŒåŒ…æ‹¬ç”¨æˆ·è¾“å…¥å’ŒAIå“åº”
 * æ”¯æŒé•¿æŒ‰ç¼–è¾‘/åˆ é™¤
 *
 * @param item å¯¹è¯è®°å½•æ•°æ®
 * @param onClick ç‚¹å‡»å›è°ƒ
 * @param onLongClick é•¿æŒ‰å›è°ƒï¼ˆç”¨äºç¼–è¾‘/åˆ é™¤ï¼‰
 * @param modifier Modifier
 */
@Composable
fun ConversationCard(
    item: TimelineItem.Conversation,
    modifier: Modifier = Modifier,
    onClick: (() -> Unit)? = null,
    onLongClick: (() -> Unit)? = null
) {
    val dimensions = AdaptiveDimensions.current
    val parseResult = remember(item.log.userInput) {
        IdentityPrefixHelper.parse(item.log.userInput)
    }

    GlassmorphicCard(
        modifier = modifier.fillMaxWidth(),
        onClick = onClick ?: onLongClick // ç‚¹å‡»æ—¶è§¦å‘ç¼–è¾‘
    ) {
        Column(modifier = Modifier.padding(dimensions.spacingMedium)) {
            // æ—¶é—´å’ŒçŠ¶æ€
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = "${parseResult.role.displayName} Â· ${formatTime(item.log.timestamp)}",
                    style = MaterialTheme.typography.labelSmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                
                // æ€»ç»“çŠ¶æ€
                Row(
                    horizontalArrangement = Arrangement.spacedBy(dimensions.spacingXSmall),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        imageVector = if (item.log.isSummarized) {
                            Icons.Default.Check
                        } else {
                            Icons.Default.Schedule
                        },
                        contentDescription = if (item.log.isSummarized) "å·²æ€»ç»“" else "å¾…æ€»ç»“",
                        modifier = Modifier.size(dimensions.iconSizeSmall - 2.dp),
                        tint = if (item.log.isSummarized) {
                            MaterialTheme.colorScheme.primary
                        } else {
                            MaterialTheme.colorScheme.onSurfaceVariant
                        }
                    )
                    Text(
                        text = if (item.log.isSummarized) "å·²æ€»ç»“" else "å¾…æ€»ç»“",
                        style = MaterialTheme.typography.labelSmall,
                        color = if (item.log.isSummarized) {
                            MaterialTheme.colorScheme.primary
                        } else {
                            MaterialTheme.colorScheme.onSurfaceVariant
                        }
                    )
                }
            }
            
            Spacer(modifier = Modifier.height(dimensions.spacingSmall))
            
            // å¯¹è¯æ°”æ³¡ï¼ˆéšè—å‰ç¼€ï¼ŒæŒ‰èº«ä»½å·¦å³å¯¹é½ï¼‰
            ConversationBubble(
                log = item.log,
                showHeader = false,
                maxLines = 3,
                overflow = TextOverflow.Ellipsis
            )
            
            // AIå“åº”å·²ç§»é™¤ - BUG-00001ä¿®å¤
            // åŸå› ï¼šAIå›å¤æ˜¾ç¤ºä¸ºæ ¼å¼åŒ–æ‘˜è¦è€Œéå®Œæ•´å»ºè®®ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
            // å¯¹è¯è®°å½•åªä¿ç•™ç”¨æˆ·è¾“å…¥ï¼ŒAIå»ºè®®åœ¨åˆ†ææ—¶å®æ—¶ç”Ÿæˆ
        }
    }
}

/**
 * æ ¼å¼åŒ–æ—¶é—´
 */
private fun formatTime(timestamp: Long): String {
    val sdf = SimpleDateFormat("MM-dd HH:mm", Locale.getDefault())
    return sdf.format(Date(timestamp))
}

// ========== é¢„è§ˆ ==========

@Preview(name = "å¯¹è¯å¡ç‰‡ - å·²æ€»ç»“", showBackground = true)
@Composable
private fun PreviewConversationCardSummarized() {
    EmpathyTheme {
        ConversationCard(
            item = TimelineItem.Conversation(
                id = "1",
                timestamp = System.currentTimeMillis(),
                emotionType = EmotionType.NEUTRAL,
                log = ConversationLog(
                    id = 1,
                    contactId = "contact_1",
                    userInput = "ä»Šå¤©æƒ³çº¦å¥¹å‡ºå»åƒé¥­ï¼Œä½†ä¸çŸ¥é“æ€ä¹ˆå¼€å£æ¯”è¾ƒå¥½",
                    aiResponse = "å»ºè®®ç”¨è½»æ¾çš„æ–¹å¼é‚€è¯·ï¼Œæ¯”å¦‚è¯´å‘ç°äº†ä¸€å®¶ä¸é”™çš„é¤å…æƒ³ä¸€èµ·å»å°å°",
                    timestamp = System.currentTimeMillis(),
                    isSummarized = true
                )
            ),
            modifier = Modifier.padding(16.dp)
        )
    }
}

@Preview(name = "å¯¹è¯å¡ç‰‡ - å¾…æ€»ç»“", showBackground = true)
@Composable
private fun PreviewConversationCardPending() {
    EmpathyTheme {
        ConversationCard(
            item = TimelineItem.Conversation(
                id = "2",
                timestamp = System.currentTimeMillis(),
                emotionType = EmotionType.SWEET,
                log = ConversationLog(
                    id = 2,
                    contactId = "contact_1",
                    userInput = "å¥¹è¯´å–œæ¬¢æˆ‘é€çš„ç¤¼ç‰©ï¼Œæ„Ÿè§‰å¾ˆå¼€å¿ƒ",
                    aiResponse = null,
                    timestamp = System.currentTimeMillis(),
                    isSummarized = false
                )
            ),
            modifier = Modifier.padding(16.dp)
        )
    }
}
```

**ä¿®æ”¹åŸå› **ï¼šäº‹å®æµå¡ç‰‡åŸæœ¬ç›´æ¥å±•ç¤º `ä½ ï¼š${userInput}`ï¼Œä¼šæŠŠ `ã€å¯¹æ–¹è¯´ã€‘ï¼š` ç­‰å‰ç¼€æš´éœ²ç»™ç”¨æˆ·ï¼Œä¸”è§†è§‰ä¸Šå§‹ç»ˆæ˜¯å•åˆ—æ–‡æœ¬ï¼Œä¸ç¬¦åˆ PRD-00008 çš„å·¦å³æ°”æ³¡è¦æ±‚ã€‚å°†å¯¹è¯å†…å®¹æ”¹ä¸º ConversationBubble æ¸²æŸ“ï¼Œèƒ½å¤Ÿè‡ªåŠ¨è§£æèº«ä»½å‰ç¼€å¹¶éšè—æ–‡æœ¬å‰ç¼€ï¼ŒåŒæ—¶ä¿ç•™â€œæ—¶é—´ + æ€»ç»“çŠ¶æ€â€çš„å¡ç‰‡ç»“æ„ã€‚

**å½±å“åˆ†æ**ï¼š
- UI è¡Œä¸ºå˜åŒ–ï¼šæ­£æ–‡åŒºåŸŸæ”¹ä¸ºæ°”æ³¡å¸ƒå±€ï¼Œèº«ä»½æ ‡ç­¾ä¸æ—¶é—´ä»ä¿ç•™åœ¨å¡ç‰‡å¤´éƒ¨ï¼›ç”¨æˆ·å¯æ›´ç›´è§‚åŒºåˆ†â€œå¯¹æ–¹/æˆ‘â€çš„å¯¹è¯ã€‚
- æ—§æ•°æ®å…¼å®¹ï¼šæ— å‰ç¼€å†…å®¹ä¼šèµ° LEGACY æ¸²æŸ“ï¼ˆå±…ä¸­ + ä¸­æ€§èƒŒæ™¯ï¼‰ï¼Œç¬¦åˆå…¼å®¹æ€§è¦æ±‚ã€‚
- äº¤äº’å½±å“ï¼šåŸæœ‰ onClick/onLongClick ä¸å˜ï¼Œæ°”æ³¡ä»å¯è§¦å‘ç¼–è¾‘ã€‚

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
1) åœ¨ ConversationCard å†…éƒ¨æ‰‹åŠ¨è§£æå‰ç¼€å¹¶ç”»æ°”æ³¡ï¼šå®ç°è€¦åˆåˆ°å¡ç‰‡ï¼Œå¤ç”¨æ€§è¾ƒå·®ã€‚
2) ç›´æ¥æ›¿æ¢ä¸ºæ–°çš„äº‹å®æµç»„ä»¶ï¼šæ”¹åŠ¨èŒƒå›´å¤§ï¼Œé£é™©é«˜ã€‚
å› æ­¤é€‰æ‹©å¤ç”¨ ConversationBubble å¹¶éšè—å¤´éƒ¨ã€‚

---

### å˜æ›´ 3ï¼šæ–°å¢ IdentityPrefixHelper å•å…ƒæµ‹è¯•

#### æ–°å¢ä»£ç ï¼ˆå®Œæ•´ä»£ç ï¼‰
```kotlin
// file: domain/src/test/kotlin/com/empathy/ai/domain/util/IdentityPrefixHelperTest.kt
// æ–°å¢
package com.empathy.ai.domain.util

import com.empathy.ai.domain.model.ActionType
import org.junit.Assert.assertEquals
import org.junit.Test

/**
 * IdentityPrefixHelper å•å…ƒæµ‹è¯•
 *
 * è¦†ç›–èº«ä»½å‰ç¼€çš„æ·»åŠ ã€è§£æä¸æ¸…ç†é€»è¾‘ã€‚
 */
class IdentityPrefixHelperTest {

    @Test
    fun `addPrefixåº”æ ¹æ®åŠ¨ä½œç±»å‹æ·»åŠ æ­£ç¡®å‰ç¼€å¹¶å»é‡`() {
        // Given
        val raw = "ä½ å¥½"

        // When
        val analyze = IdentityPrefixHelper.addPrefix(raw, ActionType.ANALYZE)
        assertEquals("${IdentityPrefixHelper.PREFIX_CONTACT}ä½ å¥½", analyze)

        val check = IdentityPrefixHelper.addPrefix(raw, ActionType.CHECK)
        assertEquals("${IdentityPrefixHelper.PREFIX_USER}ä½ å¥½", check)

        val swapped = IdentityPrefixHelper.addPrefix(
            "${IdentityPrefixHelper.PREFIX_USER}ä½ å¥½",
            ActionType.ANALYZE
        )

        // Then
        assertEquals("${IdentityPrefixHelper.PREFIX_CONTACT}ä½ å¥½", swapped)
    }

    @Test
    fun `parseåº”æ­£ç¡®è¯†åˆ«èº«ä»½å¹¶è¿”å›çº¯æ–‡æœ¬`() {
        // Given
        val contact = IdentityPrefixHelper.parse("${IdentityPrefixHelper.PREFIX_CONTACT}æ—©å®‰")

        // When
        assertEquals(IdentityPrefixHelper.IdentityRole.CONTACT, contact.role)
        assertEquals("æ—©å®‰", contact.content)

        val user = IdentityPrefixHelper.parse("${IdentityPrefixHelper.PREFIX_USER}æˆ‘é©¬ä¸Šåˆ°")
        assertEquals(IdentityPrefixHelper.IdentityRole.USER, user.role)
        assertEquals("æˆ‘é©¬ä¸Šåˆ°", user.content)

        val legacy = IdentityPrefixHelper.parse("è¿™æ˜¯ä¸€æ¡æ—§æ•°æ®")

        // Then
        assertEquals(IdentityPrefixHelper.IdentityRole.LEGACY, legacy.role)
        assertEquals("è¿™æ˜¯ä¸€æ¡æ—§æ•°æ®", legacy.content)
    }

    @Test
    fun `stripAllPrefixesåº”ç§»é™¤å¤šé‡å‰ç¼€`() {
        // Given
        val content = "${IdentityPrefixHelper.PREFIX_CONTACT}${IdentityPrefixHelper.PREFIX_USER}ä½ å¥½"

        // When
        val stripped = IdentityPrefixHelper.stripAllPrefixes(content)

        // Then
        assertEquals("ä½ å¥½", stripped)
    }
}
```

**æµ‹è¯•æ„å›¾è¯´æ˜**ï¼š
- `addPrefix`ï¼šéªŒè¯ä¸åŒ ActionType ä¸‹å‰ç¼€æ­£ç¡®ã€é‡å¤å‰ç¼€å¯è¢«æ¸…ç†ï¼Œä¿è¯åˆ†æ/æ£€æŸ¥è¾“å…¥ä¸ä¼šå‡ºç°åŒå‰ç¼€æˆ–é”™è¯¯å‰ç¼€ã€‚
- `parse`ï¼šéªŒè¯å‰ç¼€è§£æä¸æ—§æ•°æ®å…¼å®¹è¡Œä¸ºï¼Œç¡®ä¿ UI æ¸²æŸ“ä¸å†å²ä¸Šä¸‹æ–‡çš„è§’è‰²åˆ¤æ–­ä¸€è‡´ã€‚
- `stripAllPrefixes`ï¼šéªŒè¯é€’å½’æ¸…ç†é€»è¾‘ï¼Œç¡®ä¿å‰ç¼€è¢«é‡å¤ç²˜è´´æ—¶èƒ½è¢«å½’ä¸€åŒ–ã€‚

**è¾¹ç•Œæƒ…å†µè¯´æ˜**ï¼š
- åŒ…å«â€œå¯¹æ–¹è¯´ + æˆ‘æ­£åœ¨å›å¤â€çš„æ··åˆå‰ç¼€è¾“å…¥ï¼Œå±äº OCR æˆ–å¤åˆ¶åœºæ™¯çš„å¸¸è§è¯¯å·®ï¼Œéœ€ç¡®ä¿æœ€ç»ˆå†…å®¹ä¸å¸¦å‰ç¼€ã€‚

**æˆ‘çš„åˆ¤æ–­**ï¼šå»ºè®®ä¿ç•™ã€‚
**åˆ¤æ–­ç†ç”±**ï¼šæµ‹è¯•è¦†ç›–äº†æ ¸å¿ƒå‰ç¼€æ“ä½œçš„ä¸»è¦è·¯å¾„ä¸å¼‚å¸¸è¾“å…¥ï¼Œä¸”æˆæœ¬ä½ï¼Œä¸ä¼šå¼•å…¥é¢å¤–ä¾èµ–ï¼Œæœ‰åŠ©äºåç»­æ”¹åŠ¨çš„å›å½’é˜²æŠ¤ã€‚

---

## æµ‹è¯•æƒ…å†µ

### å•å…ƒæµ‹è¯•
- æ‰§è¡Œå‘½ä»¤ï¼š`gradlew.bat :domain:test --tests "com.empathy.ai.domain.util.IdentityPrefixHelperTest"`
- ç»“æœï¼šé€šè¿‡
- å¤‡æ³¨ï¼šç¼–è¯‘é˜¶æ®µå­˜åœ¨æ—¢æœ‰è­¦å‘Šï¼ˆAiResultTest/MinimizeErrorTest/PromptErrorTest/SystemPromptsTestï¼‰ï¼Œä¸æœ¬æ¬¡ä¿®æ”¹æ— ç›´æ¥å…³è”ã€‚

### é›†æˆæµ‹è¯•
- æœªæ‰§è¡Œï¼ˆæœ¬æ¬¡ä»…ä¿®æ”¹ UI ä¸å•æµ‹ï¼‰ã€‚

### å…¨é‡å›å½’
- æ‰§è¡Œå‘½ä»¤ï¼š`gradlew.bat test`
- ç»“æœï¼šå¤±è´¥
- å¤±è´¥åŸå› ï¼š`app:testDevUnitTest` è§£æä¾èµ–å¤±è´¥ï¼Œ`:data`/`:presentation` ç¼ºå°‘ `dev` æ„å»ºå˜ä½“ï¼ˆä»…æœ‰ debug/releaseï¼‰ã€‚

---

## æ„å»ºéªŒè¯
- [x] Debug æ„å»ºæˆåŠŸï¼ˆ`gradlew.bat installDebug` æ„å»ºé˜¶æ®µå®Œæˆï¼‰
- [x] Debug å®‰è£…æˆåŠŸï¼ˆè®¾å¤‡å·²è¿æ¥ï¼Œå®‰è£…åˆ° 2 å°è®¾å¤‡ï¼‰
- [ ] Release æ„å»ºæˆåŠŸï¼ˆæœªæ‰§è¡Œï¼‰
- [ ] æ— æ–°å¢ Lint è­¦å‘Šï¼ˆæœªæ‰§è¡Œï¼‰

---

## å·²çŸ¥é—®é¢˜ä¸é£é™©
1. äº‹å®æµ UI å˜æ›´æœªè¿›è¡Œäººå·¥éªŒæ”¶ï¼Œå®é™…è§†è§‰æ•ˆæœéœ€ç¡®è®¤ï¼ˆå·¦å³æ°”æ³¡ã€è¡Œæ•°æˆªæ–­ã€ å¤´éƒ¨ä¿¡æ¯ï¼‰ã€‚
2. æœ¬æ¬¡æœªè¿è¡Œ UI/ä»ªå™¨æµ‹è¯•ï¼Œæ°”æ³¡å¸ƒå±€åœ¨ä¸åŒå±å¹•å¯†åº¦ä¸Šçš„è¡¨ç°æœªéªŒè¯ã€‚
3. å…¨é‡å›å½’ `gradlew.bat test` å›  `dev` å˜ä½“ç¼ºå¤±å¤±è´¥ï¼Œéœ€è¦ç¡®è®¤æµ‹è¯•å˜ä½“æˆ–æ¨¡å—é…ç½®ã€‚
4. éƒ¨åˆ†æ—¢æœ‰å•å…ƒæµ‹è¯•å­˜åœ¨ç¼–è¯‘è­¦å‘Šï¼Œåç»­å¯é›†ä¸­æ¸…ç†ï¼Œä½†ä¸æœ¬æ¬¡ä¿®æ”¹æ— ç›´æ¥å…³ç³»ã€‚

---

## å»ºè®®
### åˆå¹¶å»ºè®®
ä»…ä¾›å‚è€ƒã€‚å»ºè®®åœ¨äººå·¥éªŒæ”¶äº‹å®æµå±•ç¤ºæ— å¼‚å¸¸åå†åˆå¹¶ã€‚

### æ”¹è¿›å»ºè®®
- å¦‚éœ€ç»Ÿä¸€äº‹å®æµä¸å…¶ä»–å¯¹è¯å±•ç¤ºï¼Œå¯è€ƒè™‘å°†å¡ç‰‡å¤´éƒ¨ï¼ˆæ—¶é—´ + æ€»ç»“çŠ¶æ€ï¼‰æŠ½ä¸ºå¯é…ç½®åŒºåŸŸã€‚
- åç»­å¯è¡¥å…… UI æµ‹è¯•ï¼Œè¦†ç›–å¯¹æ–¹/æˆ‘/æ—§æ•°æ®ä¸‰ç§æ¸²æŸ“åˆ†æ”¯ã€‚

### åç»­å·¥ä½œ
- æ‰§è¡Œä¸€æ¬¡æ‰‹åŠ¨éªŒæ”¶ï¼šäº‹å®æµå¡ç‰‡å†…æ˜¯å¦éšè—å‰ç¼€å¹¶å±•ç¤ºå·¦å³æ°”æ³¡ã€‚
- å¦‚éœ€æ›´å¼ºä¸€è‡´æ€§ï¼Œå¯ä¸º ConversationCard å¢åŠ å¯åˆ‡æ¢å¸ƒå±€é…ç½®ã€‚

---

## æ¢ç´¢æ—¥å¿—

| æ—¶é—´ | å·¥ä½œå†…å®¹ | çŠ¶æ€ |
|------|----------|------|
| 21:15 | è¯»å– PRD-00008 ä¸ç°æœ‰å®ç°ï¼Œè¯†åˆ«äº‹å®æµ UI ç¼ºå£ | âœ… |
| 21:22 | ConversationBubble æ”¯æŒéšè—å¤´éƒ¨ä¸è¡Œæ•°é™åˆ¶ | âœ… |
| 21:26 | ConversationCard æ”¹ç”¨æ°”æ³¡æ¸²æŸ“ | âœ… |
| 21:26 | æ–°å¢ IdentityPrefixHelperTest | âœ… |
| 21:31 | æ‰§è¡Œ `:domain:test`ï¼ˆæŒ‡å®šæµ‹è¯•ï¼‰ | âœ… |
| 10:21 | æ‰§è¡Œ `gradlew.bat installDebug`ï¼ˆæ— è®¾å¤‡ï¼Œå®‰è£…å¤±è´¥ï¼‰ | âŒ |
| 10:37 | é‡æ–°æ‰§è¡Œ `gradlew.bat installDebug`ï¼ˆæ— è®¾å¤‡ï¼Œå®‰è£…å¤±è´¥ï¼‰ | âŒ |
| 10:46 | æ‰§è¡Œ `gradlew.bat installDebug`ï¼ˆè®¾å¤‡å·²è¿æ¥ï¼Œå®‰è£…æˆåŠŸï¼‰ | âœ… |
