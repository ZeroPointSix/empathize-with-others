# PRD-00006 提示词编辑界面需求

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档编号 | PRD-00006 |
| 创建日期 | 2025-12-16 |
| 更新日期 | 2025-12-16 |
| 状态 | 草稿 |
| 关联文档 | PRD-00005-提示词管理系统需求 |

---

## 1. 背景与目标

### 1.1 背景

PRD-00005 定义了提示词管理系统的数据层和业务逻辑，但未包含UI界面设计。本文档专注于为"提示词编辑"功能设计一个符合产品整体调性的用户界面。

### 1.2 设计目标

为"提示词编辑"功能打造一个**极简、聚焦**且符合产品整体**温暖高级调性**的UI界面。

### 1.3 核心设计原则

| 原则 | 说明 |
|------|------|
| 极简主义 | 去除一切非必要的修饰和复杂交互元素，回归最纯粹的文本输入体验 |
| 情感化材质 | 沿用产品标志性设计语言：暖色调动态光晕背景 + 通透磨砂玻璃容器 |
| 聚焦体验 | 让用户专注于提示词内容本身，减少认知负担 |

---

## 2. 功能需求

### 2.1 MVP范围

#### ✅ 本次实现

1. **提示词编辑界面**
   - 全屏编辑模式
   - 纯文本输入（无复杂变量胶囊或锁定区域）
   - 字符计数和长度限制提示
   - 取消/完成操作

2. **视觉风格**
   - 暖色调动态光晕背景
   - 磨砂玻璃（Glassmorphism）卡片容器
   - 品牌色（暖金/橙色）高亮按钮

#### ❌ 不包含（后续版本）

- 变量插值可视化胶囊
- 提示词模板选择
- 历史版本对比
- 实时预览效果

---

## 3. 界面设计规范

### 3.1 整体结构

```
┌─────────────────────────────────────────────────────────┐
│                   动态光晕背景层                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │              磨砂玻璃卡片容器                      │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │  取消      编辑指令        完成          │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │                                         │   │   │
│  │  │                                         │   │   │
│  │  │         多行文本输入区域                  │   │   │
│  │  │                                         │   │   │
│  │  │                                         │   │   │
│  │  │                                         │   │   │
│  │  │                                         │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                              字符计数: 0/1000   │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 3.2 背景层设计

| 属性 | 规格 |
|------|------|
| 类型 | 动态光晕背景（复用现有 `EmotionalBackground` 组件） |
| 色调 | 暖色系（橙色、金色、琥珀色渐变） |
| 动画 | 缓慢流动的光晕效果，营造温暖氛围 |
| 模糊度 | 背景模糊 20dp |

### 3.3 磨砂玻璃卡片

| 属性 | 规格 |
|------|------|
| 组件 | 复用现有 `GlassmorphicCard` 组件 |
| 背景色 | `Color.White.copy(alpha = 0.15f)` |
| 模糊效果 | `BlurEffect(radiusX = 25f, radiusY = 25f)` |
| 圆角 | 24.dp |
| 边框 | 1.dp, `Color.White.copy(alpha = 0.3f)` |
| 内边距 | 水平 20.dp, 垂直 16.dp |
| 尺寸 | 宽度填满（左右边距 16.dp），高度自适应（最大占屏幕 85%） |

### 3.4 顶部导航栏

集成在磨砂玻璃卡片顶部，采用三栏布局：

| 位置 | 元素 | 样式 |
|------|------|------|
| 左侧 | "取消" 文字按钮 | 常规文字色，点击关闭编辑器 |
| 中间 | "编辑指令" 标题 | 加粗，居中显示 |
| 右侧 | "完成" 文字按钮 / 加载圈 | **品牌色（暖金/橙色）**，作为主要提交操作 |

**导航栏样式规格：**

```kotlin
// 取消按钮
Text(
    text = "取消",
    style = MaterialTheme.typography.bodyLarge,
    color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.8f)
)

// 标题
Text(
    text = "编辑指令",
    style = MaterialTheme.typography.titleMedium,
    fontWeight = FontWeight.SemiBold,
    color = MaterialTheme.colorScheme.onSurface
)

// 完成按钮 - 根据保存状态切换显示
if (isSaving) {
    CircularProgressIndicator(
        modifier = Modifier.size(20.dp),
        color = BrandWarmGold,
        strokeWidth = 2.dp
    )
} else {
    Text(
        text = "完成",
        style = MaterialTheme.typography.bodyLarge,
        fontWeight = FontWeight.SemiBold,
        color = if (canSave) BrandWarmGold else BrandWarmGold.copy(alpha = 0.4f)
    )
}
```

**保存状态说明：**

| 状态 | 右上角显示 | 可点击 |
|------|----------|--------|
| 正常可保存 | "完成"（品牌色） | ✅ |
| 字数超限 | "完成"（品牌色 40% 透明度） | ❌ |
| 保存中 | 小尺寸圆形加载圈（20dp） | ❌ |

### 3.5 核心输入区域

| 属性 | 规格 |
|------|------|
| 类型 | 多行文本输入框（`BasicTextField` 或 `OutlinedTextField`） |
| 背景 | 透明（融入磨砂玻璃卡片） |
| 边框 | 无边框，保持极简风格 |
| 占位符 | **动态占位符**（根据场景显示不同引导文案） |
| 占位符颜色 | `onSurface.copy(alpha = 0.4f)` |
| 文字样式 | `bodyLarge`，行高 1.6 |
| 光标颜色 | `BrandWarmGold`（品牌暖金色） |
| 选中手柄颜色 | `BrandWarmGold`（品牌暖金色） |
| 最小高度 | 200.dp |
| 最大高度 | 屏幕高度 60% |
| 滚动 | 内容超出时可垂直滚动 |

#### 3.5.1 动态占位符（Smart Placeholder）

根据当前编辑的场景显示不同的引导文案，帮助用户理解该场景的用途：

| 场景 | 占位符文案 |
|------|----------|
| ANALYZE（聊天分析） | "例如：请帮我分析她这句话的潜台词..." |
| CHECK（安全检查） | "例如：检查时要特别注意工作相关话题..." |
| EXTRACT（信息提取） | "例如：重点关注对方提到的兴趣爱好..." |
| SUMMARY（每日总结） | "例如：总结今天的对话亮点和需要注意的地方..." |
| 联系人自定义 | "例如：和她聊天时要注意避开前任话题..." |

**输入框样式规格：**

```kotlin
BasicTextField(
    value = promptText,
    onValueChange = { onPromptChange(it) },
    modifier = Modifier
        .fillMaxWidth()
        .heightIn(min = 200.dp, max = screenHeight * 0.6f)
        .verticalScroll(rememberScrollState()),
    textStyle = MaterialTheme.typography.bodyLarge.copy(
        lineHeight = 24.sp,
        color = MaterialTheme.colorScheme.onSurface
    ),
    // 🆕 品牌色光标和选中手柄
    cursorBrush = SolidColor(BrandWarmGold),
    decorationBox = { innerTextField ->
        Box {
            if (promptText.isEmpty()) {
                Text(
                    text = placeholderText,  // 动态占位符
                    style = MaterialTheme.typography.bodyLarge,
                    color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.4f)
                )
            }
            innerTextField()
        }
    }
)

// 🆕 在 Theme 中配置选中手柄颜色
CompositionLocalProvider(
    LocalTextSelectionColors provides TextSelectionColors(
        handleColor = BrandWarmGold,
        backgroundColor = BrandWarmGold.copy(alpha = 0.3f)
    )
) {
    // BasicTextField...
}
```

#### 3.5.2 占位符文案获取

```kotlin
fun getPlaceholderText(scene: PromptScene?, isContactPrompt: Boolean): String {
    if (isContactPrompt) {
        return "例如：和她聊天时要注意避开前任话题..."
    }
    return when (scene) {
        PromptScene.ANALYZE -> "例如：请帮我分析她这句话的潜台词..."
        PromptScene.CHECK -> "例如：检查时要特别注意工作相关话题..."
        PromptScene.EXTRACT -> "例如：重点关注对方提到的兴趣爱好..."
        PromptScene.SUMMARY -> "例如：总结今天的对话亮点和需要注意的地方..."
        null -> "在这里输入你的战术指令..."
    }
}
```

### 3.6 字符计数器

| 属性 | 规格 |
|------|------|
| 位置 | 输入区域下方，右对齐 |
| 格式 | "字符计数: {当前字数}/{最大字数}" |
| 正常状态 | `onSurface.copy(alpha = 0.5f)` |
| 警告状态 | 当字数 > 800 时，显示橙色 |
| 超限状态 | 当字数 > 1000 时，显示红色，禁用完成按钮 |

```kotlin
val charCountColor = when {
    promptText.length > 1000 -> Color.Red
    promptText.length > 800 -> BrandWarmOrange
    else -> MaterialTheme.colorScheme.onSurface.copy(alpha = 0.5f)
}

Text(
    text = "字符计数: ${promptText.length}/1000",
    style = MaterialTheme.typography.bodySmall,
    color = charCountColor,
    modifier = Modifier.align(Alignment.End)
)
```

### 3.7 键盘避让（IME Insets）[重要]

当键盘弹起时，必须确保界面正确响应，避免内容被遮挡。

| 要求 | 说明 |
|------|------|
| 监听 IME | 容器需监听 `WindowInsets.ime` |
| 底部 Padding | 键盘弹起时，底部 padding 自动增加 |
| 字符计数可见 | 确保"字符计数"始终悬浮在键盘上方，不被遮挡 |
| 光标跟随 | 输入框光标位置应自动滚动到可视区域 |

**实现规格：**

```kotlin
// 在 Activity 或 Screen 级别启用 IME 动画
WindowCompat.setDecorFitsSystemWindows(window, false)

// 卡片容器监听 IME Insets
Column(
    modifier = Modifier
        .fillMaxSize()
        .imePadding()  // 🆕 关键：自动响应键盘高度
        .navigationBarsPadding()
) {
    GlassmorphicCard(
        modifier = Modifier
            .fillMaxWidth()
            .weight(1f, fill = false)
    ) {
        // 导航栏
        TopBar(...)
        
        // 输入区域（可滚动）
        BasicTextField(
            modifier = Modifier
                .weight(1f)
                .verticalScroll(rememberScrollState())
                .bringIntoViewRequester(bringIntoViewRequester),  // 🆕 光标跟随
            ...
        )
        
        // 字符计数（始终在键盘上方）
        CharacterCounter(...)
    }
}
```

**光标自动滚动到可视区域：**

```kotlin
val bringIntoViewRequester = remember { BringIntoViewRequester() }
val coroutineScope = rememberCoroutineScope()

BasicTextField(
    modifier = Modifier.bringIntoViewRequester(bringIntoViewRequester),
    onValueChange = { newText ->
        onPromptChange(newText)
        // 确保光标位置可见
        coroutineScope.launch {
            bringIntoViewRequester.bringIntoView()
        }
    },
    ...
)
```

---

## 4. 交互设计

### 4.1 进入编辑器

| 入口 | 行为 |
|------|------|
| 设置 → 提示词管理 → 点击某场景 | 打开编辑器，加载该场景的当前提示词 |
| 联系人详情 → 提示词设置 | 打开编辑器，加载该联系人的自定义提示词 |

### 4.2 编辑操作

| 操作 | 行为 |
|------|------|
| 输入文字 | 实时更新字符计数 |
| 点击"取消" | 弹出确认对话框（如有修改），放弃修改并关闭 |
| 点击"完成" | 验证长度，保存提示词，关闭编辑器 |
| 返回键 | 等同于点击"取消" |

### 4.3 验证与反馈

| 场景 | 反馈 |
|------|------|
| 字数超过800 | 字符计数变为橙色警告 |
| 字数超过1000 | 字符计数变为红色，"完成"按钮置灰禁用 |
| 保存成功 | 显示 Toast "保存成功"，关闭编辑器 |
| 保存失败 | 显示 Toast "保存失败，请重试" |

### 4.4 取消确认对话框

当用户有未保存的修改时，点击"取消"或返回键：

```
┌─────────────────────────────────┐
│         放弃修改？               │
│                                 │
│   你有未保存的修改，确定要放弃吗？ │
│                                 │
│      [继续编辑]    [放弃]        │
└─────────────────────────────────┘
```

---

## 5. 技术实现要点

### 5.1 文件位置

```
presentation/
├── ui/screen/prompt/
│   ├── PromptEditorScreen.kt      # 提示词编辑界面
│   ├── PromptEditorUiState.kt     # UI状态
│   └── PromptEditorUiEvent.kt     # UI事件
├── viewmodel/
│   └── PromptEditorViewModel.kt   # ViewModel
```

### 5.2 复用现有组件

| 组件 | 路径 | 用途 |
|------|------|------|
| `EmotionalBackground` | `ui/component/emotion/` | 动态光晕背景 |
| `GlassmorphicCard` | `ui/component/emotion/` | 磨砂玻璃卡片 |

### 5.3 UiState 定义

```kotlin
data class PromptEditorUiState(
    val scene: PromptScene? = null,           // 当前编辑的场景
    val contactId: String? = null,            // 联系人ID（如果是联系人提示词）
    val originalPrompt: String = "",          // 原始提示词（用于检测修改）
    val currentPrompt: String = "",           // 当前编辑的提示词
    val isLoading: Boolean = false,           // 加载状态
    val isSaving: Boolean = false,            // 保存状态
    val hasUnsavedChanges: Boolean = false,   // 是否有未保存修改
    val showDiscardDialog: Boolean = false,   // 显示放弃修改对话框
    val errorMessage: String? = null          // 错误信息
) {
    val charCount: Int get() = currentPrompt.length
    val isOverLimit: Boolean get() = charCount > 1000
    val isNearLimit: Boolean get() = charCount > 800
    val canSave: Boolean get() = !isOverLimit && !isSaving
}
```

### 5.4 UiEvent 定义

```kotlin
sealed class PromptEditorUiEvent {
    data class UpdatePrompt(val text: String) : PromptEditorUiEvent()
    object SavePrompt : PromptEditorUiEvent()
    object CancelEdit : PromptEditorUiEvent()
    object ConfirmDiscard : PromptEditorUiEvent()
    object DismissDiscardDialog : PromptEditorUiEvent()
    object ClearError : PromptEditorUiEvent()
}
```

### 5.5 品牌色定义

在 `theme/Color.kt` 中添加：

```kotlin
// 品牌暖色系
val BrandWarmGold = Color(0xFFF5A623)      // 暖金色 - 主要操作按钮
val BrandWarmOrange = Color(0xFFFF9500)    // 暖橙色 - 警告状态
val BrandWarmAmber = Color(0xFFFFCC00)     // 琥珀色 - 辅助高亮
```

---

## 6. 视觉参考

### 6.1 设计风格关键词

- **Glassmorphism**（磨砂玻璃拟态）
- **Warm Gradient**（暖色渐变）
- **Minimal Input**（极简输入）
- **Soft Glow**（柔和光晕）

### 6.2 配色方案

| 元素 | 颜色 | 说明 |
|------|------|------|
| 背景光晕 | `#F5A623` → `#FF9500` → `#FFCC00` | 暖色渐变流动 |
| 卡片背景 | `rgba(255,255,255,0.15)` | 半透明白色 |
| 卡片边框 | `rgba(255,255,255,0.3)` | 微妙的白色边框 |
| 主文字 | `#1A1A1A` | 深色文字 |
| 次要文字 | `rgba(26,26,26,0.5)` | 半透明深色 |
| 品牌高亮 | `#F5A623` | 暖金色 |

---

## 7. 验收标准

### 7.1 功能验收

- [ ] 编辑器能正确加载当前提示词
- [ ] 文本输入流畅，无卡顿
- [ ] 字符计数实时更新
- [ ] 超限时"完成"按钮正确禁用
- [ ] 取消时正确弹出确认对话框（有修改时）
- [ ] 保存成功后正确关闭编辑器
- [ ] 保存失败时显示错误提示
- [ ] 动态占位符根据场景正确显示不同引导文案

### 7.2 视觉验收

- [ ] 背景光晕效果流畅自然
- [ ] 磨砂玻璃卡片通透感良好
- [ ] 品牌色应用正确
- [ ] 整体风格与产品调性一致
- [ ] 深色/浅色模式适配正确
- [ ] 光标颜色为品牌暖金色（非系统默认蓝色）
- [ ] 文本选中手柄颜色为品牌暖金色
- [ ] 保存中状态显示小尺寸圆形加载圈（替代"完成"文字）

### 7.3 交互验收

- [ ] 键盘弹出时界面正确调整（IME Insets 响应）
- [ ] 键盘弹起时"字符计数"始终悬浮在键盘上方，不被遮挡
- [ ] 输入时光标位置自动滚动到可视区域
- [ ] 长文本滚动流畅
- [ ] 触摸反馈及时
- [ ] 动画过渡自然
- [ ] 保存中状态下"完成"按钮不可重复点击

---

## 8. 相关文档

- [PRD-00005-提示词管理系统需求](PRD-00005-提示词管理系统需求.md)
- [FD-00004-联系人画像记忆系统UI功能设计](../FD/FD-00004-联系人画像记忆系统UI功能设计.md)（参考情感化设计）
