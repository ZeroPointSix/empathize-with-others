# PRD-00007 å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºéœ€æ±‚

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç¼–å· | PRD-00007 |
| åˆ›å»ºæ—¥æœŸ | 2025-12-16 |
| æ›´æ–°æ—¥æœŸ | 2025-12-16 |
| çŠ¶æ€ | è‰ç¨¿ |
| å…³è”æ–‡æ¡£ | PRD-00005ï¼ˆæç¤ºè¯ç®¡ç†ç³»ç»Ÿï¼‰ |

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 èƒŒæ™¯

å½“å‰AIåˆ†æåŠŸèƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **å¯¹è¯ç¼ºä¹è¿ç»­æ€§**ï¼šæ¯æ¬¡è°ƒç”¨AIåˆ†ææ—¶ï¼Œåªä¼ é€’å½“å‰å±å¹•æŠ“å–çš„èŠå¤©è®°å½•ï¼ŒAIæ— æ³•æ„ŸçŸ¥ä¹‹å‰çš„å¯¹è¯å†å²
2. **ä¸Šä¸‹æ–‡æ–­è£‚**ï¼šç”¨æˆ·å¯èƒ½åœ¨å¤šæ¬¡å¯¹è¯ä¸­è®¨è®ºåŒä¸€è¯é¢˜ï¼Œä½†AIæ¯æ¬¡éƒ½æ˜¯"ä»é›¶å¼€å§‹"åˆ†æ
3. **æ—¶æ•ˆæ€§ç¼ºå¤±**ï¼šæ²¡æœ‰åŒºåˆ†"åˆšåˆšå‘ç”Ÿçš„å¯¹è¯"å’Œ"å‡ å°æ—¶å‰çš„å¯¹è¯"ï¼ŒAIæ— æ³•æ„ŸçŸ¥æ—¶é—´æµé€å¸¦æ¥çš„æƒ…ç»ªå˜åŒ–

**æ ¸å¿ƒé—®é¢˜**ï¼šäººçš„å¯¹è¯æ˜¯è¿ç»­çš„ã€æ»šåŠ¨çš„ï¼Œè€Œå½“å‰AIåˆ†ææ˜¯å­¤ç«‹çš„ã€ç‰‡æ®µçš„ã€‚

### 1.2 ç›®æ ‡

æ„å»ºä¸€ä¸ªæ™ºèƒ½çš„å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§ç³»ç»Ÿï¼Œå®ç°ï¼š

1. **å¯¹è¯è®°å¿†**ï¼šè‡ªåŠ¨ä¿å­˜å¹¶å›é¡¾æœ€è¿‘çš„å¯¹è¯å†å²ï¼ˆå¯é…ç½®5æ¡/10æ¡ï¼‰
2. **æ—¶é—´æ„ŸçŸ¥**ï¼šé€šè¿‡"æ—¶é—´æµé€æ ‡è®°"è®©AIç†è§£å¯¹è¯çš„æ—¶é—´é—´éš”
3. **æƒ…ç»ªæ¨æ–­**ï¼šAIèƒ½ä»æ—¶é—´é—´éš”ä¸­æ¨æ–­å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå˜åŒ–ï¼ˆå¦‚é•¿æ—¶é—´æœªå›å¤å¯èƒ½å¯¼è‡´çš„æƒ…ç»ªå †ç§¯ï¼‰
4. **è‡ªç„¶é˜…è¯»**ï¼šæ¨¡æ‹Ÿäººç±»ç¿»çœ‹èŠå¤©è®°å½•çš„å¿ƒç†æ´»åŠ¨ï¼Œæ„å»ºæ›´è‡ªç„¶çš„ä¸Šä¸‹æ–‡ç»“æ„

---

## 2. æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 2.1 æ¨¡æ‹Ÿäººç±»é˜…è¯»èŠå¤©è®°å½•

æˆ‘ä»¬ç¿»çœ‹èŠå¤©è®°å½•æ—¶ï¼Œä¸ä¼šç»™æ¯å¥è¯æ‰“æ ‡ç­¾ï¼Œè€Œæ˜¯çœ‹**æ—¶é—´æˆ³å’Œç©ºéš™**ã€‚

é‡‡ç”¨"æ—¶é—´æµé€æ ‡è®° (Time Flow Markers)"ç­–ç•¥ï¼Œåœ¨æ¶ˆæ¯ä¹‹é—´æ’å…¥æ—¶é—´æ ‡è®°ï¼Œè€Œéä¿®æ”¹åŸå§‹æ¶ˆæ¯å†…å®¹ã€‚

### 2.2 æ—¶é—´æµé€æ ‡è®°ç­–ç•¥

| æ—¶é—´é—´éš” | ä¼šè¯çŠ¶æ€ | æ ‡è®°æ–¹å¼ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| < 10åˆ†é’Ÿ | Hot Sessionï¼ˆçƒ­å¯¹è¯ï¼‰ | æ— æ ‡è®° | ä¿æŒæµç•…ï¼Œè¿è´¯å¯¹è¯ |
| 10åˆ†é’Ÿ ~ 3å°æ—¶ | Warm Sessionï¼ˆæ¸©å¯¹è¯ï¼‰ | è½»æ ‡è®° | `--- (ç»è¿‡äº† 45 åˆ†é’Ÿ) ---` |
| > 3å°æ—¶ | Cold Sessionï¼ˆå†·å¯¹è¯ï¼‰ | å¼ºæ ‡è®° | `--- (è·ç¦»ä¸Šæ¬¡å¯¹è¯å·²è¿‡ 4 å°æ—¶ï¼Œæ³¨æ„æƒ…ç»ªå˜åŒ–) ---` |
| è·¨å¤© | New Dayï¼ˆæ–°çš„ä¸€å¤©ï¼‰ | æ—¥æœŸæ ‡è®° | `--- [2025-12-16] ---` |

### 2.3 ä¸ºä»€ä¹ˆè¿™æ ·æ›´å¥½ï¼Ÿ

1. **AIèƒ½è¯»æ‡‚"æ²‰é»˜"**ï¼šAIçœ‹åˆ°ä¸­é—´éš”äº†6å°æ—¶ï¼Œä¸”å¯¹æ–¹é—®"ä½ å¾ˆå¿™å—"ï¼Œç«‹åˆ»å°±èƒ½åˆ†æå‡ºå¯¹æ–¹å¯èƒ½è§‰å¾—è¢«å†·è½äº†
2. **èŠ‚çœTokenä¸”æ¸…æ™°**ï¼šä¸éœ€è¦ç»™æ¯æ¡éƒ½åŠ å°¾ç¼€ï¼Œåªåœ¨æ–­æ¡£å¤„åŠ æ ‡è®°
3. **ç¬¦åˆç›´è§‰**ï¼šè¿™æ›´åƒæˆ‘ä»¬ç¿»çœ‹å¾®ä¿¡èŠå¤©è®°å½•æ—¶çš„å¿ƒç†æ´»åŠ¨

---

## 3. åŠŸèƒ½éœ€æ±‚

### 3.1 å¯¹è¯å†å²å›é¡¾

#### 3.1.1 å†å²æ¡æ•°é…ç½®

| é…ç½®é¡¹ | é»˜è®¤å€¼ | å¯é€‰å€¼ | è¯´æ˜ |
|--------|--------|--------|------|
| å†å²å¯¹è¯æ¡æ•° | 5 | 0/5/10 | å‘é€ç»™AIçš„å†å²å¯¹è¯æ•°é‡ |

- **0æ¡**ï¼šä¸å‘é€å†å²ï¼Œæ¯æ¬¡åˆ†æç‹¬ç«‹ï¼ˆå½“å‰è¡Œä¸ºï¼‰
- **5æ¡**ï¼šå‘é€æœ€è¿‘5æ¡å¯¹è¯å†å²
- **10æ¡**ï¼šå‘é€æœ€è¿‘10æ¡å¯¹è¯å†å²

#### 3.1.2 å†å²å¯¹è¯æ¥æº

ä» `conversation_logs` è¡¨ä¸­è·å–æŒ‡å®šè”ç³»äººçš„æœ€è¿‘Næ¡å¯¹è¯è®°å½•ï¼ŒæŒ‰æ—¶é—´æˆ³æ­£åºæ’åˆ—ï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰ã€‚

### 3.2 æ—¶é—´æµé€æ ‡è®°

#### 3.2.1 æ—¶é—´é˜ˆå€¼é…ç½®

```kotlin
object ConversationContextConfig {
    const val HOT_SESSION_THRESHOLD = 10 * 60 * 1000L      // 10åˆ†é’Ÿï¼ˆæ¯«ç§’ï¼‰
    const val WARM_SESSION_THRESHOLD = 3 * 60 * 60 * 1000L // 3å°æ—¶ï¼ˆæ¯«ç§’ï¼‰
}
```

#### 3.2.2 æ ‡è®°ç”Ÿæˆè§„åˆ™

```
å½“å‰æ¶ˆæ¯æ—¶é—´ - ä¸Šä¸€æ¡æ¶ˆæ¯æ—¶é—´ = æ—¶é—´é—´éš”

if (è·¨å¤©) {
    æ’å…¥: --- [YYYY-MM-DD] ---
}
if (é—´éš” < 10åˆ†é’Ÿ) {
    ä¸æ’å…¥æ ‡è®°ï¼ˆHot Sessionï¼‰
} else if (é—´éš” < 3å°æ—¶) {
    æ’å…¥: --- (å¯¹è¯æš‚åœäº† X åˆ†é’Ÿ/å°æ—¶) ---
} else {
    æ’å…¥: --- (å¯¹è¯æš‚åœäº† X å°æ—¶ï¼Œæ³¨æ„å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå˜åŒ–) ---
}
```

> ğŸ’¡ **æ–‡æ¡ˆä¼˜åŒ–è¯´æ˜**ï¼šä½¿ç”¨"å¯¹è¯æš‚åœäº†"è€Œé"ç»è¿‡äº†"ï¼Œæ›´èƒ½æš—ç¤ºäº’åŠ¨çš„æ–­è£‚æ„Ÿï¼Œå¸®åŠ©AIæ›´å¥½åœ°ä»£å…¥"å†›å¸ˆ"è§’è‰²ã€‚

#### 3.2.3 æ—¶é—´æ ¼å¼åŒ–è§„åˆ™

| æ—¶é—´é—´éš” | æ˜¾ç¤ºæ ¼å¼ |
|---------|---------|
| 10-59åˆ†é’Ÿ | `X åˆ†é’Ÿ` |
| 1-2å°æ—¶ | `1 å°æ—¶` / `2 å°æ—¶` |
| 3å°æ—¶ä»¥ä¸Š | `X å°æ—¶` |
| è·¨å¤© | `[YYYY-MM-DD]` |

### 3.3 Tokenæº¢å‡ºä¿æŠ¤

#### 3.3.1 é—®é¢˜èƒŒæ™¯

è™½ç„¶é™åˆ¶äº†å†å²æ¡æ•°ï¼ˆæœ€å¤š10æ¡ï¼‰ï¼Œä½†å¦‚æœæ¯æ¡æ¶ˆæ¯éƒ½æ˜¯å‡ åƒå­—çš„"å°ä½œæ–‡"ï¼Œä¾ç„¶å¯èƒ½æ’‘çˆ†Tokené™åˆ¶ã€‚

#### 3.3.2 ä¿æŠ¤ç­–ç•¥

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| å•æ¡æ¶ˆæ¯æœ€å¤§å­—ç¬¦æ•° | 500 | è¶…è¿‡æ—¶æˆªæ–­å¹¶æ·»åŠ  `...` |
| å†å²ä¸Šä¸‹æ–‡æ€»å­—ç¬¦æ•° | 2000 | è¶…è¿‡æ—¶ä»æœ€æ—©çš„æ¶ˆæ¯å¼€å§‹ç§»é™¤ |

#### 3.3.3 æˆªæ–­è§„åˆ™

```kotlin
object HistoryContextConfig {
    const val MAX_SINGLE_MESSAGE_LENGTH = 500   // å•æ¡æ¶ˆæ¯æœ€å¤§å­—ç¬¦
    const val MAX_TOTAL_CONTEXT_LENGTH = 2000   // å†å²ä¸Šä¸‹æ–‡æ€»å­—ç¬¦
}
```

**æˆªæ–­ä¼˜å…ˆçº§**ï¼š
1. å…ˆæˆªæ–­å•æ¡è¿‡é•¿çš„æ¶ˆæ¯ï¼ˆä¿ç•™å‰500å­—ç¬¦ + `...`ï¼‰
2. å¦‚æœæ€»é•¿åº¦ä»è¶…é™ï¼Œä»æœ€æ—©çš„æ¶ˆæ¯å¼€å§‹ç§»é™¤
3. è‡³å°‘ä¿ç•™æœ€è¿‘1æ¡æ¶ˆæ¯ï¼ˆå³ä½¿è¶…é™ä¹Ÿä¸ç§»é™¤ï¼‰

#### 3.3.4 æˆªæ–­æç¤º

å½“å‘ç”Ÿæˆªæ–­æ—¶ï¼Œåœ¨ä¸Šä¸‹æ–‡ä¸­æ·»åŠ æç¤ºï¼š

```
ã€å†å²å¯¹è¯å›é¡¾ã€‘(æœ€è¿‘5æ¡ï¼Œéƒ¨åˆ†å†…å®¹å·²æˆªæ–­)
```

### 3.4 æ„å»ºåçš„ä¸Šä¸‹æ–‡ç¤ºä¾‹

**åœºæ™¯**ï¼šç”¨æˆ·æƒ³å›å¤æœ€åä¸€å¥"ä½ ä»Šå¤©ä¸€å¤©éƒ½å¾ˆå¿™å—ï¼Ÿ"

**AIçœ‹åˆ°çš„å†å²ä¸Šä¸‹æ–‡**ï¼ˆåŸºäºç®€åŒ–æ–¹æ¡ˆï¼‰ï¼š

```
ã€å†å²å¯¹è¯å›é¡¾ã€‘(æœ€è¿‘3æ¡)
[å†å²è®°å½• - 08:30]: 
å®ï¼Œæ—©å®‰
æ—©å‘€

--- (å¯¹è¯æš‚åœäº† 20 åˆ†é’Ÿ) ---

[å†å²è®°å½• - 08:55]:
æˆ‘å‡ºé—¨äº†
è·¯ä¸Šå°å¿ƒ

--- (å¯¹è¯æš‚åœäº† 6 å°æ—¶ï¼Œæ³¨æ„å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå˜åŒ–) ---

[å†å²è®°å½• - 15:00]:
ä½ ä»Šå¤©ä¸€å¤©éƒ½å¾ˆå¿™å—ï¼Ÿ

ã€å½“å‰èŠå¤©è®°å½•ã€‘
ï¼ˆç”¨æˆ·å½“å‰å±å¹•æŠ“å–çš„å†…å®¹ï¼‰
```

### 3.4 æ¶ˆæ¯å‘é€è€…æ ‡è¯†

#### 3.4.1 å½“å‰æ•°æ®å­˜å‚¨ç°çŠ¶

> âš ï¸ **é‡è¦è¯´æ˜**ï¼šå½“å‰ `conversation_logs` è¡¨åªå­˜å‚¨äº†ï¼š
> - `user_input`ï¼šç”¨æˆ·æäº¤ç»™AIåˆ†æçš„èŠå¤©è®°å½•ï¼ˆé€šå¸¸æ˜¯å±å¹•æŠ“å–çš„å†…å®¹ï¼‰
> - `ai_response`ï¼šAIçš„åˆ†æå›å¤
> 
> **å¹¶æœªå•ç‹¬å­˜å‚¨"å¯¹æ–¹çš„å›å¤å†…å®¹"**ã€‚

#### 3.4.2 MVPé˜¶æ®µçš„ç®€åŒ–æ–¹æ¡ˆ

é‰´äºå½“å‰æ•°æ®å­˜å‚¨ç°çŠ¶ï¼ŒMVPé˜¶æ®µé‡‡ç”¨ä»¥ä¸‹ç®€åŒ–æ–¹æ¡ˆï¼š

| æ•°æ®æ¥æº | å†…å®¹ | æ ‡è®°æ–¹å¼ |
|---------|------|---------|
| å†å²è®°å½• | `user_input`ï¼ˆç”¨æˆ·æäº¤çš„èŠå¤©è®°å½•ï¼‰ | `[å†å²è®°å½•]` |
| å½“å‰å±å¹• | å®æ—¶å±å¹•æŠ“å–çš„å†…å®¹ | `[å½“å‰å¯¹è¯]` |

**è®¾è®¡ç†ç”±**ï¼š
- å†å²è®°å½•ä¸­çš„ `user_input` å®é™…ä¸ŠåŒ…å«äº†ç”¨æˆ·å½“æ—¶æäº¤çš„å®Œæ•´èŠå¤©ä¸Šä¸‹æ–‡ï¼ˆå¯èƒ½åŒ…å«åŒæ–¹å¯¹è¯ï¼‰
- è¿™ä¾ç„¶æœ‰ä»·å€¼ï¼šAIçŸ¥é“ç”¨æˆ·ä¹‹å‰å…³æ³¨äº†å“ªäº›å¯¹è¯å†…å®¹
- é¿å…å¯¹ç°æœ‰æ•°æ®ç»“æ„åšå¤§æ”¹åŠ¨

#### 3.4.3 æ¶ˆæ¯æ ¼å¼

```
[å†å²è®°å½• - HH:mm]: ç”¨æˆ·æäº¤çš„èŠå¤©å†…å®¹
```

ç¤ºä¾‹ï¼š
```
ã€å†å²å¯¹è¯å›é¡¾ã€‘(æœ€è¿‘3æ¡)
[å†å²è®°å½• - 08:30]: 
å®ï¼Œæ—©å®‰
æ—©å‘€

--- (å¯¹è¯æš‚åœäº† 20 åˆ†é’Ÿ) ---

[å†å²è®°å½• - 08:55]:
æˆ‘å‡ºé—¨äº†
è·¯ä¸Šå°å¿ƒ

--- (å¯¹è¯æš‚åœäº† 6 å°æ—¶ï¼Œæ³¨æ„å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå˜åŒ–) ---

[å†å²è®°å½• - 15:00]:
ä½ ä»Šå¤©ä¸€å¤©éƒ½å¾ˆå¿™å—ï¼Ÿ
```

#### 3.4.4 åç»­ä¼˜åŒ–æ–¹å‘ï¼ˆéMVPï¼‰

å¦‚éœ€æ›´ç²¾ç¡®çš„å‘é€è€…è¯†åˆ«ï¼Œåç»­ç‰ˆæœ¬å¯è€ƒè™‘ï¼š
1. åœ¨å±å¹•æŠ“å–æ—¶è§£æå¹¶æ ‡è®°å‘é€è€…
2. æ–°å¢å­—æ®µå­˜å‚¨ç»“æ„åŒ–çš„å¯¹è¯å†…å®¹ï¼ˆJSONæ ¼å¼ï¼‰
3. ä½¿ç”¨AIè¾…åŠ©è¯†åˆ«æ¶ˆæ¯å‘é€è€…

---

## 4. æ•°æ®ç»“æ„è®¾è®¡

### 4.1 å†å²å¯¹è¯è®°å½•æ¨¡å‹

> ğŸ’¡ **MVPç®€åŒ–**ï¼šç›´æ¥å¤ç”¨ç°æœ‰çš„ `ConversationLog` æ¨¡å‹ï¼Œæ— éœ€æ–°å¢æ•°æ®ç»“æ„ã€‚

```kotlin
/**
 * å¯¹è¯è®°å½•é¢†åŸŸæ¨¡å‹ï¼ˆå·²å­˜åœ¨ï¼‰
 *
 * ç›´æ¥ä½¿ç”¨ç°æœ‰æ¨¡å‹ï¼ŒåŒ…å«ï¼š
 * - userInput: ç”¨æˆ·æäº¤çš„èŠå¤©è®°å½•ï¼ˆå¯èƒ½åŒ…å«åŒæ–¹å¯¹è¯ï¼‰
 * - timestamp: è®°å½•æ—¶é—´
 * - aiResponse: AIçš„åˆ†æå›å¤
 */
data class ConversationLog(
    val id: Long,
    val contactId: String,
    val userInput: String,      // ç”¨æˆ·æäº¤çš„å®Œæ•´èŠå¤©ä¸Šä¸‹æ–‡
    val aiResponse: String?,
    val timestamp: Long,
    val isSummarized: Boolean
)
```

### 4.2 ä¸Šä¸‹æ–‡é…ç½®æ¨¡å‹

```kotlin
/**
 * å¯¹è¯ä¸Šä¸‹æ–‡é…ç½®
 */
data class ConversationContextConfig(
    val historyCount: Int = 5,                           // å†å²å¯¹è¯æ¡æ•°
    val hotSessionThreshold: Long = 10 * 60 * 1000L,     // çƒ­å¯¹è¯é˜ˆå€¼ï¼ˆ10åˆ†é’Ÿï¼‰
    val warmSessionThreshold: Long = 3 * 60 * 60 * 1000L, // æ¸©å¯¹è¯é˜ˆå€¼ï¼ˆ3å°æ—¶ï¼‰
    val maxSingleMessageLength: Int = 500,               // å•æ¡æ¶ˆæ¯æœ€å¤§å­—ç¬¦
    val maxTotalContextLength: Int = 2000                // å†å²ä¸Šä¸‹æ–‡æ€»å­—ç¬¦
)
```

### 4.3 æ—¶é—´æ ‡è®°æ¨¡å‹

```kotlin
/**
 * æ—¶é—´æµé€æ ‡è®°ç±»å‹
 */
sealed class TimeFlowMarker {
    data class DateChange(val date: String) : TimeFlowMarker()
    data class ShortGap(val minutes: Int) : TimeFlowMarker()
    data class LongGap(val hours: Int) : TimeFlowMarker()
    object None : TimeFlowMarker()
}
```

---

## 5. æŠ€æœ¯å®ç°è¦ç‚¹

### 5.1 ConversationContextBuilder

æ–°å¢å·¥å…·ç±»ï¼Œä¸“é—¨è´Ÿè´£æ„å»ºå¸¦æ—¶é—´æµé€æ ‡è®°çš„å¯¹è¯ä¸Šä¸‹æ–‡ï¼š

```kotlin
@Singleton
class ConversationContextBuilder @Inject constructor() {

    /**
     * æ„å»ºå¸¦æ—¶é—´æµé€æ ‡è®°çš„å¯¹è¯å†å²
     *
     * @param messages æŒ‰æ—¶é—´æ­£åºæ’åˆ—çš„æ¶ˆæ¯åˆ—è¡¨
     * @param config ä¸Šä¸‹æ–‡é…ç½®
     * @return æ ¼å¼åŒ–åçš„å¯¹è¯å†å²å­—ç¬¦ä¸²
     */
    fun buildHistoryContext(
        messages: List<TimestampedMessage>,
        config: ConversationContextConfig = ConversationContextConfig()
    ): String {
        if (messages.isEmpty()) return ""
        
        return buildString {
            appendLine("ã€å†å²å¯¹è¯ã€‘(æœ€è¿‘${messages.size}æ¡)")
            
            var previousTimestamp: Long? = null
            var previousDate: String? = null
            
            messages.forEach { message ->
                // è®¡ç®—æ—¶é—´æ ‡è®°
                val marker = calculateTimeMarker(
                    previousTimestamp, 
                    message.timestamp,
                    previousDate,
                    config
                )
                
                // æ’å…¥æ—¶é—´æ ‡è®°
                when (marker) {
                    is TimeFlowMarker.DateChange -> {
                        appendLine("--- [${marker.date}] ---")
                    }
                    is TimeFlowMarker.ShortGap -> {
                        appendLine("--- (ç»è¿‡äº† ${formatDuration(marker.minutes)} ) ---")
                    }
                    is TimeFlowMarker.LongGap -> {
                        appendLine("--- (è·ç¦»ä¸Šæ¬¡å¯¹è¯å·²è¿‡ ${marker.hours} å°æ—¶ï¼Œæ³¨æ„æƒ…ç»ªå˜åŒ–) ---")
                    }
                    TimeFlowMarker.None -> { /* ä¸æ’å…¥æ ‡è®° */ }
                }
                
                // æ·»åŠ æ¶ˆæ¯
                val timeStr = formatTime(message.timestamp)
                appendLine("${message.sender.prefix}: ${message.content} ($timeStr)")
                
                previousTimestamp = message.timestamp
                previousDate = formatDate(message.timestamp)
            }
        }
    }
    
    private fun calculateTimeMarker(
        previousTimestamp: Long?,
        currentTimestamp: Long,
        previousDate: String?,
        config: ConversationContextConfig
    ): TimeFlowMarker {
        if (previousTimestamp == null) return TimeFlowMarker.None
        
        val currentDate = formatDate(currentTimestamp)
        
        // æ£€æŸ¥æ˜¯å¦è·¨å¤©
        if (previousDate != null && previousDate != currentDate) {
            return TimeFlowMarker.DateChange(currentDate)
        }
        
        val gap = currentTimestamp - previousTimestamp
        
        return when {
            gap < config.hotSessionThreshold -> TimeFlowMarker.None
            gap < config.warmSessionThreshold -> {
                val minutes = (gap / (60 * 1000)).toInt()
                TimeFlowMarker.ShortGap(minutes)
            }
            else -> {
                val hours = (gap / (60 * 60 * 1000)).toInt()
                TimeFlowMarker.LongGap(hours)
            }
        }
    }
    
    private fun formatDuration(minutes: Int): String {
        return if (minutes >= 60) {
            "${minutes / 60} å°æ—¶"
        } else {
            "$minutes åˆ†é’Ÿ"
        }
    }
    
    private fun formatTime(timestamp: Long): String {
        // è¿”å› HH:mm æ ¼å¼
    }
    
    private fun formatDate(timestamp: Long): String {
        // è¿”å› yyyy-MM-dd æ ¼å¼
    }
}
```

### 5.2 ConversationRepository æ‰©å±•

æ–°å¢æ–¹æ³•è·å–æœ€è¿‘Næ¡å¯¹è¯ï¼š

```kotlin
interface ConversationRepository {
    // ... ç°æœ‰æ–¹æ³• ...
    
    /**
     * è·å–æŒ‡å®šè”ç³»äººçš„æœ€è¿‘Næ¡å¯¹è¯è®°å½•
     *
     * @param contactId è”ç³»äººID
     * @param limit æœ€å¤§æ¡æ•°
     * @return æŒ‰æ—¶é—´æ­£åºæ’åˆ—çš„å¯¹è¯è®°å½•
     */
    suspend fun getRecentConversations(
        contactId: String, 
        limit: Int
    ): Result<List<ConversationLog>>
}
```

### 5.3 AnalyzeChatUseCase é›†æˆ

ä¿®æ”¹ `AnalyzeChatUseCase`ï¼Œåœ¨æ„å»ºä¸Šä¸‹æ–‡æ—¶åŠ å…¥å†å²å¯¹è¯ï¼š

```kotlin
class AnalyzeChatUseCase @Inject constructor(
    // ... ç°æœ‰ä¾èµ– ...
    private val conversationContextBuilder: ConversationContextBuilder
) {
    suspend operator fun invoke(
        contactId: String,
        rawScreenContext: List<String>
    ): Result<AnalysisResult> {
        // ... ç°æœ‰é€»è¾‘ ...
        
        // è·å–å†å²å¯¹è¯
        val historyCount = settingsRepository.getHistoryConversationCount()
            .getOrDefault(5)
        
        val historyContext = if (historyCount > 0) {
            val recentLogs = conversationRepository
                .getRecentConversations(contactId, historyCount)
                .getOrDefault(emptyList())
            
            val messages = recentLogs.map { log ->
                TimestampedMessage(
                    content = log.userInput,
                    timestamp = log.timestamp,
                    sender = MessageSender.USER
                )
            }
            
            conversationContextBuilder.buildHistoryContext(messages)
        } else {
            ""
        }
        
        // å°†å†å²ä¸Šä¸‹æ–‡åŠ å…¥Prompt
        val runtimeData = buildContextData(
            targetGoal = profile.targetGoal,
            facts = profile.facts,
            redTags = redTags,
            greenTags = greenTags,
            conversationHistory = maskedContext,
            historyContext = historyContext  // æ–°å¢
        )
        
        // ... åç»­é€»è¾‘ ...
    }
}
```

### 5.4 è®¾ç½®é¡¹å­˜å‚¨

åœ¨ `SettingsRepository` ä¸­æ–°å¢é…ç½®é¡¹ï¼š

```kotlin
interface SettingsRepository {
    // ... ç°æœ‰æ–¹æ³• ...
    
    /**
     * è·å–å†å²å¯¹è¯æ¡æ•°é…ç½®
     * @return 0/5/10
     */
    suspend fun getHistoryConversationCount(): Result<Int>
    
    /**
     * è®¾ç½®å†å²å¯¹è¯æ¡æ•°
     */
    suspend fun setHistoryConversationCount(count: Int): Result<Unit>
}
```

---

## 6. ç”¨æˆ·ç•Œé¢éœ€æ±‚

### 6.1 è®¾ç½®é¡µé¢

åœ¨è®¾ç½®é¡µé¢çš„"AIé…ç½®"åŒºåŸŸæ–°å¢é€‰é¡¹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI é…ç½®                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é»˜è®¤æœåŠ¡å•†          DeepSeek    >   â”‚
â”‚ æç¤ºè¯ç®¡ç†                      >   â”‚
â”‚ å†å²å¯¹è¯æ¡æ•°        5æ¡         â–¼   â”‚
â”‚   â”œâ”€ ä¸å‘é€å†å² (0æ¡)               â”‚
â”‚   â”œâ”€ æœ€è¿‘5æ¡ âœ“                      â”‚
â”‚   â””â”€ æœ€è¿‘10æ¡                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 é…ç½®è¯´æ˜

| é€‰é¡¹ | è¯´æ˜ |
|------|------|
| ä¸å‘é€å†å² | æ¯æ¬¡åˆ†æç‹¬ç«‹ï¼Œä¸åŒ…å«å†å²å¯¹è¯ |
| æœ€è¿‘5æ¡ | å‘é€æœ€è¿‘5æ¡å¯¹è¯å†å²ï¼Œå¹³è¡¡ä¸Šä¸‹æ–‡å’ŒTokenæ¶ˆè€— |
| æœ€è¿‘10æ¡ | å‘é€æœ€è¿‘10æ¡å¯¹è¯å†å²ï¼Œæ›´å®Œæ•´çš„ä¸Šä¸‹æ–‡ |

---

## 7. éåŠŸèƒ½éœ€æ±‚

### 7.1 æ€§èƒ½è¦æ±‚

- å†å²å¯¹è¯æŸ¥è¯¢æ—¶é—´ < 50ms
- ä¸Šä¸‹æ–‡æ„å»ºæ—¶é—´ < 10ms
- ä¸æ˜¾è‘—å¢åŠ AIè°ƒç”¨çš„Tokenæ¶ˆè€—ï¼ˆé¢„è®¡å¢åŠ 5-15%ï¼‰

### 7.2 å­˜å‚¨è¦æ±‚

- å¤ç”¨ç°æœ‰ `conversation_logs` è¡¨ï¼Œæ— éœ€æ–°å¢è¡¨
- æ— éœ€æ•°æ®åº“è¿ç§»

### 7.3 å…¼å®¹æ€§è¦æ±‚

- å‘åå…¼å®¹ï¼šé»˜è®¤é…ç½®ä¸º5æ¡ï¼Œä¸å½±å“ç°æœ‰ç”¨æˆ·ä½“éªŒ
- é…ç½®æŒä¹…åŒ–ï¼šä½¿ç”¨SharedPreferenceså­˜å‚¨

---

## 8. ä¸åŒ…å«çš„åŠŸèƒ½ï¼ˆåç»­ç‰ˆæœ¬ï¼‰

- [ ] è‡ªåŠ¨è¯†åˆ«æ¶ˆæ¯å‘é€è€…ï¼ˆå½“å‰éœ€è¦æ‰‹åŠ¨æ ‡è®°æˆ–ä»å±å¹•æŠ“å–æ¨æ–­ï¼‰
- [ ] å¯¹è¯ä¸»é¢˜è‡ªåŠ¨åˆ†å‰²
- [ ] å†å²å¯¹è¯çš„æ™ºèƒ½ç­›é€‰ï¼ˆå¦‚åªé€‰æ‹©ç›¸å…³è¯é¢˜ï¼‰
- [ ] å¯¹è¯æƒ…ç»ªè¶‹åŠ¿åˆ†æå›¾è¡¨
- [ ] å†å²å¯¹è¯çš„æœ¬åœ°æœç´¢åŠŸèƒ½

---

## 9. éªŒæ”¶æ ‡å‡†

### 9.1 åŠŸèƒ½éªŒæ”¶

- [ ] å†å²å¯¹è¯æ¡æ•°é…ç½®å¯æ­£å¸¸ä¿å­˜å’Œè¯»å–
- [ ] æ—¶é—´æµé€æ ‡è®°æŒ‰è§„åˆ™æ­£ç¡®ç”Ÿæˆ
- [ ] è·¨å¤©æ ‡è®°æ­£ç¡®æ˜¾ç¤ºæ—¥æœŸ
- [ ] çƒ­å¯¹è¯ï¼ˆ<10åˆ†é’Ÿï¼‰ä¸æ’å…¥æ ‡è®°
- [ ] æ¸©å¯¹è¯ï¼ˆ10åˆ†é’Ÿ~3å°æ—¶ï¼‰æ’å…¥è½»æ ‡è®°ï¼ˆ"å¯¹è¯æš‚åœäº†Xåˆ†é’Ÿ"ï¼‰
- [ ] å†·å¯¹è¯ï¼ˆ>3å°æ—¶ï¼‰æ’å…¥å¼ºæ ‡è®°å¹¶æç¤ºæƒ…ç»ªå˜åŒ–
- [ ] AIåˆ†ææ—¶æ­£ç¡®åŒ…å«å†å²ä¸Šä¸‹æ–‡
- [ ] è®¾ç½®ä¸º0æ¡æ—¶ä¸å‘é€å†å²
- [ ] å•æ¡æ¶ˆæ¯è¶…è¿‡500å­—ç¬¦æ—¶æ­£ç¡®æˆªæ–­
- [ ] æ€»ä¸Šä¸‹æ–‡è¶…è¿‡2000å­—ç¬¦æ—¶æ­£ç¡®ç§»é™¤æ—©æœŸæ¶ˆæ¯
- [ ] æˆªæ–­æ—¶æ˜¾ç¤ºæç¤ºä¿¡æ¯

### 9.2 æ€§èƒ½éªŒæ”¶

- [ ] å†å²å¯¹è¯æŸ¥è¯¢æ—¶é—´ < 50ms
- [ ] ä¸Šä¸‹æ–‡æ„å»ºæ—¶é—´ < 10ms
- [ ] Tokenæ¶ˆè€—å¢åŠ åœ¨å¯æ¥å—èŒƒå›´å†…

### 9.3 ç”¨æˆ·ä½“éªŒéªŒæ”¶

- [ ] è®¾ç½®é¡µé¢é€‰é¡¹æ¸…æ™°æ˜“æ‡‚
- [ ] AIåˆ†æç»“æœä½“ç°äº†å¯¹å†å²å¯¹è¯çš„ç†è§£
- [ ] AIèƒ½æ­£ç¡®æ¨æ–­æ—¶é—´é—´éš”å¸¦æ¥çš„æƒ…ç»ªå˜åŒ–

---

## 10. é£é™©è¯„ä¼°

| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|-----|------|---------|
| Tokenæ¶ˆè€—å¢åŠ  | ä½ | é™åˆ¶æœ€å¤š10æ¡ï¼Œæ—¶é—´æ ‡è®°ç®€æ´ |
| å†å²å¯¹è¯è¿‡å¤šå¯¼è‡´ä¸Šä¸‹æ–‡è¿‡é•¿ | ä½ | ç¡¬æ€§é™åˆ¶æ¡æ•°ï¼Œå¯é…ç½® |
| å•æ¡æ¶ˆæ¯è¿‡é•¿æ’‘çˆ†Token | ä¸­ | å•æ¡500å­—ç¬¦é™åˆ¶ + æ€»é‡2000å­—ç¬¦é™åˆ¶ |
| æ¶ˆæ¯å‘é€è€…è¯†åˆ«ä¸å‡†ç¡® | ä¸­ | MVPé‡‡ç”¨ç®€åŒ–æ–¹æ¡ˆï¼Œä¸åŒºåˆ†å‘é€è€…ï¼Œåç»­ä¼˜åŒ– |
| æ—¶é—´æ ‡è®°å¹²æ‰°AIç†è§£ | ä½ | ä½¿ç”¨"å¯¹è¯æš‚åœäº†"ç­‰è‡ªç„¶è¯­è¨€è¡¨è¿° |
| å†å²è®°å½•åªæœ‰ç”¨æˆ·ä¾§æ•°æ® | ä½ | æ˜ç¡®è¯´æ˜ï¼Œå†å²è®°å½•æ˜¯ç”¨æˆ·æäº¤çš„å®Œæ•´èŠå¤©ä¸Šä¸‹æ–‡ |

---

## 11. å®ç°è®¡åˆ’

### é˜¶æ®µ1ï¼šé¢†åŸŸå±‚æ‰©å±•ï¼ˆé¢„è®¡1å¤©ï¼‰
1. æ–°å¢ `TimestampedMessage` æ¨¡å‹
2. æ–°å¢ `ConversationContextBuilder` å·¥å…·ç±»
3. æ–°å¢ `TimeFlowMarker` å¯†å°ç±»
4. æ‰©å±• `ConversationRepository` æ¥å£

### é˜¶æ®µ2ï¼šæ•°æ®å±‚é€‚é…ï¼ˆé¢„è®¡0.5å¤©ï¼‰
1. æ‰©å±• `ConversationLogDao`ï¼Œæ·»åŠ è·å–æœ€è¿‘Næ¡çš„æŸ¥è¯¢
2. å®ç° `ConversationRepositoryImpl` æ–°æ–¹æ³•

### é˜¶æ®µ3ï¼šä¸šåŠ¡å±‚é›†æˆï¼ˆé¢„è®¡0.5å¤©ï¼‰
1. ä¿®æ”¹ `AnalyzeChatUseCase`ï¼Œé›†æˆå†å²ä¸Šä¸‹æ–‡
2. ä¿®æ”¹ `ContextBuilder`ï¼Œæ”¯æŒå†å²å¯¹è¯åŒºå—

### é˜¶æ®µ4ï¼šè®¾ç½®å±‚å®ç°ï¼ˆé¢„è®¡0.5å¤©ï¼‰
1. æ‰©å±• `SettingsRepository`ï¼Œæ·»åŠ å†å²æ¡æ•°é…ç½®
2. ä¿®æ”¹è®¾ç½®é¡µé¢UIï¼Œæ·»åŠ é…ç½®é€‰é¡¹

### é˜¶æ®µ5ï¼šæµ‹è¯•ï¼ˆé¢„è®¡1å¤©ï¼‰
1. å•å…ƒæµ‹è¯•ï¼šConversationContextBuilder
2. å•å…ƒæµ‹è¯•ï¼šæ—¶é—´æ ‡è®°ç”Ÿæˆé€»è¾‘
3. é›†æˆæµ‹è¯•ï¼šå®Œæ•´æµç¨‹éªŒè¯

**æ€»é¢„è®¡å·¥ä½œé‡**ï¼š3.5å¤©

---

## 12. ç›¸å…³æ–‡æ¡£

- [PRD-00005-æç¤ºè¯ç®¡ç†ç³»ç»Ÿéœ€æ±‚](./PRD-00005-æç¤ºè¯ç®¡ç†ç³»ç»Ÿéœ€æ±‚.md)
- [ContextBuilder.kt](../../../app/src/main/java/com/empathy/ai/domain/util/ContextBuilder.kt)
- [ConversationRepository.kt](../../../app/src/main/java/com/empathy/ai/domain/repository/ConversationRepository.kt)
- [AnalyzeChatUseCase.kt](../../../app/src/main/java/com/empathy/ai/domain/usecase/AnalyzeChatUseCase.kt)
