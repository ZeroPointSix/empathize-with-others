# PRD-00009-悬浮窗功能重构需求

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | PRD (Product Requirements Document) |
| 文档编号 | PRD-00009 |
| 功能名称 | 悬浮窗功能重构 |
| 版本 | 1.0 |
| 创建日期 | 2025-12-17 |
| 作者 | Kiro |
| 审核人 | 待定 |
| 关联文档 | PRD-00001-悬浮窗功能需求 |

## 2. 产品概述

### 2.1 重构背景

当前悬浮窗功能已实现基础的"帮我分析"和"帮我检查"功能，但存在以下问题：
1. 功能定位不够清晰，"帮我检查"与"帮我润色"概念重叠
2. 缺少"帮我回复"功能，用户需要自己根据分析结果编写回复
3. 用户对AI结果不满意时，需要重新走完整流程
4. 最小化后状态丢失，用户体验不连贯
5. 联系人选择每次都需要重新选择

### 2.2 重构目标

1. **功能整合**：将三大核心功能（分析、润色、回复）统一到一个界面
2. **体验优化**：支持状态保持、联系人记忆、微调重新生成
3. **交互简化**：通过Tab切换替代多级菜单，减少操作步骤

### 2.3 目标用户

- **主要用户**: 频繁进行社交沟通的用户
- **使用场景**: 在微信、QQ等聊天应用中需要AI辅助

## 3. 功能需求

### 3.1 核心功能（三大功能）

#### 3.1.1 帮我分析 (P0)

**功能描述**: 分析对方发来的消息，理解情绪、意图和潜台词

**输入**: 对方说的话（系统自动添加`【对方说】`前缀）

**输出**: 
- 情绪分析（对方此刻的情绪状态）
- 意图解读（对方的真实意图和潜台词）
- 风险预警（是否有坑、废物测试等）
- 策略建议（应该如何应对）

**验收标准**:
- [ ] 用户选择"帮我分析"Tab后输入内容
- [ ] 系统自动为内容添加`【对方说】`身份前缀
- [ ] AI返回结构化的分析结果
- [ ] 分析结果包含风险等级（SAFE/WARNING/DANGER）
- [ ] 处理时间控制在10秒内

#### 3.1.2 帮我润色 (P0)

**功能描述**: 优化用户写好的草稿，使表达更得体（内含风险检查）

**输入**: 我要说的话（系统自动添加`【我正在回复】`前缀）

**输出**: 
- 优化后的文本（可直接复制使用）
- 如有风险，附带风险提示

**验收标准**:
- [ ] 用户选择"帮我润色"Tab后输入草稿
- [ ] 系统自动为内容添加`【我正在回复】`身份前缀
- [ ] AI返回优化后的文本，可直接复制
- [ ] 如检测到雷区词汇，同时返回风险提示
- [ ] 处理时间控制在10秒内

#### 3.1.3 帮我回复 (P0)

**功能描述**: 根据对方的话，直接生成合适的回复

**输入**: 对方说的话（系统自动添加`【对方说】`前缀）

**输出**: 
- 建议的回复内容（可直接复制使用）
- 简要的策略说明（为什么这样回复）

**验收标准**:
- [ ] 用户选择"帮我回复"Tab后输入对方的话
- [ ] 系统自动为内容添加`【对方说】`身份前缀
- [ ] AI返回可直接使用的回复内容
- [ ] 回复内容符合联系人画像中的策略标签
- [ ] 处理时间控制在10秒内

### 3.2 交互优化功能

#### 3.2.1 Tab切换 (P0)

**功能描述**: 输入框上方提供三个Tab，用户通过切换Tab选择功能

**验收标准**:
- [ ] 显示三个Tab：🔍帮我分析 | ✍️帮我润色 | 💬帮我回复
- [ ] Tab切换时保留输入框内容（不清空）
- [ ] 记住上次选中的Tab，下次打开时默认选中
- [ ] Tab切换动画流畅，时长150ms

#### 3.2.2 状态保持 (P0)

**功能描述**: 最小化时保存完整状态，恢复时还原

**需要保存的状态**:
- 当前选中的Tab
- 输入框中的内容
- 选中的联系人
- AI返回的结果（如果有）

**验收标准**:
- [ ] 点击最小化按钮时保存所有状态
- [ ] 点击最小化指示器时恢复所有状态
- [ ] 点击关闭按钮时清空所有状态
- [ ] 状态保存到SharedPreferences，应用重启后可恢复

#### 3.2.3 联系人记忆 (P1)

**功能描述**: 默认选中上次对话的联系人

**验收标准**:
- [ ] 记录每次成功发送请求时的联系人ID
- [ ] 下次打开悬浮窗时，默认选中该联系人
- [ ] 如果该联系人已删除，则选中列表第一个
- [ ] 联系人ID保存到SharedPreferences

#### 3.2.4 微调重新生成 (P0)

**功能描述**: 用户对AI结果不满意时，可以重新生成或微调方向

**交互流程**:
1. 用户点击结果页的"🔄重新生成"按钮
2. 弹出对话框询问："需要调整方向吗？"
3. 用户可以：
   - 输入微调指令（如"强硬一点"、"幽默一点"）→ 点击"按方向生成"
   - 不输入任何内容 → 点击"直接重新生成"

**验收标准**:
- [ ] 结果页显示"🔄重新生成"按钮
- [ ] 点击后弹出微调对话框
- [ ] 对话框包含输入框和两个按钮
- [ ] "直接重新生成"：使用原始输入重新调用AI
- [ ] "按方向生成"：将微调指令和原始结果一起发送给AI
- [ ] 微调后的结果替换原结果

### 3.3 后端接口需求

#### 3.3.1 ActionType扩展

**当前状态**:
```kotlin
enum class ActionType {
    ANALYZE,  // 帮我分析
    CHECK     // 帮我检查（将废弃）
}
```

**重构后**:
```kotlin
enum class ActionType {
    ANALYZE,  // 帮我分析
    POLISH,   // 帮我润色（替代CHECK）
    REPLY     // 帮我回复（新增）
}
```

#### 3.3.2 新增UseCase

**PolishDraftUseCase**: 润色用户草稿
- 输入：contactId, draftText
- 输出：PolishResult（优化后的文本 + 可选的风险提示）

**GenerateReplyUseCase**: 生成回复
- 输入：contactId, theirMessage
- 输出：ReplyResult（建议的回复 + 策略说明）

**RefinementUseCase**: 微调重新生成
- 输入：originalInput, lastAiResponse, refinementInstruction（可选）
- 输出：与原功能相同类型的结果

#### 3.3.3 新增提示词场景

在`PromptScene`中新增：
```kotlin
enum class PromptScene {
    ANALYZE,  // 已有
    CHECK,    // 已有（将废弃或合并到POLISH）
    EXTRACT,  // 已有
    SUMMARY,  // 已有
    POLISH,   // 新增：润色场景
    REPLY     // 新增：回复场景
}
```

## 4. UI设计

### 4.1 输入态界面

```
┌─────────────────────────────────────────┐
│  [🔍分析]  [✍️润色]  [💬回复]          │  ← Tab切换栏
├─────────────────────────────────────────┤
│  联系人: [小红 ▼]                       │  ← 下拉选择，默认上次
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────────┐│
│  │                                     ││
│  │  请输入内容...                      ││  ← 多行输入框
│  │                                     ││
│  │                                     ││
│  └─────────────────────────────────────┘│
│                                 0/5000  │  ← 字符计数
├─────────────────────────────────────────┤
│  [✕关闭]      [⊖最小化]      [发送→]  │  ← 操作按钮
└─────────────────────────────────────────┘
```

### 4.2 加载态界面

```
┌─────────────────────────────────────────┐
│  [🔍分析]  [✍️润色]  [💬回复]          │
├─────────────────────────────────────────┤
│                                         │
│           ◐ AI正在思考中...             │  ← 加载动画
│                                         │
├─────────────────────────────────────────┤
│  [✕关闭]      [⊖最小化]                │
└─────────────────────────────────────────┘
```

### 4.3 结果态界面（分析）

```
┌─────────────────────────────────────────┐
│  🔍 分析结果                    [⚠️警告]│  ← 标题 + 风险等级
├─────────────────────────────────────────┤
│  【军师分析】                           │
│  她这句话表面上是在撒娇，但实际上...    │
│                                         │
│  【策略建议】                           │
│  建议你先冷一冷，不要立刻回复...        │
│                                         │
│  【话术参考】                           │
│  "好的，那你先忙，我也有点事"          │
├─────────────────────────────────────────┤
│  [📋复制]              [🔄重新生成]    │
└─────────────────────────────────────────┘
```

### 4.4 结果态界面（润色/回复）

```
┌─────────────────────────────────────────┐
│  ✍️ 润色结果                            │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────────┐│
│  │                                     ││
│  │  亲爱的，今晚有点累，想在家休息     ││  ← 优化后的文本
│  │  一下，下次一定陪你去～              ││
│  │                                     ││
│  └─────────────────────────────────────┘│
├─────────────────────────────────────────┤
│  [📋复制]              [🔄重新生成]    │
└─────────────────────────────────────────┘
```

### 4.5 微调对话框

```
┌─────────────────────────────────────────┐
│  需要调整方向吗？                       │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────────┐│
│  │ 例如：强硬一点、幽默一点、简短点... ││  ← 输入框
│  └─────────────────────────────────────┘│
├─────────────────────────────────────────┤
│  [直接重新生成]        [按方向生成]    │
└─────────────────────────────────────────┘
```

## 5. 数据模型

### 5.1 悬浮窗状态模型

```kotlin
data class FloatingWindowState(
    val selectedTab: ActionType = ActionType.ANALYZE,
    val selectedContactId: String? = null,
    val inputText: String = "",
    val lastResult: AiResult? = null,
    val isLoading: Boolean = false
)

sealed class AiResult {
    data class Analysis(val result: AnalysisResult) : AiResult()
    data class Polish(val result: PolishResult) : AiResult()
    data class Reply(val result: ReplyResult) : AiResult()
}
```

### 5.2 润色结果模型

```kotlin
data class PolishResult(
    val polishedText: String,        // 优化后的文本
    val hasRisk: Boolean = false,    // 是否有风险
    val riskWarning: String? = null  // 风险提示（可选）
)
```

### 5.3 回复结果模型

```kotlin
data class ReplyResult(
    val suggestedReply: String,      // 建议的回复
    val strategyNote: String? = null // 策略说明（可选）
)
```

### 5.4 微调请求模型

```kotlin
data class RefinementRequest(
    val originalInput: String,           // 原始用户输入
    val originalTask: ActionType,        // 原始任务类型
    val lastAiResponse: String,          // AI上次的回复
    val refinementInstruction: String?   // 用户的微调指令（可选）
)
```

## 6. 提示词设计

### 6.1 润色场景提示词

```kotlin
private const val POLISH_HEADER = """你是用户的"高情商嘴替"。

【你的人设】
你是一个情商很高的朋友，帮用户把话说得更好听、更得体。
说话直接，改完就给结果，别啰嗦。

【身份识别】
- 【我正在回复】开头 = 用户打算发送的草稿，你要帮用户优化表达

【你的任务】
1. 检查草稿有没有踩雷的地方
2. 优化表达，让话说得更得体
3. 保持用户的原意，不要改变核心内容

【输出要求】
- 直接输出优化后的文本
- 如果有风险，在最后简单提一句
- 不要解释为什么这样改"""

private const val POLISH_FOOTER = """请以JSON格式返回结果：
{
  "polishedText": "优化后的文本",
  "hasRisk": false,
  "riskWarning": null
}

【字段说明】
- polishedText: 优化后可直接使用的文本
- hasRisk: 是否检测到风险（true/false）
- riskWarning: 风险提示（没有风险则为null）"""
```

### 6.2 回复场景提示词

```kotlin
private const val REPLY_HEADER = """你是用户的"神回复生成器"。

【你的人设】
你是一个阅人无数的老司机，能根据对方的话，给出最合适的回复。
说话直接，给完回复简单说一句为什么这样回就行。

【身份识别】
- 【对方说】开头 = 对方发给用户的消息，你要帮用户生成回复

【你的任务】
1. 理解对方话里的情绪和意图
2. 结合联系人画像，生成合适的回复
3. 回复要自然，像用户自己说的话

【输出要求】
- 直接给出可以发送的回复
- 简单说一句为什么这样回复
- 回复要符合用户和对方的关系"""

private const val REPLY_FOOTER = """请以JSON格式返回结果：
{
  "suggestedReply": "建议的回复内容",
  "strategyNote": "简短的策略说明"
}

【字段说明】
- suggestedReply: 可直接复制发送的回复
- strategyNote: 一句话说明为什么这样回复"""
```

### 6.3 微调场景提示词补充

```kotlin
private const val REFINEMENT_INSTRUCTION = """
用户对上一次的生成结果不满意。

【上次的结果】
{lastAiResponse}

【用户的修改意见】
{refinementInstruction}

请基于用户的意见重新生成，不要解释，直接输出新的结果。
"""
```

## 7. 验收标准

### 7.1 功能验收

- [ ] 三个Tab可以正常切换，切换时保留输入内容
- [ ] 每个Tab对应的功能正常工作
- [ ] 最小化时保存状态，恢复时还原状态
- [ ] 关闭时清空所有状态
- [ ] 联系人默认选中上次对话的联系人
- [ ] 微调重新生成功能正常工作

### 7.2 性能验收

- [ ] Tab切换响应时间<100ms
- [ ] AI请求响应时间<10s
- [ ] 状态保存/恢复时间<200ms
- [ ] 内存占用增量<2MB

### 7.3 兼容性验收

- [ ] 与现有悬浮窗功能兼容
- [ ] 不影响现有的AnalyzeChatUseCase和CheckDraftUseCase
- [ ] 支持现有的提示词系统

## 8. 开发计划

### 8.1 阶段一：后端重构（预计3天）

1. 扩展ActionType枚举
2. 新增PolishDraftUseCase
3. 新增GenerateReplyUseCase
4. 新增RefinementUseCase
5. 扩展PromptScene和SystemPrompts
6. 新增数据模型（PolishResult、ReplyResult等）

### 8.2 阶段二：UI重构（预计4天）

1. 重构FloatingView，添加Tab切换
2. 实现状态保持逻辑
3. 实现联系人记忆功能
4. 实现微调对话框
5. 更新结果展示界面

### 8.3 阶段三：集成测试（预计2天）

1. 单元测试
2. 集成测试
3. UI测试
4. 性能测试

## 9. 风险评估

### 9.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 状态保持可能导致内存泄漏 | 中 | 使用WeakReference，及时清理 |
| 微调功能增加API调用成本 | 低 | 限制微调次数，提示用户 |
| Tab切换可能影响现有逻辑 | 中 | 保持向后兼容，渐进式重构 |

### 9.2 产品风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 用户可能不理解三个功能的区别 | 中 | 添加功能说明和引导 |
| 微调功能可能被滥用 | 低 | 限制单次会话微调次数 |

## 10. 附录

### 10.1 与PRD-00001的关系

本PRD是对PRD-00001的功能扩展和优化，主要变更：
- 将"帮我检查"重命名为"帮我润色"，并增强功能
- 新增"帮我回复"功能
- 新增Tab切换交互
- 新增状态保持和联系人记忆
- 新增微调重新生成功能

### 10.2 相关文档

- PRD-00001-悬浮窗功能需求
- PRD-00008-输入内容身份识别与双向对话历史需求
- TDD-00008-输入内容身份识别与双向对话历史技术设计
