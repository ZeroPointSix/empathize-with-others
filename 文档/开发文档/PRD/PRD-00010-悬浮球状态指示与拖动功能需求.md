# PRD-00010-悬浮球状态指示与拖动功能需求

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | PRD (Product Requirements Document) |
| 文档编号 | PRD-00010 |
| 功能名称 | 悬浮球状态指示与拖动功能 |
| 版本 | 1.0 |
| 创建日期 | 2025-12-18 |
| 作者 | Kiro |
| 审核人 | 待定 |
| 关联文档 | PRD-00009-悬浮窗功能重构需求 |

---

## 2. 产品概述

### 2.1 功能背景

当前悬浮窗系统存在以下问题：

1. **悬浮球不能拖动**：最小化后的悬浮球固定在某个位置，用户无法根据使用习惯调整位置
2. **最小化时缺少状态指示**：用户在AI处理过程中最小化悬浮窗后，无法知道AI是否还在处理
3. **缺少完成通知**：AI处理完成后，如果用户已最小化，没有任何提醒机制

### 2.2 功能目标

1. **悬浮球可拖动**：用户可以将悬浮球拖动到屏幕任意位置，并记住位置
2. **状态可视化**：通过悬浮球的视觉变化，让用户随时了解AI处理状态
3. **完成通知**：AI处理完成后，通过系统通知和悬浮球视觉变化双重提醒用户

### 2.3 目标用户

- **主要用户**：频繁使用悬浮窗进行AI分析/润色/回复的用户
- **使用场景**：用户发起AI请求后，最小化悬浮窗继续使用其他应用

---

## 3. 名词定义

| 名词 | 定义 |
|------|------|
| 悬浮窗 | 主界面，包含Tab切换、输入框、结果展示等完整功能，固定居中显示 |
| 悬浮球 | 最小化后的小圆球，可拖动，显示状态指示 |
| 状态指示器 | 悬浮球上的视觉元素，用于表示当前AI处理状态 |

---

## 4. 功能需求

### 4.1 悬浮球拖动功能 (P0)

#### 4.1.1 功能描述

用户可以通过手指拖动悬浮球到屏幕任意位置。

#### 4.1.2 交互规则

| 操作 | 行为 |
|------|------|
| 短按（<200ms） | 展开悬浮窗 |
| 长按拖动 | 移动悬浮球位置 |
| 松手 | 悬浮球停留在当前位置 |

#### 4.1.3 位置规则

- **默认位置**：屏幕右侧中间（首次使用时）
- **拖动范围**：屏幕任意位置（不限制贴边）
- **边界处理**：悬浮球不能完全移出屏幕，至少保留50%可见
- **位置记忆**：记住用户上次拖动的位置，下次最小化时恢复到该位置

#### 4.1.4 验收标准

- [ ] 悬浮球可以被拖动到屏幕任意位置
- [ ] 短按悬浮球可以展开悬浮窗
- [ ] 拖动过程流畅，无卡顿（帧率≥55FPS）
- [ ] 松手后悬浮球停留在当前位置
- [ ] 位置信息保存到SharedPreferences
- [ ] 应用重启后，悬浮球位置恢复到上次保存的位置

---

### 4.2 悬浮球状态指示 (P0)

#### 4.2.1 功能描述

悬浮球通过不同的视觉样式，表示当前AI处理状态。

#### 4.2.2 状态定义

| 状态 | 视觉样式 | 说明 |
|------|----------|------|
| 空闲 (IDLE) | 静态App图标 | 没有正在处理的请求 |
| 加载中 (LOADING) | 旋转动画 + 进度环 | AI正在处理请求 |
| 成功 (SUCCESS) | 绿色勾 ✓ + 轻微弹跳动画 | AI处理完成，有结果可查看 |
| 失败 (ERROR) | 红色叹号 ! | AI处理失败 |

#### 4.2.3 状态转换

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  ┌──────┐    发起请求    ┌─────────┐                   │
│  │ IDLE │ ─────────────→ │ LOADING │                   │
│  └──────┘                └─────────┘                   │
│      ↑                    │       │                    │
│      │                    │       │                    │
│      │    点击查看结果    ↓       ↓    处理失败        │
│      │              ┌─────────┐  ┌───────┐             │
│      └───────────── │ SUCCESS │  │ ERROR │             │
│      │              └─────────┘  └───────┘             │
│      │                               │                 │
│      └───────────────────────────────┘                 │
│                    点击查看/重试                        │
└─────────────────────────────────────────────────────────┘
```

#### 4.2.4 状态触发条件（重要）

**⚠️ 核心原则：只有真正发起AI网络请求后，才能进入LOADING状态**

| 状态 | 触发条件 | 说明 |
|------|----------|------|
| IDLE → LOADING | **真正调用AI API时** | 必须是网络请求已发出，不是点击发送按钮时 |
| LOADING → SUCCESS | AI API返回成功结果 | 收到有效的AI响应 |
| LOADING → ERROR | AI API返回错误或超时 | 网络错误、API错误、超时等 |
| SUCCESS → IDLE | 用户点击悬浮球查看结果 | 结果已被用户查看 |
| ERROR → IDLE | 用户点击悬浮球查看错误 | 错误已被用户确认 |

**❌ 不应触发LOADING的场景**：
- 用户点击发送按钮（此时可能还在做本地校验）
- 本地数据校验中
- 构建请求参数中
- 联系人信息加载中

**✅ 应该触发LOADING的时机**：
- `AiRepository.analyzeChat()` 被调用时
- `AiRepository.polishDraft()` 被调用时
- `AiRepository.generateReply()` 被调用时
- 即：Retrofit/OkHttp 真正发起HTTP请求的那一刻

#### 4.2.5 状态持续时间

| 状态 | 持续时间 |
|------|----------|
| IDLE | 持续，直到发起真正的AI请求 |
| LOADING | 持续，直到AI返回结果或超时 |
| SUCCESS | 持续，直到用户点击查看结果 |
| ERROR | 持续，直到用户点击查看/重试 |

#### 4.2.6 验收标准

- [ ] 空闲状态显示静态App图标
- [ ] 加载状态显示旋转动画，动画流畅
- [ ] 成功状态显示绿色勾，有轻微弹跳动画
- [ ] 失败状态显示红色叹号
- [ ] 状态转换正确，无异常状态
- [ ] **关键：点击发送按钮时不立即显示加载状态**
- [ ] **关键：只有AI API真正被调用时才显示加载状态**
- [ ] **关键：本地校验失败时不显示加载状态，直接显示错误提示**

---

### 4.3 悬浮球点击行为 (P0)

#### 4.3.1 功能描述

用户点击悬浮球后，根据当前状态展开悬浮窗并显示对应内容。

#### 4.3.2 点击行为定义

| 当前状态 | 点击后行为 |
|----------|-----------|
| IDLE | 展开悬浮窗，显示输入界面 |
| LOADING | 展开悬浮窗，显示加载状态 |
| SUCCESS | 展开悬浮窗，显示AI结果，状态重置为IDLE |
| ERROR | 展开悬浮窗，显示错误信息，状态重置为IDLE |

#### 4.3.3 验收标准

- [ ] 各状态下点击悬浮球都能正确展开悬浮窗
- [ ] 展开后显示对应的内容（输入/加载/结果/错误）
- [ ] SUCCESS和ERROR状态点击后重置为IDLE

---

### 4.4 系统通知 (P0)

#### 4.4.1 功能描述

AI处理完成后，发送系统通知提醒用户。

#### 4.4.2 通知内容

**成功通知**：

| 任务类型 | 通知标题 | 通知内容 |
|----------|----------|----------|
| ANALYZE | 共情AI | 分析完成，点击查看结果 |
| POLISH | 共情AI | 润色完成，点击查看结果 |
| REPLY | 共情AI | 回复已生成，点击查看 |

**失败通知**：

| 场景 | 通知标题 | 通知内容 |
|------|----------|----------|
| 网络错误 | 共情AI | 网络连接失败，点击重试 |
| API错误 | 共情AI | 处理失败，点击重试 |
| 超时 | 共情AI | 请求超时，点击重试 |

#### 4.4.3 通知行为

- **点击通知**：展开悬浮窗，显示结果或错误信息
- **滑动删除**：仅删除通知，不影响悬浮球状态
- **通知渠道**：使用独立的通知渠道 `empathy_ai_result`

#### 4.4.4 通知触发条件

- **仅在最小化状态下触发**：如果悬浮窗已展开，不发送通知
- **每次请求只发送一次**：避免重复通知

#### 4.4.5 验收标准

- [ ] AI处理成功后发送成功通知
- [ ] AI处理失败后发送失败通知
- [ ] 通知内容根据任务类型正确显示
- [ ] 点击通知能正确展开悬浮窗
- [ ] 悬浮窗已展开时不发送通知
- [ ] 通知渠道正确配置，用户可在系统设置中管理

---

## 5. UI设计

### 5.1 悬浮球设计

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│   空闲状态          加载状态          成功状态          │
│                                                         │
│   ┌──────┐         ┌──────┐         ┌──────┐           │
│   │      │         │  ◐   │         │  ✓   │           │
│   │  📱  │         │ ╱ ╲  │         │      │           │
│   │      │         │      │         │ 绿色  │           │
│   └──────┘         └──────┘         └──────┘           │
│   静态图标         旋转动画          弹跳动画           │
│                                                         │
│                                                         │
│   失败状态                                              │
│                                                         │
│   ┌──────┐                                             │
│   │  !   │                                             │
│   │      │                                             │
│   │ 红色  │                                             │
│   └──────┘                                             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5.2 悬浮球尺寸

| 属性 | 值 |
|------|-----|
| 直径 | 56dp |
| 图标大小 | 32dp |
| 阴影 | elevation 8dp |
| 圆角 | 完全圆形 (28dp radius) |

### 5.3 状态颜色

| 状态 | 背景色 | 图标色 |
|------|--------|--------|
| IDLE | #FFFFFF | 主题色 |
| LOADING | #FFFFFF | 主题色 |
| SUCCESS | #E8F5E9 | #4CAF50 |
| ERROR | #FFEBEE | #F44336 |

### 5.4 动画规格

| 动画 | 时长 | 缓动函数 |
|------|------|----------|
| 加载旋转 | 1000ms/圈 | LinearInterpolator |
| 成功弹跳 | 300ms | OvershootInterpolator |
| 状态切换 | 200ms | FastOutSlowInInterpolator |

---

## 6. 数据模型

### 6.1 悬浮球状态枚举

```kotlin
enum class FloatingBubbleState {
    IDLE,      // 空闲
    LOADING,   // 加载中
    SUCCESS,   // 成功
    ERROR      // 失败
}
```

### 6.2 悬浮球位置模型

```kotlin
data class FloatingBubblePosition(
    val x: Int,  // 屏幕X坐标
    val y: Int   // 屏幕Y坐标
)
```

### 6.3 通知数据模型

```kotlin
data class AiResultNotification(
    val taskType: ActionType,      // 任务类型
    val isSuccess: Boolean,        // 是否成功
    val title: String,             // 通知标题
    val content: String,           // 通知内容
    val timestamp: Long            // 时间戳
)
```

---

## 7. 技术要点

### 7.1 拖动实现

- 使用 `OnTouchListener` 监听触摸事件
- 通过 `WindowManager.updateViewLayout()` 更新位置
- 区分短按和拖动：记录按下时间和移动距离

### 7.2 状态指示器实现

- 使用 `AnimatedVectorDrawable` 实现旋转动画
- 使用 `ObjectAnimator` 实现弹跳动画
- 状态切换使用 `TransitionDrawable` 实现平滑过渡

### 7.3 通知实现

- 创建通知渠道 `empathy_ai_result`
- 使用 `NotificationCompat.Builder` 构建通知
- 通过 `PendingIntent` 实现点击跳转

### 7.4 位置持久化

- 使用 `FloatingWindowPreferences` 保存位置
- 新增字段：`bubble_position_x`, `bubble_position_y`

---

## 8. 验收标准汇总

### 8.1 功能验收

- [ ] 悬浮球可拖动到屏幕任意位置
- [ ] 悬浮球位置记忆功能正常
- [ ] 四种状态（空闲/加载/成功/失败）显示正确
- [ ] 状态转换逻辑正确
- [ ] 点击悬浮球能正确展开悬浮窗
- [ ] 系统通知发送和点击跳转正常

### 8.2 性能验收

- [ ] 拖动帧率≥55FPS
- [ ] 动画流畅，无卡顿
- [ ] 内存占用增量<1MB

### 8.3 兼容性验收

- [ ] 支持Android 7.0及以上版本
- [ ] 兼容主流厂商ROM
- [ ] 通知渠道在各系统版本正常工作

---

## 9. 开发计划

### 9.1 阶段一：悬浮球拖动（预计1天）

1. 实现触摸事件监听
2. 实现拖动逻辑
3. 实现位置持久化
4. 区分短按和拖动

### 9.2 阶段二：状态指示器（预计1.5天）

1. 定义状态枚举
2. 实现各状态的视觉样式
3. 实现状态切换动画
4. 集成到FloatingWindowService

### 9.3 阶段三：系统通知（预计1天）

1. 创建通知渠道
2. 实现通知构建逻辑
3. 实现点击跳转
4. 集成到AI请求完成回调

### 9.4 阶段四：测试与优化（预计0.5天）

1. 单元测试
2. 集成测试
3. 性能优化

**总计：约4天**

---

## 10. 风险评估

### 10.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 部分ROM限制悬浮窗拖动 | 中 | 检测ROM类型，提供兼容方案 |
| 通知权限被用户关闭 | 低 | 仅依赖悬浮球状态指示，通知为辅助 |
| 动画性能问题 | 低 | 使用硬件加速，优化动画实现 |

### 10.2 产品风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 用户不理解状态含义 | 低 | 首次使用时提供引导说明 |
| 通知过于频繁打扰用户 | 低 | 仅在最小化状态下发送，用户可关闭 |

---

## 11. 相关文档

- [PRD-00009-悬浮窗功能重构需求](PRD-00009-悬浮窗功能重构需求.md)
- [TDD-00009-悬浮窗功能重构技术设计](../TDD/TDD-00009-悬浮窗功能重构技术设计.md)
- [BUG-00013-悬浮窗UI交互问题修复](../BUG/BUG-00013-悬浮窗UI交互问题修复.md)
