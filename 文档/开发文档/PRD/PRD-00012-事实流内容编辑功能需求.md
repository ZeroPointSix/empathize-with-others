# PRD-00006-事实流内容编辑功能需求

## 文档信息

**文档编号**: PRD-00012  
**创建日期**: 2025-12-20  
**最后更新**: 2025-12-20  
**状态**: 草稿  
**负责人**: 产品经理  

---

## 1. 需求背景与目标

### 1.1 需求背景

当前的事实流系统已经实现了自动记录对话、AI总结和事实管理功能，但用户无法对已记录的内容进行修改。随着关系的发展，联系人的信息、目标以及事实内容可能会发生变化，用户需要能够灵活地修改这些内容。

### 1.2 需求痛点

1. **内容不可编辑**：事实流中的标签、对话记录、AI总结等内容一旦生成就无法修改
2. **信息更新困难**：联系人姓名、目标等基本信息变化后无法更新
3. **数据准确性问题**：AI推断的内容可能有误，用户无法纠正
4. **用户体验不佳**：用户无法根据自己的理解调整事实描述

### 1.3 需求目标

1. **全面可编辑**：允许用户编辑事实流中的所有内容
2. **标记修改**：明确标识用户修改过的内容
3. **保持数据完整性**：编辑操作不影响系统的其他功能
4. **提升用户体验**：提供直观、便捷的编辑界面

---

## 2. 功能范围

### 2.1 核心功能

#### 2.1.1 事实（Fact）编辑
- 编辑事实的键（key）和值（value）
- 标记事实是否被用户修改过
- 更新事实的最后修改时间

#### 2.1.2 对话记录编辑
- 编辑对话记录的内容文本
- 标记对话记录是否被用户修改过
- 更新对话记录的最后修改时间

#### 2.1.3 AI总结编辑
- 编辑AI总结的内容文本
- 标记AI总结是否被用户修改过
- 更新AI总结的最后修改时间

#### 2.1.4 联系人信息编辑
- 编辑联系人姓名
- 编辑联系人目标
- 更新信息的最后修改时间

### 2.2 辅助功能

#### 2.2.1 视觉标识
- 为已编辑的内容显示"已编辑"标识
- 区分原始内容和用户修改内容
- 显示最后修改时间

#### 2.2.2 编辑状态管理
- 保存编辑状态，避免数据丢失
- 提供撤销和恢复功能

#### 2.2.3 V2版本功能（本次不实现）
> 以下功能计划在V2版本实现，本次MVP不包含：

- **批量编辑操作**：支持同时编辑多个事实或对话记录
- **编辑历史记录查看**：查看内容的修改历史和版本对比

---

## 3. 用户故事

### 3.1 主要用户故事

#### US1: 事实编辑
**作为** 用户  
**我希望** 能够编辑事实流中的事实内容  
**以便** 纠正错误或更新过时的信息  

**验收标准**:
- 可以点击事实进入编辑模式
- 可以修改事实的键和值
- 保存后显示"已编辑"标识
- 更新最后修改时间

#### US2: 对话记录编辑
**作为** 用户  
**我希望** 能够编辑对话记录的内容  
**以便** 修正记录错误或补充遗漏信息  

**验收标准**:
- 可以点击对话记录进入编辑模式
- 可以修改对话文本内容
- 保存后显示"已编辑"标识
- 更新最后修改时间

#### US3: AI总结编辑
**作为** 用户  
**我希望** 能够编辑AI总结的内容  
**以便** 纠正AI的推断错误或调整表述方式  

**验收标准**:
- 可以点击AI总结进入编辑模式
- 可以修改总结文本内容
- 保存后显示"已编辑"标识
- 更新最后修改时间

#### US4: 联系人信息编辑
**作为** 用户  
**我希望** 能够编辑联系人的姓名和目标  
**以便** 更新联系人信息以反映当前状态  

**验收标准**:
- 可以编辑联系人姓名
- 可以编辑联系人目标
- 保存后更新显示信息
- 更新最后修改时间

---

## 4. 功能详细设计

### 4.1 数据模型扩展

#### 4.1.1 Fact模型扩展
```kotlin
data class Fact(
    val id: String = UUID.randomUUID().toString(),
    val key: String,
    val value: String,
    val timestamp: Long,
    val source: FactSource,
    // 新增字段
    val isUserModified: Boolean = false,
    val lastModifiedTime: Long = timestamp
)
```

#### 4.1.2 ConversationLog模型扩展
```kotlin
data class ConversationLog(
    val id: String,
    val contactId: String,
    val content: String,
    val timestamp: Long,
    val sender: MessageSender,
    // 新增字段
    val isUserModified: Boolean = false,
    val lastModifiedTime: Long = timestamp
)
```

#### 4.1.3 DailySummary模型扩展
```kotlin
data class DailySummary(
    val id: String,
    val contactId: String,
    val date: String,
    val summary: String,
    val keyEvents: List<KeyEvent>,
    val newFacts: List<Fact>,
    val updatedTags: List<TagUpdate>,
    // 新增字段
    val isUserModified: Boolean = false,
    val lastModifiedTime: Long
)
```

#### 4.1.4 ContactProfile模型扩展
```kotlin
data class ContactProfile(
    val id: String,
    val name: String,
    val targetGoal: String,
    val contextDepth: Int = 10,
    val facts: List<Fact> = emptyList(),
    val relationshipScore: Int = MemoryConstants.DEFAULT_RELATIONSHIP_SCORE,
    val lastInteractionDate: String? = null,
    val avatarUrl: String? = null,
    // 新增字段
    val isNameUserModified: Boolean = false,
    val isGoalUserModified: Boolean = false,
    val nameLastModifiedTime: Long = 0L,
    val goalLastModifiedTime: Long = 0L
)
```

### 4.2 UI交互设计

#### 4.2.1 事实编辑界面
- 点击事实卡片进入编辑模式
- 提供键和值的输入框
- 保存/取消按钮
- 显示原始值作为参考

#### 4.2.2 对话记录编辑界面
- 点击对话气泡进入编辑模式
- 提供文本编辑框
- 保存/取消按钮
- 显示原始内容作为参考

#### 4.2.3 AI总结编辑界面
- 点击总结内容进入编辑模式
- 提供多行文本编辑框
- 保存/取消按钮
- 显示原始内容作为参考

#### 4.2.4 联系人信息编辑界面
- 点击联系人姓名或目标进入编辑模式
- 提供输入框
- 保存/取消按钮
- 显示原始值作为参考

#### 4.2.5 视觉标识设计
- 已编辑内容显示"已编辑"标签
- 使用不同颜色区分修改状态
- 显示最后修改时间
- 提供查看原始内容的选项

### 4.3 业务逻辑设计

#### 4.3.1 编辑流程
1. 用户点击可编辑内容
2. 系统显示编辑界面
3. 用户修改内容
4. 系统验证输入
5. 保存修改并更新标记
6. 刷新显示界面

#### 4.3.2 数据验证规则
- 事实键不能为空
- 事实值不能为空
- 联系人姓名不能为空
- 联系人目标不能为空
- 文本长度限制

#### 4.3.3 冲突处理
- 同时编辑冲突检测
- 版本冲突解决策略
- 数据一致性保证

---

## 5. 非功能性需求

### 5.1 性能需求
- 编辑对话框打开时间 < 100ms
- 保存操作响应时间 < 200ms
- 数据库操作时间 < 50ms
- 支持离线编辑

### 5.2 可用性需求
- 直观的编辑界面
- 清晰的编辑状态指示
- 简单的操作流程

### 5.3 兼容性需求
- 兼容现有数据结构
- 支持数据迁移
- 向后兼容旧版本

---

## 6. 技术约束

### 6.1 数据存储
- 使用Room数据库
- 支持数据迁移
- 保证数据完整性

### 6.2 UI框架
- 使用Jetpack Compose
- 遵循Material Design
- 响应式设计

### 6.3 架构约束
- 遵循MVVM架构
- 使用Repository模式
- 保持领域模型纯净

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 所有类型的内容都可以编辑
- [ ] 编辑后正确显示"已编辑"标识
- [ ] 最后修改时间正确更新
- [ ] 数据正确保存到数据库

### 7.2 性能验收
- [ ] 编辑操作响应时间符合要求
- [ ] 保存操作性能达标
- [ ] 内存使用合理

### 7.3 用户体验验收
- [ ] 编辑界面直观易用
- [ ] 错误提示清晰
- [ ] 操作流程顺畅

---

## 8. 风险与依赖

### 8.1 技术风险
- 数据迁移复杂性
- 性能影响
- 兼容性问题

### 8.2 业务风险
- 用户数据误修改
- 数据一致性问题
- 用户体验下降

### 8.3 依赖项
- 依赖现有事实流系统
- 依赖数据库架构
- 依赖UI组件库

---

## 9. 实施计划

### 9.1 阶段一：数据模型扩展（4h）
- 扩展数据模型
- 实现数据迁移
- 更新Repository层

### 9.2 阶段二：编辑功能实现（3-4天）
- 实现事实编辑功能
- 实现对话记录编辑功能
- 实现AI总结编辑功能
- 实现联系人信息编辑功能

### 9.3 阶段三：UI界面优化（2-3天）
- 优化编辑界面
- 实现视觉标识
- 完善交互体验

### 9.4 阶段四：测试与优化（1-2天）
- 功能测试
- 性能测试
- 用户体验测试

---

## 10. 成功指标

### 10.1 功能指标
- 编辑功能成功率 > 99%
- 数据保存成功率 > 99.9%
- 编辑响应时间 < 200ms

### 10.2 用户指标
- 用户满意度 > 4.5/5
- 编辑功能使用率 > 30%
- 错误率 < 1%

---

**最后更新**: 2025-12-20  
**版本**: v1.0