# PRD-00024-图标和版本号自动更新

## 文档信息
- **文档编号**: PRD-00024
- **文档版本**: v1.1
- **创建日期**: 2025-12-31
- **创建者**: Claude (产品经理)
- **状态**: 待审查
- **相关文档**: TDD-00024, TD-00024

---

## 1. 需求背景

### 1.1 问题陈述
当前项目在发布流程中存在以下痛点：
1. **手动更新效率低**: 每次发布需要手动更新应用图标和版本号，耗时且容易出错
2. **版本管理不规范**: 缺乏统一的版本管理机制，版本号变更依赖人工判断
3. **发布流程不标准**: 没有标准化的发布流程，不同发布阶段缺乏明确的标识
4. **自动化程度不足**: 发布流程中人工干预过多，影响发布效率和准确性

### 1.2 需求动机
为了建立自动化的发布流程和规范的版本管理机制，需要实现图标和版本号的自动更新功能，为项目的正式发布做好准备。

### 1.3 业务价值
- **提升发布效率**: 减少人工操作，降低发布时间成本
- **降低错误率**: 自动化更新减少人为错误
- **标准化流程**: 建立规范的版本管理和发布流程
- **支持多阶段发布**: 为开发、测试、预发布、正式发布提供明确的视觉区分

---

## 2. 功能概述

### 2.1 核心功能
实现基于Gradle任务的图标和版本号自动更新系统，支持根据发布阶段自动切换应用图标，并根据Git提交信息自动递增版本号。

### 2.2 目标用户
- **开发团队**: 负责应用开发和发布的开发人员
- **项目经理**: 负责发布流程管理的项目管理人员
- **测试团队**: 需要区分不同版本进行测试的测试人员

### 2.3 使用场景
1. **开发阶段发布**: 开发完成后，运行命令自动更新为开发版图标和版本号
2. **测试阶段发布**: 测试版本发布时，自动更新为测试版图标和版本号
3. **预发布阶段**: 预发布版本发布时，自动更新为预发布版图标和版本号
4. **正式发布**: 正式版本发布时，自动更新为正式版图标和版本号

---

## 3. 功能需求

### 3.1 版本号自动更新

#### 3.1.1 版本号规则
采用语义化版本控制（Semantic Versioning）：
- **格式**: `major.minor.patch` (例如: 1.0.0)
- **Major版本**: 不兼容的API修改
- **Minor版本**: 向下兼容的功能性新增
- **Patch版本**: 向下兼容的问题修正

#### 3.1.2 版本号变更识别
基于Git提交信息自动识别版本变更类型：
- **feat!**: Major版本递增 (例如: feat!: 添加了全新的AI引擎架构)
- **feat**: Minor版本递增 (例如: feat: 添加了联系人标签功能)
- **fix**: Patch版本递增 (例如: fix: 修复了悬浮窗显示问题)

#### 3.1.3 版本号更新逻辑
1. 分析自上次发布以来的Git提交信息
2. 根据提交信息中的关键字确定变更类型
3. 按照语义化版本规则递增相应的版本号
4. 更新build.gradle.kts中的版本信息
5. 更新相关配置文件中的版本引用

### 3.2 图标自动更新

#### 3.2.1 发布阶段图标
为不同发布阶段准备不同的应用图标：
- **开发版**: 带有"DEV"标识的开发图标
- **测试版**: 带有"TEST"标识的测试图标
- **预发布版**: 带有"BETA"标识的预发布图标
- **正式版**: 标准的正式版图标

#### 3.2.2 图标更新逻辑
1. 根据当前发布阶段确定目标图标
2. 自动替换app/src/main/res/mipmap*目录下的图标文件
3. 更新应用启动图标相关的配置
4. 确保所有分辨率的图标都被正确更新

### 3.3 Gradle任务集成

#### 3.3.1 主任务
- **任务名称**: `updateVersionAndIcon`
- **触发方式**: `./gradlew updateVersionAndIcon`
- **功能**: 执行完整的版本号和图标更新流程

#### 3.3.2 子任务
- `updateVersion`: 仅更新版本号
- `updateIcon`: 仅更新图标
- `updateVersionAndIcon --stage=production`: 指定发布阶段

#### 3.3.3 任务参数
- `--stage`: 发布阶段 (dev/test/beta/production)
- `--force`: 强制更新，忽略版本检查
- `--dry-run`: 预演模式，只显示将要执行的变更

---

## 4. 非功能性需求

### 4.1 性能要求
- **执行时间**: 整个更新流程应在30秒内完成
- **资源占用**: 内存占用不超过100MB
- **并发支持**: 支持多开发者并行执行（通过文件锁机制）

### 4.2 可靠性要求
- **数据一致性**: 确保版本号和图标更新的一致性
- **回滚机制**: 支持更新失败时的自动回滚
- **备份机制**: 更新前自动备份原始文件

### 4.3 兼容性要求
- **Gradle版本**: 兼容Gradle 8.0+
- **Android版本**: 支持Android API 24+
- **操作系统**: 支持Windows、macOS、Linux

### 4.4 安全性要求
- **权限控制**: 只有授权用户可以执行发布更新
- **变更审计**: 记录所有版本和图标变更历史
- **签名验证**: 验证图标文件的完整性

---

## 5. 用户界面需求

### 5.1 命令行界面
提供清晰的命令行输出，包括：
- 当前版本信息
- 检测到的变更类型
- 将要执行的操作列表
- 执行结果和状态

### 5.2 配置界面
在项目根目录提供配置文件：
- `version-config.json`: 版本更新配置
- `icon-mapping.json`: 图标映射配置

---

## 6. 数据需求

### 6.1 版本数据存储
- **当前版本**: 存储在build.gradle.kts中
- **版本历史**: 存储在version-history.json中
- **变更记录**: 存储在change-log.json中

### 6.2 图标资源管理
- **图标文件**: 存储在assets/icons/目录下
- **图标配置**: 存储在icon-config.json中
- **临时文件**: 存储在temp/目录下

---

## 7. 集成需求

### 7.1 CI/CD集成
- **Jenkins**: 提供Jenkins Pipeline脚本
- **GitHub Actions**: 提供GitHub Action工作流
- **GitLab CI**: 提供GitLab CI配置

### 7.2 开发工具集成
- **Android Studio**: 提供Android Studio插件
- **VS Code**: 提供VS Code扩展
- **IDEA**: 提供IntelliJ IDEA插件

---

## 8. 测试需求

### 8.1 单元测试
- 版本号解析逻辑测试
- 图标更新逻辑测试
- Git提交信息分析测试

### 8.2 集成测试
- 完整更新流程测试
- 多平台兼容性测试
- 错误处理和回滚测试

### 8.3 用户验收测试
- 不同发布场景测试
- 边界条件测试
- 性能压力测试

---

## 9. 部署需求

### 9.1 环境要求
- **Java**: JDK 17+
- **Git**: Git 2.30+
- **Gradle**: Gradle 8.0+

### 9.2 配置要求
- **权限**: 读写项目目录权限
- **网络**: 访问Git仓库权限
- **存储**: 至少100MB可用空间

---

## 10. 风险与限制

### 10.1 技术风险
- **Git提交信息不规范**: 可能导致版本号判断错误
- **图标文件损坏**: 可能导致应用无法启动
- **并发冲突**: 多用户同时执行可能导致文件冲突

### 10.2 业务风险
- **版本号跳跃**: 可能导致版本管理混乱
- **图标更新失败**: 可能影响用户体验
- **回滚失败**: 可能导致应用状态不一致

### 10.3 限制条件
- **Git提交规范**: 需要团队遵循统一的提交信息规范
- **图标设计**: 需要预先设计不同阶段的图标
- **网络依赖**: 需要稳定的Git仓库访问

---

## 11. 成功标准

### 11.1 功能完整性
- [ ] 版本号能够根据Git提交信息正确递增
- [ ] 图标能够根据发布阶段正确更新
- [ ] Gradle任务能够正确执行所有更新操作

### 11.2 性能指标
- [ ] 更新流程执行时间 < 30秒
- [ ] 内存占用 < 100MB
- [ ] 成功率 > 99%

### 11.3 用户体验
- [ ] 命令行输出清晰易懂
- [ ] 错误信息友好明确
- [ ] 操作流程简单直观

---

## 12. 验收标准

### 12.1 功能验收
1. 执行`./gradlew updateVersionAndIcon`能够正确更新版本号和图标
2. 不同发布阶段的图标能够正确区分和显示
3. 版本号变更类型识别准确率达到100%

### 12.2 性能验收
1. 在标准开发机器上，更新流程完成时间 < 30秒
2. 连续执行100次更新，成功率 > 99%
3. 内存占用峰值 < 100MB

### 12.3 兼容性验收
1. 在Windows、macOS、Linux三个平台上都能正常运行
2. 支持Gradle 8.0及以上版本
3. 兼容Android Studio 2022.3.1及以上版本

---

## 13. 发布计划

### 13.1 开发阶段
- **第1周**: 版本号自动更新功能开发
- **第2周**: 图标自动更新功能开发
- **第3周**: Gradle任务集成和测试

### 13.2 测试阶段
- **第4周**: 单元测试和集成测试
- **第5周**: 用户验收测试和性能测试
- **第6周**: 多平台兼容性测试

### 13.3 发布阶段
- **第7周**: 文档完善和培训材料准备
- **第8周**: 正式发布和团队培训

---

## 14. 后续优化

### 14.1 功能扩展
- 支持自定义版本号规则
- 支持更多发布阶段类型
- 支持图标主题自定义

### 14.2 工具集成
- 开发图形界面工具
- 集成更多CI/CD平台
- 提供Web管理界面

### 14.3 智能化改进
- 基于机器学习的版本号预测
- 自动化的图标生成
- 智能的发布建议

---

## 15. 架构集成考虑

### 15.1 多模块版本同步策略
由于项目采用Clean Architecture多模块设计，需要确保各模块版本号的一致性：

#### 15.1.1 版本号管理
- **统一版本源**: 在app模块的build.gradle.kts中定义主版本号
- **模块引用**: 其他模块通过project.property引用主版本号
- **版本同步**: 更新任务确保所有模块使用相同版本号

#### 15.1.2 跨模块协调机制
- **依赖检查**: 验证模块间依赖关系的版本兼容性
- **同步更新**: 版本号更新时同步更新所有相关模块
- **冲突解决**: 处理模块间版本不一致的情况

### 15.2 DI模块影响评估
版本和图标更新功能对现有依赖注入模块的影响：

#### 15.2.1 版本信息提供
- **新增接口**: 在domain层添加VersionInfoRepository接口
- **实现类**: 在data层提供VersionInfoRepositoryImpl
- **依赖注入**: 通过Hilt提供版本信息访问能力

#### 15.2.2 现有模块影响
- **DatabaseModule**: 无直接影响，版本信息独立存储
- **NetworkModule**: 无直接影响，不涉及网络请求
- **RepositoryModule**: 需要添加版本信息仓库的依赖配置

### 15.3 模块间协调机制
确保版本更新功能与现有模块的协调工作：

#### 15.3.1 构建时协调
- **Gradle任务链**: 定义任务依赖关系，确保正确的执行顺序
- **资源管理**: 协调各模块的资源文件更新
- **配置同步**: 同步更新各模块的配置文件

#### 15.3.2 运行时协调
- **版本查询**: 提供统一的版本信息查询接口
- **状态同步**: 确保各模块对版本状态的一致认知
- **错误传播**: 建立跨模块的错误传播机制

---

## 16. 错误处理详细方案

### 16.1 备份策略具体实现

#### 16.1.1 备份文件格式和位置
- **备份目录**: `project/backups/version-update/`
- **文件格式**: `backup-YYYY-MM-DD-HH-mm-ss.tar.gz`
- **备份内容**: 
  - build.gradle.kts文件
  - app/src/main/res/mipmap*目录
  - version-config.json配置文件
  - version-history.json历史文件

#### 16.1.2 备份保留策略
- **保留期限**: 保留最近30天的备份文件
- **最大数量**: 最多保留50个备份文件
- **清理机制**: 每次更新时自动清理过期备份

#### 16.1.3 备份验证机制
- **完整性检查**: 备份后验证文件完整性
- **恢复测试**: 定期测试备份文件的可用性
- **空间监控**: 监控备份目录的磁盘空间使用

### 16.2 并发控制机制

#### 16.2.1 文件锁机制实现
- **锁文件**: `.version-update.lock`
- **锁获取**: 使用Java FileLock机制
- **锁超时**: 等待锁的最长时间为5分钟
- **锁释放**: 任务完成或异常时自动释放锁

#### 16.2.2 多用户协作策略
- **队列机制**: 多个请求按到达顺序排队执行
- **状态通知**: 实时通知其他用户当前执行状态
- **冲突解决**: 提供手动解决冲突的选项

#### 16.2.3 分布式锁支持
- **Git锁**: 使用Git分支作为分布式锁
- **远程锁**: 支持远程锁服务（如Redis）
- **锁同步**: 确保多台机器间的锁状态同步

### 16.3 错误恢复流程

#### 16.3.1 常见错误场景恢复
- **Git操作失败**: 
  - 检查网络连接
  - 重试Git操作（最多3次）
  - 使用本地缓存信息继续执行
- **文件写入失败**: 
  - 检查文件权限
  - 确保磁盘空间充足
  - 使用临时文件机制
- **版本解析错误**: 
  - 使用默认版本号
  - 记录错误日志
  - 提供手动修复建议

#### 16.3.2 自动恢复触发条件
- **网络超时**: 自动重试网络操作
- **文件锁定**: 等待锁释放后重试
- **权限问题**: 提示用户检查权限设置
- **磁盘空间**: 清理临时文件后重试

#### 16.3.3 手动恢复流程
- **备份恢复**: 提供从备份恢复的命令
- **状态重置**: 重置更新状态到初始状态
- **强制更新**: 提供跳过检查的强制更新选项
- **日志分析**: 提供详细的错误日志分析工具

---

## 17. 附录

### 17.1 术语表
- **PRD**: Product Requirements Document (产品需求文档)
- **CI/CD**: Continuous Integration/Continuous Deployment (持续集成/持续部署)
- **Gradle**: 基于Groovy的构建自动化工具
- **语义化版本**: Semantic Versioning，一种版本号命名规范

### 17.2 参考资料
- [Semantic Versioning 2.0.0](https://semver.org/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Android Gradle Plugin Documentation](https://developer.android.com/studio/build)

### 17.3 相关文档
- TDD-00024: 图标和版本号自动更新技术设计文档
- TD-00024: 图标和版本号自动更新任务清单
- CR-00024: 图标和版本号自动更新变更记录

---

**文档状态**: 待审查
**下一步**: 等待技术设计和任务清单文档创建
**预计完成**: 2025-12-31