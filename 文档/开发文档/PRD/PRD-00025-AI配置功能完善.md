# PRD-00025 AI配置功能完善

## 1. 需求概述

### 1.1 需求背景
当前AI配置功能在前端已经实现了基础界面，但后端功能尚未完全实现。用户无法真正使用高级选项、测试连接等功能，模型列表排序方式不够直观，通用选项中的网络代理和用量统计功能也缺少实际的后端支持。

### 1.2 需求目标
完善AI配置功能，实现前端界面与后端功能的完整对接，提供流畅的用户体验和可靠的AI服务商管理功能。

### 1.3 核心价值
- 提供完整的AI配置管理功能，增强用户对AI服务的控制力
- 优化模型列表排序交互，提升用户体验
- 实现用量统计功能，帮助用户了解API使用情况
- 提供网络代理设置，满足不同网络环境下的使用需求

## 2. 功能范围

### 2.1 AI配置高级选项功能
- **Temperature设置**：每个AI服务商独立的温度滑块设置
  - 取值范围：0-2（标准范围）
  - 默认值：0.7
  - 交互方式：滑块形式，实时显示当前值
- **最大Token数设置**：每个AI服务商独立的Token限制设置
  - 取值范围：用户自定义
  - 默认值：4096
  - 交互方式：数字输入框，支持手动输入
- **请求超时设置**：每个AI服务商独立的超时设置
  - 取值范围：用户自定义（秒）
  - 默认值：30秒
  - 交互方式：数字输入框，支持手动输入

### 2.2 测试连接功能
- **真实API测试**：使用服务商提供的专门测试接口
- **测试结果显示**：
  - 响应时间（毫秒）
  - 状态码
  - 简短的成功/失败消息
- **错误处理**：显示基本错误类型（网络错误、认证失败、服务不可用等）
- **配额提示**：可能消耗少量API配额，测试前进行提示

### 2.3 模型列表排序优化
- **拖拽排序**：替换现有的上下箭头排序方式
- **交互设计**：
  - 长按开始拖拽
  - 拖拽项放大显示
  - 其他项目自动腾出空间
  - 可拖拽到任意位置
- **视觉设计**：
  - 三个蓝色横杠图标
  - 图标位置：列表项右侧
  - 图标尺寸：大尺寸
- **限制范围**：限制在模型列表内拖拽

### 2.4 通用选项功能实现
- **网络代理设置**：
  - 支持HTTP/HTTPS/SOCKS代理
  - 代理服务器地址和端口配置
  - 用户名和密码认证（可选）
- **用量统计功能**：
  - 全局总览：显示总体API使用量
  - 供应商区分：按不同AI服务商分类统计
  - 模型区分：按不同模型分类统计
  - 简单计数：不要求绝对准确，显示大概统计即可
  - 历史记录：保留使用历史数据

## 3. 用户故事

### 3.1 高级选项设置
**作为** AI服务使用者  
**我希望** 能够为每个AI服务商设置不同的参数  
**以便** 获得符合我需求的AI响应质量和性能

### 3.2 测试连接
**作为** AI服务配置者  
**我希望** 能够测试我的配置是否正确  
**以便** 确保API调用能够成功

### 3.3 模型排序
**作为** AI服务使用者  
**我希望** 能够通过拖拽调整模型顺序  
**以便** 将常用的模型排在前面

### 3.4 用量统计
**作为** AI服务使用者  
**我希望** 能够查看我的API使用情况  
**以便** 控制使用成本和了解使用习惯

## 4. 功能规格

### 4.1 高级选项规格
| 功能 | 输入方式 | 取值范围 | 默认值 | 存储位置 |
|------|----------|----------|--------|----------|
| Temperature | 滑块 | 0-2 | 0.7 | 每个服务商独立存储 |
| 最大Token数 | 数字输入框 | 用户自定义 | 4096 | 每个服务商独立存储 |
| 请求超时 | 数字输入框 | 用户自定义（秒） | 30 | 每个服务商独立存储 |

### 4.2 测试连接规格
| 项目 | 规格 |
|------|------|
| 测试方式 | 使用服务商专门测试接口 |
| 显示信息 | 响应时间、状态码、成功/失败消息 |
| 错误类型 | 网络错误、认证失败、服务不可用等基本类型 |
| 配额消耗 | 可能消耗少量配额，测试前提示 |

### 4.3 模型排序规格
| 项目 | 规格 |
|------|------|
| 触发方式 | 长按 |
| 拖拽反馈 | 拖拽项放大，其他项自动腾出空间 |
| 图标设计 | 三个蓝色横杠 |
| 图标位置 | 列表项右侧 |
| 拖拽范围 | 限制在模型列表内 |

### 4.4 用量统计规格
| 统计维度 | 说明 |
|----------|------|
| 全局总览 | 显示总体API使用量 |
| 供应商区分 | 按不同AI服务商分类统计 |
| 模型区分 | 按不同模型分类统计 |
| 精度要求 | 简单计数，不要求绝对准确 |
| 历史记录 | 保留使用历史数据 |

## 5. 验收标准

### 5.1 高级选项验收标准
- [ ] 每个AI服务商可以独立设置Temperature值
- [ ] Temperature滑块可以正常拖动，取值范围0-2
- [ ] 每个AI服务商可以独立设置最大Token数
- [ ] 最大Token数输入框可以正常输入和保存
- [ ] 每个AI服务商可以独立设置请求超时时间
- [ ] 请求超时输入框可以正常输入和保存
- [ ] 所有设置在重启应用后保持不变

### 5.2 测试连接验收标准
- [ ] 点击测试连接按钮能发送真实API请求
- [ ] 测试成功时显示响应时间和成功消息
- [ ] 测试失败时显示基本错误类型
- [ ] 测试前提示可能消耗配额
- [ ] 测试过程中显示加载状态

### 5.3 模型排序验收标准
- [ ] 长按模型项可以开始拖拽
- [ ] 拖拽过程中项目放大显示
- [ ] 其他项目自动腾出空间
- [ ] 可以拖拽到列表内任意位置
- [ ] 显示三个蓝色横杠图标
- [ ] 图标位于列表项右侧
- [ ] 排序结果正确保存

### 5.4 通用选项验收标准
- [ ] 网络代理设置可以正常配置和保存
- [ ] 代理设置在API请求中生效
- [ ] 用量统计显示全局总览数据
- [ ] 用量统计按供应商分类显示
- [ ] 用量统计按模型分类显示
- [ ] 用量统计保留历史记录

## 6. 技术要求

### 6.1 数据存储
- 高级选项设置存储在本地数据库，与每个AI服务商关联
- 用量统计数据存储在本地数据库，支持历史记录查询
- 网络代理设置加密存储在本地SharedPreferences

### 6.2 API集成
- 测试连接使用各服务商提供的专门测试接口
- 代理设置应用于所有网络请求
- 用量统计在每次API调用后更新

### 6.3 UI/UX要求
- 遵循iOS设计规范，保持与现有界面风格一致
- 滑块和输入框提供即时反馈
- 拖拽操作流畅，提供清晰的视觉反馈
- 加载状态和错误提示友好明确

## 7. 风险与限制

### 7.1 技术风险
- 不同服务商的测试接口可能不统一，需要适配处理
- 代理设置可能影响部分网络请求，需要完善的错误处理
- 用量统计在多设备同步时可能出现数据不一致

### 7.2 用户体验风险
- 高级选项设置过于复杂可能增加用户学习成本
- 测试连接消耗配额可能导致用户不愿使用
- 拖拽操作在不同设备上可能有性能差异

### 7.3 限制条件
- 代理设置仅支持标准协议，不支持特殊协议
- 用量统计精度有限，仅作为参考
- 测试连接依赖网络环境，可能影响结果准确性

## 8. 成功指标

### 8.1 功能指标
- 高级选项设置成功率 > 95%
- 测试连接成功率 > 90%
- 模型排序操作完成率 > 98%
- 用量统计数据准确性 > 85%

### 8.2 用户体验指标
- 高级选项设置平均完成时间 < 30秒
- 测试连接平均响应时间 < 5秒
- 模型排序平均完成时间 < 10秒
- 用户满意度评分 > 4.0/5.0

## 9. 后续迭代计划

### 9.1 短期优化（1-2周）
- 根据用户反馈优化高级选项的默认值
- 增加更多测试连接的错误类型识别
- 优化拖拽操作的性能和流畅度

### 9.2 中期扩展（1-2月）
- 支持更多高级参数设置（如top_p、presence_penalty等）
- 增加用量统计的导出功能
- 支持代理设置的自动检测和配置

### 9.3 长期规划（3-6月）
- 实现用量统计的云端同步
- 支持代理设置的规则化配置
- 增加AI服务商性能评估和推荐功能

## 10. 附录

### 10.1 术语表
| 术语 | 说明 |
|------|------|
| Temperature | AI模型生成文本的随机性控制参数，值越高越随机 |
| Token | AI模型处理文本的基本单位，中文通常1个字符=1-2个Token |
| API配额 | AI服务商提供的API调用次数限制 |

### 10.2 参考资料
- [AI配置界面设计稿](HTML/设置/AI配置.html)
- [现有AI配置实现](presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/aiconfig/)
- [测试连接用例](domain/src/main/kotlin/com/empathy/ai/domain/usecase/TestConnectionUseCase.kt)

---

**文档版本**：v1.0  
**创建日期**：2026-01-01  
**创建者**：产品经理  
**最后更新**：2026-01-01  
**审核状态**：待审核