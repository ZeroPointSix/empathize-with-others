# PRD-00026 AI军师对话功能需求

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档编号 | PRD-00026 |
| 创建日期 | 2026-01-01 |
| 更新日期 | 2026-01-01 |
| 状态 | ✅ 已定稿 |
| 关联文档 | PRD-00007（对话上下文连续性增强）、PRD-00008（输入内容身份识别与双向对话历史） |

---

## 1. 背景与目标

### 1.1 背景

当前应用主要提供实时对话分析功能，用户需要在聊天过程中或聊天后立即获得AI分析。但缺乏一个独立的、专门的对话复盘和分析空间，用户无法：

1. **系统性回顾对话历史**：无法将多个时间段的对话进行整体分析
2. **深度关系分析**：缺乏基于完整对话历史的关系发展趋势分析
3. **赛前策略规划**：无法在重要对话前获得针对性的策略建议
4. **赛后复盘总结**：无法对关键对话进行深度复盘和经验总结

**核心问题**：现有功能是"即时反应式"的，而用户需要一个"深度思考式"的AI军师功能。

### 1.2 目标

构建一个独立的AI军师对话系统，实现：

1. **对话复盘功能**：基于完整的对话历史进行深度分析和复盘
2. **关系洞察功能**：从心理学、社会学、人类学角度分析人际关系变化
3. **策略规划功能**：为重要对话提供前瞻性的策略建议
4. **客观分析立场**：保持绝对公正客观的分析视角，基于经典理论

---

## 2. 核心设计理念

### 2.1 赛前赛后复盘模式

AI军师功能定位为"赛前赛后复盘助手"，而非实时对话分析：

| 功能定位 | 使用场景 | 价值主张 |
|---------|----------|----------|
| 赛前规划 | 重要对话前的策略准备 | 提供针对性的沟通策略和注意事项 |
| 赛后复盘 | 关键对话后的深度分析 | 总结经验教训，发现关系变化趋势 |
| 关系洞察 | 定期关系状态评估 | 从多维度分析关系发展阶段和问题 |

### 2.2 客观分析立场

AI军师必须保持绝对公正客观的立场：

1. **理论基础**：基于心理学、社会学、人类学经典理论
2. **分析角度**：从第三方客观视角分析，不带情感色彩
3. **判断标准**：使用公认的社交心理学标准进行评估
4. **建议原则**：提供理性、可行的建议，避免主观臆断

### 2.3 独立对话空间

AI军师提供与主应用隔离的对话环境：

1. **独立入口**：通过底部导航栏的专用入口进入
2. **独立数据**：对话历史与conversation_logs表分离存储
3. **独立上下文**：每个联系人有独立的对话会话
4. **独立提示词**：使用专门的AI军师提示词系统

---

## 3. 功能需求

### 3.1 核心对话功能

#### 3.1.1 AI军师对话界面

**需求描述**：提供类似普通AI对话应用的交互界面

**界面布局**：
```
┌─────────────────────────────────────┐
│ 顶部导航栏                          │
│ ├── 返回按钮    ├── 联系人选择器    │
├─────────────────────────────────────┤
│ 对话历史区域                        │
│ ├── AI消息（左侧）                  │
│ └── 用户消息（右侧）                │
├─────────────────────────────────────┤
│ 输入区域                            │
│ ├── 文本输入框    ├── 发送按钮        │
└─────────────────────────────────────┘
```

**验收标准**：
- [x] AI消息显示在左侧，用户消息显示在右侧
- [x] 支持长文本对话，自动换行显示
- [x] 支持对话历史滚动查看
- [x] 提供流畅的打字动画效果
- [x] 支持消息复制功能
- [x] 支持消息删除功能（仅删除当前会话）

#### 3.1.2 联系人选择与切换

**需求描述**：在AI军师对话界面内可以切换不同联系人

**交互设计**：
1. **联系人选择器**：顶部导航栏右侧的下拉选择器
2. **切换确认**：切换联系人时弹出确认对话框
3. **上下文清理**：确认切换后清空当前对话上下文
4. **会话保存**：当前对话自动保存到对应联系人的会话历史

**验收标准**：
- [x] 联系人选择器显示当前选中的联系人名称
- [x] 点击选择器显示联系人列表（按最近使用时间排序）
- [x] 切换联系人时显示确认对话框
- [x] 确认切换后界面刷新为初始状态
- [x] 切换前的对话自动保存
- [x] 切换回原联系人时能恢复历史对话

#### 3.1.3 对话会话管理

**需求描述**：为每个联系人维护独立的对话会话

**功能特性**：
1. **会话隔离**：每个联系人的对话完全独立
2. **自动保存**：每次对话后自动保存到本地
3. **会话恢复**：切换联系人时自动恢复该联系人的最新会话
4. **新建会话**：支持为同一联系人创建多个会话主题

**验收标准**：
- [x] 每个联系人有独立的对话历史
- [x] 对话内容实时保存，不会丢失
- [x] 切换联系人时自动恢复该联系人的对话
- [x] 支持为同一联系人创建新会话
- [x] 会话列表显示创建时间和最后消息预览

### 3.2 数据分析与关联

#### 3.2.1 对话历史数据源

**需求描述**：AI军师分析基于该联系人的完整对话历史

**数据来源**：
1. **主要来源**：conversation_logs表中该联系人的所有历史记录
2. **辅助数据**：联系人画像信息（facts、tags、目标等）
3. **实时数据**：当前AI军师对话的上下文

**数据处理**：
1. **时间排序**：按时间正序排列，构建完整对话流
2. **身份标识**：识别并标记对话中的发送者身份
3. **关键事件**：识别关系中的重要事件和转折点
4. **情感分析**：分析对话中的情感变化趋势

**验收标准**：
- [x] AI军师能访问该联系人的完整对话历史
- [x] 对话历史按时间正序排列
- [x] 正确识别对话中的发送者身份
- [x] 能从对话中提取关键关系事件
- [x] 能分析对话中的情感变化

#### 3.2.2 联系人画像集成

**需求描述**：AI军师分析时结合该联系人的画像信息

**集成数据**：
1. **基础信息**：联系人姓名、关系阶段、认识时间
2. **事实信息**：已记录的facts（生日、爱好、工作等）
3. **标签信息**：雷区标签和策略标签
4. **目标设定**：用户的攻略目标和关系定位

**应用方式**：
1. **背景上下文**：作为分析的基础背景信息
2. **个性化分析**：基于联系人特点提供针对性建议
3. **策略匹配**：结合标签信息提供符合策略的建议
4. **目标对齐**：确保分析与用户目标保持一致

**验收标准**：
- [x] AI军师分析时包含联系人的基础信息
- [x] 分析结果体现对已记录事实的理解
- [x] 建议符合雷区标签的约束
- [x] 分析方向与用户的攻略目标一致
- [x] 能根据关系阶段调整分析语气和深度

### 3.3 AI军师提示词系统

#### 3.3.1 专用提示词设计

**需求描述**：为AI军师功能设计专门的提示词系统

**设计原则**：
1. **客观立场**：强调第三方客观分析视角
2. **理论基础**：基于心理学、社会学、人类学经典理论
3. **理性分析**：避免主观臆断，提供理性判断
4. **实用建议**：给出具体可行的建议而非泛泛而谈

**提示词结构**：
```
你是一位专业的社交关系分析顾问（AI军师），具备心理学、社会学、人类学的专业背景。

【核心职责】
1. 基于提供的对话历史和联系人信息，进行客观、理性的分析
2. 从心理学角度分析双方的行为模式和情感变化
3. 从社会学角度评估关系发展阶段和动态
4. 从人类学角度理解文化背景对沟通的影响
5. 提供具体、可行的建议，帮助用户改善沟通质量

【分析原则】
- 保持绝对客观中立，不做道德评判
- 基于经典理论和公认标准进行分析
- 关注行为模式而非单次事件
- 提供建设性意见而非批评指责
- 尊重个体差异和文化背景

【输出要求】
- 分析要有理有据，引用相关理论支撑
- 建议要具体可行，避免空泛描述
- 语言要专业但不晦涩，易于理解
- 结构要清晰，便于用户理解和执行
```

**验收标准**：
- [x] AI军师回复保持客观中立立场
- [x] 分析内容体现心理学、社会学理论背景
- [x] 建议具体可行，避免空泛描述
- [x] 语言专业但不晦涩
- [x] 回复结构清晰，便于理解

#### 3.3.2 提示词编码实现

**需求描述**：将AI军师提示词硬编码到代码中

**实现方式**：
1. **常量定义**：在SystemPrompts.kt中新增AI_ADVISOR常量
2. **场景适配**：根据不同分析场景微调提示词
3. **变量插值**：支持插入联系人信息和对话历史
4. **版本管理**：预留提示词版本管理接口

**编码规范**：
1. **遵循三层分离架构**：系统约束层、用户指令层、运行时数据层
2. **避免硬编码字符串**：使用常量定义，便于维护
3. **支持多语言**：预留国际化支持
4. **文档注释**：详细说明提示词设计意图和使用场景

**验收标准**：
- [x] 提示词定义在SystemPrompts.kt中
- [x] 遵循三层分离架构
- [x] 支持变量插值
- [x] 包含完整的代码注释
- [x] 预留版本管理接口

---

## 4. 数据结构设计

### 4.1 AI军师对话记录表

**表名**：`ai_advisor_conversations`

**字段设计**：
```sql
CREATE TABLE ai_advisor_conversations (
    id TEXT PRIMARY KEY NOT NULL,                    -- 对话ID（UUID）
    contact_id TEXT NOT NULL,                         -- 联系人ID
    session_id TEXT NOT NULL,                         -- 会话ID（同一联系人的多个会话）
    message_type TEXT NOT NULL,                        -- 消息类型：user/ai
    content TEXT NOT NULL,                            -- 消息内容
    timestamp INTEGER NOT NULL,                        -- 时间戳
    created_at INTEGER NOT NULL,                        -- 创建时间
    FOREIGN KEY(contact_id) REFERENCES contact_profiles(id)
);

-- 索引
CREATE INDEX index_ai_advisor_conversations_contact_id ON ai_advisor_conversations(contact_id);
CREATE INDEX index_ai_advisor_conversations_session_id ON ai_advisor_conversations(session_id);
CREATE INDEX index_ai_advisor_conversations_timestamp ON ai_advisor_conversations(timestamp);
```

### 4.2 AI军师会话表

**表名**：`ai_advisor_sessions`

**字段设计**：
```sql
CREATE TABLE ai_advisor_sessions (
    id TEXT PRIMARY KEY NOT NULL,                      -- 会话ID（UUID）
    contact_id TEXT NOT NULL,                          -- 联系人ID
    title TEXT NOT NULL,                              -- 会话标题
    created_at INTEGER NOT NULL,                        -- 创建时间
    updated_at INTEGER NOT NULL,                        -- 最后更新时间
    message_count INTEGER DEFAULT 0,                    -- 消息数量
    is_active BOOLEAN DEFAULT 1,                      -- 是否为活跃会话
    FOREIGN KEY(contact_id) REFERENCES contact_profiles(id)
);

-- 索引
CREATE INDEX index_ai_advisor_sessions_contact_id ON ai_advisor_sessions(contact_id);
CREATE INDEX index_ai_advisor_sessions_created_at ON ai_advisor_sessions(created_at);
```

### 4.3 数据模型

**AiAdvisorConversation**：
```kotlin
@Entity(tableName = "ai_advisor_conversations")
data class AiAdvisorConversation(
    @PrimaryKey
    val id: String,
    val contactId: String,
    val sessionId: String,
    val messageType: MessageType,     // USER or AI
    val content: String,
    val timestamp: Long,
    val createdAt: Long = System.currentTimeMillis()
)

enum class MessageType {
    USER,
    AI
}
```

**AiAdvisorSession**：
```kotlin
@Entity(tableName = "ai_advisor_sessions")
data class AiAdvisorSession(
    @PrimaryKey
    val id: String,
    val contactId: String,
    val title: String,
    val createdAt: Long,
    val updatedAt: Long,
    val messageCount: Int = 0,
    val isActive: Boolean = true
)
```

---

## 5. 技术实现要点

### 5.1 数据库迁移

**迁移版本**：v12 → v13

```kotlin
val MIGRATION_12_13 = object : Migration(12, 13) {
    override fun migrate(database: SupportSQLiteDatabase) {
        // 创建ai_advisor_sessions表
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS ai_advisor_sessions (
                id TEXT PRIMARY KEY NOT NULL,
                contact_id TEXT NOT NULL,
                title TEXT NOT NULL,
                created_at INTEGER NOT NULL,
                updated_at INTEGER NOT NULL,
                message_count INTEGER DEFAULT 0,
                is_active INTEGER DEFAULT 1,
                FOREIGN KEY(contact_id) REFERENCES contact_profiles(id)
            )
        """)
        
        // 创建ai_advisor_conversations表
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS ai_advisor_conversations (
                id TEXT PRIMARY KEY NOT NULL,
                contact_id TEXT NOT NULL,
                session_id TEXT NOT NULL,
                message_type TEXT NOT NULL,
                content TEXT NOT NULL,
                timestamp INTEGER NOT NULL,
                created_at INTEGER NOT NULL,
                FOREIGN KEY(contact_id) REFERENCES contact_profiles(id)
            )
        """)
        
        // 创建索引
        database.execSQL("CREATE INDEX IF NOT EXISTS index_ai_advisor_sessions_contact_id ON ai_advisor_sessions(contact_id)")
        database.execSQL("CREATE INDEX IF NOT EXISTS index_ai_advisor_sessions_created_at ON ai_advisor_sessions(created_at)")
        database.execSQL("CREATE INDEX IF NOT EXISTS index_ai_advisor_conversations_contact_id ON ai_advisor_conversations(contact_id)")
        database.execSQL("CREATE INDEX IF NOT EXISTS index_ai_advisor_conversations_session_id ON ai_advisor_conversations(session_id)")
        database.execSQL("CREATE INDEX IF NOT EXISTS index_ai_advisor_conversations_timestamp ON ai_advisor_conversations(timestamp)")
    }
}
```

### 5.2 Repository接口设计

**AiAdvisorRepository**：
```kotlin
interface AiAdvisorRepository {
    // 会话管理
    suspend fun createSession(contactId: String, title: String): Result<String>
    suspend fun getSessions(contactId: String): Result<List<AiAdvisorSession>>
    suspend fun getActiveSession(contactId: String): Result<AiAdvisorSession?>
    suspend fun updateSessionTitle(sessionId: String, title: String): Result<Unit>
    suspend fun deleteSession(sessionId: String): Result<Unit>
    
    // 对话管理
    suspend fun saveMessage(sessionId: String, messageType: MessageType, content: String): Result<String>
    suspend fun getConversations(sessionId: String): Result<List<AiAdvisorConversation>>
    suspend fun deleteConversation(conversationId: String): Result<Unit>
    suspend fun clearSession(sessionId: String): Result<Unit>
    
    // 联系人对话历史（用于AI分析）
    suspend fun getContactConversationHistory(contactId: String): Result<List<ConversationLog>>
}
```

### 5.3 UseCase设计

**CreateAdvisorSessionUseCase**：
```kotlin
class CreateAdvisorSessionUseCase @Inject constructor(
    private val repository: AiAdvisorRepository
) {
    suspend operator fun invoke(
        contactId: String,
        title: String = "新对话"
    ): Result<String> {
        return repository.createSession(contactId, title)
    }
}
```

**SendAdvisorMessageUseCase**：
```kotlin
class SendAdvisorMessageUseCase @Inject constructor(
    private val repository: AiAdvisorRepository,
    private val aiRepository: AiRepository,
    private val getContactProfileUseCase: GetContactProfileUseCase,
    private val systemPrompts: SystemPrompts
) {
    suspend operator fun invoke(
        sessionId: String,
        contactId: String,
        message: String
    ): Result<String> {
        // 1. 保存用户消息
        repository.saveMessage(sessionId, MessageType.USER, message)
        
        // 2. 获取联系人画像和对话历史
        val profile = getContactProfileUseCase(contactId).getOrNull()
        val history = repository.getContactConversationHistory(contactId).getOrDefault(emptyList())
        
        // 3. 构建AI请求
        val prompt = buildAdvisorPrompt(profile, history, message)
        
        // 4. 调用AI
        val aiResponse = aiRepository.chat(prompt)
        
        // 5. 保存AI回复
        if (aiResponse.isSuccess) {
            repository.saveMessage(sessionId, MessageType.AI, aiResponse.getOrNull()?.content ?: "")
        }
        
        return aiResponse.map { it.content }
    }
    
    private fun buildAdvisorPrompt(
        profile: ContactProfile?,
        history: List<ConversationLog>,
        currentMessage: String
    ): String {
        // 构建包含联系人画像、对话历史和当前消息的完整提示词
        return systemPrompts.buildAiAdvisorPrompt(profile, history, currentMessage)
    }
}
```

---

## 6. 用户界面需求

### 6.1 底部导航栏集成

**入口位置**：主界面底部导航栏新增"AI军师"入口

**图标设计**：
- 使用军师/顾问相关的图标
- 风格与现有导航图标保持一致
- 支持选中/未选中两种状态

**导航逻辑**：
```kotlin
object NavRoutes {
    // 现有路由...
    const val AI_ADVISOR = "ai_advisor"
}

sealed class BottomNavItem(
    val route: String,
    val icon: ImageVector,
    val label: String
) {
    // 现有项目...
    object AIAdvisor : BottomNavItem(
        route = NavRoutes.AI_ADVISOR,
        icon = Icons.Default.Psychology, // 示例图标
        label = "AI军师"
    )
}
```

**验收标准**：
- [x] 底部导航栏显示"AI军师"入口
- [x] 图标风格与现有导航图标一致
- [x] 点击能正确跳转到AI军师页面
- [x] 支持选中状态高亮显示

### 6.2 AI军师主界面

**页面结构**：
```
┌─────────────────────────────────────┐
│ 顶部导航栏                          │
│ ├── 返回按钮    ├── 联系人选择器    │
├─────────────────────────────────────┤
│ 会话列表（如有多个会话）            │
│ ├── 会话1（最新）                  │
│ ├── 会话2                          │
│ └── 新建会话按钮                   │
├─────────────────────────────────────┤
│ 对话区域（当前会话）                │
│ ├── AI消息（左侧）                  │
│ └── 用户消息（右侧）                │
├─────────────────────────────────────┤
│ 输入区域                            │
│ ├── 文本输入框    ├── 发送按钮        │
└─────────────────────────────────────┘
```

**交互设计**：
1. **首次进入**：显示联系人选择器，选择后创建新会话
2. **多会话管理**：顶部显示会话列表，可切换不同会话
3. **新建会话**：提供新建会话按钮，可自定义会话标题
4. **对话交互**：类似普通聊天应用的交互方式

**验收标准**：
- [x] 首次进入显示联系人选择器
- [x] 支持多会话管理和切换
- [x] 支持新建会话并自定义标题
- [x] 对话交互流畅自然
- [x] 消息显示正确（AI左，用户右）

### 6.3 联系人选择器

**设计规格**：
- **位置**：顶部导航栏右侧
- **样式**：下拉选择器，显示当前联系人名称
- **交互**：点击展开联系人列表，选择后确认切换

**状态管理**：
```kotlin
data class AiAdvisorUiState(
    val currentContactId: String? = null,
    val currentContactName: String = "选择联系人",
    val showContactSelector: Boolean = false,
    val contactList: List<ContactProfile> = emptyList(),
    val showSwitchConfirmDialog: Boolean = false,
    val pendingContactId: String? = null
)
```

**验收标准**：
- [x] 选择器显示当前联系人名称
- [x] 点击展开联系人列表
- [x] 列表按最近使用时间排序
- [x] 切换时显示确认对话框
- [x] 确认后正确切换到新联系人

---

## 7. 非功能需求

### 7.1 性能要求

- **对话加载时间**：< 200ms
- **消息发送响应时间**：< 500ms
- **联系人切换时间**：< 300ms
- **数据库查询时间**：< 100ms

### 7.2 存储要求

- **对话数据本地存储**：不上传到服务器
- **数据加密**：敏感对话内容使用AES加密
- **存储空间**：AI军师数据占用< 10MB
- **数据备份**：支持导出备份功能

### 7.3 兼容性要求

- **向后兼容**：不影响现有功能正常运行
- **数据迁移**：升级时平滑迁移现有数据
- **版本兼容**：支持旧版本数据的读取和转换

---

## 8. 不包含的功能（后续版本）

- [ ] AI军师提示词用户自定义功能
- [ ] 对话分析和建议的图表化展示
- [ ] 多人关系分析（三角关系、群体关系）
- [ ] AI军师分析的分享功能
- [ ] 基于地理位置的文化背景分析
- [ ] 语音输入和语音回复功能

---

## 9. 验收标准

### 9.1 功能验收

- [x] 底部导航栏正确显示AI军师入口
- [x] 联系人选择器正常工作
- [x] 对话界面显示正确（AI左，用户右）
- [x] 消息发送和接收功能正常
- [x] 联系人切换时正确保存和恢复对话
- [x] AI分析基于联系人完整对话历史
- [x] AI军师保持客观公正的分析立场
- [x] 数据正确保存到本地数据库

### 9.2 性能验收

- [x] 对话加载时间< 200ms
- [x] 消息发送响应时间< 500ms
- [x] 联系人切换时间< 300ms
- [x] 数据库查询时间< 100ms

### 9.3 用户体验验收

- [x] 界面交互流畅自然
- [x] 联系人切换操作简单直观
- [x] AI分析内容专业且实用
- [x] 对话历史保存完整不丢失
- [x] 错误处理友好，有明确提示

---

## 10. 风险评估

| 风险 | 等级 | 缓解措施 |
|-----|------|---------|
| AI军师分析不够客观 | 中 | 严格设计提示词，强调客观立场，基于经典理论 |
| 对话历史数据量大影响性能 | 中 | 实现分页加载，优化数据库查询 |
| 用户对AI军师功能理解偏差 | 低 | 提供清晰的功能说明和使用引导 |
| 联系人切换操作复杂 | 低 | 简化切换流程，提供确认机制 |
| 数据存储空间增长过快 | 低 | 实现数据清理机制，定期清理过期数据 |

---

## 11. 实现计划

### 阶段1：数据层实现（预计1天）
1. 创建AiAdvisorConversation和AiAdvisorSession数据模型
2. 实现数据库迁移脚本
3. 创建AiAdvisorDao和AiAdvisorRepository
4. 编写数据层单元测试

### 阶段2：领域层实现（预计1天）
1. 创建相关UseCase（CreateAdvisorSessionUseCase、SendAdvisorMessageUseCase等）
2. 实现AI军师提示词系统
3. 集成联系人画像和对话历史数据
4. 编写领域层单元测试

### 阶段3：界面层实现（预计1.5天）
1. 创建AiAdvisorScreen主界面
2. 实现联系人选择器组件
3. 实现对话界面和消息组件
4. 集成到底部导航栏
5. 编写UI层单元测试

### 阶段4：集成测试与优化（预计0.5天）
1. 端到端功能测试
2. 性能优化和内存泄漏检查
3. 错误处理和边界情况测试
4. 用户体验优化

**总预计工作量**：4天

---

## 12. 相关文档

- [PRD-00007-对话上下文连续性增强需求](./PRD-00007-对话上下文连续性增强需求.md)
- [PRD-00008-输入内容身份识别与双向对话历史需求](./PRD-00008-输入内容身份识别与双向对话历史需求.md)
- [PRD-00005-提示词管理系统需求](./PRD-00005-提示词管理系统需求.md)
- [提示词系统三层分离架构设计](../../特殊要求/提示词系统三层分离架构设计.md)