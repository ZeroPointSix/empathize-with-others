# PRD-00027: 项目修复需求

> **文档类型**: 产品需求文档 (PRD)
> **版本**: 1.0
> **创建日期**: 2026-01-01
> **更新日期**: 2026-01-01
> **负责人**: 产品经理
> **状态**: 📝 草案
> **优先级**: 🔴 高
> **预计工期**: 18天

---

## 🎯 核心目标

**基于MA文档分析结果，系统性地解决项目在代码质量、架构设计和测试覆盖率方面存在的问题，提升项目的整体质量和可维护性**

---

## 📋 需求背景

### 1.1 问题陈述

基于MA文档分析的结果，项目在代码质量、架构设计和测试覆盖率方面存在多个需要修复的问题。这些问题按严重程度分为P0（严重）、P1（中等）和P2（轻微）三个级别。

### 1.2 影响范围

| 问题级别 | 数量 | 影响描述 |
|----------|------|----------|
| P0严重问题 | 1 | 影响基本构建和测试功能 |
| P1中等问题 | 6 | 影响代码质量和架构合理性 |
| P2轻微问题 | 4 | 影响代码结构和可维护性 |

### 1.3 修复目标

- 解决P0严重问题，确保项目基本构建和测试功能正常
- 修复P1中等问题，提升代码质量和架构合理性
- 优化P2轻微问题，改善代码结构和可维护性
- 提高测试覆盖率，特别是Domain层的UseCase测试
- 确保项目符合Clean Architecture最佳实践

---

## 🔍 问题清单

### 2.1 P0严重问题

#### 2.1.1 构建配置问题
- **问题描述**: app模块定义了dev构建变体，但presentation和data模块没有对应变体
- **影响范围**: 
  - 无法执行testDevUnitTest任务
  - IDE中选择dev变体会失败
  - 影响开发和测试流程
- **修复建议**: 在presentation和data模块添加dev构建变体
- **预估工时**: 0.5天

### 2.2 P1中等问题

#### 2.2.1 UseCase测试覆盖不足（高优先级）
- **问题描述**: Domain层有36个UseCase文件，但测试覆盖率为0%
- **影响范围**: 
  - 核心业务逻辑缺乏测试保障
  - 代码质量风险高
  - 重构和维护困难
- **修复建议**: 
  - 为所有UseCase编写单元测试
  - 建立测试覆盖率监控机制
  - 设置最低测试覆盖率标准
- **预估工时**: 5天

#### 2.2.2 FallbackHandler接口未实现（高优先级）
- **问题描述**: 接口存在但无实现类
- **影响范围**: 
  - 缺少降级处理能力
  - 系统健壮性不足
  - 异常情况下用户体验差
- **修复建议**: 
  - 实现FallbackHandler接口
  - 设计合理的降级策略
  - 添加相应的测试用例
- **预估工时**: 1天

#### 2.2.3 Parser接口职责不清晰（高优先级）
- **问题描述**: 接口定义清晰但缺少实现
- **影响范围**: 
  - 缺少统一的解析能力
  - 解析逻辑分散在多处
  - 代码重复和维护困难
- **修复建议**: 
  - 实现Parser接口
  - 统一解析逻辑
  - 重构现有解析代码
- **预估工时**: 2天

#### 2.2.4 AiRepositoryImpl文件过大（中优先级）
- **问题描述**: 906行，包含大量解析逻辑
- **影响范围**: 
  - 单一文件承担过多职责
  - 可读性和维护性差
  - 违反单一职责原则
- **修复建议**: 
  - 按功能拆分AiRepositoryImpl
  - 将解析逻辑抽取到独立类
  - 重新设计类结构
- **预估工时**: 2天

#### 2.2.5 重复的Debug版本ViewModel（中优先级）
- **问题描述**: 存在ContactDetailTabViewModelDebug.kt和ContactDetailTabViewModelWithDebug.kt
- **影响范围**: 
  - 代码重复
  - 维护成本高
  - 可能导致功能不一致
- **修复建议**: 
  - 合并重复的Debug版本ViewModel
  - 统一调试功能实现
  - 清理冗余代码
- **预估工时**: 0.5天

#### 2.2.6 Presentation层component目录过度细分（中优先级）
- **问题描述**: 26个子目录，部分目录文件数很少
- **影响范围**: 
  - 增加导航复杂度
  - 开发效率低
  - 项目结构不清晰
- **修复建议**: 
  - 合并文件较少的目录
  - 重新设计目录结构
  - 优化组件组织方式
- **预估工时**: 1天

### 2.3 P2轻微问题

#### 2.3.1 PrivacyEngine职责可拆分
- **问题描述**: 同时包含敏感信息检测和脱敏两种职责
- **影响范围**: 
  - 违反单一职责原则
  - 耦合度高
  - 测试困难
- **修复建议**: 
  - 拆分为PrivacyDetector和PrivacyMasker两个类
  - 通过接口进行交互
  - 更新相关测试
- **预估工时**: 1天

#### 2.3.2 PromptBuilder部分方法逻辑较复杂
- **问题描述**: buildSystemInstruction和buildWithTopic方法内部逻辑较复杂
- **影响范围**: 
  - 可读性和维护性差
  - 测试覆盖困难
  - 潜在bug风险高
- **修复建议**: 
  - 重构复杂方法
  - 拆分为多个小方法
  - 增加单元测试
- **预估工时**: 1天

#### 2.3.3 UseCase错误处理可抽象
- **问题描述**: 多个UseCase中存在相似的try-catch错误处理代码
- **影响范围**: 
  - 代码重复
  - 错误处理不一致
  - 维护成本高
- **修复建议**: 
  - 抽象公共错误处理逻辑
  - 创建错误处理基类或工具类
  - 统一错误处理模式
- **预估工时**: 1天

#### 2.3.4 部分解析代码重复
- **问题描述**: AiRepositoryImpl中解析方法有相似结构
- **影响范围**: 
  - 代码重复
  - 维护成本高
  - 不一致风险
- **修复建议**: 
  - 抽取公共解析逻辑
  - 创建解析工具类
  - 重构现有解析方法
- **预估工时**: 1天

---

## 📅 修复计划

### 3.1 立即执行（第1周）

#### 3.1.1 P0问题修复
- **任务**: 修复构建配置问题
- **负责人**: Kiro
- **时间安排**: 第1天
- **具体工作**:
  - 在presentation模块添加dev构建变体
  - 在data模块添加dev构建变体
  - 验证testDevUnitTest任务可正常执行
  - 验证IDE中可选择dev变体

#### 3.1.2 P1高优先级问题修复
- **任务**: 实现FallbackHandler和Parser接口
- **负责人**: Kiro
- **时间安排**: 第2-3天
- **具体工作**:
  - 实现FallbackHandler接口及降级策略
  - 实现Parser接口及统一解析逻辑
  - 添加相应测试用例
  - 验证功能正确性

### 3.2 短期执行（第2-3周）

#### 3.2.1 UseCase测试覆盖
- **任务**: 为Domain层UseCase编写单元测试
- **负责人**: Kiro
- **时间安排**: 第4-8天
- **具体工作**:
  - 分析36个UseCase的功能和依赖
  - 编写单元测试用例
  - 设置测试覆盖率监控
  - 确保测试覆盖率达到80%以上

#### 3.2.2 代码结构优化
- **任务**: 拆分大文件和合并重复代码
- **负责人**: Kiro
- **时间安排**: 第9-12天
- **具体工作**:
  - 拆分AiRepositoryImpl文件
  - 合并重复的Debug版本ViewModel
  - 优化Presentation层component目录结构
  - 重构解析代码，消除重复

### 3.3 中期执行（第4周）

#### 3.3.1 代码质量提升
- **任务**: 解决P2轻微问题
- **负责人**: Kiro
- **时间安排**: 第13-16天
- **具体工作**:
  - 拆分PrivacyEngine职责
  - 重构PromptBuilder复杂方法
  - 抽象UseCase错误处理逻辑
  - 优化解析代码结构

#### 3.3.2 测试和验证
- **任务**: 全面测试修复结果
- **负责人**: Roo
- **时间安排**: 第17-18天
- **具体工作**:
  - 执行完整测试套件
  - 验证所有修复功能
  - 检查代码质量指标
  - 生成修复报告

### 3.4 资源分配和依赖关系

| 任务 | 负责人 | 依赖关系 | 所需资源 |
|------|--------|----------|----------|
| 构建配置修复 | Kiro | 无 | 开发环境 |
| 接口实现 | Kiro | 构建配置修复 | 开发环境 |
| UseCase测试覆盖 | Kiro | 接口实现 | 测试环境 |
| 代码结构优化 | Kiro | UseCase测试覆盖 | 开发环境 |
| 代码质量提升 | Kiro | 代码结构优化 | 开发环境 |
| 测试和验证 | Roo | 代码质量提升 | 测试环境 |

---

## ✅ 验收标准

### 4.1 P0问题验收标准
- [ ] presentation和data模块成功添加dev构建变体
- [ ] testDevUnitTest任务可正常执行
- [ ] IDE中可选择dev变体且无错误提示
- [ ] 所有构建变体均可正常编译和运行

### 4.2 P1问题验收标准
- [ ] Domain层UseCase测试覆盖率达到80%以上
- [ ] FallbackHandler接口已实现且功能正常
- [ ] Parser接口已实现且统一了解析逻辑
- [ ] AiRepositoryImpl文件拆分完成，单一文件不超过500行
- [ ] 重复的Debug版本ViewModel已合并
- [ ] Presentation层component目录结构优化完成

### 4.3 P2问题验收标准
- [ ] PrivacyEngine已拆分为PrivacyDetector和PrivacyMasker
- [ ] PromptBuilder复杂方法已重构，方法复杂度降低
- [ ] UseCase错误处理逻辑已抽象和统一
- [ ] 解析代码重复已消除

### 4.4 整体修复验收标准
- [ ] 所有P0、P1、P2问题已按标准修复
- [ ] 项目整体测试覆盖率不低于85%
- [ ] 代码质量检查通过，无严重警告
- [ ] 构建和测试流程完全正常
- [ ] 所有修复功能已通过集成测试
- [ ] 文档已更新，反映最新代码结构

---

## ⚠️ 风险评估

### 5.1 技术风险

#### 5.1.1 构建配置修改风险
- **风险描述**: 修改构建配置可能导致现有功能异常
- **影响程度**: 中
- **发生概率**: 低
- **应对措施**: 
  - 在修改前备份原始配置
  - 分步骤进行修改和验证
  - 保留回滚方案

#### 5.1.2 接口实现风险
- **风险描述**: 新实现的接口可能与现有代码不兼容
- **影响程度**: 中
- **发生概率**: 中
- **应对措施**: 
  - 详细分析接口使用场景
  - 编写全面的测试用例
  - 采用渐进式实现策略

#### 5.1.3 代码重构风险
- **风险描述**: 大规模代码重构可能引入新的bug
- **影响程度**: 高
- **发生概率**: 中
- **应对措施**: 
  - 分模块逐步重构
  - 每次重构后立即测试
  - 保留重构前代码备份

### 5.2 项目风险

#### 5.2.1 时间延期风险
- **风险描述**: 修复工作量可能超出预期
- **影响程度**: 中
- **发生概率**: 中
- **应对措施**: 
  - 预留20%的缓冲时间
  - 优先修复P0和P1问题
  - P2问题可根据时间情况调整

#### 5.2.2 资源冲突风险
- **风险描述**: 开发资源可能被其他高优先级任务占用
- **影响程度**: 中
- **发生概率**: 低
- **应对措施**: 
  - 提前协调资源分配
  - 明确任务优先级
  - 准备备选资源方案

### 5.3 质量风险

#### 5.3.1 测试覆盖不足风险
- **风险描述**: 测试用例可能无法覆盖所有场景
- **影响程度**: 中
- **发生概率**: 中
- **应对措施**: 
  - 使用测试覆盖率工具
  - 进行代码审查
  - 执行多种测试类型

#### 5.3.2 回归风险
- **风险描述**: 修复可能引入新的问题或导致原有功能异常
- **影响程度**: 高
- **发生概率**: 中
- **应对措施**: 
  - 执行全面的回归测试
  - 建立自动化测试流程
  - 监控生产环境表现

---

## 📎 附录

### 6.1 相关文档引用
- [MA文档分析报告](../../CODE_ANALYSIS/Love/full_analysis_report.md)
- [Clean Architecture设计文档](../../文档/开发文档/TDD/TDD-00017-CleanArchitecture模块化改造技术设计.md)
- [测试规范文档](../../Rules/测试规范.md)
- [代码质量标准](../../Rules/代码质量标准.md)

### 6.2 术语解释
- **P0问题**: 严重问题，影响系统基本功能，必须立即修复
- **P1问题**: 中等问题，影响系统质量，应在短期内修复
- **P2问题**: 轻微问题，不影响系统功能，可在中长期修复
- **UseCase**: 用例，Domain层中封装特定业务逻辑的类
- **Clean Architecture**: 一种分层架构模式，强调依赖倒置和职责分离
- **测试覆盖率**: 衡量测试代码覆盖源代码比例的指标

### 6.3 交付物清单
- [ ] 修复后的源代码
- [ ] 单元测试代码
- [ ] 集成测试报告
- [ ] 代码质量报告
- [ ] 修复总结文档
- [ ] 更新的技术文档

---

## 📋 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2026-01-01 | 初始版本，定义项目修复需求 | 产品经理 |

---

**文档版本**: 1.0
**最后更新**: 2026-01-01
**文档状态**: 📝 草案