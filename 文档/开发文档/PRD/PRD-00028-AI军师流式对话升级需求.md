# PRD-00028 AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§éœ€æ±‚

## 1. æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç±»å‹ | PRD (Product Requirements Document) |
| æ–‡æ¡£ç¼–å· | PRD-00028 |
| åŠŸèƒ½åç§° | AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§ |
| ç‰ˆæœ¬ | 1.2 |
| åˆ›å»ºæ—¥æœŸ | 2026-01-04 |
| æœ€åæ›´æ–° | 2026-01-04 |
| ä½œè€… | AI Assistant |
| çŠ¶æ€ | å®¡æŸ¥é€šè¿‡ |
| å…³è”æ–‡æ¡£ | PRD-00026ï¼ˆAIå†›å¸ˆå¯¹è¯åŠŸèƒ½éœ€æ±‚ï¼‰ã€RESEARCH-00003ã€RESEARCH-00004ã€TDD-00028 |

---

## 2. äº§å“æ¦‚è¿°

### 2.0 ä¸PRD-00026çš„å…¼å®¹æ€§è¯´æ˜

#### å…¼å®¹å˜æ›´
- `AdvisorMessageStatus`æ–°å¢STREAMINGã€STOPPEDçŠ¶æ€ï¼ˆå‘åå…¼å®¹ï¼‰
- `AiAdvisorConversation`è¡¨ç»“æ„ä¸å˜ï¼Œæ–°å¢statuså­—æ®µæ”¯æŒæ›´å¤šçŠ¶æ€

#### æ–°å¢è¡¨
- `ai_advisor_message_blocks`ï¼ˆP0æ–°å¢ï¼Œå­˜å‚¨æ¶ˆæ¯å—ï¼‰

#### åºŸå¼ƒåŠŸèƒ½
- æ— åºŸå¼ƒåŠŸèƒ½ï¼Œ`SendAdvisorMessageUseCase`ä¿ç•™ä½œä¸ºéæµå¼å¤‡é€‰

#### é™çº§ç­–ç•¥

| åœºæ™¯ | ä½¿ç”¨ç‰ˆæœ¬ | åŸå›  |
|------|---------|------|
| ç”¨æˆ·ä¸»åŠ¨ç¦ç”¨æµå¼ | éæµå¼ç‰ˆæœ¬ | ç”¨æˆ·åå¥½è®¾ç½® |
| Providerä¸æ”¯æŒSSE | éæµå¼ç‰ˆæœ¬ | æŠ€æœ¯é™åˆ¶ |
| ç½‘ç»œä¸ç¨³å®šï¼ˆè¿ç»­3æ¬¡SSEå¤±è´¥ï¼‰ | éæµå¼ç‰ˆæœ¬ | æå‡æˆåŠŸç‡ |
| é»˜è®¤åœºæ™¯ | æµå¼ç‰ˆæœ¬ | æœ€ä½³ä½“éªŒ |

#### æ¨¡å—åˆ†å¸ƒè¯´æ˜

| ç±»/æ¥å£ | æ‰€åœ¨æ¨¡å— | åŸå›  |
|--------|---------|------|
| AiStreamChunk | :domain | çº¯æ•°æ®æ¨¡å‹ï¼ŒThrowableæ˜¯Kotlinæ ‡å‡†åº“ç±» |
| MessageBlockType | :domain | æšä¸¾å®šä¹‰ï¼Œæ— Androidä¾èµ– |
| MessageBlockStatus | :domain | æšä¸¾å®šä¹‰ï¼Œæ— Androidä¾èµ– |
| AiAdvisorMessageBlock | :domain | é¢†åŸŸæ¨¡å‹ï¼Œæ— Androidä¾èµ– |
| SseStreamReader | :data | ä½¿ç”¨OkHttp EventSourceï¼Œéœ€è¦Androidç¯å¢ƒ |
| BlockUpdateManager | :data | æ•°æ®åº“æ“ä½œï¼Œéœ€è¦Room |
| SendAdvisorMessageStreamingUseCase | :domain | ä¸šåŠ¡é€»è¾‘ï¼Œæ— Androidä¾èµ– |
| AiAdvisorChatViewModel | :presentation | UIçŠ¶æ€ç®¡ç†ï¼Œä½¿ç”¨Hilt |

### 2.1 å‡çº§èƒŒæ™¯

PRD-00026å·²å®ç°AIå†›å¸ˆåŸºç¡€å¯¹è¯åŠŸèƒ½ï¼Œä½†å­˜åœ¨ä»¥ä¸‹ä½“éªŒé—®é¢˜ï¼š

1. **å“åº”ç­‰å¾…æ—¶é—´é•¿**ï¼šç”¨æˆ·å‘é€æ¶ˆæ¯åéœ€ç­‰å¾…AIå®Œæ•´å“åº”ï¼Œæ— æ³•çœ‹åˆ°å®æ—¶è¿›åº¦
2. **æ— æ€è€ƒè¿‡ç¨‹å±•ç¤º**ï¼šDeepSeek R1ç­‰æ¨¡å‹çš„æ€è€ƒè¿‡ç¨‹æ— æ³•å±•ç¤ºç»™ç”¨æˆ·
3. **æ¶ˆæ¯ç»“æ„å•ä¸€**ï¼šå½“å‰æ¶ˆæ¯åªæ”¯æŒçº¯æ–‡æœ¬ï¼Œæ— æ³•æ”¯æŒå¤æ‚å†…å®¹ç»„åˆ
4. **æ— æ³•ä¸­é€”å–æ¶ˆ**ï¼šç”¨æˆ·æ— æ³•å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„AIè¯·æ±‚

### 2.2 å‡çº§ç›®æ ‡

å‚è€ƒCherry Studioçš„ä¼˜ç§€è®¾è®¡ï¼Œå®ç°ï¼š

1. **æµå¼å“åº”**ï¼šAIå›å¤é€å­—æ˜¾ç¤ºï¼Œæå‡ç”¨æˆ·ä½“éªŒ
2. **æ€è€ƒè¿‡ç¨‹å±•ç¤º**ï¼šå±•ç¤ºAIçš„æ€è€ƒè¿‡ç¨‹ï¼ˆæ”¯æŒDeepSeek R1ç­‰æ¨¡å‹ï¼‰
3. **Blockæ¶æ„**ï¼šæ¶ˆæ¯æ”¯æŒå¤šç§å†…å®¹å—ç»„åˆ
4. **è¯·æ±‚æ§åˆ¶**ï¼šæ”¯æŒå–æ¶ˆ/æš‚åœæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚

### 2.3 å‚è€ƒè®¾è®¡

æœ¬PRDè®¾è®¡å®Œå…¨å‚è€ƒCherry Studioçš„å®ç°ï¼Œä¸»è¦å€Ÿé‰´ï¼š
- Block-basedæ¶ˆæ¯æ¶æ„
- ChunkTypeæµå¼äº‹ä»¶åè®®
- BlockManageræ™ºèƒ½èŠ‚æµæ›´æ–°ç­–ç•¥
- æ¶ˆæ¯çŠ¶æ€ç®¡ç†æœºåˆ¶

### 2.4 Cherry Studioæ ¸å¿ƒåŠŸèƒ½å¯¹æ¯”

| Cherry StudioåŠŸèƒ½ | è¯´æ˜ | æœ¬PRDçŠ¶æ€ |
|------------------|------|----------|
| **Block-basedæ¶ˆæ¯æ¶æ„** | æ¶ˆæ¯æ‹†åˆ†ä¸ºMAIN_TEXTã€THINKINGã€TOOLç­‰å¤šä¸ªBlock | âœ… P0å®ç° |
| **ChunkTypeæµå¼åè®®** | TEXT_DELTAã€THINKING_DELTAç­‰ç»Ÿä¸€äº‹ä»¶ç±»å‹ | âœ… P0å®ç° |
| **BlockManageræ™ºèƒ½èŠ‚æµ** | å—ç±»å‹å˜åŒ–ç«‹å³å†™å…¥ï¼ŒåŒç±»å‹èŠ‚æµæ›´æ–° | âœ… P1å®ç° |
| **æ€è€ƒè¿‡ç¨‹å±•ç¤º** | DeepSeek R1ç­‰æ¨¡å‹çš„reasoning_contentå±•ç¤º | âœ… P0å®ç° |
| **è¯·æ±‚å–æ¶ˆæ§åˆ¶** | æš‚åœ/å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„AIè¯·æ±‚ | âœ… P1å®ç° |
| **å¤šçº§ç¼“å­˜ç­–ç•¥** | æ°¸ä¹…ç¼“å­˜+LRUç¼“å­˜+TTLç¼“å­˜ | â³ P2åç»­ |
| **Observerè®¢é˜…æ¨¡å¼** | useSyncExternalStoreå®æ—¶UIæ›´æ–° | âš ï¸ Room Flowæ›¿ä»£ |
| **ä¹è§‚æ›´æ–°** | å…ˆæ›´æ–°UIï¼ŒåæŒä¹…åŒ–ï¼Œå¤±è´¥å›æ»š | âš ï¸ éƒ¨åˆ†å®ç° |
| **è™šæ‹Ÿåˆ—è¡¨ä¼˜åŒ–** | LegendList + recycleItems | â³ P2åç»­ |
| **å¤šæ¨¡å‹å¹¶è¡Œå“åº”** | Mentionsæœºåˆ¶@å¤šä¸ªæ¨¡å‹ | â³ P3åç»­ |
| **å·¥å…·è°ƒç”¨Block** | MCPå·¥å…·è°ƒç”¨ç»“æœå±•ç¤º | â³ P3åç»­ |
| **ä»£ç å—é«˜äº®** | è¯­æ³•é«˜äº®æ¸²æŸ“ | â³ P3åç»­ |

---

## 3. æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

### 3.1 æµå¼å“åº”ï¼ˆP0 - å¿…é¡»å®ç°ï¼‰

#### 3.1.1 åŠŸèƒ½æè¿°

ç”¨æˆ·å‘é€æ¶ˆæ¯åï¼ŒAIå›å¤é€å­—æ˜¾ç¤ºï¼Œè€Œéç­‰å¾…å®Œæ•´å“åº”åä¸€æ¬¡æ€§æ˜¾ç¤ºã€‚

#### 3.1.2 ç”¨æˆ·ä½“éªŒ

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
ç«‹å³æ˜¾ç¤ºAIæ¶ˆæ¯å ä½ï¼ˆçŠ¶æ€ï¼šç­‰å¾…ä¸­ï¼‰
    â†“
å¼€å§‹æ¥æ”¶æµå¼å“åº”ï¼ˆçŠ¶æ€ï¼šç”Ÿæˆä¸­ï¼‰
    â†“
æ–‡å­—é€å­—æ˜¾ç¤ºï¼Œå¸¦æ‰“å­—æœºæ•ˆæœ
    â†“
å“åº”å®Œæˆï¼ˆçŠ¶æ€ï¼šæˆåŠŸï¼‰
```

#### 3.1.3 éªŒæ”¶æ ‡å‡†

- [ ] ç”¨æˆ·å‘é€æ¶ˆæ¯åï¼Œç«‹å³æ˜¾ç¤ºAIæ¶ˆæ¯å ä½
- [ ] AIå›å¤é€å­—æ˜¾ç¤ºï¼Œæœ‰æ˜æ˜¾çš„æ‰“å­—æœºæ•ˆæœ
- [ ] æ˜¾ç¤º"AIæ­£åœ¨æ€è€ƒ..."çš„åŠ è½½çŠ¶æ€
- [ ] æµå¼å“åº”è¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ°å®æ—¶å­—æ•°ç»Ÿè®¡
- [ ] å“åº”å®ŒæˆåçŠ¶æ€æ­£ç¡®æ›´æ–°ä¸º"æˆåŠŸ"
- [ ] ç½‘ç»œé”™è¯¯æ—¶çŠ¶æ€æ›´æ–°ä¸º"å¤±è´¥"ï¼Œæ˜¾ç¤ºé‡è¯•æŒ‰é’®

#### 3.1.4 æŠ€æœ¯å‚è€ƒï¼ˆCherry Studioï¼‰

```typescript
// Cherry Studioçš„ChunkTypeå®šä¹‰
export enum ChunkType {
  TEXT_START = 'text.start',
  TEXT_DELTA = 'text.delta',
  TEXT_COMPLETE = 'text.complete',
  ERROR = 'error',
  BLOCK_COMPLETE = 'block_complete'
}
```

---

### 3.2 æ€è€ƒè¿‡ç¨‹å±•ç¤ºï¼ˆP0 - å¿…é¡»å®ç°ï¼‰

#### 3.2.1 åŠŸèƒ½æè¿°

å±•ç¤ºAIçš„æ€è€ƒè¿‡ç¨‹ï¼Œç‰¹åˆ«æ˜¯DeepSeek R1ç­‰æ”¯æŒreasoningçš„æ¨¡å‹ã€‚

#### 3.2.2 UIè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ§  æ€è€ƒè¿‡ç¨‹ (2.3s)              [æ”¶èµ·â–²] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·é—®çš„æ˜¯å…³äºçº¦ä¼šçš„é—®é¢˜ï¼Œæˆ‘éœ€è¦å…ˆ     â”‚
â”‚ åˆ†æä¸€ä¸‹å¯¹æ–¹çš„æ€§æ ¼ç‰¹ç‚¹...               â”‚
â”‚ æ ¹æ®è”ç³»äººç”»åƒï¼Œå¥¹æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ•æ„Ÿçš„äºº... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ å›å¤                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ ¹æ®æˆ‘çš„åˆ†æï¼Œå»ºè®®ä½ è¿™æ ·å›å¤...         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.3 éªŒæ”¶æ ‡å‡†

- [ ] æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºåœ¨ç‹¬ç«‹çš„å¯æŠ˜å åŒºåŸŸ
- [ ] æ˜¾ç¤ºæ€è€ƒè€—æ—¶ï¼ˆå¦‚"2.3s"ï¼‰
- [ ] é»˜è®¤å±•å¼€ï¼Œç”¨æˆ·å¯ä»¥ç‚¹å‡»æ”¶èµ·
- [ ] æ€è€ƒè¿‡ç¨‹å’Œä¸»æ–‡æœ¬åˆ†å¼€æ˜¾ç¤º
- [ ] æ€è€ƒè¿‡ç¨‹ä½¿ç”¨ä¸åŒçš„èƒŒæ™¯è‰²åŒºåˆ†
- [ ] ä¸æ”¯æŒæ€è€ƒè¿‡ç¨‹çš„æ¨¡å‹ä¸æ˜¾ç¤ºæ­¤åŒºåŸŸ

#### 3.2.4 æŠ€æœ¯å‚è€ƒï¼ˆCherry Studioï¼‰

```typescript
// Cherry Studioçš„æ€è€ƒè¿‡ç¨‹Chunk
export enum ChunkType {
  THINKING_START = 'thinking.start',
  THINKING_DELTA = 'thinking.delta',
  THINKING_COMPLETE = 'thinking.complete',
}

// æ€è€ƒè¿‡ç¨‹å…ƒæ•°æ®
interface ThinkingMetadata {
  thinking_millsec: number  // æ€è€ƒè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
}
```

---

### 3.3 Blockæ¶æ„ï¼ˆP0 - å¿…é¡»å®ç°ï¼‰

#### 3.3.1 åŠŸèƒ½æè¿°

å°†æ¶ˆæ¯æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„Blockï¼Œæ”¯æŒå¤æ‚å†…å®¹ç»„åˆã€‚

#### 3.3.2 Blockç±»å‹å®šä¹‰

| Blockç±»å‹ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|-----------|------|--------|
| MAIN_TEXT | ä¸»æ–‡æœ¬å†…å®¹ | P0 |
| THINKING | æ€è€ƒè¿‡ç¨‹ | P0 |
| ERROR | é”™è¯¯ä¿¡æ¯ | P0 |
| CODE | ä»£ç å—ï¼ˆæœªæ¥æ‰©å±•ï¼‰ | P2 |
| TOOL | å·¥å…·è°ƒç”¨ï¼ˆæœªæ¥æ‰©å±•ï¼‰ | P2 |

#### 3.3.3 BlockçŠ¶æ€å®šä¹‰

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| PENDING | ç­‰å¾…å¤„ç† |
| STREAMING | æµå¼æ¥æ”¶ä¸­ |
| SUCCESS | æˆåŠŸå®Œæˆ |
| ERROR | å‘ç”Ÿé”™è¯¯ |

#### 3.3.4 éªŒæ”¶æ ‡å‡†

- [ ] æ¯æ¡AIæ¶ˆæ¯å¯ä»¥åŒ…å«å¤šä¸ªBlock
- [ ] æ¯ä¸ªBlockæœ‰ç‹¬ç«‹çš„çŠ¶æ€ç®¡ç†
- [ ] BlockæŒ‰åˆ›å»ºé¡ºåºæ˜¾ç¤º
- [ ] æ”¯æŒMAIN_TEXTå’ŒTHINKINGä¸¤ç§Blockç±»å‹
- [ ] Blockæ•°æ®æ­£ç¡®æŒä¹…åŒ–åˆ°æ•°æ®åº“

#### 3.3.5 æŠ€æœ¯å‚è€ƒï¼ˆCherry Studioï¼‰

```typescript
// Cherry Studioçš„Blockç±»å‹
export enum MessageBlockType {
  UNKNOWN = 'unknown',
  MAIN_TEXT = 'main_text',
  THINKING = 'thinking',
  TOOL = 'tool',
  ERROR = 'error',
}

// Cherry Studioçš„BlockçŠ¶æ€
export enum MessageBlockStatus {
  PENDING = 'pending',
  PROCESSING = 'processing',
  STREAMING = 'streaming',
  SUCCESS = 'success',
  ERROR = 'error',
}
```

---

### 3.4 è¯·æ±‚æ§åˆ¶ï¼ˆP1 - åº”è¯¥å®ç°ï¼‰

#### 3.4.1 åŠŸèƒ½æè¿°

ç”¨æˆ·å¯ä»¥å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„AIè¯·æ±‚ã€‚

#### 3.4.2 UIè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIæ­£åœ¨ç”Ÿæˆå›å¤...                       â”‚
â”‚                                         â”‚
â”‚ æ ¹æ®æˆ‘çš„åˆ†æï¼Œå»ºè®®ä½ â–ˆ                   â”‚  â† æµå¼æ˜¾ç¤ºä¸­
â”‚                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              [â¹ åœæ­¢ç”Ÿæˆ]               â”‚  â† å–æ¶ˆæŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.4.3 éªŒæ”¶æ ‡å‡†

- [ ] æµå¼å“åº”è¿‡ç¨‹ä¸­æ˜¾ç¤º"åœæ­¢ç”Ÿæˆ"æŒ‰é’®
- [ ] ç‚¹å‡»åç«‹å³åœæ­¢æ¥æ”¶å“åº”
- [ ] å·²æ¥æ”¶çš„å†…å®¹ä¿ç•™æ˜¾ç¤º
- [ ] æ¶ˆæ¯çŠ¶æ€æ›´æ–°ä¸º"å·²åœæ­¢"
- [ ] åœæ­¢åå¯ä»¥é‡æ–°å‘é€æ¶ˆæ¯

---

## 4. æ•°æ®æ¨¡å‹è®¾è®¡

### 4.1 æµå¼æ•°æ®å—æ¨¡å‹ï¼ˆå‚è€ƒCherry Studio ChunkTypeï¼‰

```kotlin
/**
 * AIæµå¼å“åº”æ•°æ®å—
 * å‚è€ƒCherry Studioçš„ChunkTypeè®¾è®¡
 */
sealed class AiStreamChunk {
    /** å“åº”å¼€å§‹ */
    object Started : AiStreamChunk()
    
    /** æ–‡æœ¬å¢é‡ */
    data class TextDelta(val text: String) : AiStreamChunk()
    
    /** æ€è€ƒè¿‡ç¨‹å¢é‡ï¼ˆDeepSeek R1ç­‰æ¨¡å‹ï¼‰ */
    data class ThinkingDelta(
        val text: String,
        val thinkingMs: Long? = null
    ) : AiStreamChunk()
    
    /** æ€è€ƒå®Œæˆ */
    data class ThinkingComplete(
        val fullThinking: String,
        val totalMs: Long
    ) : AiStreamChunk()
    
    /** å“åº”å®Œæˆ */
    data class Complete(
        val fullText: String,
        val usage: TokenUsage? = null
    ) : AiStreamChunk()
    
    /** é”™è¯¯ */
    data class Error(val error: Throwable) : AiStreamChunk()
}

data class TokenUsage(
    val promptTokens: Int,
    val completionTokens: Int,
    val totalTokens: Int
)
```

### 4.2 æ¶ˆæ¯å—ç±»å‹ï¼ˆå‚è€ƒCherry Studio MessageBlockTypeï¼‰

```kotlin
/**
 * æ¶ˆæ¯å—ç±»å‹
 * å‚è€ƒCherry Studioçš„MessageBlockTypeè®¾è®¡
 */
enum class MessageBlockType {
    MAIN_TEXT,    // ä¸»æ–‡æœ¬
    THINKING,     // æ€è€ƒè¿‡ç¨‹
    ERROR         // é”™è¯¯ä¿¡æ¯
    // æœªæ¥æ‰©å±•ï¼šCODE, TOOL, CITATION
}
```

### 4.3 æ¶ˆæ¯å—çŠ¶æ€ï¼ˆå‚è€ƒCherry Studio MessageBlockStatusï¼‰

```kotlin
/**
 * æ¶ˆæ¯å—çŠ¶æ€
 * å‚è€ƒCherry Studioçš„MessageBlockStatusè®¾è®¡
 */
enum class MessageBlockStatus {
    PENDING,      // ç­‰å¾…å¤„ç†
    STREAMING,    // æµå¼æ¥æ”¶ä¸­
    SUCCESS,      // æˆåŠŸå®Œæˆ
    ERROR         // å‘ç”Ÿé”™è¯¯
}
```

### 4.4 æ¶ˆæ¯å—å®ä½“

```kotlin
/**
 * AIå†›å¸ˆæ¶ˆæ¯å—
 * ä¸€æ¡æ¶ˆæ¯å¯ä»¥åŒ…å«å¤šä¸ªå—ï¼ˆæ€è€ƒ+æ–‡æœ¬ï¼‰
 */
data class AiAdvisorMessageBlock(
    val id: String,
    val messageId: String,           // å…³è”çš„æ¶ˆæ¯ID
    val type: MessageBlockType,      // å—ç±»å‹
    val status: MessageBlockStatus,  // å—çŠ¶æ€
    val content: String,             // å—å†…å®¹
    val metadata: BlockMetadata? = null,  // å…ƒæ•°æ®
    val createdAt: Long = System.currentTimeMillis()
)

data class BlockMetadata(
    val thinkingMs: Long? = null,    // æ€è€ƒè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
    val tokenCount: Int? = null      // Tokenæ•°é‡
)
```

### 4.5 å¢å¼ºçš„æ¶ˆæ¯çŠ¶æ€ï¼ˆå‚è€ƒCherry Studio AssistantMessageStatusï¼‰

```kotlin
/**
 * AIæ¶ˆæ¯å‘é€çŠ¶æ€ï¼ˆå¢å¼ºç‰ˆï¼‰
 * å‚è€ƒCherry Studioçš„AssistantMessageStatusè®¾è®¡
 */
enum class AdvisorMessageStatus {
    PENDING,      // ç­‰å¾…å¤„ç†
    STREAMING,    // æµå¼æ¥æ”¶ä¸­ï¼ˆæ–°å¢ï¼‰
    SUCCESS,      // æˆåŠŸ
    STOPPED,      // ç”¨æˆ·åœæ­¢ï¼ˆæ–°å¢ï¼‰
    ERROR         // é”™è¯¯
}
```

---

## 5. æ•°æ®åº“è®¾è®¡

### 5.1 æ–°å¢æ¶ˆæ¯å—è¡¨

**è¡¨å**ï¼š`ai_advisor_message_blocks`

```sql
CREATE TABLE ai_advisor_message_blocks (
    id TEXT PRIMARY KEY NOT NULL,
    message_id TEXT NOT NULL,
    type TEXT NOT NULL,              -- MessageBlockType
    status TEXT NOT NULL,            -- MessageBlockStatus
    content TEXT NOT NULL,
    metadata TEXT,                   -- JSONæ ¼å¼çš„BlockMetadata
    created_at INTEGER NOT NULL,
    FOREIGN KEY (message_id) REFERENCES ai_advisor_conversations(id) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_blocks_message_id ON ai_advisor_message_blocks(message_id);
```

### 5.2 æ•°æ®åº“è¿ç§»

#### 5.2.1 ç‰ˆæœ¬ç¡®è®¤

| é¡¹ç›® | ç‰ˆæœ¬ |
|------|------|
| å½“å‰æ•°æ®åº“ç‰ˆæœ¬ | v13ï¼ˆPRD-00026å·²å®Œæˆv12â†’v13è¿ç§»ï¼‰ |
| æœ¬PRDè¿ç§»ç‰ˆæœ¬ | v13 â†’ v14 |
| è¿ç§»æ–‡ä»¶ä½ç½® | `data/src/main/kotlin/com/empathy/ai/data/local/DatabaseMigrations.kt` |

âš ï¸ **æ³¨æ„**ï¼šå¦‚æœPRD-00026çš„è¿ç§»å°šæœªåˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼Œéœ€è¦å…ˆç¡®è®¤v13ç‰ˆæœ¬å·²ç”Ÿæ•ˆã€‚

#### 5.2.2 è¿ç§»è„šæœ¬

**è¿ç§»ç‰ˆæœ¬**ï¼šv13 â†’ v14

```kotlin
val MIGRATION_13_14 = object : Migration(13, 14) {
    override fun migrate(database: SupportSQLiteDatabase) {
        // 1. åˆ›å»ºæ¶ˆæ¯å—è¡¨
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS ai_advisor_message_blocks (
                id TEXT PRIMARY KEY NOT NULL,
                message_id TEXT NOT NULL,
                type TEXT NOT NULL,
                status TEXT NOT NULL,
                content TEXT NOT NULL,
                metadata TEXT,
                created_at INTEGER NOT NULL,
                FOREIGN KEY (message_id) REFERENCES ai_advisor_conversations(id) ON DELETE CASCADE
            )
        """)
        
        // 2. åˆ›å»ºç´¢å¼•
        database.execSQL("""
            CREATE INDEX IF NOT EXISTS idx_blocks_message_id 
            ON ai_advisor_message_blocks(message_id)
        """)
        
        // 3. ä¸ºç°æœ‰æ¶ˆæ¯åˆ›å»ºé»˜è®¤Blockï¼ˆæ•°æ®è¿ç§»ï¼‰
        database.execSQL("""
            INSERT INTO ai_advisor_message_blocks (id, message_id, type, status, content, created_at)
            SELECT 
                id || '_block',
                id,
                'MAIN_TEXT',
                'SUCCESS',
                content,
                created_at
            FROM ai_advisor_conversations
            WHERE message_type = 'AI'
        """)
    }
}
```

#### 5.2.3 å›æ»šæ–¹æ¡ˆ

å¦‚æœè¿ç§»å¤±è´¥éœ€è¦å›æ»šï¼š

```sql
-- å›æ»šè„šæœ¬ï¼ˆä»…åœ¨ç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨ï¼‰
DROP INDEX IF EXISTS idx_blocks_message_id;
DROP TABLE IF EXISTS ai_advisor_message_blocks;
-- æ³¨æ„ï¼šå›æ»šåæ•°æ®åº“ç‰ˆæœ¬ä»ä¸ºv14ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†ç‰ˆæœ¬å·
-- å»ºè®®ï¼šé€šè¿‡å¤‡ä»½æ¢å¤è€Œéæ‰‹åŠ¨å›æ»š
```

**æ¨èå›æ»šç­–ç•¥**ï¼š
1. ä¿ç•™ç”¨æˆ·æ•°æ®åº“å¤‡ä»½ï¼ˆåº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨å¤‡ä»½ï¼‰
2. è¿ç§»å¤±è´¥æ—¶ä»å¤‡ä»½æ¢å¤
3. ä¸å»ºè®®æ‰‹åŠ¨æ‰§è¡ŒDROPè¯­å¥

---

## 6. æ¥å£è®¾è®¡

### 6.1 Repositoryæ¥å£æ‰©å±•

```kotlin
interface AiRepository {
    // ç°æœ‰æ¥å£ï¼ˆä¿ç•™ï¼‰
    suspend fun generateText(
        provider: AiProvider,
        prompt: String,
        systemInstruction: String
    ): Result<String>
    
    // ğŸ†• æ–°å¢æµå¼æ¥å£
    fun generateTextStream(
        provider: AiProvider,
        prompt: String,
        systemInstruction: String
    ): Flow<AiStreamChunk>
}
```

### 6.2 AiAdvisorRepositoryæ¥å£æ‰©å±•

```kotlin
interface AiAdvisorRepository {
    // ç°æœ‰æ¥å£ï¼ˆä¿ç•™ï¼‰
    suspend fun saveMessage(message: AiAdvisorConversation): Result<Unit>
    suspend fun getConversations(sessionId: String): Flow<List<AiAdvisorConversation>>
    
    // ğŸ†• æ–°å¢Blockç›¸å…³æ¥å£
    suspend fun saveBlock(block: AiAdvisorMessageBlock): Result<Unit>
    suspend fun updateBlock(blockId: String, content: String, status: MessageBlockStatus): Result<Unit>
    suspend fun getBlocksByMessageId(messageId: String): Result<List<AiAdvisorMessageBlock>>
    fun observeBlocksByMessageId(messageId: String): Flow<List<AiAdvisorMessageBlock>>
}
```

### 6.3 æ–°å¢æµå¼UseCase

```kotlin
/**
 * å‘é€AIå†›å¸ˆæ¶ˆæ¯ï¼ˆæµå¼ç‰ˆæœ¬ï¼‰
 * å‚è€ƒCherry Studioçš„æ¶ˆæ¯å‘é€æµç¨‹
 */
class SendAdvisorMessageStreamingUseCase @Inject constructor(
    private val aiAdvisorRepository: AiAdvisorRepository,
    private val aiRepository: AiRepository,
    private val contactRepository: ContactRepository,
    private val aiProviderRepository: AiProviderRepository
) {
    /**
     * å‘é€æ¶ˆæ¯å¹¶è¿”å›æµå¼å“åº”
     */
    operator fun invoke(
        contactId: String,
        sessionId: String,
        userMessage: String
    ): Flow<AiStreamChunk> = flow {
        // 1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
        val userConversation = AiAdvisorConversation.createUserMessage(...)
        aiAdvisorRepository.saveMessage(userConversation)
        
        // 2. åˆ›å»ºAIæ¶ˆæ¯å ä½
        val aiMessage = AiAdvisorConversation.createAiMessage(
            sendStatus = AdvisorMessageStatus.PENDING
        )
        aiAdvisorRepository.saveMessage(aiMessage)
        
        emit(AiStreamChunk.Started)
        
        // 3. è·å–Providerå’Œæ„å»ºæç¤ºè¯
        val provider = aiProviderRepository.getDefaultProvider().getOrThrow()
        val contact = contactRepository.getProfile(contactId).getOrThrow()
        val prompt = buildPrompt(contact, userMessage)
        
        // 4. è°ƒç”¨æµå¼API
        aiRepository.generateTextStream(provider, prompt, systemInstruction)
            .collect { chunk ->
                emit(chunk)
                handleChunk(aiMessage.id, chunk)
            }
    }
    
    private suspend fun handleChunk(messageId: String, chunk: AiStreamChunk) {
        when (chunk) {
            is AiStreamChunk.TextDelta -> {
                // æ›´æ–°MAIN_TEXT Block
            }
            is AiStreamChunk.ThinkingDelta -> {
                // æ›´æ–°THINKING Block
            }
            is AiStreamChunk.Complete -> {
                // æ ‡è®°æ¶ˆæ¯å®Œæˆ
            }
            is AiStreamChunk.Error -> {
                // æ ‡è®°æ¶ˆæ¯å¤±è´¥
            }
            else -> {}
        }
    }
}
```

---

## 7. UIè®¾è®¡

### 7.1 æµå¼æ¶ˆæ¯æ°”æ³¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– AIå†›å¸ˆ                      12:30    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ§  æ€è€ƒè¿‡ç¨‹ (2.3s)         [æ”¶èµ·â–²] â”‚ â”‚  â† æ€è€ƒBlockï¼ˆå¯æŠ˜å ï¼‰
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ è®©æˆ‘åˆ†æä¸€ä¸‹è¿™ä¸ªé—®é¢˜...             â”‚ â”‚
â”‚ â”‚ æ ¹æ®è”ç³»äººç”»åƒï¼Œå¥¹æ˜¯...â–ˆ            â”‚ â”‚  â† æµå¼æ˜¾ç¤º
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ’¬ å›å¤å»ºè®®                         â”‚ â”‚  â† ä¸»æ–‡æœ¬Block
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ æ ¹æ®æˆ‘çš„åˆ†æï¼Œå»ºè®®ä½ ...â–ˆ            â”‚ â”‚  â† æµå¼æ˜¾ç¤º
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              [â¹ åœæ­¢ç”Ÿæˆ]               â”‚  â† æµå¼ä¸­æ˜¾ç¤º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 çŠ¶æ€æŒ‡ç¤ºå™¨

| çŠ¶æ€ | æ˜¾ç¤º |
|------|------|
| PENDING | â³ ç­‰å¾…ä¸­... |
| STREAMING | âœï¸ æ­£åœ¨ç”Ÿæˆ... |
| SUCCESS | âœ… ï¼ˆæ— æ˜¾ç¤ºï¼‰ |
| STOPPED | â¹ å·²åœæ­¢ |
| ERROR | âŒ ç”Ÿæˆå¤±è´¥ [é‡è¯•] |

### 7.3 æ€è€ƒè¿‡ç¨‹ç»„ä»¶

```kotlin
@Composable
fun ThinkingSection(
    content: String,
    thinkingMs: Long,
    isStreaming: Boolean,
    modifier: Modifier = Modifier
) {
    var expanded by remember { mutableStateOf(true) }
    
    Card(
        modifier = modifier,
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.5f)
        )
    ) {
        Column(modifier = Modifier.padding(12.dp)) {
            // æ ‡é¢˜æ ï¼ˆå¯ç‚¹å‡»æŠ˜å ï¼‰
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .clickable { expanded = !expanded },
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                Row {
                    Icon(Icons.Default.Psychology, "æ€è€ƒ")
                    Text("æ€è€ƒè¿‡ç¨‹")
                    if (thinkingMs > 0) {
                        Text(" (${thinkingMs / 1000.0}s)")
                    }
                }
                Icon(
                    if (expanded) Icons.Default.ExpandLess else Icons.Default.ExpandMore,
                    contentDescription = null
                )
            }
            
            // å†…å®¹ï¼ˆå¯æŠ˜å ï¼‰
            AnimatedVisibility(visible = expanded) {
                Text(
                    text = content + if (isStreaming) "â–ˆ" else "",
                    style = MaterialTheme.typography.bodySmall
                )
            }
        }
    }
}
```

---

## 8. æŠ€æœ¯å®ç°è¦ç‚¹

### 8.1 OkHttp SSEæµå¼å®ç°

```kotlin
/**
 * SSEæµå¼è¯»å–å™¨
 * å‚è€ƒCherry Studioçš„AiSdkToChunkAdapterè®¾è®¡
 */
class SseStreamReader(
    private val okHttpClient: OkHttpClient
) {
    fun stream(
        url: String,
        requestBody: ChatRequestDto,
        headers: Map<String, String>
    ): Flow<AiStreamChunk> = callbackFlow {
        val request = Request.Builder()
            .url(url)
            .apply { headers.forEach { (k, v) -> addHeader(k, v) } }
            .post(requestBody.toJson().toRequestBody("application/json".toMediaType()))
            .build()

        val eventSource = EventSources.createFactory(okHttpClient)
            .newEventSource(request, object : EventSourceListener() {
                override fun onOpen(eventSource: EventSource, response: Response) {
                    trySend(AiStreamChunk.Started)
                }

                override fun onEvent(eventSource: EventSource, id: String?, type: String?, data: String) {
                    if (data == "[DONE]") return
                    parseChunk(data)?.let { trySend(it) }
                }

                override fun onClosed(eventSource: EventSource) {
                    channel.close()
                }

                override fun onFailure(eventSource: EventSource, t: Throwable?, response: Response?) {
                    trySend(AiStreamChunk.Error(t ?: Exception("SSEè¿æ¥å¤±è´¥")))
                    channel.close()
                }
            })

        awaitClose { eventSource.cancel() }
    }

    private fun parseChunk(data: String): AiStreamChunk? {
        val json = JSONObject(data)
        val choices = json.optJSONArray("choices") ?: return null
        if (choices.length() == 0) return null

        val delta = choices.getJSONObject(0).optJSONObject("delta") ?: return null

        // æ£€æŸ¥æ€è€ƒå†…å®¹ï¼ˆDeepSeek R1æ ¼å¼ï¼‰
        val reasoning = delta.optString("reasoning_content", "")
        if (reasoning.isNotEmpty()) {
            return AiStreamChunk.ThinkingDelta(reasoning)
        }

        // æ™®é€šæ–‡æœ¬å†…å®¹
        val content = delta.optString("content", "")
        if (content.isNotEmpty()) {
            return AiStreamChunk.TextDelta(content)
        }

        // æ£€æŸ¥å®Œæˆ
        val finishReason = choices.getJSONObject(0).optString("finish_reason", "")
        if (finishReason == "stop") {
            return AiStreamChunk.Complete("", null)
        }

        return null
    }
}
```

### 8.2 æ™ºèƒ½èŠ‚æµæ›´æ–°ï¼ˆå‚è€ƒCherry Studio BlockManagerï¼‰

```kotlin
/**
 * Blockæ›´æ–°ç®¡ç†å™¨
 * å‚è€ƒCherry Studioçš„BlockManageræ™ºèƒ½èŠ‚æµç­–ç•¥
 */
class BlockUpdateManager @Inject constructor(
    private val aiAdvisorRepository: AiAdvisorRepository,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) {
    private var lastBlockType: MessageBlockType? = null
    private val pendingUpdates = mutableMapOf<String, String>()
    private var throttleJob: Job? = null

    /**
     * æ™ºèƒ½æ›´æ–°Block
     * - å—ç±»å‹å˜åŒ–æ—¶ç«‹å³å†™å…¥
     * - åŒç±»å‹å†…å®¹ä½¿ç”¨èŠ‚æµï¼ˆ300msï¼‰
     */
    suspend fun smartUpdate(
        blockId: String,
        content: String,
        blockType: MessageBlockType,
        isComplete: Boolean = false
    ) {
        val isTypeChanged = lastBlockType != null && lastBlockType != blockType

        if (isTypeChanged || isComplete) {
            // ç«‹å³å†™å…¥
            flushPendingUpdates()
            aiAdvisorRepository.updateBlock(blockId, content, MessageBlockStatus.STREAMING)
        } else {
            // èŠ‚æµæ›´æ–°
            pendingUpdates[blockId] = content
            scheduleFlush()
        }

        lastBlockType = blockType
    }

    private fun scheduleFlush() {
        throttleJob?.cancel()
        throttleJob = CoroutineScope(ioDispatcher).launch {
            delay(300) // 300msèŠ‚æµ
            flushPendingUpdates()
        }
    }

    private suspend fun flushPendingUpdates() {
        pendingUpdates.forEach { (blockId, content) ->
            aiAdvisorRepository.updateBlock(blockId, content, MessageBlockStatus.STREAMING)
        }
        pendingUpdates.clear()
    }
}
```

### 8.3 ViewModelæµå¼çŠ¶æ€ç®¡ç†

```kotlin
@HiltViewModel
class AiAdvisorChatViewModel @Inject constructor(
    // ... ç°æœ‰ä¾èµ–
    private val sendAdvisorMessageStreamingUseCase: SendAdvisorMessageStreamingUseCase
) : ViewModel() {

    private val _uiState = MutableStateFlow(AiAdvisorChatUiState())
    val uiState: StateFlow<AiAdvisorChatUiState> = _uiState.asStateFlow()

    private var streamingJob: Job? = null

    fun sendMessageStreaming() {
        val message = _uiState.value.inputText.trim()
        if (message.isEmpty() || _uiState.value.isSending) return

        streamingJob?.cancel()
        streamingJob = viewModelScope.launch {
            _uiState.update {
                it.copy(
                    isSending = true,
                    inputText = "",
                    streamingContent = "",
                    thinkingContent = "",
                    canCancel = true
                )
            }

            sendAdvisorMessageStreamingUseCase(contactId, sessionId, message)
                .catch { error ->
                    _uiState.update {
                        it.copy(isSending = false, canCancel = false, error = error.message)
                    }
                }
                .collect { chunk -> handleStreamChunk(chunk) }
        }
    }

    private fun handleStreamChunk(chunk: AiStreamChunk) {
        when (chunk) {
            is AiStreamChunk.TextDelta -> {
                _uiState.update { it.copy(streamingContent = it.streamingContent + chunk.text) }
            }
            is AiStreamChunk.ThinkingDelta -> {
                _uiState.update { it.copy(thinkingContent = it.thinkingContent + chunk.text) }
            }
            is AiStreamChunk.Complete -> {
                _uiState.update { it.copy(isSending = false, canCancel = false) }
            }
            is AiStreamChunk.Error -> {
                _uiState.update { it.copy(isSending = false, canCancel = false, error = chunk.error.message) }
            }
            else -> {}
        }
    }

    fun cancelStreaming() {
        streamingJob?.cancel()
        _uiState.update { it.copy(isSending = false, canCancel = false) }
    }
}

data class AiAdvisorChatUiState(
    // ... ç°æœ‰å­—æ®µ
    val streamingContent: String = "",      // æµå¼æ–‡æœ¬ç¼“å†²
    val thinkingContent: String = "",       // æ€è€ƒè¿‡ç¨‹ç¼“å†²
    val thinkingTimeMs: Long = 0,           // æ€è€ƒè€—æ—¶
    val canCancel: Boolean = false          // æ˜¯å¦å¯å–æ¶ˆ
)
```

---

## 9. éªŒæ”¶æ ‡å‡†

### 9.1 åŠŸèƒ½éªŒæ”¶

#### æµå¼å“åº”
- [ ] ç”¨æˆ·å‘é€æ¶ˆæ¯åï¼ŒAIå›å¤é€å­—æ˜¾ç¤º
- [ ] æ˜¾ç¤ºæ‰“å­—æœºæ•ˆæœï¼ˆå…‰æ ‡é—ªçƒï¼‰
- [ ] æµå¼è¿‡ç¨‹ä¸­æ˜¾ç¤º"æ­£åœ¨ç”Ÿæˆ..."çŠ¶æ€
- [ ] å“åº”å®ŒæˆåçŠ¶æ€æ­£ç¡®æ›´æ–°

#### æ€è€ƒè¿‡ç¨‹
- [ ] DeepSeek R1ç­‰æ¨¡å‹çš„æ€è€ƒè¿‡ç¨‹æ­£ç¡®æ˜¾ç¤º
- [ ] æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºåœ¨ç‹¬ç«‹çš„å¯æŠ˜å åŒºåŸŸ
- [ ] æ˜¾ç¤ºæ€è€ƒè€—æ—¶
- [ ] ä¸æ”¯æŒæ€è€ƒçš„æ¨¡å‹ä¸æ˜¾ç¤ºæ­¤åŒºåŸŸ

#### Blockæ¶æ„
- [ ] æ¶ˆæ¯æ­£ç¡®æ‹†åˆ†ä¸ºå¤šä¸ªBlock
- [ ] Blockæ•°æ®æ­£ç¡®æŒä¹…åŒ–
- [ ] BlockçŠ¶æ€æ­£ç¡®æ›´æ–°
- [ ] åº”ç”¨é‡å¯åBlockæ•°æ®æ­£ç¡®æ¢å¤

#### è¯·æ±‚æ§åˆ¶
- [ ] æµå¼è¿‡ç¨‹ä¸­æ˜¾ç¤º"åœæ­¢ç”Ÿæˆ"æŒ‰é’®
- [ ] ç‚¹å‡»åœæ­¢åç«‹å³åœæ­¢æ¥æ”¶
- [ ] å·²æ¥æ”¶å†…å®¹ä¿ç•™æ˜¾ç¤º

### 9.2 æ€§èƒ½éªŒæ”¶

- [ ] é¦–å­—å“åº”æ—¶é—´ < 500ms
- [ ] æµå¼æ›´æ–°å¸§ç‡ > 30fps
- [ ] æ•°æ®åº“å†™å…¥èŠ‚æµæœ‰æ•ˆï¼ˆä¸è¶…è¿‡3æ¬¡/ç§’ï¼‰
- [ ] å†…å­˜å ç”¨å¢é‡ < 5MB

### 9.3 å…¼å®¹æ€§éªŒæ”¶

- [ ] ä¸ç°æœ‰AIå†›å¸ˆåŠŸèƒ½å…¼å®¹
- [ ] ä¸å½±å“ç°æœ‰çš„SendAdvisorMessageUseCase
- [ ] æ”¯æŒOpenAIã€DeepSeekç­‰ä¸»æµæœåŠ¡å•†
- [ ] æ•°æ®åº“è¿ç§»å¹³æ»‘ï¼Œä¸ä¸¢å¤±ç°æœ‰æ•°æ®

### 9.4 æµ‹è¯•ç­–ç•¥

#### å•å…ƒæµ‹è¯•

| æµ‹è¯•ç±» | æµ‹è¯•å†…å®¹ | æ¨¡å— |
|--------|---------|------|
| AiStreamChunkTest | å¯†å°ç±»å„å­ç±»å‹åˆ›å»ºå’Œå±æ€§éªŒè¯ | :domain |
| MessageBlockTypeTest | æšä¸¾å€¼å’Œåºåˆ—åŒ–æµ‹è¯• | :domain |
| SendAdvisorMessageStreamingUseCaseTest | æµå¼å‘é€é€»è¾‘ã€é”™è¯¯å¤„ç†ã€å–æ¶ˆé€»è¾‘ | :domain |
| BlockUpdateManagerTest | èŠ‚æµé€»è¾‘ã€ç«‹å³å†™å…¥æ¡ä»¶ã€å¹¶å‘å®‰å…¨ | :data |
| SseStreamReaderTest | SSEè§£æã€é”™è¯¯å¤„ç†ã€è¿æ¥ç®¡ç† | :data |
| AiAdvisorChatViewModelTest | æµå¼çŠ¶æ€ç®¡ç†ã€å–æ¶ˆæ“ä½œã€é”™è¯¯æ¢å¤ | :presentation |

#### é›†æˆæµ‹è¯•

| æµ‹è¯•ç±» | æµ‹è¯•å†…å®¹ | æ¨¡å— |
|--------|---------|------|
| Migration13To14Test | æ•°æ®åº“è¿ç§»æ­£ç¡®æ€§ã€æ•°æ®å®Œæ•´æ€§ | :data (androidTest) |
| AiAdvisorMessageBlockDaoTest | Block CRUDæ“ä½œã€Flowå“åº”å¼æ›´æ–° | :data (androidTest) |
| StreamingIntegrationTest | ç«¯åˆ°ç«¯æµå¼å“åº”æµ‹è¯• | :app (androidTest) |

#### UIæµ‹è¯•

| æµ‹è¯•ç±» | æµ‹è¯•å†…å®¹ | æ¨¡å— |
|--------|---------|------|
| ThinkingSectionTest | æŠ˜å /å±•å¼€ã€è€—æ—¶æ˜¾ç¤º | :presentation (androidTest) |
| StreamingMessageBubbleTest | æ‰“å­—æœºæ•ˆæœã€çŠ¶æ€æŒ‡ç¤ºå™¨ | :presentation (androidTest) |
| CancelButtonTest | å–æ¶ˆæŒ‰é’®æ˜¾ç¤º/éšè—ã€ç‚¹å‡»å“åº” | :presentation (androidTest) |

#### Mockç­–ç•¥

```kotlin
// æ¨¡æ‹Ÿæµå¼å“åº”
val mockStreamFlow = flow {
    emit(AiStreamChunk.Started)
    delay(100)
    emit(AiStreamChunk.ThinkingDelta("æ€è€ƒä¸­...", 100))
    delay(100)
    emit(AiStreamChunk.TextDelta("å›å¤å†…å®¹"))
    delay(100)
    emit(AiStreamChunk.Complete("å®Œæ•´å›å¤", null))
}

// æ¨¡æ‹ŸSSEé”™è¯¯
val mockErrorFlow = flow {
    emit(AiStreamChunk.Started)
    delay(100)
    emit(AiStreamChunk.Error(IOException("ç½‘ç»œé”™è¯¯")))
}
```

---

## 10. å¼€å‘è®¡åˆ’

### 10.1 Phase 1ï¼šæµå¼å“åº”åŸºç¡€ï¼ˆé¢„è®¡1å‘¨ï¼‰

| ä»»åŠ¡ | æ–‡ä»¶ | é¢„ä¼° |
|------|------|------|
| å®šä¹‰AiStreamChunkå¯†å°ç±» | domain/model/AiStreamChunk.kt | 0.5å¤© |
| AiRepositoryæ–°å¢æµå¼æ¥å£ | domain/repository/AiRepository.kt | 0.5å¤© |
| å®ç°SseStreamReader | data/remote/SseStreamReader.kt | 2å¤© |
| AiRepositoryImplå®ç°æµå¼ | data/repository/AiRepositoryImpl.kt | 1å¤© |
| æ–°å¢æµå¼UseCase | domain/usecase/SendAdvisorMessageStreamingUseCase.kt | 1å¤© |
| ViewModelæµå¼çŠ¶æ€ | presentation/viewmodel/AiAdvisorChatViewModel.kt | 1å¤© |
| UIæ‰“å­—æœºæ•ˆæœ | presentation/ui/screen/advisor/component/ | 1å¤© |

**äº¤ä»˜ç‰©**ï¼šç”¨æˆ·å‘é€æ¶ˆæ¯åï¼ŒAIå›å¤é€å­—æ˜¾ç¤º

### 10.2 Phase 2ï¼šBlockæ¶æ„ï¼ˆé¢„è®¡1å‘¨ï¼‰

| ä»»åŠ¡ | æ–‡ä»¶ | é¢„ä¼° |
|------|------|------|
| å®šä¹‰MessageBlockæ¨¡å‹ | domain/model/AiAdvisorMessageBlock.kt | 0.5å¤© |
| æ•°æ®åº“è¿ç§»13â†’14 | data/local/AppDatabase.kt | 1å¤© |
| æ–°å¢MessageBlockDao | data/local/dao/AiAdvisorMessageBlockDao.kt | 0.5å¤© |
| æ–°å¢MessageBlockEntity | data/local/entity/AiAdvisorMessageBlockEntity.kt | 0.5å¤© |
| Repositoryæ”¯æŒBlock | data/repository/AiAdvisorRepositoryImpl.kt | 1å¤© |
| æ€è€ƒè¿‡ç¨‹UIç»„ä»¶ | presentation/ui/screen/advisor/component/ThinkingSection.kt | 1å¤© |
| Blockæ¸²æŸ“ç»„ä»¶ | presentation/ui/screen/advisor/component/MessageBlockRenderer.kt | 1å¤© |
| è¿ç§»æµ‹è¯• | data/src/androidTest/ | 0.5å¤© |

**äº¤ä»˜ç‰©**ï¼šæ”¯æŒæ€è€ƒè¿‡ç¨‹å±•ç¤ºï¼Œæ¶ˆæ¯ç”±å¤šä¸ªBlockç»„æˆ

### 10.3 Phase 3ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆé¢„è®¡0.5å‘¨ï¼‰

| ä»»åŠ¡ | æ–‡ä»¶ | é¢„ä¼° |
|------|------|------|
| æ™ºèƒ½èŠ‚æµæ›´æ–° | data/util/BlockUpdateManager.kt | 1å¤© |
| æ€§èƒ½æµ‹è¯• | - | 0.5å¤© |
| Bugä¿®å¤ | - | 0.5å¤© |

**äº¤ä»˜ç‰©**ï¼šæµå¼æ›´æ–°æ€§èƒ½ä¼˜åŒ–ï¼Œå‡å°‘æ•°æ®åº“å†™å…¥

### 10.4 æ€»é¢„ä¼°

- **æ€»å·¥ä½œé‡**ï¼š2.5å‘¨
- **é£é™©ç¼“å†²**ï¼š+20% = 3å‘¨

---

## 11. é£é™©è¯„ä¼°

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| AIæœåŠ¡å•†ä¸æ”¯æŒSSE | ä½ | é«˜ | OpenAI/DeepSeekéƒ½æ”¯æŒï¼Œæå‰éªŒè¯ |
| æ•°æ®åº“è¿ç§»å¤±è´¥ | ä¸­ | é«˜ | ç¼–å†™å®Œæ•´è¿ç§»æµ‹è¯•ï¼Œä¿ç•™å›æ»šæ–¹æ¡ˆ |
| æµå¼è§£æé”™è¯¯ | ä¸­ | ä¸­ | å¢å¼ºé”™è¯¯å¤„ç†ï¼Œå‚è€ƒç°æœ‰AiResponseCleaner |
| æ€§èƒ½é—®é¢˜ | ä½ | ä¸­ | æ™ºèƒ½èŠ‚æµï¼Œé¿å…é¢‘ç¹UIæ›´æ–° |
| æ€è€ƒè¿‡ç¨‹æ ¼å¼ä¸ç»Ÿä¸€ | ä¸­ | ä½ | é€‚é…å¤šç§æ¨¡å‹æ ¼å¼ |

---

## 12. Cherry Studioç‹¬ç‰¹åŠŸèƒ½æ·±åº¦åˆ†æ

åŸºäºå¯¹Cherry Studioä»£ç çš„æ·±åº¦åˆ†æï¼Œä»¥ä¸‹æ˜¯å…¶æ ¸å¿ƒè®¾è®¡äº®ç‚¹å’Œæˆ‘ä»¬å¯ä»¥å€Ÿé‰´çš„åŠŸèƒ½ï¼š

### 12.1 å·²çº³å…¥æœ¬PRDçš„åŠŸèƒ½

| åŠŸèƒ½ | Cherry Studioå®ç° | æœ¬PRDå¯¹åº”ç« èŠ‚ |
|------|------------------|--------------|
| Block-basedæ¶ˆæ¯æ¶æ„ | MessageBlockTypeæšä¸¾ | 3.3 Blockæ¶æ„ |
| ChunkTypeæµå¼åè®® | ç»Ÿä¸€çš„æµå¼äº‹ä»¶æšä¸¾ | 4.1 æµå¼æ•°æ®å—æ¨¡å‹ |
| æ™ºèƒ½èŠ‚æµæ›´æ–° | BlockManager.smartBlockUpdate | 8.2 æ™ºèƒ½èŠ‚æµæ›´æ–° |
| æ€è€ƒè¿‡ç¨‹å±•ç¤º | THINKING Block + æŠ˜å UI | 3.2 æ€è€ƒè¿‡ç¨‹å±•ç¤º |
| è¯·æ±‚å–æ¶ˆæ§åˆ¶ | æš‚åœ/å–æ¶ˆæŒ‰é’® | 3.4 è¯·æ±‚æ§åˆ¶ |

### 12.2 Cherry Studioå…¶ä»–ç‹¬ç‰¹åŠŸèƒ½ï¼ˆåç»­ç‰ˆæœ¬è€ƒè™‘ï¼‰

#### 12.2.1 å¤šçº§ç¼“å­˜ç­–ç•¥

Cherry Studioå®ç°äº†ä¸‰çº§ç¼“å­˜ï¼š

```typescript
// ç¬¬1å±‚ï¼šæ°¸ä¹…ç¼“å­˜ï¼ˆç³»ç»ŸåŠ©æ‰‹ç­‰ï¼‰
private systemAssistantsCache = new Map<string, Assistant>()

// ç¬¬2å±‚ï¼šLRUç¼“å­˜ï¼ˆæœ€å¤š10ä¸ªï¼Œæœ€è¿‘è®¿é—®ä¼˜å…ˆï¼‰
private assistantCache = new Map<string, Assistant>()
private readonly MAX_CACHE_SIZE = 10

// ç¬¬3å±‚ï¼šTTLç¼“å­˜ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
private allAssistantsCache = new Map<string, Assistant>()
private readonly CACHE_TTL = 5 * 60 * 1000
```

**ä¼˜åŠ¿**ï¼šå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼Œæå‡å“åº”é€Ÿåº¦

**æˆ‘ä»¬çš„é€‚é…æ–¹æ¡ˆ**ï¼ˆP2ä¼˜å…ˆçº§ï¼‰ï¼š
```kotlin
class ConversationCacheManager @Inject constructor() {
    // LRUç¼“å­˜ï¼šæœ€è¿‘è®¿é—®çš„ä¼šè¯
    private val sessionCache = object : LinkedHashMap<String, List<AiAdvisorConversation>>(
        10, 0.75f, true
    ) {
        override fun removeEldestEntry(eldest: MutableMap.MutableEntry<String, List<AiAdvisorConversation>>): Boolean {
            return size > MAX_CACHE_SIZE
        }
    }
    
    // TTLç¼“å­˜ï¼šå¸¦è¿‡æœŸæ—¶é—´
    private val cacheTimestamps = mutableMapOf<String, Long>()
    private val CACHE_TTL = 5 * 60 * 1000L // 5åˆ†é’Ÿ
}
```

#### 12.2.2 Observerè®¢é˜…æ¨¡å¼

Cherry Studioä½¿ç”¨å‘å¸ƒ-è®¢é˜…æœºåˆ¶å®ç°å®æ—¶UIæ›´æ–°ï¼š

```typescript
// è®¢é˜…å•ä¸ªå®ä½“
subscribeTopic(topicId: string, callback: () => void): UnsubscribeFunction

// è®¢é˜…å…¨å±€å˜åŒ–
subscribeAll(callback: () => void): UnsubscribeFunction

// ä¸React useSyncExternalStoreé›†æˆ
const topic = useSyncExternalStore(
    topicService.subscribeTopic.bind(topicService, topicId),
    () => topicService.getTopic(topicId)
)
```

**æˆ‘ä»¬çš„é€‚é…æ–¹æ¡ˆ**ï¼š
- å·²æœ‰Room + Flowå®ç°ç±»ä¼¼åŠŸèƒ½
- å¯è€ƒè™‘æ·»åŠ æ›´ç»†ç²’åº¦çš„è®¢é˜…ï¼ˆå¦‚å•æ¡æ¶ˆæ¯å˜åŒ–ï¼‰

#### 12.2.3 ä¹è§‚æ›´æ–°ç­–ç•¥

Cherry Studioé‡‡ç”¨"å…ˆæ›´æ–°UIï¼ŒåæŒä¹…åŒ–"çš„ç­–ç•¥ï¼š

```typescript
public async updateTopic(topicId: string, updates: Partial<Topic>): Promise<void> {
    // 1. å…ˆæ›´æ–°ç¼“å­˜ï¼ˆä¹è§‚æ›´æ–°ï¼‰
    this.updateTopicInCache(topicId, { ...updates, updatedAt: Date.now() })
    this.notifyCurrentTopicSubscribers()  // UIç«‹å³åˆ·æ–°

    // 2. åå°æŒä¹…åŒ–
    try {
        await topicDatabase.upsertTopics([updatedTopic])
    } catch (error) {
        // 3. å¤±è´¥å›æ»š
        this.rollbackCache(topicId, oldTopic)
        this.notifyCurrentTopicSubscribers()
        throw error
    }
}
```

**æˆ‘ä»¬çš„é€‚é…æ–¹æ¡ˆ**ï¼ˆP1ä¼˜å…ˆçº§ï¼‰ï¼š
- åœ¨ViewModelä¸­å®ç°ä¹è§‚æ›´æ–°
- æµå¼å“åº”æ—¶å…ˆæ›´æ–°UIçŠ¶æ€ï¼ŒåæŒä¹…åŒ–åˆ°æ•°æ®åº“

#### 12.2.4 è™šæ‹Ÿåˆ—è¡¨ä¼˜åŒ–ï¼ˆLegendListï¼‰

Cherry Studioä½¿ç”¨LegendListå®ç°é«˜æ•ˆçš„æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“ï¼š

```typescript
<LegendList
    data={groupedMessages}
    renderItem={({ item }) => <MessageGroup item={item} />}
    maintainScrollAtEnd        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    recycleItems               // åˆ—è¡¨é¡¹å¤ç”¨ä¼˜åŒ–
    estimatedItemSize={100}    // é¢„ä¼°é«˜åº¦
/>
```

**æˆ‘ä»¬çš„é€‚é…æ–¹æ¡ˆ**ï¼ˆP2ä¼˜å…ˆçº§ï¼‰ï¼š
- ä½¿ç”¨Compose LazyColumnå·²æœ‰ç±»ä¼¼ä¼˜åŒ–
- å¯è€ƒè™‘æ·»åŠ æ¶ˆæ¯åˆ†ç»„æ¸²æŸ“ï¼ˆæŒ‰æ—¶é—´/è§’è‰²ï¼‰
- æ·»åŠ estimatedItemSizeæå‡æ»šåŠ¨æ€§èƒ½

#### 12.2.5 å¤šæ¨¡å‹å¹¶è¡Œå“åº”ï¼ˆMentionsæœºåˆ¶ï¼‰

Cherry Studioæ”¯æŒåœ¨å•æ¡æ¶ˆæ¯ä¸­@å¤šä¸ªæ¨¡å‹ï¼Œå¹¶è¡Œè·å–å“åº”ï¼š

```typescript
// ç”¨æˆ·è¾“å…¥å¤„ç†
if (currentMentions.length > 0) {
    message.mentions = currentMentions
}

// æ¶ˆæ¯æœåŠ¡å¤„ç†
if (mentionedModels?.length > 0) {
    await multiModelResponses(topicId, assistant, userMessage, mentionedModels)
} else {
    // å•æ¨¡å‹å¤„ç†
}
```

**æˆ‘ä»¬çš„é€‚é…æ–¹æ¡ˆ**ï¼ˆP3ä¼˜å…ˆçº§ï¼Œåç»­ç‰ˆæœ¬ï¼‰ï¼š
- éœ€è¦UIæ”¯æŒ@æ¨¡å‹é€‰æ‹©
- éœ€è¦å¹¶è¡Œè¯·æ±‚ç®¡ç†
- éœ€è¦å¤šå“åº”å±•ç¤ºUI

#### 12.2.6 æ¶ˆæ¯å—æ‰¹é‡æ›´æ–°

Cherry Studioçš„BlockManageræ”¯æŒæ‰¹é‡æ›´æ–°ä¼˜åŒ–ï¼š

```typescript
// èŠ‚æµæ›´æ–°ï¼šåŒç±»å‹å†…å®¹ç´¯ç§¯åæ‰¹é‡å†™å…¥
await this.deps.throttledBlockUpdate(blockId, changes)

// ç«‹å³æ›´æ–°ï¼šå—ç±»å‹å˜åŒ–æˆ–å®Œæˆæ—¶
await messageBlockDatabase.updateOneBlock({ id: blockId, changes })
```

**æˆ‘ä»¬çš„é€‚é…æ–¹æ¡ˆ**ï¼šå·²åœ¨8.2èŠ‚å®ç°

### 12.3 åŠŸèƒ½ä¼˜å…ˆçº§æ€»ç»“

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | æœ¬PRDç‰ˆæœ¬ | è¯´æ˜ |
|------|--------|----------|------|
| æµå¼å“åº” | P0 | âœ… åŒ…å« | æ ¸å¿ƒä½“éªŒæå‡ |
| æ€è€ƒè¿‡ç¨‹å±•ç¤º | P0 | âœ… åŒ…å« | DeepSeek R1æ”¯æŒ |
| Blockæ¶æ„ | P0 | âœ… åŒ…å« | æ¶æ„åŸºç¡€ |
| æ™ºèƒ½èŠ‚æµæ›´æ–° | P1 | âœ… åŒ…å« | æ€§èƒ½ä¼˜åŒ– |
| è¯·æ±‚å–æ¶ˆ | P1 | âœ… åŒ…å« | ç”¨æˆ·æ§åˆ¶ |
| ä¹è§‚æ›´æ–° | P1 | âš ï¸ éƒ¨åˆ† | ViewModelå±‚å®ç° |
| å¤šçº§ç¼“å­˜ | P2 | âŒ åç»­ | æ€§èƒ½ä¼˜åŒ– |
| è™šæ‹Ÿåˆ—è¡¨ä¼˜åŒ– | P2 | âŒ åç»­ | å¤§é‡æ¶ˆæ¯åœºæ™¯ |
| å¤šæ¨¡å‹å¹¶è¡Œ | P3 | âŒ åç»­ | é«˜çº§åŠŸèƒ½ |
| å·¥å…·è°ƒç”¨Block | P3 | âŒ åç»­ | MCPé›†æˆ |
| ä»£ç å—é«˜äº® | P3 | âŒ åç»­ | ä»£ç å±•ç¤º |

---

## 13. ä¸åŒ…å«çš„åŠŸèƒ½ï¼ˆåç»­ç‰ˆæœ¬ï¼‰

- [ ] å·¥å…·è°ƒç”¨Blockï¼ˆMCPé›†æˆï¼‰
- [ ] ä»£ç å—è¯­æ³•é«˜äº®
- [ ] å¼•ç”¨/æœç´¢ç»“æœBlock
- [ ] å›¾ç‰‡ç”ŸæˆBlock
- [ ] å¤šæ¨¡å‹å¹¶è¡Œå“åº”ï¼ˆMentionsæœºåˆ¶ï¼‰
- [ ] æ¶ˆæ¯ç¼–è¾‘åŠŸèƒ½
- [ ] å¤šçº§ç¼“å­˜ç­–ç•¥
- [ ] è™šæ‹Ÿåˆ—è¡¨ä¼˜åŒ–ï¼ˆæ¶ˆæ¯åˆ†ç»„ï¼‰

---

## 14. é™„å½•

### 14.1 Cherry Studioå‚è€ƒæ–‡æ¡£

- `cherry/CODE_ANALYSIS/cherry-studio/architecture/ai_conversation_flow.md`
- `cherry/CODE_ANALYSIS/cherry-studio/architecture/component_interaction.md`
- `cherry/CODE_ANALYSIS/cherry-studio/architecture/state_management.md`
- `cherry/CODE_ANALYSIS/services/architecture/design_patterns.md`

### 14.2 ç›¸å…³è°ƒç ”æŠ¥å‘Š

- `æ–‡æ¡£/å¼€å‘æ–‡æ¡£/RE/RESEARCH-00003-Cherryé¡¹ç›®æ¶æ„å¯¹æ¯”åˆ†ææŠ¥å‘Š.md`
- `æ–‡æ¡£/å¼€å‘æ–‡æ¡£/RE/RESEARCH-00004-Cherryé¡¹ç›®AIå¯¹è¯å®ç°æ·±åº¦åˆ†ææŠ¥å‘Š.md`

### 14.3 å…³è”PRD

- `PRD-00026-AIå†›å¸ˆå¯¹è¯åŠŸèƒ½éœ€æ±‚.md` - åŸºç¡€åŠŸèƒ½éœ€æ±‚
- `PRD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„éœ€æ±‚.md` - ç±»ä¼¼çš„æµå¼ä½“éªŒå‚è€ƒ

### 14.4 Cherry Studioæ ¸å¿ƒè®¾è®¡æ¨¡å¼æ€»ç»“

| è®¾è®¡æ¨¡å¼ | åº”ç”¨åœºæ™¯ | æˆ‘ä»¬çš„é€‚é… |
|---------|---------|-----------|
| Singleton | æ‰€æœ‰æ ¸å¿ƒæœåŠ¡ | Hilt @Singleton |
| Observer | å®æ—¶UIæ›´æ–° | Room Flow |
| LRU Cache | ä¼šè¯/æ¶ˆæ¯ç¼“å­˜ | LinkedHashMap |
| Strategy | æµå¤„ç†åˆ†å‘ | whenè¡¨è¾¾å¼ |
| Optimistic Update | CRUDæ“ä½œ | ViewModelçŠ¶æ€ç®¡ç† |
| Queue | å¹¶å‘æ§åˆ¶ | Mutex/Channel |

### 14.5 æœ¯è¯­è¡¨

| æœ¯è¯­ | è§£é‡Š |
|------|------|
| Block | æ¶ˆæ¯å—ï¼Œä¸€æ¡æ¶ˆæ¯å¯åŒ…å«å¤šä¸ªBlockï¼ˆæ€è€ƒ+æ–‡æœ¬+å·¥å…·ç­‰ï¼‰ |
| Chunk | æµå¼å“åº”çš„æ•°æ®ç‰‡æ®µ |
| SSE | Server-Sent Eventsï¼ŒæœåŠ¡å™¨æ¨é€äº‹ä»¶ |
| LRU | Least Recently Usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ç¼“å­˜ç­–ç•¥ |
| TTL | Time To Liveï¼Œç¼“å­˜è¿‡æœŸæ—¶é—´ |
| èŠ‚æµ | Throttleï¼Œé™åˆ¶æ“ä½œé¢‘ç‡ |
| ä¹è§‚æ›´æ–° | å…ˆæ›´æ–°UIï¼ŒåæŒä¹…åŒ–ï¼Œå¤±è´¥å›æ»š |
| Mentions | @æåŠæœºåˆ¶ï¼Œç”¨äºå¤šæ¨¡å‹å¹¶è¡Œå“åº” |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.1  
**æœ€åæ›´æ–°**: 2026-01-04  
**æ›´æ–°å†…å®¹**: æ·»åŠ Cherry Studioç‹¬ç‰¹åŠŸèƒ½æ·±åº¦åˆ†æç« èŠ‚
