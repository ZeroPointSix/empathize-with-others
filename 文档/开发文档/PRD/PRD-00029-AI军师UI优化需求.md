# PRD-00029: AI军师UI架构优化需求

> **文档类型**: 产品需求文档 (PRD)
> **版本**: 3.0
> **创建日期**: 2026-01-06
> **更新日期**: 2026-01-06
> **负责人**: Roo
> **状态**: ✅ 需求确认
> **优先级**: 🔴 高

---

## 🎯 核心目标

重构AI军师UI架构，实现**三个独立页面**的导航体系：
1. **对话界面** - 与AI军师的对话交互（主界面）
2. **会话历史页面** - 当前联系人的历史会话列表
3. **联系人选择页面** - 切换不同联系人

---

## � 需求背型景

当前AI军师功能（PRD-00026）已经实现了基本的对话功能，但在实际使用中存在以下问题：

1. **缺少会话历史管理** - 用户无法查看与某个联系人的历史对话记录
2. **联系人切换不便** - 当前使用弹窗Dialog切换联系人，体验不够直观
3. **会话隔离不清晰** - 用户不清楚不同联系人的会话是隔离的
4. **首次使用引导缺失** - 新用户进入后不知道如何开始

**用户反馈**：
- "我想看看之前和张三聊过什么，但找不到历史记录"
- "切换联系人的弹窗太小了，联系人多的时候不好选"
- "每次进来都要重新选联系人，能不能记住上次的？"

**优化目标**：
- 提供独立的会话历史页面，方便用户回顾历史对话
- 提供独立的联系人选择页面，提升切换体验
- 自动恢复上次联系人，提升使用效率

---

## 🎭 用户故事

### US-001: 快速切换联系人
**作为** 用户，
**我想要** 快速切换到不同的联系人，
**以便于** 为不同联系人获取AI建议，而不需要重复输入聊天记录。

**验收标准**：
- 点击右上角👤图标进入联系人选择页面
- 联系人列表显示姓名、关系标签、最后消息预览
- 点击联系人后自动开启新会话并返回对话界面

### US-002: 查看历史会话
**作为** 用户，
**我想要** 查看与某个联系人的历史会话，
**以便于** 回顾之前的AI建议，避免重复提问。

**验收标准**：
- 点击左上角☰图标进入会话历史页面
- 会话列表显示会话标题、最后消息、时间
- 点击会话后加载该会话内容并返回对话界面

### US-003: 自动恢复上次联系人
**作为** 用户，
**我想要** 进入AI军师时自动恢复上次使用的联系人，
**以便于** 快速继续上次的对话，提升使用效率。

**验收标准**：
- 进入AI军师时自动加载上次联系人
- 自动开启新会话（不加载历史会话内容）
- 首次使用时进入联系人选择页面

---

## 🔴 UI原型（必须严格遵循）

> ⚠️ **强制要求**：开发时必须严格按照UI原型文件实现，包括布局、颜色、间距、组件样式等所有细节。

| 页面 | UI原型文件 |
|------|-----------|
| **对话界面** | `文档/开发文档/UI-原型/PRD29/gemini对话界面.html` |
| **会话历史页面** | `文档/开发文档/UI-原型/PRD29/ai-advisor-home-ios.html` |
| **联系人选择页面** | `文档/开发文档/UI-原型/PRD29/ai-advisor-home-ios.html` |

**使用方法**：直接在浏览器打开HTML文件查看完整效果，所有颜色值、字体大小、间距、组件位置必须与原型一致。

---

## 📋 三页面架构

### 页面关系图

```
┌─────────────────────────────────────────────────────────────┐
│                     用户点击"AI军师"Tab                      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  检查是否有上次联系人记录                                     │
│  ├── 有记录 → 恢复该联系人 + 自动开启新会话 → 对话界面        │
│  └── 无记录 → 进入联系人选择页面                             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                       对话界面                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [☰]           AI 军师            [👤]             │   │
│  │   ↓                                  ↓              │   │
│  │ 会话历史页面                     联系人选择页面      │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 页面职责

| 页面 | 入口 | 功能 |
|------|------|------|
| **对话界面** | AI军师Tab（默认） | 与AI军师对话，自动恢复上次联系人+新会话 |
| **会话历史页面** | 左上角 ☰ 图标 | 显示当前联系人的所有历史会话 |
| **联系人选择页面** | 右上角 👤 图标 | 切换联系人（切换后自动开启新会话） |

---

## 🖼️ 界面1：对话界面（主界面）

### 🔴 必须参考原型
> **原型文件**: `文档/开发文档/UI-原型/PRD29/gemini对话界面.html`

### 页面结构

```
┌─────────────────────────────────────────┐
│            状态栏 (11dp)                │
├─────────────────────────────────────────┤
│  [☰]         AI 军师          [👤]     │  ← 导航栏
├─────────────────────────────────────────┤
│                                         │
│     ┌─────────────────────────┐        │
│     │   共情 Logo (渐变心形)   │        │  ← 空状态欢迎区
│     │       "共情"            │        │
│     │  "懂你所想，助你表达"    │        │
│     └─────────────────────────┘        │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ [AI] AI回复内容...              │   │  ← 对话消息
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │           用户消息内容 [用户]   │   │
│  └─────────────────────────────────┘   │
│                                         │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐   │
│  │[+] 输入消息或粘贴聊天记录 [🎤][➤]│   │  ← 悬浮输入框
│  └─────────────────────────────────┘   │
├─────────────────────────────────────────┤
│          Home Indicator (8dp)           │
└─────────────────────────────────────────┘
```

### 导航栏设计

| 元素 | 位置 | 图标 | 点击行为 |
|------|------|------|----------|
| 菜单按钮 | 左侧 | `menu` (☰) | 进入会话历史页面 |
| 标题 | 中间 | - | "AI 军师" |
| 联系人按钮 | 右侧 | `person` (👤) | 进入联系人选择页面 |

### 功能需求

| ID | 需求 | 优先级 |
|----|------|--------|
| R-029-01 | 左上角☰图标点击进入会话历史页面 | P0 |
| R-029-02 | 右上角👤图标点击进入联系人选择页面 | P0 |
| R-029-03 | 自动恢复上次联系人并开启新会话 | P0 |
| R-029-04 | 无对话时显示共情Logo欢迎区域 | P1 |
| R-029-05 | 悬浮输入框（圆角22dp，带阴影） | P0 |
| R-029-06 | 流式AI回复（打字机效果+停止按钮） | P0 |

---

## 🖼️ 界面2：会话历史页面

### 🔴 必须参考原型
> **原型文件**: `文档/开发文档/UI-原型/PRD29/ai-advisor-home-ios.html`
> 
> 参考原型中"最近对话"区域的列表样式。

### 页面结构

```
┌─────────────────────────────────────────┐
│            状态栏 (11dp)                │
├─────────────────────────────────────────┤
│  [<]         会话历史          [新建]   │  ← 导航栏
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐   │
│  │ 🔍 搜索会话                     │   │  ← 搜索框
│  └─────────────────────────────────┘   │
├─────────────────────────────────────────┤
│  与 张三 的对话                         │  ← 分组标题
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐   │
│  │ 会话标题A              10:30  > │   │
│  │ 最后一条消息预览...              │   │
│  ├─────────────────────────────────┤   │  ← 会话列表
│  │ 会话标题B              昨天   > │   │
│  │ 最后一条消息预览...              │   │
│  ├─────────────────────────────────┤   │
│  │ 会话标题C              12/28  > │   │
│  │ 最后一条消息预览...              │   │
│  └─────────────────────────────────┘   │
├─────────────────────────────────────────┤
│          Home Indicator (8dp)           │
└─────────────────────────────────────────┘
```

### 功能需求

| ID | 需求 | 优先级 |
|----|------|--------|
| R-029-10 | 显示当前联系人的所有历史会话（按时间倒序） | P0 |
| R-029-11 | 点击会话项加载该会话并返回对话界面 | P0 |
| R-029-12 | 右上角"新建"按钮创建新会话并返回 | P0 |
| R-029-13 | 返回按钮返回对话界面 | P0 |
| R-029-14 | 搜索会话功能 | P2 |
| R-029-15 | 左滑删除会话 | P1 |
| R-029-16 | 空状态友好提示 | P1 |

---

## 🖼️ 界面3：联系人选择页面

### 🔴 必须参考原型
> **原型文件**: `文档/开发文档/UI-原型/PRD29/ai-advisor-home-ios.html`
> 
> 参考原型中联系人列表的样式（头像、姓名、关系标签、时间、消息预览）。

### 页面结构

```
┌─────────────────────────────────────────┐
│            状态栏 (11dp)                │
├─────────────────────────────────────────┤
│  [<]         选择联系人                 │  ← 导航栏
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐   │
│  │ 🔍 搜索联系人                   │   │  ← 搜索框
│  └─────────────────────────────────┘   │
├─────────────────────────────────────────┤
│  联系人                                 │  ← 分组标题
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐   │
│  │ [张] 张三        亲密    10:30 >│   │
│  │      最近工作好累啊...           │   │
│  ├─────────────────────────────────┤   │  ← 联系人列表
│  │ [李] 李四        熟悉    昨天  >│   │
│  │      周末有空吗？                │   │
│  ├─────────────────────────────────┤   │
│  │ [王] 王五        普通    周一  >│   │
│  │      项目进度怎么样了？          │   │
│  └─────────────────────────────────┘   │
├─────────────────────────────────────────┤
│          Home Indicator (8dp)           │
└─────────────────────────────────────────┘
```

### 联系人列表项设计

| 元素 | 说明 |
|------|------|
| 头像 | 44dp方形圆角，彩色背景+姓氏首字 |
| 姓名 | 15sp, 黑色 |
| 关系标签 | 11sp, 灰色（亲密/熟悉/普通/新认识） |
| 时间 | 11sp, 灰色（相对时间） |
| 消息预览 | 13sp, 灰色, 单行截断 |

### 功能需求

| ID | 需求 | 优先级 |
|----|------|--------|
| R-029-20 | 显示所有联系人（按最后对话时间倒序） | P0 |
| R-029-21 | 点击联系人切换+开启新会话+返回对话界面 | P0 |
| R-029-22 | 返回按钮返回对话界面 | P0 |
| R-029-23 | 显示关系标签和最后消息预览 | P1 |
| R-029-24 | 搜索联系人功能 | P2 |
| R-029-25 | 空状态引导添加联系人 | P1 |

---

## 🔄 核心交互逻辑

### 1. 进入AI军师

```
用户点击"AI军师"Tab
    ↓
检查 SharedPreferences 中的 lastContactId
    ├── 有值 → 加载该联系人 + 创建新会话 → 进入对话界面
    └── 无值 → 进入联系人选择页面
```

### 2. 切换联系人

```
用户在对话界面点击右上角👤
    ↓
进入联系人选择页面
    ↓
用户点击某个联系人
    ↓
保存 lastContactId + 创建新会话 → 返回对话界面
```

### 3. 查看历史会话

```
用户在对话界面点击左上角☰
    ↓
进入会话历史页面（显示当前联系人的会话）
    ↓
用户点击某个会话
    ↓
加载该会话内容 → 返回对话界面
```

---

## ⚙️ 非功能需求

### 性能要求
| 指标 | 要求 |
|------|------|
| 页面切换时间 | < 200ms |
| 会话列表加载时间 | < 500ms（100条会话） |
| 联系人列表加载时间 | < 500ms（100个联系人） |
| 流式响应首字延迟 | < 1000ms |

### 兼容性要求
| 指标 | 要求 |
|------|------|
| 最低Android版本 | Android 7.0 (API 24) |
| 目标Android版本 | Android 15 (API 35) |
| 支持屏幕尺寸 | 手机（4.7" - 6.7"） |
| 支持屏幕方向 | 竖屏 |

### 安全性要求
| 指标 | 要求 |
|------|------|
| 偏好设置存储 | 使用EncryptedSharedPreferences加密存储 |
| 日志输出 | 不在日志中输出敏感信息（联系人ID、会话内容） |

---

## 🔧 技术约束

### 技术栈限制
| 类型 | 要求 |
|------|------|
| UI框架 | Jetpack Compose（必须使用） |
| 导航 | Navigation Compose（必须使用） |
| 依赖注入 | Hilt（必须使用） |
| 状态管理 | StateFlow + ViewModel（必须使用） |
| 数据流 | Kotlin Flow（必须使用） |

### 架构限制
| 类型 | 要求 |
|------|------|
| 架构模式 | Clean Architecture + MVVM |
| 依赖方向 | 表现层 → 领域层 → 数据层 |
| Screen位置 | `:presentation/ui/screen/advisor/` |
| ViewModel位置 | `:presentation/viewmodel/` |
| Preferences位置 | `:data/local/` |

---

## 📊 数据持久化

### AI军师偏好设置

存储位置：`EncryptedSharedPreferences` - `ai_advisor_preferences`

| 字段 | 类型 | 说明 |
|------|------|------|
| `lastContactId` | String | 上次使用的联系人ID |
| `lastSessionId` | String? | 上次使用的会话ID（可选） |

---

## 🗄️ 数据库变更

### Entity变更
- ❌ 不需要新增Entity（使用现有`AiAdvisorSessionEntity`和`AiAdvisorConversationEntity`）

### DAO变更
- ✅ 需要在`AiAdvisorSessionDao`中确认以下方法存在：

```kotlin
@Query("SELECT * FROM ai_advisor_sessions WHERE contact_id = :contactId ORDER BY updated_at DESC")
fun getSessionsByContactId(contactId: String): Flow<List<AiAdvisorSessionEntity>>

@Query("SELECT id FROM ai_advisor_sessions WHERE contact_id = :contactId ORDER BY updated_at DESC LIMIT 1")
fun getLatestSessionId(contactId: String): Flow<String?>
```

### Migration
- ❌ 不需要数据库Migration（不修改表结构）

---

## 🏗️ 业务逻辑层变更

### Repository变更
- ❌ 不需要新增Repository（使用现有`AiAdvisorRepository`和`ContactRepository`）

### UseCase变更
- ✅ 需要确认以下UseCase存在或新增：

| UseCase | 说明 | 状态 |
|---------|------|------|
| `GetSessionsByContactIdUseCase` | 获取联系人的所有会话 | 确认是否存在 |
| `GetAllContactsUseCase` | 获取所有联系人 | 确认是否存在 |
| `CreateNewSessionUseCase` | 创建新会话 | 确认是否存在 |
| `LoadSessionUseCase` | 加载指定会话 | 确认是否存在 |

---

## 🔌 DI模块集成

### 新增DI模块
- ❌ 不需要新增DI模块

### ViewModel注册
- ✅ 使用`@HiltViewModel`注解，Hilt自动注册，无需手动配置

```kotlin
@HiltViewModel
class SessionHistoryViewModel @Inject constructor(
    private val getSessionsByContactIdUseCase: GetSessionsByContactIdUseCase,
    private val savedStateHandle: SavedStateHandle
) : ViewModel()

@HiltViewModel
class ContactSelectViewModel @Inject constructor(
    private val getAllContactsUseCase: GetAllContactsUseCase
) : ViewModel()
```

---

## 🔗 调用链

### 会话历史页面调用链
```
SessionHistoryScreen
    ↓ (通过hiltViewModel()注入)
SessionHistoryViewModel
    ↓ (调用UseCase)
GetSessionsByContactIdUseCase(contactId)
    ↓ (调用Repository)
AiAdvisorRepository.getSessionsByContactId(contactId)
    ↓ (调用DAO)
AiAdvisorSessionDao.getSessionsByContactId(contactId)
```

### 联系人选择页面调用链
```
ContactSelectScreen
    ↓ (通过hiltViewModel()注入)
ContactSelectViewModel
    ↓ (调用UseCase)
GetAllContactsUseCase()
    ↓ (调用Repository)
ContactRepository.getAllProfiles()
    ↓ (调用DAO)
ContactDao.getAllProfiles()
```

---

## 🔗 路由定义

| 路由名 | 路径 | 参数 |
|--------|------|------|
| `AI_ADVISOR_CHAT` | `ai_advisor_chat/{contactId}` | contactId: 联系人ID |
| `AI_ADVISOR_SESSIONS` | `ai_advisor_sessions/{contactId}` | contactId: 联系人ID |
| `AI_ADVISOR_CONTACTS` | `ai_advisor_contacts` | 无 |

---

## 📝 字符串资源

### 需要新增的字符串资源

```xml
<!-- AI军师相关 -->
<string name="ai_advisor_title">AI 军师</string>
<string name="session_history_title">会话历史</string>
<string name="select_contact_title">选择联系人</string>
<string name="new_session">新建</string>
<string name="search_sessions">搜索会话</string>
<string name="search_contacts">搜索联系人</string>
<string name="empty_sessions_hint">暂无历史会话</string>
<string name="empty_contacts_hint">暂无联系人，请先添加</string>
<string name="welcome_title">共情</string>
<string name="welcome_subtitle">懂你所想，助你表达</string>
<string name="input_hint">输入消息或粘贴聊天记录...</string>
<string name="conversation_with">与 %s 的对话</string>
```

---

## 📁 文件清单

### 新增文件

| 文件 | 模块 | 说明 |
|------|------|------|
| `SessionHistoryScreen.kt` | :presentation | 会话历史页面 |
| `SessionHistoryViewModel.kt` | :presentation | 会话历史ViewModel |
| `SessionHistoryUiState.kt` | :presentation | 会话历史UI状态 |
| `ContactSelectScreen.kt` | :presentation | 联系人选择页面 |
| `ContactSelectViewModel.kt` | :presentation | 联系人选择ViewModel |
| `ContactSelectUiState.kt` | :presentation | 联系人选择UI状态 |
| `AiAdvisorPreferences.kt` | :data | AI军师偏好设置存储 |

### 修改文件

| 文件 | 模块 | 修改内容 |
|------|------|----------|
| `AiAdvisorChatScreen.kt` | :presentation | 导航栏改为☰和👤图标 |
| `AiAdvisorChatViewModel.kt` | :presentation | 添加自动恢复联系人逻辑 |
| `NavGraph.kt` | :presentation | 新增三个路由 |
| `NavRoutes.kt` | :presentation | 新增路由常量 |

---

## ✅ 验收标准

| 序号 | 验收项 | 标准 |
|------|--------|------|
| 1 | **🔴 UI原型一致性** | 所有页面必须与UI原型文件完全一致 |
| 2 | 三页面独立 | 对话界面、会话历史、联系人选择是三个独立全屏页面 |
| 3 | 自动恢复 | 进入AI军师自动恢复上次联系人+开启新会话 |
| 4 | 首次使用 | 无历史联系人时进入联系人选择页面 |
| 5 | 会话历史入口 | 左上角☰图标进入会话历史页面 |
| 6 | 联系人选择入口 | 右上角👤图标进入联系人选择页面 |
| 7 | 切换联系人 | 选择联系人后自动开启新会话 |
| 8 | iOS风格 | 所有页面遵循iOS设计规范 |
| 9 | 性能达标 | 页面切换<200ms，列表加载<500ms |

---

## 📚 关联文档

- [PRD-00026-AI军师对话功能需求](./PRD-00026-AI军师对话功能需求.md)
- [TDD-00026-AI军师对话功能技术设计](../TDD/TDD-00026-AI军师对话功能技术设计.md)
- [DR-00029-PRD00029文档审查报告](../DR/DR-00029-PRD00029文档审查报告.md)

---

**文档版本**: 3.0  
**最后更新**: 2026-01-06  
**更新内容**: 根据DR-00029审查报告补充需求背景、用户故事、非功能需求、技术约束、数据库变更、业务逻辑层变更、DI模块集成、调用链、字符串资源等章节
