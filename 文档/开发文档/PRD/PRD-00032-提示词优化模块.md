# PRD-00032: 提示词优化模块（Prompt Optimization Module）

## 文档信息

| 字段 | 内容 |
|-----|------|
| **文档编号** | PRD-00032 |
| **版本** | 1.0 |
| **创建日期** | 2026-01-08 |
| **状态** | 待开发 |
| **优先级** | P1 |
| **关联需求** | 用户反馈：提示词调优效率低 |

---

## 1. 需求背景

### 1.1 问题描述

当前提示词优化存在以下痛点：

| 问题 | 影响 | 现状 |
|-----|------|------|
| 调优需重新编译 | 开发效率低，每次修改提示词都要构建APK | 提示词硬编码在代码中 |
| 测试周期长 | 改一次等5-10分钟才能验证效果 | 无法快速迭代 |
| 无法A/B测试 | 无法对比不同提示词的效果 | 缺乏对比机制 |
| 效果评估主观 | 没有量化指标评估提示词好坏 | 依赖人工判断 |

### 1.2 用户故事

```
作为：提示词优化者
我希望：快速测试不同提示词的效果
以便：在不重新编译的情况下，找到最优的提示词配置
```

```
作为：开发者
我希望：有一个专门的调试模式来测试提示词
以便：快速定位和修复提示词相关问题
```

### 1.3 竞品参考

| 产品 | 提示词优化方式 | 启示 |
|-----|---------------|------|
| OpenAI Playground | 实时编辑 + 对比测试 | 可视化编辑界面 |
| LangSmith | 提示词版本管理 + 评估 | 版本追踪 + 效果分析 |
| Dify | 可视化提示词编排 | 拖拽式配置 |

---

## 2. 需求概述

### 2.1 目标

建立一个**独立的提示词优化模块**，支持：

1. **热更新测试** - 无需重新编译即可测试不同提示词
2. **快速对比** - 并排对比不同提示词版本的输出
3. **效果评估** - 量化分析提示词质量
4. **版本管理** - 提示词版本历史与回滚

### 2.2 核心功能

```
┌─────────────────────────────────────────────────────────────────────┐
│                    提示词优化模块 - 功能架构                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  提示词编辑器  │  │  A/B测试模式  │  │  效果分析器   │              │
│  │  (热更新)     │  │  (对比测试)   │  │  (质量评估)   │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  版本管理器   │  │  测试用例库   │  │  数据导出    │              │
│  │  (历史回滚)   │  │  (标准化测试) │  │  (离线分析)  │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 详细功能需求

### 3.1 功能模块一：提示词编辑器（Prompt Editor）

#### 3.1.1 功能描述
提供可视化界面编辑系统提示词，支持实时生效无需编译。

#### 3.1.2 界面设计

```
┌─────────────────────────────────────────────────────────────────┐
│  提示词优化器 [DEV MODE]                              ─ □ ×    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─ 场景选择 ─────────────────────────────────────────────────┐ │
│  │ [ANALYZE ▼]  │  系统提示词     │  用户提示词     │  合并预览 │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 编辑区 ───────────────────────────────────────────────────┐ │
│  │                                                             │ │
│  │  【系统 Header】(不可编辑)                                   │ │
│  │  ┌─────────────────────────────────────────┐               │ │
│  │  │ 你是用户的"恋爱军师"...                               │ │ │
│  │  └─────────────────────────────────────────┘               │ │
│  │                                                             │ │
│  │  【用户指令】(可编辑)                                         │ │
│  │  ┌─────────────────────────────────────────┐               │ │
│  │  │  分析时要特别关注对方的情绪变化...             [✓] [×]  │ │ │
│  │  └─────────────────────────────────────────┘               │ │
│  │                                                             │ │
│  │  【系统 Footer】(不可编辑)                                   │ │
│  │  ┌─────────────────────────────────────────┐               │ │
│  │  │  请以JSON格式返回...                               │ │ │
│  │  └─────────────────────────────────────────┘               │ │
│  │                                                             │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 操作按钮 ─────────────────────────────────────────────────┐ │
│  │  [保存并测试]  [恢复到默认]  [另存为版本A]  [对比版本B]      │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.1.3 功能需求

| 编号 | 功能描述 | 优先级 |
|-----|---------|-------|
| F-EDT-001 | 编辑各场景的系统提示词（Header/Footer） | P0 |
| F-EDT-002 | 实时预览提示词组装结果 | P0 |
| F-EDT-003 | 一键恢复到系统默认值 | P1 |
| F-EDT-004 | 保存为命名版本 | P1 |
| F-EDT-005 | 语法高亮显示 | P2 |
| F-EDT-006 | 变量占位符自动补全 | P2 |

### 3.2 功能模块二：A/B测试模式（A/B Testing）

#### 3.2.1 功能描述
对比两个不同提示词版本的输出效果，支持标准化测试输入。

#### 3.2.2 界面设计

```
┌─────────────────────────────────────────────────────────────────┐
│  A/B 对比测试                                          ─ □ ×    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─ 测试输入 ─────────────────────────────────────────────────┐ │
│  │                                                             │ │
│  │  对方消息："在干嘛？"                                         │ │
│  │                                                             │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 版本对比 ─────────────────────────────────────────────────┐ │
│  │                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐                          │ │
│  │  │  版本 A      │  │  版本 B      │                          │ │
│  │  │ [当前版本]   │  │ [测试版本]   │                          │ │
│  │  ├─────────────┤  ├─────────────┤                          │ │
│  │  │ 分析结果:    │  │ 分析结果:    │                          │ │
│  │  │ "SAFE..."  │  │ "WARNING..."│                          │ │
│  │  ├─────────────┤  ├─────────────┤                          │ │
│  │  │ 策略分析:    │  │ 策略分析:    │                          │ │
│  │  │ "她可能在..."│  │ "她在测试..."│                          │ │
│  │  ├─────────────┤  ├─────────────┤                          │ │
│  │  │ 建议回复:    │  │ 建议回复:    │                          │ │
│  │  │ "刚吃完饭"  │  │ "想我了？😊" │                          │ │
│  │  └─────────────┘  └─────────────┘                          │ │
│  │                                                             │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 差异高亮 ─────────────────────────────────────────────────┐ │
│  │  ⚠️ 输出差异检测                                            │ │
│  │     • 风险等级不同: SAFE vs WARNING                        │ │
│  │     • 策略建议差异: 稳定型 vs 主动型                         │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 操作按钮 ─────────────────────────────────────────────────┐ │
│  │  [运行测试]  [切换版本]  [保存优胜版本]                      │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.2.3 功能需求

| 编号 | 功能描述 | 优先级 |
|-----|---------|-------|
| F-ABT-001 | 并排显示两个版本的输出 | P0 |
| F-ABT-002 | 标准化测试输入（预设场景） | P0 |
| F-ABT-003 | 自动检测输出差异 | P1 |
| F-ABT-004 | 批量运行多组测试用例 | P1 |
| F-ABT-005 | 一键应用优胜版本 | P2 |

### 3.3 功能模块三：效果分析器（Quality Analyzer）

#### 3.3.1 功能描述
量化评估提示词生成结果的质量，提供客观指标。

#### 3.3.2 评估指标

| 指标 | 说明 | 计算方式 |
|-----|------|---------|
| **响应相关性** | 输出是否针对输入 | NLP相似度计算 |
| **格式合规性** | 是否符合JSON格式要求 | JSON Schema验证 |
| **风险识别准确率** | 风险判断是否合理 | 人工标注基准对比 |
| **建议可行性** | 回复建议是否可执行 | 规则判断 + 人工反馈 |
| **响应一致性** | 相同输入的输出一致性 | 多次测试方差 |

#### 3.3.3 界面设计

```
┌─────────────────────────────────────────────────────────────────┐
│  效果分析报告                                          ─ □ ×    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─ 质量评分卡 ───────────────────────────────────────────────┐ │
│  │                                                             │ │
│  │    整体评分: ★★★★☆ (4.2/5)                                 │ │
│  │                                                             │ │
│  │  ┌─────────────────────────────────────────────────────┐   │ │
│  │  │ 响应相关性  ████████████░░░░░░  85%                  │   │ │
│  │  │ 格式合规性  ████████████████░░  95%                  │   │ │
│  │  │ 风险识别    ██████████░░░░░░░░  70%                  │   │ │
│  │  │ 建议可行性  ████████████░░░░░░  80%                  │   │ │
│  │  │ 一致性      ████████████████░░  90%                  │   │ │
│  │  └─────────────────────────────────────────────────────┘   │ │
│  │                                                             │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 问题诊断 ─────────────────────────────────────────────────┐ │
│  │                                                             │ │
│  │  ⚠️ 发现的问题:                                              │ │
│  │     1. 风险识别偏低 - 建议增加风险识别关键词                  │ │
│  │     2. 回复建议偏保守 - 建议调整主动性                        │ │
│  │                                                             │ │
│  │  💡 优化建议:                                                │ │
│  │     • 在Header中添加"关注潜台词"提示                         │ │
│  │     • 在Footer中强调"给出主动型建议"                         │ │
│  │                                                             │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.3.4 功能需求

| 编号 | 功能描述 | 优先级 |
|-----|---------|-------|
| F-ANL-001 | 自动计算质量评分 | P1 |
| F-ANL-002 | 问题诊断与优化建议 | P1 |
| F-ANL-003 | 历史趋势图表 | P2 |
| F-ANL-004 | 与基准版本对比 | P2 |

### 3.4 功能模块四：版本管理器（Version Manager）

#### 3.4.1 功能描述
管理提示词的版本历史，支持版本对比和回滚。

#### 3.4.2 数据结构

```kotlin
/**
 * 提示词版本
 */
data class PromptVersion(
    val id: String,                    // 版本唯一标识
    val scene: PromptScene,            // 场景类型
    val header: String,                // 系统Header
    val footer: String,                // 系统Footer
    val userInstruction: String,       // 用户指令
    val createdAt: Long,               // 创建时间
    val createdBy: String,             // 创建者（用户/系统）
    val tags: List<String>,            // 标签（stable/experimental等）
    val note: String,                  // 版本说明
    val metrics: PromptMetrics?        // 效果指标（如果有）
)

/**
 * 提示词效果指标
 */
data class PromptMetrics(
    val testCount: Int,                // 测试次数
    val avgRelevanceScore: Float,      // 平均相关性分数
    val avgFormatCompliance: Float,    // 平均格式合规率
    val avgRiskRecall: Float,          // 平均风险召回率
    val avgSuggestionFeasibility: Float // 平均建议可行性
)
```

#### 3.4.3 功能需求

| 编号 | 功能描述 | 优先级 |
|-----|---------|-------|
| F-VER-001 | 自动保存版本历史 | P0 |
| F-VER-002 | 版本对比（Diff视图） | P1 |
| F-VER-003 | 一键回滚到指定版本 | P1 |
| F-VER-004 | 标记稳定/实验版本 | P2 |

### 3.5 功能模块五：测试用例库（Test Case Library）

#### 3.5.1 功能描述
标准化测试用例集，确保测试可比性。

#### 3.5.2 数据结构

```kotlin
/**
 * 测试用例
 */
data class TestCase(
    val id: String,                    // 用例唯一标识
    val name: String,                  // 用例名称
    val scene: PromptScene,            // 适用场景
    val input: String,                 // 输入消息
    val expectedRiskLevel: String,     // 预期风险等级
    val expectedKeywords: List<String>, // 预期包含关键词
    val category: TestCategory,        // 用例分类
    val description: String            // 用例描述
)

/**
 * 测试用例分类
 */
enum class TestCategory {
    NORMAL,           // 正常对话
    FLIRTING,         // 暧昧场景
    CONFLICT,         // 冲突场景
    TESTING,          // 废物测试
    GHOSTING,         // 冷战/失联
    COMPLAIN,         // 抱怨/负面情绪
    URGENT,           // 紧急情况
    CUSTOM            // 自定义
}
```

#### 3.5.3 预设测试用例集

| 用例名称 | 输入 | 预期风险 | 分类 |
|---------|------|---------|------|
| 正常问候 | "在干嘛？ | SAFE | NORMAL |
| 暧昧试探 | "今天好想你" | SAFE | FLIRTING |
| 废物测试 | "你为什么对我这么好？" | WARNING | TESTING |
| 负面情绪 | "烦死了，工作好累" | SAFE | COMPLAIN |
| 冷战信号 | "哦" | DANGER | GHOSTING |
| 紧急求助 | "我生病了" | SAFE | URGENT |

#### 3.5.4 功能需求

| 编号 | 功能描述 | 优先级 |
|-----|---------|-------|
| F-TST-001 | 预设标准测试用例集 | P0 |
| F-TST-002 | 自定义测试用例 | P1 |
| F-TST-003 | 批量运行测试集 | P1 |
| F-TST-004 | 测试结果导出 | P2 |

---

## 4. 技术设计

### 4.1 架构设计

```
┌─────────────────────────────────────────────────────────────────────┐
│                      提示词优化模块 - 架构设计                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                     Presentation Layer                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │ │
│  │  │PromptEditor │  │ABTestScreen │  │AnalyticsDashboard      │ │ │
│  │  │Screen       │  │             │  │                        │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                     ViewModel Layer                            │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │ │
│  │  │PromptEditor │  │ABTestView   │  │AnalyticsViewModel      │ │ │
│  │  │ViewModel    │  │Model        │  │                        │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                     Domain Layer (新增)                        │ │
│  │  ┌─────────────────────────────────────────────────────────┐  │ │
│  │  │  UseCase                                                 │  │ │
│  │  │  ├── TestPromptUseCase         - 测试提示词              │  │ │
│  │  │  ├── ComparePromptsUseCase     - 对比提示词              │  │ │
│  │  │  ├── AnalyzePromptUseCase      - 分析提示词质量          │  │ │
│  │  │  ├── ManagePromptVersionsUseCase- 管理版本              │  │ │
│  │  │  └── ManageTestCasesUseCase    - 管理测试用例            │  │ │
│  │  └─────────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────────┐  │ │
│  │  │  Repository                                             │  │ │
│  │  │  ├── PromptTestRepository       - 测试数据访问           │  │ │
│  │  │  └── TestCaseRepository         - 测试用例访问           │  │ │
│  │  └─────────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                     Data Layer                                 │ │
│  │  ┌─────────────────────────────────────────────────────────┐  │ │
│  │  │  Local                                                  │  │ │
│  │  │  ├── PromptTestStorage          - 测试数据存储          │  │ │
│  │  │  ├── TestCaseStorage            - 测试用例存储          │  │ │
│  │  │  └── PromptVersionStorage       - 版本历史存储          │  │ │
│  │  └─────────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 模块结构

```
domain/src/main/kotlin/com/empathy/ai/domain/
├── model/
│   ├── prompt/
│   │   ├── PromptVersion.kt           # 提示词版本模型
│   │   ├── PromptMetrics.kt           # 效果指标模型
│   │   ├── TestCase.kt                # 测试用例模型
│   │   └── TestCategory.kt            # 测试分类枚举
│   └── usecase/
│       └── prompt/
│           ├── TestPromptUseCase.kt          # 测试提示词
│           ├── ComparePromptsUseCase.kt      # 对比提示词
│           ├── AnalyzePromptUseCase.kt       # 分析提示词质量
│           ├── ManagePromptVersionsUseCase.kt # 管理版本
│           └── ManageTestCasesUseCase.kt     # 管理测试用例
└── repository/
    ├── PromptTestRepository.kt        # 测试数据仓库接口
    └── TestCaseRepository.kt          # 测试用例仓库接口

data/src/main/kotlin/com/empathy/ai/data/
├── local/
│   ├── PromptTestStorage.kt           # 测试数据存储实现
│   ├── TestCaseStorage.kt             # 测试用例存储实现
│   └── PromptVersionStorage.kt        # 版本历史存储实现
└── repository/
    ├── PromptTestRepositoryImpl.kt    # 测试数据仓库实现
    └── TestCaseRepositoryImpl.kt      # 测试用例仓库实现

presentation/src/main/kotlin/com/empathy/ai/presentation/
├── ui/
│   └── screen/
│       └── prompt/
│           ├── PromptOptimizerScreen.kt       # 优化器主界面
│           ├── PromptEditorScreen.kt          # 编辑界面
│           ├── ABTestScreen.kt                # A/B测试界面
│           └── AnalyticsScreen.kt             # 分析报告界面
└── viewmodel/
    ├── PromptOptimizerViewModel.kt    # 优化器ViewModel
    ├── ABTestViewModel.kt             # A/B测试ViewModel
    └── AnalyticsViewModel.kt          # 分析ViewModel
```

### 4.3 入口模式设计（Debug Mode）

#### 4.3.1 启动模式

通过编译选项或Debug设置启用提示词优化模块：

```kotlin
/**
 * 启动模式
 */
enum class AppLaunchMode {
    NORMAL,           // 正常启动
    PROMPT_OPTIMIZER  // 提示词优化模式
}
```

#### 4.3.2 启动入口

```
启动流程:
1. 检查 SettingsRepository.isPromptOptimizerEnabled()
2. 如果启用，直接进入 PromptOptimizerScreen
3. 否则，正常启动应用
```

#### 4.3.3 启用方式（按优先级）

| 方式 | 说明 | 触发条件 |
|-----|------|---------|
| **编译选项** | Gradle参数 `-Dprompt.optimizer=true` | 开发者编译时 |
| **Dev Build** | Debug变体自动启用 | 构建变体 |
| **快捷入口** | 设置页隐藏入口（5次点击） | 用户触发 |
| **ADB命令** | `adb shell am start -n com.empathy.ai/.ui.MainActivity --ez optimizer true` | 调试时 |

### 4.4 关键API设计

#### 4.4.1 提示词测试API

```kotlin
/**
 * 测试提示词用例
 *
 * @param prompt 完整提示词
 * @param testCase 测试用例
 * @param aiRepository AI服务（用于执行测试）
 * @return 测试结果
 */
class TestPromptUseCase(
    private val aiRepository: AiRepository
) {
    suspend operator fun invoke(
        prompt: String,
        testCase: TestCase
    ): TestResult
}

/**
 * 测试结果
 */
data class TestResult(
    val testCaseId: String,
    val rawResponse: String,
    val parsedResponse: Map<String, Any>,
    val riskLevel: String,
    val strategyAnalysis: String,
    val replySuggestion: String?,
    val isFormatValid: Boolean,
    val containsKeywords: Boolean,
    val responseTimeMs: Long
)
```

#### 4.4.2 提示词对比API

```kotlin
/**
 * 对比两个提示词版本
 *
 * @param versionA 版本A
 * @param versionB 版本B
 * @param testCases 测试用例集
 * @return 对比报告
 */
class ComparePromptsUseCase(
    private val testPromptUseCase: TestPromptUseCase
) {
    suspend operator fun invoke(
        versionA: PromptVersion,
        versionB: PromptVersion,
        testCases: List<TestCase>
    ): ComparisonReport
}

/**
 * 对比报告
 */
data class ComparisonReport(
    val versionA: PromptVersion,
    val versionB: PromptVersion,
    val testResultsA: List<TestResult>,
    val testResultsB: List<TestResult>,
    val differences: List<ResponseDifference>,
    val winner: PromptVersion?,
    val metricsComparison: MetricsComparison
)
```

#### 4.4.3 质量分析API

```kotlin
/**
 * 分析提示词质量
 *
 * @param prompt 提示词
 * @param testResults 测试结果集
 * @return 质量分析报告
 */
class AnalyzePromptUseCase {
    suspend operator fun invoke(
        prompt: String,
        testResults: List<TestResult>
    ): QualityReport
}

/**
 * 质量分析报告
 */
data class QualityReport(
    val overallScore: Float,
    val metrics: PromptMetrics,
    val issues: List<QualityIssue>,
    val suggestions: List<OptimizationSuggestion>,
    val trend: ScoreTrend?
)

/**
 * 质量问题
 */
data class QualityIssue(
    val type: IssueType,
    val description: String,
    val severity: Severity,
    val affectedTests: List<String>
)
```

---

## 5. 数据存储

### 5.1 存储文件结构

```
data/
└── prompt_optimizer/
    ├── versions/                      # 版本历史
    │   ├── ANALYZE_v1.json
    │   ├── ANALYZE_v2.json
    │   └── ...
    ├── test_results/                  # 测试结果
    │   ├── 2026-01-08/
    │   │   ├── test_001_result.json
    │   │   └── test_002_result.json
    │   └── ...
    └── test_cases/                    # 测试用例库
        ├── default.json               # 预设用例
        └── custom.json                # 自定义用例
```

### 5.2 数据模型JSON示例

#### 版本历史

```json
{
  "versionId": "v_20260108_143022",
  "scene": "ANALYZE",
  "header": "你是用户的\"恋爱军师\"...",
  "footer": "请以JSON格式返回...",
  "userInstruction": "分析时要特别关注对方的情绪变化",
  "createdAt": 1704695422000,
  "createdBy": "user",
  "tags": ["stable"],
  "note": "优化了风险识别关键词",
  "metrics": {
    "testCount": 10,
    "avgRelevanceScore": 0.85,
    "avgFormatCompliance": 0.95,
    "avgRiskRecall": 0.70,
    "avgSuggestionFeasibility": 0.80
  }
}
```

#### 测试结果

```json
{
  "resultId": "res_001",
  "testCaseId": "tc_001",
  "promptVersionId": "v_20260108_143022",
  "timestamp": 1704695422000,
  "rawResponse": "{\"replySuggestion\": \"...\"}",
  "parsedResponse": {
    "replySuggestion": "刚吃完饭",
    "strategyAnalysis": "对方可能在试探你的状态",
    "riskLevel": "SAFE"
  },
  "isFormatValid": true,
  "containsKeywords": true,
  "responseTimeMs": 1200
}
```

---

## 6. 用户界面原型

### 6.1 优化器主界面

```
┌─────────────────────────────────────────────────────────────────┐
│  提示词优化器 [DEV MODE]                              ─ □ ×    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─ 模式选择 ─────────────────────────────────────────────────┐ │
│  │  ○ 提示词编辑器    ● A/B测试    ○ 效果分析    ○ 版本历史   │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 快速操作 ─────────────────────────────────────────────────┐ │
│  │  [📝 编辑当前提示词]  [⚖️ 对比版本]  [📊 查看分析]          │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 当前状态 ─────────────────────────────────────────────────┐ │
│  │  场景: ANALYZE                                             │ │
│  │  版本: v_20260108_143022 (stable)                          │ │
│  │  测试次数: 10    平均分: 4.2/5                             │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 最近活动 ─────────────────────────────────────────────────┐ │
│  │  • 10:30 运行了A/B测试 - 版本B获胜                          │ │
│  │  • 10:15 保存了新版本 v_20260108_143022                     │ │
│  │  • 09:45 恢复到默认配置                                     │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 设置 ─────────────────────────────────────────────────────┐ │
│  │  [☐] 启用自动化测试    [☐] 启用效果追踪                     │ │
│  │  预设测试用例: 默认集合 (6个)                               │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 提示词编辑器界面

```
┌─────────────────────────────────────────────────────────────────┐
│  提示词编辑器 - ANALYZE                    [保存] [取消] ─ □ ×    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─ 系统提示词（Header）───────────────────────────────────────┐ │
│  │ ┌─────────────────────────────────────────────────────────┐ │ │
│  │ │ 你是用户的"恋爱军师"和"社交策略专家"...                  │ │ │
│  │ └─────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 用户自定义指令 ───────────────────────────────────────────┐ │
│  │                                                             │ │
│  │ 分析时要特别关注对方的情绪变化，给出温和的回复建议            │ │
│  │ 如果对方在生气，先安抚情绪再分析                             │ │
│  │                                                             │ │
│  │ (字符: 78/1000)                     [✓ 格式正确]            │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 系统提示词（Footer）───────────────────────────────────────┐ │
│  │ ┌─────────────────────────────────────────────────────────┐ │ │
│  │ │ 请以JSON格式返回分析结果...                              │ │ │
│  │ └─────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 实时预览 ─────────────────────────────────────────────────┐ │
│  │ 完整提示词预览（仅显示前500字符）                            │ │
│  │ ┌─────────────────────────────────────────────────────────┐ │ │
│  │ │ 你是用户的"恋爱军师"...                                  │ │ │
│  │ │ 【用户自定义指令】分析时要特别关注...                     │ │ │
│  │ │ 【上下文数据】...                                        │ │ │
│  │ │ 请以JSON格式返回...                                      │ │ │
│  │ └─────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 验收标准

### 7.1 功能验收

| 编号 | 验收标准 | 优先级 |
|-----|---------|-------|
| AC-001 | 用户可以在不重新编译的情况下编辑系统提示词 | P0 |
| AC-002 | 用户可以对比两个提示词版本的输出差异 | P0 |
| AC-003 | 系统提供预设的标准化测试用例 | P0 |
| AC-004 | 系统自动计算提示词效果评分 | P1 |
| AC-005 | 用户可以回滚到任意历史版本 | P1 |
| AC-006 | 用户可以将提示词导出为JSON文件 | P2 |
| AC-007 | 系统提供问题诊断和优化建议 | P2 |

### 7.2 性能验收

| 编号 | 验收标准 | 指标 |
|-----|---------|------|
| PC-001 | 提示词保存后立即生效 | < 100ms |
| PC-002 | A/B测试运行10个用例总耗时 | < 30s |
| PC-003 | 界面切换无明显卡顿 | 60fps |
| PC-004 | 历史版本存储空间占用 | < 10MB |

### 7.3 兼容性验收

| 编号 | 验收标准 |
|-----|---------|
| CC-001 | 与现有提示词系统兼容（不破坏原有功能） |
| CC-002 | 与AI军师功能兼容 |
| CC-003 | 与悬浮窗功能兼容 |

---

## 8. 实施计划

### 8.1 第一阶段：核心框架（MVP）

**目标**：建立基础框架，实现编辑器核心功能

| 任务 | 说明 | 依赖 |
|-----|------|-----|
| T-001 | 创建领域模型（PromptVersion, TestCase等） | - |
| T-002 | 创建存储层（PromptVersionStorage等） | T-001 |
| T-003 | 实现PromptOptimizerViewModel | T-001, T-002 |
| T-004 | 实现提示词编辑器UI | T-003 |
| T-005 | 集成测试验证 | T-004 |

### 8.2 第二阶段：A/B测试

**目标**：实现对比测试功能

| 任务 | 说明 | 依赖 |
|-----|------|-----|
| T-006 | 实现TestPromptUseCase | - |
| T-007 | 实现ComparePromptsUseCase | T-006 |
| T-008 | 实现ABTestViewModel | T-006, T-007 |
| T-009 | 实现A/B测试界面UI | T-008 |
| T-010 | 集成测试验证 | T-009 |

### 8.3 第三阶段：效果分析

**目标**：实现质量评估功能

| 任务 | 说明 | 依赖 |
|-----|------|-----|
| T-011 | 实现AnalyzePromptUseCase | - |
| T-012 | 实现AnalyticsViewModel | T-011 |
| T-013 | 实现效果分析界面UI | T-012 |
| T-014 | 集成测试验证 | T-013 |

### 8.4 第四阶段：完善与优化

**目标**：完善细节，提升体验

| 任务 | 说明 | 依赖 |
|-----|------|-----|
| T-015 | 版本历史与回滚功能 | - |
| T-016 | 自定义测试用例功能 | - |
| T-017 | 数据导出功能 | - |
| T-018 | UI/UX优化 | T-015, T-016, T-017 |
| T-019 | 完整集成测试 | T-018 |

---

## 9. 风险与依赖

### 9.1 风险

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 与现有系统冲突 | 可能破坏现有功能 | 隔离测试，充分验证 |
| 性能问题 | 大量测试耗时长 | 异步执行，批量处理 |
| 数据迁移 | 旧版本提示词兼容 | 向后兼容，旧数据迁移 |

### 9.2 依赖

| 依赖 | 说明 |
|-----|------|
| AI Repository | 用于执行测试调用 |
| Prompt Repository | 用于读取/保存提示词 |
| Settings Repository | 用于保存模块设置 |

---

## 10. 相关文档

| 文档 | 说明 |
|-----|------|
| [TDD-00007](文档/特殊要求/提示词系统三层分离架构设计.md) | 提示词系统三层分离架构 |
| [PRD-00005](../开发文档/PRD/提示词管理系统需求.md) | 提示词管理系统需求 |
| [domain/CLAUDE.md](../../domain/CLAUDE.md) | 领域层文档 |
| [presentation/CLAUDE.md](../../presentation/CLAUDE.md) | 表现层文档 |

---

**文档版本**: 1.0
**最后更新**: 2026-01-08
**更新者**: Claude
