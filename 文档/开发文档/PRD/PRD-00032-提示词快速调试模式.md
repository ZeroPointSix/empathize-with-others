# PRD-00032: 提示词快速调试模式

## 极简需求

**目标**：启动时快速编辑系统提示词，立即测试效果，无需重新编译。

---

## 入口方式（任选其一即可）

| 方式 | 命令/操作 |
|-----|----------|
| **ADB启动** | `adb shell am start -n com.empathy.ai/.ui.MainActivity --ez prompt_debug true` |
| **编译选项** | `./gradlew assembleDebug -Dprompt.debug=true` |
| **快捷入口** | 设置页连续点击Logo 5次（隐藏入口） |

---

## 启动流程

```
启动应用
    │
    ├─→ 检查 isPromptDebugMode?
    │       │
    │       ├─→ [否] → 正常启动应用
    │       │
    │       └─→ [是] → 进入提示词调试主界面
    │
    └─→ 调试主界面
            │
            ├─→ 选择场景 (ANALYZE/CHECK/POLISH/REPLY...)
            │
            ├─→ 编辑 Header / Footer / User指令
            │
            ├─→ [保存] → 立即生效
            │
            └─→ [测试] → 输入测试消息，查看AI回复
```

---

## 界面设计（一个屏幕搞定）

```
┌─────────────────────────────────────────────────────────┐
│  🔧 提示词调试模式                              [返回]   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  【场景选择】                                            │
│  ┌─────────────────────────────────────────────────┐   │
│  │ [ANALYZE ▼] 聊天分析   [v] 立即生效             │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─ Header (角色定义) ──────────────────────────────┐  │
│  │ ┌───────────────────────────────────────────────┐ │  │
│  │ │ 你是用户的"恋爱军师"...                       │ │  │
│  │ └───────────────────────────────────────────────┘ │  │
│  │ [编辑]  [恢复默认]                               │  │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
│  ┌─ 用户指令 (可编辑) ──────────────────────────────┐  │
│  │ ┌───────────────────────────────────────────────┐ │  │
│  │ │                                               │ │  │
│  │ │  分析时要特别关注对方的情绪变化...             │ │  │
│  │ │                                               │ │  │
│  │ │  (字符: 78/1000)                              │ │  │
│  │ └───────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
│  ┌─ Footer (输出格式) ──────────────────────────────┐  │
│  │ ┌───────────────────────────────────────────────┐ │  │
│  │ │  请以JSON格式返回分析结果...                   │ │  │
│  │ └───────────────────────────────────────────────┘ │  │
│  │ [编辑]  [恢复默认]                               │  │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
│  ┌─ 快速测试 ───────────────────────────────────────┐  │
│  │                                                    │  │
│  │  输入测试消息:                                     │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │  在干嘛？                                [发送]│  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  │                                                    │  │
│  │  AI回复:                                          │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │  {"replySuggestion": "...", ...}           │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  │                                                    │  │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 最小实现范围

### 只改这些文件：

| 文件 | 改动 |
|-----|------|
| `MainActivity.kt` | 检测启动参数，决定进入调试模式还是正常模式 |
| `SettingsRepository` | 添加 `isPromptDebugMode()` 方法 |
| `presentation/navigation/NavGraph.kt` | 添加调试模式入口 |
| `presentation/ui/screen/` | 新建 `PromptDebugScreen.kt` (一个文件搞定) |
| `presentation/viewmodel/` | 新建 `PromptDebugViewModel.kt` |

### 不做这些：

- ~~版本管理~~（没必要）
- ~~A/B测试对比~~（太复杂）
- ~~效果分析评分~~（够用就行）
- ~~测试用例库~~（手动输入测试消息）
- ~~导出功能~~（没必要）

---

## 核心代码逻辑

```kotlin
// MainActivity.kt
@Composable
fun MainApp() {
    val isDebugMode = remember {
        intent.getBooleanExtra("prompt_debug", false) ||
        getDebugModeFromSettings()
    }

    if (isDebugMode) {
        PromptDebugScreen(
            onExit = { finish() }
        )
    } else {
        NavGraph() // 正常启动
    }
}
```

```kotlin
// PromptDebugViewModel.kt
class PromptDebugViewModel : ViewModel() {
    // 场景列表
    val scenes = listOf(ANALYZE, CHECK, POLISH, REPLY, SUMMARY)

    // 当前选中的场景
    var currentScene by mutableStateOf(ANALYZE)

    // 当前场景的提示词
    var header by mutableStateOf(SystemPrompts.getHeader(currentScene))
    var footer by mutableStateOf(SystemPrompts.getFooter(currentScene))
    var userInstruction by mutableStateOf("")

    // 测试结果
    var testResult by mutableStateOf<String?>(null)

    // 保存
    fun save() {
        // 立即保存到 PromptRepository
        promptRepository.saveGlobalPrompt(currentScene, userInstruction)
    }

    // 测试
    fun test(input: String) {
        // 调用 AI 接口，获取回复
        val result = aiRepository.sendMessage(buildPrompt(), input)
        testResult = result
    }
}
```

---

## 验收标准

| 完成度 | 标准 |
|-------|------|
| ✅ | ADB启动能进入调试界面 |
| ✅ | 可以编辑所有场景的提示词 |
| ✅ | 保存后立即生效 |
| ✅ | 可以手动输入消息测试效果 |
| ✅ | 能返回正常模式 |

---

## 实施步骤

1. 修改 `MainActivity` 添加启动参数检测
2. 创建 `PromptDebugScreen` (一个Compose文件)
3. 创建 `PromptDebugViewModel`
4. 集成现有 `PromptRepository` 和 `AiRepository`
5. 测试 ADB 启动方式

---

**版本**: 0.1 (极简版)
**最后更新**: 2026-01-08
