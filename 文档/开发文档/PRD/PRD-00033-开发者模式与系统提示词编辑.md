# PRD-00033: 开发者模式与系统提示词编辑

## 文档信息

| 字段 | 内容 |
|-----|------|
| **文档编号** | PRD-00033 |
| **版本** | 1.0 |
| **创建日期** | 2026-01-08 |
| **状态** | 待开发 |
| **优先级** | P1 |
| **关联需求** | 提示词优化迭代效率提升 |

---

## 1. 需求背景

### 1.1 问题描述

当前系统提示词（Header/Footer）硬编码在 `SystemPrompts.kt` 中，每次修改都需要重新编译APK，严重影响提示词优化迭代效率。

| 问题 | 影响 |
|-----|------|
| 修改需重编译 | 每次调整提示词需要5-10分钟构建时间 |
| 无法快速验证 | 难以快速对比不同提示词的效果 |
| 开发效率低 | 提示词优化周期长，迭代慢 |

### 1.2 用户故事

```
作为：提示词优化者
我希望：在运行时直接编辑系统提示词并立即生效
以便：快速测试不同提示词的效果，无需重新编译APK
```

### 1.3 设计参考

参考 Android 系统设置中的"开发者选项"设计：
- 隐藏入口：连续点击"版本号"7次解锁
- 解锁后显示"开发者选项"菜单
- 提供开发调试相关功能

---

## 2. 功能范围

### 2.1 MVP功能清单

| 功能 | 说明 | 优先级 |
|-----|------|-------|
| 开发者模式入口 | 点击版本号7次解锁 | P0 |
| 开发者选项界面 | 设置页面显示开发者选项区域 | P0 |
| 系统提示词编辑 | 编辑6个场景的Header/Footer | P0 |
| 文件导入导出 | 支持MD/TXT/JSON格式 | P1 |
| 恢复默认 | 一键恢复到系统默认提示词 | P1 |

### 2.2 不包含功能（后续版本）

- ~~版本管理~~ - MVP不需要
- ~~A/B测试对比~~ - MVP不需要
- ~~效果评分分析~~ - MVP不需要
- ~~测试用例库~~ - MVP不需要

---

## 3. 详细功能设计

### 3.1 开发者模式入口

#### 3.1.1 触发方式

在设置页面的"关于"区域，连续点击**版本号**7次解锁开发者模式。

#### 3.1.2 交互流程

```
用户在设置页面
    │
    ├─→ 点击版本号（第1-6次）
    │       └─→ 显示Toast: "再点击 X 次进入开发者模式"
    │
    └─→ 点击版本号（第7次）
            └─→ 显示Toast: "已进入开发者模式"
            └─→ 设置页面底部显示"开发者选项"区域
```

#### 3.1.3 持久化规则

- **不持久化**：每次启动App都需要重新解锁
- 解锁状态仅在当前App生命周期内有效
- App退出或被杀死后，下次启动需重新解锁

#### 3.1.4 UI设计

```
┌─────────────────────────────────────────────────────────────┐
│  设置                                                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ 关于 ─────────────────────────────────────────────────┐ │
│  │                                                         │ │
│  │  应用名称: 共情AI助手                                    │ │
│  │  版本号: v1.0.0  ← [点击7次解锁]                         │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ... 其他设置项 ...                                          │
│                                                             │
│  ┌─ 开发者选项 ───────────────────────────────────────────┐ │
│  │  (解锁后显示)                                           │ │
│  │                                                         │ │
│  │  📝 系统提示词编辑                                       │ │
│  │     编辑AI场景的系统提示词                               │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


### 3.2 系统提示词编辑

#### 3.2.1 支持的场景

> **说明**：开发者模式支持编辑5个AI场景的系统提示词。

| 序号 | 场景 | 枚举/常量 | 说明 | 状态 |
|------|------|----------|------|------|
| 1 | 聊天分析 | `ANALYZE` | 分析对方说的话，提供沟通建议 | ✅ 核心场景 |
| 2 | 润色优化 | `POLISH` | 优化用户草稿，使表达更得体（含风险检查） | ✅ 核心场景 |
| 3 | 生成回复 | `REPLY` | 根据对方消息生成合适的回复 | ✅ 核心场景 |
| 4 | 每日总结 | `SUMMARY` | 生成每日对话总结 | ✅ 核心场景 |
| 5 | AI军师 | `AI_ADVISOR` | AI军师对话模式，提供深度策略分析 | ✅ 核心场景 |

> **注意**：CHECK和EXTRACT场景已废弃（TD-00015），不在开发者模式中显示。

#### 3.2.2 编辑内容

每个场景包含两部分可编辑内容：

| 部分 | 说明 | 示例 |
|-----|------|------|
| **Header** | 角色定义，定义AI的身份和任务 | "你是用户的恋爱军师..." |
| **Footer** | 输出格式约束，定义AI的输出格式 | "请以JSON格式返回..." |

#### 3.2.3 界面设计

**场景列表页**

```
┌─────────────────────────────────────────────────────────────┐
│  ← 系统提示词编辑                                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  选择要编辑的AI场景：                                         │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 🔍 聊天分析 (ANALYZE)                                 > ││
│  │    分析对方说的话，提供沟通建议                           ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ ✍️ 润色优化 (POLISH)                                  > ││
│  │    优化用户草稿，使表达更得体                             ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 💬 生成回复 (REPLY)                                   > ││
│  │    根据对方消息生成合适的回复                             ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 📊 每日总结 (SUMMARY)                                 > ││
│  │    生成每日对话总结                                      ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 🎯 AI军师 (AI_ADVISOR)                                > ││
│  │    AI军师对话模式，提供深度策略分析                       ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  [📤 导出全部]    [📥 导入配置]    [🔄 恢复全部默认]      ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**场景编辑页**（复用现有提示词编辑器组件）

```
┌─────────────────────────────────────────────────────────────┐
│  ← 聊天分析 (ANALYZE)                            [保存]     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ Header (角色定义) ────────────────────────────────────┐ │
│  │                                                         │ │
│  │  ┌─────────────────────────────────────────────────┐   │ │
│  │  │ 你是用户的"恋爱军师"和"社交策略专家"。           │   │ │
│  │  │                                                 │   │ │
│  │  │ 【你的人设】                                     │   │ │
│  │  │ 说话风格：犀利、直球、高情商、像老朋友一样自然。  │   │ │
│  │  │ ...                                             │   │ │
│  │  └─────────────────────────────────────────────────┘   │ │
│  │                                                         │ │
│  │  字符数: 1234/5000                    [恢复默认]        │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Footer (输出格式) ────────────────────────────────────┐ │
│  │                                                         │ │
│  │  ┌─────────────────────────────────────────────────┐   │ │
│  │  │ 请以JSON格式返回分析结果：                       │   │ │
│  │  │ {                                               │   │ │
│  │  │   "replySuggestion": "建议的回复内容",          │   │ │
│  │  │   "strategyAnalysis": "策略分析",               │   │ │
│  │  │   "riskLevel": "SAFE/WARNING/DANGER"            │   │ │
│  │  │ }                                               │   │ │
│  │  │ ...                                             │   │ │
│  │  └─────────────────────────────────────────────────┘   │ │
│  │                                                         │ │
│  │  字符数: 567/3000                     [恢复默认]        │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ 操作 ─────────────────────────────────────────────────┐ │
│  │  [📤 导出此场景]    [📥 导入]    [🔄 恢复此场景默认]     │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


### 3.3 文件导入导出

#### 3.3.1 支持格式

| 格式 | 扩展名 | 说明 |
|-----|-------|------|
| JSON | `.json` | 结构化格式，包含所有元数据 |
| Markdown | `.md` | 可读性好，方便在电脑上编辑 |
| 纯文本 | `.txt` | 最简单格式 |

#### 3.3.2 导出功能

- **导出单个场景**：导出选中场景的Header和Footer
- **导出全部场景**：导出所有6个场景的配置

导出文件保存到App私有目录，通过系统分享功能发送。

#### 3.3.3 导入功能

- 从文件选择器选择配置文件
- 自动识别文件格式
- 导入前显示预览确认

#### 3.3.4 JSON格式示例

```json
{
  "version": "1.0",
  "exportTime": "2026-01-08T14:30:00Z",
  "scenes": {
    "ANALYZE": {
      "header": "你是用户的\"恋爱军师\"...",
      "footer": "请以JSON格式返回..."
    },
    "POLISH": {
      "header": "你是用户的\"高情商嘴替\"...",
      "footer": "【输出要求】..."
    }
  }
}
```

#### 3.3.5 Markdown格式示例

```markdown
# 系统提示词配置

导出时间: 2026-01-08 14:30:00

---

## ANALYZE (聊天分析)

### Header

你是用户的"恋爱军师"和"社交策略专家"。
...

### Footer

请以JSON格式返回分析结果：
...

---

## POLISH (润色优化)

### Header

你是用户的"高情商嘴替"。
...

### Footer

【输出要求】
...
```

---

## 4. 数据存储

### 4.1 存储位置

```
/data/data/com.empathy.ai/files/prompts/
├── global_prompts.json          # 现有：用户自定义提示词
├── system_prompts.json          # 新增：系统提示词配置
└── exports/                     # 新增：导出文件临时目录
    └── prompt_export_20260108.json
```

### 4.2 数据模型

```kotlin
/**
 * 系统提示词配置
 */
data class SystemPromptConfig(
    val version: Int = 1,
    val scenes: Map<String, ScenePromptConfig>
)

/**
 * 场景提示词配置
 */
data class ScenePromptConfig(
    val header: String,
    val footer: String,
    val updatedAt: Long = System.currentTimeMillis()
)
```

### 4.3 生效机制

修改后**直接生效**到正式配置：
1. 用户编辑并保存
2. 立即写入 `system_prompts.json`
3. `PromptBuilder` 下次构建时读取新配置
4. 无需重启App，立即生效

---

## 5. 技术实现

### 5.1 复用策略

| 组件 | 复用方式 |
|-----|---------|
| 提示词编辑器UI | 复用 `PromptEditorScreen` 组件 |
| 设置界面风格 | 复用现有iOS风格设置组件 |
| 文件存储 | 复用 `PromptFileStorage` |
| 变量解析 | 复用 `PromptVariableResolver` |

### 5.2 新增文件清单

| 模块 | 文件 | 说明 |
|-----|------|------|
| **:domain** | `model/SystemPromptConfig.kt` | 系统提示词配置模型 |
| **:domain** | `repository/SystemPromptRepository.kt` | 系统提示词仓库接口 |
| **:data** | `local/SystemPromptStorage.kt` | 系统提示词存储实现 |
| **:data** | `repository/SystemPromptRepositoryImpl.kt` | 仓库实现 |
| **:presentation** | `ui/screen/developer/DeveloperOptionsSection.kt` | 开发者选项区域 |
| **:presentation** | `ui/screen/developer/SystemPromptListScreen.kt` | 场景列表页 |
| **:presentation** | `ui/screen/developer/SystemPromptEditScreen.kt` | 场景编辑页 |
| **:presentation** | `viewmodel/DeveloperModeViewModel.kt` | 开发者模式状态管理 |
| **:presentation** | `viewmodel/SystemPromptEditViewModel.kt` | 编辑页状态管理 |

### 5.3 修改文件清单

| 文件 | 修改内容 |
|-----|---------|
| `SettingsScreen.kt` | 添加版本号点击计数逻辑，显示开发者选项区域 |
| `SettingsViewModel.kt` | 添加开发者模式状态管理 |
| `SystemPrompts.kt` | 修改为优先读取自定义配置，fallback到默认值 |
| `PromptBuilder.kt` | 集成SystemPromptRepository |
| `NavGraph.kt` | 添加系统提示词编辑页面路由 |


---

## 6. 用户流程

### 6.1 解锁开发者模式

```
1. 用户打开设置页面
2. 滚动到"关于"区域
3. 连续点击版本号7次
   - 第1-6次：显示Toast "再点击 X 次进入开发者模式"
   - 第7次：显示Toast "已进入开发者模式"
4. 设置页面底部出现"开发者选项"区域
```

### 6.2 编辑系统提示词

```
1. 在开发者选项中点击"系统提示词编辑"
2. 进入场景列表页，显示6个AI场景
3. 点击要编辑的场景（如"聊天分析"）
4. 进入编辑页，显示Header和Footer两个编辑区
5. 编辑内容
6. 点击"保存"按钮
7. 提示"保存成功，已立即生效"
8. 返回场景列表页
```

### 6.3 导出配置

```
1. 在场景列表页点击"导出全部"
   或在场景编辑页点击"导出此场景"
2. 选择导出格式（JSON/MD/TXT）
3. 系统生成导出文件
4. 弹出系统分享面板
5. 用户选择分享方式（微信/邮件/保存到文件等）
```

### 6.4 导入配置

```
1. 在场景列表页点击"导入配置"
2. 打开系统文件选择器
3. 选择配置文件
4. 显示导入预览（将要覆盖的场景列表）
5. 用户确认导入
6. 导入成功，提示"已导入 X 个场景配置"
```

### 6.5 恢复默认

```
1. 点击"恢复默认"按钮
2. 弹出确认对话框"确定要恢复默认配置吗？"
3. 用户确认
4. 恢复到系统默认提示词
5. 提示"已恢复默认配置"
```

---

## 7. 验收标准

### 7.1 功能验收（P0 - 核心功能）

- [ ] **AC-001** 点击版本号7次能解锁开发者模式
- [ ] **AC-002** 解锁后设置页面显示"开发者选项"区域
- [ ] **AC-003** 可以编辑5个核心场景的Header和Footer（ANALYZE、POLISH、REPLY、SUMMARY、AI_ADVISOR）
- [ ] **AC-004** 保存后立即生效，无需重启App
- [ ] **AC-005** App重启后需要重新解锁开发者模式

### 7.2 功能验收（P1 - 扩展功能）

- [ ] **AC-006** 支持导出为JSON格式
- [ ] **AC-007** 支持导出为Markdown格式
- [ ] **AC-008** 支持导出为纯文本格式
- [ ] **AC-009** 支持从文件导入配置
- [ ] **AC-010** 导入前显示预览确认
- [ ] **AC-011** 支持恢复单个场景的默认配置
- [ ] **AC-012** 支持恢复全部场景的默认配置

### 7.3 性能验收

- [ ] **PC-001** 保存配置响应时间 < 200ms
- [ ] **PC-002** 配置修改后立即生效（无需重启）
- [ ] **PC-003** 导出文件生成时间 < 1s
- [ ] **PC-004** 导入文件解析时间 < 1s

### 7.4 兼容性验收

- [ ] **CC-001** 不影响现有用户提示词功能
- [ ] **CC-002** 与悬浮窗功能兼容
- [ ] **CC-003** 与AI军师功能兼容
- [ ] **CC-004** 配置文件损坏时能fallback到默认值
- [ ] **CC-005** 与现有PromptBuilder无缝集成

### 7.5 安全验收

- [ ] **SC-001** 配置文件存储在App私有目录
- [ ] **SC-002** 导入文件进行格式校验
- [ ] **SC-003** 异常输入不会导致App崩溃

---

## 8. 实施计划

### 8.1 任务分解

| 任务ID | 任务描述 | 预估工时 | 依赖 |
|--------|---------|---------|------|
| T-001 | 创建SystemPromptConfig数据模型 | 0.5h | - |
| T-002 | 创建SystemPromptRepository接口 | 0.5h | T-001 |
| T-003 | 实现SystemPromptStorage存储 | 1h | T-001 |
| T-004 | 实现SystemPromptRepositoryImpl | 1h | T-002, T-003 |
| T-005 | 修改SystemPrompts支持自定义配置 | 1h | T-004 |
| T-006 | 修改PromptBuilder集成新配置 | 0.5h | T-005 |
| T-007 | 实现DeveloperModeViewModel | 1h | - |
| T-008 | 修改SettingsScreen添加解锁逻辑 | 1h | T-007 |
| T-009 | 实现DeveloperOptionsSection组件 | 1h | T-007 |
| T-010 | 实现SystemPromptListScreen | 1.5h | T-004 |
| T-011 | 实现SystemPromptEditScreen | 2h | T-004 |
| T-012 | 实现SystemPromptEditViewModel | 1.5h | T-004 |
| T-013 | 实现导出功能 | 1.5h | T-004 |
| T-014 | 实现导入功能 | 1.5h | T-004 |
| T-015 | 添加导航路由 | 0.5h | T-010, T-011 |
| T-016 | 单元测试 | 2h | 全部 |
| T-017 | 集成测试 | 1h | 全部 |

**总预估工时**: 约18小时

### 8.2 里程碑

| 里程碑 | 包含任务 | 交付物 |
|--------|---------|--------|
| M1: 核心功能 | T-001 ~ T-009 | 开发者模式入口可用 |
| M2: 编辑功能 | T-010 ~ T-012, T-015 | 系统提示词可编辑 |
| M3: 导入导出 | T-013 ~ T-014 | 配置可导入导出 |
| M4: 测试完成 | T-016 ~ T-017 | 功能完整可用 |

---

## 9. 风险与应对

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 配置文件损坏 | AI功能异常 | 实现fallback机制，损坏时使用默认值 |
| 用户误操作 | 提示词被改坏 | 提供"恢复默认"功能 |
| 导入格式错误 | 导入失败 | 严格校验，友好错误提示 |

---

## 10. 相关文档

| 文档 | 说明 |
|-----|------|
| [PRD-00005](PRD-00005-提示词管理系统需求.md) | 提示词管理系统需求 |
| [PRD-00015](PRD-00015-提示词设置优化需求.md) | 提示词设置优化需求 |
| [SUMMARY-00001](../审查报告/SUMMARY-00001-系统提示词优化总结.md) | 系统提示词优化总结 |
| [SystemPrompts.kt](../../../domain/src/main/kotlin/com/empathy/ai/domain/util/SystemPrompts.kt) | 当前系统提示词实现 |

---

**文档版本**: 1.3
**最后更新**: 2026-01-08
**更新者**: Kiro
**更新说明**: 
- v1.1: 根据审查报告优化验收标准格式，添加checkbox便于跟踪验收进度
- v1.2: 根据SUMMARY-00001审查报告，将场景数量从6个调整为4个核心场景（ANALYZE、POLISH、REPLY、SUMMARY）
- v1.3: 添加第5个场景AI_ADVISOR（AI军师），支持AI军师对话模式的系统提示词编辑
