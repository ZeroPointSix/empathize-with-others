# PRD-00034：界面切换性能优化 - 页面缓存方案

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档编号 | PRD-00034 |
| 创建日期 | 2026-01-10 |
| 关联BUG | BUG-00060 |
| 优先级 | P0 (最高) |
| 状态 | 📋 待实现 |
| 预估工时 | 2-3天 |

---

## 1. 问题背景

### 1.1 现象描述

用户在应用内进行界面切换时，会出现明显的**黑屏闪动**现象：

1. 点击底部导航切换Tab时，屏幕短暂黑屏
2. 进入复杂页面（如「设置」）时，黑屏更严重
3. 整体切换不流畅，有明显卡顿和闪烁

### 1.2 根因分析

经过深度调研，问题由以下原因造成：

| 原因 | 影响程度 | 说明 |
|------|----------|------|
| **Navigation Compose 2.7+ 默认行为** | 高 | 新版本NavHost会覆盖单个composable的动画设置 |
| **页面每次重建** | 高 | 底部导航切换时，页面被销毁再重建 |
| **fadeIn/fadeOut动画** | 中 | 淡入淡出时露出黑色背景 |
| **复杂页面首帧渲染慢** | 中 | ViewModel创建、数据加载阻塞渲染 |

### 1.3 参考资料

- [Compose Navigation 2.7.3 动画修复](https://openillumi.com/en/en-compose-navigation-273-animation-fix/)
- [StackOverflow: 底部导航卡顿问题](https://stackoverflow.com/questions/69806098/)
- 微信、支付宝等成熟应用的切换体验

---

## 2. 解决方案概览


### 2.1 方案总览

| 优化项 | 优先级 | 效果 | 复杂度 | 阶段 |
|--------|--------|------|--------|------|
| 修复NavHost动画配置 | P0 | 消除默认淡入淡出导致的闪烁 | 低 | Phase 1 |
| 底部导航页面缓存 | P0 | 消除Tab切换时的重建黑屏 | 中 | Phase 2 |
| 优化动画时长和曲线 | P1 | 让切换更流畅 | 低 | Phase 1 |
| 添加页面骨架屏 | P2 | 复杂页面首次加载体验 | 中 | Phase 3 |

### 2.2 预期效果

- **切换延迟**: 从 300-500ms 降低到 < 100ms
- **黑屏现象**: 完全消除
- **用户体验**: 达到微信级别的流畅度

---

## 3. Phase 1：修复动画配置（快速修复）

### 3.1 问题代码

当前 `AnimationSpec.kt` 使用了 `slideInHorizontally + fadeIn` 组合：

```kotlin
// 当前代码 - 有问题
val PageEnterTransition = slideInHorizontally(...) + fadeIn(...)
val PageExitTransition = slideOutHorizontally(...) + fadeOut(...)
```

**问题**：`fadeIn/fadeOut` 会导致背景露出，产生黑屏。

### 3.2 修复方案

**修改文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/theme/AnimationSpec.kt`

```kotlin
object AnimationSpec {
    // 缩短动画时长
    const val DurationPageEnter = 200  // 原300ms
    const val DurationPageExit = 150   // 原250ms

    /**
     * 页面进入转场 - 只用滑动，移除淡入
     */
    val PageEnterTransition = androidx.compose.animation.slideInHorizontally(
        initialOffsetX = { fullWidth -> fullWidth },
        animationSpec = tween(DurationPageEnter, easing = FastOutSlowInEasing)
    )

    /**
     * 页面退出转场 - 只滑出1/4，移除淡出
     */
    val PageExitTransition = androidx.compose.animation.slideOutHorizontally(
        targetOffsetX = { fullWidth -> -fullWidth / 4 },
        animationSpec = tween(DurationPageExit, easing = FastOutSlowInEasing)
    )

    /**
     * 返回进入转场
     */
    val PagePopEnterTransition = androidx.compose.animation.slideInHorizontally(
        initialOffsetX = { fullWidth -> -fullWidth / 4 },
        animationSpec = tween(DurationPageEnter, easing = FastOutSlowInEasing)
    )

    /**
     * 返回退出转场
     */
    val PagePopExitTransition = androidx.compose.animation.slideOutHorizontally(
        targetOffsetX = { fullWidth -> fullWidth },
        animationSpec = tween(DurationPageExit, easing = FastOutSlowInEasing)
    )
}
```

### 3.3 关键改动

1. **移除 `fadeIn()` 和 `fadeOut()`** - 这是黑屏的主要原因
2. **缩短动画时长** - 200ms/150ms 更流畅
3. **退出时只滑动1/4** - 模拟iOS的层叠效果

---

## 4. Phase 2：底部导航页面缓存（核心优化）


### 4.1 核心思路

当前问题：每次切换底部Tab，页面都会被**销毁重建**，导致：
- ViewModel重新创建
- 数据重新加载
- Compose树重新构建
- 黑屏等待渲染完成

解决方案：**让底部Tab页面保持在内存中，只切换可见性**

```
┌─────────────────────────────────────────────────────────┐
│                    BottomNavScaffold                     │
├─────────────────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │Contacts │ │BrainTag │ │Advisor  │ │Settings │       │
│  │(visible)│ │(hidden) │ │(hidden) │ │(hidden) │       │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │
│                                                          │
│  所有页面都在内存中，只切换 visible 状态                  │
│  切换时不重建，瞬间完成                                   │
└─────────────────────────────────────────────────────────┘
```

### 4.2 新增文件

**文件路径**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/navigation/BottomNavScaffold.kt`

```kotlin
package com.empathy.ai.presentation.ui.component.navigation

import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.fadeIn
import androidx.compose.animation.fadeOut
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.Scaffold
import androidx.compose.runtime.*
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.ui.Modifier
import androidx.navigation.NavHostController

/**
 * 底部导航Tab枚举
 */
enum class BottomNavTab(val route: String) {
    CONTACTS("contact_list"),
    BRAIN_TAG("brain_tag"),
    AI_ADVISOR("ai_advisor"),
    SETTINGS("settings")
}

/**
 * 带页面缓存的底部导航Scaffold
 * 
 * 核心优化：所有Tab页面保持在内存中，只切换可见性
 * 这样切换时不会重建页面，消除黑屏闪烁
 * 
 * @param navController 导航控制器，用于跳转到非Tab页面
 * @param currentTab 当前选中的Tab
 * @param onTabSelected Tab切换回调
 * @param contactsContent 联系人页面内容
 * @param brainTagContent 标签页面内容
 * @param aiAdvisorContent AI军师页面内容
 * @param settingsContent 设置页面内容
 * @param bottomBar 底部导航栏
 */
@Composable
fun BottomNavScaffold(
    navController: NavHostController,
    currentTab: BottomNavTab,
    onTabSelected: (BottomNavTab) -> Unit,
    contactsContent: @Composable () -> Unit,
    brainTagContent: @Composable () -> Unit,
    aiAdvisorContent: @Composable () -> Unit,
    settingsContent: @Composable () -> Unit,
    bottomBar: @Composable () -> Unit
) {
    // 记录哪些Tab已经被访问过（懒加载优化）
    var visitedTabs by rememberSaveable { 
        mutableStateOf(setOf(currentTab)) 
    }
    
    // 当切换Tab时，标记为已访问
    LaunchedEffect(currentTab) {
        visitedTabs = visitedTabs + currentTab
    }

    Scaffold(
        bottomBar = bottomBar
    ) { paddingValues ->
        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
        ) {
            // 联系人页面 - 懒加载：只有访问过才渲染
            if (BottomNavTab.CONTACTS in visitedTabs) {
                TabContent(
                    visible = currentTab == BottomNavTab.CONTACTS,
                    content = contactsContent
                )
            }

            // 标签页面
            if (BottomNavTab.BRAIN_TAG in visitedTabs) {
                TabContent(
                    visible = currentTab == BottomNavTab.BRAIN_TAG,
                    content = brainTagContent
                )
            }

            // AI军师页面
            if (BottomNavTab.AI_ADVISOR in visitedTabs) {
                TabContent(
                    visible = currentTab == BottomNavTab.AI_ADVISOR,
                    content = aiAdvisorContent
                )
            }

            // 设置页面
            if (BottomNavTab.SETTINGS in visitedTabs) {
                TabContent(
                    visible = currentTab == BottomNavTab.SETTINGS,
                    content = settingsContent
                )
            }
        }
    }
}

/**
 * Tab内容包装器 - 处理可见性动画
 */
@Composable
private fun TabContent(
    visible: Boolean,
    content: @Composable () -> Unit
) {
    AnimatedVisibility(
        visible = visible,
        enter = fadeIn(
            animationSpec = androidx.compose.animation.core.tween(100)
        ),
        exit = fadeOut(
            animationSpec = androidx.compose.animation.core.tween(100)
        )
    ) {
        content()
    }
}
```

### 4.3 设计要点

1. **懒加载**：只有访问过的Tab才会渲染，节省内存
2. **状态保持**：`rememberSaveable` 确保配置变更后状态恢复
3. **快速切换**：100ms的淡入淡出，几乎瞬间完成
4. **内存友好**：页面保持在内存中，但未访问的不渲染

---

## 5. Phase 2：重构 MainActivity


### 5.1 架构变更

```
┌─────────────────────────────────────────────────────────┐
│                      MainActivity                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  isInMainTab == true?                                   │
│       │                                                  │
│       ├── YES ──→ BottomNavScaffold (页面缓存)          │
│       │           ├── ContactListScreen                 │
│       │           ├── BrainTagScreen                    │
│       │           ├── AiAdvisorScreen                   │
│       │           └── SettingsScreen                    │
│       │                                                  │
│       └── NO ───→ NavGraph (标准导航)                   │
│                   ├── ContactDetailTabScreen            │
│                   ├── AiAdvisorChatScreen               │
│                   ├── AiConfigScreen                    │
│                   └── ...其他页面                        │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 5.2 修改文件

**文件路径**: `app/src/main/java/com/empathy/ai/ui/MainActivity.kt`

```kotlin
package com.empathy.ai.ui

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.runtime.*
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.ui.Modifier
import androidx.navigation.compose.currentBackStackEntryAsState
import androidx.navigation.compose.rememberNavController
import com.empathy.ai.presentation.navigation.NavGraph
import com.empathy.ai.presentation.navigation.NavRoutes
import com.empathy.ai.presentation.ui.component.navigation.BottomNavScaffold
import com.empathy.ai.presentation.ui.component.navigation.BottomNavTab
import com.empathy.ai.presentation.ui.component.navigation.EmpathyBottomNavigation
import com.empathy.ai.presentation.ui.screen.advisor.AiAdvisorScreen
import com.empathy.ai.presentation.ui.screen.contact.ContactListScreen
import com.empathy.ai.presentation.ui.screen.settings.SettingsScreen
import com.empathy.ai.presentation.ui.screen.tag.BrainTagScreen
import com.empathy.ai.ui.theme.AppTheme
import dagger.hilt.android.AndroidEntryPoint

/**
 * 应用主Activity
 * 
 * 架构说明：
 * - 底部导航的4个主Tab使用 BottomNavScaffold 实现页面缓存
 * - 其他页面使用标准 NavGraph 导航
 * - 这样底部Tab切换时不会重建页面，消除黑屏闪烁
 */
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        setContent {
            AppTheme {
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    MainScreen()
                }
            }
        }
    }
}

/**
 * 主屏幕 - 管理底部导航和页面切换
 */
@Composable
private fun MainScreen() {
    val navController = rememberNavController()
    
    // 当前选中的底部Tab
    var currentTab by rememberSaveable { 
        mutableStateOf(BottomNavTab.CONTACTS) 
    }
    
    // 监听导航状态，判断是否在主Tab页
    val navBackStackEntry by navController.currentBackStackEntryAsState()
    val currentRoute = navBackStackEntry?.destination?.route
    
    // 判断是否在底部导航的主页面
    val isInMainTab = currentRoute == null || currentRoute in listOf(
        NavRoutes.CONTACT_LIST,
        NavRoutes.BRAIN_TAG,
        NavRoutes.AI_ADVISOR,
        NavRoutes.SETTINGS
    )

    if (isInMainTab) {
        // ========== 底部导航主页面 - 使用页面缓存 ==========
        BottomNavScaffold(
            navController = navController,
            currentTab = currentTab,
            onTabSelected = { tab -> currentTab = tab },
            
            // 联系人页面
            contactsContent = {
                ContactListScreen(
                    onNavigateToDetail = { contactId ->
                        if (contactId.isNotEmpty()) {
                            navController.navigate(
                                NavRoutes.createContactDetailTabRoute(contactId)
                            )
                        } else {
                            navController.navigate(NavRoutes.CREATE_CONTACT)
                        }
                    },
                    onNavigateToSettings = { 
                        currentTab = BottomNavTab.SETTINGS 
                    },
                    onNavigate = { route ->
                        handleBottomNavRoute(route) { tab ->
                            currentTab = tab
                        } ?: navController.navigate(route)
                    },
                    onAddClick = { 
                        navController.navigate(NavRoutes.CREATE_CONTACT) 
                    }
                )
            },
            
            // 标签页面
            brainTagContent = {
                BrainTagScreen(
                    onNavigateBack = { 
                        currentTab = BottomNavTab.CONTACTS 
                    }
                )
            },
            
            // AI军师页面
            aiAdvisorContent = {
                AiAdvisorScreen(
                    onNavigateToChat = { contactId ->
                        navController.navigate(NavRoutes.aiAdvisorChat(contactId))
                    },
                    onNavigateToContactSelect = {
                        navController.navigate(NavRoutes.AI_ADVISOR_CONTACTS)
                    }
                )
            },
            
            // 设置页面
            settingsContent = {
                SettingsScreen(
                    onNavigateBack = { 
                        currentTab = BottomNavTab.CONTACTS 
                    },
                    onNavigateToAiConfig = { 
                        navController.navigate(NavRoutes.AI_CONFIG) 
                    },
                    onNavigateToPromptEditor = { route -> 
                        navController.navigate(route) 
                    },
                    onNavigateToUserProfile = { 
                        navController.navigate(NavRoutes.USER_PROFILE) 
                    },
                    onNavigateToSystemPromptList = { 
                        navController.navigate(NavRoutes.SYSTEM_PROMPT_LIST) 
                    },
                    onNavigate = { route ->
                        handleBottomNavRoute(route) { tab ->
                            currentTab = tab
                        } ?: navController.navigate(route)
                    },
                    onAddClick = { 
                        navController.navigate(NavRoutes.CREATE_CONTACT) 
                    }
                )
            },
            
            // 底部导航栏
            bottomBar = {
                EmpathyBottomNavigation(
                    currentRoute = currentTab.route,
                    onNavigate = { route ->
                        BottomNavTab.entries.find { it.route == route }?.let {
                            currentTab = it
                        }
                    }
                )
            }
        )
    } else {
        // ========== 非底部导航页面 - 使用标准NavGraph ==========
        NavGraph(navController = navController)
    }
}

/**
 * 处理底部导航路由
 * 如果是底部Tab路由，返回对应Tab；否则返回null
 */
private fun handleBottomNavRoute(
    route: String, 
    onTabChange: (BottomNavTab) -> Unit
): Unit? {
    return when (route) {
        NavRoutes.CONTACT_LIST -> {
            onTabChange(BottomNavTab.CONTACTS)
            Unit
        }
        NavRoutes.BRAIN_TAG -> {
            onTabChange(BottomNavTab.BRAIN_TAG)
            Unit
        }
        NavRoutes.AI_ADVISOR -> {
            onTabChange(BottomNavTab.AI_ADVISOR)
            Unit
        }
        NavRoutes.SETTINGS -> {
            onTabChange(BottomNavTab.SETTINGS)
            Unit
        }
        else -> null
    }
}
```

---

## 6. 实现任务清单


### 6.1 Phase 1 任务（快速修复）

| 任务ID | 任务描述 | 文件 | 预估时间 |
|--------|----------|------|----------|
| T1-01 | 修改动画时长常量 | AnimationSpec.kt | 5min |
| T1-02 | 移除fadeIn/fadeOut | AnimationSpec.kt | 10min |
| T1-03 | 调整滑动偏移量 | AnimationSpec.kt | 5min |
| T1-04 | 测试验证 | - | 15min |

### 6.2 Phase 2 任务（页面缓存）

| 任务ID | 任务描述 | 文件 | 预估时间 |
|--------|----------|------|----------|
| T2-01 | 创建BottomNavTab枚举 | BottomNavScaffold.kt | 10min |
| T2-02 | 实现BottomNavScaffold | BottomNavScaffold.kt | 30min |
| T2-03 | 实现TabContent组件 | BottomNavScaffold.kt | 15min |
| T2-04 | 重构MainActivity | MainActivity.kt | 45min |
| T2-05 | 实现handleBottomNavRoute | MainActivity.kt | 15min |
| T2-06 | 调整各Screen的回调 | 多个Screen文件 | 30min |
| T2-07 | 集成测试 | - | 30min |

### 6.3 Phase 3 任务（可选优化）

| 任务ID | 任务描述 | 文件 | 预估时间 |
|--------|----------|------|----------|
| T3-01 | 设计骨架屏组件 | SkeletonScreen.kt | 30min |
| T3-02 | 为SettingsScreen添加骨架屏 | SettingsScreen.kt | 20min |
| T3-03 | 为ContactListScreen添加骨架屏 | ContactListScreen.kt | 20min |

---

## 7. 测试用例

### 7.1 TC-001: 底部Tab切换无黑屏

**前置条件**: 应用已启动，在联系人列表页

**步骤**:
1. 点击底部「标签」Tab
2. 点击底部「军师」Tab
3. 点击底部「设置」Tab
4. 点击底部「联系人」Tab

**预期结果**:
- 每次切换都应该瞬间完成（< 100ms）
- 不应该出现任何黑屏闪烁
- 页面状态应该保持（如滚动位置）

### 7.2 TC-002: 页面状态保持

**前置条件**: 应用已启动

**步骤**:
1. 在联系人列表滚动到中间位置
2. 切换到设置Tab
3. 切换回联系人Tab

**预期结果**:
- 联系人列表应该保持在之前的滚动位置
- 不应该重新加载数据

### 7.3 TC-003: 懒加载验证

**前置条件**: 应用刚启动

**步骤**:
1. 观察内存使用
2. 切换到设置Tab
3. 再次观察内存使用

**预期结果**:
- 启动时只加载联系人页面
- 切换到设置时才加载设置页面
- 内存使用合理增长

### 7.4 TC-004: 非Tab页面导航正常

**前置条件**: 应用已启动

**步骤**:
1. 点击某个联系人进入详情页
2. 点击返回
3. 进入设置 → AI配置

**预期结果**:
- 非Tab页面使用标准导航动画
- 返回时底部Tab状态正确
- 导航栈正常工作

### 7.5 TC-005: 配置变更后状态恢复

**前置条件**: 应用已启动，切换过多个Tab

**步骤**:
1. 旋转屏幕（或切换深色模式）
2. 观察当前Tab状态

**预期结果**:
- 当前选中的Tab应该保持
- 已访问的Tab状态应该恢复

---

## 8. 风险评估

| 风险项 | 等级 | 说明 | 缓解措施 |
|--------|------|------|----------|
| 内存占用增加 | 中 | 4个Tab页面都在内存中 | 使用懒加载，只渲染访问过的Tab |
| 导航逻辑复杂化 | 中 | 两套导航逻辑并存 | 清晰的isInMainTab判断 |
| Screen回调调整 | 低 | 需要调整各Screen的导航回调 | 统一使用handleBottomNavRoute |
| 测试覆盖 | 低 | 需要新增测试用例 | 按测试用例逐一验证 |

---

## 9. 相关文件清单

### 9.1 需要修改的文件

| 文件路径 | 修改类型 | 说明 |
|----------|----------|------|
| `presentation/.../theme/AnimationSpec.kt` | 修改 | 优化动画配置 |
| `app/.../ui/MainActivity.kt` | 重构 | 实现页面缓存架构 |

### 9.2 需要新增的文件

| 文件路径 | 说明 |
|----------|------|
| `presentation/.../navigation/BottomNavScaffold.kt` | 页面缓存Scaffold组件 |

### 9.3 可能需要调整的文件

| 文件路径 | 说明 |
|----------|------|
| `presentation/.../screen/contact/ContactListScreen.kt` | 调整导航回调 |
| `presentation/.../screen/settings/SettingsScreen.kt` | 调整导航回调 |
| `presentation/.../screen/tag/BrainTagScreen.kt` | 调整导航回调 |
| `presentation/.../screen/advisor/AiAdvisorScreen.kt` | 调整导航回调 |

---

## 10. 验收标准

### 10.1 功能验收

- [ ] 底部Tab切换无黑屏闪烁
- [ ] 切换延迟 < 100ms
- [ ] 页面状态正确保持
- [ ] 非Tab页面导航正常
- [ ] 配置变更后状态恢复

### 10.2 性能验收

- [ ] 内存占用增加 < 20MB
- [ ] 首次启动时间无明显增加
- [ ] 无内存泄漏

### 10.3 兼容性验收

- [ ] Android 7.0+ 正常运行
- [ ] 不同屏幕尺寸正常显示
- [ ] 深色/浅色模式正常切换

---

**文档版本**: 1.0
**最后更新**: 2026-01-10
**状态**: 📋 待实现


---

## 11. 补充优化策略（基于2026年研究报告）

> 以下内容基于《2026年 Android Compose Navigation 性能优化与架构演进深度研究报告》

### 11.1 优化优先级矩阵

| 优化项 | 收益 | 风险 | 工时 | 建议优先级 |
|--------|------|------|------|------------|
| 动画Lambda Modifiers | 高 | 低 | 2h | **P0 - 立即** |
| LazyColumn Key检查 | 高 | 低 | 1h | **P0 - 立即** |
| 移除fadeIn/fadeOut | 高 | 低 | 30min | **P0 - 立即** |
| Baseline Profiles | 很高 | 低 | 1天 | **P1 - 本周** |
| 底部导航页面缓存 | 很高 | 中 | 2-3天 | **P1 - 本周** |
| 类型安全路由 | 中 | 中 | 3-5天 | **P2 - 下周** |
| 迁移Nav3 | 很高 | 高 | 2周+ | **P3 - 长期** |
| 共享元素转场 | 中 | 中 | 3天 | **P3 - 长期** |

### 11.2 P0级优化：Lambda Modifiers

**问题**：在动画期间，如果在组合阶段读取状态，会导致每帧都重组。

**修复方式**：
```kotlin
// ❌ 错误 - 每帧都重组
Box(modifier = Modifier.offset(x = animatedOffset.dp, y = 0.dp))

// ✅ 正确 - 只在布局阶段读取
Box(modifier = Modifier.offset { IntOffset(animatedOffset.roundToInt(), 0) })

// ✅ 更优 - 使用 graphicsLayer（GPU加速）
Box(modifier = Modifier.graphicsLayer {
    translationX = animatedOffset
    alpha = animatedAlpha
})
```

**收益**：减少动画期间的重组次数，帧率提升 20-30%

### 11.3 P0级优化：LazyColumn Key

**检查清单**：
- [ ] ContactListScreen 的联系人列表
- [ ] SessionHistoryScreen 的会话列表
- [ ] AiAdvisorChatScreen 的消息列表
- [ ] SettingsScreen 的设置项列表

**正确示例**：
```kotlin
LazyColumn {
    items(
        items = contacts,
        key = { contact -> contact.id }  // 必须指定
    ) { contact ->
        ContactItem(contact)
    }
}
```

### 11.4 P1级优化：Baseline Profiles

**实施步骤**：

1. 添加 benchmark 模块到 `settings.gradle.kts`
2. 创建 `BaselineProfileGenerator.kt`
3. 覆盖核心导航路径：
   - 启动 → 联系人列表
   - 联系人列表 → 联系人详情
   - 底部Tab切换
   - 设置 → AI配置
4. 生成 `baseline-prof.txt`
5. 打包进 Release APK

**预期收益**：首次导航 TTID 降低 30-40%

### 11.5 长期规划：Navigation 3 迁移路径

**Phase 1 - 类型安全化**（可先行）
```kotlin
// 当前方式
navController.navigate("contact_detail_tab/$contactId")

// 目标方式
@Serializable
data class ContactDetailTab(val contactId: String)
navController.navigate(ContactDetailTab(contactId))
```

**Phase 2 - 状态上提**
- 将导航逻辑从 UI 层移到 ViewModel 或 AppState

**Phase 3 - 替换引擎**
- `NavHost` → `NavDisplay`
- `NavController` → `SnapshotStateList<NavKey>`

### 11.6 性能监控指标

| 指标 | 目标阈值 | 说明 |
|------|----------|------|
| TTID (首帧耗时) | < 500ms | 从点击到首帧显示 |
| TTFD (全屏耗时) | < 1s | 内容完全加载 |
| FrameDuration P99 | < 8ms (120Hz) | 动画流畅度 |
| FrameOverrun | < 0ms | 负值=优秀，正值=丢帧 |

---

## 12. 实施路线图

### 本周（Phase 1）
- [ ] T1-01: 修改 AnimationSpec.kt，移除 fadeIn/fadeOut
- [ ] T1-02: 检查所有 LazyColumn 的 key 参数
- [ ] T1-03: 将动画属性改为 Lambda Modifiers

### 下周（Phase 2）
- [ ] T2-01~T2-07: 实施底部导航页面缓存方案
- [ ] T2-08: 添加 Baseline Profiles

### 后续（Phase 3）
- [ ] 类型安全路由改造
- [ ] 关注 Nav3 稳定版发布
- [ ] 规划 Nav3 迁移

---

**文档版本**: 1.1
**最后更新**: 2026-01-10
**更新内容**: 补充基于2026年研究报告的优化策略
