# PRD-00036: 截图预览功能

## 需求背景

**用户反馈**: 悬浮窗中的截图缩略图太小,用户无法清楚看到截图内容,需要添加点击预览功能。

**当前问题**:
- 截图缩略图尺寸: 48dp (约144px)
- 只能看到模糊的缩略图
- 无法确认截图内容是否正确
- 只有删除功能,没有预览功能

## 需求描述

### 功能目标

在悬浮窗的截图附件区域,添加点击预览功能,让用户可以查看完整的截图。

### 用户场景

1. 用户在悬浮窗中进行截图
2. 截图以缩略图形式显示在附件区域
3. 用户点击缩略图
4. 弹出全屏预览对话框,显示完整截图
5. 用户点击对话框外部或按返回键关闭预览

## 功能设计

### UI设计

**预览对话框**:
- 全屏显示
- 黑色半透明背景 (alpha=0.9)
- 图片居中显示,保持宽高比
- 图片最大尺寸: 屏幕宽高的90%
- 点击图片外部关闭对话框
- 支持返回键关闭

**交互设计**:
- 点击缩略图 → 显示预览对话框
- 点击对话框外部 → 关闭预览
- 按返回键 → 关闭预览
- 预览时不影响其他功能

### 技术方案

**方案选择**: 使用Dialog显示全屏图片

**实现组件**:
1. **ImagePreviewDialog**: 图片预览对话框组件
2. **FloatingViewV2**: 添加缩略图点击事件
3. **FloatingWindowService**: 处理预览请求

**图片加载**:
- 使用Coil加载完整图片
- 显示加载进度指示器
- 处理加载失败情况

## 技术实现

### 数据流

```
用户点击缩略图
  ↓
FloatingViewV2.onScreenshotPreviewListener
  ↓
FloatingWindowService.showScreenshotPreview()
  ↓
ImagePreviewDialog.show()
  ↓
Coil加载完整图片
  ↓
显示预览对话框
```

### 文件修改清单

1. **新建**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/dialog/ImagePreviewDialog.kt`
   - 图片预览对话框组件
   - 使用Coil加载图片
   - 处理点击关闭事件

2. **修改**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/floating/FloatingViewV2.kt`
   - 添加`setOnScreenshotPreviewListener()`方法
   - 在`createAttachmentItem()`中添加ImageView点击事件

3. **修改**: `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt`
   - 添加`showScreenshotPreview()`方法
   - 处理预览请求

### 代码结构

**ImagePreviewDialog.kt**:
```kotlin
class ImagePreviewDialog(
    context: Context,
    private val imagePath: String
) : Dialog(context, R.style.FullScreenDialog) {

    private lateinit var imageView: ImageView
    private lateinit var progressBar: ProgressBar

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setupView()
        loadImage()
    }

    private fun setupView() {
        // 设置全屏布局
        // 黑色半透明背景
        // ImageView居中显示
    }

    private fun loadImage() {
        // 使用Coil加载图片
        // 显示加载进度
        // 处理加载失败
    }
}
```

**FloatingViewV2.kt修改**:
```kotlin
// 添加预览监听器
private var onScreenshotPreviewListener: ((String) -> Unit)? = null

fun setOnScreenshotPreviewListener(listener: (String) -> Unit) {
    onScreenshotPreviewListener = listener
}

// 在createAttachmentItem中添加点击事件
imageView.setOnClickListener {
    onScreenshotPreviewListener?.invoke(attachment.localPath)
}
```

## 测试用例

### 单元测试

**测试文件**: `presentation/src/test/kotlin/com/empathy/ai/presentation/ui/floating/FloatingViewV2Test.kt`

测试用例:
1. 测试点击缩略图触发预览回调
2. 测试预览回调传递正确的图片路径
3. 测试删除按钮不触发预览回调

### UI测试

**测试文件**: `app/src/androidTest/kotlin/com/empathy/ai/ui/ImagePreviewDialogTest.kt`

测试用例:
1. 测试对话框正确显示
2. 测试图片加载成功
3. 测试点击外部关闭对话框
4. 测试返回键关闭对话框
5. 测试加载失败的错误处理

### 集成测试

手动测试流程:
1. 进行截图,生成缩略图
2. 点击缩略图
3. 验证预览对话框显示
4. 验证图片完整显示
5. 点击外部关闭预览
6. 验证可以预览多张截图

## 验收标准

1. 点击截图缩略图可以弹出预览对话框
2. 预览对话框显示完整的截图
3. 图片居中显示,保持宽高比
4. 点击对话框外部可以关闭预览
5. 按返回键可以关闭预览
6. 预览功能不影响删除功能
7. 预览功能不影响发送功能

## 非功能需求

1. **性能**: 图片加载时间<500ms
2. **内存**: 使用Coil的内存缓存,避免重复加载
3. **兼容性**: 支持API 24+
4. **用户体验**: 流畅的打开/关闭动画

## 风险评估

**低风险**:
- 功能简单,实现复杂度低
- 使用成熟的Coil库
- 不影响现有功能

**潜在问题**:
- 大图片可能导致内存压力(已通过Coil缓存管理)
- 对话框可能遮挡其他UI(通过点击外部关闭解决)

## 相关文档

- Explore Agent分析报告: 截图显示和附件管理代码
- ScreenshotAttachment数据模型: domain/src/main/kotlin/com/empathy/ai/domain/model/ScreenshotAttachment.kt
- FloatingViewV2实现: presentation/src/main/kotlin/com/empathy/ai/presentation/ui/floating/FloatingViewV2.kt

---

**创建时间**: 2026-01-17 12:18:00
**创建者**: Claude
**优先级**: 中
**状态**: 待实施
