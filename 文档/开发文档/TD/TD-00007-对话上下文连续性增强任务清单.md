# TD-00007: å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºä»»åŠ¡æ¸…å•

## æ–‡æ¡£ä¿¡æ¯

**æ–‡æ¡£ç¼–å·**: TD-00007  
**ç‰ˆæœ¬**: 1.1  
**åˆ›å»ºæ—¥æœŸ**: 2025-12-16  
**æœ€åæ›´æ–°**: 2025-12-16  
**éœ€æ±‚æ–‡æ¡£**: `æ–‡æ¡£/å¼€å‘æ–‡æ¡£/PRD/PRD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºéœ€æ±‚.md` (v1.0)  
**åŠŸèƒ½è®¾è®¡**: `æ–‡æ¡£/å¼€å‘æ–‡æ¡£/FD/FD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºåŠŸèƒ½è®¾è®¡.md` (v1.1)  
**æŠ€æœ¯è®¾è®¡**: `æ–‡æ¡£/å¼€å‘æ–‡æ¡£/TDD/TDD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºæŠ€æœ¯è®¾è®¡.md` (v1.1)  
**çŠ¶æ€**: âœ… ä¸»ä»£ç å®Œæˆ + Bugä¿®å¤  
**è´Ÿè´£äºº**: Kiro  
**é¢„è®¡å·¥ä½œé‡**: 1.5-2ä¸ªå·¥ä½œæ—¥  
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­  
**å®é™…è¿›åº¦**: 25/25ä»»åŠ¡å®Œæˆ + 1ä¸ªBugä¿®å¤ï¼ˆå†å²ä¸Šä¸‹æ–‡ä¸ç”Ÿæ•ˆé—®é¢˜ï¼‰

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-16 | Kiro | åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºäºTDD-00007 v1.1 |
| 1.1 | 2025-12-16 | Kiro | å®Œæˆæ‰€æœ‰25ä¸ªä»»åŠ¡ï¼Œä¸»ä»£ç ç¼–è¯‘é€šè¿‡ |
| 1.2 | 2025-12-17 | Kiro | ä¿®å¤BUGï¼šå†å²ä¸Šä¸‹æ–‡ä¸ç”Ÿæ•ˆé—®é¢˜ï¼ˆæ‰§è¡Œé¡ºåºè°ƒæ•´ï¼‰ |

---

## ä»»åŠ¡æ ¼å¼è¯´æ˜

- **[P]**: å¯å¹¶è¡Œæ‰§è¡Œï¼ˆä¸åŒæ–‡ä»¶ï¼Œæ— ä¾èµ–ï¼‰
- **[é˜¶æ®µX]**: æ‰€å±å¼€å‘é˜¶æ®µ
- **[ä¾èµ–]**: ä¾èµ–å…¶ä»–ä»»åŠ¡å®Œæˆ
- æè¿°ä¸­åŒ…å«ç¡®åˆ‡çš„æ–‡ä»¶è·¯å¾„

---

## è·¯å¾„çº¦å®š

åŸºäºé¡¹ç›®ç»“æ„ `com.empathy.ai/`:
- **é¢†åŸŸå±‚**: `domain/model/`, `domain/util/`, `domain/repository/`, `domain/usecase/`
- **æ•°æ®å±‚**: `data/local/dao/`, `data/local/`, `data/repository/`
- **è¡¨ç°å±‚**: `presentation/ui/screen/settings/`, `presentation/viewmodel/`
- **ä¾èµ–æ³¨å…¥**: `di/`
- **æµ‹è¯•**: `test/`, `androidTest/`

---

## å¼€å‘é˜¶æ®µæ˜ å°„

æ ¹æ®TDD-00007 v1.1ï¼Œæœ¬åŠŸèƒ½åˆ†ä¸º4ä¸ªå¼€å‘é˜¶æ®µï¼š

- **é˜¶æ®µ1**: é¢†åŸŸå±‚æ¨¡å‹ï¼ˆ0.25å¤©ï¼‰ğŸ¯ åŸºç¡€
- **é˜¶æ®µ2**: æ•°æ®å±‚æ‰©å±•ï¼ˆ0.25å¤©ï¼‰
- **é˜¶æ®µ3**: ä¸šåŠ¡å±‚é›†æˆï¼ˆ0.5å¤©ï¼‰
- **é˜¶æ®µ4**: è¡¨ç°å±‚å’Œæµ‹è¯•ï¼ˆ0.5-1å¤©ï¼‰

**æ€»å·¥æœŸ**: 1.5-2ä¸ªå·¥ä½œæ—¥

---

## å‰ç½®ä¾èµ–

æœ¬ä»»åŠ¡ä¾èµ–ä»¥ä¸‹ç°æœ‰ç»„ä»¶ï¼š

| ä¾èµ–ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ |
|---------|---------|------|
| ConversationLog | `domain/model/ConversationLog.kt` | âœ… å·²å®ç° |
| ConversationLogDao | `data/local/dao/ConversationLogDao.kt` | âœ… å·²å®ç° |
| ConversationRepository | `domain/repository/ConversationRepository.kt` | âœ… å·²å®ç° |
| ConversationRepositoryImpl | `data/repository/ConversationRepositoryImpl.kt` | âœ… å·²å®ç° |
| SettingsRepository | `domain/repository/SettingsRepository.kt` | âœ… å·²å®ç° |
| AnalyzeChatUseCase | `domain/usecase/AnalyzeChatUseCase.kt` | âœ… å·²å®ç° |
| SettingsScreen | `presentation/ui/screen/settings/SettingsScreen.kt` | âœ… å·²å®ç° |
| SettingsViewModel | `presentation/viewmodel/SettingsViewModel.kt` | âœ… å·²å®ç° |
| coreLibraryDesugaring | `app/build.gradle.kts` | âš ï¸ éœ€éªŒè¯ |

---

## é˜¶æ®µ1: é¢†åŸŸå±‚æ¨¡å‹ï¼ˆ0.25å¤©ï¼‰

**ç›®æ ‡**: å»ºç«‹æ ¸å¿ƒæ•°æ®æ¨¡å‹

**é‡Œç¨‹ç¢‘**: M1 - é¢†åŸŸæ¨¡å‹å®Œæˆ

### 1.1 æšä¸¾å’ŒåŸºç¡€æ¨¡å‹

- [x] T001 [P] ~~åˆ›å»ºMessageSenderæ¶ˆæ¯å‘é€è€…æšä¸¾~~ **è·³è¿‡ï¼šå·²å­˜åœ¨äºChatMessage.ktä¸­**
  - æ–‡ä»¶: `domain/model/ChatMessage.kt` (å·²æœ‰MessageSenderæšä¸¾ï¼šME/THEM)
  - è¯´æ˜: å¤ç”¨ç°æœ‰æšä¸¾ï¼Œæ— éœ€åˆ›å»ºæ–°æ–‡ä»¶

- [x] T002 [P] åˆ›å»ºTimestampedMessageå¸¦æ—¶é—´æˆ³æ¶ˆæ¯æ¨¡å‹ âœ…
  - æ–‡ä»¶: `domain/model/TimestampedMessage.kt`
  - å†…å®¹:
    - content: Stringï¼ˆæ¶ˆæ¯å†…å®¹ï¼‰
    - timestamp: Longï¼ˆæ—¶é—´æˆ³æ¯«ç§’ï¼‰
    - sender: MessageSenderï¼ˆå‘é€è€…ï¼‰
  - æ–¹æ³•:
    - getFormattedTime(): Stringï¼ˆHH:mmæ ¼å¼ï¼‰
    - getFormattedDate(): Stringï¼ˆyyyy-MM-ddæ ¼å¼ï¼‰
    - toDisplayString(showTime: Boolean): String
  - éªŒè¯: contentéç©ºã€timestamp > 0
  - ä¾èµ–: ä½¿ç”¨ç°æœ‰MessageSender

- [x] T003 [P] åˆ›å»ºTimeFlowMarkeræ—¶é—´æµé€æ ‡è®°å¯†å°ç±» âœ…
  - æ–‡ä»¶: `domain/model/TimeFlowMarker.kt`
  - å†…å®¹:
    - DateChange(date: String): æ—¥æœŸå˜æ›´æ ‡è®°
    - ShortGap(minutes: Int): çŸ­é—´éš”æ ‡è®°ï¼ˆ10åˆ†é’Ÿ~3å°æ—¶ï¼‰
    - LongGap(hours: Int): é•¿é—´éš”æ ‡è®°ï¼ˆ>3å°æ—¶ï¼‰
    - None: æ— æ ‡è®°ï¼ˆçƒ­å¯¹è¯<10åˆ†é’Ÿï¼‰
  - å¸¸é‡: UNIT_MINUTEã€UNIT_HOURã€æ ¼å¼åŒ–æ¨¡æ¿
  - æ–¹æ³•: toDisplayString(): String

- [x] T004 [P] åˆ›å»ºConversationContextConfigé…ç½®ç±» âœ…
  - æ–‡ä»¶: `domain/model/ConversationContextConfig.kt`
  - å†…å®¹:
    - historyCount: Intï¼ˆå†å²æ¡æ•°ï¼Œé»˜è®¤5ï¼‰
    - hotSessionThreshold: Longï¼ˆçƒ­å¯¹è¯é˜ˆå€¼ï¼Œé»˜è®¤10åˆ†é’Ÿï¼‰
    - warmSessionThreshold: Longï¼ˆæ¸©å¯¹è¯é˜ˆå€¼ï¼Œé»˜è®¤3å°æ—¶ï¼‰
  - å¸¸é‡: DEFAULT_HISTORY_COUNT=5ã€HISTORY_COUNT_OPTIONS=[0,5,10]
  - éªŒè¯: historyCountå¿…é¡»åœ¨é€‰é¡¹åˆ—è¡¨ä¸­

### 1.2 æ ¸å¿ƒæ„å»ºå™¨

- [x] T005 åˆ›å»ºConversationContextBuilderä¸Šä¸‹æ–‡æ„å»ºå™¨ âœ…
  - æ–‡ä»¶: `domain/util/ConversationContextBuilder.kt`
  - åŠŸèƒ½:
    - buildHistoryContext(messages, config): String
    - calculateTimeMarker(previousTimestamp, currentTimestamp, previousDate, config): TimeFlowMarker
  - ç‰¹æ€§:
    - @Singletonå•ä¾‹
    - ä½¿ç”¨DateTimeFormatterï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
    - æ—¶é—´æµé€æ ‡è®°ç­–ç•¥å®ç°
  - ä¾èµ–: T002, T003, T004

**éªŒæ”¶æ ‡å‡†**:
- [x] æ‰€æœ‰æ¨¡å‹ç±»æ­£ç¡®å®šä¹‰
- [x] éªŒè¯é€»è¾‘æ­£ç¡®æŠ›å‡ºå¼‚å¸¸
- [x] DateTimeFormatterçº¿ç¨‹å®‰å…¨
- [x] æ—¶é—´æ ‡è®°ç®—æ³•æ­£ç¡®

---

## é˜¶æ®µ2: æ•°æ®å±‚æ‰©å±•ï¼ˆ0.25å¤©ï¼‰

**ç›®æ ‡**: æ‰©å±•æ•°æ®è®¿é—®èƒ½åŠ›

**é‡Œç¨‹ç¢‘**: M2 - æ•°æ®å±‚å®Œæˆ

### 2.1 DAOæ‰©å±•

- [x] T006 æ‰©å±•ConversationLogDaoæ·»åŠ æŸ¥è¯¢æ–¹æ³• âœ…
  - æ–‡ä»¶: `data/local/dao/ConversationLogDao.kt`
  - æ–°å¢æ–¹æ³•: `getRecentConversations(contactId, limit)`
  - è¯´æ˜: å­æŸ¥è¯¢è·å–æœ€è¿‘Næ¡ï¼Œå†æ­£åºæ’åˆ—

### 2.2 Repositoryæ‰©å±•

- [x] T007 æ‰©å±•ConversationRepositoryæ¥å£ âœ…
  - æ–‡ä»¶: `domain/repository/ConversationRepository.kt`
  - æ–°å¢æ–¹æ³•: `getRecentConversations(contactId, limit): Result<List<ConversationLog>>`

- [x] T008 å®ç°ConversationRepositoryImplæ‰©å±•æ–¹æ³• âœ…
  - æ–‡ä»¶: `data/repository/ConversationRepositoryImpl.kt`
  - å®ç°: è°ƒç”¨DAOæ–¹æ³•ï¼ŒEntityè½¬Domainï¼Œå¼‚å¸¸å¤„ç†
  - ä¾èµ–: T006, T007

### 2.3 è®¾ç½®å­˜å‚¨æ‰©å±•

- [x] T009 åˆ›å»ºConversationPreferencesæ·»åŠ å†å²æ¡æ•°é…ç½® âœ…
  - æ–‡ä»¶: `data/local/ConversationPreferences.kt`ï¼ˆæ–°å»ºï¼‰
  - æ–°å¢:
    - KEY_HISTORY_CONVERSATION_COUNTå¸¸é‡
    - getHistoryConversationCount(): Int
    - setHistoryConversationCount(count: Int)
  - é»˜è®¤å€¼: 5

- [x] T010 æ‰©å±•SettingsRepositoryæ¥å£ âœ…
  - æ–‡ä»¶: `domain/repository/SettingsRepository.kt`
  - æ–°å¢æ–¹æ³•: `getHistoryConversationCount()`, `setHistoryConversationCount(count)`

- [x] T011 å®ç°SettingsRepositoryImplæ‰©å±•æ–¹æ³• âœ…
  - æ–‡ä»¶: `data/repository/settings/SettingsRepositoryImpl.kt`
  - å®ç°: è°ƒç”¨ConversationPreferencesæ–¹æ³•
  - ä¾èµ–: T009, T010

**éªŒæ”¶æ ‡å‡†**:
- [x] DAOæŸ¥è¯¢è¿”å›æ­£åºæ’åˆ—çš„è®°å½•
- [x] Repositoryæ­£ç¡®å¤„ç†å¼‚å¸¸
- [x] è®¾ç½®æ­£ç¡®æŒä¹…åŒ–

---

## é˜¶æ®µ3: ä¸šåŠ¡å±‚é›†æˆï¼ˆ0.5å¤©ï¼‰

**ç›®æ ‡**: é›†æˆåˆ°AIåˆ†ææµç¨‹

**é‡Œç¨‹ç¢‘**: M3 - ä¸šåŠ¡é›†æˆå®Œæˆ

### 3.1 ä¾èµ–æ³¨å…¥

- [x] T012 æ‰©å±•MemoryModuleæä¾›ConversationContextBuilder âœ…
  - æ–‡ä»¶: `di/MemoryModule.kt`
  - æ–°å¢: `provideConversationContextBuilder()` æ–¹æ³•
  - ä¾èµ–: T005

### 3.2 UseCaseé›†æˆ

- [x] T013 ä¿®æ”¹AnalyzeChatUseCaseé›†æˆå†å²ä¸Šä¸‹æ–‡ âœ…
  - æ–‡ä»¶: `domain/usecase/AnalyzeChatUseCase.kt`
  - ä¿®æ”¹:
    - æ³¨å…¥ConversationContextBuilder
    - æ–°å¢buildHistoryContextç§æœ‰æ–¹æ³•
    - ä¿®æ”¹buildContextDataæ–¹æ³•æ·»åŠ historyContextå‚æ•°
    - åœ¨invokeä¸­è·å–é…ç½®å¹¶æ„å»ºå†å²ä¸Šä¸‹æ–‡
  - é™çº§ç­–ç•¥: ä»»ä½•å¼‚å¸¸è¿”å›ç©ºå†å²ï¼Œä¸å½±å“ä¸»æµç¨‹
  - ä¾èµ–: T005, T007, T010, T012

**éªŒæ”¶æ ‡å‡†**:
- [x] å†å²ä¸Šä¸‹æ–‡æ­£ç¡®æ³¨å…¥AIè¯·æ±‚
- [x] é…ç½®ä¸º0æ—¶ä¸æŸ¥è¯¢æ•°æ®åº“
- [x] å¼‚å¸¸æ—¶é™çº§ä¸ºç©ºå†å²

---

## é˜¶æ®µ4: è¡¨ç°å±‚å’Œæµ‹è¯•ï¼ˆ0.5-1å¤©ï¼‰

**ç›®æ ‡**: UIé…ç½®å’Œå®Œæ•´æµ‹è¯•

**é‡Œç¨‹ç¢‘**: M4 - åŠŸèƒ½å®Œæˆ

### 4.1 UIçŠ¶æ€æ‰©å±•

- [x] T014 æ‰©å±•SettingsUiStateæ·»åŠ å†å²æ¡æ•°é…ç½® âœ…
  - æ–‡ä»¶: `presentation/ui/screen/settings/SettingsUiState.kt`
  - æ–°å¢: historyConversationCountã€HistoryCountOptionæ•°æ®ç±»

- [x] T015 æ‰©å±•SettingsUiEventæ·»åŠ äº‹ä»¶ âœ…
  - æ–‡ä»¶: `presentation/ui/screen/settings/SettingsUiEvent.kt`
  - æ–°å¢: `ChangeHistoryConversationCount(count: Int)`

### 4.2 ViewModelæ‰©å±•

- [x] T016 æ‰©å±•SettingsViewModelå¤„ç†å†å²æ¡æ•°é…ç½® âœ…
  - æ–‡ä»¶: `presentation/viewmodel/SettingsViewModel.kt`
  - ä¿®æ”¹: loadSettings()ã€onEvent()ã€changeHistoryConversationCount()
  - ä¾èµ–: T010, T014, T015

### 4.3 UIç»„ä»¶

- [x] T017 åˆ›å»ºHistoryConversationCountSection UIç»„ä»¶ âœ…
  - æ–‡ä»¶: `presentation/ui/screen/settings/component/HistoryConversationCountSection.kt`
  - åŠŸèƒ½: RadioButtoné€‰é¡¹ç»„ï¼ˆ0/5/10æ¡ï¼‰
  - ä¾èµ–: T014

- [x] T018 ä¿®æ”¹SettingsScreenæ·»åŠ å†å²æ¡æ•°é…ç½®åŒºå— âœ…
  - æ–‡ä»¶: `presentation/ui/screen/settings/SettingsScreen.kt`
  - ä¿®æ”¹: åœ¨"AIåˆ†æè®¾ç½®"åˆ†ç»„ä¸­æ·»åŠ HistoryConversationCountSection
  - ä¾èµ–: T016, T017

### 4.4 å­—ç¬¦ä¸²èµ„æº

- [x] T019 [P] æ·»åŠ ä¸­æ–‡å­—ç¬¦ä¸²èµ„æº âœ…
  - æ–‡ä»¶: `res/values/strings.xml`
  - æ–°å¢: å†å²å¯¹è¯æ¡æ•°ç›¸å…³å­—ç¬¦ä¸²

- [x] T020 [P] æ·»åŠ è‹±æ–‡å­—ç¬¦ä¸²èµ„æº âœ…
  - æ–‡ä»¶: `res/values-en/strings.xml`
  - æ–°å¢: å¯¹åº”çš„è‹±æ–‡ç¿»è¯‘

### 4.5 å•å…ƒæµ‹è¯•

- [x] T021 åˆ›å»ºConversationContextBuilderTest âœ…
  - æ–‡ä»¶: `test/domain/util/ConversationContextBuilderTest.kt`
  - æµ‹è¯•: ç©ºæ¶ˆæ¯ã€å•æ¡æ¶ˆæ¯ã€çƒ­/æ¸©/å†·å¯¹è¯ã€è·¨å¤©æ ‡è®°
  - ä¾èµ–: T005

- [x] T022 åˆ›å»ºTimeFlowMarkerTest âœ…
  - æ–‡ä»¶: `test/domain/model/TimeFlowMarkerTest.kt`
  - æµ‹è¯•: å„ç§æ ‡è®°ç±»å‹çš„æ˜¾ç¤ºæ ¼å¼
  - ä¾èµ–: T003

- [x] T023 åˆ›å»ºTimestampedMessageTest âœ…
  - æ–‡ä»¶: `test/domain/model/TimestampedMessageTest.kt`
  - æµ‹è¯•: toDisplayStringã€éªŒè¯é€»è¾‘
  - ä¾èµ–: T002

- [x] T024 åˆ›å»ºAnalyzeChatUseCaseHistoryContextTest âœ…
  - æ–‡ä»¶: `test/domain/usecase/AnalyzeChatUseCaseHistoryContextTest.kt`
  - æµ‹è¯•: ç©ºå†å²ã€é™çº§ç­–ç•¥ã€é…ç½®ä¸º0
  - ä¾èµ–: T013

- [x] T025 åˆ›å»ºConversationContextConfigTest âœ…
  - æ–‡ä»¶: `test/domain/model/ConversationContextConfigTest.kt`
  - æµ‹è¯•: é»˜è®¤å€¼ã€éªŒè¯é€»è¾‘
  - ä¾èµ–: T004

**éªŒæ”¶æ ‡å‡†**:
- [x] è®¾ç½®ç•Œé¢æ­£ç¡®æ˜¾ç¤ºå†å²æ¡æ•°é€‰é¡¹
- [x] é€‰æ‹©åæ­£ç¡®ä¿å­˜é…ç½®
- [âš ï¸] å•å…ƒæµ‹è¯•æ–‡ä»¶å·²åˆ›å»ºï¼Œä½†é¡¹ç›®å­˜åœ¨å…¶ä»–æµ‹è¯•ç¼–è¯‘é—®é¢˜éœ€è¦ä¿®å¤
- [x] ä¸»ä»£ç ç¼–è¯‘é€šè¿‡

---

## ä»»åŠ¡æ€»è§ˆ

### ä»»åŠ¡ç»Ÿè®¡

| é˜¶æ®µ | ä»»åŠ¡æ•° | é¢„è®¡å·¥æ—¶ | çŠ¶æ€ |
|------|--------|----------|------|
| é˜¶æ®µ1: é¢†åŸŸå±‚æ¨¡å‹ | 5 | 0.25å¤© | âœ… å®Œæˆ |
| é˜¶æ®µ2: æ•°æ®å±‚æ‰©å±• | 6 | 0.25å¤© | âœ… å®Œæˆ |
| é˜¶æ®µ3: ä¸šåŠ¡å±‚é›†æˆ | 2 | 0.5å¤© | âœ… å®Œæˆ |
| é˜¶æ®µ4: è¡¨ç°å±‚å’Œæµ‹è¯• | 12 | 0.5-1å¤© | âœ… å®Œæˆ |
| **æ€»è®¡** | **25** | **1.5-2å¤©** | âœ… å®Œæˆ |

### ä»»åŠ¡ä¾èµ–å›¾

```
é˜¶æ®µ1 (é¢†åŸŸå±‚æ¨¡å‹)
â”œâ”€â”€ T001 MessageSender [P]
â”œâ”€â”€ T002 TimestampedMessage â† T001
â”œâ”€â”€ T003 TimeFlowMarker [P]
â”œâ”€â”€ T004 ConversationContextConfig [P]
â””â”€â”€ T005 ConversationContextBuilder â† T002, T003, T004

é˜¶æ®µ2 (æ•°æ®å±‚æ‰©å±•)
â”œâ”€â”€ T006 ConversationLogDaoæ‰©å±•
â”œâ”€â”€ T007 ConversationRepositoryæ¥å£æ‰©å±•
â”œâ”€â”€ T008 ConversationRepositoryImplå®ç° â† T006, T007
â”œâ”€â”€ T009 SettingsPreferencesæ‰©å±•
â”œâ”€â”€ T010 SettingsRepositoryæ¥å£æ‰©å±•
â””â”€â”€ T011 SettingsRepositoryImplå®ç° â† T009, T010

é˜¶æ®µ3 (ä¸šåŠ¡å±‚é›†æˆ)
â”œâ”€â”€ T012 MemoryModuleæ‰©å±• â† T005
â””â”€â”€ T013 AnalyzeChatUseCaseä¿®æ”¹ â† T005, T007, T010, T012

é˜¶æ®µ4 (è¡¨ç°å±‚å’Œæµ‹è¯•)
â”œâ”€â”€ T014 SettingsUiStateæ‰©å±•
â”œâ”€â”€ T015 SettingsUiEventæ‰©å±•
â”œâ”€â”€ T016 SettingsViewModelæ‰©å±• â† T010, T014, T015
â”œâ”€â”€ T017 HistoryConversationCountSection â† T014
â”œâ”€â”€ T018 SettingsScreenä¿®æ”¹ â† T016, T017
â”œâ”€â”€ T019-T020 å­—ç¬¦ä¸²èµ„æº [P]
â”œâ”€â”€ T021 ConversationContextBuilderTest â† T005
â”œâ”€â”€ T022 TimeFlowMarkerTest â† T003
â”œâ”€â”€ T023 TimestampedMessageTest â† T002
â”œâ”€â”€ T024 AnalyzeChatUseCaseHistoryContextTest â† T013
â””â”€â”€ T025 ConversationContextConfigTest â† T004
```

---

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶ï¼ˆ10ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | ä»»åŠ¡ç¼–å· | è¯´æ˜ |
|---------|---------|------|
| `domain/model/MessageSender.kt` | T001 | æ¶ˆæ¯å‘é€è€…æšä¸¾ |
| `domain/model/TimestampedMessage.kt` | T002 | å¸¦æ—¶é—´æˆ³æ¶ˆæ¯æ¨¡å‹ |
| `domain/model/TimeFlowMarker.kt` | T003 | æ—¶é—´æµé€æ ‡è®° |
| `domain/model/ConversationContextConfig.kt` | T004 | ä¸Šä¸‹æ–‡é…ç½® |
| `domain/util/ConversationContextBuilder.kt` | T005 | ä¸Šä¸‹æ–‡æ„å»ºå™¨ |
| `presentation/ui/screen/settings/component/HistoryConversationCountSection.kt` | T017 | å†å²æ¡æ•°é…ç½®ç»„ä»¶ |

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ9ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | ä»»åŠ¡ç¼–å· | ä¿®æ”¹å†…å®¹ |
|---------|---------|---------|
| `data/local/dao/ConversationLogDao.kt` | T006 | æ·»åŠ getRecentConversationsæ–¹æ³• |
| `domain/repository/ConversationRepository.kt` | T007 | æ·»åŠ getRecentConversationsæ–¹æ³• |
| `data/repository/ConversationRepositoryImpl.kt` | T008 | å®ç°getRecentConversations |
| `data/local/SettingsPreferences.kt` | T009 | æ·»åŠ å†å²æ¡æ•°é…ç½® |
| `domain/repository/SettingsRepository.kt` | T010 | æ·»åŠ å†å²æ¡æ•°æ–¹æ³• |
| `data/repository/settings/SettingsRepositoryImpl.kt` | T011 | å®ç°å†å²æ¡æ•°æ–¹æ³• |
| `di/MemoryModule.kt` | T012 | æä¾›ConversationContextBuilder |
| `domain/usecase/AnalyzeChatUseCase.kt` | T013 | é›†æˆå†å²ä¸Šä¸‹æ–‡æ„å»º |
| `presentation/ui/screen/settings/SettingsUiState.kt` | T014 | æ·»åŠ å†å²æ¡æ•°çŠ¶æ€ |
| `presentation/ui/screen/settings/SettingsUiEvent.kt` | T015 | æ·»åŠ å†å²æ¡æ•°äº‹ä»¶ |
| `presentation/viewmodel/SettingsViewModel.kt` | T016 | å¤„ç†å†å²æ¡æ•°é…ç½® |
| `presentation/ui/screen/settings/SettingsScreen.kt` | T018 | æ·»åŠ å†å²æ¡æ•°é…ç½®åŒºå— |

### èµ„æºæ–‡ä»¶ï¼ˆ2ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | ä»»åŠ¡ç¼–å· | è¯´æ˜ |
|---------|---------|------|
| `res/values/strings.xml` | T019 | ä¸­æ–‡å­—ç¬¦ä¸² |
| `res/values-en/strings.xml` | T020 | è‹±æ–‡å­—ç¬¦ä¸² |

### æµ‹è¯•æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | ä»»åŠ¡ç¼–å· | è¯´æ˜ |
|---------|---------|------|
| `test/domain/util/ConversationContextBuilderTest.kt` | T021 | æ„å»ºå™¨æµ‹è¯• |
| `test/domain/model/TimeFlowMarkerTest.kt` | T022 | æ—¶é—´æ ‡è®°æµ‹è¯• |
| `test/domain/model/TimestampedMessageTest.kt` | T023 | æ¶ˆæ¯æ¨¡å‹æµ‹è¯• |
| `test/domain/usecase/AnalyzeChatUseCaseHistoryContextTest.kt` | T024 | UseCaseå†å²ä¸Šä¸‹æ–‡æµ‹è¯• |
| `test/domain/model/ConversationContextConfigTest.kt` | T025 | é…ç½®ç±»æµ‹è¯• |

---

## æµ‹è¯•è¦†ç›–ç‡æ ‡å‡†

| æ¨¡å— | è¦†ç›–ç‡è¦æ±‚ | è¯´æ˜ |
|------|-----------|------|
| ConversationContextBuilder | â‰¥90% | æ ¸å¿ƒç®—æ³• |
| TimeFlowMarker | 100% | æ‰€æœ‰æ ‡è®°ç±»å‹ |
| TimestampedMessage | 100% | éªŒè¯é€»è¾‘ |
| ConversationContextConfig | 100% | é…ç½®éªŒè¯ |
| AnalyzeChatUseCaseï¼ˆå†å²éƒ¨åˆ†ï¼‰ | â‰¥80% | é›†æˆé€»è¾‘ |

---

## é£é™©è¯„ä¼°

| é£é™© | ä¸¥é‡ç¨‹åº¦ | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½ |
|------|---------|------|------|---------|
| coreLibraryDesugaringæœªé…ç½® | ğŸ”´ é«˜ | 20% | ç¼–è¯‘å¤±è´¥ | éªŒè¯build.gradle.ktsé…ç½® |
| å¤§æ•°æ®é‡æŸ¥è¯¢æ€§èƒ½ | ğŸŸ¡ ä¸­ | 15% | å“åº”æ…¢ | é™åˆ¶æŸ¥è¯¢æ¡æ•°ï¼Œåˆ©ç”¨ç´¢å¼• |
| æ—¶é—´æ ¼å¼åŒ–æœ¬åœ°åŒ– | ğŸŸ¢ ä½ | 10% | æ˜¾ç¤ºå¼‚å¸¸ | ä½¿ç”¨ç³»ç»Ÿé»˜è®¤Locale |
| Tokenæ¶ˆè€—å¢åŠ  | ğŸŸ¢ ä½ | 30% | æˆæœ¬å¢åŠ  | æä¾›0æ¡é€‰é¡¹ï¼Œé»˜è®¤5æ¡ |

---

## å‰ç½®æ£€æŸ¥æ¸…å•

å¼€å§‹å¼€å‘å‰ï¼Œè¯·ç¡®è®¤ä»¥ä¸‹é…ç½®ï¼š

### coreLibraryDesugaringé…ç½®

ç¡®è®¤ `app/build.gradle.kts` ä¸­å·²é…ç½®ï¼š

```kotlin
android {
    compileOptions {
        isCoreLibraryDesugaringEnabled = true
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
    }
}

dependencies {
    coreLibraryDesugaring("com.android.tools:desugar_jdk_libs:2.0.4")
}
```

### æ•°æ®åº“ç´¢å¼•ç¡®è®¤

ç¡®è®¤ `ConversationLogEntity` å·²æœ‰ä»¥ä¸‹ç´¢å¼•ï¼š
- `contact_id` ç´¢å¼•
- `timestamp` ç´¢å¼•

---

## ç›¸å…³æ–‡æ¡£

- [PRD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºéœ€æ±‚](../PRD/PRD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºéœ€æ±‚.md)
- [FD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºåŠŸèƒ½è®¾è®¡](../FD/FD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºåŠŸèƒ½è®¾è®¡.md)
- [TDD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºæŠ€æœ¯è®¾è®¡](../TDD/TDD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºæŠ€æœ¯è®¾è®¡.md)


---

## Bugä¿®å¤è®°å½•

### BUG-001: å†å²ä¸Šä¸‹æ–‡ä¸ç”Ÿæ•ˆé—®é¢˜

**å‘ç°æ—¥æœŸ**: 2025-12-17  
**ä¿®å¤æ—¥æœŸ**: 2025-12-17  
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜  

#### é—®é¢˜æè¿°

ç”¨æˆ·äººå·¥æµ‹è¯•å‘ç°ï¼šåœ¨å‰é¢å·²æœ‰ä¿¡æ¯çš„æƒ…å†µä¸‹ï¼Œæ–°å‘é€çš„æ¶ˆæ¯ä¸ä¼šå¸¦ä¸Šå‰é¢çš„å†å²ä¿¡æ¯ã€‚

#### æ ¹å› åˆ†æ

**æ‰§è¡Œé¡ºåºé—®é¢˜**ï¼šåŸä»£ç ä¸­ï¼Œ`saveUserInput()`ï¼ˆæ­¥éª¤5ï¼‰åœ¨ `buildHistoryContext()`ï¼ˆæ­¥éª¤5.5ï¼‰ä¹‹å‰æ‰§è¡Œã€‚è¿™å¯¼è‡´ï¼š

1. ç”¨æˆ·ç‚¹å‡»"å¸®æˆ‘åˆ†æ"
2. å½“å‰è¾“å…¥è¢«ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆæ­¥éª¤5ï¼‰
3. æŸ¥è¯¢å†å²è®°å½•ï¼ˆæ­¥éª¤5.5ï¼‰
4. **é—®é¢˜**ï¼šåˆšä¿å­˜çš„å½“å‰è¾“å…¥ä¹Ÿè¢«æŸ¥å‡ºæ¥ï¼Œä½œä¸º"å†å²"çš„ä¸€éƒ¨åˆ†
5. å®é™…ä¸Šæ²¡æœ‰çœŸæ­£çš„"ä¹‹å‰çš„å†å²"è¢«åŒ…å«

```
åŸæµç¨‹ï¼ˆé”™è¯¯ï¼‰:
saveUserInput() â†’ buildHistoryContext() â†’ AIåˆ†æ
                  â†‘
                  æŸ¥è¯¢ç»“æœåŒ…å«åˆšä¿å­˜çš„å½“å‰è¾“å…¥ï¼Œè€ŒéçœŸæ­£çš„å†å²
```

#### ä¿®å¤æ–¹æ¡ˆ

**è°ƒæ•´æ‰§è¡Œé¡ºåº**ï¼šå°†å†å²æŸ¥è¯¢ç§»åˆ°ä¿å­˜å½“å‰è¾“å…¥ä¹‹å‰ã€‚

```
ä¿®å¤åæµç¨‹ï¼ˆæ­£ç¡®ï¼‰:
buildHistoryContext() â†’ saveUserInput() â†’ AIåˆ†æ
â†‘
æŸ¥è¯¢ç»“æœåªåŒ…å«ä¹‹å‰çš„å†å²è®°å½•
```

#### ä¿®æ”¹æ–‡ä»¶

1. **`AnalyzeChatUseCase.kt`**
   - å°†æ­¥éª¤5ï¼ˆä¿å­˜ç”¨æˆ·è¾“å…¥ï¼‰å’Œæ­¥éª¤5.5ï¼ˆæ„å»ºå†å²ä¸Šä¸‹æ–‡ï¼‰çš„é¡ºåºè°ƒæ¢
   - æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºåç»­æ’æŸ¥
   - æ›´æ–°æ­¥éª¤ç¼–å·æ³¨é‡Š

2. **`ConversationRepositoryImpl.kt`**
   - åœ¨ `getRecentConversations()` æ–¹æ³•ä¸­æ·»åŠ è°ƒè¯•æ—¥å¿—

#### éªŒè¯æ–¹æ³•

1. åœ¨è®¾ç½®ä¸­ç¡®è®¤å†å²æ¡æ•°é…ç½®ä¸º5æˆ–10
2. å¯¹åŒä¸€è”ç³»äººè¿›è¡Œå¤šæ¬¡åˆ†æ
3. æŸ¥çœ‹Logcatæ—¥å¿—ï¼š
   - `AnalyzeChatUseCase: å†å²é…ç½®: historyCount=X, contactId=XXX`
   - `ConversationRepo: æŸ¥è¯¢å†å²: contactId=XXX, limit=X, ç»“æœæ•°=X`
   - `AnalyzeChatUseCase: å†å²ä¸Šä¸‹æ–‡é•¿åº¦: X, å†…å®¹é¢„è§ˆ: ...`
4. ç¡®è®¤AIå›å¤ä¸­åŒ…å«å¯¹å†å²å¯¹è¯çš„å¼•ç”¨

#### ç»éªŒæ•™è®­

1. **æ•°æ®åº“æ“ä½œé¡ºåºæ•æ„Ÿ**ï¼šæ¶‰åŠ"å…ˆä¿å­˜åæŸ¥è¯¢"çš„åœºæ™¯ï¼Œéœ€è¦ä»”ç»†è€ƒè™‘æ‰§è¡Œé¡ºåº
2. **æ·»åŠ è°ƒè¯•æ—¥å¿—**ï¼šå…³é”®ä¸šåŠ¡æµç¨‹åº”æ·»åŠ æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
3. **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯•å¯èƒ½æ— æ³•è¦†ç›–æ‰§è¡Œé¡ºåºé—®é¢˜ï¼Œéœ€è¦äººå·¥ç«¯åˆ°ç«¯æµ‹è¯•
