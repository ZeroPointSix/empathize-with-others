# TD-00008 输入内容身份识别与双向对话历史任务清单

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档编号 | TD-00008 |
| 创建日期 | 2025-12-17 |
| 更新日期 | 2025-12-17 |
| 状态 | 进行中 |
| 关联PRD | PRD-00008 |
| 关联FD | FD-00008 |
| 关联TDD | TDD-00008 |

---

## 1. 任务概览

| 阶段 | 任务数 | 预计工时 |
|-----|-------|---------|
| 阶段1：核心工具类 | 4 | 0.5天 |
| 阶段2：UseCase集成 | 3 | 0.5天 |
| 阶段3：提示词优化 | 2 | 0.25天 |
| 阶段4：UI渲染优化 | 4 | 0.5天 |
| 阶段5：单元测试 | 3 | 0.5天 |
| 阶段6：集成测试 | 2 | 0.25天 |
| **总计** | **18** | **2.5天** |

---

## 2. 阶段1：核心工具类（0.5天）

### 任务1.1：创建 IdentityPrefixHelper 工具类基础结构

- [x] **任务ID**: T-00008-01
- **文件**: `app/src/main/java/com/empathy/ai/domain/util/IdentityPrefixHelper.kt`
- **描述**: 创建身份前缀工具类，包含常量定义和枚举
- **验收标准**:
  - [x] 定义 `PREFIX_CONTACT = "【对方说】："`
  - [x] 定义 `PREFIX_USER = "【我正在回复】："`
  - [x] 定义 `IdentityRole` 枚举（CONTACT, USER, LEGACY）
  - [x] 定义 `ParseResult` 数据类（role, pureText）

### 任务1.2：实现 addPrefix 方法

- [x] **任务ID**: T-00008-02
- **文件**: `app/src/main/java/com/empathy/ai/domain/util/IdentityPrefixHelper.kt`
- **描述**: 实现根据角色添加前缀的方法
- **验收标准**:
  - [x] `addPrefix(text: String, role: IdentityRole): String`
  - [x] CONTACT 角色添加 `【对方说】：` 前缀
  - [x] USER 角色添加 `【我正在回复】：` 前缀
  - [x] LEGACY 角色不添加前缀
  - [x] 调用 `stripAllPrefixes` 防止双重前缀

### 任务1.3：实现 parse 方法

- [x] **任务ID**: T-00008-03
- **文件**: `app/src/main/java/com/empathy/ai/domain/util/IdentityPrefixHelper.kt`
- **描述**: 实现解析带前缀文本的方法
- **验收标准**:
  - [x] `parse(text: String): ParseResult`
  - [x] 识别 `【对方说】：` 前缀返回 CONTACT
  - [x] 识别 `【我正在回复】：` 前缀返回 USER
  - [x] 无前缀返回 LEGACY
  - [x] 正确提取纯文本内容

### 任务1.4：实现 stripAllPrefixes 和 rebuildWithPrefix 方法

- [x] **任务ID**: T-00008-04
- **文件**: `app/src/main/java/com/empathy/ai/domain/util/IdentityPrefixHelper.kt`
- **描述**: 实现递归去除前缀和重建前缀的方法
- **验收标准**:
  - [x] `stripAllPrefixes(text: String): String` 递归去除所有前缀
  - [x] `rebuildWithPrefix(text: String, originalRole: IdentityRole): String`
  - [x] 处理双重前缀场景：`【对方说】：【对方说】：xxx` → `xxx`
  - [x] 编辑保存时正确重建前缀

---

## 3. 阶段2：UseCase集成（0.5天）

### 任务2.1：修改 AnalyzeChatUseCase

- [x] **任务ID**: T-00008-05
- **文件**: `app/src/main/java/com/empathy/ai/domain/usecase/AnalyzeChatUseCase.kt`
- **描述**: 在分析流程中自动添加"对方说"前缀
- **验收标准**:
  - [x] 导入 `IdentityPrefixHelper`
  - [x] 在 `invoke` 方法中调用 `addPrefix(userInput, IdentityRole.CONTACT)`
  - [x] 处理后的文本传递给 AI 和存储
  - [x] 不影响现有返回值结构

### 任务2.2：修改 CheckDraftUseCase

- [x] **任务ID**: T-00008-06
- **文件**: `app/src/main/java/com/empathy/ai/domain/usecase/CheckDraftUseCase.kt`
- **描述**: 在检查流程中自动添加"我正在回复"前缀
- **验收标准**:
  - [x] 导入 `IdentityPrefixHelper`
  - [x] 在 `invoke` 方法中调用 `addPrefix(draft, IdentityRole.USER)`
  - [x] 处理后的文本仅用于 AI 分析，不存储
  - [x] 不影响现有返回值结构

### 任务2.3：修改 ConversationContextBuilder

- [x] **任务ID**: T-00008-07
- **文件**: `app/src/main/java/com/empathy/ai/domain/util/ConversationContextBuilder.kt`
- **描述**: 在构建上下文时保留身份前缀
- **验收标准**:
  - [x] 历史记录拼接时保留原始前缀
  - [x] 格式：`【对方说】：xxx\n【我正在回复】：yyy\n...`
  - [x] 兼容无前缀的历史数据（LEGACY）

---

## 4. 阶段3：提示词优化（0.25天）

### 任务3.1：修改 SystemPrompts ANALYZE_HEADER

- [x] **任务ID**: T-00008-08
- **文件**: `app/src/main/java/com/empathy/ai/domain/util/SystemPrompts.kt`
- **描述**: 在分析提示词中加入身份识别说明和防回声规则
- **验收标准**:
  - [x] 添加身份前缀说明：`【对方说】：表示对方发来的消息`
  - [x] 添加防回声规则：`不要自行添加任何【】格式的角色前缀`
  - [x] 保持原有提示词结构不变

### 任务3.2：修改 SystemPrompts CHECK_HEADER

- [x] **任务ID**: T-00008-09
- **文件**: `app/src/main/java/com/empathy/ai/domain/util/SystemPrompts.kt`
- **描述**: 在检查提示词中加入身份识别说明和防回声规则
- **验收标准**:
  - [x] 添加身份前缀说明：`【我正在回复】：表示用户打算发送的内容`
  - [x] 添加防回声规则：`不要自行添加任何【】格式的角色前缀`
  - [x] 保持原有提示词结构不变

---

## 5. 阶段4：UI渲染优化（0.5天）

### 任务4.1：创建 ConversationBubble 组件

- [x] **任务ID**: T-00008-10
- **文件**: `app/src/main/java/com/empathy/ai/presentation/ui/component/message/ConversationBubble.kt`
- **描述**: 创建支持左右布局的对话气泡组件
- **验收标准**:
  - [x] 接收 `text: String` 和 `role: IdentityRole` 参数
  - [x] CONTACT 角色：左对齐，浅灰背景
  - [x] USER 角色：右对齐，主题色背景
  - [x] LEGACY 角色：居中对齐，中性背景
  - [x] 隐藏前缀，只显示纯文本

### 任务4.2：修改 TimelineView 使用 ConversationBubble

- [ ] **任务ID**: T-00008-11
- **文件**: `app/src/main/java/com/empathy/ai/presentation/ui/screen/contact/factstream/TimelineView.kt`
- **描述**: 在时间线视图中使用新的气泡组件
- **验收标准**:
  - [ ] 对话类型的 TimelineItem 使用 ConversationBubble
  - [ ] 调用 `IdentityPrefixHelper.parse()` 解析角色
  - [ ] 保持其他类型 TimelineItem 不变
- **备注**: 可选任务，当前 ConversationCard 已能正常工作，后续可优化

### 任务4.3：修改 ListView 使用 ConversationBubble

- [ ] **任务ID**: T-00008-12
- **文件**: `app/src/main/java/com/empathy/ai/presentation/ui/screen/contact/factstream/ListView.kt`
- **描述**: 在列表视图中使用新的气泡组件
- **验收标准**:
  - [ ] 对话类型的列表项使用 ConversationBubble
  - [ ] 调用 `IdentityPrefixHelper.parse()` 解析角色
  - [ ] 保持其他类型列表项不变
- **备注**: 可选任务，当前 ListViewRow 已能正常工作，后续可优化

### 任务4.4：修改 EditConversationDialog

- [x] **任务ID**: T-00008-13
- **文件**: `app/src/main/java/com/empathy/ai/presentation/ui/component/dialog/EditConversationDialog.kt`
- **描述**: 编辑对话时正确处理前缀
- **验收标准**:
  - [x] 加载时：调用 `parse()` 提取纯文本显示在编辑框
  - [x] 保存时：调用 `rebuildWithPrefix()` 重新拼接前缀
  - [x] 记住原始角色，保存时使用原始角色
  - [x] 用户无感知前缀存在

---

## 6. 阶段5：单元测试（0.5天）

### 任务5.1：创建 IdentityPrefixHelperTest

- [x] **任务ID**: T-00008-14
- **文件**: `app/src/test/java/com/empathy/ai/domain/util/IdentityPrefixHelperTest.kt`
- **描述**: 为 IdentityPrefixHelper 编写完整单元测试
- **验收标准**:
  - [x] 测试 `addPrefix` 各角色场景
  - [x] 测试 `parse` 各前缀识别场景
  - [x] 测试 `stripAllPrefixes` 双重前缀场景
  - [x] 测试 `rebuildWithPrefix` 编辑保存场景
  - [x] 测试边界情况（空字符串、null安全）

### 任务5.2：更新 AnalyzeChatUseCaseTest

- [ ] **任务ID**: T-00008-15
- **文件**: `app/src/test/java/com/empathy/ai/domain/usecase/AnalyzeChatUseCaseTest.kt`
- **描述**: 添加身份前缀相关测试用例
- **验收标准**:
  - [ ] 测试输入自动添加 `【对方说】：` 前缀
  - [ ] 测试存储的内容包含前缀
  - [ ] 测试传递给 AI 的内容包含前缀
- **备注**: 可选任务，核心逻辑已在 IdentityPrefixHelperTest 中覆盖

### 任务5.3：更新 CheckDraftUseCaseTest

- [ ] **任务ID**: T-00008-16
- **文件**: `app/src/test/java/com/empathy/ai/domain/usecase/CheckDraftUseCaseTest.kt`
- **描述**: 添加身份前缀相关测试用例
- **验收标准**:
  - [ ] 测试输入自动添加 `【我正在回复】：` 前缀
  - [ ] 测试不存储历史记录
  - [ ] 测试传递给 AI 的内容包含前缀
- **备注**: 可选任务，核心逻辑已在 IdentityPrefixHelperTest 中覆盖

---

## 7. 阶段6：集成测试（0.25天）

### 任务6.1：端到端流程测试

- [x] **任务ID**: T-00008-17
- **文件**: `app/src/test/java/com/empathy/ai/integration/IdentityPrefixIntegrationTest.kt`
- **描述**: 测试完整的身份识别流程
- **验收标准**:
  - [x] 测试【帮我分析】→ 存储 → UI显示完整流程
  - [x] 测试【帮我检查】→ AI分析 → 不存储完整流程
  - [x] 测试编辑对话 → 保存 → 前缀保留完整流程

### 任务6.2：数据兼容性测试

- [x] **任务ID**: T-00008-18
- **文件**: `app/src/test/java/com/empathy/ai/integration/IdentityPrefixIntegrationTest.kt`
- **描述**: 测试与历史数据的兼容性
- **验收标准**:
  - [x] 测试无前缀历史数据正确显示为 LEGACY
  - [x] 测试新旧数据混合场景
  - [x] 测试 UI 正确渲染三种角色

---

## 8. 任务依赖关系

```
阶段1 (核心工具类)
  ├── T-00008-01 (基础结构)
  ├── T-00008-02 (addPrefix) ← 依赖 T-00008-01
  ├── T-00008-03 (parse) ← 依赖 T-00008-01
  └── T-00008-04 (stripAllPrefixes) ← 依赖 T-00008-01
        ↓
阶段2 (UseCase集成) ← 依赖阶段1全部完成
  ├── T-00008-05 (AnalyzeChatUseCase)
  ├── T-00008-06 (CheckDraftUseCase)
  └── T-00008-07 (ConversationContextBuilder)
        ↓
阶段3 (提示词优化) ← 可与阶段2并行
  ├── T-00008-08 (ANALYZE_HEADER)
  └── T-00008-09 (CHECK_HEADER)
        ↓
阶段4 (UI渲染优化) ← 依赖阶段1完成
  ├── T-00008-10 (ConversationBubble)
  ├── T-00008-11 (TimelineView) ← 依赖 T-00008-10
  ├── T-00008-12 (ListView) ← 依赖 T-00008-10
  └── T-00008-13 (EditConversationDialog)
        ↓
阶段5 (单元测试) ← 依赖对应功能完成
  ├── T-00008-14 (IdentityPrefixHelperTest) ← 依赖阶段1
  ├── T-00008-15 (AnalyzeChatUseCaseTest) ← 依赖 T-00008-05
  └── T-00008-16 (CheckDraftUseCaseTest) ← 依赖 T-00008-06
        ↓
阶段6 (集成测试) ← 依赖阶段1-5全部完成
  ├── T-00008-17 (端到端测试)
  └── T-00008-18 (兼容性测试)
```

---

## 9. 风险与注意事项

### 9.1 技术风险

| 风险 | 影响 | 缓解措施 |
|-----|-----|---------|
| 双重前缀问题 | 数据污染 | `stripAllPrefixes` 递归处理 |
| 历史数据兼容 | UI显示异常 | LEGACY 角色兜底处理 |
| AI 回声问题 | 输出包含前缀 | 提示词加入防回声规则 |

### 9.2 注意事项

1. **前缀常量不可修改**：一旦上线，前缀字符串不能修改，否则历史数据无法解析
2. **编辑保存闭环**：必须记住原始角色，否则编辑后角色丢失
3. **UI 隐藏前缀**：用户不应看到 `【对方说】：` 等前缀文本
4. **测试覆盖**：边界情况（空字符串、特殊字符）必须测试
5. **🚨 禁止字符串硬编码**：整个项目中除了 `IdentityPrefixHelper` 定义处，**禁止直接使用** `"【对方说】："` 或 `"【我正在回复】："` 字符串字面量。所有引用必须通过常量：
   - ✅ 正确：`IdentityPrefixHelper.PREFIX_CONTACT`
   - ❌ 错误：`"【对方说】："`
   - **原因**：防止未来修改前缀（如中文冒号变英文冒号）时遗漏某处导致全盘崩溃

### 9.3 代码审查检查点

在代码审查时，必须检查以下内容：

```kotlin
// 🚨 代码审查时搜索以下字符串，确保只出现在 IdentityPrefixHelper.kt 中
"【对方说】"
"【我正在回复】"
"对方说】："
"我正在回复】："
```

如果在其他文件中发现上述字符串，必须改为使用常量引用。

---

## 10. 验收检查清单

### 10.1 功能验收

- [ ] 【帮我分析】自动添加 `【对方说】：` 前缀
- [ ] 【帮我检查】自动添加 `【我正在回复】：` 前缀
- [ ] 【帮我检查】不保存历史记录
- [ ] UI 正确显示左右气泡布局
- [ ] 编辑对话时前缀正确保留
- [ ] 历史数据兼容显示

### 10.2 测试验收

- [ ] IdentityPrefixHelper 单元测试全部通过
- [ ] UseCase 单元测试全部通过
- [ ] 集成测试全部通过
- [ ] 无回归问题

### 10.3 代码质量

- [ ] 代码符合项目规范
- [ ] 注释完整清晰
- [ ] 无 Lint 警告
- [ ] 构建成功
- [ ] **字符串硬编码检查通过**：搜索 `"【对方说】"` 和 `"【我正在回复】"` 确保只出现在 `IdentityPrefixHelper.kt`

---

## 11. 文档更新

完成开发后需更新以下文档：

- [ ] `WORKSPACE.md` - 更新任务状态
- [ ] `product.md` - 更新功能实现状态
- [ ] `structure.md` - 添加新文件到项目结构

---

## 变更记录

| 版本 | 日期 | 作者 | 变更内容 |
|-----|------|-----|---------|
| 1.0 | 2025-12-17 | AI | 初始版本 |
| 1.1 | 2025-12-17 | AI | 完成阶段1-6核心任务实现（14/18任务完成） |
