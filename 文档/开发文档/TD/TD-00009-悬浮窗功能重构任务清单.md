# TD-00009: æ‚¬æµ®çª—åŠŸèƒ½é‡æ„ä»»åŠ¡æ¸…å•

## æ–‡æ¡£ä¿¡æ¯

**æ–‡æ¡£ç¼–å·**: TD-00009  
**ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-12-17  
**æœ€åæ›´æ–°**: 2025-12-17  
**éœ€æ±‚æ–‡æ¡£**: `æ–‡æ¡£/å¼€å‘æ–‡æ¡£/PRD/PRD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„éœ€æ±‚.md` (v1.0)  
**åŠŸèƒ½è®¾è®¡**: `æ–‡æ¡£/å¼€å‘æ–‡æ¡£/FD/FD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„åŠŸèƒ½è®¾è®¡.md` (v1.0)  
**æŠ€æœ¯è®¾è®¡**: `æ–‡æ¡£/å¼€å‘æ–‡æ¡£/TDD/TDD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„æŠ€æœ¯è®¾è®¡.md` (v1.0)  
**çŠ¶æ€**: ğŸ“ å¾…å¼€å‘  
**è´Ÿè´£äºº**: Kiro  
**é¢„è®¡å·¥ä½œé‡**: 9ä¸ªå·¥ä½œæ—¥  
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-17 | Kiro | åˆå§‹ç‰ˆæœ¬ |

---

## ä»»åŠ¡æ ¼å¼è¯´æ˜

- **[P]**: å¯å¹¶è¡Œæ‰§è¡Œï¼ˆä¸åŒæ–‡ä»¶ï¼Œæ— ä¾èµ–ï¼‰
- **[é˜¶æ®µX]**: æ‰€å±å¼€å‘é˜¶æ®µï¼ˆé˜¶æ®µ1-4ï¼‰
- **[ä¾èµ–]**: ä¾èµ–å…¶ä»–ä»»åŠ¡å®Œæˆ
- æè¿°ä¸­åŒ…å«ç¡®åˆ‡çš„æ–‡ä»¶è·¯å¾„

---

## è·¯å¾„çº¦å®š

åŸºäºé¡¹ç›®ç»“æ„ `com.empathy.ai/`:
- **é¢†åŸŸå±‚**: `domain/model/`, `domain/usecase/`, `domain/util/`
- **æ•°æ®å±‚**: `data/local/`, `data/repository/`
- **è¡¨ç°å±‚**: `presentation/ui/floating/`
- **ä¾èµ–æ³¨å…¥**: `di/`
- **æµ‹è¯•**: `test/`, `androidTest/`

---

## å¼€å‘é˜¶æ®µæ˜ å°„

æ ¹æ®TDD-00009ï¼Œæœ¬åŠŸèƒ½åˆ†ä¸º4ä¸ªå¼€å‘é˜¶æ®µï¼š

- **é˜¶æ®µ1**: åç«¯é‡æ„ - æ•°æ®æ¨¡å‹å’ŒUseCaseï¼ˆ3å¤©ï¼‰ğŸ¯ åŸºç¡€
- **é˜¶æ®µ2**: çŠ¶æ€ç®¡ç†ï¼ˆ1å¤©ï¼‰
- **é˜¶æ®µ3**: UIé‡æ„ï¼ˆ3å¤©ï¼‰
- **é˜¶æ®µ4**: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ2å¤©ï¼‰

**æ€»å·¥æœŸ**: 9ä¸ªå·¥ä½œæ—¥

---

## æ€»ä½“è¿›åº¦

| é˜¶æ®µ | ä»»åŠ¡æ•° | å·²å®Œæˆ | è¿›åº¦ |
|------|--------|--------|------|
| é˜¶æ®µ1: åç«¯é‡æ„ | 18 | 0 | 0% |
| é˜¶æ®µ2: çŠ¶æ€ç®¡ç† | 6 | 0 | 0% |
| é˜¶æ®µ3: UIé‡æ„ | 12 | 0 | 0% |
| é˜¶æ®µ4: æµ‹è¯•ä¸ä¼˜åŒ– | 10 | 0 | 0% |
| **æ€»è®¡** | **46** | **0** | **0%** |

---


## é˜¶æ®µ1: åç«¯é‡æ„ - æ•°æ®æ¨¡å‹å’ŒUseCaseï¼ˆ3å¤©ï¼‰

**ç›®æ ‡**: å»ºç«‹æ•°æ®æ¨¡å‹ã€å®ç°ä¸‰å¤§æ ¸å¿ƒUseCaseã€æ‰©å±•Repository

**é‡Œç¨‹ç¢‘**: M1 - åç«¯å®Œæˆï¼Œæ‰€æœ‰UseCaseå¯ç‹¬ç«‹è¿è¡Œ

### 1.1 æ•°æ®æ¨¡å‹ï¼ˆDomain Layerï¼‰

- [ ] T001 [P] æ‰©å±•ActionTypeæšä¸¾
  - æ–‡ä»¶: `domain/model/ActionType.kt`
  - ä¿®æ”¹: æ·»åŠ POLISHã€REPLYç±»å‹ï¼ŒåºŸå¼ƒCHECK
  - å†…å®¹: displayNameã€iconã€identityPrefixå±æ€§
  - åŒ…å«: default()ã€validTypes()æ–¹æ³•

- [ ] T002 [P] åˆ›å»ºPolishResultæ¶¦è‰²ç»“æœæ¨¡å‹
  - æ–‡ä»¶: `domain/model/PolishResult.kt`
  - å†…å®¹: polishedTextã€hasRiskã€riskWarning
  - åŒ…å«: getCopyableText()ã€getDisplayContent()æ–¹æ³•
  - æ³¨è§£: @JsonClass(generateAdapter = true)

- [ ] T003 [P] åˆ›å»ºReplyResultå›å¤ç»“æœæ¨¡å‹
  - æ–‡ä»¶: `domain/model/ReplyResult.kt`
  - å†…å®¹: suggestedReplyã€strategyNote
  - åŒ…å«: getCopyableText()ã€getDisplayContent()æ–¹æ³•
  - æ³¨è§£: @JsonClass(generateAdapter = true)

- [ ] T004 [P] åˆ›å»ºAiResultå¯†å°ç±»
  - æ–‡ä»¶: `domain/model/AiResult.kt`
  - å†…å®¹: Analysisã€Polishã€Replyä¸‰ä¸ªå­ç±»
  - åŒ…å«: getCopyableText()ã€getDisplayContent()æ–¹æ³•

- [ ] T005 [P] åˆ›å»ºFloatingWindowStateçŠ¶æ€æ¨¡å‹
  - æ–‡ä»¶: `domain/model/FloatingWindowState.kt`
  - å†…å®¹: selectedTabã€selectedContactIdã€inputTextã€lastResultã€isLoadingã€errorMessage
  - åŒ…å«: hasResult()ã€canSubmit()ã€clearResult()æ–¹æ³•

- [ ] T006 [P] åˆ›å»ºRefinementRequestå¾®è°ƒè¯·æ±‚æ¨¡å‹
  - æ–‡ä»¶: `domain/model/RefinementRequest.kt`
  - å†…å®¹: originalInputã€originalTaskã€lastAiResponseã€refinementInstructionã€contactId
  - åŒ…å«: hasInstruction()æ–¹æ³•

- [ ] T007 [P] åˆ›å»ºFloatingWindowErroré”™è¯¯ç±»å‹
  - æ–‡ä»¶: `domain/model/FloatingWindowError.kt`
  - å†…å®¹: NoProviderConfiguredã€ContactNotFoundã€AiCallFailedã€ParseFailedã€NetworkTimeoutã€EmptyInputã€NoContactSelected
  - åŒ…å«: getUserMessage()ã€isRetryable()æ–¹æ³•

### 1.2 æç¤ºè¯æ‰©å±•

- [ ] T008 [ä¾èµ–T001] æ‰©å±•PromptSceneæšä¸¾
  - æ–‡ä»¶: `domain/model/PromptScene.kt`
  - ä¿®æ”¹: æ·»åŠ POLISHã€REPLYåœºæ™¯
  - å†…å®¹: displayNameã€descriptionã€availableVariables

- [ ] T009 [ä¾èµ–T008] æ‰©å±•SystemPromptsæç¤ºè¯
  - æ–‡ä»¶: `domain/util/SystemPrompts.kt`
  - æ·»åŠ : POLISH_HEADERã€POLISH_FOOTER
  - æ·»åŠ : REPLY_HEADERã€REPLY_FOOTER
  - ä¿®æ”¹: getHeader()ã€getFooter()æ–¹æ³•æ”¯æŒæ–°åœºæ™¯

### 1.3 Repositoryæ‰©å±•

- [ ] T010 [ä¾èµ–T002,T003] æ‰©å±•AiRepositoryæ¥å£
  - æ–‡ä»¶: `domain/repository/AiRepository.kt`
  - æ·»åŠ : polishDraft()ã€generateReply()
  - æ·»åŠ : refineAnalysis()ã€refinePolish()ã€refineReply()

- [ ] T011 [ä¾èµ–T010] å®ç°AiRepositoryImplæ–°å¢æ–¹æ³•
  - æ–‡ä»¶: `data/repository/AiRepositoryImpl.kt`
  - å®ç°: polishDraft()ã€generateReply()
  - å®ç°: refineAnalysis()ã€refinePolish()ã€refineReply()
  - æ·»åŠ : parsePolishResult()ã€parseReplyResult()ç§æœ‰æ–¹æ³•
  - é…ç½®: å¯é…ç½®è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤45ç§’ï¼‰

### 1.4 UseCaseå®ç°

- [ ] T012 [ä¾èµ–T002,T009,T010] åˆ›å»ºPolishDraftUseCase
  - æ–‡ä»¶: `domain/usecase/PolishDraftUseCase.kt`
  - åŠŸèƒ½: æ¶¦è‰²ç”¨æˆ·è‰ç¨¿
  - ä¾èµ–æ³¨å…¥: ContactRepositoryã€BrainTagRepositoryã€PrivacyRepositoryã€AiRepositoryã€AiProviderRepositoryã€PromptBuilderã€IdentityPrefixHelper
  - æµç¨‹: å‰ç½®æ£€æŸ¥â†’åŠ è½½è”ç³»äººâ†’æ•°æ®è„±æ•â†’æ·»åŠ èº«ä»½å‰ç¼€â†’æ„å»ºæç¤ºè¯â†’è°ƒç”¨AI

- [ ] T013 [ä¾èµ–T003,T009,T010] åˆ›å»ºGenerateReplyUseCase
  - æ–‡ä»¶: `domain/usecase/GenerateReplyUseCase.kt`
  - åŠŸèƒ½: æ ¹æ®å¯¹æ–¹æ¶ˆæ¯ç”Ÿæˆå›å¤
  - ä¾èµ–æ³¨å…¥: ContactRepositoryã€BrainTagRepositoryã€PrivacyRepositoryã€AiRepositoryã€AiProviderRepositoryã€PromptBuilderã€ConversationRepositoryã€IdentityPrefixHelper
  - æµç¨‹: å‰ç½®æ£€æŸ¥â†’åŠ è½½è”ç³»äººâ†’æ•°æ®è„±æ•â†’æ·»åŠ èº«ä»½å‰ç¼€â†’ä¿å­˜å¯¹è¯è®°å½•â†’æ„å»ºæç¤ºè¯â†’è°ƒç”¨AI

- [ ] T014 [ä¾èµ–T004,T006,T012,T013] åˆ›å»ºRefinementUseCase
  - æ–‡ä»¶: `domain/usecase/RefinementUseCase.kt`
  - åŠŸèƒ½: å¾®è°ƒé‡æ–°ç”ŸæˆAIç»“æœ
  - ä¾èµ–æ³¨å…¥: AnalyzeChatUseCaseã€PolishDraftUseCaseã€GenerateReplyUseCaseã€AiRepositoryã€AiProviderRepository
  - é€»è¾‘: æœ‰æŒ‡ä»¤â†’refineWithInstruction()ï¼Œæ— æŒ‡ä»¤â†’regenerateDirectly()

### 1.5 ä¾èµ–æ³¨å…¥

- [ ] T015 [ä¾èµ–T012,T013,T014] åˆ›å»ºFloatingWindowModule
  - æ–‡ä»¶: `di/FloatingWindowModule.kt`
  - æä¾›: PolishDraftUseCaseã€GenerateReplyUseCaseã€RefinementUseCase
  - æ³¨è§£: @Moduleã€@InstallIn(SingletonComponent::class)

### 1.6 é˜¶æ®µ1å•å…ƒæµ‹è¯•

- [ ] T016 [P][ä¾èµ–T002] åˆ›å»ºPolishResultTest
  - æ–‡ä»¶: `test/domain/model/PolishResultTest.kt`
  - æµ‹è¯•: getCopyableText()ã€getDisplayContent()ã€é£é™©æç¤ºæ˜¾ç¤º

- [ ] T017 [P][ä¾èµ–T003] åˆ›å»ºReplyResultTest
  - æ–‡ä»¶: `test/domain/model/ReplyResultTest.kt`
  - æµ‹è¯•: getCopyableText()ã€getDisplayContent()ã€ç­–ç•¥è¯´æ˜æ˜¾ç¤º

- [ ] T018 [P][ä¾èµ–T004] åˆ›å»ºAiResultTest
  - æ–‡ä»¶: `test/domain/model/AiResultTest.kt`
  - æµ‹è¯•: ä¸‰ç§å­ç±»çš„getCopyableText()ã€getDisplayContent()

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰æ•°æ®æ¨¡å‹å¯æ­£ç¡®åºåˆ—åŒ–/ååºåˆ—åŒ–
- [ ] PolishDraftUseCaseå¯ç‹¬ç«‹è¿è¡Œå¹¶è¿”å›æ­£ç¡®ç»“æœ
- [ ] GenerateReplyUseCaseå¯ç‹¬ç«‹è¿è¡Œå¹¶è¿”å›æ­£ç¡®ç»“æœ
- [ ] RefinementUseCaseæ”¯æŒæœ‰/æ— æŒ‡ä»¤ä¸¤ç§æ¨¡å¼
- [ ] é˜¶æ®µ1å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡

---


## é˜¶æ®µ2: çŠ¶æ€ç®¡ç†ï¼ˆ1å¤©ï¼‰

**ç›®æ ‡**: å®ç°æ‚¬æµ®çª—çŠ¶æ€ä¿æŒã€Tabè®°å¿†ã€è”ç³»äººè®°å¿†åŠŸèƒ½

**é‡Œç¨‹ç¢‘**: M2 - çŠ¶æ€ç®¡ç†å®Œæˆï¼ŒçŠ¶æ€ä¿å­˜/æ¢å¤åŠŸèƒ½å¯ç”¨

### 2.1 FloatingWindowPreferencesæ‰©å±•

- [ ] T019 [ä¾èµ–T001,T005] æ‰©å±•FloatingWindowPreferences
  - æ–‡ä»¶: `data/local/FloatingWindowPreferences.kt`
  - æ·»åŠ å¸¸é‡: KEY_SELECTED_TABã€KEY_LAST_CONTACT_IDã€KEY_SAVED_INPUT_TEXTã€KEY_HAS_SAVED_STATE
  - æ·»åŠ æ–¹æ³•: getSelectedTab()ã€saveSelectedTab()
  - æ·»åŠ æ–¹æ³•: getLastContactId()ã€saveLastContactId()
  - æ·»åŠ æ–¹æ³•: saveState()ã€restoreState()ã€clearSavedState()ã€hasSavedState()

### 2.2 çŠ¶æ€ç®¡ç†é€»è¾‘

- [ ] T020 [ä¾èµ–T019] å®ç°Tabè®°å¿†åŠŸèƒ½
  - æ–‡ä»¶: `data/local/FloatingWindowPreferences.kt`
  - åŠŸèƒ½: è®°ä½ç”¨æˆ·ä¸Šæ¬¡é€‰ä¸­çš„Tab
  - é€»è¾‘: åˆ‡æ¢Tabæ—¶è°ƒç”¨saveSelectedTab()ï¼Œæ‰“å¼€æ—¶è°ƒç”¨getSelectedTab()

- [ ] T021 [ä¾èµ–T019] å®ç°è”ç³»äººè®°å¿†åŠŸèƒ½
  - æ–‡ä»¶: `data/local/FloatingWindowPreferences.kt`
  - åŠŸèƒ½: é»˜è®¤é€‰ä¸­ä¸Šæ¬¡å¯¹è¯çš„è”ç³»äºº
  - é€»è¾‘: å‘é€æˆåŠŸåè°ƒç”¨saveLastContactId()ï¼Œæ‰“å¼€æ—¶è°ƒç”¨getLastContactId()

- [ ] T022 [ä¾èµ–T019] å®ç°çŠ¶æ€ä¿æŒåŠŸèƒ½
  - æ–‡ä»¶: `data/local/FloatingWindowPreferences.kt`
  - åŠŸèƒ½: æœ€å°åŒ–æ—¶ä¿å­˜å®Œæ•´çŠ¶æ€ï¼Œå…³é—­æ—¶æ¸…ç©º
  - é€»è¾‘: æœ€å°åŒ–â†’saveState()ï¼Œæ¢å¤â†’restoreState()ï¼Œå…³é—­â†’clearSavedState()

### 2.3 é˜¶æ®µ2å•å…ƒæµ‹è¯•

- [ ] T023 [ä¾èµ–T019] åˆ›å»ºFloatingWindowPreferencesExtTest
  - æ–‡ä»¶: `test/data/local/FloatingWindowPreferencesExtTest.kt`
  - æµ‹è¯•: Tabè®°å¿†ä¿å­˜/æ¢å¤
  - æµ‹è¯•: è”ç³»äººIDä¿å­˜/æ¢å¤
  - æµ‹è¯•: å®Œæ•´çŠ¶æ€ä¿å­˜/æ¢å¤/æ¸…é™¤
  - æµ‹è¯•: hasSavedState()æ­£ç¡®åæ˜ çŠ¶æ€

- [ ] T024 [ä¾èµ–T005] åˆ›å»ºFloatingWindowStateTest
  - æ–‡ä»¶: `test/domain/model/FloatingWindowStateTest.kt`
  - æµ‹è¯•: hasResult()ã€canSubmit()ã€clearResult()æ–¹æ³•

**éªŒæ”¶æ ‡å‡†**:
- [ ] Tabåˆ‡æ¢åé‡æ–°æ‰“å¼€æ‚¬æµ®çª—ï¼Œé»˜è®¤é€‰ä¸­ä¸Šæ¬¡çš„Tab
- [ ] å‘é€æˆåŠŸåé‡æ–°æ‰“å¼€æ‚¬æµ®çª—ï¼Œé»˜è®¤é€‰ä¸­ä¸Šæ¬¡çš„è”ç³»äºº
- [ ] æœ€å°åŒ–åæ¢å¤ï¼Œè¾“å…¥å†…å®¹ã€è”ç³»äººã€Tabéƒ½ä¿æŒä¸å˜
- [ ] å…³é—­åé‡æ–°æ‰“å¼€ï¼ŒçŠ¶æ€å·²æ¸…ç©ºï¼ˆé™¤Tabå’Œè”ç³»äººè®°å¿†å¤–ï¼‰
- [ ] é˜¶æ®µ2å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡

---

## é˜¶æ®µ3: UIé‡æ„ï¼ˆ3å¤©ï¼‰

**ç›®æ ‡**: é‡æ„æ‚¬æµ®çª—UIï¼Œå®ç°ä¸‰Tabåˆ‡æ¢ã€ç»“æœå±•ç¤ºã€å¾®è°ƒå¯¹è¯æ¡†

**é‡Œç¨‹ç¢‘**: M3 - UIå®Œæˆï¼Œä¸‰Tabåˆ‡æ¢ã€ç»“æœå±•ç¤ºã€å¾®è°ƒåŠŸèƒ½å¯ç”¨

### 3.1 å¸ƒå±€æ–‡ä»¶

- [ ] T025 [P] åˆ›å»ºTabåˆ‡æ¢å¸ƒå±€
  - æ–‡ä»¶: `res/layout/floating_tab_switcher.xml`
  - å†…å®¹: TabLayoutåŒ…å«ä¸‰ä¸ªTabï¼ˆåˆ†æ/æ¶¦è‰²/å›å¤ï¼‰
  - æ ·å¼: Material Design 3é£æ ¼

- [ ] T026 [P] åˆ›å»ºç»“æœå¡ç‰‡å¸ƒå±€
  - æ–‡ä»¶: `res/layout/floating_result_card.xml`
  - å†…å®¹: æ ‡é¢˜ã€å†…å®¹æ–‡æœ¬ã€å¤åˆ¶æŒ‰é’®ã€é‡æ–°ç”ŸæˆæŒ‰é’®
  - æ ·å¼: æ”¯æŒä¸åŒé£é™©ç­‰çº§çš„èƒŒæ™¯è‰²

- [ ] T027 [P] åˆ›å»ºå¾®è°ƒè¦†ç›–å±‚å¸ƒå±€
  - æ–‡ä»¶: `res/layout/overlay_refinement.xml`
  - å†…å®¹: åŠé€æ˜èƒŒæ™¯ã€å¯¹è¯æ¡†å¡ç‰‡ã€è¾“å…¥æ¡†ã€ä¸¤ä¸ªæŒ‰é’®
  - æ³¨æ„: ä½¿ç”¨FrameLayoutæ¨¡æ‹ŸDialogï¼Œé¿å…BadTokenException

- [ ] T028 [P] åˆ›å»ºTabå†…å®¹å¸ƒå±€ï¼ˆåˆ†æï¼‰
  - æ–‡ä»¶: `res/layout/floating_tab_analyze.xml`
  - å†…å®¹: è¾“å…¥æ¡†ã€è”ç³»äººé€‰æ‹©å™¨ã€å‘é€æŒ‰é’®

- [ ] T029 [P] åˆ›å»ºTabå†…å®¹å¸ƒå±€ï¼ˆæ¶¦è‰²ï¼‰
  - æ–‡ä»¶: `res/layout/floating_tab_polish.xml`
  - å†…å®¹: è¾“å…¥æ¡†ã€è”ç³»äººé€‰æ‹©å™¨ã€å‘é€æŒ‰é’®

- [ ] T030 [P] åˆ›å»ºTabå†…å®¹å¸ƒå±€ï¼ˆå›å¤ï¼‰
  - æ–‡ä»¶: `res/layout/floating_tab_reply.xml`
  - å†…å®¹: è¾“å…¥æ¡†ã€è”ç³»äººé€‰æ‹©å™¨ã€å‘é€æŒ‰é’®

### 3.2 UIç»„ä»¶

- [ ] T031 [ä¾èµ–T001,T025] åˆ›å»ºTabSwitcherç»„ä»¶
  - æ–‡ä»¶: `presentation/ui/floating/TabSwitcher.kt`
  - åŠŸèƒ½: ä¸‰Tabåˆ‡æ¢ï¼Œé¢„åŠ è½½æ‰€æœ‰Tabå†…å®¹
  - ä¼˜åŒ–: ä½¿ç”¨GONE/VISIBLEåˆ‡æ¢ï¼Œé¿å…é‡å¤inflate
  - å›è°ƒ: onTabSelected

- [ ] T032 [ä¾èµ–T004,T026] åˆ›å»ºResultCardç»„ä»¶
  - æ–‡ä»¶: `presentation/ui/floating/ResultCard.kt`
  - åŠŸèƒ½: å±•ç¤ºAIè¿”å›ç»“æœ
  - æ–¹æ³•: showAnalysisResult()ã€showPolishResult()ã€showReplyResult()
  - å›è°ƒ: onCopyClickã€onRegenerateClick

- [ ] T033 [ä¾èµ–T027] åˆ›å»ºRefinementOverlayç»„ä»¶
  - æ–‡ä»¶: `presentation/ui/floating/RefinementOverlay.kt`
  - åŠŸèƒ½: å¾®è°ƒå¯¹è¯æ¡†ï¼ˆä½¿ç”¨WindowManagerè¦†ç›–å±‚å®ç°ï¼‰
  - æ–¹æ³•: show()ã€dismiss()ã€isShowing()
  - å›è°ƒ: onDirectRegenerateã€onRegenerateWithInstructionã€onDismiss
  - æ³¨æ„: ä¸ä½¿ç”¨AlertDialogï¼Œé¿å…Serviceç¯å¢ƒä¸‹çš„BadTokenException

### 3.3 FloatingViewé‡æ„

- [ ] T034 [ä¾èµ–T031,T032,T033] é‡æ„FloatingViewé›†æˆTab
  - æ–‡ä»¶: `domain/util/FloatingView.kt`
  - ä¿®æ”¹: æ·»åŠ TabSwitcherã€ResultCardç»„ä»¶
  - ä¿®æ”¹: æ›´æ–°å¸ƒå±€ç»“æ„æ”¯æŒä¸‰Tab
  - æ·»åŠ : restoreState()æ–¹æ³•æ¢å¤çŠ¶æ€
  - æ·»åŠ : showResult()ã€showError()ã€showLoading()æ–¹æ³•

### 3.4 FloatingWindowServiceé‡æ„

- [ ] T035 [ä¾èµ–T012,T013,T014,T019,T034] é‡æ„FloatingWindowService
  - æ–‡ä»¶: `domain/service/FloatingWindowService.kt`
  - æ³¨å…¥: PolishDraftUseCaseã€GenerateReplyUseCaseã€RefinementUseCase
  - æ·»åŠ : currentStateçŠ¶æ€ç®¡ç†
  - æ·»åŠ : handleSubmit()å¤„ç†å‘é€è¯·æ±‚
  - æ·»åŠ : handleRegenerate()å¤„ç†é‡æ–°ç”Ÿæˆ
  - æ·»åŠ : handleMinimize()ã€handleRestore()ã€handleClose()çŠ¶æ€ç®¡ç†
  - æ·»åŠ : handleTabChange()å¤„ç†Tabåˆ‡æ¢
  - æ·»åŠ : showRefinementDialog()æ˜¾ç¤ºå¾®è°ƒå¯¹è¯æ¡†

- [ ] T036 [ä¾èµ–T035] å®ç°é”™è¯¯å¤„ç†å’Œæ˜ å°„
  - æ–‡ä»¶: `domain/service/FloatingWindowService.kt`
  - æ·»åŠ : mapToFloatingWindowError()é”™è¯¯æ˜ å°„
  - æ·»åŠ : showError()æ˜¾ç¤ºé”™è¯¯æç¤º
  - åŠŸèƒ½: æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæç¤ºï¼Œæ”¯æŒé‡è¯•

**éªŒæ”¶æ ‡å‡†**:
- [ ] ä¸‰ä¸ªTabå¯æ­£å¸¸åˆ‡æ¢ï¼Œåˆ‡æ¢æ—¶å†…å®¹åŒºåŸŸæ­£ç¡®æ˜¾ç¤º
- [ ] è¾“å…¥å†…å®¹åç‚¹å‡»å‘é€ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
- [ ] AIè¿”å›åæ­£ç¡®æ˜¾ç¤ºç»“æœå¡ç‰‡
- [ ] ç‚¹å‡»å¤åˆ¶æŒ‰é’®å¯å¤åˆ¶ç»“æœåˆ°å‰ªè´´æ¿
- [ ] ç‚¹å‡»é‡æ–°ç”ŸæˆæŒ‰é’®å¼¹å‡ºå¾®è°ƒå¯¹è¯æ¡†
- [ ] å¾®è°ƒå¯¹è¯æ¡†æ”¯æŒç›´æ¥é‡æ–°ç”Ÿæˆå’ŒæŒ‰æ–¹å‘ç”Ÿæˆ
- [ ] é”™è¯¯æƒ…å†µä¸‹æ˜¾ç¤ºå‹å¥½æç¤º

---


## é˜¶æ®µ4: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ2å¤©ï¼‰

**ç›®æ ‡**: å®Œæˆå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½ä¼˜åŒ–

**é‡Œç¨‹ç¢‘**: M4 - æµ‹è¯•å®Œæˆï¼Œæµ‹è¯•è¦†ç›–ç‡â‰¥90%ï¼Œæ— P0 Bug

### 4.1 UseCaseå•å…ƒæµ‹è¯•

- [ ] T037 [ä¾èµ–T012] åˆ›å»ºPolishDraftUseCaseTest
  - æ–‡ä»¶: `test/domain/usecase/PolishDraftUseCaseTest.kt`
  - æµ‹è¯•: æ¶¦è‰²æˆåŠŸè¿”å›PolishResult
  - æµ‹è¯•: æ£€æµ‹åˆ°é£é™©æ—¶è¿”å›é£é™©æç¤º
  - æµ‹è¯•: æœªé…ç½®AIæœåŠ¡å•†æ—¶è¿”å›é”™è¯¯
  - æµ‹è¯•: è”ç³»äººä¸å­˜åœ¨æ—¶è¿”å›é”™è¯¯
  - æµ‹è¯•: æ•°æ®è„±æ•æ­£ç¡®æ‰§è¡Œ
  - æµ‹è¯•: èº«ä»½å‰ç¼€æ­£ç¡®æ·»åŠ 

- [ ] T038 [ä¾èµ–T013] åˆ›å»ºGenerateReplyUseCaseTest
  - æ–‡ä»¶: `test/domain/usecase/GenerateReplyUseCaseTest.kt`
  - æµ‹è¯•: ç”Ÿæˆå›å¤æˆåŠŸè¿”å›ReplyResult
  - æµ‹è¯•: ç­–ç•¥è¯´æ˜æ­£ç¡®è¿”å›
  - æµ‹è¯•: æœªé…ç½®AIæœåŠ¡å•†æ—¶è¿”å›é”™è¯¯
  - æµ‹è¯•: è”ç³»äººä¸å­˜åœ¨æ—¶è¿”å›é”™è¯¯
  - æµ‹è¯•: å¯¹è¯è®°å½•æ­£ç¡®ä¿å­˜
  - æµ‹è¯•: é›·åŒºæ ‡ç­¾å’Œç­–ç•¥æ ‡ç­¾æ­£ç¡®ä¼ é€’

- [ ] T039 [ä¾èµ–T014] åˆ›å»ºRefinementUseCaseTest
  - æ–‡ä»¶: `test/domain/usecase/RefinementUseCaseTest.kt`
  - æµ‹è¯•: æ— å¾®è°ƒæŒ‡ä»¤æ—¶ç›´æ¥é‡æ–°ç”Ÿæˆ
  - æµ‹è¯•: æœ‰å¾®è°ƒæŒ‡ä»¤æ—¶ä½¿ç”¨å¾®è°ƒæç¤ºè¯
  - æµ‹è¯•: åˆ†æä»»åŠ¡çš„å¾®è°ƒæ­£ç¡®è°ƒç”¨refineAnalysis
  - æµ‹è¯•: æ¶¦è‰²ä»»åŠ¡çš„å¾®è°ƒæ­£ç¡®è°ƒç”¨refinePolish
  - æµ‹è¯•: å›å¤ä»»åŠ¡çš„å¾®è°ƒæ­£ç¡®è°ƒç”¨refineReply
  - æµ‹è¯•: å¾®è°ƒæç¤ºè¯æ­£ç¡®æ„å»º

### 4.2 Repositoryå•å…ƒæµ‹è¯•

- [ ] T040 [ä¾èµ–T011] åˆ›å»ºAiRepositoryImplExtTest
  - æ–‡ä»¶: `test/data/repository/AiRepositoryImplExtTest.kt`
  - æµ‹è¯•: polishDraft()æ­£ç¡®è°ƒç”¨AIå¹¶è§£æç»“æœ
  - æµ‹è¯•: generateReply()æ­£ç¡®è°ƒç”¨AIå¹¶è§£æç»“æœ
  - æµ‹è¯•: refineAnalysis()æ­£ç¡®æ„å»ºæç¤ºè¯
  - æµ‹è¯•: refinePolish()æ­£ç¡®æ„å»ºæç¤ºè¯
  - æµ‹è¯•: refineReply()æ­£ç¡®æ„å»ºæç¤ºè¯
  - æµ‹è¯•: è¶…æ—¶é…ç½®æ­£ç¡®ç”Ÿæ•ˆ
  - æµ‹è¯•: JSONè§£æå¤±è´¥æ—¶è¿”å›é”™è¯¯

### 4.3 é›†æˆæµ‹è¯•

- [ ] T041 [ä¾èµ–é˜¶æ®µ3] åˆ›å»ºFloatingWindowIntegrationTest
  - æ–‡ä»¶: `androidTest/presentation/ui/floating/FloatingWindowIntegrationTest.kt`
  - æµ‹è¯•: å®Œæ•´æµç¨‹_æ¶¦è‰²åå¾®è°ƒ
  - æµ‹è¯•: å®Œæ•´æµç¨‹_å›å¤åå¾®è°ƒ
  - æµ‹è¯•: çŠ¶æ€ä¿æŒæµç¨‹_æœ€å°åŒ–æ¢å¤
  - æµ‹è¯•: Tabåˆ‡æ¢ä¸ä¸¢å¤±è¾“å…¥å†…å®¹
  - æµ‹è¯•: è”ç³»äººåˆ‡æ¢æ­£ç¡®æ›´æ–°çŠ¶æ€

- [ ] T042 [ä¾èµ–T031] åˆ›å»ºTabSwitcherTest
  - æ–‡ä»¶: `androidTest/presentation/ui/floating/TabSwitcherTest.kt`
  - æµ‹è¯•: Tabåˆ‡æ¢æ­£ç¡®è§¦å‘å›è°ƒ
  - æµ‹è¯•: setSelectedTab()æ­£ç¡®æ›´æ–°UI
  - æµ‹è¯•: é¢„åŠ è½½çš„Viewæ­£ç¡®æ˜¾ç¤º/éšè—

### 4.4 æ€§èƒ½ä¼˜åŒ–

- [ ] T043 [ä¾èµ–é˜¶æ®µ3] æ€§èƒ½ä¼˜åŒ–_Tabåˆ‡æ¢
  - æ–‡ä»¶: `presentation/ui/floating/TabSwitcher.kt`
  - ä¼˜åŒ–: ç¡®ä¿Tabåˆ‡æ¢å“åº”<50ms
  - éªŒè¯: ä½¿ç”¨Systraceæˆ–ProfileréªŒè¯

- [ ] T044 [ä¾èµ–é˜¶æ®µ2] æ€§èƒ½ä¼˜åŒ–_çŠ¶æ€ä¿å­˜
  - æ–‡ä»¶: `data/local/FloatingWindowPreferences.kt`
  - ä¼˜åŒ–: ç¡®ä¿çŠ¶æ€ä¿å­˜<100ms
  - éªŒè¯: ä½¿ç”¨apply()å¼‚æ­¥å†™å…¥

- [ ] T045 [ä¾èµ–T011] æ€§èƒ½ä¼˜åŒ–_AIè°ƒç”¨
  - æ–‡ä»¶: `data/repository/AiRepositoryImpl.kt`
  - ä¼˜åŒ–: è¶…æ—¶æ—¶é—´å¯é…ç½®ï¼ˆé»˜è®¤45ç§’ï¼‰
  - æ·»åŠ : SettingsRepositoryè¯»å–è¶…æ—¶é…ç½®
  - æ·»åŠ : ç½‘ç»œè¶…æ—¶è‡ªåŠ¨é‡è¯•ç­–ç•¥ï¼ˆNetworkTimeoutæ—¶è‡ªåŠ¨é‡è¯•1æ¬¡ï¼‰
  - é…ç½®: RetryConfigï¼ˆmaxRetries=1, retryableErrors=[NetworkTimeout]ï¼‰
  - æ³¨æ„: ä»…å¯¹NetworkTimeoutç±»å‹é”™è¯¯è‡ªåŠ¨é‡è¯•ï¼Œå…¶ä»–é”™è¯¯ç›´æ¥è¿”å›è®©UIå±‚å¤„ç†

### 4.5 Bugä¿®å¤é¢„ç•™

- [ ] T046 [ä¾èµ–é˜¶æ®µ3] Bugä¿®å¤é¢„ç•™
  - é¢„ç•™æ—¶é—´: 4å°æ—¶
  - ç”¨é€”: ä¿®å¤é›†æˆæµ‹è¯•å‘ç°çš„é—®é¢˜
  - èŒƒå›´: P0å’ŒP1çº§åˆ«Bug

**éªŒæ”¶æ ‡å‡†**:
- [ ] UseCaseå•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥90%
- [ ] Repositoryå•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥90%
- [ ] é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] Tabåˆ‡æ¢å“åº”<50ms
- [ ] çŠ¶æ€ä¿å­˜<100ms
- [ ] æ— P0çº§åˆ«Bug

---

## é£é™©ä¸ç¼“è§£æªæ–½

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| AIå“åº”æ ¼å¼ä¸ç¨³å®š | ä¸­ | ä¸­ | ä½¿ç”¨AiResponseCleanerï¼Œæ·»åŠ é™çº§å¤„ç† |
| çŠ¶æ€ä¿æŒå¯¼è‡´å†…å­˜æ³„æ¼ | ä¸­ | ä½ | ä½¿ç”¨WeakReferenceï¼ŒåŠæ—¶æ¸…ç† |
| Tabåˆ‡æ¢å½±å“ç°æœ‰é€»è¾‘ | ä¸­ | ä¸­ | ä¿æŒå‘åå…¼å®¹ï¼Œæ¸è¿›å¼é‡æ„ |
| å¾®è°ƒåŠŸèƒ½å¢åŠ APIæˆæœ¬ | ä½ | ä¸­ | é™åˆ¶å¾®è°ƒæ¬¡æ•°ï¼Œæç¤ºç”¨æˆ· |
| FloatingViewé‡æ„å¤æ‚åº¦é«˜ | é«˜ | ä¸­ | åˆ†æ­¥é‡æ„ï¼Œä¿æŒå¯å›æ»š |
| RefinementDialogåœ¨Serviceç¯å¢ƒæŠ¥é”™ | é«˜ | é«˜ | ä½¿ç”¨WindowManagerè¦†ç›–å±‚æ–¹æ¡ˆ |

---

## ä¾èµ–å…³ç³»å›¾

```
é˜¶æ®µ1: åç«¯é‡æ„
â”œâ”€â”€ T001-T007 [P] æ•°æ®æ¨¡å‹ï¼ˆå¯å¹¶è¡Œï¼‰
â”œâ”€â”€ T008 â†’ T009 æç¤ºè¯æ‰©å±•
â”œâ”€â”€ T002,T003 â†’ T010 â†’ T011 Repositoryæ‰©å±•
â”œâ”€â”€ T002,T009,T010 â†’ T012 PolishDraftUseCase
â”œâ”€â”€ T003,T009,T010 â†’ T013 GenerateReplyUseCase
â”œâ”€â”€ T004,T006,T012,T013 â†’ T014 RefinementUseCase
â””â”€â”€ T012,T013,T014 â†’ T015 ä¾èµ–æ³¨å…¥

é˜¶æ®µ2: çŠ¶æ€ç®¡ç†
â”œâ”€â”€ T001,T005 â†’ T019 FloatingWindowPreferencesæ‰©å±•
â””â”€â”€ T019 â†’ T020,T021,T022 çŠ¶æ€ç®¡ç†é€»è¾‘

é˜¶æ®µ3: UIé‡æ„
â”œâ”€â”€ T025-T030 [P] å¸ƒå±€æ–‡ä»¶ï¼ˆå¯å¹¶è¡Œï¼‰
â”œâ”€â”€ T001,T025 â†’ T031 TabSwitcher
â”œâ”€â”€ T004,T026 â†’ T032 ResultCard
â”œâ”€â”€ T027 â†’ T033 RefinementOverlay
â”œâ”€â”€ T031,T032,T033 â†’ T034 FloatingViewé‡æ„
â””â”€â”€ T012,T013,T014,T019,T034 â†’ T035,T036 FloatingWindowServiceé‡æ„

é˜¶æ®µ4: æµ‹è¯•ä¸ä¼˜åŒ–
â”œâ”€â”€ T012 â†’ T037 PolishDraftUseCaseTest
â”œâ”€â”€ T013 â†’ T038 GenerateReplyUseCaseTest
â”œâ”€â”€ T014 â†’ T039 RefinementUseCaseTest
â”œâ”€â”€ T011 â†’ T040 AiRepositoryImplExtTest
â””â”€â”€ é˜¶æ®µ3 â†’ T041-T046 é›†æˆæµ‹è¯•å’Œä¼˜åŒ–
```

---

## é™„å½•

### A. ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [PRD-00009](../PRD/PRD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„éœ€æ±‚.md) | éœ€æ±‚æ–‡æ¡£ |
| [FD-00009](../FD/FD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„åŠŸèƒ½è®¾è®¡.md) | åŠŸèƒ½è®¾è®¡æ–‡æ¡£ |
| [TDD-00009](../TDD/TDD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„æŠ€æœ¯è®¾è®¡.md) | æŠ€æœ¯è®¾è®¡æ–‡æ¡£ |
| [PRD-00001](../PRD/PRD-00001-æ‚¬æµ®çª—åŠŸèƒ½éœ€æ±‚.md) | åŸæ‚¬æµ®çª—éœ€æ±‚ |

### B. æµ‹è¯•è¦†ç›–ç‡æ ‡å‡†

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | é‡ç‚¹æµ‹è¯•é¡¹ |
|------|-----------|-----------|
| PolishDraftUseCase | â‰¥90% | æ­£å¸¸æµç¨‹ã€é£é™©æ£€æµ‹ã€é”™è¯¯å¤„ç† |
| GenerateReplyUseCase | â‰¥90% | æ­£å¸¸æµç¨‹ã€æ ‡ç­¾é›†æˆã€é”™è¯¯å¤„ç† |
| RefinementUseCase | â‰¥90% | æœ‰/æ— æŒ‡ä»¤åˆ†æ”¯ã€å„ä»»åŠ¡ç±»å‹ |
| FloatingWindowPreferences | â‰¥95% | çŠ¶æ€ä¿å­˜/æ¢å¤/æ¸…é™¤ |
| AiResult | 100% | getCopyableTextã€getDisplayContent |

### C. éªŒæ”¶æ£€æŸ¥æ¸…å•

#### åŠŸèƒ½éªŒæ”¶
- [ ] ä¸‰ä¸ªTabï¼ˆåˆ†æ/æ¶¦è‰²/å›å¤ï¼‰å¯æ­£å¸¸åˆ‡æ¢
- [ ] è¾“å…¥å†…å®¹åå¯æ­£ç¡®å‘é€è¯·æ±‚
- [ ] AIè¿”å›ç»“æœæ­£ç¡®æ˜¾ç¤º
- [ ] å¤åˆ¶åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] å¾®è°ƒé‡æ–°ç”ŸæˆåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] Tabè®°å¿†åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] è”ç³»äººè®°å¿†åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] æœ€å°åŒ–çŠ¶æ€ä¿æŒåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] å…³é—­æ—¶çŠ¶æ€æ­£ç¡®æ¸…ç©º

#### æ€§èƒ½éªŒæ”¶
- [ ] Tabåˆ‡æ¢å“åº”<50ms
- [ ] çŠ¶æ€ä¿å­˜<100ms
- [ ] çŠ¶æ€æ¢å¤<100ms
- [ ] AIè°ƒç”¨è¶…æ—¶å¯é…ç½®

#### è´¨é‡éªŒæ”¶
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥90%
- [ ] æ— P0çº§åˆ«Bug
- [ ] ä»£ç é€šè¿‡Lintæ£€æŸ¥
- [ ] æ— å†…å­˜æ³„æ¼

### D. å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| 2025-12-17 | 1.0 | åˆå§‹ç‰ˆæœ¬ | Kiro |
