# TD-00010: 悬浮球状态指示与拖动任务清单

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | TD (Task Document) |
| 文档编号 | TD-00010 |
| 功能名称 | 悬浮球状态指示与拖动功能 |
| 版本 | 1.0 |
| 创建日期 | 2025-12-18 |
| 作者 | Kiro |
| 关联文档 | PRD-00010, FD-00010, TDD-00010 |

---

## 2. 任务概览

| 阶段 | 任务数 | 预计工时 | 状态 |
|------|--------|----------|------|
| 阶段一：数据模型与持久化 | 5 | 0.5天 | ✅ 已完成 |
| 阶段二：悬浮球视图实现 | 6 | 1天 | ✅ 已完成 |
| 阶段三：状态管理与集成 | 6 | 1天 | ✅ 已完成 |
| 阶段四：通知系统 | 4 | 0.5天 | ✅ 已完成 |
| 阶段五：测试与优化 | 5 | 1天 | 🔄 进行中 (1/5) |
| **总计** | **26** | **4天** | **23/26 完成** |

---

## 3. 阶段一：数据模型与持久化（0.5天）

### 任务 1.1：创建 FloatingBubbleState 枚举
- **文件**：`domain/model/FloatingBubbleState.kt`
- **内容**：
  - 定义四种状态：IDLE, LOADING, SUCCESS, ERROR
  - 添加状态描述和图标资源ID
- **验收标准**：
  - [x] 枚举定义完整
  - [x] 单元测试通过
- **状态**：✅ 已完成

### 任务 1.2：创建 FloatingBubblePosition 数据类
- **文件**：`domain/model/FloatingBubblePosition.kt`
- **内容**：
  - 定义 x, y 坐标属性
  - 添加 default() 工厂方法
- **验收标准**：
  - [x] 数据类定义完整
  - [x] 默认位置计算正确
- **状态**：✅ 已完成


### 任务 1.3：扩展 FloatingWindowPreferences
- **文件**：`data/local/FloatingWindowPreferences.kt`
- **内容**：
  - 新增 `saveBubblePosition(x, y)` 方法
  - 新增 `getBubblePosition()` 方法
  - 新增 `saveBubbleState()` 方法
  - 新增 `saveMinimizeState()` / `getMinimizeStateIfValid()` 方法
  - 新增 `clearMinimizeState()` 方法
- **验收标准**：
  - [x] 位置保存和读取正确
  - [x] 最小化状态10分钟有效期逻辑正确
  - [x] 单元测试通过
- **状态**：✅ 已完成

### 任务 1.4：编写数据模型单元测试
- **文件**：`test/.../FloatingBubbleStateTest.kt`, `test/.../FloatingBubblePositionTest.kt`
- **内容**：
  - 测试枚举值
  - 测试默认位置计算
- **验收标准**：
  - [x] 测试覆盖率 > 90%
- **状态**：✅ 已完成

### 任务 1.5：编写 Preferences 扩展单元测试
- **文件**：`test/.../FloatingWindowPreferencesBubbleTest.kt`
- **内容**：
  - 测试位置保存/读取
  - 测试状态保存/读取
  - 测试最小化状态有效期
- **验收标准**：
  - [x] 测试覆盖率 > 90%
- **状态**：✅ 已完成

---

## 4. 阶段二：悬浮球视图实现（1天）

### 任务 2.1：创建 FloatingBubbleView 基础结构
- **文件**：`presentation/ui/floating/FloatingBubbleView.kt`
- **内容**：
  - 继承 FrameLayout
  - 初始化视图组件（ImageView, ProgressIndicator）
  - 设置悬浮球尺寸（56dp）和样式
- **验收标准**：
  - [x] 视图正确显示
  - [x] 尺寸符合设计规范
- **状态**：✅ 已完成

### 任务 2.2：实现拖动功能
- **文件**：`presentation/ui/floating/FloatingBubbleView.kt`
- **内容**：
  - 实现 OnTouchListener
  - 区分点击和拖动（10dp阈值，200ms时长）
  - 实现边界保护（至少50%在屏幕内）
  - 拖动结束时回调位置变化
- **验收标准**：
  - [x] 拖动流畅（≥55FPS）
  - [x] 点击和拖动正确区分
  - [x] 边界保护生效
- **状态**：✅ 已完成

### 任务 2.3：实现 IDLE 状态显示
- **文件**：`presentation/ui/floating/FloatingBubbleView.kt`
- **内容**：
  - 显示静态 App Logo
  - 白色背景
- **验收标准**：
  - [x] 图标正确显示
  - [x] 样式符合设计
- **状态**：✅ 已完成

### 任务 2.4：实现 LOADING 状态显示
- **文件**：`presentation/ui/floating/FloatingBubbleView.kt`
- **内容**：
  - 显示 CircularProgressIndicator
  - 旋转动画（1000ms/圈）
- **验收标准**：
  - [x] 进度指示器正确显示
  - [x] 动画流畅
- **状态**：✅ 已完成

### 任务 2.5：实现 SUCCESS 状态显示
- **文件**：`presentation/ui/floating/FloatingBubbleView.kt`
- **内容**：
  - 显示绿色勾图标
  - 绿色背景（#E8F5E9）
  - 弹跳动画（300ms, OvershootInterpolator）
- **验收标准**：
  - [x] 图标和颜色正确
  - [x] 弹跳动画流畅
- **状态**：✅ 已完成

### 任务 2.6：实现 ERROR 状态显示
- **文件**：`presentation/ui/floating/FloatingBubbleView.kt`
- **内容**：
  - 显示红色叹号图标
  - 红色背景（#FFEBEE）
- **验收标准**：
  - [x] 图标和颜色正确
- **状态**：✅ 已完成

---

## 5. 阶段三：状态管理与集成（1天）

### 任务 3.1：在 FloatingWindowService 中添加悬浮球管理
- **文件**：`domain/service/FloatingWindowService.kt`
- **内容**：
  - 添加 `floatingBubbleView` 成员变量
  - 实现 `showFloatingBubble(state)` 方法
  - 实现 `hideFloatingBubble()` 方法
  - 恢复保存的位置
- **验收标准**：
  - [x] 悬浮球正确显示/隐藏
  - [x] 位置正确恢复
- **状态**：✅ 已完成

### 任务 3.2：实现最小化逻辑（关键）
- **文件**：`domain/service/FloatingWindowService.kt`
- **内容**：
  - 实现 `minimizeToFloatingBubble()` 方法
  - **关键**：根据 `hasActiveAiRequest` 决定状态
    - 无请求 → IDLE
    - 有请求 → LOADING
  - 保存最小化状态（如果有请求）
- **验收标准**：
  - [x] 无请求时显示 IDLE
  - [x] 有请求时显示 LOADING
  - [x] 状态正确保存
- **⚠️ 注意**：参考 TDD-00010 第3章历史踩坑记录
- **状态**：✅ 已完成

### 任务 3.3：实现展开逻辑
- **文件**：`domain/service/FloatingWindowService.kt`
- **内容**：
  - 实现 `expandFromBubble()` 方法
  - 隐藏悬浮球，显示悬浮窗
  - 如果有结果，显示结果
  - 重置悬浮球状态为 IDLE
- **验收标准**：
  - [x] 展开后悬浮窗正确显示
  - [x] 结果正确显示
  - [x] 状态正确重置
- **状态**：✅ 已完成

### 任务 3.4：实现 AI 请求状态回调
- **文件**：`domain/service/FloatingWindowService.kt`
- **内容**：
  - 实现 `onAiRequestStarted()` 方法
    - 设置 `hasActiveAiRequest = true`
    - 更新悬浮球为 LOADING（如果已最小化）
  - 实现 `onAiRequestCompleted(result)` 方法
    - 设置 `hasActiveAiRequest = false`
    - 更新悬浮球为 SUCCESS
  - 实现 `onAiRequestFailed(error)` 方法
    - 设置 `hasActiveAiRequest = false`
    - 更新悬浮球为 ERROR
- **验收标准**：
  - [x] 状态转换正确
  - [x] **关键**：只有真正调用 AI API 时才触发 LOADING
- **状态**：✅ 已完成

### 任务 3.5：集成到现有 AI 调用流程
- **文件**：`domain/service/FloatingWindowService.kt`
- **内容**：
  - 在调用 `analyzeChatUseCase` 前调用 `onAiRequestStarted()`
  - 在调用 `polishDraftUseCase` 前调用 `onAiRequestStarted()`
  - 在调用 `generateReplyUseCase` 前调用 `onAiRequestStarted()`
  - 在结果回调中调用 `onAiRequestCompleted()` 或 `onAiRequestFailed()`
- **验收标准**：
  - [x] 三种功能都正确触发状态变化
- **状态**：✅ 已完成

### 任务 3.6：实现应用重启恢复
- **文件**：`domain/service/FloatingWindowService.kt`
- **内容**：
  - 在 `onCreate()` 中检查是否有保存的最小化状态
  - 如果有且未过期（10分钟内），恢复 LOADING 状态
  - 如果已过期，清除状态，显示 IDLE
- **验收标准**：
  - [x] 重启后正确恢复状态
  - [x] 过期状态正确清除
- **状态**：✅ 已完成

---

## 6. 阶段四：通知系统（0.5天）

### 任务 4.1：创建 AiResultNotificationManager
- **文件**：`notification/AiResultNotificationManager.kt`
- **内容**：
  - 创建通知渠道 `empathy_ai_result`
  - 实现 `notifySuccess(taskType)` 方法
  - 实现 `notifyError(errorMessage)` 方法
  - 实现 `cancelNotification()` 方法
- **验收标准**：
  - [x] 通知渠道正确创建
  - [x] 通知内容正确
- **状态**：✅ 已完成

### 任务 4.2：实现通知点击跳转
- **文件**：`notification/AiResultNotificationManager.kt`
- **内容**：
  - 创建 PendingIntent 指向 FloatingWindowService
  - 添加 ACTION_EXPAND_FROM_NOTIFICATION 常量
  - 在 Service 中处理该 Action
- **验收标准**：
  - [x] 点击通知正确展开悬浮窗
- **状态**：✅ 已完成

### 任务 4.3：集成通知到状态回调
- **文件**：`domain/service/FloatingWindowService.kt`
- **内容**：
  - 在 `onAiRequestCompleted()` 中发送成功通知（仅最小化状态）
  - 在 `onAiRequestFailed()` 中发送失败通知（仅最小化状态）
- **验收标准**：
  - [x] 最小化状态下收到通知
  - [x] 展开状态下不发送通知
- **状态**：✅ 已完成

### 任务 4.4：添加 Hilt 依赖注入
- **文件**：`di/FloatingWindowModule.kt`
- **内容**：
  - 提供 AiResultNotificationManager 单例（通过 @Singleton 注解自动注入）
- **验收标准**：
  - [x] 依赖注入正确配置
- **状态**：✅ 已完成

---

## 7. 阶段五：测试与优化（1天）

### 任务 5.1：编写 FloatingBubbleView 单元测试
- **文件**：`test/.../FloatingBubbleViewTest.kt`
- **内容**：
  - 测试状态切换
  - 测试边界计算
  - 测试点击/拖动判定逻辑
- **验收标准**：
  - [x] 测试覆盖率 > 80%
- **状态**：✅ 已完成
- **备注**：JVM 单元测试，UI 交互测试需要 Android 环境

### 任务 5.2：编写状态管理集成测试
- **文件**：`androidTest/.../FloatingBubbleIntegrationTest.kt`
- **内容**：
  - 测试无请求时最小化 → IDLE
  - 测试有请求时最小化 → LOADING
  - 测试 AI 成功 → SUCCESS + 通知
  - 测试 AI 失败 → ERROR + 通知
  - 测试点击悬浮球 → 展开 + IDLE
- **验收标准**：
  - [ ] 所有场景测试通过
- **状态**：⬜ 待开始
- **备注**：需要设备或模拟器运行

### 任务 5.3：编写拖动功能测试
- **文件**：`androidTest/.../FloatingBubbleDragTest.kt`
- **内容**：
  - 测试拖动位置更新
  - 测试位置保存
  - 测试边界保护
  - 测试点击识别
- **验收标准**：
  - [ ] 所有场景测试通过
- **状态**：⬜ 待开始
- **备注**：需要设备或模拟器运行

### 任务 5.4：性能优化
- **内容**：
  - 检查拖动帧率（目标 ≥55FPS）
  - 检查动画流畅度
  - 检查内存占用（目标 <1MB 增量）
- **验收标准**：
  - [ ] 性能指标达标
- **状态**：⬜ 待开始
- **备注**：需要真机测试

### 任务 5.5：边界情况测试
- **内容**：
  - 测试屏幕旋转
  - 测试分屏模式
  - 测试进程被杀后恢复
  - 测试通知权限被拒绝
- **验收标准**：
  - [ ] 所有边界情况处理正确
- **状态**：⬜ 待开始
- **备注**：需要真机测试

---

## 8. 开发注意事项

> ⚠️ **重要**：开发前务必阅读 [TDD-00010 第3章：开发注意事项](../TDD/TDD-00010-悬浮球状态指示与拖动技术设计.md#3-开发注意事项历史踩坑记录)

### 8.1 核心原则

1. **状态触发时机**：只有真正发起 AI 网络请求后，才能进入 LOADING 状态
2. **关闭 vs 最小化**：无请求时最小化 = 关闭（IDLE），有请求时最小化 = 真正最小化（LOADING）
3. **状态原子性**：状态和视图必须同步修改

### 8.2 Kotlin 陷阱

- 在 `apply/run/with` 中调用 Service 方法时，使用 `this@FloatingWindowService.method()`

### 8.3 资源清理

- 隐藏悬浮球时移除所有监听器
- 持有 TextWatcher 引用以便移除

---

## 9. 相关文档

- [PRD-00010-悬浮球状态指示与拖动功能需求](../PRD/PRD-00010-悬浮球状态指示与拖动功能需求.md)
- [FD-00010-悬浮球状态指示与拖动功能设计](../FD/FD-00010-悬浮球状态指示与拖动功能设计.md)
- [TDD-00010-悬浮球状态指示与拖动技术设计](../TDD/TDD-00010-悬浮球状态指示与拖动技术设计.md)
