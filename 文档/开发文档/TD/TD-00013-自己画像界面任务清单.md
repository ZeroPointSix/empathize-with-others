# TD-00013: 自己画像界面任务清单

---
**文档类型**: TD (Task Document) - 开发过程文档  
**存放规范**: 符合项目宪法第IV条 - 文档规范  
**版本控制**: Git管理，见.commit钩子  
---

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | TD (Task Document) |
| 文档编号 | TD-00013 |
| 功能名称 | 自己画像界面 |
| 版本 | 1.1 |
| 创建日期 | 2025-12-21 |
| 最后更新 | 2025-12-21 |
| 作者 | Kiro |
| 关联文档 | PRD-00013, FD-00013, TDD-00013, RESEARCH-00013 |

---

## 2. 任务概览

| 阶段 | 任务数 | 预计工时 | 状态 |
|------|--------|----------|------|
| 阶段一：领域模型实现 | 5 | 4h | ⬜ 待开始 |
| 阶段二：数据层实现 | 5 | 5h | ⬜ 待开始 |
| 阶段三：业务层实现 | 6 | 6h | ⬜ 待开始 |
| 阶段四：UI组件开发 | 12 | 12h | ⬜ 待开始 |
| 阶段五：ViewModel实现 | 4 | 4h | ⬜ 待开始 |
| 阶段六：AI上下文集成与性能优化 | 6 | 6h | ⬜ 待开始 |
| 阶段七：依赖注入与导航配置 | 3 | 2h | ⬜ 待开始 |
| 阶段八：单元测试 | 8 | 8h | ⬜ 待开始 |
| 阶段九：集成测试与UI测试 | 6 | 6h | ⬜ 待开始 |
| **总计** | **55** | **53h (约7天)** | **0/55 完成** |

### 2.1 已完成的集成点

以下集成点已在现有代码中实现，无需重复开发：

| 集成点 | 文件位置 | 状态 |
|--------|----------|------|
| UserProfileScreen路由 | `NavGraph.kt` | ✅ 已存在 |
| USER_PROFILE路由常量 | `NavRoutes.kt` | ✅ 已存在 |
| 设置页面入口回调 | `SettingsScreen.kt` | ✅ 已存在 |

---

## 3. 阶段一：领域模型实现（4h）

### 任务 1.1：创建 UserProfile 领域模型
- **文件**：`domain/model/UserProfile.kt`
- **内容**：
  - 定义 UserProfile data class
  - 字段：id, personalityTraits, values, interests, communicationStyle, socialPreferences, customDimensions, createdAt, updatedAt
  - 实现 isEmpty() 方法
  - 实现 getCompleteness() 方法（计算画像完整度百分比）
  - 实现 getTotalTagCount() 方法
  - 实现 getTagsForDimension() 方法
- **验收标准**：
  - [ ] 字段定义完整，默认值正确
  - [ ] isEmpty() 正确判断所有维度是否为空
  - [ ] getCompleteness() 基于5个基础维度计算百分比
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 1.2：创建 UserProfileDimension 枚举
- **文件**：`domain/model/UserProfileDimension.kt`
- **内容**：
  - 定义5个基础维度枚举值：PERSONALITY_TRAITS, VALUES, INTERESTS, COMMUNICATION_STYLE, SOCIAL_PREFERENCES
  - 每个枚举包含：displayName, description, presetTags
  - 实现 getPresetTags() 方法
  - 实现 fromKey() 静态方法
- **验收标准**：
  - [ ] 5个基础维度定义完整
  - [ ] 每个维度至少8个预设标签
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 1.3：创建 UserProfileValidationResult 密封类
- **文件**：`domain/model/UserProfileValidationResult.kt`
- **内容**：
  - 定义验证结果：Valid, TagEmpty, TagTooLong, TagDuplicate, DimensionNameEmpty, DimensionNameTooLong, DimensionNameDuplicate, TagLimitExceeded, DimensionLimitExceeded
  - 实现 isValid() 方法
  - 实现 getErrorMessage() 方法
- **验收标准**：
  - [ ] 密封类定义完整
  - [ ] 错误消息用户友好（中文）
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 1.4：创建 UserProfileValidator 验证器
- **文件**：`domain/util/UserProfileValidator.kt`
- **内容**：
  - 实现 validateTag(tag: String) 方法 - 1-50字符，不能为空
  - 实现 validateDimensionName(name: String) 方法 - 2-20字符，不能为空
  - 实现 validateTagNotDuplicate(dimension: String, tag: String, existingTags: List<String>) 方法
  - 实现 validateDimensionNotDuplicate(name: String, existingDimensions: List<String>) 方法
  - 实现 validateTagLimit(existingCount: Int) 方法 - 单维度最多20个
  - 实现 validateDimensionLimit(existingCount: Int) 方法 - 自定义维度最多10个
  - 实现 sanitizeInput(input: String) 方法 - 过滤特殊字符
- **验收标准**：
  - [ ] 所有验证方法正确
  - [ ] 特殊字符过滤：<, >, &, ', ", /, \
  - [ ] 单元测试覆盖所有边界情况
- **状态**：⬜ 待开始

### 任务 1.5：创建 ExportFormat 枚举
- **文件**：`domain/model/ExportFormat.kt`
- **内容**：
  - 定义导出格式：JSON, PLAIN_TEXT
  - 每个格式包含：displayName, fileExtension, mimeType
- **验收标准**：
  - [ ] 枚举定义完整
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

---

## 4. 阶段二：数据层实现（5h）

### 任务 2.1：创建 UserProfilePreferences 加密存储
- **文件**：`data/local/UserProfilePreferences.kt`
- **内容**：
  - 使用 EncryptedSharedPreferences 加密存储
  - 注入 Context 和 Moshi
  - 实现 saveUserProfile(profile: UserProfile): Result<Unit>
  - 实现 loadUserProfile(): Result<UserProfile>
  - 实现 clearUserProfile(): Result<Unit>
  - 实现 exportUserProfile(): Result<String>
  - 实现 importUserProfile(json: String): Result<Unit>
  - 添加完整的异常处理
- **验收标准**：
  - [ ] 使用 AES256_GCM 加密方案
  - [ ] 所有方法返回 Result 类型
  - [ ] 异常处理完整，错误消息用户友好
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 2.2：创建 UserProfileRepository 接口
- **文件**：`domain/repository/UserProfileRepository.kt`
- **内容**：
  - 定义 getUserProfile(): Result<UserProfile>
  - 定义 updateUserProfile(profile: UserProfile): Result<Unit>
  - 定义 clearUserProfile(): Result<Unit>
  - 定义 exportUserProfile(): Result<String>
  - 定义 importUserProfile(json: String): Result<Unit>
- **验收标准**：
  - [ ] 接口方法定义完整
  - [ ] 所有方法使用 suspend 修饰
  - [ ] 返回类型统一使用 Result
- **状态**：⬜ 待开始

### 任务 2.3：创建 UserProfileRepositoryImpl 实现
- **文件**：`data/repository/UserProfileRepositoryImpl.kt`
- **内容**：
  - 注入 UserProfilePreferences 和 IoDispatcher
  - 实现所有接口方法
  - 使用 withContext(ioDispatcher) 确保IO操作在后台线程
  - 添加完整的异常处理和日志记录
- **验收标准**：
  - [ ] 正确调用 UserProfilePreferences
  - [ ] IO操作在后台线程执行
  - [ ] 异常处理完整
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 2.4：创建 UserProfileCache 多级缓存
- **文件**：`data/local/UserProfileCache.kt`
- **内容**：
  - 实现多级缓存机制（L1内存缓存 + L2磁盘缓存）
  - L1缓存有效期：1分钟
  - L2缓存有效期：10分钟
  - 实现 get(): UserProfile?
  - 实现 set(profile: UserProfile)
  - 实现 invalidate()
  - 实现 isValid(): Boolean
  - 实现 cleanupExpiredCache() 定期清理
  - 实现内存压力监控，自动清理缓存
- **验收标准**：
  - [ ] 多级缓存有效期正确
  - [ ] 线程安全（使用 @Synchronized 或 Mutex）
  - [ ] 内存压力时自动清理
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 2.5：创建 UserProfileBackupManager 备份管理器
- **文件**：`data/local/UserProfileBackupManager.kt`
- **内容**：
  - 实现自动备份机制（每次修改前创建备份）
  - 最多保留5个历史版本
  - 实现 createBackup(profile: UserProfile): Result<Unit>
  - 实现 restoreFromBackup(version: Int): Result<UserProfile>
  - 实现 getBackupVersions(): List<BackupInfo>
  - 实现 cleanupOldBackups()
- **验收标准**：
  - [ ] 备份版本管理正确
  - [ ] 恢复功能正常
  - [ ] 自动清理旧备份
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

---

## 5. 阶段三：业务层实现（6h）

### 任务 3.1：创建 GetUserProfileUseCase
- **文件**：`domain/usecase/GetUserProfileUseCase.kt`
- **内容**：
  - 注入 UserProfileRepository 和 UserProfileCache
  - 实现 invoke(forceRefresh: Boolean = false): Result<UserProfile>
  - 流程：检查缓存 → 缓存有效返回缓存 → 从存储加载 → 更新缓存 → 返回结果
- **验收标准**：
  - [ ] 缓存逻辑正确
  - [ ] forceRefresh 参数正确处理
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 3.2：创建 UpdateUserProfileUseCase
- **文件**：`domain/usecase/UpdateUserProfileUseCase.kt`
- **内容**：
  - 注入 UserProfileRepository 和 UserProfileCache
  - 实现 invoke(profile: UserProfile): Result<UserProfile>
  - 流程：更新存储 → 更新缓存 → 返回更新后的画像
  - 自动更新 updatedAt 时间戳
- **验收标准**：
  - [ ] 存储和缓存同步更新
  - [ ] updatedAt 自动更新
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 3.3：创建 AddTagUseCase
- **文件**：`domain/usecase/AddTagUseCase.kt`
- **内容**：
  - 注入 GetUserProfileUseCase, UpdateUserProfileUseCase, UserProfileValidator
  - 实现 invoke(dimension: String, tag: String): Result<UserProfile>
  - 流程：验证标签 → 获取当前画像 → 检查重复 → 检查数量限制 → 添加标签 → 保存
- **验收标准**：
  - [ ] 验证逻辑正确
  - [ ] 支持基础维度和自定义维度
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 3.4：创建 RemoveTagUseCase
- **文件**：`domain/usecase/RemoveTagUseCase.kt`
- **内容**：
  - 注入 GetUserProfileUseCase, UpdateUserProfileUseCase
  - 实现 invoke(dimension: String, tag: String): Result<UserProfile>
  - 流程：获取当前画像 → 移除标签 → 保存
- **验收标准**：
  - [ ] 支持基础维度和自定义维度
  - [ ] 标签不存在时返回成功（幂等）
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 3.5：创建 ManageCustomDimensionUseCase
- **文件**：`domain/usecase/ManageCustomDimensionUseCase.kt`
- **内容**：
  - 注入 GetUserProfileUseCase, UpdateUserProfileUseCase, UserProfileValidator
  - 实现 addDimension(name: String): Result<UserProfile>
  - 实现 removeDimension(name: String): Result<UserProfile>
  - 流程：验证维度名 → 检查重复/限制 → 添加/删除 → 保存
- **验收标准**：
  - [ ] 添加时验证名称和数量限制
  - [ ] 删除时级联删除所有标签
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 3.6：创建 ExportUserProfileUseCase
- **文件**：`domain/usecase/ExportUserProfileUseCase.kt`
- **内容**：
  - 注入 UserProfileRepository
  - 实现 invoke(format: ExportFormat): Result<String>
  - 支持 JSON 和纯文本格式导出
- **验收标准**：
  - [ ] JSON 格式正确
  - [ ] 纯文本格式可读性好
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

---

## 6. 阶段四：UI组件开发（12h）

### 任务 4.1：创建 UserProfileScreen 主界面
- **文件**：`presentation/ui/screen/userprofile/UserProfileScreen.kt`
- **内容**：
  - 顶部栏：标题"个人画像" + 重置按钮
  - ProfileCompletenessCard 画像完整度卡片
  - TabRow 标签页切换（基础信息/自定义维度）
  - 根据选中标签页显示对应内容
  - 处理加载状态和错误状态
- **验收标准**：
  - [ ] 界面布局符合FD-00013设计
  - [ ] 标签页切换流畅
  - [ ] 加载和错误状态正确显示
- **状态**：⬜ 待开始

### 任务 4.2：创建 ProfileCompletenessCard 完整度卡片
- **文件**：`presentation/ui/screen/userprofile/component/ProfileCompletenessCard.kt`
- **内容**：
  - 显示画像完整度百分比
  - LinearProgressIndicator 进度条（带动画）
  - 显示已添加标签总数
  - 完整度计算：基于5个基础维度是否有标签
- **验收标准**：
  - [ ] 进度条动画流畅（使用 animateFloatAsState）
  - [ ] 百分比计算正确
  - [ ] 样式符合Material Design 3
- **状态**：⬜ 待开始

### 任务 4.3：创建 DimensionCard 维度卡片
- **文件**：`presentation/ui/screen/userprofile/component/DimensionCard.kt`
- **内容**：
  - 维度标题和描述
  - 可展开/收起功能（带动画）
  - TagChipGroup 标签组显示
  - 添加标签按钮
  - 预设标签建议区域
  - 自定义维度显示删除按钮
- **交互细节**：
  - 展开/收起动画：使用 AnimatedVisibility + expandVertically/shrinkVertically
  - 动画时长：300ms
  - 展开图标旋转动画：0° → 180°
- **验收标准**：
  - [ ] 展开/收起动画流畅
  - [ ] 标签显示正确
  - [ ] 预设标签可快速选择
- **状态**：⬜ 待开始

### 任务 4.4：创建 TagChipGroup 标签组组件
- **文件**：`presentation/ui/screen/userprofile/component/TagChipGroup.kt`
- **内容**：
  - FlowRow 布局显示标签
  - 每个标签支持点击编辑
  - 每个标签支持长按删除
  - 添加标签按钮（+图标）
  - 支持拖拽排序
- **拖拽交互细节**：
  - 长按识别：500ms 后进入拖拽模式
  - 视觉反馈：标签放大1.1倍，添加阴影，透明度70%
  - 拖拽指示器：目标位置显示蓝色插入线
  - 边界处理：拖拽到屏幕边界时自动滚动
  - 释放确认：松手时在目标位置插入标签
  - 取消操作：拖拽到非目标区域时取消
- **验收标准**：
  - [ ] FlowRow 自动换行
  - [ ] 标签交互正确
  - [ ] 拖拽排序功能正常
  - [ ] 样式符合设计规范
- **状态**：⬜ 待开始

### 任务 4.5：创建 DraggableTagChip 可拖拽标签组件
- **文件**：`presentation/ui/screen/userprofile/component/DraggableTagChip.kt`
- **内容**：
  - 基于 Modifier.pointerInput 实现拖拽
  - 长按触发拖拽模式
  - 拖拽状态视觉反馈
  - 拖拽结束回调
- **动画效果**：
  - 进入拖拽模式：scale(1.0 → 1.1)，elevation(0dp → 8dp)
  - 拖拽中：alpha(1.0 → 0.7)
  - 释放动画：scale(1.1 → 1.0)，弹性动画
- **验收标准**：
  - [ ] 长按500ms触发拖拽
  - [ ] 拖拽视觉反馈正确
  - [ ] 动画流畅自然
- **状态**：⬜ 待开始

### 任务 4.6：创建 AddTagDialog 添加标签对话框
- **文件**：`presentation/ui/screen/userprofile/component/AddTagDialog.kt`
- **内容**：
  - 标签输入框（最多50字符）
  - 字符计数显示
  - 实时验证和错误提示
  - 预设标签快速选择区域
  - 取消和添加按钮
- **错误处理**：
  - 空输入：显示"标签内容不能为空"，禁用添加按钮
  - 超长输入：显示"标签不能超过50字"，禁用添加按钮
  - 重复标签：显示"该标签已存在"，禁用添加按钮
- **验收标准**：
  - [ ] 输入验证正确
  - [ ] 预设标签可点击选择
  - [ ] 验证失败时添加按钮禁用
  - [ ] 错误提示清晰友好
- **状态**：⬜ 待开始

### 任务 4.7：创建 EditTagDialog 编辑标签对话框
- **文件**：`presentation/ui/screen/userprofile/component/EditTagDialog.kt`
- **内容**：
  - 标签输入框（预填充当前值）
  - 字符计数显示
  - 实时验证和错误提示
  - 删除按钮（带二次确认）
  - 取消和保存按钮
- **验收标准**：
  - [ ] 预填充当前标签值
  - [ ] 删除有二次确认
  - [ ] 验证失败时保存按钮禁用
- **状态**：⬜ 待开始

### 任务 4.8：创建 AddDimensionDialog 添加维度对话框
- **文件**：`presentation/ui/screen/userprofile/component/AddDimensionDialog.kt`
- **内容**：
  - 维度名称输入框（2-20字符）
  - 字符计数显示
  - 实时验证和错误提示
  - 示例提示文字
  - 取消和添加按钮
- **验收标准**：
  - [ ] 输入验证正确
  - [ ] 示例提示清晰
  - [ ] 验证失败时添加按钮禁用
- **状态**：⬜ 待开始

### 任务 4.9：创建 DeleteConfirmDialog 删除确认对话框
- **文件**：`presentation/ui/screen/userprofile/component/DeleteConfirmDialog.kt`
- **内容**：
  - 警告图标
  - 标题和提示消息（支持自定义）
  - 取消按钮和删除按钮（红色）
- **验收标准**：
  - [ ] 警告图标显示
  - [ ] 删除按钮为error颜色
  - [ ] 消息可自定义
- **状态**：⬜ 待开始

### 任务 4.10：创建 ExportProfileDialog 导出对话框
- **文件**：`presentation/ui/screen/userprofile/component/ExportProfileDialog.kt`
- **内容**：
  - 导出格式选择（JSON/纯文本）
  - 导出内容选项（基础维度/自定义维度/时间信息）
  - 取消和导出按钮
  - 导出成功后显示分享选项
- **验收标准**：
  - [ ] 格式选择正确
  - [ ] 导出内容可配置
  - [ ] 支持系统分享
- **状态**：⬜ 待开始

### 任务 4.11：创建 PresetTagSelector 预设标签选择器
- **文件**：`presentation/ui/screen/userprofile/component/PresetTagSelector.kt`
- **内容**：
  - FlowRow 显示预设标签
  - 已添加的标签显示为禁用状态
  - 点击标签快速添加
  - 支持滚动显示更多标签
- **验收标准**：
  - [ ] 已添加标签正确禁用
  - [ ] 点击添加功能正确
  - [ ] 滚动流畅
- **状态**：⬜ 待开始

### 任务 4.12：创建 TagAnimations 标签动画工具
- **文件**：`presentation/ui/screen/userprofile/component/TagAnimations.kt`
- **内容**：
  - 实现标签添加动画（淡入 + 缩放）
  - 实现标签删除动画（淡出 + 缩放）
  - 实现标签编辑动画（闪烁高亮）
  - 实现拖拽动画（弹性效果）
- **动画规格**：
  - 添加动画：300ms，EaseOutBack
  - 删除动画：200ms，EaseInBack
  - 编辑动画：150ms × 2，闪烁
  - 拖拽动画：Spring(dampingRatio = 0.6f)
- **验收标准**：
  - [ ] 动画流畅自然
  - [ ] 动画时长符合规格
  - [ ] 不影响性能
- **状态**：⬜ 待开始

---

## 7. 阶段五：ViewModel实现（4h）

### 任务 5.1：创建 UserProfileUiState 状态类
- **文件**：`presentation/ui/screen/profile/UserProfileUiState.kt`
- **内容**：
  - profile: UserProfile - 当前画像数据
  - selectedTabIndex: Int - 选中的标签页索引
  - isLoading: Boolean - 加载状态
  - error: String? - 错误消息
  - showAddTagDialog: Boolean - 添加标签对话框显示状态
  - showEditTagDialog: Boolean - 编辑标签对话框显示状态
  - showAddDimensionDialog: Boolean - 添加维度对话框显示状态
  - showDeleteConfirmDialog: Boolean - 删除确认对话框显示状态
  - showExportDialog: Boolean - 导出对话框显示状态
  - currentEditDimension: String? - 当前编辑的维度
  - currentEditTag: String? - 当前编辑的标签
  - 计算属性：completeness, totalTagCount, isEmpty
- **验收标准**：
  - [ ] 状态定义完整
  - [ ] 计算属性正确
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 5.2：创建 UserProfileUiEvent 事件类
- **文件**：`presentation/ui/screen/profile/UserProfileUiEvent.kt`
- **内容**：
  - 标签操作事件：ShowAddTagDialog, AddTag, ShowEditTagDialog, EditTag, RemoveTag, HideTagDialog
  - 维度操作事件：ShowAddDimensionDialog, AddDimension, RemoveDimension, HideDimensionDialog
  - 导出事件：ShowExportDialog, ExportProfile, HideExportDialog
  - 其他事件：SwitchTab, ResetProfile, ClearError, RefreshProfile
- **验收标准**：
  - [ ] 所有事件定义完整
  - [ ] 参数类型正确
- **状态**：⬜ 待开始

### 任务 5.3：创建 UserProfileViewModel
- **文件**：`presentation/viewmodel/UserProfileViewModel.kt`
- **内容**：
  - 注入所有相关UseCase
  - 实现 _uiState: MutableStateFlow<UserProfileUiState>
  - 实现 uiState: StateFlow<UserProfileUiState>
  - 实现 onEvent(event: UserProfileUiEvent) 事件处理
  - 实现 loadUserProfile() 加载画像
  - 实现 addTag(), editTag(), removeTag() 标签操作
  - 实现 addDimension(), removeDimension() 维度操作
  - 实现 exportProfile() 导出功能
  - 实现 resetProfile() 重置功能
  - 添加完整的错误处理
- **验收标准**：
  - [ ] 所有事件处理正确
  - [ ] 状态更新正确
  - [ ] 错误处理完整
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 5.4：集成设置页面入口
- **文件**：`presentation/ui/screen/settings/SettingsScreen.kt`
- **内容**：
  - 在AI服务商配置下方添加"个人画像"入口
  - 显示Person图标
  - 显示画像完整度百分比和进度条
  - 点击跳转到UserProfileScreen
  - 添加导航路由定义
- **验收标准**：
  - [ ] 入口位置正确
  - [ ] 完整度显示正确
  - [ ] 导航跳转正确
- **状态**：⬜ 待开始

---

## 8. 阶段六：AI上下文集成与性能优化（6h）

### 任务 6.1：创建 UserProfileContextBuilder 上下文构建器
- **文件**：`domain/util/UserProfileContextBuilder.kt`
- **内容**：
  - 注入 UserProfileRepository
  - 实现 buildAnalysisContext(contact: ContactProfile, userInput: String): Result<String>
  - 实现 filterRelevantProfileInfo(profile: UserProfile, chatContent: String): UserProfile
  - 实现 appendUserProfileSection(sb: StringBuilder, profile: UserProfile)
  - 实现 appendContactSection(sb: StringBuilder, contact: ContactProfile)
  - 智能筛选算法：关键词匹配、情感分析匹配、场景匹配
- **验收标准**：
  - [ ] 上下文构建格式正确
  - [ ] 智能筛选算法有效
  - [ ] 用户画像优先级高于联系人画像
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 6.2：修改 AnalyzeChatUseCase 集成用户画像
- **文件**：`domain/usecase/AnalyzeChatUseCase.kt`
- **内容**：
  - 注入 UserProfileContextBuilder
  - 修改 invoke() 方法使用新的上下文构建器
  - 流程：获取联系人 → 构建包含用户画像的上下文 → 发送AI请求
  - 添加错误处理：用户画像获取失败时降级为不含用户画像的上下文
- **验收标准**：
  - [ ] 用户画像正确集成到上下文
  - [ ] 降级策略正确
  - [ ] 不影响现有功能
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 6.3：增强 SystemPrompts 系统提示词
- **文件**：`domain/util/SystemPrompts.kt`
- **内容**：
  - 新增 ANALYSIS_WITH_USER_PROFILE 提示词
  - 引导AI利用用户画像信息
  - 强调根据用户性格特点提供个性化建议
  - 考虑用户沟通风格和价值观
- **验收标准**：
  - [ ] 提示词清晰有效
  - [ ] 与现有提示词兼容
- **状态**：⬜ 待开始

### 任务 6.4：集成到悬浮窗分析功能
- **文件**：`domain/service/FloatingWindowService.kt` 或相关文件
- **内容**：
  - 确保悬浮窗的分析功能也使用新的上下文构建器
  - 验证用户画像信息在悬浮窗分析中正确传递
  - 添加必要的依赖注入
- **验收标准**：
  - [ ] 悬浮窗分析包含用户画像
  - [ ] 功能正常工作
  - [ ] 集成测试通过
- **状态**：⬜ 待开始

### 任务 6.5：实现 UserProfileMemoryOptimizer 内存优化器
- **文件**：`domain/util/UserProfileMemoryOptimizer.kt`
- **内容**：
  - 实现对象池复用机制
  - 实现懒加载自定义维度
  - 实现定期清理缓存（30秒间隔）
  - 实现内存阈值监控（80%时自动清理）
  - 使用 WeakReference 避免内存泄漏
- **验收标准**：
  - [ ] 对象池复用正确
  - [ ] 懒加载机制有效
  - [ ] 内存监控正常
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 6.6：实现 Compose 性能优化
- **文件**：各UI组件文件
- **内容**：
  - 使用 remember 缓存计算结果
  - 使用 derivedStateOf 避免不必要的重组
  - 为 LazyColumn 提供稳定的 key
  - 使用 LazyColumn 处理大量标签数据
  - 优化动画性能（使用硬件加速）
- **验收标准**：
  - [ ] 界面加载时间 < 500ms
  - [ ] 标签操作响应时间 < 200ms
  - [ ] 无明显卡顿
  - [ ] 性能测试通过
- **状态**：⬜ 待开始

---

## 9. 阶段七：依赖注入与导航配置（2h）

### 任务 7.1：创建 UserProfileModule
- **文件**：`di/UserProfileModule.kt`
- **内容**：
  - 提供 UserProfilePreferences 单例
  - 提供 UserProfileCache 单例
  - 提供 UserProfileBackupManager 单例
  - 提供 UserProfileValidator 单例
  - 提供 UserProfileContextBuilder 单例
  - 提供 UserProfileMemoryOptimizer 单例
  - 提供所有UseCase单例
- **验收标准**：
  - [ ] 依赖注入配置正确
  - [ ] 单例作用域正确
  - [ ] 编译通过
- **状态**：⬜ 待开始

### 任务 7.2：更新 RepositoryModule 绑定 UserProfileRepository
- **文件**：`di/RepositoryModule.kt`
- **内容**：
  - 添加 UserProfileRepository 接口与 UserProfileRepositoryImpl 的绑定
  - 使用 @Binds 注解
- **代码示例**：
  ```kotlin
  @Binds
  abstract fun bindUserProfileRepository(
      impl: UserProfileRepositoryImpl
  ): UserProfileRepository
  ```
- **验收标准**：
  - [ ] 绑定配置正确
  - [ ] 编译通过
  - [ ] 依赖注入正常工作
- **状态**：⬜ 待开始

### 任务 7.3：验证导航路由配置
- **文件**：`presentation/navigation/NavGraph.kt`, `presentation/navigation/NavRoutes.kt`
- **内容**：
  - 验证 USER_PROFILE 路由常量已存在
  - 验证 UserProfileScreen 的 composable 定义已存在
  - 验证 SettingsScreen 的 onNavigateToUserProfile 回调已配置
  - 测试导航跳转功能
- **验收标准**：
  - [ ] 路由定义正确（已存在）
  - [ ] 导航跳转正常
  - [ ] 返回导航正常
- **状态**：⬜ 待开始（验证任务）

---

## 10. 阶段八：单元测试（8h）

### 任务 8.1：编写 UserProfile 模型测试
- **文件**：`test/domain/model/UserProfileTest.kt`
- **内容**：
  - 测试 isEmpty() 各种情况
  - 测试 getCompleteness() 计算逻辑
  - 测试 getTotalTagCount() 计算逻辑
  - 测试 getTagsForDimension() 方法
  - 测试默认值和边界情况
- **验收标准**：
  - [ ] 测试覆盖率 > 95%
  - [ ] 所有边界情况覆盖
- **状态**：⬜ 待开始

### 任务 8.2：编写 UserProfileValidator 测试
- **文件**：`test/domain/util/UserProfileValidatorTest.kt`
- **内容**：
  - 测试 validateTag() 正常和异常情况
  - 测试 validateDimensionName() 正常和异常情况
  - 测试 validateTagNotDuplicate() 方法
  - 测试 validateDimensionNotDuplicate() 方法
  - 测试 validateTagLimit() 和 validateDimensionLimit()
  - 测试 sanitizeInput() 特殊字符过滤
- **验收标准**：
  - [ ] 测试覆盖率 > 95%
  - [ ] 所有验证规则覆盖
- **状态**：⬜ 待开始

### 任务 8.3：编写 UserProfilePreferences 测试
- **文件**：`test/data/local/UserProfilePreferencesTest.kt`
- **内容**：
  - 测试 saveUserProfile() 正常保存
  - 测试 loadUserProfile() 正常加载
  - 测试 loadUserProfile() 空数据返回默认值
  - 测试 clearUserProfile() 清除功能
  - 测试 exportUserProfile() 导出功能
  - 测试 importUserProfile() 导入功能
  - 测试异常处理
- **验收标准**：
  - [ ] 测试覆盖率 > 90%
  - [ ] 加密存储正确验证
- **状态**：⬜ 待开始

### 任务 8.4：编写 UserProfileRepositoryImpl 测试
- **文件**：`test/data/repository/UserProfileRepositoryImplTest.kt`
- **内容**：
  - 测试所有接口方法
  - 测试IO调度器使用
  - 测试异常处理
  - 使用MockK模拟依赖
- **验收标准**：
  - [ ] 测试覆盖率 > 90%
  - [ ] 所有分支覆盖
- **状态**：⬜ 待开始

### 任务 8.5：编写 UseCase 测试
- **文件**：`test/domain/usecase/GetUserProfileUseCaseTest.kt`, `test/domain/usecase/UpdateUserProfileUseCaseTest.kt`, `test/domain/usecase/AddTagUseCaseTest.kt`, `test/domain/usecase/RemoveTagUseCaseTest.kt`, `test/domain/usecase/ManageCustomDimensionUseCaseTest.kt`, `test/domain/usecase/ExportUserProfileUseCaseTest.kt`
- **内容**：
  - 测试正常流程
  - 测试验证失败场景
  - 测试缓存逻辑
  - 测试错误处理
- **验收标准**：
  - [ ] 每个UseCase测试覆盖率 > 90%
  - [ ] 所有分支覆盖
- **状态**：⬜ 待开始

### 任务 8.6：编写 UserProfileContextBuilder 测试
- **文件**：`test/domain/util/UserProfileContextBuilderTest.kt`
- **内容**：
  - 测试 buildAnalysisContext() 正常构建
  - 测试空画像情况
  - 测试 filterRelevantProfileInfo() 智能筛选
  - 测试各种关键词匹配场景
  - 测试上下文格式正确性
- **验收标准**：
  - [ ] 测试覆盖率 > 90%
  - [ ] 智能筛选算法验证
- **状态**：⬜ 待开始

### 任务 8.7：编写 UserProfileViewModel 测试
- **文件**：`test/presentation/viewmodel/UserProfileViewModelTest.kt`
- **内容**：
  - 测试初始化加载
  - 测试所有事件处理
  - 测试状态更新
  - 测试错误处理
  - 使用MockK模拟UseCase
- **验收标准**：
  - [ ] 测试覆盖率 > 90%
  - [ ] 所有事件处理覆盖
- **状态**：⬜ 待开始

### 任务 8.8：编写 UserProfileUiState 测试
- **文件**：`test/presentation/ui/screen/profile/UserProfileUiStateTest.kt`
- **内容**：
  - 测试计算属性 completeness
  - 测试计算属性 totalTagCount
  - 测试计算属性 isEmpty
  - 测试默认值
- **验收标准**：
  - [ ] 测试覆盖率 100%
- **状态**：⬜ 待开始

---

## 11. 阶段九：集成测试与UI测试（6h）

### 任务 9.1：编写 UserProfileScreen UI测试
- **文件**：`androidTest/presentation/ui/screen/profile/UserProfileScreenTest.kt`
- **内容**：
  - 测试界面正确渲染
  - 测试标签页切换
  - 测试完整度卡片显示
  - 测试维度卡片展开/收起
  - 测试标签显示
- **验收标准**：
  - [ ] UI测试通过
  - [ ] 交互测试覆盖
- **状态**：⬜ 待开始

### 任务 9.2：编写 AddTagDialog UI测试
- **文件**：`androidTest/presentation/ui/screen/profile/component/AddTagDialogTest.kt`
- **内容**：
  - 测试对话框正确显示
  - 测试空输入显示错误
  - 测试超长输入显示错误
  - 测试重复标签显示错误
  - 测试预设标签点击添加
  - 测试验证错误时添加按钮禁用
- **验收标准**：
  - [ ] UI测试通过
  - [ ] 验证逻辑正确
- **状态**：⬜ 待开始

### 任务 9.3：编写 AI上下文集成测试
- **文件**：`androidTest/integration/UserProfileAiIntegrationTest.kt`
- **内容**：
  - 测试用户画像正确集成到AI分析上下文
  - 测试智能筛选算法效果
  - 测试空画像降级策略
  - 测试与现有AnalyzeChatUseCase的兼容性
- **验收标准**：
  - [ ] 集成测试通过
  - [ ] 上下文格式正确
- **状态**：⬜ 待开始

### 任务 9.4：编写端到端流程测试
- **文件**：`androidTest/presentation/ui/screen/profile/UserProfileFlowTest.kt`
- **内容**：
  - 测试从设置页面进入用户画像界面
  - 测试添加标签完整流程
  - 测试编辑标签完整流程
  - 测试删除标签完整流程
  - 测试添加自定义维度完整流程
  - 测试导出功能完整流程
  - 测试重置功能完整流程
- **验收标准**：
  - [ ] 端到端流程验证
  - [ ] 状态正确更新
- **状态**：⬜ 待开始

### 任务 9.5：编写性能测试
- **文件**：`test/performance/UserProfilePerformanceTest.kt`
- **内容**：
  - 测试界面加载时间 < 500ms
  - 测试标签操作响应时间 < 200ms
  - 测试数据保存时间 < 200ms
  - 测试AI上下文构建时间 < 300ms
  - 测试内存占用 < 5MB
- **验收标准**：
  - [ ] 所有性能指标达标
  - [ ] 性能数据可追踪
- **状态**：⬜ 待开始

### 任务 9.6：编写数据持久化测试
- **文件**：`androidTest/data/local/UserProfilePreferencesIntegrationTest.kt`
- **内容**：
  - 测试加密存储正确性
  - 测试数据持久化（应用重启后数据保留）
  - 测试导入导出数据一致性
  - 测试清除数据功能
- **验收标准**：
  - [ ] 数据持久化正确
  - [ ] 加密存储验证
- **状态**：⬜ 待开始

---

## 12. 开发注意事项

### 12.1 核心原则

1. **隐私优先**：使用EncryptedSharedPreferences加密存储用户画像数据
2. **架构一致**：严格遵循Clean Architecture + MVVM模式
3. **与现有系统兼容**：不破坏现有联系人画像系统功能
4. **渐进式发布**：使用功能开关控制发布节奏

### 12.2 关键依赖

- 依赖 TDD-00003 的 ContactProfile 模型
- 依赖现有的 AnalyzeChatUseCase 进行AI分析集成
- 复用现有的 SettingsScreen 作为入口
- 复用现有的 Material Design 3 组件库

### 12.3 性能要求

| 指标 | 目标值 |
|------|--------|
| 界面加载时间 | < 500ms |
| 标签操作响应时间 | < 200ms |
| 数据保存时间 | < 200ms |
| AI上下文构建时间 | < 300ms |
| 内存占用增量 | < 5MB |

### 12.4 验证规则汇总

| 内容类型 | 字段 | 长度限制 | 必填 | 其他规则 |
|---------|------|---------|------|----------|
| 标签 | tag | 1-50字符 | 是 | 同维度不重复 |
| 维度名称 | name | 2-20字符 | 是 | 不与基础维度重复 |
| 单维度标签数 | - | 最多20个 | - | - |
| 自定义维度数 | - | 最多10个 | - | - |

### 12.5 智能筛选关键词

| 关键词类别 | 示例关键词 | 匹配维度 |
|-----------|-----------|----------|
| 工作场景 | 工作、职场、同事 | values, communicationStyle |
| 社交场景 | 朋友、聚会 | socialPreferences, interests |
| 家庭场景 | 家人、父母 | values, personalityTraits |
| 情感场景 | 约会、恋爱 | interests, communicationStyle, personalityTraits |
| 情绪关键词 | 开心、难过、生气 | personalityTraits, values |
| 活动场景 | 会议、演讲、聚餐 | communicationStyle, socialPreferences |

---

## 13. 相关文档

- [PRD-00013-自己画像界面产品需求文档](../PRD/PRD-00013-自己画像界面产品需求文档.md)
- [FD-00013-自己画像界面功能设计](../FD/FD-00013-自己画像界面功能设计.md)
- [TDD-00013-自己画像界面技术设计](../TDD/TDD-00013-自己画像界面技术设计.md)
- [RESEARCH-00013-自己画像界面功能前置调研报告](../../../plans/RESEARCH-00013-自己画像界面功能前置调研报告.md)

---

## 14. 修订历史

| 版本 | 日期 | 作者 | 修改内容 |
|------|------|------|----------|
| 1.0 | 2025-12-21 | Kiro | 初始版本，基于PRD-00013、FD-00013、TDD-00013编写 |
| 1.1 | 2025-12-21 | Kiro | 根据优化建议更新：1) 补充已完成集成点说明（NavGraph.kt、SettingsScreen.kt）；2) 新增RepositoryModule.kt绑定任务；3) 补充多级缓存和备份管理器任务；4) 补充UI组件交互细节（拖拽排序、动画效果）；5) 新增性能优化任务（内存优化器、Compose优化）；6) 更新任务总数从49增至55 |

