# TD-00014: 联系人画像界面升级任务清单

---
**文档类型**: TD (Task Document) - 开发过程文档  
**存放规范**: 符合项目宪法第IV条 - 文档规范  
**版本控制**: Git管理，见.commit钩子  
---

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | TD (Task Document) |
| 文档编号 | TD-00014 |
| 功能名称 | 联系人画像界面升级 |
| 版本 | 1.0 |
| 创建日期 | 2025-12-21 |
| 最后更新 | 2025-12-21 |
| 作者 | Kiro |
| 关联文档 | PRD-00014, FD-00014, TDD-00014, DR-00017 |

---

## 2. 任务概览

| 阶段 | 任务数 | 预计工时 | 状态 |
|------|--------|----------|------|
| 阶段一：领域模型实现 | 3 | 2h | ⬜ 待开始 |
| 阶段二：业务层实现 | 3 | 3h | ⬜ 待开始 |
| 阶段三：工具类实现 | 2 | 2h | ⬜ 待开始 |
| 阶段四：主题与颜色系统 | 1 | 1h | ⬜ 待开始 |
| 阶段五：UI组件开发 | 8 | 10h | ⬜ 待开始 |
| 阶段六：ViewModel扩展 | 2 | 3h | ⬜ 待开始 |
| 阶段七：依赖注入配置 | 1 | 1h | ⬜ 待开始 |
| 阶段八：字符串资源 | 1 | 0.5h | ⬜ 待开始 |
| 阶段九：单元测试 | 6 | 6h | ⬜ 待开始 |
| 阶段十：集成测试与UI测试 | 3 | 4h | ⬜ 待开始 |
| **总计** | **30** | **32.5h (约4天)** | **0/30 完成 (0%)** |


### 2.1 已确认的集成点

以下集成点已在现有代码中确认，无需重复开发：

| 集成点 | 文件位置 | 状态 |
|--------|----------|------|
| ContactRepository | `domain/repository/ContactRepository.kt` | ✅ 复用现有 |
| Fact模型 | `domain/model/Fact.kt` | ✅ 复用现有 |
| ContactDetailTabScreen | `presentation/ui/screen/contact/ContactDetailTabScreen.kt` | ✅ 扩展集成 |
| AppDatabase | `data/local/AppDatabase.kt` | ✅ 无需修改 |

---

## 3. 阶段一：领域模型实现（2h）

### 任务 1.1：创建 FactCategory 分类分组模型
- **文件**：`domain/model/FactCategory.kt`
- **内容**：
  - 定义 FactCategory data class
  - 字段：key (分类名称), facts (标签列表), color (分类颜色), isExpanded (是否展开)
  - 实现 factCount 计算属性
  - 实现 isEmpty 计算属性
  - 实现 getFactIds() 方法
  - 实现 containsFact(factId) 方法
  - 实现 toggleExpanded() 方法
  - 定义 CategoryColor data class（titleColor, tagBackgroundColor, tagTextColor）
- **验收标准**：
  - [ ] 字段定义完整，默认值正确
  - [ ] 计算属性正确
  - [ ] 单元测试通过
- **状态**：⬜ 待开始


### 任务 1.2：创建 EditModeState 编辑模式状态
- **文件**：`domain/model/EditModeState.kt`
- **内容**：
  - 定义 EditModeState data class
  - 字段：isActive, selectedFactIds, showDeleteConfirm, showMoveDialog
  - 实现 selectedCount 计算属性
  - 实现 hasSelection 计算属性
  - 实现 toggleSelection(factId) 方法
  - 实现 selectAll(factIds) 方法
  - 实现 deselectAll(factIds) 方法
  - 实现 clearSelection() 方法
  - 实现 exit() 方法
  - 实现 showDeleteConfirmDialog() / hideDeleteConfirmDialog() 方法
  - 实现 showMoveCategoryDialog() / hideMoveCategoryDialog() 方法
- **验收标准**：
  - [ ] 状态切换逻辑正确
  - [ ] 选择操作正确
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 1.3：创建 PersonaSearchState 搜索状态
- **文件**：`domain/model/PersonaSearchState.kt`
- **内容**：
  - 定义 PersonaSearchState data class
  - 字段：query (搜索关键词), isSearching (是否正在搜索)
  - 实现 hasQuery 计算属性
  - 实现 updateQuery(newQuery) 方法
  - 实现 clear() 方法
- **验收标准**：
  - [ ] 状态定义完整
  - [ ] 方法逻辑正确
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

---

## 4. 阶段二：业务层实现（3h）

### 任务 2.1：创建 GroupFactsByCategoryUseCase 分组用例
- **文件**：`domain/usecase/GroupFactsByCategoryUseCase.kt`
- **内容**：
  - 注入 CategoryColorAssigner
  - 实现 invoke(facts: List<Fact>, isDarkMode: Boolean): List<FactCategory>
  - 按Fact的key字段分组
  - 分类内标签按时间倒序排列
  - 分类按名称排序
  - 为每个分类分配颜色
- **验收标准**：
  - [ ] 分组逻辑正确
  - [ ] 排序逻辑正确
  - [ ] 颜色分配正确
  - [ ] 单元测试通过
- **状态**：⬜ 待开始


### 任务 2.2：创建 BatchDeleteFactsUseCase 批量删除用例
- **文件**：`domain/usecase/BatchDeleteFactsUseCase.kt`
- **内容**：
  - 注入 ContactRepository
  - 实现 invoke(contactId: String, factIds: List<String>): Result<Int>
  - 空ID列表返回0
  - 联系人不存在返回错误
  - 从联系人的facts列表中移除指定ID的Fact
  - 返回实际删除的数量
- **验收标准**：
  - [ ] 删除逻辑正确
  - [ ] 错误处理完整
  - [ ] 幂等性保证
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

### 任务 2.3：创建 BatchMoveFactsUseCase 批量移动用例
- **文件**：`domain/usecase/BatchMoveFactsUseCase.kt`
- **内容**：
  - 注入 ContactRepository
  - 实现 invoke(contactId: String, factIds: List<String>, targetCategory: String): Result<Int>
  - 验证目标分类名称（1-20字符，不能为空）
  - 更新Fact的key字段为目标分类
  - 设置isUserModified为true
  - 更新lastModifiedTime
  - 返回实际移动的数量
- **验收标准**：
  - [ ] 移动逻辑正确
  - [ ] 验证规则正确
  - [ ] 时间戳更新正确
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

---

## 5. 阶段三：工具类实现（2h）

### 任务 3.1：创建 CategoryColorAssigner 颜色分配器
- **文件**：`domain/util/CategoryColorAssigner.kt`
- **内容**：
  - 实现 assignColor(categoryKey: String, isDarkMode: Boolean): CategoryColor
  - 使用哈希算法确保同一分类始终获得相同颜色
  - 调用 CategoryColorPalette 获取颜色
- **验收标准**：
  - [ ] 颜色分配一致性
  - [ ] 深色/浅色模式支持
  - [ ] 单元测试通过
- **状态**：⬜ 待开始


### 任务 3.2：创建 FactSearchFilter 搜索过滤器
- **文件**：`domain/util/FactSearchFilter.kt`
- **内容**：
  - 实现 filter(categories: List<FactCategory>, query: String): List<FactCategory>
  - 空查询返回原列表
  - 分类名称匹配返回完整分类
  - 标签值匹配只返回匹配的标签
  - 无匹配返回空列表
  - 搜索不区分大小写
  - 实现 matches(text: String, query: String): Boolean 辅助方法
- **验收标准**：
  - [ ] 过滤逻辑正确
  - [ ] 大小写不敏感
  - [ ] 部分匹配支持
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

---

## 6. 阶段四：主题与颜色系统（1h）

### 任务 4.1：创建 CategoryColorPalette 颜色调色板
- **文件**：`presentation/theme/CategoryColorPalette.kt`
- **内容**：
  - 定义8种Pastel色系颜色（浅色模式）
  - 定义8种对应的深色模式颜色
  - 每种颜色包含：titleColor, tagBackgroundColor, tagTextColor
  - 实现 getColorForCategory(categoryKey: String, isDarkMode: Boolean): CategoryColor
  - 使用哈希算法确保颜色一致性
  - 实现 getColorCount(): Int
- **颜色方案**：
  - 红色系、绿色系、蓝色系、橙色系
  - 紫色系、青色系、粉色系、灰蓝色系
- **验收标准**：
  - [ ] 8种颜色定义完整
  - [ ] 深色/浅色模式对应正确
  - [ ] 哈希分配一致
  - [ ] 视觉效果符合Material Design 3
- **状态**：⬜ 待开始

---

## 7. 阶段五：UI组件开发（10h）

### 任务 5.1：创建 PersonaTabV2 升级后主界面
- **文件**：`presentation/ui/screen/contact/persona/PersonaTabV2.kt`
- **内容**：
  - 接收参数：categories, searchState, editModeState, 各种回调
  - 编辑模式显示EditModeTopBar，否则显示CategorySearchBar
  - 使用LazyColumn显示分类列表，key为category.key
  - 编辑模式下有选中项时显示BatchActionBar
  - 处理对话框显示（删除确认、移动分类）
- **验收标准**：
  - [ ] 布局结构正确
  - [ ] 编辑模式切换正确
  - [ ] 列表性能优化（使用key）
  - [ ] 交互流畅
- **状态**：⬜ 待开始


### 任务 5.2：创建 CategorySearchBar 搜索栏
- **文件**：`presentation/ui/screen/contact/persona/CategorySearchBar.kt`
- **内容**：
  - OutlinedTextField实现
  - 搜索图标（leadingIcon）
  - 清除按钮（trailingIcon，有内容时显示）
  - 圆角样式（24.dp）
  - placeholder文本："搜索标签或分类..."
- **验收标准**：
  - [ ] 样式符合设计规范
  - [ ] 清除按钮逻辑正确
  - [ ] 输入响应正确
- **状态**：⬜ 待开始

### 任务 5.3：创建 DynamicCategoryCard 动态分类卡片
- **文件**：`presentation/ui/screen/contact/persona/DynamicCategoryCard.kt`
- **内容**：
  - Card容器，圆角12.dp
  - 分类标题栏：颜色指示条(4dp宽) + 分类名称 + 标签数量 + 展开/折叠图标
  - 点击标题栏切换展开/折叠
  - AnimatedVisibility实现折叠动画（expandVertically + fadeIn/fadeOut）
  - FlowRow布局显示标签
  - 使用分类颜色（titleColor, tagBackgroundColor）
- **验收标准**：
  - [ ] 卡片样式正确
  - [ ] 折叠动画流畅
  - [ ] 颜色应用正确
  - [ ] FlowRow自动换行
- **状态**：⬜ 待开始

### 任务 5.4：创建 SelectableTagChip 可选标签
- **文件**：`presentation/ui/screen/contact/persona/SelectableTagChip.kt`
- **内容**：
  - 使用combinedClickable支持点击和长按
  - 编辑模式下点击触发选中，否则触发普通点击
  - 长按进入编辑模式
  - 选中状态显示CheckCircle图标
  - 选中时使用primaryContainer颜色，否则使用分类颜色
  - 支持搜索关键词高亮（buildAnnotatedString）
- **验收标准**：
  - [ ] 点击/长按交互正确
  - [ ] 选中状态视觉反馈正确
  - [ ] 搜索高亮正确
  - [ ] 颜色切换正确
- **状态**：⬜ 待开始


### 任务 5.5：创建 EditModeTopBar 编辑模式顶栏
- **文件**：`presentation/ui/screen/contact/persona/EditModeTopBar.kt`
- **内容**：
  - Surface容器，primaryContainer颜色
  - 左侧：关闭按钮(X图标) + "已选择 N 项"文本
  - 右侧：全选按钮 + 取消全选按钮
  - 使用onPrimaryContainer颜色
- **验收标准**：
  - [ ] 布局正确
  - [ ] 按钮功能正确
  - [ ] 颜色符合Material Design 3
- **状态**：⬜ 待开始

### 任务 5.6：创建 BatchActionBar 批量操作栏
- **文件**：`presentation/ui/screen/contact/persona/BatchActionBar.kt`
- **内容**：
  - Surface容器，surfaceVariant颜色
  - 两个按钮平分宽度
  - 移动按钮：FilledTonalButton + DriveFileMove图标
  - 删除按钮：Button(error颜色) + Delete图标 + 选中数量
- **验收标准**：
  - [ ] 布局正确
  - [ ] 按钮样式正确
  - [ ] 删除按钮为error颜色
- **状态**：⬜ 待开始

### 任务 5.7：创建 MoveCategoryDialog 移动分类对话框
- **文件**：`presentation/ui/screen/contact/persona/MoveCategoryDialog.kt`
- **内容**：
  - AlertDialog实现
  - 标题："移动 N 个标签到"
  - 创建新分类选项（RadioButton + 输入框）
  - 现有分类列表（LazyColumn + RadioButton）
  - 新分类名称限制20字符
  - 确认按钮在有效选择时启用
- **验收标准**：
  - [ ] 对话框布局正确
  - [ ] 单选逻辑正确
  - [ ] 输入验证正确
  - [ ] 确认按钮启用逻辑正确
- **状态**：⬜ 待开始


### 任务 5.8：创建 BatchDeleteConfirmDialog 批量删除确认对话框
- **文件**：`presentation/ui/screen/contact/persona/BatchDeleteConfirmDialog.kt`
- **内容**：
  - AlertDialog实现
  - 标题："确认删除"
  - 消息："确定要删除选中的 N 个标签吗？此操作不可撤销。"
  - 取消按钮（TextButton）
  - 删除按钮（TextButton，error颜色）
- **验收标准**：
  - [ ] 对话框布局正确
  - [ ] 删除按钮为error颜色
  - [ ] 消息文本正确显示数量
- **状态**：⬜ 待开始

---

## 8. 阶段六：ViewModel扩展（3h）

### 任务 6.1：扩展 ContactDetailTabViewModel 状态
- **文件**：`presentation/viewmodel/ContactDetailTabViewModel.kt`（扩展现有）
- **内容**：
  - 在UiState中新增字段：
    - factCategories: List<FactCategory>
    - personaSearchState: PersonaSearchState
    - editModeState: EditModeState
    - availableCategories: List<String>
  - 新增事件类型：
    - UpdatePersonaSearch(query)
    - ToggleCategoryExpand(categoryKey)
    - EnterEditMode(initialFactId)
    - ExitEditMode
    - ToggleFactSelection(factId)
    - SelectAllInCategory(categoryKey)
    - DeselectAll
    - ShowDeleteConfirm / HideDeleteConfirm
    - ConfirmBatchDelete
    - ShowMoveDialog / HideMoveDialog
    - ConfirmBatchMove(targetCategory)
- **验收标准**：
  - [ ] 状态字段定义完整
  - [ ] 事件类型定义完整
  - [ ] 与现有代码兼容
- **状态**：⬜ 待开始


### 任务 6.2：实现 ContactDetailTabViewModel 事件处理
- **文件**：`presentation/viewmodel/ContactDetailTabViewModel.kt`（扩展现有）
- **内容**：
  - 注入新增UseCase：GroupFactsByCategoryUseCase, BatchDeleteFactsUseCase, BatchMoveFactsUseCase, FactSearchFilter
  - 实现handlePersonaEvent()方法处理所有标签画像相关事件
  - 实现refreshCategories()方法刷新分类列表
  - 搜索防抖处理（300ms）
  - 批量操作后刷新UI
  - 错误处理和提示
- **验收标准**：
  - [ ] 所有事件处理正确
  - [ ] 搜索防抖正确
  - [ ] 批量操作后状态更新正确
  - [ ] 错误处理完整
  - [ ] 单元测试通过
- **状态**：⬜ 待开始

---

## 9. 阶段七：依赖注入配置（1h）

### 任务 7.1：创建 PersonaModule 依赖注入模块
- **文件**：`di/PersonaModule.kt`
- **内容**：
  - @Module @InstallIn(SingletonComponent::class)
  - 提供 CategoryColorAssigner 单例
  - 提供 FactSearchFilter 单例
  - 提供 GroupFactsByCategoryUseCase 单例
  - 提供 BatchDeleteFactsUseCase 单例
  - 提供 BatchMoveFactsUseCase 单例
- **验收标准**：
  - [ ] 依赖注入配置正确
  - [ ] 单例作用域正确
  - [ ] 编译通过
  - [ ] 运行时注入正常
- **状态**：⬜ 待开始

---

## 10. 阶段八：字符串资源（0.5h）

### 任务 8.1：添加字符串资源
- **文件**：`res/values/strings.xml`, `res/values-en/strings.xml`
- **内容**：
  - search_tags_hint: "搜索标签或分类..." / "Search tags or categories..."
  - clear_search: "清除搜索" / "Clear search"
  - exit_edit_mode: "退出编辑模式" / "Exit edit mode"
  - selected_count: "已选择 %d 项" / "%d selected"
  - select_all: "全选" / "Select all"
  - deselect_all: "取消全选" / "Deselect all"
  - move_to_category: "移动分类" / "Move to category"
  - delete_selected: "删除 (%d)" / "Delete (%d)"
  - move_to_category_title: "移动 %d 个标签到" / "Move %d tags to"
  - create_new_category: "创建新分类" / "Create new category"
  - category_name: "分类名称" / "Category name"
  - existing_categories: "现有分类" / "Existing categories"
  - confirm_move: "确认移动" / "Confirm move"
  - delete_confirm_title: "确认删除" / "Confirm delete"
  - delete_tags_confirm_message: "确定要删除选中的 %d 个标签吗？此操作不可撤销。" / "Are you sure..."
  - delete: "删除" / "Delete"
  - cancel: "取消" / "Cancel"
- **验收标准**：
  - [ ] 中文字符串完整
  - [ ] 英文字符串完整
  - [ ] 格式化参数正确
- **状态**：⬜ 待开始


---

## 11. 阶段九：单元测试（6h）

### 任务 9.1：编写 FactCategory 和 EditModeState 模型测试
- **文件**：`test/domain/model/FactCategoryTest.kt`, `test/domain/model/EditModeStateTest.kt`
- **内容**：
  - FactCategory测试：factCount, isEmpty, getFactIds, containsFact, toggleExpanded
  - EditModeState测试：初始状态, toggleSelection, selectAll, deselectAll, clearSelection, exit, 对话框显示/隐藏
- **验收标准**：
  - [ ] 测试覆盖率 > 95%
  - [ ] 所有边界情况覆盖
- **状态**：⬜ 待开始

### 任务 9.2：编写 GroupFactsByCategoryUseCase 测试
- **文件**：`test/domain/usecase/GroupFactsByCategoryUseCaseTest.kt`
- **内容**：
  - 空列表返回空结果
  - 按Key正确分组
  - 分类按名称排序
  - 分类内标签按时间倒序排列
  - 颜色分配正确
- **验收标准**：
  - [ ] 测试覆盖率 > 90%
  - [ ] 所有分支覆盖
- **状态**：⬜ 待开始

### 任务 9.3：编写 BatchDeleteFactsUseCase 测试
- **文件**：`test/domain/usecase/BatchDeleteFactsUseCaseTest.kt`
- **内容**：
  - 空ID列表返回0
  - 联系人不存在返回错误
  - 成功删除指定Facts
  - 部分ID不存在时正确处理
  - 验证Repository调用
- **验收标准**：
  - [ ] 测试覆盖率 > 90%
  - [ ] 所有分支覆盖
- **状态**：⬜ 待开始

### 任务 9.4：编写 BatchMoveFactsUseCase 测试
- **文件**：`test/domain/usecase/BatchMoveFactsUseCaseTest.kt`
- **内容**：
  - 空ID列表返回0
  - 目标分类为空返回错误
  - 目标分类过长返回错误
  - 成功移动指定Facts
  - 验证key、isUserModified、lastModifiedTime更新
- **验收标准**：
  - [ ] 测试覆盖率 > 90%
  - [ ] 所有分支覆盖
- **状态**：⬜ 待开始


### 任务 9.5：编写 FactSearchFilter 测试
- **文件**：`test/domain/util/FactSearchFilterTest.kt`
- **内容**：
  - 空查询返回原列表
  - 分类名称匹配返回完整分类
  - 标签值匹配只返回匹配的标签
  - 无匹配返回空列表
  - 搜索不区分大小写
  - 部分匹配测试
- **验收标准**：
  - [ ] 测试覆盖率 > 90%
  - [ ] 所有分支覆盖
- **状态**：⬜ 待开始

### 任务 9.6：编写 ContactDetailTabViewModel 扩展测试
- **文件**：`test/presentation/viewmodel/ContactDetailTabViewModelPersonaTest.kt`
- **内容**：
  - 搜索事件处理测试
  - 分类展开/折叠测试
  - 编辑模式进入/退出测试
  - 标签选择/取消选择测试
  - 批量删除流程测试
  - 批量移动流程测试
  - 错误处理测试
- **验收标准**：
  - [ ] 测试覆盖率 > 90%
  - [ ] 所有事件处理覆盖
- **状态**：⬜ 待开始

---

## 12. 阶段十：集成测试与UI测试（4h）

### 任务 10.1：编写 PersonaTabV2 UI测试
- **文件**：`androidTest/presentation/ui/screen/contact/persona/PersonaTabV2Test.kt`
- **内容**：
  - 显示搜索栏测试
  - 编辑模式显示顶栏测试
  - 显示分类卡片测试
  - 分类折叠/展开测试
  - 标签点击测试
  - 标签长按进入编辑模式测试
  - 批量操作栏显示测试
- **验收标准**：
  - [ ] UI测试通过
  - [ ] 交互测试覆盖
- **状态**：⬜ 待开始

### 任务 10.2：编写对话框UI测试
- **文件**：`androidTest/presentation/ui/screen/contact/persona/PersonaDialogsTest.kt`
- **内容**：
  - MoveCategoryDialog显示测试
  - MoveCategoryDialog选择逻辑测试
  - MoveCategoryDialog新建分类测试
  - BatchDeleteConfirmDialog显示测试
  - BatchDeleteConfirmDialog确认/取消测试
- **验收标准**：
  - [ ] UI测试通过
  - [ ] 对话框交互正确
- **状态**：⬜ 待开始

### 任务 10.3：编写端到端流程测试
- **文件**：`androidTest/presentation/ui/screen/contact/persona/PersonaFlowTest.kt`
- **内容**：
  - 搜索过滤完整流程
  - 进入编辑模式 → 选择标签 → 批量删除完整流程
  - 进入编辑模式 → 选择标签 → 批量移动完整流程
  - 分类折叠/展开完整流程
  - 与现有PersonaTab功能兼容性测试
- **验收标准**：
  - [ ] 端到端流程验证
  - [ ] 状态正确更新
  - [ ] 与现有功能兼容
- **状态**：⬜ 待开始


---

## 13. 开发注意事项

### 13.1 核心原则

1. **渐进式升级**：保留现有PersonaTab，通过Feature Flag控制切换
2. **复用优先**：复用现有Fact模型和ContactRepository
3. **架构一致**：严格遵循Clean Architecture + MVVM模式
4. **性能优先**：使用LazyColumn和key优化列表性能

### 13.2 关键依赖

| 依赖项 | 文件位置 | 说明 |
|--------|----------|------|
| Fact模型 | `domain/model/Fact.kt` | 复用现有，无需修改 |
| ContactRepository | `domain/repository/ContactRepository.kt` | 复用现有，无需修改 |
| ContactDetailTabScreen | `presentation/ui/screen/contact/ContactDetailTabScreen.kt` | 扩展集成PersonaTabV2 |
| ContactDetailTabViewModel | `presentation/viewmodel/ContactDetailTabViewModel.kt` | 扩展添加新状态和事件 |

### 13.3 性能要求

| 指标 | 目标值 |
|------|--------|
| 分类列表渲染时间 | < 100ms |
| 搜索响应时间 | < 300ms（含防抖） |
| 批量操作响应时间 | < 500ms |
| 折叠/展开动画 | 60fps |

### 13.4 Feature Flag配置

```kotlin
// domain/util/FeatureFlags.kt
object FeatureFlags {
    var usePersonaTabV2: Boolean = false
    fun shouldUsePersonaTabV2(): Boolean = usePersonaTabV2
}
```

在ContactDetailTabScreen中使用：
```kotlin
if (FeatureFlags.shouldUsePersonaTabV2()) {
    PersonaTabV2(...)
} else {
    PersonaTab(...)
}
```

### 13.5 迁移策略

| 阶段 | 内容 | 风险 | 回滚方案 |
|------|------|------|----------|
| 阶段1 | 新增数据模型和UseCase | 低 | 删除新增文件 |
| 阶段2 | 新增UI组件（不替换现有） | 低 | 删除新增文件 |
| 阶段3 | 扩展ViewModel | 中 | Git回滚 |
| 阶段4 | 通过Feature Flag启用PersonaTabV2 | 中 | 关闭Feature Flag |
| 阶段5 | 删除旧PersonaTab | 低 | 从Git历史恢复 |

---

## 14. 文件清单

| 序号 | 文件路径 | 类型 | 阶段 |
|------|----------|------|------|
| 1 | `domain/model/FactCategory.kt` | 新增 | 阶段一 |
| 2 | `domain/model/EditModeState.kt` | 新增 | 阶段一 |
| 3 | `domain/model/PersonaSearchState.kt` | 新增 | 阶段一 |
| 4 | `domain/usecase/GroupFactsByCategoryUseCase.kt` | 新增 | 阶段二 |
| 5 | `domain/usecase/BatchDeleteFactsUseCase.kt` | 新增 | 阶段二 |
| 6 | `domain/usecase/BatchMoveFactsUseCase.kt` | 新增 | 阶段二 |
| 7 | `domain/util/CategoryColorAssigner.kt` | 新增 | 阶段三 |
| 8 | `domain/util/FactSearchFilter.kt` | 新增 | 阶段三 |
| 9 | `presentation/theme/CategoryColorPalette.kt` | 新增 | 阶段四 |
| 10 | `presentation/ui/screen/contact/persona/PersonaTabV2.kt` | 新增 | 阶段五 |
| 11 | `presentation/ui/screen/contact/persona/CategorySearchBar.kt` | 新增 | 阶段五 |
| 12 | `presentation/ui/screen/contact/persona/DynamicCategoryCard.kt` | 新增 | 阶段五 |
| 13 | `presentation/ui/screen/contact/persona/SelectableTagChip.kt` | 新增 | 阶段五 |
| 14 | `presentation/ui/screen/contact/persona/EditModeTopBar.kt` | 新增 | 阶段五 |
| 15 | `presentation/ui/screen/contact/persona/BatchActionBar.kt` | 新增 | 阶段五 |
| 16 | `presentation/ui/screen/contact/persona/MoveCategoryDialog.kt` | 新增 | 阶段五 |
| 17 | `presentation/ui/screen/contact/persona/BatchDeleteConfirmDialog.kt` | 新增 | 阶段五 |
| 18 | `presentation/viewmodel/ContactDetailTabViewModel.kt` | 扩展 | 阶段六 |
| 19 | `di/PersonaModule.kt` | 新增 | 阶段七 |
| 20 | `res/values/strings.xml` | 扩展 | 阶段八 |
| 21 | `res/values-en/strings.xml` | 扩展 | 阶段八 |


---

## 15. 集成验证清单

> **说明**：根据DR-00017审查报告，用于开发时验证集成完整性。

| 集成点 | 文件 | 验证状态 | 说明 |
|--------|------|----------|------|
| 导航集成 | ContactDetailTabScreen.kt | ⬜ 待验证 | PersonaTabV2作为子组件集成 |
| DI绑定 | PersonaModule.kt | ⬜ 待验证 | 新增UseCase绑定 |
| ViewModel扩展 | ContactDetailTabViewModel.kt | ⬜ 待验证 | 添加编辑模式状态和事件 |
| 字符串资源 | strings.xml | ⬜ 待验证 | 新增UI文本 |
| 颜色资源 | CategoryColorPalette.kt | ⬜ 待验证 | 新增调色板 |
| Feature Flag | FeatureFlags.kt | ⬜ 待验证 | 灰度发布控制 |
| 数据层复用 | ContactRepository | ✅ 已确认 | 复用现有实现 |
| 模型复用 | Fact.kt | ✅ 已确认 | 复用现有模型 |
| 数据库 | AppDatabase.kt | ✅ 已确认 | 无需修改 |

---

## 16. 相关文档

- [PRD-00014-联系人画像界面升级需求](../PRD/PRD-00014-联系人画像界面升级需求.md)
- [FD-00014-联系人画像界面升级功能设计](../FD/FD-00014-联系人画像界面升级功能设计.md)
- [TDD-00014-联系人画像界面升级技术设计](../TDD/TDD-00014-联系人画像界面升级技术设计.md)
- [DR-00017-TDD00014文档审查报告](../DR/DR-00017-TDD00014文档审查报告.md)

---

## 17. 修订历史

| 版本 | 日期 | 作者 | 修改内容 |
|------|------|------|----------|
| 1.0 | 2025-12-21 | Kiro | 初始版本，基于TDD-00014编写，包含30个任务，10个阶段 |
