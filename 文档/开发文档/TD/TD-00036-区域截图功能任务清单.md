# TD-00036-区域截图功能任务清单

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | TD |
| 文档编号 | TD-00036 |
| 版本 | v1.14 |
| 创建日期 | 2026-01-12 |
| 最后更新 | 2026-01-13 |
| 需求文档 | `文档/开发文档/PRD/PRD-00036-区域截图功能需求.md` |
| 功能设计 | `文档/开发文档/FD/FD-00036-区域截图功能设计.md` |
| 技术设计 | `文档/开发文档/TDD/TDD-00036-区域截图功能技术设计.md` |
| 状态 | ✅ 已完成 |
| 负责人 | Codex |
| 优先级 | P0 |

---

## 版本历史

| 版本 | 日期 | 变更说明 | 负责人 |
|------|------|----------|--------|
| v1.0 | 2026-01-12 | 初始版本 | Codex |
| v1.1 | 2026-01-12 | 补充任务概览与统计 | Codex |
| v1.2 | 2026-01-12 | 补充依赖图与并行执行示例 | Codex |
| v1.3 | 2026-01-12 | 补充任务依赖标注与并行数统计 | Codex |
| v1.4 | 2026-01-12 | 补充并行标注与统计对齐 | Codex |
| v1.5 | 2026-01-12 | 补充交付物、风险与完成定义 | Codex |
| v1.6 | 2026-01-12 | 补充需求追溯、DI任务与资源归属说明 | Codex |
| v1.7 | 2026-01-12 | 同步实现落点与完成状态 | Codex |
| v1.8 | 2026-01-12 | 补齐单测并更新任务状态 | Codex |
| v1.9 | 2026-01-12 | 补齐集成测试并完成任务 | Codex |
| v1.10 | 2026-01-13 | 补充单测执行记录（通过） | Codex |
| v1.11 | 2026-01-13 | 补充 MuMu 集成测试执行记录（通过） | Codex |
| v1.12 | 2026-01-13 | 补充 Gradle connected（仅MuMu）执行记录 | Codex |
| v1.13 | 2026-01-13 | 补充回归复测与MuMu重装记录 | Codex |
| v1.14 | 2026-01-13 | 补充多模态DTO序列化单测与说明 | Codex |

---

## 任务格式说明

- **[P]**: 可并行执行（不同文件，无依赖）
- **[US?]**: 所属用户故事（US1/US2）
- **[DEP:Txxx]**: 依赖任务
- 描述中包含确切的文件路径

---

## 路径约定

- **App/Service**: `app/src/main/java/com/empathy/ai/domain/service/`
- **App/Util**: `app/src/main/java/com/empathy/ai/domain/util/`
- **Domain**: `domain/src/main/kotlin/com/empathy/ai/domain/`
- **Data**: `data/src/main/kotlin/com/empathy/ai/data/`
- **Presentation**: `presentation/src/main/kotlin/com/empathy/ai/presentation/`
- **资源**: `app/src/main/res/`

---

## 资源归属说明

- 悬浮窗 View-based UI（遮罩、缩略图布局、文案）归属 `app/src/main/res/`
- 设置页 Compose UI 归属 `presentation/src/main/`
- 如需新增 Compose 资源，仅在 `presentation/src/main/res/` 落地并注明调用方

---

## 用户故事映射

- **US1 (P0)**: 在任意 App 内区域截图并插入悬浮窗输入框，支持删除、最多 5 张、模型不支持时降级提示，发送后清理
- **US2 (P1)**: 连续截屏与压缩策略（1.5s 窗口、设置开关、图片压缩）

---

## 任务概览

| 阶段 | 任务数 | 状态 | 备注 |
|------|--------|------|------|
| 阶段 1: 基础设置 | 4 | 已完成 | 权限、资源与布局 |
| 阶段 2: 基础架构 | 9 | 已完成 | 模型能力与多模态 DTO |
| 阶段 3: US1 | 6 | 已完成 | 区域截图与输入框插入 |
| 阶段 4: US2 | 6 | 已完成 | 连续截屏与压缩 |
| 阶段 5: 收尾与测试 | 4 | 已完成 | 单测 + 集成测试完成 |
| **总计** | **29** | **已完成** | **全部完成** |

---

## 任务统计

- 总任务数: 29
- US1 任务数: 6
- US2 任务数: 6
- 可并行任务数: 14
- MVP 范围: 阶段 1 + 阶段 2 + US1

---

## 阶段 1: 基础设置

**目标**: 权限、资源与布局就绪

- [x] T001 [P] 添加 MediaProjection 权限与前台服务类型 `app/src/main/AndroidManifest.xml`
- [x] T002 [P] 新增提示与错误文案（含降级提示文案）`app/src/main/res/values/strings.xml`
- [x] T003 [P] 新增截图入口图标 `app/src/main/res/drawable/ic_screenshot.xml`
- [x] T004 [DEP:T003] 新增缩略图容器与条目布局 `app/src/main/res/layout/floating_tab_content.xml`（条目由 `FloatingViewV2` 动态生成）

**检查点**: 权限与基础资源准备完成，悬浮窗布局可承载缩略图列表
_需求: PRD-00036 3.1, 3.4, 3.5_

---

## 阶段 2: 基础架构（阻塞性前置条件）

**目标**: 数据结构与多模态 DTO 完成

- [x] T005 [P] 新建附件模型 `domain/src/main/kotlin/com/empathy/ai/domain/model/ScreenshotAttachment.kt`
- [x] T006 [P] 扩展模型能力字段 `domain/src/main/kotlin/com/empathy/ai/domain/model/AiModel.kt`
- [x] T007 [DEP:T006] 补充预置模型能力 `domain/src/main/kotlin/com/empathy/ai/domain/model/ProviderPresets.kt`
- [x] T008 [DEP:T006] 允许自定义模型配置图片能力 `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/aiconfig/EditProviderScreen.kt`
- [x] T009 [P] 新建多模态内容结构 `data/src/main/kotlin/com/empathy/ai/data/remote/model/MessageContentPartDto.kt`
- [x] T010 [DEP:T009] 修改消息 DTO 支持多模态 `data/src/main/kotlin/com/empathy/ai/data/remote/model/MessageDto.kt`
- [x] T011 [DEP:T010] 多模态序列化适配 `data/src/main/kotlin/com/empathy/ai/data/remote/model/MessageDtoJsonAdapter.kt`
- [x] T012 [DEP:T011] 构建多模态请求与降级过滤 `data/src/main/kotlin/com/empathy/ai/data/repository/AiRepositoryImpl.kt`
- [x] T013 [P] 补齐 DI 绑定或校验 `data/src/main/kotlin/com/empathy/ai/data/di/NetworkModule.kt`

**检查点**: 模型能力可配置，多模态 DTO 就绪，仓储能够构建多模态请求
_需求: PRD-00036 3.5_

---

## 阶段 3: 用户故事 US1（P0）区域截图与输入框插入

**目标**: 完成区域截图、插入输入框、删除与清理
**独立测试**: 悬浮窗触发截图→插入缩略图→删除任一图片→发送清理成功

- [x] T014 [P] [US1] 附件管理内聚于 Service `app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt`
- [x] T015 [P] [US1] 新建遮罩与框选交互 `app/src/main/java/com/empathy/ai/domain/util/ScreenshotOverlayView.kt`
- [x] T016 [P] [US1] 缩略图渲染与删除回调 `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/floating/FloatingViewV2.kt`
- [x] T017 [US1] [DEP:T004,T016] 接入截图入口与缩略图列表 `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/floating/FloatingViewV2.kt`
- [x] T018 [US1] [DEP:T014,T015] 实现截图流程与附件插入 `app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt`
- [x] T019 [US1] [DEP:T018,T014] 发送后清理与失败保留 `app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt`

**检查点**: 区域截图可插入输入框，缩略图可删除，最多 5 张，发送成功自动清理
_需求: PRD-00036 3.2, 3.4, 3.6, 3.8_

---

## 阶段 4: 用户故事 US2（P1）连续截屏与压缩

**目标**: 连续截屏开关、1.5s 窗口与压缩策略落地
**独立测试**: 开启连续截屏→1.5s 内追加截图→超时自动退出→压缩后体积符合策略

- [x] T020 [P] [US2] 扩展悬浮窗偏好接口 `domain/src/main/kotlin/com/empathy/ai/domain/repository/FloatingWindowPreferencesRepository.kt`
- [x] T021 [US2] [DEP:T020] 实现偏好存储 `data/src/main/kotlin/com/empathy/ai/data/local/FloatingWindowPreferences.kt`
- [x] T022 [P] [US2] 新增设置状态与事件 `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsUiState.kt`、`presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsUiEvent.kt`
- [x] T023 [US2] [DEP:T022,T021] 接入设置 UI 与 ViewModel `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsScreen.kt`、`presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/SettingsViewModel.kt`
- [x] T024 [US2] [DEP:T018] 压缩处理并接入 `app/src/main/java/com/empathy/ai/domain/util/ScreenshotCaptureHelper.kt`、`app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt`
- [x] T025 [US2] [DEP:T024,T018] 连续截屏 1.5s 窗口与提示 `app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt`、`app/src/main/java/com/empathy/ai/domain/util/ScreenshotOverlayView.kt`

**检查点**: 连续截屏开关可用，1.5s 内可追加截图，压缩策略生效
_需求: PRD-00036 3.3, 3.7_

---

## 阶段 5: 收尾与测试

**目标**: 补齐核心单测与集成验证

- [x] T026 [P] 单元测试（截图文件清理）`app/src/test/java/com/empathy/ai/domain/util/ScreenshotCaptureHelperTest.kt`
- [x] T027 [P] 单元测试（连续截屏开关）`app/src/test/java/com/empathy/ai/data/local/FloatingWindowPreferencesContinuousScreenshotTest.kt`
- [x] T028 [DEP:T018,T025] 集成测试（悬浮窗截图）`app/src/androidTest/java/com/empathy/ai/domain/service/FloatingWindowServiceScreenshotTest.kt`
- [x] T029 [DEP:T019] 收尾检查与清理 `app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt`

**检查点**: 关键逻辑通过验证，截图文件无残留
_需求: PRD-00036 8.1, 8.2_

**单测执行记录**:
- `./gradlew.bat :app:testDebugUnitTest --tests "com.empathy.ai.domain.util.ScreenshotCaptureHelperTest" --tests "com.empathy.ai.data.local.FloatingWindowPreferencesContinuousScreenshotTest"` ✅
- 报告：`app/build/reports/tests/testDebugUnitTest/index.html`

**集成测试执行记录（MuMu）**:
- 前置：`adb connect 127.0.0.1:7555`
- 安装：`adb -s 127.0.0.1:7555 install -r app/build/outputs/apk/debug/app-debug.apk`、`adb -s 127.0.0.1:7555 install -r app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk`
- 执行：`adb -s 127.0.0.1:7555 shell am instrument -w -r -e class com.empathy.ai.domain.service.FloatingWindowServiceScreenshotTest com.empathy.ai.test/androidx.test.runner.AndroidJUnitRunner` ✅

**Gradle connected（仅 MuMu）**:
- `ANDROID_SERIAL=127.0.0.1:7555 ./gradlew.bat :app:connectedDebugAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.empathy.ai.domain.service.FloatingWindowServiceScreenshotTest` ✅
  - PowerShell 兼容写法：`$env:ANDROID_SERIAL='127.0.0.1:7555'; ./gradlew.bat :app:connectedDebugAndroidTest "-Pandroid.testInstrumentationRunnerArguments.class=com.empathy.ai.domain.service.FloatingWindowServiceScreenshotTest"` ✅

**回归复测（2026-01-13）**:
- `./gradlew.bat :app:testDebugUnitTest` ✅（报告：`app/build/reports/tests/testDebugUnitTest/index.html`）
- `adb connect 127.0.0.1:7555` ✅
- `./gradlew.bat :app:assembleDebug` ✅ + `adb -s 127.0.0.1:7555 install -r app/build/outputs/apk/debug/app-debug.apk` ✅
- `PowerShell: $env:ANDROID_SERIAL='127.0.0.1:7555'; ./gradlew.bat :app:connectedDebugAndroidTest "-Pandroid.testInstrumentationRunnerArguments.class=com.empathy.ai.domain.service.FloatingWindowServiceScreenshotTest"` ✅

**数据层单测（多模态DTO）**:
- `./gradlew.bat :data:testDebugUnitTest --tests "com.empathy.ai.data.remote.model.MessageDtoContentJsonAdapterTest"` ✅（报告：`data/build/reports/tests/testDebugUnitTest/index.html`）

**设备说明（MuMu）**:
- 若 `adb connect 127.0.0.1:7555` 返回 `10061`（连接被拒绝），通常表示 MuMu 未启动或端口未开放，此时 `connectedDebugAndroidTest` / 安装 APK 将无法执行。

**额外回归说明（非本需求阻塞项）**:
- 若在 MuMu 上跑 `:app:connectedDebugAndroidTest` 全量用例，当前会因非截图相关用例失败而导致整体失败：
  - `com.empathy.ai.presentation.ui.component.EmotionalBackgroundTest#emotionalBackground_scoreChange_triggersRecomposition` ❌
  - 报告：`app/build/reports/androidTests/connected/debug/index.html`
- 逐个执行其他 androidTest 时也存在非截图相关失败（不影响本需求验收）：
  - `com.empathy.ai.presentation.ui.component.GuessedTagTest#guessedTag_riskType_rendersCorrectly` ❌
  - `com.empathy.ai.presentation.ui.component.SegmentedControlTest#segmentedControl_longText_rendersCorrectly` ❌
  - `com.empathy.ai.presentation.ui.component.EmotionalBackgroundTest` 在 MuMu 上存在不稳定：单测方法可单独通过，但跑完整类时可能因 `WindowManager$InvalidDisplayException: Display#4 could not be found` 导致进程被杀，从而出现空 failure。
  - 复测结论：`GuessedTagTest#guessedTag_riskType_rendersCorrectly` / `SegmentedControlTest#segmentedControl_longText_rendersCorrectly` 在方法级过滤下可通过，但按类/全量执行时仍可能失败并触发崩溃，倾向环境/设备不稳定导致的 flaky。
  - `EmotionalBackgroundTest` 方法级复跑（MuMu）可全部通过，但仍可能在同类/全量执行时触发崩溃，建议后续统一做稳定性治理后再纳入全量回归门禁。

---

## 依赖关系与执行顺序

- 阶段 1 → 阶段 2（前置依赖）
- 阶段 2 完成后进入 US1（P0）
- US2（P1）依赖 US1 的截图基础流程完成
- 收尾与测试在 US1/US2 完成后执行

---

## 依赖关系图

```
阶段 1: 基础设置
      ↓
阶段 2: 基础架构
      ↓
阶段 3: US1 (P0)
      ↓
阶段 4: US2 (P1)
      ↓
阶段 5: 收尾与测试
```

---

## 并行执行示例

### US1 并行示例（不冲突文件）
- T014 `ScreenshotAttachmentManager.kt`
- T015 `ScreenshotOverlayView.kt`
- T016 `ScreenshotThumbAdapter.kt`

### US2 并行示例（不冲突文件）
- T020 `FloatingWindowPreferencesRepository.kt`
- T022 `SettingsUiState.kt`、`SettingsUiEvent.kt`

---

## 实施策略

1. 完成阶段 1 + 阶段 2，确保权限与数据结构就绪
2. 先交付 US1（P0）作为 MVP
3. 再交付 US2（P1）连续截屏与压缩
4. 最后补齐测试与收尾验证

---

## 交付物清单

**新增**:
- `app/src/main/java/com/empathy/ai/domain/util/ScreenshotOverlayView.kt`
- `app/src/main/java/com/empathy/ai/domain/util/ScreenshotCaptureHelper.kt`
- `app/src/main/java/com/empathy/ai/ui/ScreenshotPermissionActivity.kt`
- `app/src/test/java/com/empathy/ai/domain/util/ScreenshotCaptureHelperTest.kt`
- `app/src/test/java/com/empathy/ai/data/local/FloatingWindowPreferencesContinuousScreenshotTest.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/model/ScreenshotAttachment.kt`
- `data/src/main/kotlin/com/empathy/ai/data/remote/model/MessageContentPartDto.kt`
- `data/src/main/kotlin/com/empathy/ai/data/remote/model/MessageDtoJsonAdapter.kt`
- `app/src/main/res/drawable/ic_screenshot.xml`

**修改**:
- `app/src/main/java/com/empathy/ai/domain/service/FloatingWindowService.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/floating/FloatingViewV2.kt`
- `app/src/main/res/layout/floating_tab_content.xml`
- `presentation/src/main/res/layout/floating_tab_content.xml`
- `app/src/main/AndroidManifest.xml`
- `app/src/main/res/values/strings.xml`
- `domain/src/main/kotlin/com/empathy/ai/domain/model/AiModel.kt`
- `domain/src/main/kotlin/com/empathy/ai/domain/model/ProviderPresets.kt`
- `data/src/main/kotlin/com/empathy/ai/data/remote/model/MessageDto.kt`
- `data/src/main/kotlin/com/empathy/ai/data/di/NetworkModule.kt`
- `data/src/main/kotlin/com/empathy/ai/data/di/RepositoryModule.kt`
- `app/src/main/java/com/empathy/ai/app/di/ServiceModule.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/aiconfig/EditProviderScreen.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsUiState.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsUiEvent.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsScreen.kt`
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/SettingsViewModel.kt`

---

## 风险与注意事项

- MediaProjection 授权在部分机型每次都需要确认，需接受降级体验
- 遮罩需在截图前隐藏，避免被截图进画面
- 模型不支持图片时仅发送文本并提示，避免误解
- 连续截屏超时需释放资源，避免后台占用

---

## 完成定义（DoD）

- TD 任务全部勾选完成
- US1 与 US2 独立测试通过
- 截图临时文件在发送后清理完毕
- 模型不支持图片时不发送附件且提示生效

---

## 验收检查清单

- [x] 截图入口可用，遮罩拖拽松手即截图
- [x] 缩略图列表可删除，最多 5 张
- [x] 模型不支持图片时仅发送文字并提示
- [x] 连续截屏开关与 1.5s 窗口生效
- [x] 发送成功后截图文件清理干净
