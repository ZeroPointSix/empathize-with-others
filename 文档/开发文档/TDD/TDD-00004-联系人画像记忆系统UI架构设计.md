# TDD-00004: è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIæ¶æ„è®¾è®¡

## 1. æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç±»å‹ | TDD (Technical Design Document) |
| æ–‡æ¡£ç¼–å· | TDD-00004 |
| åŠŸèƒ½åç§° | è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIæ¶æ„è®¾è®¡ |
| ç‰ˆæœ¬ | 2.1 (æ ¹æ®DR-00008å®¡æŸ¥ä¼˜åŒ–) |
| åˆ›å»ºæ—¥æœŸ | 2025-12-14 |
| æœ€åæ›´æ–° | 2025-12-14 |
| ä½œè€… | Kiro |
| å®¡æ ¸äºº | Roo |
| å®¡æ ¸çŠ¶æ€ | âœ… å·²å®¡æ ¸ (DR-00008) |
| å…³è”æ–‡æ¡£ | PRD-00004 v2.0, FD-00004 v2.1 |

## 1.1 å‚è€ƒæ ‡å‡†

æœ¬æ–‡æ¡£éµå¾ªä»¥ä¸‹é¡¹ç›®æ ‡å‡†å’Œè§„èŒƒï¼š

| æ ‡å‡†æ–‡æ¡£ | ç‰ˆæœ¬ | è¯´æ˜ |
|---------|------|------|
| Clean Architecture | - | æ¶æ„æ¨¡å¼æ ‡å‡† |
| MVVM Pattern | - | UIæ¶æ„æ¨¡å¼ |
| Jetpack Compose Guidelines | 2024.12.01 | UIå¼€å‘è§„èŒƒ |
| Material Design 3 | 1.3.1 | è®¾è®¡ç³»ç»Ÿè§„èŒƒ |
| Kotlin Coding Conventions | 2.0.21 | ä»£ç è§„èŒƒ |

## 1.2 æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

**å½“å‰æŠ€æœ¯å€ºåŠ¡**ï¼š

| å€ºåŠ¡ID | æè¿° | å½±å“ | ä¼˜å…ˆçº§ | è®¡åˆ’è§£å†³æ—¶é—´ |
|--------|------|------|--------|-------------|
| TD-001 | Roomæ•°æ®åº“è¿ç§»ç­–ç•¥éœ€å®Œå–„ | é«˜ | ğŸ”´ é«˜ | Betaæµ‹è¯•å‰ |
| TD-002 | åª’ä½“å¤„ç†æ¨¡å—æœªå®ç° | ä¸­ | ğŸŸ¡ ä¸­ | v2.0ç‰ˆæœ¬ |
| TD-003 | è§„åˆ™å¼•æ“é›†æˆçŠ¶æ€ä¸æ˜ | ä½ | ğŸŸ¢ ä½ | v2.0ç‰ˆæœ¬ |

**å¯¹æœ¬æ¬¡å¼€å‘çš„å½±å“**ï¼š
- TD-001ï¼šéœ€è¦åœ¨UIå¼€å‘å®Œæˆåç«‹å³å¤„ç†ï¼Œé¿å…ç”¨æˆ·æ•°æ®ä¸¢å¤±
- TD-002ã€TD-003ï¼šä¸å½±å“UIå¼€å‘ï¼Œå¯å»¶åå¤„ç†

## 2. æ¶æ„æ¦‚è¿°

### 2.1 æ¶æ„ç›®æ ‡

è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIé‡‡ç”¨Clean Architecture + MVVMæ¶æ„æ¨¡å¼ï¼Œé€šè¿‡æƒ…æ„ŸåŒ–è®¾è®¡è¯­è¨€å®ç°"æ´»ä½“æ¡£æ¡ˆ"å’Œ"AIå†›å¸ˆæƒ…æŠ¥ä¸­å¿ƒ"çš„äº§å“æ„¿æ™¯ã€‚æ¶æ„è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

- **æƒ…æ„ŸåŒ–ä¼˜å…ˆ**: æ¯ä¸ªåƒç´ éƒ½ä¼ é€’å…³ç³»çš„æƒ…æ„Ÿå’Œç¡®å®šæ€§ä¿¡æ¯
- **æµä½“äº¤äº’**: ç¦æ­¢ç¡¬åˆ‡ï¼Œæ‰€æœ‰çŠ¶æ€è¿‡æ¸¡ä½¿ç”¨æµä½“åŠ¨ç”»
- **åŠ¨æ€å“åº”**: ç•Œé¢å…ƒç´ æ ¹æ®å…³ç³»çŠ¶æ€å®æ—¶å˜åŒ–
- **æ€§èƒ½ä¼˜å…ˆ**: åˆ—è¡¨ä¼˜åŒ–ã€åŠ¨ç”»ä¼˜åŒ–ã€æ•°æ®åŠ è½½ä¼˜åŒ–
- **å…³æ³¨ç‚¹åˆ†ç¦»**: UIé€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- **å¯æµ‹è¯•æ€§**: ç»„ä»¶å¯ç‹¬ç«‹æµ‹è¯•
- **å¯ç»´æŠ¤æ€§**: ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•

### 2.2 æŠ€æœ¯æ ˆé€‰æ‹©

| æŠ€æœ¯é¢†åŸŸ | æŠ€æœ¯é€‰æ‹© | ç‰ˆæœ¬è¦æ±‚ | ç”¨é€” |
|---------|----------|----------|------|
| UIæ¡†æ¶ | Jetpack Compose | 2024.12.01 | å£°æ˜å¼UI |
| è®¾è®¡ç³»ç»Ÿ | Material Design 3 | 1.3.1 | è®¾è®¡è§„èŒƒ |
| æ¶æ„æ¨¡å¼ | MVVM | - | æ¶æ„æ¨¡å¼ |
| çŠ¶æ€ç®¡ç† | StateFlow | 1.9.0 | UIçŠ¶æ€ç®¡ç† |
| åŠ¨ç”»ç³»ç»Ÿ | Compose Animation | 2024.12.01 | æµä½“åŠ¨ç”» |
| å›¾ç‰‡åŠ è½½ | Coil | 2.5.0 | å¼‚æ­¥å›¾ç‰‡åŠ è½½ |
| ä¾èµ–æ³¨å…¥ | Hilt | 2.52 | ä¾èµ–ç®¡ç† |
| å¯¼èˆª | Navigation Compose | 2.8.5 | é¡µé¢å¯¼èˆª |

### 2.3 è®¾è®¡è¯­è¨€æ ¸å¿ƒ

**æƒ…æ„ŸåŒ–ç£¨ç ‚ç»ç’ƒ (Emotional Glassmorphism)**ï¼š
- åŠé€æ˜ç£¨ç ‚ç»ç’ƒæ•ˆæœ
- åŠ¨æ€èƒŒæ™¯å…‰æ™•ï¼ˆæ ¹æ®å…³ç³»åˆ†æ•°å˜è‰²ï¼‰
- æµä½“å˜å½¢åŠ¨ç”»
- æƒ…ç»ªèŠ‚ç‚¹å¯è§†åŒ–

**å…³ç³»åˆ†æ•°è‰²å½©æ˜ å°„**ï¼š
- 81-100åˆ†ï¼šæš–æ©™/ç²‰è‰²æ¸å˜ï¼ˆäº²å¯†ï¼‰
- 61-80åˆ†ï¼šæŸ”å’Œé»„ç»¿æ¸å˜ï¼ˆè‰¯å¥½ï¼‰
- 31-60åˆ†ï¼šä¸­æ€§è“ç°æ¸å˜ï¼ˆä¸€èˆ¬ï¼‰
- 0-30åˆ†ï¼šå†·è“/æ·±ç°æ¸å˜ï¼ˆå†·æ·¡ï¼‰



## 3. æ•´ä½“æ¶æ„è®¾è®¡

### 3.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ContactDetailScreen                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ Overview   â”‚ â”‚FactStream  â”‚ â”‚ Persona        â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Tab        â”‚ â”‚ Tab        â”‚ â”‚ Tab            â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Reusable UI Components                        â”‚  â”‚
â”‚  â”‚  - EmotionalBackground                                â”‚  â”‚
â”‚  â”‚  - GlassmorphicCard                                   â”‚  â”‚
â”‚  â”‚  - EmotionalTimelineNode                              â”‚  â”‚
â”‚  â”‚  - ConfirmedTag / GuessedTag                          â”‚  â”‚
â”‚  â”‚  - SegmentedControl                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         ContactDetailViewModel                        â”‚  â”‚
â”‚  â”‚  - UiState (StateFlow)                                â”‚  â”‚
â”‚  â”‚  - UiEvent (Sealed Class)                             â”‚  â”‚
â”‚  â”‚  - Event Handling                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Domain Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Repository Interfaces                    â”‚  â”‚
â”‚  â”‚  - ContactRepository                                  â”‚  â”‚
â”‚  â”‚  - ConversationRepository                             â”‚  â”‚
â”‚  â”‚  - DailySummaryRepository                             â”‚  â”‚
â”‚  â”‚  - BrainTagRepository                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 Domain Models                         â”‚  â”‚
â”‚  â”‚  - ContactProfile, Fact, ConversationLog              â”‚  â”‚
â”‚  â”‚  - DailySummary, BrainTag                             â”‚  â”‚
â”‚  â”‚  - TimelineItem, EmotionType                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Data Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          Repository Implementations                   â”‚  â”‚
â”‚  â”‚  - ContactRepositoryImpl                              â”‚  â”‚
â”‚  â”‚  - ConversationRepositoryImpl                         â”‚  â”‚
â”‚  â”‚  - DailySummaryRepositoryImpl                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Room Database                            â”‚  â”‚
â”‚  â”‚  - ContactProfileEntity                               â”‚  â”‚
â”‚  â”‚  - ConversationLogEntity                              â”‚  â”‚
â”‚  â”‚  - DailySummaryEntity                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 UIç»„ä»¶å±‚æ¬¡ç»“æ„

```
ContactDetailScreen (ä¸»å±å¹•)
â”œâ”€â”€ EmotionalBackground (åŠ¨æ€èƒŒæ™¯)
â”œâ”€â”€ TabRow (æ ‡ç­¾é¡µåˆ‡æ¢)
â”‚   â”œâ”€â”€ "æ¦‚è§ˆ"
â”‚   â”œâ”€â”€ "äº‹å®æµ"
â”‚   â”œâ”€â”€ "æ ‡ç­¾ç”»åƒ"
â”‚   â””â”€â”€ "èµ„æ–™åº“"
â””â”€â”€ AnimatedContent (å†…å®¹åŒºåŸŸ)
    â”œâ”€â”€ OverviewTab (ç•Œé¢ä¸€ï¼šæ¦‚è§ˆ)
    â”‚   â”œâ”€â”€ DynamicEmotionalHeader (åŠ¨æ€æƒ…æ„Ÿå¤´éƒ¨)
    â”‚   â”œâ”€â”€ TopTagsSection (æ ¸å¿ƒæ ‡ç­¾é€Ÿè§ˆ)
    â”‚   â””â”€â”€ LatestFactHookCard (æœ€æ–°åŠ¨æ€å¡ç‰‡)
    â”œâ”€â”€ FactStreamTab (ç•Œé¢äºŒï¼šäº‹å®æµ)
    â”‚   â”œâ”€â”€ FactStreamTopBar (é¡¶éƒ¨æ§ä»¶)
    â”‚   â”‚   â”œâ”€â”€ SegmentedControl (è§†å›¾åˆ‡æ¢)
    â”‚   â”‚   â””â”€â”€ FilterButton (ç­›é€‰æŒ‰é’®)
    â”‚   â””â”€â”€ AnimatedContent (è§†å›¾å†…å®¹)
    â”‚       â”œâ”€â”€ TimelineView (æ—¶å…‰è½´è§†å›¾)
    â”‚       â”‚   â””â”€â”€ LazyVerticalStaggeredGrid
    â”‚       â”‚       â”œâ”€â”€ EmotionalTimelineNode
    â”‚       â”‚       â”œâ”€â”€ PhotoMomentCard
    â”‚       â”‚       â”œâ”€â”€ AiSummaryCard
    â”‚       â”‚       â”œâ”€â”€ MilestoneCard
    â”‚       â”‚       â””â”€â”€ ConversationCard
    â”‚       â””â”€â”€ ListView (æ¸…å•åˆ—è¡¨è§†å›¾)
    â”‚           â”œâ”€â”€ QuickFilterChips
    â”‚           â””â”€â”€ LazyColumn
    â”‚               â””â”€â”€ ListViewRow
    â”œâ”€â”€ PersonaTab (ç•Œé¢ä¸‰ï¼šæ ‡ç­¾ç”»åƒ)
    â”‚   â””â”€â”€ LazyColumn
    â”‚       â””â”€â”€ CategorySection
    â”‚           â””â”€â”€ FlowRow
    â”‚               â”œâ”€â”€ ConfirmedTag
    â”‚               â””â”€â”€ GuessedTag
    â””â”€â”€ DataVaultTab (ç•Œé¢å››ï¼šèµ„æ–™åº“)
        â””â”€â”€ LazyVerticalGrid
            â””â”€â”€ DataSourceCard
```



### 3.3 æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UIäº¤äº’æ•°æ®æµ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·æ“ä½œ (ç‚¹å‡»ã€æ»šåŠ¨ã€åˆ‡æ¢)
    â†“
ContactDetailScreen.onEvent()
    â†“
ContactDetailViewModel.onEvent()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶å¤„ç†åˆ†å‘                                                 â”‚
â”‚  - SwitchTab â†’ åˆ‡æ¢æ ‡ç­¾é¡µ                                   â”‚
â”‚  - SwitchViewMode â†’ åˆ‡æ¢è§†å›¾æ¨¡å¼                            â”‚
â”‚  - ToggleFilter â†’ åˆ‡æ¢ç­›é€‰æ¡ä»¶                              â”‚
â”‚  - ConfirmTag â†’ ç¡®è®¤AIæ¨æµ‹æ ‡ç­¾                              â”‚
â”‚  - RejectTag â†’ é©³å›AIæ¨æµ‹æ ‡ç­¾                               â”‚
â”‚  - RefreshData â†’ åˆ·æ–°æ•°æ®                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Repositoryå±‚æ•°æ®æ“ä½œ                                         â”‚
â”‚  - ContactRepository.updateProfile()                        â”‚
â”‚  - ConversationRepository.getConversations()                â”‚
â”‚  - DailySummaryRepository.getSummaries()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´æ–°UiState                                                  â”‚
â”‚  _uiState.update { it.copy(...) }                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UIé‡ç»„                                                       â”‚
â”‚  ContactDetailScreen observes uiState                       â”‚
â”‚  â†’ è§¦å‘Composeé‡ç»„                                          â”‚
â”‚  â†’ æ›´æ–°ç•Œé¢æ˜¾ç¤º                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®åŠ è½½æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ContactDetailScreenå¯åŠ¨
    â†“
ContactDetailViewModel.init {}
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¹¶è¡ŒåŠ è½½æ•°æ®                                                 â”‚
â”‚  async { contactRepository.getProfile(contactId) }          â”‚
â”‚  async { conversationRepository.getConversations() }        â”‚
â”‚  async { dailySummaryRepository.getSummaries() }            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®å¤„ç†                                                     â”‚
â”‚  - æ„å»ºTimelineItems                                        â”‚
â”‚  - ç­›é€‰TopTags                                              â”‚
â”‚  - è·å–LatestFact                                           â”‚
â”‚  - æ£€æµ‹æƒ…ç»ªç±»å‹                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´æ–°UiState                                                  â”‚
â”‚  _uiState.update {                                          â”‚
â”‚    it.copy(                                                 â”‚
â”‚      contact = contact,                                     â”‚
â”‚      conversations = conversations,                         â”‚
â”‚      summaries = summaries,                                 â”‚
â”‚      timelineItems = timelineItems,                         â”‚
â”‚      isLoading = false                                      â”‚
â”‚    )                                                        â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
UIæ˜¾ç¤ºæ•°æ®
```



## 4. æ ¸å¿ƒç±»è®¾è®¡

### 4.1 Presentationå±‚æ ¸å¿ƒç±»

#### 4.1.1 ContactDetailViewModel

```kotlin
/**
 * è”ç³»äººè¯¦æƒ…ViewModel
 *
 * èŒè´£ï¼š
 * - ç®¡ç†è”ç³»äººè¯¦æƒ…é¡µçš„UIçŠ¶æ€
 * - å¤„ç†ç”¨æˆ·äº¤äº’äº‹ä»¶
 * - åè°ƒæ•°æ®åŠ è½½å’Œæ›´æ–°
 * - æ„å»ºæ—¶é—´çº¿æ•°æ®
 */
@HiltViewModel
class ContactDetailViewModel @Inject constructor(
    private val contactRepository: ContactRepository,
    private val conversationRepository: ConversationRepository,
    private val dailySummaryRepository: DailySummaryRepository,
    savedStateHandle: SavedStateHandle
) : ViewModel() {
    
    // ä»å¯¼èˆªå‚æ•°è·å–è”ç³»äººID
    private val contactId: String = savedStateHandle["contactId"] ?: ""
    
    // UIçŠ¶æ€
    private val _uiState = MutableStateFlow(ContactDetailUiState())
    val uiState: StateFlow<ContactDetailUiState> = _uiState.asStateFlow()
    
    init {
        loadContactDetail()
    }
    
    /**
     * å¤„ç†UIäº‹ä»¶
     */
    fun onEvent(event: ContactDetailUiEvent) {
        when (event) {
            is ContactDetailUiEvent.SwitchTab -> switchTab(event.tab)
            is ContactDetailUiEvent.SwitchViewMode -> switchViewMode(event.mode)
            is ContactDetailUiEvent.ToggleFilter -> toggleFilter(event.filter)
            is ContactDetailUiEvent.ConfirmTag -> confirmTag(event.factId)
            is ContactDetailUiEvent.RejectTag -> rejectTag(event.factId)
            is ContactDetailUiEvent.RefreshData -> loadContactDetail()
        }
    }
    
    /**
     * åŠ è½½è”ç³»äººè¯¦æƒ…æ•°æ®
     */
    private fun loadContactDetail() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            
            try {
                // å¹¶è¡ŒåŠ è½½æ•°æ®
                val contactDeferred = async { 
                    contactRepository.getProfile(contactId) 
                }
                val conversationsDeferred = async { 
                    conversationRepository.getConversationsByContact(contactId).first() 
                }
                val summariesDeferred = async { 
                    dailySummaryRepository.getSummariesByContact(contactId).first() 
                }
                
                val contact = contactDeferred.await().getOrNull()
                val conversations = conversationsDeferred.await()
                val summaries = summariesDeferred.await()
                
                _uiState.update {
                    it.copy(
                        contact = contact,
                        conversations = conversations,
                        summaries = summaries,
                        facts = contact?.facts ?: emptyList(),
                        topTags = contact?.facts
                            ?.sortedByDescending { fact -> fact.confidence }
                            ?.take(5) ?: emptyList(),
                        latestFact = contact?.facts
                            ?.maxByOrNull { fact -> fact.timestamp },
                        timelineItems = buildTimelineItems(conversations, summaries),
                        isLoading = false
                    )
                }
            } catch (e: Exception) {
                _uiState.update {
                    it.copy(
                        isLoading = false,
                        error = e.message
                    )
                }
            }
        }
    }
    
    /**
     * æ„å»ºæ—¶é—´çº¿æ•°æ®
     */
    private fun buildTimelineItems(
        conversations: List<ConversationLog>,
        summaries: List<DailySummary>
    ): List<TimelineItem> {
        val items = mutableListOf<TimelineItem>()
        
        // æ·»åŠ å¯¹è¯è®°å½•
        conversations.forEach { log ->
            items.add(
                TimelineItem.Conversation(
                    id = "conv_${log.id}",
                    timestamp = log.timestamp,
                    emotionType = detectEmotion(log),
                    log = log
                )
            )
        }
        
        // æ·»åŠ æ¯æ—¥æ€»ç»“
        summaries.forEach { summary ->
            items.add(
                TimelineItem.AiSummary(
                    id = "summary_${summary.id}",
                    timestamp = summary.createdAt,
                    emotionType = EmotionType.NEUTRAL,
                    summary = summary
                )
            )
        }
        
        // æŒ‰æ—¶é—´å€’åºæ’åº
        return items.sortedByDescending { it.timestamp }
    }
    
    /**
     * æ£€æµ‹æƒ…ç»ªç±»å‹
     */
    private fun detectEmotion(log: ConversationLog): EmotionType {
        val text = log.userInput + (log.aiResponse ?: "")
        return when {
            text.contains("çˆ±") || text.contains("å–œæ¬¢") -> EmotionType.SWEET
            text.contains("ç”Ÿæ°”") || text.contains("åµæ¶") -> EmotionType.CONFLICT
            text.contains("ç¤¼ç‰©") || text.contains("é€") -> EmotionType.GIFT
            text.contains("åƒé¥­") || text.contains("çº¦ä¼š") -> EmotionType.DATE
            else -> EmotionType.NEUTRAL
        }
    }
    
    /**
     * ç¡®è®¤AIæ¨æµ‹æ ‡ç­¾
     */
    private fun confirmTag(factId: Long) {
        viewModelScope.launch {
            val updatedFacts = _uiState.value.facts.map { fact ->
                if (fact.timestamp == factId) {
                    fact.copy(source = "MANUAL", confidence = 1.0f)
                } else {
                    fact
                }
            }
            
            val updatedContact = _uiState.value.contact?.copy(facts = updatedFacts)
            if (updatedContact != null) {
                contactRepository.updateProfile(updatedContact)
                _uiState.update { it.copy(facts = updatedFacts) }
            }
        }
    }
    
    /**
     * é©³å›AIæ¨æµ‹æ ‡ç­¾
     */
    private fun rejectTag(factId: Long) {
        viewModelScope.launch {
            val updatedFacts = _uiState.value.facts.filter { it.timestamp != factId }
            val updatedContact = _uiState.value.contact?.copy(facts = updatedFacts)
            
            if (updatedContact != null) {
                contactRepository.updateProfile(updatedContact)
                _uiState.update { it.copy(facts = updatedFacts) }
            }
        }
    }
    
    // å…¶ä»–ç§æœ‰æ–¹æ³•...
}
```

#### 4.1.2 ContactDetailUiState

```kotlin
/**
 * è”ç³»äººè¯¦æƒ…UIçŠ¶æ€
 *
 * åŒ…å«æ‰€æœ‰ç•Œé¢éœ€è¦çš„æ•°æ®
 */
data class ContactDetailUiState(
    // åŸºç¡€æ•°æ®
    val contact: ContactProfile? = null,
    val conversations: List<ConversationLog> = emptyList(),
    val summaries: List<DailySummary> = emptyList(),
    val facts: List<Fact> = emptyList(),
    
    // ç•Œé¢ä¸€ï¼šæ¦‚è§ˆ
    val topTags: List<Fact> = emptyList(),
    val latestFact: Fact? = null,
    
    // ç•Œé¢äºŒï¼šäº‹å®æµ
    val currentTab: DetailTab = DetailTab.Overview,
    val viewMode: ViewMode = ViewMode.Timeline,
    val selectedFilters: Set<FilterType> = emptySet(),
    val timelineItems: List<TimelineItem> = emptyList(),
    
    // çŠ¶æ€
    val isLoading: Boolean = false,
    val error: String? = null
)

/**
 * è¯¦æƒ…é¡µæ ‡ç­¾é¡µæšä¸¾
 */
enum class DetailTab {
    Overview,      // æ¦‚è§ˆ
    FactStream,    // äº‹å®æµ
    Persona,       // æ ‡ç­¾ç”»åƒ
    DataVault      // èµ„æ–™åº“
}
```

#### 4.1.3 ContactDetailUiEvent

```kotlin
/**
 * è”ç³»äººè¯¦æƒ…UIäº‹ä»¶
 *
 * å¯†å°ç±»ï¼Œè¡¨ç¤ºæ‰€æœ‰å¯èƒ½çš„ç”¨æˆ·äº¤äº’
 */
sealed class ContactDetailUiEvent {
    /**
     * åˆ‡æ¢æ ‡ç­¾é¡µ
     */
    data class SwitchTab(val tab: DetailTab) : ContactDetailUiEvent()
    
    /**
     * åˆ‡æ¢è§†å›¾æ¨¡å¼ï¼ˆæ—¶å…‰è½´/æ¸…å•åˆ—è¡¨ï¼‰
     */
    data class SwitchViewMode(val mode: ViewMode) : ContactDetailUiEvent()
    
    /**
     * åˆ‡æ¢ç­›é€‰æ¡ä»¶
     */
    data class ToggleFilter(val filter: FilterType) : ContactDetailUiEvent()
    
    /**
     * ç¡®è®¤AIæ¨æµ‹æ ‡ç­¾
     */
    data class ConfirmTag(val factId: Long) : ContactDetailUiEvent()
    
    /**
     * é©³å›AIæ¨æµ‹æ ‡ç­¾
     */
    data class RejectTag(val factId: Long) : ContactDetailUiEvent()
    
    /**
     * åˆ·æ–°æ•°æ®
     */
    object RefreshData : ContactDetailUiEvent()
}
```



### 4.2 Repositoryæ¥å£è¯¦ç»†è®¾è®¡

#### 4.2.1 ContactRepository API

```kotlin
/**
 * è”ç³»äººä»“åº“æ¥å£
 *
 * æä¾›è”ç³»äººæ•°æ®çš„CRUDæ“ä½œå’ŒæŸ¥è¯¢åŠŸèƒ½
 */
interface ContactRepository {
    /**
     * è·å–è”ç³»äººè¯¦æƒ…
     *
     * @param contactId è”ç³»äººID
     * @return è”ç³»äººä¿¡æ¯ï¼Œå¤±è´¥è¿”å›é”™è¯¯
     */
    suspend fun getProfile(contactId: String): Result<ContactProfile>
    
    /**
     * è·å–è”ç³»äººè¯¦æƒ…Flow
     *
     * @param contactId è”ç³»äººID
     * @return è”ç³»äººä¿¡æ¯Flowï¼Œè‡ªåŠ¨æ›´æ–°
     */
    fun getProfileFlow(contactId: String): Flow<Result<ContactProfile>>
    
    /**
     * æ›´æ–°è”ç³»äººä¿¡æ¯
     *
     * @param profile è”ç³»äººä¿¡æ¯
     * @return æ“ä½œç»“æœ
     */
    suspend fun updateProfile(profile: ContactProfile): Result<Unit>
    
    /**
     * æ›´æ–°å…³ç³»åˆ†æ•°
     *
     * @param contactId è”ç³»äººID
     * @param newScore æ–°çš„å…³ç³»åˆ†æ•°ï¼ˆ0-100ï¼‰
     * @return æ“ä½œç»“æœ
     */
    suspend fun updateRelationshipScore(
        contactId: String,
        newScore: Int
    ): Result<Unit>
    
    /**
     * æ›´æ–°Factsåˆ—è¡¨
     *
     * @param contactId è”ç³»äººID
     * @param facts æ–°çš„Factsåˆ—è¡¨
     * @return æ“ä½œç»“æœ
     */
    suspend fun updateFacts(
        contactId: String,
        facts: List<Fact>
    ): Result<Unit>
    
    /**
     * æ‰¹é‡æ›´æ–°è”ç³»äººæ•°æ®ï¼ˆäº‹åŠ¡ï¼‰
     *
     * @param contactId è”ç³»äººID
     * @param facts æ–°çš„Factsåˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
     * @param relationshipScore æ–°çš„å…³ç³»åˆ†æ•°ï¼ˆå¯é€‰ï¼‰
     * @param lastInteractionDate æœ€åäº’åŠ¨æ—¥æœŸï¼ˆå¯é€‰ï¼‰
     * @return æ“ä½œç»“æœ
     */
    suspend fun updateContactData(
        contactId: String,
        facts: List<Fact>? = null,
        relationshipScore: Int? = null,
        lastInteractionDate: String? = null
    ): Result<Unit>
}
```

#### 4.2.2 ConversationRepository API

```kotlin
/**
 * å¯¹è¯è®°å½•ä»“åº“æ¥å£
 */
interface ConversationRepository {
    /**
     * è·å–æŒ‡å®šè”ç³»äººçš„å¯¹è¯è®°å½•
     *
     * @param contactId è”ç³»äººID
     * @return å¯¹è¯è®°å½•Flow
     */
    fun getConversationsByContact(contactId: String): Flow<List<ConversationLog>>
    
    /**
     * è·å–æŒ‡å®šè”ç³»äººçš„å¯¹è¯è®°å½•ï¼ˆåˆ†é¡µï¼‰
     *
     * @param contactId è”ç³»äººID
     * @param limit æ¯é¡µæ•°é‡
     * @param offset åç§»é‡
     * @return å¯¹è¯è®°å½•åˆ—è¡¨
     */
    suspend fun getConversationsByContactPaged(
        contactId: String,
        limit: Int,
        offset: Int
    ): Result<List<ConversationLog>>
    
    /**
     * ä¿å­˜å¯¹è¯è®°å½•
     *
     * @param log å¯¹è¯è®°å½•
     * @return ä¿å­˜çš„è®°å½•ID
     */
    suspend fun saveConversation(log: ConversationLog): Result<Long>
    
    /**
     * åˆ é™¤å¯¹è¯è®°å½•
     *
     * @param logId è®°å½•ID
     * @return æ“ä½œç»“æœ
     */
    suspend fun deleteConversation(logId: Long): Result<Unit>
}
```

#### 4.2.3 DailySummaryRepository API

```kotlin
/**
 * æ¯æ—¥æ€»ç»“ä»“åº“æ¥å£
 */
interface DailySummaryRepository {
    /**
     * è·å–æŒ‡å®šè”ç³»äººçš„æ€»ç»“åˆ—è¡¨
     *
     * @param contactId è”ç³»äººID
     * @return æ€»ç»“åˆ—è¡¨Flow
     */
    fun getSummariesByContact(contactId: String): Flow<List<DailySummary>>
    
    /**
     * ä¿å­˜æ¯æ—¥æ€»ç»“
     *
     * @param summary æ€»ç»“å¯¹è±¡
     * @return ä¿å­˜çš„æ€»ç»“ID
     */
    suspend fun saveSummary(summary: DailySummary): Result<Long>
    
    /**
     * è·å–æŒ‡å®šæ—¥æœŸçš„æ€»ç»“
     *
     * @param contactId è”ç³»äººID
     * @param date æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆyyyy-MM-ddï¼‰
     * @return æ€»ç»“å¯¹è±¡ï¼Œä¸å­˜åœ¨åˆ™è¿”å›null
     */
    suspend fun getSummaryByDate(
        contactId: String,
        date: String
    ): Result<DailySummary?>
}
```

#### 4.2.4 ç»Ÿä¸€é”™è¯¯å¤„ç†

```kotlin
/**
 * ç»Ÿä¸€é”™è¯¯ç å®šä¹‰
 */
object ErrorCodes {
    const val NETWORK_ERROR = 1001
    const val DATABASE_ERROR = 1002
    const val VALIDATION_ERROR = 1003
    const val NOT_FOUND = 1004
    const val PERMISSION_DENIED = 1005
    const val UNKNOWN_ERROR = 9999
}

/**
 * ç»Ÿä¸€é”™è¯¯ç±»å‹
 */
sealed class AppError : Exception() {
    data class NetworkError(override val message: String) : AppError()
    data class DatabaseError(override val message: String) : AppError()
    data class ValidationError(override val message: String) : AppError()
    data class NotFoundError(override val message: String) : AppError()
    data class PermissionError(override val message: String) : AppError()
    data class UnknownError(override val message: String) : AppError()
}

/**
 * é”™è¯¯å¤„ç†æ‰©å±•å‡½æ•°
 */
fun <T> Result<T>.mapError(): Result<T> {
    return this.onFailure { error ->
        when (error) {
            is IOException -> AppError.NetworkError(error.message ?: "ç½‘ç»œé”™è¯¯")
            is SQLException -> AppError.DatabaseError(error.message ?: "æ•°æ®åº“é”™è¯¯")
            is IllegalArgumentException -> AppError.ValidationError(error.message ?: "å‚æ•°é”™è¯¯")
            else -> AppError.UnknownError(error.message ?: "æœªçŸ¥é”™è¯¯")
        }
    }
}
```

### 4.3 Domainå±‚æ•°æ®æ¨¡å‹

#### 4.2.1 TimelineItem

```kotlin
/**
 * æ—¶é—´çº¿é¡¹ç›®å¯†å°ç±»
 *
 * è¡¨ç¤ºæ—¶é—´çº¿ä¸Šçš„ä¸åŒç±»å‹å†…å®¹
 */
sealed class TimelineItem {
    abstract val id: String
    abstract val timestamp: Long
    abstract val emotionType: EmotionType
    
    /**
     * å›¾æ–‡æ—¶åˆ»
     */
    data class PhotoMoment(
        override val id: String,
        override val timestamp: Long,
        override val emotionType: EmotionType,
        val photoUrl: String,
        val description: String
    ) : TimelineItem()
    
    /**
     * AIæ€»ç»“
     */
    data class AiSummary(
        override val id: String,
        override val timestamp: Long,
        override val emotionType: EmotionType,
        val summary: DailySummary
    ) : TimelineItem()
    
    /**
     * é‡Œç¨‹ç¢‘äº‹ä»¶
     */
    data class Milestone(
        override val id: String,
        override val timestamp: Long,
        override val emotionType: EmotionType,
        val title: String,
        val description: String,
        val icon: String
    ) : TimelineItem()
    
    /**
     * å¯¹è¯è®°å½•
     */
    data class Conversation(
        override val id: String,
        override val timestamp: Long,
        override val emotionType: EmotionType,
        val log: ConversationLog
    ) : TimelineItem()
}
```

#### 4.2.2 EmotionType

```kotlin
/**
 * æƒ…ç»ªç±»å‹æšä¸¾
 *
 * ç”¨äºæ—¶é—´çº¿èŠ‚ç‚¹çš„æƒ…ç»ªå¯è§†åŒ–
 */
enum class EmotionType(val emoji: String, val displayName: String) {
    SWEET("â¤ï¸", "ç”œèœœ"),
    CONFLICT("â›ˆï¸", "å†²çª"),
    GIFT("ğŸ", "ç¤¼ç‰©"),
    DATE("ğŸ½ï¸", "çº¦ä¼š"),
    DEEP_TALK("ğŸ’¬", "æ·±åº¦å¯¹è¯"),
    NEUTRAL("â­•", "æ™®é€š")
}
```

#### 4.2.3 ViewMode

```kotlin
/**
 * è§†å›¾æ¨¡å¼æšä¸¾
 *
 * äº‹å®æµçš„ä¸¤ç§å±•ç¤ºæ¨¡å¼
 */
enum class ViewMode {
    Timeline,  // æ—¶å…‰è½´ï¼ˆç€‘å¸ƒæµï¼‰
    List       // æ¸…å•åˆ—è¡¨
}
```

#### 4.2.4 FilterType

```kotlin
/**
 * ç­›é€‰ç±»å‹æšä¸¾
 *
 * ç”¨äºäº‹å®æµçš„å¿«é€Ÿç­›é€‰
 */
enum class FilterType(
    val displayName: String,
    val icon: ImageVector
) {
    AI_SUMMARY("åªçœ‹AI", Icons.Default.Psychology),
    CONFLICT("åªçœ‹å†²çª", Icons.Default.Warning),
    DATE("åªçœ‹çº¦ä¼š", Icons.Default.Restaurant),
    ALL("å…¨éƒ¨", Icons.Default.FilterList)
}
```

#### 4.2.5 DataStatus

```kotlin
/**
 * æ•°æ®çŠ¶æ€æšä¸¾
 *
 * ç”¨äºèµ„æ–™åº“çš„çŠ¶æ€è§’æ ‡
 */
enum class DataStatus {
    COMPLETED,      // å·²å®Œæˆ
    PROCESSING,     // å¤„ç†ä¸­
    FAILED,         // å¤±è´¥
    NOT_AVAILABLE   // ä¸å¯ç”¨
}
```



## 5. UIç»„ä»¶è®¾è®¡

### 5.1 å…¨å±€è®¾è®¡ç³»ç»Ÿç»„ä»¶

#### 5.1.1 EmotionalBackground

```kotlin
/**
 * æƒ…æ„ŸåŒ–èƒŒæ™¯ç»„ä»¶
 *
 * èŒè´£ï¼š
 * - æ ¹æ®å…³ç³»åˆ†æ•°ç”ŸæˆåŠ¨æ€æ¸å˜èƒŒæ™¯
 * - æ”¯æŒé¢œè‰²å¹³æ»‘è¿‡æ¸¡åŠ¨ç”»
 * - æä¾›å¾„å‘æ¸å˜æ•ˆæœ
 *
 * æŠ€æœ¯è¦ç‚¹ï¼š
 * - ä½¿ç”¨rememberç¼“å­˜é¢œè‰²è®¡ç®—
 * - ä½¿ç”¨animateColorAsStateå®ç°å¹³æ»‘è¿‡æ¸¡
 * - é¿å…æ¯æ¬¡é‡ç»„æ—¶é‡æ–°è®¡ç®—
 */
@Composable
fun EmotionalBackground(
    relationshipScore: Int,
    modifier: Modifier = Modifier
) {
    // æ ¹æ®åˆ†æ•°é€‰æ‹©é¢œè‰²
    val backgroundColor = remember(relationshipScore) {
        when {
            relationshipScore >= 81 -> RelationshipColors.Excellent
            relationshipScore >= 61 -> RelationshipColors.Good
            relationshipScore >= 31 -> RelationshipColors.Normal
            else -> RelationshipColors.Poor
        }
    }
    
    // åŠ¨ç”»è¿‡æ¸¡
    val animatedColors = backgroundColor.map { color ->
        animateColorAsState(
            targetValue = color,
            animationSpec = tween(durationMillis = 1000)
        ).value
    }
    
    Box(
        modifier = modifier
            .fillMaxSize()
            .background(
                Brush.radialGradient(
                    colors = animatedColors,
                    center = Offset(0.5f, 0.3f),
                    radius = 1000f
                )
            )
    )
}

/**
 * å…³ç³»åˆ†æ•°é¢œè‰²æ˜ å°„
 */
object RelationshipColors {
    val Excellent = listOf(Color(0xFFFF6B9D), Color(0xFFFFA06B))
    val Good = listOf(Color(0xFFFFC371), Color(0xFF7FD8BE))
    val Normal = listOf(Color(0xFF89B5E0), Color(0xFFB8C5D6))
    val Poor = listOf(Color(0xFF6B8CAE), Color(0xFF8B9DAF))
}
```

#### 5.1.2 GlassmorphicCard

```kotlin
/**
 * ç£¨ç ‚ç»ç’ƒå¡ç‰‡ç»„ä»¶
 *
 * èŒè´£ï¼š
 * - æä¾›åŠé€æ˜ç£¨ç ‚ç»ç’ƒæ•ˆæœ
 * - æ”¯æŒç‚¹å‡»äº¤äº’
 * - æä¾›ç™½è‰²è¾¹æ¡†å…‰æ™•
 *
 * æŠ€æœ¯è¦ç‚¹ï¼š
 * - ä½¿ç”¨Surfaceå®ç°åœ†è§’å’Œé˜´å½±
 * - ä½¿ç”¨Brushå®ç°æ¸å˜å…‰æ™•
 * - æ”¯æŒå¯é€‰çš„ç‚¹å‡»äº‹ä»¶
 */
@Composable
fun GlassmorphicCard(
    modifier: Modifier = Modifier,
    backgroundColor: Color = MaterialTheme.colorScheme.surface.copy(alpha = 0.7f),
    borderColor: Color = Color.White.copy(alpha = 0.2f),
    onClick: (() -> Unit)? = null,
    content: @Composable () -> Unit
) {
    val interactionSource = remember { MutableInteractionSource() }
    
    Surface(
        modifier = modifier.then(
            if (onClick != null) {
                Modifier.clickable(
                    interactionSource = interactionSource,
                    indication = rememberRipple(),
                    onClick = onClick
                )
            } else Modifier
        ),
        shape = RoundedCornerShape(16.dp),
        color = backgroundColor,
        border = BorderStroke(width = 1.dp, color = borderColor),
        shadowElevation = 8.dp
    ) {
        Box(
            modifier = Modifier.background(
                Brush.verticalGradient(
                    colors = listOf(
                        Color.White.copy(alpha = 0.1f),
                        Color.Transparent
                    )
                )
            )
        ) {
            content()
        }
    }
}
```

#### 5.1.3 SegmentedControl

```kotlin
/**
 * åˆ†æ®µæ§åˆ¶å™¨ç»„ä»¶
 *
 * èŒè´£ï¼š
 * - æä¾›å¤šé€‰é¡¹åˆ‡æ¢æ§ä»¶
 * - æ”¯æŒé€‰ä¸­çŠ¶æ€åŠ¨ç”»
 * - Material Design 3é£æ ¼
 *
 * æŠ€æœ¯è¦ç‚¹ï¼š
 * - ä½¿ç”¨Surfaceå®ç°åœ†è§’èƒŒæ™¯
 * - ä½¿ç”¨åŠ¨ç”»å®ç°å¹³æ»‘åˆ‡æ¢
 * - æ”¯æŒè‡ªå®šä¹‰é€‰é¡¹åˆ—è¡¨
 */
@Composable
fun SegmentedControl(
    items: List<String>,
    selectedIndex: Int,
    onItemSelected: (Int) -> Unit,
    modifier: Modifier = Modifier
) {
    Surface(
        modifier = modifier,
        shape = RoundedCornerShape(12.dp),
        color = MaterialTheme.colorScheme.surfaceVariant
    ) {
        Row(modifier = Modifier.padding(4.dp)) {
            items.forEachIndexed { index, item ->
                val isSelected = index == selectedIndex
                Surface(
                    modifier = Modifier
                        .weight(1f)
                        .clickable { onItemSelected(index) },
                    shape = RoundedCornerShape(8.dp),
                    color = if (isSelected) {
                        MaterialTheme.colorScheme.primary
                    } else {
                        Color.Transparent
                    }
                ) {
                    Text(
                        text = item,
                        modifier = Modifier.padding(
                            vertical = 8.dp,
                            horizontal = 16.dp
                        ),
                        textAlign = TextAlign.Center,
                        style = MaterialTheme.typography.labelLarge,
                        color = if (isSelected) {
                            MaterialTheme.colorScheme.onPrimary
                        } else {
                            MaterialTheme.colorScheme.onSurfaceVariant
                        }
                    )
                }
            }
        }
    }
}
```

### 5.2 ç•Œé¢ä¸€ï¼šæ¦‚è§ˆç»„ä»¶

#### 5.2.1 DynamicEmotionalHeader

```kotlin
/**
 * åŠ¨æ€æƒ…æ„Ÿå¤´éƒ¨ç»„ä»¶
 *
 * èŒè´£ï¼š
 * - æ˜¾ç¤ºè”ç³»äººå¤´åƒã€å§“åã€ç›¸è¯†æ—¶é•¿
 * - æ ¹æ®æ»šåŠ¨çŠ¶æ€åŠ¨æ€æ”¶ç¼©
 * - èƒŒæ™¯å…‰æ™•éšæ»šåŠ¨æ·¡åŒ–
 *
 * æŠ€æœ¯è¦ç‚¹ï¼š
 * - ä½¿ç”¨derivedStateOfç›‘å¬æ»šåŠ¨çŠ¶æ€
 * - ä½¿ç”¨lerpå®ç°å¹³æ»‘æ’å€¼
 * - é«˜åº¦å’Œé€æ˜åº¦åŒæ­¥å˜åŒ–
 */
@Composable
fun DynamicEmotionalHeader(
    contact: ContactProfile,
    scrollState: LazyListState,
    modifier: Modifier = Modifier
) {
    // è®¡ç®—å¤´éƒ¨é«˜åº¦
    val headerHeight by remember {
        derivedStateOf {
            val offset = scrollState.firstVisibleItemScrollOffset.toFloat()
            val maxScroll = 200f
            val progress = (offset / maxScroll).coerceIn(0f, 1f)
            
            lerp(
                start = Dimensions.HeaderHeightExpanded.value,
                stop = Dimensions.HeaderHeightCollapsed.value,
                fraction = progress
            ).dp
        }
    }
    
    // è®¡ç®—å¤´åƒå¤§å°
    val avatarSize by remember {
        derivedStateOf {
            val offset = scrollState.firstVisibleItemScrollOffset.toFloat()
            val maxScroll = 200f
            val progress = (offset / maxScroll).coerceIn(0f, 1f)
            
            lerp(
                start = Dimensions.AvatarSizeLarge.value,
                stop = Dimensions.AvatarSizeSmall.value,
                fraction = progress
            ).dp
        }
    }
    
    // è®¡ç®—èƒŒæ™¯é€æ˜åº¦
    val backgroundAlpha by remember {
        derivedStateOf {
            val offset = scrollState.firstVisibleItemScrollOffset.toFloat()
            val maxScroll = 200f
            val progress = (offset / maxScroll).coerceIn(0f, 1f)
            
            1f - progress
        }
    }
    
    Box(
        modifier = modifier
            .fillMaxWidth()
            .height(headerHeight)
            .background(
                Brush.verticalGradient(
                    colors = getEmotionalColors(contact.relationshipScore)
                        .map { it.copy(alpha = backgroundAlpha) }
                )
            )
    ) {
        Row(
            modifier = Modifier
                .fillMaxSize()
                .padding(16.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // å¤´åƒ
            AsyncImage(
                model = contact.avatarUrl,
                contentDescription = "å¤´åƒ",
                modifier = Modifier
                    .size(avatarSize)
                    .clip(CircleShape)
            )
            
            // å§“åå’Œç›¸è¯†æ—¶é•¿
            Column {
                Text(
                    text = contact.name,
                    style = MaterialTheme.typography.headlineMedium,
                    color = Color.White
                )
                
                if (headerHeight > Dimensions.HeaderHeightCollapsed) {
                    Text(
                        text = "å·²ç›¸è¯† ${getDaysSince(contact.createdAt)} å¤©",
                        style = MaterialTheme.typography.bodyMedium,
                        color = Color.White.copy(alpha = 0.8f)
                    )
                }
            }
        }
    }
}

/**
 * å°ºå¯¸å¸¸é‡
 */
object Dimensions {
    val HeaderHeightExpanded = 200.dp
    val HeaderHeightCollapsed = 56.dp
    val AvatarSizeLarge = 120.dp
    val AvatarSizeSmall = 40.dp
}
```



### 5.3 ç•Œé¢äºŒï¼šäº‹å®æµç»„ä»¶

#### 5.3.1 EmotionalTimelineNode

```kotlin
/**
 * æƒ…ç»ªæ—¶é—´çº¿èŠ‚ç‚¹ç»„ä»¶
 *
 * èŒè´£ï¼š
 * - æ˜¾ç¤ºæƒ…ç»ªEmojièŠ‚ç‚¹
 * - æä¾›åœ†å½¢èƒŒæ™¯å’Œè¾¹æ¡†
 * - æ ¹æ®æƒ…ç»ªç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡
 *
 * æŠ€æœ¯è¦ç‚¹ï¼š
 * - ä½¿ç”¨Boxå®ç°åœ†å½¢å®¹å™¨
 * - ä½¿ç”¨borderå®ç°è¾¹æ¡†å…‰æ™•
 * - æ”¯æŒè‡ªå®šä¹‰æƒ…ç»ªç±»å‹
 */
@Composable
fun EmotionalTimelineNode(
    emotion: EmotionType,
    modifier: Modifier = Modifier
) {
    Box(
        modifier = modifier
            .size(32.dp)
            .background(
                color = MaterialTheme.colorScheme.surface.copy(alpha = 0.9f),
                shape = CircleShape
            )
            .border(
                width = 2.dp,
                color = MaterialTheme.colorScheme.primary.copy(alpha = 0.3f),
                shape = CircleShape
            ),
        contentAlignment = Alignment.Center
    ) {
        Text(
            text = emotion.emoji,
            fontSize = 16.sp
        )
    }
}
```

#### 5.3.2 TimelineView

```kotlin
/**
 * æ—¶å…‰è½´è§†å›¾ç»„ä»¶
 *
 * èŒè´£ï¼š
 * - ç€‘å¸ƒæµå¸ƒå±€å±•ç¤ºæ—¶é—´çº¿é¡¹ç›®
 * - æ”¯æŒä¸åŒç±»å‹çš„å¡ç‰‡
 * - ä¼˜åŒ–åˆ—è¡¨æ€§èƒ½
 *
 * æŠ€æœ¯è¦ç‚¹ï¼š
 * - ä½¿ç”¨LazyVerticalStaggeredGridå®ç°ç€‘å¸ƒæµ
 * - ä½¿ç”¨keyå‚æ•°ä¼˜åŒ–é‡ç»„
 * - æ”¯æŒå¤šç§å¡ç‰‡ç±»å‹
 */
@Composable
fun TimelineView(
    items: List<TimelineItem>,
    modifier: Modifier = Modifier
) {
    LazyVerticalStaggeredGrid(
        columns = StaggeredGridCells.Fixed(2),
        modifier = modifier.fillMaxSize(),
        contentPadding = PaddingValues(16.dp),
        horizontalArrangement = Arrangement.spacedBy(12.dp),
        verticalItemSpacing = 12.dp
    ) {
        items(
            items = items,
            key = { it.id }
        ) { item ->
            TimelineItemCard(item)
        }
    }
}

@Composable
fun TimelineItemCard(item: TimelineItem) {
    Column {
        // æƒ…ç»ªèŠ‚ç‚¹
        EmotionalTimelineNode(item.emotionType)
        
        Spacer(modifier = Modifier.height(8.dp))
        
        // å¡ç‰‡å†…å®¹
        when (item) {
            is TimelineItem.PhotoMoment -> PhotoMomentCard(item)
            is TimelineItem.AiSummary -> AiSummaryCard(item.summary)
            is TimelineItem.Milestone -> MilestoneCard(item)
            is TimelineItem.Conversation -> ConversationCard(item.log)
        }
    }
}
```

#### 5.3.3 ListView

```kotlin
/**
 * æ¸…å•åˆ—è¡¨è§†å›¾ç»„ä»¶
 *
 * èŒè´£ï¼š
 * - åˆ—è¡¨å½¢å¼å±•ç¤ºå¯¹è¯è®°å½•
 * - æ”¯æŒå¿«é€Ÿç­›é€‰
 * - é«˜ä¿¡æ¯å¯†åº¦å±•ç¤º
 *
 * æŠ€æœ¯è¦ç‚¹ï¼š
 * - ä½¿ç”¨LazyColumnå®ç°åˆ—è¡¨
 * - ä½¿ç”¨keyå‚æ•°ä¼˜åŒ–æ€§èƒ½
 * - æ”¯æŒç­›é€‰åŠŸèƒ½
 */
@Composable
fun ListView(
    conversations: List<ConversationLog>,
    selectedFilters: Set<FilterType>,
    onFilterToggle: (FilterType) -> Unit,
    modifier: Modifier = Modifier
) {
    Column(modifier = modifier.fillMaxSize()) {
        // å¿«é€Ÿç­›é€‰
        QuickFilterChips(
            selectedFilters = selectedFilters,
            onFilterToggle = onFilterToggle
        )
        
        // åˆ—è¡¨
        LazyColumn(
            contentPadding = PaddingValues(vertical = 8.dp)
        ) {
            items(
                items = conversations,
                key = { it.id }
            ) { log ->
                ListViewRow(log)
                Divider()
            }
        }
    }
}

@Composable
fun ListViewRow(log: ConversationLog) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .clickable { /* æŸ¥çœ‹è¯¦æƒ… */ }
            .padding(horizontal = 16.dp, vertical = 12.dp),
        horizontalArrangement = Arrangement.spacedBy(12.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        // å·¦ä¾§ï¼šæ—¥æœŸ
        Text(
            text = formatDate(log.timestamp, "MM-DD"),
            style = MaterialTheme.typography.labelMedium,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
            modifier = Modifier.width(48.dp)
        )
        
        // ä¸­é—´ï¼šå›¾æ ‡ + æ ‡é¢˜
        Row(
            modifier = Modifier.weight(1f),
            horizontalArrangement = Arrangement.spacedBy(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(
                imageVector = Icons.Default.Chat,
                contentDescription = null,
                modifier = Modifier.size(20.dp),
                tint = MaterialTheme.colorScheme.primary
            )
            Text(
                text = log.userInput.take(30) + "...",
                style = MaterialTheme.typography.bodyMedium,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
        }
        
        // å³ä¾§ï¼šæ ‡ç­¾
        if (log.isSummarized) {
            Chip(
                text = "å·²æ€»ç»“",
                backgroundColor = MaterialTheme.colorScheme.primaryContainer,
                textColor = MaterialTheme.colorScheme.onPrimaryContainer
            )
        }
    }
}
```

### 5.4 ç•Œé¢ä¸‰ï¼šæ ‡ç­¾ç”»åƒç»„ä»¶

#### 5.4.1 ConfirmedTag

```kotlin
/**
 * ç¡®è®¤æ ‡ç­¾ç»„ä»¶
 *
 * èŒè´£ï¼š
 * - æ˜¾ç¤ºç”¨æˆ·ç¡®è®¤çš„æ ‡ç­¾
 * - å®å¿ƒèƒŒæ™¯ + å¯¹å‹¾å›¾æ ‡
 * - é«˜é¥±å’Œåº¦é¢œè‰²
 *
 * æŠ€æœ¯è¦ç‚¹ï¼š
 * - ä½¿ç”¨Surfaceå®ç°åœ†è§’èƒŒæ™¯
 * - ä½¿ç”¨Iconæ˜¾ç¤ºå¯¹å‹¾
 * - æ”¯æŒè‡ªå®šä¹‰é¢œè‰²
 */
@Composable
fun ConfirmedTag(
    tag: Fact,
    modifier: Modifier = Modifier
) {
    Surface(
        modifier = modifier,
        shape = RoundedCornerShape(16.dp),
        color = MaterialTheme.colorScheme.primary,
        shadowElevation = 2.dp
    ) {
        Row(
            modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp),
            horizontalArrangement = Arrangement.spacedBy(4.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = tag.value,
                style = MaterialTheme.typography.labelMedium,
                color = MaterialTheme.colorScheme.onPrimary
            )
            Icon(
                imageVector = Icons.Default.Check,
                contentDescription = "å·²ç¡®è®¤",
                modifier = Modifier.size(14.dp),
                tint = MaterialTheme.colorScheme.onPrimary
            )
        }
    }
}
```

#### 5.4.2 GuessedTag

```kotlin
/**
 * æ¨æµ‹æ ‡ç­¾ç»„ä»¶
 *
 * èŒè´£ï¼š
 * - æ˜¾ç¤ºAIæ¨æµ‹çš„æ ‡ç­¾
 * - åŠé€æ˜èƒŒæ™¯ + é—®å·å›¾æ ‡
 * - å‘¼å¸åŠ¨æ•ˆ
 * - æ”¯æŒç¡®è®¤/é©³å›æ“ä½œ
 *
 * æŠ€æœ¯è¦ç‚¹ï¼š
 * - ä½¿ç”¨rememberInfiniteTransitionå®ç°å‘¼å¸åŠ¨æ•ˆ
 * - ä½¿ç”¨clickableæ”¯æŒç‚¹å‡»
 * - ä½¿ç”¨AlertDialogå®ç°ç¡®è®¤å¯¹è¯æ¡†
 */
@Composable
fun GuessedTag(
    tag: Fact,
    onConfirm: () -> Unit,
    onReject: () -> Unit,
    modifier: Modifier = Modifier
) {
    var showDialog by remember { mutableStateOf(false) }
    
    // å‘¼å¸åŠ¨æ•ˆ
    val infiniteTransition = rememberInfiniteTransition(label = "breathing")
    val alpha by infiniteTransition.animateFloat(
        initialValue = 0.6f,
        targetValue = 0.9f,
        animationSpec = infiniteRepeatable(
            animation = tween(2000, easing = LinearEasing),
            repeatMode = RepeatMode.Reverse
        ),
        label = "alpha"
    )
    
    Surface(
        modifier = modifier.clickable { showDialog = true },
        shape = RoundedCornerShape(16.dp),
        color = MaterialTheme.colorScheme.surfaceVariant.copy(alpha = alpha),
        border = BorderStroke(
            width = 1.dp,
            color = MaterialTheme.colorScheme.outline.copy(alpha = 0.5f)
        )
    ) {
        Row(
            modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp),
            horizontalArrangement = Arrangement.spacedBy(4.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = tag.value,
                style = MaterialTheme.typography.labelMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Icon(
                imageVector = Icons.Default.HelpOutline,
                contentDescription = "AIæ¨æµ‹",
                modifier = Modifier.size(14.dp),
                tint = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.6f)
            )
        }
    }
    
    if (showDialog) {
        TagConfirmationDialog(
            tag = tag,
            onConfirm = {
                onConfirm()
                showDialog = false
            },
            onReject = {
                onReject()
                showDialog = false
            },
            onDismiss = { showDialog = false }
        )
    }
}
```



## 6. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 6.1 åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–

#### 6.1.1 ä½¿ç”¨ç¨³å®šçš„keyå‚æ•°

```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¨³å®šçš„å”¯ä¸€æ ‡è¯†
LazyColumn {
    items(
        items = conversations,
        key = { it.id }  // ä½¿ç”¨æ•°æ®åº“IDä½œä¸ºkey
    ) { conversation ->
        ConversationCard(conversation)
    }
}

// âŒ é”™è¯¯ï¼šä½¿ç”¨ç´¢å¼•æˆ–ä¸ç¨³å®šçš„å€¼
LazyColumn {
    items(conversations) { conversation ->  // æ²¡æœ‰key
        ConversationCard(conversation)
    }
}
```

#### 6.1.2 ä½¿ç”¨contentTypeä¼˜åŒ–

```kotlin
// ä¸ºä¸åŒç±»å‹çš„itemæŒ‡å®šcontentType
LazyColumn {
    items(
        items = timelineItems,
        key = { it.id },
        contentType = { item ->
            when (item) {
                is TimelineItem.PhotoMoment -> "photo"
                is TimelineItem.AiSummary -> "summary"
                is TimelineItem.Milestone -> "milestone"
                is TimelineItem.Conversation -> "conversation"
            }
        }
    ) { item ->
        TimelineItemCard(item)
    }
}
```

#### 6.1.3 é¿å…åœ¨itemsä¸­åˆ›å»ºæ–°å¯¹è±¡

```kotlin
// âœ… æ­£ç¡®ï¼šåœ¨ViewModelä¸­é¢„å¤„ç†æ•°æ®
val timelineItems = buildTimelineItems(conversations, summaries)

LazyColumn {
    items(timelineItems) { item ->
        TimelineItemCard(item)
    }
}

// âŒ é”™è¯¯ï¼šåœ¨itemsä¸­åˆ›å»ºæ–°å¯¹è±¡
LazyColumn {
    items(conversations) { conversation ->
        TimelineItemCard(
            TimelineItem.Conversation(  // æ¯æ¬¡é‡ç»„éƒ½åˆ›å»ºæ–°å¯¹è±¡
                id = "conv_${conversation.id}",
                timestamp = conversation.timestamp,
                emotionType = detectEmotion(conversation),
                log = conversation
            )
        )
    }
}
```

### 6.2 åŠ¨ç”»æ€§èƒ½ä¼˜åŒ–

#### 6.2.1 é™åˆ¶åŒæ—¶è¿è¡Œçš„åŠ¨ç”»æ•°é‡

```kotlin
// åªåœ¨å¯è§åŒºåŸŸå¯ç”¨å‘¼å¸åŠ¨ç”»
@Composable
fun GuessedTag(
    tag: Fact,
    isVisible: Boolean,  // ç”±LazyColumnæä¾›
    onConfirm: () -> Unit,
    onReject: () -> Unit
) {
    val alpha = if (isVisible) {
        val infiniteTransition = rememberInfiniteTransition()
        infiniteTransition.animateFloat(
            initialValue = 0.6f,
            targetValue = 0.9f,
            animationSpec = infiniteRepeatable(
                animation = tween(2000),
                repeatMode = RepeatMode.Reverse
            )
        ).value
    } else {
        0.7f  // ä¸å¯è§æ—¶ä½¿ç”¨å›ºå®šå€¼
    }
    
    // ç»„ä»¶å†…å®¹...
}
```

#### 6.2.2 ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ

```kotlin
// ä¸ºå¤æ‚åŠ¨ç”»å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ
Box(
    modifier = Modifier
        .graphicsLayer {
            // ä½¿ç”¨graphicsLayerå¯ç”¨ç¡¬ä»¶åŠ é€Ÿ
            alpha = animatedAlpha
            scaleX = animatedScale
            scaleY = animatedScale
        }
)
```

### 6.3 æ•°æ®åŠ è½½ä¼˜åŒ–

#### 6.3.1 å¹¶è¡ŒåŠ è½½æ•°æ®

```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨asyncå¹¶è¡ŒåŠ è½½
private fun loadContactDetail() {
    viewModelScope.launch {
        _uiState.update { it.copy(isLoading = true) }
        
        try {
            // å¹¶è¡ŒåŠ è½½
            val contactDeferred = async { contactRepository.getProfile(contactId) }
            val conversationsDeferred = async { conversationRepository.getConversations() }
            val summariesDeferred = async { dailySummaryRepository.getSummaries() }
            
            // ç­‰å¾…æ‰€æœ‰ç»“æœ
            val contact = contactDeferred.await().getOrNull()
            val conversations = conversationsDeferred.await()
            val summaries = summariesDeferred.await()
            
            // æ›´æ–°UI
            _uiState.update { /* ... */ }
        } catch (e: Exception) {
            // é”™è¯¯å¤„ç†
        }
    }
}

// âŒ é”™è¯¯ï¼šä¸²è¡ŒåŠ è½½
private fun loadContactDetail() {
    viewModelScope.launch {
        val contact = contactRepository.getProfile(contactId).getOrNull()
        val conversations = conversationRepository.getConversations()  // ç­‰å¾…ä¸Šä¸€ä¸ªå®Œæˆ
        val summaries = dailySummaryRepository.getSummaries()  // ç­‰å¾…ä¸Šä¸€ä¸ªå®Œæˆ
    }
}
```

#### 6.3.2 ä½¿ç”¨Flowè‡ªåŠ¨æ›´æ–°

```kotlin
// ä½¿ç”¨Flowå®ç°æ•°æ®è‡ªåŠ¨æ›´æ–°
init {
    viewModelScope.launch {
        combine(
            contactRepository.getProfileFlow(contactId),
            conversationRepository.getConversationsFlow(contactId),
            dailySummaryRepository.getSummariesFlow(contactId)
        ) { contact, conversations, summaries ->
            Triple(contact, conversations, summaries)
        }.collect { (contact, conversations, summaries) ->
            _uiState.update {
                it.copy(
                    contact = contact.getOrNull(),
                    conversations = conversations,
                    summaries = summaries,
                    timelineItems = buildTimelineItems(conversations, summaries)
                )
            }
        }
    }
}
```

### 6.4 å†…å­˜ä¼˜åŒ–

#### 6.4.1 å›¾ç‰‡åŠ è½½ä¼˜åŒ–

```kotlin
// ä½¿ç”¨CoilåŠ è½½å›¾ç‰‡ï¼Œè‡ªåŠ¨å¤„ç†ç¼“å­˜å’Œå†…å­˜
AsyncImage(
    model = ImageRequest.Builder(LocalContext.current)
        .data(contact.avatarUrl)
        .crossfade(true)
        .size(120)  // æŒ‡å®šå°ºå¯¸ï¼Œé¿å…åŠ è½½è¿‡å¤§å›¾ç‰‡
        .build(),
    contentDescription = "å¤´åƒ",
    modifier = Modifier
        .size(120.dp)
        .clip(CircleShape)
)
```

#### 6.4.2 é¿å…å†…å­˜æ³„æ¼

```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨viewModelScope
class ContactDetailViewModel : ViewModel() {
    fun loadData() {
        viewModelScope.launch {  // è‡ªåŠ¨åœ¨ViewModelæ¸…é™¤æ—¶å–æ¶ˆ
            // åŠ è½½æ•°æ®
        }
    }
}

// âŒ é”™è¯¯ï¼šä½¿ç”¨GlobalScope
class ContactDetailViewModel : ViewModel() {
    fun loadData() {
        GlobalScope.launch {  // ä¸ä¼šè‡ªåŠ¨å–æ¶ˆï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
            // åŠ è½½æ•°æ®
        }
    }
}
```



## 7. æµ‹è¯•ç­–ç•¥

### 7.1 ViewModelå•å…ƒæµ‹è¯•

#### 7.1.1 æµ‹è¯•æ•°æ®åŠ è½½

```kotlin
@Test
fun `loadContactDetail should update uiState with contact data`() = runTest {
    // Given
    val mockContact = ContactProfile(
        id = "test_id",
        name = "æµ‹è¯•è”ç³»äºº",
        targetGoal = "æµ‹è¯•ç›®æ ‡",
        relationshipScore = 75
    )
    coEvery { contactRepository.getProfile("test_id") } returns Result.success(mockContact)
    coEvery { conversationRepository.getConversations() } returns emptyList()
    coEvery { dailySummaryRepository.getSummaries() } returns emptyList()
    
    val viewModel = ContactDetailViewModel(
        contactRepository,
        conversationRepository,
        dailySummaryRepository,
        savedStateHandle
    )
    
    // When
    advanceUntilIdle()
    
    // Then
    assertEquals(mockContact, viewModel.uiState.value.contact)
    assertFalse(viewModel.uiState.value.isLoading)
}
```

#### 7.1.2 æµ‹è¯•æ ‡ç­¾ç¡®è®¤

```kotlin
@Test
fun `confirmTag should update fact source to MANUAL`() = runTest {
    // Given
    val viewModel = ContactDetailViewModel(...)
    val factId = 123L
    val initialFact = Fact(
        key = "æµ‹è¯•",
        value = "æµ‹è¯•å€¼",
        timestamp = factId,
        source = "AI_INFERRED",
        confidence = 0.7f
    )
    
    // è®¾ç½®åˆå§‹çŠ¶æ€
    viewModel._uiState.update {
        it.copy(
            facts = listOf(initialFact),
            contact = ContactProfile(
                id = "test",
                name = "æµ‹è¯•",
                targetGoal = "æµ‹è¯•",
                facts = listOf(initialFact)
            )
        )
    }
    
    // When
    viewModel.onEvent(ContactDetailUiEvent.ConfirmTag(factId))
    advanceUntilIdle()
    
    // Then
    val updatedFact = viewModel.uiState.value.facts.find { it.timestamp == factId }
    assertEquals("MANUAL", updatedFact?.source)
    assertEquals(1.0f, updatedFact?.confidence)
}
```

#### 7.1.3 æµ‹è¯•è§†å›¾åˆ‡æ¢

```kotlin
@Test
fun `switchViewMode should update viewMode in uiState`() = runTest {
    // Given
    val viewModel = ContactDetailViewModel(...)
    assertEquals(ViewMode.Timeline, viewModel.uiState.value.viewMode)
    
    // When
    viewModel.onEvent(ContactDetailUiEvent.SwitchViewMode(ViewMode.List))
    
    // Then
    assertEquals(ViewMode.List, viewModel.uiState.value.viewMode)
}
```

### 7.2 UIç»„ä»¶æµ‹è¯•

#### 7.2.1 æµ‹è¯•EmotionalBackground

```kotlin
@Test
fun `EmotionalBackground should display correct colors for relationship score`() {
    composeTestRule.setContent {
        EmotionalBackground(relationshipScore = 85)
    }
    
    // éªŒè¯èƒŒæ™¯é¢œè‰²ï¼ˆé€šè¿‡æˆªå›¾å¯¹æ¯”æˆ–å…¶ä»–æ–¹å¼ï¼‰
    // æ³¨ï¼šCompose UIæµ‹è¯•å¯¹é¢œè‰²éªŒè¯æœ‰é™ï¼Œä¸»è¦éªŒè¯ç»„ä»¶æ˜¯å¦æ­£å¸¸æ¸²æŸ“
    composeTestRule.onRoot().assertExists()
}
```

#### 7.2.2 æµ‹è¯•GuessedTagäº¤äº’

```kotlin
@Test
fun `GuessedTag should show confirmation dialog on click`() {
    var confirmCalled = false
    var rejectCalled = false
    
    composeTestRule.setContent {
        GuessedTag(
            tag = Fact(
                key = "æµ‹è¯•",
                value = "æµ‹è¯•æ ‡ç­¾",
                timestamp = 123L,
                source = "AI_INFERRED",
                confidence = 0.7f
            ),
            onConfirm = { confirmCalled = true },
            onReject = { rejectCalled = true }
        )
    }
    
    // ç‚¹å‡»æ ‡ç­¾
    composeTestRule.onNodeWithText("æµ‹è¯•æ ‡ç­¾").performClick()
    
    // éªŒè¯å¯¹è¯æ¡†æ˜¾ç¤º
    composeTestRule.onNodeWithText("ç¡®è®¤æ ‡ç­¾").assertIsDisplayed()
    
    // ç‚¹å‡»ç¡®è®¤
    composeTestRule.onNodeWithText("ç¡®è®¤").performClick()
    
    // éªŒè¯å›è°ƒè¢«è°ƒç”¨
    assertTrue(confirmCalled)
    assertFalse(rejectCalled)
}
```

#### 7.2.3 æµ‹è¯•SegmentedControl

```kotlin
@Test
fun `SegmentedControl should call onItemSelected when item clicked`() {
    var selectedIndex = 0
    
    composeTestRule.setContent {
        SegmentedControl(
            items = listOf("æ—¶å…‰è½´", "æ¸…å•"),
            selectedIndex = selectedIndex,
            onItemSelected = { selectedIndex = it }
        )
    }
    
    // ç‚¹å‡»ç¬¬äºŒä¸ªé€‰é¡¹
    composeTestRule.onNodeWithText("æ¸…å•").performClick()
    
    // éªŒè¯é€‰ä¸­ç´¢å¼•æ›´æ–°
    assertEquals(1, selectedIndex)
}
```

### 7.3 é›†æˆæµ‹è¯•

#### 7.3.1 æµ‹è¯•å®Œæ•´çš„æ•°æ®æµ

```kotlin
@Test
fun `complete data flow from repository to UI`() = runTest {
    // Given
    val testContact = ContactProfile(
        id = "test_id",
        name = "æµ‹è¯•è”ç³»äºº",
        targetGoal = "æµ‹è¯•ç›®æ ‡",
        relationshipScore = 75,
        facts = listOf(
            Fact("å…´è¶£", "ç¼–ç¨‹", 123L, "MANUAL", 1.0f)
        )
    )
    
    // è®¾ç½®Repositoryè¿”å›å€¼
    coEvery { contactRepository.getProfile("test_id") } returns Result.success(testContact)
    
    // When
    composeTestRule.setContent {
        val viewModel = ContactDetailViewModel(...)
        ContactDetailScreen(
            uiState = viewModel.uiState.collectAsState().value,
            onEvent = viewModel::onEvent
        )
    }
    
    // Then
    composeTestRule.onNodeWithText("æµ‹è¯•è”ç³»äºº").assertIsDisplayed()
    composeTestRule.onNodeWithText("ç¼–ç¨‹").assertIsDisplayed()
}
```

### 7.4 æ€§èƒ½æµ‹è¯•

#### 7.4.1 æµ‹è¯•åˆ—è¡¨æ»šåŠ¨æ€§èƒ½

```kotlin
@Test
fun `timeline view should scroll smoothly with 100 items`() {
    val items = (1..100).map { index ->
        TimelineItem.Conversation(
            id = "conv_$index",
            timestamp = System.currentTimeMillis() - index * 1000L,
            emotionType = EmotionType.NEUTRAL,
            log = ConversationLog(
                id = index.toLong(),
                contactId = "test",
                userInput = "æµ‹è¯•æ¶ˆæ¯ $index",
                aiResponse = "AIå›å¤ $index",
                timestamp = System.currentTimeMillis()
            )
        )
    }
    
    composeTestRule.setContent {
        TimelineView(items = items)
    }
    
    // æ‰§è¡Œæ»šåŠ¨
    composeTestRule.onRoot().performTouchInput {
        swipeUp(startY = bottom, endY = top)
    }
    
    // éªŒè¯æ²¡æœ‰ä¸¢å¸§ï¼ˆé€šè¿‡æ€§èƒ½ç›‘æ§å·¥å…·ï¼‰
    // æ³¨ï¼šå®é™…æ€§èƒ½æµ‹è¯•éœ€è¦ä½¿ç”¨Android Profilerç­‰å·¥å…·
}
```



## 8. å®æ–½è®¡åˆ’

### 8.1 å¼€å‘é˜¶æ®µåˆ’åˆ†

#### é˜¶æ®µ1ï¼šå…¨å±€è®¾è®¡ç³»ç»Ÿï¼ˆ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šå»ºç«‹æƒ…æ„ŸåŒ–è®¾è®¡è¯­è¨€çš„åŸºç¡€ç»„ä»¶

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®ç°EmotionalBackgroundç»„ä»¶
  - å…³ç³»åˆ†æ•°è‰²å½©æ˜ å°„
  - åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ
  - æ€§èƒ½ä¼˜åŒ–
- [ ] å®ç°GlassmorphicCardç»„ä»¶
  - ç£¨ç ‚ç»ç’ƒæ•ˆæœ
  - è¾¹æ¡†å…‰æ™•
  - ç‚¹å‡»äº¤äº’
- [ ] å®ç°SegmentedControlç»„ä»¶
  - å¤šé€‰é¡¹åˆ‡æ¢
  - é€‰ä¸­çŠ¶æ€åŠ¨ç”»
  - Material Design 3é£æ ¼
- [ ] å®ç°æµä½“åˆ‡æ¢åŠ¨ç”»ç³»ç»Ÿ
  - AnimatedContenté…ç½®
  - ç¼“åŠ¨æ›²çº¿è°ƒä¼˜
  - æ€§èƒ½æµ‹è¯•

**éªŒæ”¶æ ‡å‡†**ï¼š
- æ‰€æœ‰ç»„ä»¶å¯ç‹¬ç«‹è¿è¡Œ
- åŠ¨ç”»æµç•…ï¼ˆ60fpsï¼‰
- é€šè¿‡å•å…ƒæµ‹è¯•

#### é˜¶æ®µ2ï¼šç•Œé¢ä¸€ - æ¦‚è§ˆï¼ˆ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šå®ç°è”ç³»äººæ¦‚è§ˆé¡µé¢

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®ç°DynamicEmotionalHeader
  - Sticky Headeræ•ˆæœ
  - æ»šåŠ¨æ”¶ç¼©åŠ¨ç”»
  - èƒŒæ™¯å…‰æ™•æ·¡åŒ–
- [ ] å®ç°TopTagsSection
  - æ¨ªå‘æ»šåŠ¨åˆ—è¡¨
  - æ ‡ç­¾æ ·å¼
  - é¢œè‰²æ˜ å°„
- [ ] å®ç°LatestFactHookCard
  - ç£¨ç ‚ç»ç’ƒå¡ç‰‡
  - è£…é¥°æ€§å›¾æ ‡
  - ç‚¹å‡»è·³è½¬
- [ ] é›†æˆåˆ°ContactDetailScreen
  - æ ‡ç­¾é¡µåˆ‡æ¢
  - æ•°æ®ç»‘å®š
  - çŠ¶æ€ç®¡ç†

**éªŒæ”¶æ ‡å‡†**ï¼š
- ç•Œé¢å®Œæ•´æ˜¾ç¤º
- æ»šåŠ¨äº¤äº’æµç•…
- æ•°æ®æ­£ç¡®å±•ç¤º

#### é˜¶æ®µ3ï¼šç•Œé¢äºŒ - äº‹å®æµï¼ˆ3-4å¤©ï¼‰

**ç›®æ ‡**ï¼šå®ç°æ—¶å…‰è½´å’Œæ¸…å•åˆ—è¡¨åŒè§†å›¾

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®ç°TimelineView
  - ç€‘å¸ƒæµå¸ƒå±€
  - EmotionalTimelineNode
  - å¤šæ ·åŒ–å¡ç‰‡ï¼ˆPhotoMomentã€AiSummaryã€Milestoneã€Conversationï¼‰
- [ ] å®ç°ListView
  - å•åˆ—åˆ—è¡¨
  - ListViewRow
  - å¿«é€Ÿç­›é€‰Chips
- [ ] å®ç°FactStreamTopBar
  - SegmentedControlé›†æˆ
  - ç­›é€‰æŒ‰é’®
  - çŠ¶æ€ç®¡ç†
- [ ] å®ç°åŒè§†å›¾åˆ‡æ¢
  - AnimatedContentè¿‡æ¸¡
  - çŠ¶æ€ä¿æŒ
  - æ€§èƒ½ä¼˜åŒ–

**éªŒæ”¶æ ‡å‡†**ï¼š
- ä¸¤ç§è§†å›¾æ­£å¸¸åˆ‡æ¢
- åˆ—è¡¨æ»šåŠ¨æµç•…
- ç­›é€‰åŠŸèƒ½æ­£å¸¸
- æƒ…ç»ªèŠ‚ç‚¹æ­£ç¡®æ˜¾ç¤º

#### é˜¶æ®µ4ï¼šç•Œé¢ä¸‰ - æ ‡ç­¾ç”»åƒï¼ˆ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šå®ç°æ ‡ç­¾ç®¡ç†å’Œç¡®è®¤åŠŸèƒ½

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®ç°ConfirmedTagç»„ä»¶
  - å®å¿ƒèƒŒæ™¯
  - å¯¹å‹¾å›¾æ ‡
  - é«˜é¥±å’Œåº¦é¢œè‰²
- [ ] å®ç°GuessedTagç»„ä»¶
  - åŠé€æ˜èƒŒæ™¯
  - é—®å·å›¾æ ‡
  - å‘¼å¸åŠ¨æ•ˆ
  - ç‚¹å‡»äº¤äº’
- [ ] å®ç°TagConfirmationDialog
  - ç¡®è®¤/é©³å›æ“ä½œ
  - ç½®ä¿¡åº¦æ˜¾ç¤º
  - é”™è¯¯å¤„ç†
- [ ] å®ç°PersonaTab
  - åˆ†ç±»å±•ç¤º
  - FlowRowå¸ƒå±€
  - æ•°æ®ç»‘å®š

**éªŒæ”¶æ ‡å‡†**ï¼š
- æ ‡ç­¾æ ·å¼æ­£ç¡®
- å‘¼å¸åŠ¨æ•ˆæµç•…
- ç¡®è®¤/é©³å›åŠŸèƒ½æ­£å¸¸
- æ•°æ®æŒä¹…åŒ–æˆåŠŸ

#### é˜¶æ®µ5ï¼šç•Œé¢å›› - èµ„æ–™åº“ï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡**ï¼šå®ç°æ•°æ®æºç®¡ç†ç•Œé¢

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®ç°DataSourceCard
  - ç½‘æ ¼å¸ƒå±€
  - çŠ¶æ€è§’æ ‡
  - ç‚¹å‡»å¯¼èˆª
- [ ] å®ç°StatusBadge
  - çŠ¶æ€å›¾æ ‡
  - é¢œè‰²æ˜ å°„
  - åŠ¨ç”»æ•ˆæœ
- [ ] å®ç°DataVaultTab
  - LazyVerticalGrid
  - æ•°æ®ç»Ÿè®¡
  - å¯¼èˆªé›†æˆ

**éªŒæ”¶æ ‡å‡†**ï¼š
- ç½‘æ ¼å¸ƒå±€æ­£ç¡®
- çŠ¶æ€æ˜¾ç¤ºå‡†ç¡®
- å¯¼èˆªåŠŸèƒ½æ­£å¸¸

#### é˜¶æ®µ6ï¼šViewModelå’Œæ•°æ®é›†æˆï¼ˆ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šå®Œå–„æ•°æ®å±‚å’Œä¸šåŠ¡é€»è¾‘

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®Œå–„ContactDetailViewModel
  - æ•°æ®åŠ è½½é€»è¾‘
  - äº‹ä»¶å¤„ç†
  - é”™è¯¯å¤„ç†
  - çŠ¶æ€ç®¡ç†
- [ ] å®ç°æ•°æ®è½¬æ¢é€»è¾‘
  - buildTimelineItems
  - detectEmotion
  - æ•°æ®ç­›é€‰
- [ ] å®ç°Repositoryé›†æˆ
  - å¹¶è¡ŒåŠ è½½
  - Flowè®¢é˜…
  - é”™è¯¯æ¢å¤
- [ ] å®ç°æ•°æ®æŒä¹…åŒ–
  - æ ‡ç­¾ç¡®è®¤/é©³å›
  - å…³ç³»åˆ†æ•°æ›´æ–°
  - Factsæ›´æ–°

**éªŒæ”¶æ ‡å‡†**ï¼š
- æ•°æ®åŠ è½½æ­£å¸¸
- äº‹ä»¶å¤„ç†æ­£ç¡®
- é”™è¯¯å¤„ç†å®Œå–„
- æ•°æ®æŒä¹…åŒ–æˆåŠŸ

#### é˜¶æ®µ7ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šç¡®ä¿è´¨é‡å’Œæ€§èƒ½

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
  - ViewModelæµ‹è¯•
  - æ•°æ®æ¨¡å‹æµ‹è¯•
  - å·¥å…·ç±»æµ‹è¯•
- [ ] ç¼–å†™UIæµ‹è¯•
  - ç»„ä»¶æµ‹è¯•
  - äº¤äº’æµ‹è¯•
  - é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
  - åˆ—è¡¨ä¼˜åŒ–
  - åŠ¨ç”»ä¼˜åŒ–
  - å†…å­˜ä¼˜åŒ–
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–
  - åŠ è½½çŠ¶æ€
  - é”™è¯¯æç¤º
  - ç©ºçŠ¶æ€å¤„ç†

**éªŒæ”¶æ ‡å‡†**ï¼š
- æµ‹è¯•è¦†ç›–ç‡ > 80%
- æ‰€æœ‰æµ‹è¯•é€šè¿‡
- åˆ—è¡¨æ»šåŠ¨æµç•…ï¼ˆ60fpsï¼‰
- å†…å­˜å ç”¨åˆç†

### 8.2 æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | å·¥ä½œé‡ | ä¾èµ– | é£é™© |
|------|--------|------|------|
| é˜¶æ®µ1 | 2-3å¤© | æ—  | ä½ |
| é˜¶æ®µ2 | 2-3å¤© | é˜¶æ®µ1 | ä½ |
| é˜¶æ®µ3 | 3-4å¤© | é˜¶æ®µ1 | ä¸­ï¼ˆç€‘å¸ƒæµå¸ƒå±€å¤æ‚ï¼‰ |
| é˜¶æ®µ4 | 2-3å¤© | é˜¶æ®µ1 | ä½ |
| é˜¶æ®µ5 | 1-2å¤© | æ—  | ä½ |
| é˜¶æ®µ6 | 2-3å¤© | é˜¶æ®µ2-5 | ä¸­ï¼ˆæ•°æ®é›†æˆå¤æ‚ï¼‰ |
| é˜¶æ®µ7 | 2-3å¤© | é˜¶æ®µ1-6 | ä½ |
| **æ€»è®¡** | **14-21å¤©** | - | - |

### 8.3 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | å®Œæˆæ ‡å‡† | é¢„è®¡æ—¶é—´ |
|--------|---------|---------|
| M1: è®¾è®¡ç³»ç»Ÿå®Œæˆ | æ‰€æœ‰åŸºç¡€ç»„ä»¶å¯ç”¨ | ç¬¬3å¤© |
| M2: æ¦‚è§ˆé¡µé¢å®Œæˆ | ç•Œé¢ä¸€å®Œæ•´å®ç° | ç¬¬6å¤© |
| M3: äº‹å®æµå®Œæˆ | ç•Œé¢äºŒåŒè§†å›¾å®ç° | ç¬¬10å¤© |
| M4: æ ‡ç­¾ç”»åƒå®Œæˆ | ç•Œé¢ä¸‰æ ‡ç­¾ç®¡ç†å®ç° | ç¬¬13å¤© |
| M5: èµ„æ–™åº“å®Œæˆ | ç•Œé¢å››æ•°æ®æºç®¡ç†å®ç° | ç¬¬15å¤© |
| M6: æ•°æ®é›†æˆå®Œæˆ | æ‰€æœ‰åŠŸèƒ½å¯ç”¨ | ç¬¬18å¤© |
| M7: æµ‹è¯•å®Œæˆ | è´¨é‡è¾¾æ ‡ï¼Œå¯å‘å¸ƒ | ç¬¬21å¤© |



## 9. æ•°æ®åº“è®¾è®¡

### 9.1 å®ä½“å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Entity Relationship                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ContactProfileEntity (è”ç³»äºº)
    â”œâ”€â”€ id (PK)
    â”œâ”€â”€ name
    â”œâ”€â”€ relationshipScore
    â”œâ”€â”€ facts (JSON)
    â””â”€â”€ lastInteractionDate
         â”‚
         â”‚ 1:N
         â†“
ConversationLogEntity (å¯¹è¯è®°å½•)
    â”œâ”€â”€ id (PK)
    â”œâ”€â”€ contactId (FK) â†’ ContactProfileEntity.id
    â”œâ”€â”€ userInput
    â”œâ”€â”€ aiResponse
    â”œâ”€â”€ timestamp
    â””â”€â”€ isSummarized
         â”‚
         â”‚ N:1
         â†“
DailySummaryEntity (æ¯æ—¥æ€»ç»“)
    â”œâ”€â”€ id (PK)
    â”œâ”€â”€ contactId (FK) â†’ ContactProfileEntity.id
    â”œâ”€â”€ summaryDate
    â”œâ”€â”€ content
    â”œâ”€â”€ keyEvents (JSON)
    â”œâ”€â”€ newFacts (JSON)
    â”œâ”€â”€ relationshipScoreChange
    â””â”€â”€ createdAt
```

### 9.2 ç´¢å¼•ç­–ç•¥

```kotlin
/**
 * æ•°æ®åº“ç´¢å¼•é…ç½®
 */
@Database(
    entities = [
        ContactProfileEntity::class,
        ConversationLogEntity::class,
        DailySummaryEntity::class
    ],
    version = 5,
    exportSchema = true
)
abstract class AppDatabase : RoomDatabase() {
    // DAOs...
}

/**
 * ConversationLogEntityç´¢å¼•
 */
@Entity(
    tableName = "conversation_logs",
    indices = [
        Index(value = ["contact_id"]),           // æŒ‰è”ç³»äººæŸ¥è¯¢
        Index(value = ["timestamp"]),            // æŒ‰æ—¶é—´æ’åº
        Index(value = ["is_summarized"]),        // æŸ¥è¯¢æœªæ€»ç»“è®°å½•
        Index(value = ["contact_id", "timestamp"]) // å¤åˆç´¢å¼•
    ],
    foreignKeys = [
        ForeignKey(
            entity = ContactProfileEntity::class,
            parentColumns = ["id"],
            childColumns = ["contact_id"],
            onDelete = ForeignKey.CASCADE
        )
    ]
)
data class ConversationLogEntity(...)

/**
 * DailySummaryEntityç´¢å¼•
 */
@Entity(
    tableName = "daily_summaries",
    indices = [
        Index(value = ["contact_id"]),
        Index(value = ["summary_date"]),
        Index(value = ["contact_id", "summary_date"], unique = true)
    ],
    foreignKeys = [
        ForeignKey(
            entity = ContactProfileEntity::class,
            parentColumns = ["id"],
            childColumns = ["contact_id"],
            onDelete = ForeignKey.CASCADE
        )
    ]
)
data class DailySummaryEntity(...)
```

### 9.3 æ•°æ®åº“è¿ç§»ç­–ç•¥

```kotlin
/**
 * æ•°æ®åº“è¿ç§»ç¤ºä¾‹ï¼ˆv4 â†’ v5ï¼‰
 */
val MIGRATION_4_5 = object : Migration(4, 5) {
    override fun migrate(database: SupportSQLiteDatabase) {
        // 1. æ·»åŠ æ–°å­—æ®µ
        database.execSQL(
            "ALTER TABLE conversation_logs ADD COLUMN is_summarized INTEGER NOT NULL DEFAULT 0"
        )
        
        // 2. æ·»åŠ ç´¢å¼•
        database.execSQL(
            "CREATE INDEX IF NOT EXISTS index_conversation_logs_is_summarized " +
            "ON conversation_logs(is_summarized)"
        )
        
        // 3. æ•°æ®è¿ç§»
        database.execSQL(
            "UPDATE conversation_logs SET is_summarized = 0 WHERE is_summarized IS NULL"
        )
    }
}

/**
 * DatabaseModuleé…ç½®
 */
@Module
@InstallIn(SingletonComponent::class)
object DatabaseModule {
    @Provides
    @Singleton
    fun provideDatabase(
        @ApplicationContext context: Context
    ): AppDatabase {
        return Room.databaseBuilder(
            context,
            AppDatabase::class.java,
            "empathy_database"
        )
            .addMigrations(MIGRATION_4_5)  // æ·»åŠ è¿ç§»
            // .fallbackToDestructiveMigration()  // æ­£å¼å‘å¸ƒå‰ç§»é™¤
            .build()
    }
}
```

## 10. å®‰å…¨æ€§è®¾è®¡

### 10.1 æ•°æ®åŠ å¯†

```kotlin
/**
 * å®‰å…¨é…ç½®
 */
object SecurityConfig {
    const val ENCRYPTION_ALGORITHM = "AES/GCM/NoPadding"
    const val KEY_ALIAS = "contact_data_key"
    const val KEY_SIZE = 256
}

/**
 * æ•°æ®åŠ å¯†å·¥å…·
 */
@Singleton
class DataEncryption @Inject constructor(
    @ApplicationContext private val context: Context
) {
    private val keyStore = KeyStore.getInstance("AndroidKeyStore").apply {
        load(null)
    }
    
    /**
     * åŠ å¯†æ•æ„Ÿæ•°æ®
     */
    fun encrypt(data: String): String {
        val cipher = Cipher.getInstance(SecurityConfig.ENCRYPTION_ALGORITHM)
        cipher.init(Cipher.ENCRYPT_MODE, getOrCreateKey())
        
        val encryptedBytes = cipher.doFinal(data.toByteArray())
        val iv = cipher.iv
        
        return Base64.encodeToString(iv + encryptedBytes, Base64.DEFAULT)
    }
    
    /**
     * è§£å¯†æ•æ„Ÿæ•°æ®
     */
    fun decrypt(encryptedData: String): String {
        val bytes = Base64.decode(encryptedData, Base64.DEFAULT)
        val iv = bytes.copyOfRange(0, 12)
        val encrypted = bytes.copyOfRange(12, bytes.size)
        
        val cipher = Cipher.getInstance(SecurityConfig.ENCRYPTION_ALGORITHM)
        cipher.init(Cipher.DECRYPT_MODE, getOrCreateKey(), GCMParameterSpec(128, iv))
        
        return String(cipher.doFinal(encrypted))
    }
    
    private fun getOrCreateKey(): SecretKey {
        if (!keyStore.containsAlias(SecurityConfig.KEY_ALIAS)) {
            val keyGenerator = KeyGenerator.getInstance(
                KeyProperties.KEY_ALGORITHM_AES,
                "AndroidKeyStore"
            )
            keyGenerator.init(
                KeyGenParameterSpec.Builder(
                    SecurityConfig.KEY_ALIAS,
                    KeyProperties.PURPOSE_ENCRYPT or KeyProperties.PURPOSE_DECRYPT
                )
                    .setBlockModes(KeyProperties.BLOCK_MODE_GCM)
                    .setEncryptionPaddings(KeyProperties.ENCRYPTION_PADDING_NONE)
                    .setKeySize(SecurityConfig.KEY_SIZE)
                    .build()
            )
            keyGenerator.generateKey()
        }
        
        return keyStore.getKey(SecurityConfig.KEY_ALIAS, null) as SecretKey
    }
}
```

### 10.2 æƒé™æ§åˆ¶

```kotlin
/**
 * æƒé™ç®¡ç†å™¨
 */
@Singleton
class PermissionManager @Inject constructor(
    @ApplicationContext private val context: Context
) {
    /**
     * æ£€æŸ¥æ‚¬æµ®çª—æƒé™
     */
    fun hasOverlayPermission(): Boolean {
        return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            Settings.canDrawOverlays(context)
        } else {
            true
        }
    }
    
    /**
     * è¯·æ±‚æ‚¬æµ®çª—æƒé™
     */
    fun requestOverlayPermission(activity: Activity) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            val intent = Intent(
                Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                Uri.parse("package:${context.packageName}")
            )
            activity.startActivityForResult(intent, REQUEST_OVERLAY_PERMISSION)
        }
    }
    
    companion object {
        const val REQUEST_OVERLAY_PERMISSION = 1001
    }
}
```

### 10.3 éšç§ä¿æŠ¤

```kotlin
/**
 * éšç§ä¿æŠ¤é…ç½®
 */
object PrivacyConfig {
    // æ•æ„Ÿæ•°æ®å­—æ®µ
    val SENSITIVE_FIELDS = setOf(
        "phone", "email", "address", "idCard"
    )
    
    // æ•°æ®ä¿ç•™æœŸé™ï¼ˆå¤©ï¼‰
    const val DATA_RETENTION_DAYS = 90
    
    // è‡ªåŠ¨æ¸…ç†å¼€å…³
    const val AUTO_CLEANUP_ENABLED = true
}

/**
 * éšç§æ•°æ®å¤„ç†
 */
@Singleton
class PrivacyDataHandler @Inject constructor(
    private val dataEncryption: DataEncryption,
    private val privacyPreferences: PrivacyPreferences
) {
    /**
     * å¤„ç†æ•æ„Ÿæ•°æ®
     */
    fun processSensitiveData(data: Map<String, String>): Map<String, String> {
        if (!privacyPreferences.isDataMaskingEnabled()) {
            return data
        }
        
        return data.mapValues { (key, value) ->
            if (key in PrivacyConfig.SENSITIVE_FIELDS) {
                dataEncryption.encrypt(value)
            } else {
                value
            }
        }
    }
    
    /**
     * è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
     */
    suspend fun autoCleanupExpiredData() {
        if (!PrivacyConfig.AUTO_CLEANUP_ENABLED) return
        
        val expiryDate = System.currentTimeMillis() - 
            PrivacyConfig.DATA_RETENTION_DAYS * 24 * 60 * 60 * 1000L
        
        // æ¸…ç†é€»è¾‘...
    }
}
```

## 11. æ€§èƒ½ç›‘æ§

### 11.1 æ€§èƒ½æŒ‡æ ‡å®šä¹‰

```kotlin
/**
 * æ€§èƒ½æŒ‡æ ‡é…ç½®
 */
object PerformanceMetrics {
    // å†…å­˜é™åˆ¶
    const val MAX_MEMORY_USAGE = 200 * 1024 * 1024 // 200MB
    
    // å¸§ç‡è¦æ±‚
    const val MIN_FPS = 60
    const val TARGET_FRAME_TIME = 16L // 16ms per frame
    
    // åŠ è½½æ—¶é—´
    const val MAX_LOAD_TIME = 1000L // 1ç§’
    const val MAX_OPERATION_TIME = 300L // 300ms
    
    // åˆ—è¡¨æ€§èƒ½
    const val MAX_LIST_ITEMS_PER_PAGE = 50
    const val PREFETCH_DISTANCE = 10
}
```

### 11.2 æ€§èƒ½ç›‘æ§å®ç°

```kotlin
/**
 * æ€§èƒ½ç›‘æ§å™¨
 */
@Singleton
class PerformanceMonitor @Inject constructor() {
    private val metrics = mutableMapOf<String, PerformanceMetric>()
    
    /**
     * å¼€å§‹ç›‘æ§
     */
    fun startMonitoring(tag: String) {
        metrics[tag] = PerformanceMetric(
            tag = tag,
            startTime = System.currentTimeMillis(),
            startMemory = Runtime.getRuntime().totalMemory() - 
                         Runtime.getRuntime().freeMemory()
        )
    }
    
    /**
     * ç»“æŸç›‘æ§
     */
    fun endMonitoring(tag: String) {
        val metric = metrics[tag] ?: return
        val endTime = System.currentTimeMillis()
        val endMemory = Runtime.getRuntime().totalMemory() - 
                       Runtime.getRuntime().freeMemory()
        
        val duration = endTime - metric.startTime
        val memoryUsed = endMemory - metric.startMemory
        
        Log.d("Performance", """
            Tag: $tag
            Duration: ${duration}ms
            Memory: ${memoryUsed / 1024}KB
            Status: ${if (duration > PerformanceMetrics.MAX_OPERATION_TIME) "âš ï¸ SLOW" else "âœ… OK"}
        """.trimIndent())
        
        metrics.remove(tag)
    }
    
    /**
     * ç›‘æ§å†…å­˜ä½¿ç”¨
     */
    fun checkMemoryUsage(): Boolean {
        val usedMemory = Runtime.getRuntime().totalMemory() - 
                        Runtime.getRuntime().freeMemory()
        
        return usedMemory < PerformanceMetrics.MAX_MEMORY_USAGE
    }
}

/**
 * æ€§èƒ½æŒ‡æ ‡æ•°æ®ç±»
 */
data class PerformanceMetric(
    val tag: String,
    val startTime: Long,
    val startMemory: Long
)
```

### 11.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```kotlin
/**
 * åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–
 */
@Composable
fun OptimizedTimelineView(
    items: List<TimelineItem>,
    performanceMonitor: PerformanceMonitor
) {
    // ç›‘æ§æ¸²æŸ“æ€§èƒ½
    LaunchedEffect(Unit) {
        performanceMonitor.startMonitoring("TimelineView")
    }
    
    DisposableEffect(Unit) {
        onDispose {
            performanceMonitor.endMonitoring("TimelineView")
        }
    }
    
    LazyVerticalStaggeredGrid(
        columns = StaggeredGridCells.Fixed(2),
        modifier = Modifier.fillMaxSize(),
        contentPadding = PaddingValues(16.dp)
    ) {
        items(
            items = items,
            key = { it.id },  // ç¨³å®šçš„key
            contentType = { it::class }  // ç±»å‹ä¼˜åŒ–
        ) { item ->
            // ä½¿ç”¨rememberç¼“å­˜è®¡ç®—
            val cachedItem = remember(item.id) { item }
            TimelineItemCard(cachedItem)
        }
    }
}
```

## 12. é£é™©è¯„ä¼°ä¸åº”å¯¹

### 9.1 æŠ€æœ¯é£é™©

#### é£é™©1ï¼šç€‘å¸ƒæµå¸ƒå±€æ€§èƒ½é—®é¢˜

**æè¿°**ï¼šLazyVerticalStaggeredGridåœ¨å¤§é‡æ•°æ®æ—¶å¯èƒ½å‡ºç°å¡é¡¿

**å½±å“**ï¼šé«˜ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰

**æ¦‚ç‡**ï¼šä¸­

**åº”å¯¹æªæ–½**ï¼š
1. ä½¿ç”¨keyå‚æ•°ä¼˜åŒ–é‡ç»„
2. ä½¿ç”¨contentTypeä¼˜åŒ–å¸ƒå±€
3. é™åˆ¶åˆå§‹åŠ è½½æ•°é‡ï¼Œå®ç°åˆ†é¡µåŠ è½½
4. ä½¿ç”¨rememberç¼“å­˜è®¡ç®—ç»“æœ
5. å¦‚æœæ€§èƒ½ä»ä¸ç†æƒ³ï¼Œé™çº§ä¸ºå•åˆ—åˆ—è¡¨

#### é£é™©2ï¼šåŠ¨ç”»æ€§èƒ½é—®é¢˜

**æè¿°**ï¼šå¤šä¸ªå‘¼å¸åŠ¨ç”»åŒæ—¶è¿è¡Œå¯èƒ½å¯¼è‡´å¡é¡¿

**å½±å“**ï¼šä¸­ï¼ˆå½±å“è§†è§‰æ•ˆæœï¼‰

**æ¦‚ç‡**ï¼šä¸­

**åº”å¯¹æªæ–½**ï¼š
1. åªåœ¨å¯è§åŒºåŸŸå¯ç”¨åŠ¨ç”»
2. ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ
3. é™åˆ¶åŒæ—¶è¿è¡Œçš„åŠ¨ç”»æ•°é‡
4. æä¾›å…³é—­åŠ¨ç”»çš„é€‰é¡¹

#### é£é™©3ï¼šå†…å­˜å ç”¨è¿‡é«˜

**æè¿°**ï¼šå¤§é‡å›¾ç‰‡å’Œæ•°æ®å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º

**å½±å“**ï¼šé«˜ï¼ˆå¯èƒ½å¯¼è‡´å´©æºƒï¼‰

**æ¦‚ç‡**ï¼šä½

**åº”å¯¹æªæ–½**ï¼š
1. ä½¿ç”¨Coilè‡ªåŠ¨ç®¡ç†å›¾ç‰‡ç¼“å­˜
2. å®ç°æ•°æ®åˆ†é¡µåŠ è½½
3. åŠæ—¶é‡Šæ”¾ä¸å¯è§çš„èµ„æº
4. ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

### 9.2 ä¸šåŠ¡é£é™©

#### é£é™©4ï¼šæ•°æ®æ¨¡å‹å˜æ›´

**æè¿°**ï¼šåç«¯æ•°æ®æ¨¡å‹å¯èƒ½éœ€è¦è°ƒæ•´

**å½±å“**ï¼šä¸­ï¼ˆéœ€è¦ä¿®æ”¹ä»£ç ï¼‰

**æ¦‚ç‡**ï¼šä¸­

**åº”å¯¹æªæ–½**ï¼š
1. ä½¿ç”¨Repositoryæ¨¡å¼éš”ç¦»æ•°æ®å±‚
2. ä½¿ç”¨Mapperè½¬æ¢æ•°æ®æ¨¡å‹
3. ç¼–å†™å®Œå–„çš„å•å…ƒæµ‹è¯•
4. ä¿æŒæ–‡æ¡£æ›´æ–°

#### é£é™©5ï¼šç”¨æˆ·ä½“éªŒä¸ç¬¦åˆé¢„æœŸ

**æè¿°**ï¼šæƒ…æ„ŸåŒ–è®¾è®¡å¯èƒ½ä¸è¢«ç”¨æˆ·æ¥å—

**å½±å“**ï¼šä¸­ï¼ˆéœ€è¦è°ƒæ•´è®¾è®¡ï¼‰

**æ¦‚ç‡**ï¼šä½

**åº”å¯¹æªæ–½**ï¼š
1. æä¾›ä¼ ç»Ÿè§†å›¾é€‰é¡¹
2. æ”¶é›†ç”¨æˆ·åé¦ˆ
3. å¿«é€Ÿè¿­ä»£ä¼˜åŒ–
4. A/Bæµ‹è¯•éªŒè¯

### 9.3 è¿›åº¦é£é™©

#### é£é™©6ï¼šå¼€å‘æ—¶é—´è¶…å‡ºé¢„æœŸ

**æè¿°**ï¼šå¤æ‚åŠŸèƒ½å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´

**å½±å“**ï¼šä¸­ï¼ˆå»¶è¿Ÿå‘å¸ƒï¼‰

**æ¦‚ç‡**ï¼šä¸­

**åº”å¯¹æªæ–½**ï¼š
1. ä¼˜å…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½
2. éæ ¸å¿ƒåŠŸèƒ½å¯å»¶å
3. å¢åŠ å¼€å‘èµ„æº
4. è°ƒæ•´å‘å¸ƒè®¡åˆ’

## 10. ä¾èµ–å…³ç³»

### 10.1 å¤–éƒ¨ä¾èµ–

| ä¾èµ–é¡¹ | ç‰ˆæœ¬ | ç”¨é€” | é£é™© |
|--------|------|------|------|
| Jetpack Compose | 2024.12.01 | UIæ¡†æ¶ | ä½ |
| Material Design 3 | 1.3.1 | è®¾è®¡ç³»ç»Ÿ | ä½ |
| Coil | 2.5.0 | å›¾ç‰‡åŠ è½½ | ä½ |
| Hilt | 2.52 | ä¾èµ–æ³¨å…¥ | ä½ |
| Room | 2.6.1 | æ•°æ®åº“ | ä½ |

### 10.2 å†…éƒ¨ä¾èµ–

| æ¨¡å— | ä¾èµ– | çŠ¶æ€ |
|------|------|------|
| ContactDetailViewModel | ContactRepository | âœ… å·²å®ç° |
| ContactDetailViewModel | ConversationRepository | âœ… å·²å®ç° |
| ContactDetailViewModel | DailySummaryRepository | âœ… å·²å®ç° |
| TimelineView | TimelineItem | ğŸ†• éœ€è¦åˆ›å»º |
| EmotionalBackground | RelationshipColors | ğŸ†• éœ€è¦åˆ›å»º |

## 11. æˆåŠŸæŒ‡æ ‡

### 11.1 åŠŸèƒ½å®Œæ•´æ€§

- [ ] æ‰€æœ‰ç•Œé¢æ­£å¸¸æ˜¾ç¤º
- [ ] æ‰€æœ‰äº¤äº’åŠŸèƒ½æ­£å¸¸
- [ ] æ•°æ®æ­£ç¡®åŠ è½½å’Œä¿å­˜
- [ ] é”™è¯¯å¤„ç†å®Œå–„

### 11.2 æ€§èƒ½æŒ‡æ ‡

- [ ] åˆ—è¡¨æ»šåŠ¨å¸§ç‡ â‰¥ 60fps
- [ ] é¡µé¢åŠ è½½æ—¶é—´ < 1ç§’
- [ ] æ“ä½œå“åº”æ—¶é—´ < 300ms
- [ ] å†…å­˜å ç”¨ < 200MB

### 11.3 è´¨é‡æŒ‡æ ‡

- [ ] æµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ‰€æœ‰UIæµ‹è¯•é€šè¿‡
- [ ] æ— ä¸¥é‡Bug

### 11.4 ç”¨æˆ·ä½“éªŒæŒ‡æ ‡

- [ ] åŠ¨ç”»æµç•…è‡ªç„¶
- [ ] ç•Œé¢ç¾è§‚ç°ä»£
- [ ] æ“ä½œç›´è§‚æ˜“æ‡‚
- [ ] é”™è¯¯æç¤ºå‹å¥½

## 12. ç›¸å…³æ–‡æ¡£

### 12.1 éœ€æ±‚æ–‡æ¡£

- [PRD-00004 v2.0 - è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIé›†æˆéœ€æ±‚](../PRD/PRD-00004-è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIé›†æˆéœ€æ±‚.md)

### 12.2 è®¾è®¡æ–‡æ¡£

- [FD-00004 v2.0 - è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIåŠŸèƒ½è®¾è®¡](../FD/FD-00004-è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIåŠŸèƒ½è®¾è®¡.md)

### 12.3 çŸ¥è¯†ä¼ é€’æ–‡æ¡£

- [HANDOFF-00001 - è®°å¿†ç³»ç»ŸUIå¼€å‘çŸ¥è¯†ä¼ é€’](../HANDOFF/HANDOFF-00001-è®°å¿†ç³»ç»ŸUIå¼€å‘çŸ¥è¯†ä¼ é€’.md)
- [å¿«é€Ÿå¯åŠ¨ - è®°å¿†ç³»ç»ŸUIå¼€å‘](../HANDOFF/å¿«é€Ÿå¯åŠ¨-è®°å¿†ç³»ç»ŸUIå¼€å‘.md)

### 12.4 å®ç°æ–‡æ¡£

- [IMPL-00003 - è”ç³»äººç”»åƒè®°å¿†ç³»ç»Ÿå®ç°è¿›åº¦](../IMPL/IMPL-00003-è”ç³»äººç”»åƒè®°å¿†ç³»ç»Ÿå®ç°è¿›åº¦.md)

### 12.5 æ¶æ„æ–‡æ¡£

- [TDD-00003 - è”ç³»äººç”»åƒè®°å¿†ç³»ç»Ÿæ¶æ„è®¾è®¡](./TDD-00003-è”ç³»äººç”»åƒè®°å¿†ç³»ç»Ÿæ¶æ„è®¾è®¡.md)

## 13. é™„å½•

### 13.1 æœ¯è¯­è¡¨

| æœ¯è¯­ | å®šä¹‰ |
|------|------|
| æƒ…æ„ŸåŒ–ç£¨ç ‚ç»ç’ƒ | Emotional Glassmorphismï¼ŒåŠé€æ˜ç£¨ç ‚ç»ç’ƒæ•ˆæœçš„è®¾è®¡é£æ ¼ |
| æµä½“åŠ¨ç”» | Morphing Animationï¼Œå…ƒç´ å¹³æ»‘å˜å½¢çš„åŠ¨ç”»æ•ˆæœ |
| æ—¶å…‰è½´ | Timeline Viewï¼Œç€‘å¸ƒæµå¸ƒå±€çš„æ—¶é—´çº¿å±•ç¤ºæ–¹å¼ |
| æ¸…å•åˆ—è¡¨ | List Viewï¼Œå•åˆ—åˆ—è¡¨çš„å±•ç¤ºæ–¹å¼ |
| ç¡®è®¤æ ‡ç­¾ | Confirmed Tagï¼Œç”¨æˆ·ç¡®è®¤çš„æ ‡ç­¾ï¼Œå®å¿ƒèƒŒæ™¯ |
| æ¨æµ‹æ ‡ç­¾ | Guessed Tagï¼ŒAIæ¨æµ‹çš„æ ‡ç­¾ï¼ŒåŠé€æ˜èƒŒæ™¯ |
| å‘¼å¸åŠ¨æ•ˆ | Breathing Animationï¼Œé€æ˜åº¦ç¼“æ…¢å˜åŒ–çš„åŠ¨ç”»æ•ˆæœ |
| Sticky Header | ç²˜æ€§å¤´éƒ¨ï¼Œæ»šåŠ¨æ—¶å›ºå®šåœ¨é¡¶éƒ¨çš„å¤´éƒ¨åŒºåŸŸ |

### 13.2 è®¾è®¡è§„èŒƒ

#### é¢œè‰²è§„èŒƒ

```kotlin
// å…³ç³»åˆ†æ•°é¢œè‰²æ˜ å°„
object RelationshipColors {
    // äº²å¯†å…³ç³» (81-100)
    val Excellent = listOf(
        Color(0xFFFF6B9D),  // ç²‰è‰²
        Color(0xFFFFA06B)   // æš–æ©™è‰²
    )
    
    // è‰¯å¥½å…³ç³» (61-80)
    val Good = listOf(
        Color(0xFFFFC371),  // æŸ”å’Œé»„è‰²
        Color(0xFF7FD8BE)   // æŸ”å’Œç»¿è‰²
    )
    
    // ä¸€èˆ¬å…³ç³» (31-60)
    val Normal = listOf(
        Color(0xFF89B5E0),  // ä¸­æ€§è“è‰²
        Color(0xFFB8C5D6)   // ä¸­æ€§ç°è‰²
    )
    
    // å†·æ·¡å…³ç³» (0-30)
    val Poor = listOf(
        Color(0xFF6B8CAE),  // å†·è“è‰²
        Color(0xFF8B9DAF)   // æ·±ç°è‰²
    )
}

// æ ‡ç­¾é¢œè‰²æ˜ å°„
object TagColors {
    val Interest = Color(0xFF4CAF50)      // å…´è¶£çˆ±å¥½ - ç»¿è‰²
    val Personality = Color(0xFF2196F3)   // æ€§æ ¼ç‰¹å¾ - è“è‰²
    val Value = Color(0xFF9C27B0)         // ä»·å€¼è§‚ - ç´«è‰²
    val Taboo = Color(0xFFF44336)         // ç¦å¿Œè¯é¢˜ - çº¢è‰²
}
```

#### å°ºå¯¸è§„èŒƒ

```kotlin
object Dimensions {
    // å¤´éƒ¨å°ºå¯¸
    val HeaderHeightExpanded = 200.dp
    val HeaderHeightCollapsed = 56.dp
    
    // å¤´åƒå°ºå¯¸
    val AvatarSizeLarge = 120.dp
    val AvatarSizeSmall = 40.dp
    
    // å¡ç‰‡åœ†è§’
    val CardCornerRadius = 16.dp
    
    // é—´è·
    val SpacingSmall = 8.dp
    val SpacingMedium = 16.dp
    val SpacingLarge = 24.dp
}
```

#### åŠ¨ç”»è§„èŒƒ

```kotlin
object AnimationSpec {
    // é¢œè‰²è¿‡æ¸¡
    val ColorTransition = tween<Color>(
        durationMillis = 1000,
        easing = FastOutSlowInEasing
    )
    
    // è§†å›¾åˆ‡æ¢
    val ViewTransition = tween<Float>(
        durationMillis = 300,
        easing = FastOutSlowInEasing
    )
    
    // å‘¼å¸åŠ¨æ•ˆ
    val BreathingAnimation = infiniteRepeatable<Float>(
        animation = tween(2000, easing = LinearEasing),
        repeatMode = RepeatMode.Reverse
    )
}
```

### 13.3 ä»£ç ç¤ºä¾‹ç´¢å¼•

| ç¤ºä¾‹ | ä½ç½® | è¯´æ˜ |
|------|------|------|
| EmotionalBackground | 5.1.1 | æƒ…æ„ŸåŒ–èƒŒæ™¯å®ç° |
| GlassmorphicCard | 5.1.2 | ç£¨ç ‚ç»ç’ƒå¡ç‰‡å®ç° |
| DynamicEmotionalHeader | 5.2.1 | åŠ¨æ€å¤´éƒ¨å®ç° |
| TimelineView | 5.3.2 | æ—¶å…‰è½´è§†å›¾å®ç° |
| GuessedTag | 5.4.2 | æ¨æµ‹æ ‡ç­¾å®ç° |
| ContactDetailViewModel | 4.1.1 | ViewModelå®Œæ•´å®ç° |

## 14. å›½é™…åŒ–ä¸æ— éšœç¢

### 14.1 å¤šè¯­è¨€æ”¯æŒæ–¹æ¡ˆ

```kotlin
/**
 * å¤šè¯­è¨€é…ç½®ï¼ˆé¢„ç•™ï¼‰
 */
object LocaleConfig {
    val SUPPORTED_LOCALES = listOf(
        Locale.SIMPLIFIED_CHINESE,  // ç®€ä½“ä¸­æ–‡ï¼ˆé»˜è®¤ï¼‰
        Locale.TRADITIONAL_CHINESE, // ç¹ä½“ä¸­æ–‡
        Locale.ENGLISH              // è‹±è¯­
    )
    
    fun getCurrentLocale(context: Context): Locale {
        return context.resources.configuration.locales[0]
    }
}

/**
 * å­—ç¬¦ä¸²èµ„æºç®¡ç†
 */
// res/values/strings.xml (ä¸­æ–‡)
<resources>
    <string name="app_name">å…±æƒ…AIåŠ©æ‰‹</string>
    <string name="tab_overview">æ¦‚è§ˆ</string>
    <string name="tab_fact_stream">äº‹å®æµ</string>
    <string name="tab_persona">æ ‡ç­¾ç”»åƒ</string>
    <string name="tab_data_vault">èµ„æ–™åº“</string>
</resources>

// res/values-en/strings.xml (è‹±æ–‡ - é¢„ç•™)
<resources>
    <string name="app_name">Empathy AI</string>
    <string name="tab_overview">Overview</string>
    <string name="tab_fact_stream">Fact Stream</string>
    <string name="tab_persona">Persona</string>
    <string name="tab_data_vault">Data Vault</string>
</resources>
```

### 14.2 å±å¹•é€‚é…æ–¹æ¡ˆ

```kotlin
/**
 * å±å¹•å°ºå¯¸é€‚é…
 */
object ScreenConfig {
    // æ–­ç‚¹å®šä¹‰
    val COMPACT_WIDTH = 600.dp
    val MEDIUM_WIDTH = 840.dp
    
    @Composable
    fun getWindowSizeClass(): WindowSizeClass {
        val configuration = LocalConfiguration.current
        val screenWidth = configuration.screenWidthDp.dp
        
        return when {
            screenWidth < COMPACT_WIDTH -> WindowSizeClass.Compact
            screenWidth < MEDIUM_WIDTH -> WindowSizeClass.Medium
            else -> WindowSizeClass.Expanded
        }
    }
}

enum class WindowSizeClass {
    Compact,   // æ‰‹æœºç«–å±
    Medium,    // æ‰‹æœºæ¨ªå±/å°å¹³æ¿
    Expanded   // å¤§å¹³æ¿/æŠ˜å å±
}

/**
 * å“åº”å¼å¸ƒå±€ç¤ºä¾‹
 */
@Composable
fun ResponsiveContactDetailScreen() {
    val windowSize = ScreenConfig.getWindowSizeClass()
    
    when (windowSize) {
        WindowSizeClass.Compact -> {
            // å•åˆ—å¸ƒå±€
            Column {
                OverviewTab()
                FactStreamTab()
            }
        }
        WindowSizeClass.Medium, WindowSizeClass.Expanded -> {
            // åŒåˆ—å¸ƒå±€
            Row {
                Box(modifier = Modifier.weight(1f)) {
                    OverviewTab()
                }
                Box(modifier = Modifier.weight(1f)) {
                    FactStreamTab()
                }
            }
        }
    }
}
```

### 14.3 æ— éšœç¢åŠŸèƒ½

```kotlin
/**
 * æ— éšœç¢æ”¯æŒ
 */
@Composable
fun AccessibleEmotionalTimelineNode(
    emotion: EmotionType,
    modifier: Modifier = Modifier
) {
    Box(
        modifier = modifier
            .size(32.dp)
            .background(
                color = MaterialTheme.colorScheme.surface.copy(alpha = 0.9f),
                shape = CircleShape
            )
            .semantics {
                // ä¸ºå±å¹•é˜…è¯»å™¨æä¾›æè¿°
                contentDescription = "æƒ…ç»ªèŠ‚ç‚¹ï¼š${emotion.displayName}"
                role = Role.Image
            }
    ) {
        Text(
            text = emotion.emoji,
            fontSize = 16.sp
        )
    }
}

/**
 * è§¦æ‘¸ç›®æ ‡å°ºå¯¸
 */
object AccessibilityConfig {
    val MIN_TOUCH_TARGET_SIZE = 48.dp  // Material Designæœ€å°è§¦æ‘¸ç›®æ ‡
    
    @Composable
    fun Modifier.minTouchTarget(): Modifier {
        return this.sizeIn(
            minWidth = MIN_TOUCH_TARGET_SIZE,
            minHeight = MIN_TOUCH_TARGET_SIZE
        )
    }
}
```

## 15. ç‰ˆæœ¬æ›´æ–°è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ | æ›´æ–°äºº |
|------|------|---------|--------|
| 2.1 | 2025-12-14 | æ ¹æ®DR-00008å®¡æŸ¥ä¼˜åŒ–ï¼š<br>- è¡¥å……APIè®¾è®¡ç»†èŠ‚<br>- å®Œå–„æ•°æ®åº“è®¾è®¡å’Œç´¢å¼•ç­–ç•¥<br>- å¢åŠ å®‰å…¨æ€§è®¾è®¡ç« èŠ‚<br>- æ·»åŠ æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ<br>- è¡¥å……å›½é™…åŒ–å’Œæ— éšœç¢è®¾è®¡ | Kiro |
| 2.0 | 2025-12-14 | åˆå§‹ç‰ˆæœ¬ï¼š<br>- å®Œæ•´çš„æ¶æ„è®¾è®¡<br>- UIç»„ä»¶è®¾è®¡<br>- æ€§èƒ½ä¼˜åŒ–ç­–ç•¥<br>- æµ‹è¯•ç­–ç•¥<br>- å®æ–½è®¡åˆ’ | Kiro |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.1  
**æœ€åæ›´æ–°**: 2025-12-14  
**æ›´æ–°è€…**: Kiro  
**å®¡æ ¸çŠ¶æ€**: âœ… å·²å®¡æ ¸ (DR-00008)  
**çŠ¶æ€**: âœ… å®Œæˆ

