# TDD-00007: å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºæŠ€æœ¯è®¾è®¡

## 1. æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç±»å‹ | TDD (Technical Design Document) |
| æ–‡æ¡£ç¼–å· | TDD-00007 |
| åŠŸèƒ½åç§° | å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºæŠ€æœ¯è®¾è®¡ |
| ç‰ˆæœ¬ | 1.0 |
| åˆ›å»ºæ—¥æœŸ | 2025-12-16 |
| æœ€åæ›´æ–° | 2025-12-16 |
| ä½œè€… | Kiro |
| å®¡æ ¸äºº | å¾…å®¡æ ¸ |
| å®¡æ ¸çŠ¶æ€ | ğŸ“ å¾…å®¡æ ¸ |
| å…³è”æ–‡æ¡£ | PRD-00007, FD-00007 |

### 1.1 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-16 | Kiro | åˆå§‹ç‰ˆæœ¬ |
| 1.1 | 2025-12-16 | Kiro | ä¿®å¤SimpleDateFormatçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ˆæ”¹ç”¨DateTimeFormatterï¼‰ï¼Œæå–æ—¶é—´å•ä½å¸¸é‡ï¼Œè¡¥å……ç©ºåˆ—è¡¨æµ‹è¯•ç”¨ä¾‹ |

### 1.2 å‚è€ƒæ ‡å‡†

| æ ‡å‡†æ–‡æ¡£ | ç‰ˆæœ¬ | è¯´æ˜ |
|---------|------|------|
| Clean Architecture | - | æ¶æ„æ¨¡å¼æ ‡å‡† |
| MVVM Pattern | - | UIæ¶æ„æ¨¡å¼ |
| Kotlin Coding Conventions | 2.0.21 | ä»£ç è§„èŒƒ |
| Room Database | 2.6.1 | æ•°æ®åº“è§„èŒƒ |

### 1.3 æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

| å€ºåŠ¡ID | æè¿° | å½±å“ | ä¼˜å…ˆçº§ | è®¡åˆ’è§£å†³æ—¶é—´ |
|--------|------|------|--------|-------------|
| TD-006 | MessageSenderä»…æ”¯æŒUSERç±»å‹ | ä½ | ğŸŸ¢ ä½ | åç»­ç‰ˆæœ¬ |
| TD-007 | æ—¶é—´æ ¼å¼åŒ–å­—ç¬¦ä¸²ç¡¬ç¼–ç ï¼ˆå·²æå–ä¸ºå¸¸é‡ï¼‰ | ä½ | ğŸŸ¢ ä½ | å›½é™…åŒ–æ—¶ |
| TD-008 | java.time APIéœ€è¦coreLibraryDesugaring | ä½ | ğŸŸ¢ ä½ | å·²é…ç½® |

**æ³¨æ„**ï¼šæœ¬é¡¹ç›® minSdk=24ï¼Œä½¿ç”¨ java.time API éœ€è¦å¯ç”¨ coreLibraryDesugaringã€‚
è¯·ç¡®è®¤ `app/build.gradle.kts` ä¸­å·²é…ç½®ï¼š
```kotlin
android {
    compileOptions {
        isCoreLibraryDesugaringEnabled = true
    }
}
dependencies {
    coreLibraryDesugaring("com.android.tools:desugar_jdk_libs:2.0.4")
}
```

---

## 2. æ¶æ„æ¦‚è¿°

### 2.1 æ¶æ„ç›®æ ‡

å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºç³»ç»Ÿé‡‡ç”¨ Clean Architecture åˆ†å±‚æ¶æ„ï¼Œå®ç°å¯¹è¯å†å²çš„æ™ºèƒ½å›æ”¾ã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
- è®©AIèƒ½å¤Ÿ"è®°ä½"æœ€è¿‘çš„å¯¹è¯å†å²ï¼Œå®ç°å¯¹è¯è¿ç»­æ€§
- é€šè¿‡"æ—¶é—´æµé€æ ‡è®°"è®©AIç†è§£å¯¹è¯çš„æ—¶é—´é—´éš”
- æ¨¡æ‹Ÿäººç±»ç¿»çœ‹èŠå¤©è®°å½•çš„å¿ƒç†æ´»åŠ¨ï¼Œæ„å»ºè‡ªç„¶çš„ä¸Šä¸‹æ–‡ç»“æ„
- AIèƒ½ä»æ—¶é—´é—´éš”ä¸­æ¨æ–­å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå˜åŒ–

### 2.2 æŠ€æœ¯æ ˆ

| æŠ€æœ¯é¢†åŸŸ | æŠ€æœ¯é€‰æ‹© | ç‰ˆæœ¬ | ç”¨é€” |
|---------|----------|------|------|
| æ•°æ®åº“ | Room | 2.6.1 | å¯¹è¯è®°å½•å­˜å‚¨ |
| å¼‚æ­¥å¤„ç† | Kotlin Coroutines | 1.9.0 | å¼‚æ­¥IOæ“ä½œ |
| ä¾èµ–æ³¨å…¥ | Hilt | 2.52 | ä¾èµ–ç®¡ç† |
| é…ç½®å­˜å‚¨ | SharedPreferences | Android SDK | å†å²æ¡æ•°é…ç½® |

### 2.3 è®¾è®¡åŸåˆ™

- **æ— ä¾µå…¥æ€§**ï¼šä¸ä¿®æ”¹ç°æœ‰æ•°æ®åº“è¡¨ç»“æ„
- **é™çº§å‹å¥½**ï¼šæŸ¥è¯¢å¤±è´¥æ—¶è¿”å›ç©ºå†å²ï¼Œä¸å½±å“ä¸»æµç¨‹
- **æ€§èƒ½ä¼˜å…ˆ**ï¼šåˆ©ç”¨ç°æœ‰ç´¢å¼•ï¼Œé™åˆ¶æŸ¥è¯¢æ¡æ•°
- **å¯é…ç½®æ€§**ï¼šå†å²æ¡æ•°å¯ç”±ç”¨æˆ·é…ç½®


---

## 3. æ•´ä½“æ¶æ„è®¾è®¡

### 3.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              SettingsScreen (å†å²æ¡æ•°é…ç½®)            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ HistoryConversationCountSection (RadioButton)  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â—‹ ä¸å‘é€å†å² (0æ¡)                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â— æœ€è¿‘5æ¡ (æ¨è)                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â—‹ æœ€è¿‘10æ¡                                   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              SettingsViewModel (æ‰©å±•)                 â”‚  â”‚
â”‚  â”‚         historyConversationCount: Int                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ConversationContextâ”‚ â”‚      AnalyzeChatUseCase          â”‚ â”‚
â”‚  â”‚     Builder       â”‚ â”‚    (é›†æˆå†å²ä¸Šä¸‹æ–‡æ„å»º)          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚TimestampedMessageâ”‚ â”‚  TimeFlowMarker  â”‚                 â”‚
â”‚  â”‚     (æ¨¡å‹)       â”‚ â”‚   (æ ‡è®°ç±»å‹)     â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  MessageSender   â”‚ â”‚ConversationContextâ”‚                â”‚
â”‚  â”‚    (æšä¸¾)        â”‚ â”‚     Config        â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Data Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ConversationRepositoryâ”‚ â”‚    ConversationLogDao         â”‚ â”‚
â”‚  â”‚       Impl        â”‚ â”‚  getRecentConversations()       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚SettingsRepositoryâ”‚ â”‚   SettingsPreferences            â”‚ â”‚
â”‚  â”‚       Impl        â”‚ â”‚  historyConversationCount       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AIåˆ†æè°ƒç”¨æµç¨‹                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·ç‚¹å‡»"å¸®æˆ‘åˆ†æ"
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚AnalyzeChatUseCaseâ”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                     â”‚
         â–¼                                     â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚SettingsRepositoryâ”‚              â”‚ConversationRepositoryâ”‚
  â”‚getHistoryCount() â”‚              â”‚getRecentConversations()â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                     â”‚
         â”‚ historyCount=5                      â”‚ List<ConversationLog>
         â”‚                                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ConversationContextâ”‚
                  â”‚     Builder       â”‚
                  â”‚ buildHistoryContext()â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ å¸¦æ—¶é—´æµé€æ ‡è®°çš„å†å²å­—ç¬¦ä¸²
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  buildContextData â”‚
                  â”‚ (åˆå¹¶åˆ°è¿è¡Œæ—¶æ•°æ®) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   AI Repository  â”‚
                  â”‚   analyzeChat()  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ¨¡å—ä¾èµ–å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ–°å¢/ä¿®æ”¹çš„æ¨¡å—                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚SettingsScreen   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ (UIæ‰©å±•)        â”‚                                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
         â”‚                                                  â”‚
         â–¼                                                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
  â”‚SettingsViewModelâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ (æ‰©å±•)          â”‚                                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
         â”‚                                                  â”‚
         â–¼                                                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
  â”‚SettingsRepositoryâ”‚ â—„â”€â”€ â”‚SettingsPreferencesâ”‚             â”‚
  â”‚ (æ‰©å±•)          â”‚     â”‚ (æ‰©å±•)          â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
         â”‚                                                  â”‚
         â–¼                                                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
  â”‚AnalyzeChatUseCaseâ”‚ â—„â”€â”€ â”‚ConversationContextâ”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ (ä¿®æ”¹)          â”‚     â”‚     Builder      â”‚ (æ–°å¢)      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
         â”‚                       â”‚                          â”‚
         â–¼                       â–¼                          â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
  â”‚ConversationRepositoryâ”‚ â”‚TimestampedMessageâ”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ (æ‰©å±•)          â”‚     â”‚ (æ–°å¢)          â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
         â”‚                       â”‚                          â”‚
         â–¼                       â–¼                          â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
  â”‚ConversationLogDaoâ”‚     â”‚ TimeFlowMarker  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚ (æ‰©å±•)          â”‚     â”‚ (æ–°å¢)          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. è¯¦ç»†è®¾è®¡

### 4.1 é¢†åŸŸå±‚è®¾è®¡

#### 4.1.1 MessageSender æšä¸¾

**æ–‡ä»¶è·¯å¾„**ï¼š`domain/model/MessageSender.kt`

```kotlin
package com.empathy.ai.domain.model

/**
 * æ¶ˆæ¯å‘é€è€…ç±»å‹
 *
 * ã€é‡è¦è¯´æ˜ã€‘å½“å‰ç‰ˆæœ¬ä»…æ”¯æŒ USER ç±»å‹ï¼ŒCONTACT ç±»å‹é¢„ç•™ç»™åç»­æ‰©å±•ã€‚
 * åŸå› ï¼šæ•°æ®åº“ conversation_logs è¡¨ç›®å‰åªå­˜å‚¨ç”¨æˆ·è¾“å…¥ï¼Œä¸åŒ…å«è”ç³»äººæ¶ˆæ¯ã€‚
 */
enum class MessageSender(
    val prefix: String,
    val displayName: String
) {
    /**
     * ç”¨æˆ·å‘é€çš„æ¶ˆæ¯
     * ã€å½“å‰ç‰ˆæœ¬ã€‘ï¼šä»…æ­¤ç±»å‹è¢«å®é™…ä½¿ç”¨
     */
    USER("[User]", "æˆ‘"),

    /**
     * è”ç³»äººå‘é€çš„æ¶ˆæ¯
     * ã€é¢„ç•™ã€‘ï¼šåç»­ç‰ˆæœ¬æ‰©å±•ä½¿ç”¨
     */
    CONTACT("[Contact]", "å¯¹æ–¹");

    companion object {
        fun fromPrefix(prefix: String): MessageSender? {
            return values().find { it.prefix == prefix }
        }
    }
}
```

#### 4.1.2 TimestampedMessage æ•°æ®ç±»

**æ–‡ä»¶è·¯å¾„**ï¼š`domain/model/TimestampedMessage.kt`

```kotlin
package com.empathy.ai.domain.model

import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

/**
 * å¸¦æ—¶é—´æˆ³çš„å¯¹è¯æ¶ˆæ¯
 *
 * ç”¨äºæ„å»ºå¸¦æ—¶é—´æµé€æ ‡è®°çš„ä¸Šä¸‹æ–‡
 *
 * @property content æ¶ˆæ¯å†…å®¹
 * @property timestamp æ¶ˆæ¯æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
 * @property sender æ¶ˆæ¯å‘é€è€…
 */
data class TimestampedMessage(
    val content: String,
    val timestamp: Long,
    val sender: MessageSender
) {
    init {
        require(content.isNotBlank()) { "æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º" }
        require(timestamp > 0) { "æ—¶é—´æˆ³å¿…é¡»å¤§äº0" }
    }

    /**
     * è·å–æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸² (HH:mm)
     */
    fun getFormattedTime(): String {
        val sdf = SimpleDateFormat("HH:mm", Locale.getDefault())
        return sdf.format(Date(timestamp))
    }

    /**
     * è·å–æ ¼å¼åŒ–çš„æ—¥æœŸå­—ç¬¦ä¸² (yyyy-MM-dd)
     */
    fun getFormattedDate(): String {
        val sdf = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
        return sdf.format(Date(timestamp))
    }

    /**
     * è½¬æ¢ä¸ºæ˜¾ç¤ºæ ¼å¼
     * ç¤ºä¾‹: [User]: ä½ å¥½ (10:30)
     */
    fun toDisplayString(showTime: Boolean = true): String {
        return if (showTime) {
            "${sender.prefix}: $content (${getFormattedTime()})"
        } else {
            "${sender.prefix}: $content"
        }
    }
}
```

#### 4.1.3 TimeFlowMarker å¯†å°ç±»

**æ–‡ä»¶è·¯å¾„**ï¼š`domain/model/TimeFlowMarker.kt`

```kotlin
package com.empathy.ai.domain.model

/**
 * æ—¶é—´æµé€æ ‡è®°ç±»å‹
 *
 * ç”¨äºåœ¨å¯¹è¯å†å²ä¸­æ’å…¥æ—¶é—´é—´éš”æç¤ºï¼Œæ¨¡æ‹Ÿäººç±»ç¿»çœ‹èŠå¤©è®°å½•çš„å¿ƒç†æ´»åŠ¨
 */
sealed class TimeFlowMarker {

    companion object {
        /**
         * æ—¶é—´å•ä½å¸¸é‡
         *
         * ã€æœ¬åœ°åŒ–è¯´æ˜ã€‘å½“å‰ç¡¬ç¼–ç ä¸­æ–‡ï¼Œåç»­ç‰ˆæœ¬å»ºè®®æå–åˆ°strings.xml
         * æå–ä¸ºå¸¸é‡ä¾¿äºåç»­å›½é™…åŒ–æ”¹é€ 
         */
        const val UNIT_MINUTE = "åˆ†é’Ÿ"
        const val UNIT_HOUR = "å°æ—¶"

        /**
         * æ ¼å¼åŒ–æ¨¡æ¿å¸¸é‡
         */
        const val TEMPLATE_DATE_CHANGE = "--- [%s] ---"
        const val TEMPLATE_SHORT_GAP = "--- (ç»è¿‡äº† %s) ---"
        const val TEMPLATE_LONG_GAP = "--- (è·ç¦»ä¸Šæ¬¡å¯¹è¯å·²è¿‡ %d %sï¼Œæ³¨æ„å¯¹æ–¹å¯èƒ½çš„æƒ…ç»ªå †ç§¯) ---"
    }

    /**
     * æ—¥æœŸå˜æ›´æ ‡è®°
     * ç¤ºä¾‹: --- [2025-12-16] ---
     */
    data class DateChange(val date: String) : TimeFlowMarker() {
        override fun toDisplayString(): String = TEMPLATE_DATE_CHANGE.format(date)
    }

    /**
     * çŸ­é—´éš”æ ‡è®°ï¼ˆ10åˆ†é’Ÿ ~ 3å°æ—¶ï¼‰
     * ç¤ºä¾‹: --- (ç»è¿‡äº† 45 åˆ†é’Ÿ) ---
     */
    data class ShortGap(val minutes: Int) : TimeFlowMarker() {
        override fun toDisplayString(): String {
            val duration = if (minutes >= 60) {
                "${minutes / 60} $UNIT_HOUR"
            } else {
                "$minutes $UNIT_MINUTE"
            }
            return TEMPLATE_SHORT_GAP.format(duration)
        }
    }

    /**
     * é•¿é—´éš”æ ‡è®°ï¼ˆ> 3å°æ—¶ï¼‰
     * ç¤ºä¾‹: --- (è·ç¦»ä¸Šæ¬¡å¯¹è¯å·²è¿‡ 6 å°æ—¶ï¼Œæ³¨æ„æƒ…ç»ªå˜åŒ–) ---
     */
    data class LongGap(val hours: Int) : TimeFlowMarker() {
        override fun toDisplayString(): String {
            return TEMPLATE_LONG_GAP.format(hours, UNIT_HOUR)
        }
    }

    /**
     * æ— æ ‡è®°ï¼ˆçƒ­å¯¹è¯ï¼Œ< 10åˆ†é’Ÿï¼‰
     */
    object None : TimeFlowMarker() {
        override fun toDisplayString(): String = ""
    }

    /**
     * è½¬æ¢ä¸ºæ˜¾ç¤ºå­—ç¬¦ä¸²
     */
    abstract fun toDisplayString(): String
}
```

#### 4.1.4 ConversationContextConfig é…ç½®ç±»

**æ–‡ä»¶è·¯å¾„**ï¼š`domain/model/ConversationContextConfig.kt`

```kotlin
package com.empathy.ai.domain.model

/**
 * å¯¹è¯ä¸Šä¸‹æ–‡é…ç½®
 *
 * @property historyCount å†å²å¯¹è¯æ¡æ•° (0/5/10)
 * @property hotSessionThreshold çƒ­å¯¹è¯é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤10åˆ†é’Ÿ
 * @property warmSessionThreshold æ¸©å¯¹è¯é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤3å°æ—¶
 */
data class ConversationContextConfig(
    val historyCount: Int = DEFAULT_HISTORY_COUNT,
    val hotSessionThreshold: Long = DEFAULT_HOT_SESSION_THRESHOLD,
    val warmSessionThreshold: Long = DEFAULT_WARM_SESSION_THRESHOLD
) {
    companion object {
        const val DEFAULT_HISTORY_COUNT = 5
        const val DEFAULT_HOT_SESSION_THRESHOLD = 10 * 60 * 1000L      // 10åˆ†é’Ÿ
        const val DEFAULT_WARM_SESSION_THRESHOLD = 3 * 60 * 60 * 1000L // 3å°æ—¶

        val HISTORY_COUNT_OPTIONS = listOf(0, 5, 10)
    }

    init {
        require(historyCount in HISTORY_COUNT_OPTIONS) {
            "å†å²æ¡æ•°å¿…é¡»æ˜¯ ${HISTORY_COUNT_OPTIONS.joinToString()} ä¹‹ä¸€"
        }
        require(hotSessionThreshold > 0) { "çƒ­å¯¹è¯é˜ˆå€¼å¿…é¡»å¤§äº0" }
        require(warmSessionThreshold > hotSessionThreshold) {
            "æ¸©å¯¹è¯é˜ˆå€¼å¿…é¡»å¤§äºçƒ­å¯¹è¯é˜ˆå€¼"
        }
    }
}
```


#### 4.1.5 ConversationContextBuilder æ„å»ºå™¨

**æ–‡ä»¶è·¯å¾„**ï¼š`domain/util/ConversationContextBuilder.kt`

```kotlin
package com.empathy.ai.domain.util

import com.empathy.ai.domain.model.ConversationContextConfig
import com.empathy.ai.domain.model.TimeFlowMarker
import com.empathy.ai.domain.model.TimestampedMessage
import java.time.Instant
import java.time.ZoneId
import java.time.format.DateTimeFormatter
import java.util.Locale
import javax.inject.Inject
import javax.inject.Singleton

/**
 * å¯¹è¯ä¸Šä¸‹æ–‡æ„å»ºå™¨
 *
 * è´Ÿè´£æ„å»ºå¸¦æ—¶é—´æµé€æ ‡è®°çš„å¯¹è¯å†å²ï¼Œæ¨¡æ‹Ÿäººç±»ç¿»çœ‹èŠå¤©è®°å½•çš„å¿ƒç†æ´»åŠ¨ã€‚
 *
 * æ—¶é—´æµé€æ ‡è®°ç­–ç•¥ï¼š
 * - < 10åˆ†é’Ÿï¼šHot Sessionï¼Œä¸æ’å…¥æ ‡è®°
 * - 10åˆ†é’Ÿ ~ 3å°æ—¶ï¼šWarm Sessionï¼Œæ’å…¥è½»æ ‡è®°
 * - > 3å°æ—¶ï¼šCold Sessionï¼Œæ’å…¥å¼ºæ ‡è®°å¹¶æç¤ºæƒ…ç»ªå˜åŒ–
 * - è·¨å¤©ï¼šæ’å…¥æ—¥æœŸæ ‡è®°
 *
 * ã€çº¿ç¨‹å®‰å…¨è¯´æ˜ã€‘
 * æœ¬ç±»æ˜¯ @Singleton å•ä¾‹ï¼Œä½¿ç”¨ java.time.format.DateTimeFormatter è¿›è¡Œæ—¥æœŸæ ¼å¼åŒ–ã€‚
 * DateTimeFormatter æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥å®‰å…¨åœ°åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å…±äº«ä½¿ç”¨ã€‚
 */
@Singleton
class ConversationContextBuilder @Inject constructor() {

    /**
     * æ—¥æœŸæ ¼å¼åŒ–å™¨ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
     *
     * ã€é‡è¦ã€‘ä½¿ç”¨ java.time.format.DateTimeFormatter æ›¿ä»£ SimpleDateFormat
     * åŸå› ï¼šSimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨ @Singleton å•ä¾‹ä¸­ä½¿ç”¨ä¼šå¯¼è‡´å¹¶å‘é—®é¢˜
     * è¦æ±‚ï¼šAndroid API 26+ (Android 8.0+)ï¼Œæœ¬é¡¹ç›® minSdk=24 éœ€è¦å¯ç”¨ coreLibraryDesugaring
     */
    private val dateFormatter: DateTimeFormatter = DateTimeFormatter
        .ofPattern("yyyy-MM-dd", Locale.getDefault())
        .withZone(ZoneId.systemDefault())

    /**
     * æ„å»ºå¸¦æ—¶é—´æµé€æ ‡è®°çš„å¯¹è¯å†å²
     *
     * @param messages æŒ‰æ—¶é—´æ­£åºæ’åˆ—çš„æ¶ˆæ¯åˆ—è¡¨
     * @param config ä¸Šä¸‹æ–‡é…ç½®
     * @return æ ¼å¼åŒ–åçš„å¯¹è¯å†å²å­—ç¬¦ä¸²
     */
    fun buildHistoryContext(
        messages: List<TimestampedMessage>,
        config: ConversationContextConfig = ConversationContextConfig()
    ): String {
        if (messages.isEmpty()) return ""

        return buildString {
            appendLine("ã€å†å²å¯¹è¯ã€‘(æœ€è¿‘${messages.size}æ¡)")

            var previousTimestamp: Long? = null
            var previousDate: String? = null

            messages.forEach { message ->
                // è®¡ç®—æ—¶é—´æ ‡è®°
                val marker = calculateTimeMarker(
                    previousTimestamp = previousTimestamp,
                    currentTimestamp = message.timestamp,
                    previousDate = previousDate,
                    config = config
                )

                // æ’å…¥æ—¶é—´æ ‡è®°ï¼ˆå¦‚æœæœ‰ï¼‰
                val markerStr = marker.toDisplayString()
                if (markerStr.isNotEmpty()) {
                    appendLine(markerStr)
                }

                // æ·»åŠ æ¶ˆæ¯ï¼ˆåœ¨æ—¶é—´é—´éš”åæ˜¾ç¤ºæ—¶é—´ï¼‰
                val showTime = marker !is TimeFlowMarker.None
                appendLine(message.toDisplayString(showTime))

                // æ›´æ–°å‰ä¸€æ¡æ¶ˆæ¯çš„ä¿¡æ¯
                previousTimestamp = message.timestamp
                previousDate = message.getFormattedDate()
            }
        }.trimEnd()
    }

    /**
     * è®¡ç®—æ—¶é—´æµé€æ ‡è®°
     *
     * @param previousTimestamp ä¸Šä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³
     * @param currentTimestamp å½“å‰æ¶ˆæ¯çš„æ—¶é—´æˆ³
     * @param previousDate ä¸Šä¸€æ¡æ¶ˆæ¯çš„æ—¥æœŸ
     * @param config é…ç½®å‚æ•°
     * @return æ—¶é—´æµé€æ ‡è®°
     */
    fun calculateTimeMarker(
        previousTimestamp: Long?,
        currentTimestamp: Long,
        previousDate: String?,
        config: ConversationContextConfig
    ): TimeFlowMarker {
        // ç¬¬ä¸€æ¡æ¶ˆæ¯ä¸éœ€è¦æ ‡è®°
        if (previousTimestamp == null) return TimeFlowMarker.None

        val currentDate = formatDate(currentTimestamp)

        // ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦è·¨å¤©
        if (previousDate != null && previousDate != currentDate) {
            return TimeFlowMarker.DateChange(currentDate)
        }

        // è®¡ç®—æ—¶é—´é—´éš”
        val gap = currentTimestamp - previousTimestamp

        return when {
            // çƒ­å¯¹è¯ï¼š< 10åˆ†é’Ÿï¼Œä¸æ’å…¥æ ‡è®°
            gap < config.hotSessionThreshold -> TimeFlowMarker.None

            // æ¸©å¯¹è¯ï¼š10åˆ†é’Ÿ ~ 3å°æ—¶ï¼Œæ’å…¥è½»æ ‡è®°
            gap < config.warmSessionThreshold -> {
                val minutes = (gap / (60 * 1000)).toInt()
                TimeFlowMarker.ShortGap(minutes)
            }

            // å†·å¯¹è¯ï¼š> 3å°æ—¶ï¼Œæ’å…¥å¼ºæ ‡è®°
            else -> {
                val hours = (gap / (60 * 60 * 1000)).toInt()
                TimeFlowMarker.LongGap(hours)
            }
        }
    }

    /**
     * æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºæ—¥æœŸå­—ç¬¦ä¸²
     *
     * ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„ DateTimeFormatter
     */
    private fun formatDate(timestamp: Long): String {
        return dateFormatter.format(Instant.ofEpochMilli(timestamp))
    }
}
```

---

### 4.2 æ•°æ®å±‚è®¾è®¡

#### 4.2.1 ConversationLogDao æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`data/local/dao/ConversationLogDao.kt`

**æ–°å¢æ–¹æ³•**ï¼š

```kotlin
/**
 * è·å–æŒ‡å®šè”ç³»äººçš„æœ€è¿‘Næ¡å¯¹è¯è®°å½•
 * æŒ‰æ—¶é—´æˆ³æ­£åºæ’åˆ—ï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰
 *
 * ä½¿ç”¨å­æŸ¥è¯¢å…ˆè·å–æœ€è¿‘Næ¡ï¼ˆå€’åºï¼‰ï¼Œå†æ­£åºæ’åˆ—
 *
 * ã€SQLæ€§èƒ½åˆ†æã€‘
 * - åˆ©ç”¨ contact_id ç´¢å¼•å¿«é€Ÿå®šä½è”ç³»äººè®°å½•
 * - åˆ©ç”¨ timestamp ç´¢å¼•è¿›è¡Œæ’åº
 * - å­æŸ¥è¯¢ + LIMIT é¿å…å…¨è¡¨æ‰«æ
 * - é¢„ä¼°æ€§èƒ½ï¼šå•äººAppåœºæ™¯ï¼ˆ<10ä¸‡æ¡è®°å½•ï¼‰ï¼ŒæŸ¥è¯¢æ—¶é—´ < 10ms
 */
@Query("""
    SELECT * FROM (
        SELECT * FROM conversation_logs 
        WHERE contact_id = :contactId 
        ORDER BY timestamp DESC 
        LIMIT :limit
    ) 
    ORDER BY timestamp ASC
""")
suspend fun getRecentConversations(contactId: String, limit: Int): List<ConversationLogEntity>
```

#### 4.2.2 ConversationRepository æ¥å£æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`domain/repository/ConversationRepository.kt`

**æ–°å¢æ–¹æ³•**ï¼š

```kotlin
/**
 * è·å–æŒ‡å®šè”ç³»äººçš„æœ€è¿‘Næ¡å¯¹è¯è®°å½•
 *
 * @param contactId è”ç³»äººID
 * @param limit æœ€å¤§æ¡æ•°
 * @return æŒ‰æ—¶é—´æ­£åºæ’åˆ—çš„å¯¹è¯è®°å½•ï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰
 */
suspend fun getRecentConversations(
    contactId: String,
    limit: Int
): Result<List<ConversationLog>>
```

#### 4.2.3 ConversationRepositoryImpl å®ç°

**æ–‡ä»¶è·¯å¾„**ï¼š`data/repository/ConversationRepositoryImpl.kt`

**æ–°å¢æ–¹æ³•**ï¼š

```kotlin
override suspend fun getRecentConversations(
    contactId: String,
    limit: Int
): Result<List<ConversationLog>> = withContext(Dispatchers.IO) {
    try {
        val entities = dao.getRecentConversations(contactId, limit)
        Result.success(entities.map { it.toDomain() })
    } catch (e: Exception) {
        Log.e(TAG, "è·å–æœ€è¿‘å¯¹è¯è®°å½•å¤±è´¥: contactId=$contactId, limit=$limit", e)
        Result.failure(e)
    }
}
```

#### 4.2.4 SettingsPreferences æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`data/local/SettingsPreferences.kt`ï¼ˆæˆ–ç°æœ‰è®¾ç½®å­˜å‚¨ç±»ï¼‰

**æ–°å¢æ–¹æ³•**ï¼š

```kotlin
companion object {
    private const val KEY_HISTORY_CONVERSATION_COUNT = "history_conversation_count"
    private const val DEFAULT_HISTORY_COUNT = 5
}

/**
 * è·å–å†å²å¯¹è¯æ¡æ•°
 */
fun getHistoryConversationCount(): Int {
    return prefs.getInt(KEY_HISTORY_CONVERSATION_COUNT, DEFAULT_HISTORY_COUNT)
}

/**
 * è®¾ç½®å†å²å¯¹è¯æ¡æ•°
 */
fun setHistoryConversationCount(count: Int) {
    prefs.edit().putInt(KEY_HISTORY_CONVERSATION_COUNT, count).apply()
}
```

#### 4.2.5 SettingsRepository æ¥å£æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`domain/repository/SettingsRepository.kt`

**æ–°å¢æ–¹æ³•**ï¼š

```kotlin
/**
 * è·å–å†å²å¯¹è¯æ¡æ•°é…ç½®
 * @return 0/5/10ï¼Œé»˜è®¤5
 */
suspend fun getHistoryConversationCount(): Result<Int>

/**
 * è®¾ç½®å†å²å¯¹è¯æ¡æ•°
 * @param count æ¡æ•°ï¼Œå¿…é¡»æ˜¯ 0/5/10 ä¹‹ä¸€
 */
suspend fun setHistoryConversationCount(count: Int): Result<Unit>
```

---

### 4.3 ä¸šåŠ¡å±‚é›†æˆè®¾è®¡

#### 4.3.1 AnalyzeChatUseCase ä¿®æ”¹

**æ–‡ä»¶è·¯å¾„**ï¼š`domain/usecase/AnalyzeChatUseCase.kt`

**ä¿®æ”¹å†…å®¹**ï¼š

```kotlin
class AnalyzeChatUseCase @Inject constructor(
    // ... ç°æœ‰ä¾èµ– ...
    private val conversationContextBuilder: ConversationContextBuilder  // æ–°å¢
) {
    companion object {
        private const val TAG = "AnalyzeChatUseCase"
    }

    suspend operator fun invoke(
        contactId: String,
        rawScreenContext: List<String>
    ): Result<AnalysisResult> {
        // ... ç°æœ‰å‰ç½®æ£€æŸ¥é€»è¾‘ ...

        // ã€æ–°å¢ã€‘è·å–å†å²å¯¹è¯é…ç½®
        val historyCount = settingsRepository.getHistoryConversationCount()
            .getOrDefault(ConversationContextConfig.DEFAULT_HISTORY_COUNT)

        // ã€æ–°å¢ã€‘æ„å»ºå†å²ä¸Šä¸‹æ–‡
        val historyContext = if (historyCount > 0) {
            buildHistoryContext(contactId, historyCount)
        } else {
            ""
        }

        // æ„å»ºè¿è¡Œæ—¶æ•°æ®ï¼ˆåŠ å…¥å†å²ä¸Šä¸‹æ–‡ï¼‰
        val runtimeData = buildContextData(
            targetGoal = profile.targetGoal,
            facts = profile.facts,
            redTags = redTags,
            greenTags = greenTags,
            conversationHistory = maskedContext,
            historyContext = historyContext  // æ–°å¢å‚æ•°
        )

        // ... åç»­AIè°ƒç”¨é€»è¾‘ ...
    }

    /**
     * ã€æ–°å¢ã€‘æ„å»ºå†å²ä¸Šä¸‹æ–‡
     *
     * ã€é‡è¦è¯´æ˜ã€‘å½“å‰ç‰ˆæœ¬ä»…å›æ”¾ç”¨æˆ·ä¾§å†å²
     * åŸå› ï¼šæ•°æ®åº“ conversation_logs è¡¨åªå­˜å‚¨äº† user_input
     */
    private suspend fun buildHistoryContext(contactId: String, limit: Int): String {
        return try {
            val recentLogs = conversationRepository
                .getRecentConversations(contactId, limit)
                .getOrDefault(emptyList())

            if (recentLogs.isEmpty()) return ""

            // å°†ConversationLogè½¬æ¢ä¸ºTimestampedMessage
            // ã€æ³¨æ„ã€‘å½“å‰ç‰ˆæœ¬ sender å›ºå®šä¸º USER
            val messages = recentLogs.mapNotNull { log ->
                try {
                    TimestampedMessage(
                        content = log.userInput,
                        timestamp = log.timestamp,
                        sender = MessageSender.USER
                    )
                } catch (e: Exception) {
                    Log.w(TAG, "è·³è¿‡æ— æ•ˆçš„å¯¹è¯è®°å½•: ${log.id}", e)
                    null
                }
            }

            conversationContextBuilder.buildHistoryContext(messages)
        } catch (e: Exception) {
            Log.e(TAG, "æ„å»ºå†å²ä¸Šä¸‹æ–‡å¤±è´¥ï¼Œé™çº§ä¸ºç©ºå†å²", e)
            ""  // é™çº§ï¼šè¿”å›ç©ºå†å²ï¼Œä¸å½±å“ä¸»æµç¨‹
        }
    }

    /**
     * ã€ä¿®æ”¹ã€‘æ„å»ºä¸Šä¸‹æ–‡æ•°æ®ï¼ŒåŠ å…¥å†å²å¯¹è¯åŒºå—
     */
    private fun buildContextData(
        targetGoal: String,
        facts: List<Fact>,
        redTags: List<BrainTag>,
        greenTags: List<BrainTag>,
        conversationHistory: List<String>,
        historyContext: String = ""  // æ–°å¢å‚æ•°
    ): String {
        return buildString {
            // ã€æ–°å¢ã€‘å†å²å¯¹è¯åŒºå—ï¼ˆæ”¾åœ¨æœ€å‰é¢ï¼Œè®©AIå…ˆäº†è§£èƒŒæ™¯ï¼‰
            if (historyContext.isNotBlank()) {
                appendLine(historyContext)
                appendLine()
            }

            appendLine("ã€æ”»ç•¥ç›®æ ‡ã€‘")
            appendLine(targetGoal)
            appendLine()

            // ... å…¶ä½™éƒ¨åˆ†ä¿æŒä¸å˜ ...
        }
    }
}
```


---

### 4.4 è¡¨ç°å±‚è®¾è®¡

#### 4.4.1 SettingsUiState æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`presentation/ui/screen/settings/SettingsUiState.kt`

**æ–°å¢å­—æ®µ**ï¼š

```kotlin
data class SettingsUiState(
    // ... ç°æœ‰å­—æ®µ ...

    /**
     * å†å²å¯¹è¯æ¡æ•°é…ç½®
     */
    val historyConversationCount: Int = 5,

    /**
     * å†å²æ¡æ•°é€‰é¡¹
     */
    val historyCountOptions: List<HistoryCountOption> = listOf(
        HistoryCountOption(0, "ä¸å‘é€å†å²", "æ¯æ¬¡åˆ†æç‹¬ç«‹ï¼Œä¸åŒ…å«å†å²å¯¹è¯"),
        HistoryCountOption(5, "æœ€è¿‘5æ¡", "æ¨èï¼Œå¹³è¡¡ä¸Šä¸‹æ–‡å’ŒTokenæ¶ˆè€—"),
        HistoryCountOption(10, "æœ€è¿‘10æ¡", "æ›´å®Œæ•´çš„ä¸Šä¸‹æ–‡ï¼ŒTokenæ¶ˆè€—è¾ƒé«˜")
    )
)

/**
 * å†å²æ¡æ•°é€‰é¡¹
 */
data class HistoryCountOption(
    val count: Int,
    val label: String,
    val description: String
)
```

#### 4.4.2 SettingsUiEvent æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`presentation/ui/screen/settings/SettingsUiEvent.kt`

**æ–°å¢äº‹ä»¶**ï¼š

```kotlin
sealed class SettingsUiEvent {
    // ... ç°æœ‰äº‹ä»¶ ...

    /**
     * æ›´æ”¹å†å²å¯¹è¯æ¡æ•°
     */
    data class ChangeHistoryConversationCount(val count: Int) : SettingsUiEvent()
}
```

#### 4.4.3 SettingsViewModel æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`presentation/viewmodel/SettingsViewModel.kt`

**æ–°å¢é€»è¾‘**ï¼š

```kotlin
@HiltViewModel
class SettingsViewModel @Inject constructor(
    // ... ç°æœ‰ä¾èµ– ...
) : ViewModel() {

    init {
        loadSettings()
    }

    private fun loadSettings() {
        viewModelScope.launch {
            // ... ç°æœ‰åŠ è½½é€»è¾‘ ...

            // åŠ è½½å†å²å¯¹è¯æ¡æ•°é…ç½®
            val historyCount = settingsRepository.getHistoryConversationCount()
                .getOrDefault(5)
            _uiState.update { it.copy(historyConversationCount = historyCount) }
        }
    }

    fun onEvent(event: SettingsUiEvent) {
        when (event) {
            // ... ç°æœ‰äº‹ä»¶å¤„ç† ...

            is SettingsUiEvent.ChangeHistoryConversationCount -> {
                changeHistoryConversationCount(event.count)
            }
        }
    }

    private fun changeHistoryConversationCount(count: Int) {
        viewModelScope.launch {
            settingsRepository.setHistoryConversationCount(count)
                .onSuccess {
                    _uiState.update { it.copy(historyConversationCount = count) }
                }
                .onFailure { e ->
                    Log.e(TAG, "ä¿å­˜å†å²æ¡æ•°é…ç½®å¤±è´¥", e)
                }
        }
    }
}
```

#### 4.4.4 SettingsScreen UIç»„ä»¶

**æ–‡ä»¶è·¯å¾„**ï¼š`presentation/ui/screen/settings/SettingsScreen.kt`

**æ–°å¢ç»„ä»¶**ï¼š

```kotlin
@Composable
fun HistoryConversationCountSection(
    selectedCount: Int,
    options: List<HistoryCountOption>,
    onCountChange: (Int) -> Unit,
    modifier: Modifier = Modifier
) {
    Column(modifier = modifier.padding(16.dp)) {
        Text(
            text = "å†å²å¯¹è¯æ¡æ•°",
            style = MaterialTheme.typography.titleMedium
        )

        Spacer(modifier = Modifier.height(8.dp))

        options.forEach { option ->
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .clickable { onCountChange(option.count) }
                    .padding(vertical = 8.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                RadioButton(
                    selected = selectedCount == option.count,
                    onClick = { onCountChange(option.count) }
                )

                Spacer(modifier = Modifier.width(8.dp))

                Column {
                    Text(
                        text = option.label,
                        style = MaterialTheme.typography.bodyLarge
                    )
                    Text(
                        text = option.description,
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }
        }

        Spacer(modifier = Modifier.height(8.dp))

        Text(
            text = "å‘é€ç»™AIçš„å†å²å¯¹è¯æ•°é‡ï¼Œå¸®åŠ©AIç†è§£å¯¹è¯ä¸Šä¸‹æ–‡å’Œæ—¶é—´é—´éš”",
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}
```

---

## 5. ä¾èµ–æ³¨å…¥é…ç½®

### 5.1 MemoryModule æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`di/MemoryModule.kt`

**æ–°å¢æä¾›æ–¹æ³•**ï¼š

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object MemoryModule {

    // ... ç°æœ‰æä¾›æ–¹æ³• ...

    @Provides
    @Singleton
    fun provideConversationContextBuilder(): ConversationContextBuilder {
        return ConversationContextBuilder()
    }
}
```

---

## 6. é”™è¯¯å¤„ç†è®¾è®¡

### 6.1 é”™è¯¯ç±»å‹

| é”™è¯¯åœºæ™¯ | é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ |
|---------|---------|---------|
| æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ | Exception | è¿”å›ç©ºåˆ—è¡¨ï¼Œè®°å½•æ—¥å¿— |
| é…ç½®è¯»å–å¤±è´¥ | Exception | ä½¿ç”¨é»˜è®¤å€¼(5æ¡) |
| æ—¶é—´æˆ³å¼‚å¸¸ | IllegalArgumentException | è·³è¿‡è¯¥æ¡æ¶ˆæ¯ |
| æ¶ˆæ¯å†…å®¹ä¸ºç©º | IllegalArgumentException | è·³è¿‡è¯¥æ¡æ¶ˆæ¯ |

### 6.2 é™çº§ç­–ç•¥

```kotlin
/**
 * é™çº§ç­–ç•¥ï¼šä»»ä½•å¼‚å¸¸éƒ½ä¸å½±å“ä¸»æµç¨‹
 */
private suspend fun buildHistoryContext(contactId: String, limit: Int): String {
    return try {
        // æ­£å¸¸é€»è¾‘
        val recentLogs = conversationRepository
            .getRecentConversations(contactId, limit)
            .getOrDefault(emptyList())

        if (recentLogs.isEmpty()) return ""

        val messages = recentLogs.mapNotNull { log ->
            try {
                TimestampedMessage(
                    content = log.userInput,
                    timestamp = log.timestamp,
                    sender = MessageSender.USER
                )
            } catch (e: Exception) {
                Log.w(TAG, "è·³è¿‡æ— æ•ˆçš„å¯¹è¯è®°å½•: ${log.id}", e)
                null  // è·³è¿‡æ— æ•ˆè®°å½•
            }
        }

        conversationContextBuilder.buildHistoryContext(messages)
    } catch (e: Exception) {
        // é™çº§ï¼šè¿”å›ç©ºå†å²ï¼Œä¸å½±å“ä¸»æµç¨‹
        Log.e(TAG, "æ„å»ºå†å²ä¸Šä¸‹æ–‡å¤±è´¥ï¼Œé™çº§ä¸ºç©ºå†å²", e)
        ""
    }
}
```

---

## 7. æ€§èƒ½è®¾è®¡

### 7.1 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

**ç°æœ‰ç´¢å¼•**ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ï¼š

```kotlin
@Entity(
    tableName = "conversation_logs",
    indices = [
        Index(value = ["contact_id"]),
        Index(value = ["timestamp"]),
        Index(value = ["is_summarized"])
    ]
)
```

**æŸ¥è¯¢æ€§èƒ½åˆ†æ**ï¼š

| æ•°æ®è§„æ¨¡ | é¢„ä¼°æŸ¥è¯¢æ—¶é—´ | è¯´æ˜ |
|---------|-------------|------|
| < 1ä¸‡æ¡ | < 5ms | æ­£å¸¸ä½¿ç”¨åœºæ™¯ |
| 1-10ä¸‡æ¡ | < 10ms | é‡åº¦ä½¿ç”¨åœºæ™¯ |
| 10-50ä¸‡æ¡ | < 50ms | æç«¯åœºæ™¯ |
| > 50ä¸‡æ¡ | å¯èƒ½è¾ƒæ…¢ | å»ºè®®æ·»åŠ å¤åˆç´¢å¼• |

**åç»­ä¼˜åŒ–å»ºè®®**ï¼š

```sql
-- å¤åˆç´¢å¼•ï¼ˆåç»­ç‰ˆæœ¬è€ƒè™‘ï¼‰
CREATE INDEX idx_contact_timestamp 
ON conversation_logs(contact_id, timestamp DESC)
```

### 7.2 å†…å­˜ä¼˜åŒ–

- **é™åˆ¶å†å²æ¡æ•°**ï¼šæœ€å¤š10æ¡ï¼Œé¿å…å†…å­˜å ç”¨è¿‡å¤§
- **å­—ç¬¦ä¸²æ„å»º**ï¼šä½¿ç”¨ `buildString` é¿å…å¤šæ¬¡å­—ç¬¦ä¸²æ‹¼æ¥
- **æ‡’åŠ è½½**ï¼šåªåœ¨éœ€è¦æ—¶æ‰æŸ¥è¯¢å†å²å¯¹è¯

### 7.3 Tokenæ¶ˆè€—ä¼°ç®—

| å†å²æ¡æ•° | é¢„ä¼°Tokenå¢åŠ  | è¯´æ˜ |
|---------|--------------|------|
| 0æ¡ | 0 | ä¸å‘é€å†å² |
| 5æ¡ | ~200-400 | çº¦5-10%å¢åŠ  |
| 10æ¡ | ~400-800 | çº¦10-20%å¢åŠ  |

---

## 8. æµ‹è¯•è®¾è®¡

### 8.1 å•å…ƒæµ‹è¯•

#### 8.1.1 ConversationContextBuilderTest

**æ–‡ä»¶è·¯å¾„**ï¼š`test/domain/util/ConversationContextBuilderTest.kt`

```kotlin
class ConversationContextBuilderTest {

    private lateinit var builder: ConversationContextBuilder

    @Before
    fun setup() {
        builder = ConversationContextBuilder()
    }

    @Test
    fun `ç©ºæ¶ˆæ¯åˆ—è¡¨è¿”å›ç©ºå­—ç¬¦ä¸²`() {
        val result = builder.buildHistoryContext(emptyList())
        assertEquals("", result)
    }

    @Test
    fun `å•æ¡æ¶ˆæ¯ä¸æ’å…¥æ—¶é—´æ ‡è®°`() {
        val messages = listOf(
            TimestampedMessage("ä½ å¥½", 1702684200000, MessageSender.USER)
        )
        val result = builder.buildHistoryContext(messages)

        assertTrue(result.contains("[User]: ä½ å¥½"))
        assertFalse(result.contains("---"))
    }

    @Test
    fun `çƒ­å¯¹è¯ä¸æ’å…¥æ—¶é—´æ ‡è®°`() {
        val baseTime = 1702684200000L
        val messages = listOf(
            TimestampedMessage("ä½ å¥½", baseTime, MessageSender.USER),
            TimestampedMessage("ä½ å¥½å‘€", baseTime + 5 * 60 * 1000, MessageSender.USER)
        )
        val result = builder.buildHistoryContext(messages)

        assertFalse(result.contains("ç»è¿‡äº†"))
    }

    @Test
    fun `æ¸©å¯¹è¯æ’å…¥è½»æ ‡è®°`() {
        val baseTime = 1702684200000L
        val messages = listOf(
            TimestampedMessage("ä½ å¥½", baseTime, MessageSender.USER),
            TimestampedMessage("ä½ å¥½å‘€", baseTime + 30 * 60 * 1000, MessageSender.USER)
        )
        val result = builder.buildHistoryContext(messages)

        assertTrue(result.contains("ç»è¿‡äº† 30 åˆ†é’Ÿ"))
    }

    @Test
    fun `å†·å¯¹è¯æ’å…¥å¼ºæ ‡è®°å¹¶æç¤ºæƒ…ç»ª`() {
        val baseTime = 1702684200000L
        val messages = listOf(
            TimestampedMessage("ä½ å¥½", baseTime, MessageSender.USER),
            TimestampedMessage("ä½ å¥½å‘€", baseTime + 6 * 60 * 60 * 1000, MessageSender.USER)
        )
        val result = builder.buildHistoryContext(messages)

        assertTrue(result.contains("è·ç¦»ä¸Šæ¬¡å¯¹è¯å·²è¿‡ 6 å°æ—¶"))
        assertTrue(result.contains("æƒ…ç»ªå †ç§¯"))
    }

    @Test
    fun `è·¨å¤©æ’å…¥æ—¥æœŸæ ‡è®°`() {
        val day1 = 1702684200000L
        val day2 = day1 + 24 * 60 * 60 * 1000
        val messages = listOf(
            TimestampedMessage("æ™šå®‰", day1, MessageSender.USER),
            TimestampedMessage("æ—©å®‰", day2, MessageSender.USER)
        )
        val result = builder.buildHistoryContext(messages)

        assertTrue(result.contains("--- ["))
    }
}
```

#### 8.1.2 TimeFlowMarkerTest

**æ–‡ä»¶è·¯å¾„**ï¼š`test/domain/model/TimeFlowMarkerTest.kt`

```kotlin
class TimeFlowMarkerTest {

    @Test
    fun `DateChangeæ˜¾ç¤ºæ ¼å¼æ­£ç¡®`() {
        val marker = TimeFlowMarker.DateChange("2025-12-16")
        assertEquals("--- [2025-12-16] ---", marker.toDisplayString())
    }

    @Test
    fun `ShortGapåˆ†é’Ÿæ˜¾ç¤ºæ ¼å¼æ­£ç¡®`() {
        val marker = TimeFlowMarker.ShortGap(30)
        assertEquals("--- (ç»è¿‡äº† 30 åˆ†é’Ÿ) ---", marker.toDisplayString())
    }

    @Test
    fun `ShortGapå°æ—¶æ˜¾ç¤ºæ ¼å¼æ­£ç¡®`() {
        val marker = TimeFlowMarker.ShortGap(90)
        assertEquals("--- (ç»è¿‡äº† 1 å°æ—¶) ---", marker.toDisplayString())
    }

    @Test
    fun `LongGapæ˜¾ç¤ºæ ¼å¼æ­£ç¡®`() {
        val marker = TimeFlowMarker.LongGap(6)
        assertTrue(marker.toDisplayString().contains("6 å°æ—¶"))
        assertTrue(marker.toDisplayString().contains("æƒ…ç»ªå †ç§¯"))
    }

    @Test
    fun `Noneè¿”å›ç©ºå­—ç¬¦ä¸²`() {
        assertEquals("", TimeFlowMarker.None.toDisplayString())
    }
}
```

#### 8.1.3 TimestampedMessageTest

**æ–‡ä»¶è·¯å¾„**ï¼š`test/domain/model/TimestampedMessageTest.kt`

```kotlin
class TimestampedMessageTest {

    @Test
    fun `toDisplayStringåŒ…å«å‘é€è€…å‰ç¼€`() {
        val message = TimestampedMessage("ä½ å¥½", 1702684200000, MessageSender.USER)
        assertTrue(message.toDisplayString().startsWith("[User]:"))
    }

    @Test
    fun `toDisplayStringåŒ…å«æ—¶é—´`() {
        val message = TimestampedMessage("ä½ å¥½", 1702684200000, MessageSender.USER)
        val result = message.toDisplayString(showTime = true)
        assertTrue(result.contains("("))
        assertTrue(result.contains(")"))
    }

    @Test
    fun `toDisplayStringä¸åŒ…å«æ—¶é—´`() {
        val message = TimestampedMessage("ä½ å¥½", 1702684200000, MessageSender.USER)
        val result = message.toDisplayString(showTime = false)
        assertEquals("[User]: ä½ å¥½", result)
    }

    @Test(expected = IllegalArgumentException::class)
    fun `ç©ºå†…å®¹æŠ›å‡ºå¼‚å¸¸`() {
        TimestampedMessage("", 1702684200000, MessageSender.USER)
    }

    @Test(expected = IllegalArgumentException::class)
    fun `ç©ºç™½å†…å®¹æŠ›å‡ºå¼‚å¸¸`() {
        TimestampedMessage("   ", 1702684200000, MessageSender.USER)
    }

    @Test(expected = IllegalArgumentException::class)
    fun `æ— æ•ˆæ—¶é—´æˆ³æŠ›å‡ºå¼‚å¸¸`() {
        TimestampedMessage("ä½ å¥½", 0, MessageSender.USER)
    }

    @Test(expected = IllegalArgumentException::class)
    fun `è´Ÿæ•°æ—¶é—´æˆ³æŠ›å‡ºå¼‚å¸¸`() {
        TimestampedMessage("ä½ å¥½", -1, MessageSender.USER)
    }
}
```

#### 8.1.4 AnalyzeChatUseCaseHistoryContextTest

**æ–‡ä»¶è·¯å¾„**ï¼š`test/domain/usecase/AnalyzeChatUseCaseHistoryContextTest.kt`

```kotlin
/**
 * AnalyzeChatUseCase å†å²ä¸Šä¸‹æ–‡æ„å»ºæµ‹è¯•
 *
 * é‡ç‚¹æµ‹è¯• buildHistoryContext æ–¹æ³•çš„è¾¹ç•Œæ¡ä»¶å’Œé™çº§è¡Œä¸º
 */
class AnalyzeChatUseCaseHistoryContextTest {

    @Mock
    private lateinit var conversationRepository: ConversationRepository

    @Mock
    private lateinit var settingsRepository: SettingsRepository

    private lateinit var conversationContextBuilder: ConversationContextBuilder

    @Before
    fun setup() {
        MockKAnnotations.init(this)
        conversationContextBuilder = ConversationContextBuilder()
    }

    /**
     * ã€å…³é”®æµ‹è¯•ã€‘éªŒè¯ getRecentConversations è¿”å›ç©ºåˆ—è¡¨æ—¶çš„è¡Œä¸º
     *
     * åœºæ™¯ï¼šæ–°è”ç³»äººï¼Œæ²¡æœ‰ä»»ä½•å†å²å¯¹è¯è®°å½•
     * é¢„æœŸï¼šè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œä¸å½±å“ä¸»æµç¨‹
     */
    @Test
    fun `ç©ºå†å²è®°å½•è¿”å›ç©ºå­—ç¬¦ä¸²`() = runTest {
        // Given: ä»“åº“è¿”å›ç©ºåˆ—è¡¨
        coEvery { 
            conversationRepository.getRecentConversations(any(), any()) 
        } returns Result.success(emptyList())

        // When: æ„å»ºå†å²ä¸Šä¸‹æ–‡
        val result = buildHistoryContextForTest("contact-123", 5)

        // Then: è¿”å›ç©ºå­—ç¬¦ä¸²
        assertEquals("", result)
    }

    /**
     * ã€å…³é”®æµ‹è¯•ã€‘éªŒè¯ä»“åº“æŸ¥è¯¢å¤±è´¥æ—¶çš„é™çº§è¡Œä¸º
     *
     * åœºæ™¯ï¼šæ•°æ®åº“æŸ¥è¯¢å¼‚å¸¸
     * é¢„æœŸï¼šè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œè®°å½•æ—¥å¿—ï¼Œä¸å½±å“ä¸»æµç¨‹
     */
    @Test
    fun `ä»“åº“æŸ¥è¯¢å¤±è´¥æ—¶é™çº§ä¸ºç©ºå†å²`() = runTest {
        // Given: ä»“åº“è¿”å›å¤±è´¥
        coEvery { 
            conversationRepository.getRecentConversations(any(), any()) 
        } returns Result.failure(Exception("æ•°æ®åº“æŸ¥è¯¢å¤±è´¥"))

        // When: æ„å»ºå†å²ä¸Šä¸‹æ–‡
        val result = buildHistoryContextForTest("contact-123", 5)

        // Then: é™çº§è¿”å›ç©ºå­—ç¬¦ä¸²
        assertEquals("", result)
    }

    /**
     * ã€å…³é”®æµ‹è¯•ã€‘éªŒè¯å†å²æ¡æ•°ä¸º0æ—¶ä¸æŸ¥è¯¢æ•°æ®åº“
     *
     * åœºæ™¯ï¼šç”¨æˆ·é…ç½®ä¸å‘é€å†å²
     * é¢„æœŸï¼šç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œä¸è°ƒç”¨ä»“åº“
     */
    @Test
    fun `å†å²æ¡æ•°ä¸º0æ—¶ä¸æŸ¥è¯¢æ•°æ®åº“`() = runTest {
        // Given: å†å²æ¡æ•°é…ç½®ä¸º0
        coEvery { 
            settingsRepository.getHistoryConversationCount() 
        } returns Result.success(0)

        // When: æ„å»ºå†å²ä¸Šä¸‹æ–‡
        val result = buildHistoryContextForTest("contact-123", 0)

        // Then: è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œä¸”ä¸è°ƒç”¨ä»“åº“
        assertEquals("", result)
        coVerify(exactly = 0) { 
            conversationRepository.getRecentConversations(any(), any()) 
        }
    }

    /**
     * è¾…åŠ©æ–¹æ³•ï¼šæ¨¡æ‹Ÿ buildHistoryContext é€»è¾‘
     */
    private suspend fun buildHistoryContextForTest(contactId: String, limit: Int): String {
        if (limit == 0) return ""

        return try {
            val recentLogs = conversationRepository
                .getRecentConversations(contactId, limit)
                .getOrDefault(emptyList())

            if (recentLogs.isEmpty()) return ""

            val messages = recentLogs.mapNotNull { log ->
                try {
                    TimestampedMessage(
                        content = log.userInput,
                        timestamp = log.timestamp,
                        sender = MessageSender.USER
                    )
                } catch (e: Exception) {
                    null
                }
            }

            conversationContextBuilder.buildHistoryContext(messages)
        } catch (e: Exception) {
            ""
        }
    }
}
```

### 8.2 æµ‹è¯•è¦†ç›–ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | é‡ç‚¹æµ‹è¯•é¡¹ |
|------|-----------|-----------|
| ConversationContextBuilder | 90%+ | æ—¶é—´æ ‡è®°ç®—æ³•ã€è¾¹ç•Œæ¡ä»¶ |
| TimeFlowMarker | 100% | æ‰€æœ‰æ ‡è®°ç±»å‹çš„æ˜¾ç¤ºæ ¼å¼ |
| TimestampedMessage | 100% | æ ¼å¼åŒ–ã€éªŒè¯é€»è¾‘ |
| ConversationContextConfig | 100% | é…ç½®éªŒè¯ |
| ConversationRepositoryæ‰©å±• | 80%+ | æŸ¥è¯¢æ­£ç¡®æ€§ã€æ’åº |
| SettingsRepositoryæ‰©å±• | 80%+ | é…ç½®è¯»å†™ |

---

## 9. å·²çŸ¥é™åˆ¶ä¸åç»­ä¼˜åŒ–

### 9.1 å½“å‰ç‰ˆæœ¬é™åˆ¶

| é™åˆ¶ | è¯´æ˜ | å½±å“ |
|------|------|------|
| ä»…å›æ”¾ç”¨æˆ·ä¾§å†å² | æ•°æ®åº“åªå­˜å‚¨user_input | AIåªèƒ½çœ‹åˆ°ç”¨æˆ·è¯´çš„è¯ |
| æ—¶é—´å­—ç¬¦ä¸²ç¡¬ç¼–ç  | "åˆ†é’Ÿ"ã€"å°æ—¶"ç­‰ä¸­æ–‡ | ä¸æ”¯æŒå¤šè¯­è¨€ |
| æ— å¤åˆç´¢å¼• | ä¾èµ–å•åˆ—ç´¢å¼• | æç«¯æ•°æ®é‡å¯èƒ½è¾ƒæ…¢ |

### 9.2 åç»­ä¼˜åŒ–æ–¹å‘

- [ ] æ‰©å±•æ•°æ®åº“è¡¨ï¼Œæ”¯æŒè”ç³»äººæ¶ˆæ¯å­˜å‚¨
- [ ] å­—ç¬¦ä¸²èµ„æºæœ¬åœ°åŒ–ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
- [x] ~~ä½¿ç”¨ `java.time` API æ›¿ä»£ `SimpleDateFormat`~~ âœ… v1.1å·²å®Œæˆ
- [ ] æ·»åŠ å¤åˆç´¢å¼•ä¼˜åŒ–å¤§æ•°æ®é‡æŸ¥è¯¢
- [ ] æ”¯æŒè‡ªå®šä¹‰æ—¶é—´é˜ˆå€¼é…ç½®

---

## 10. ç›¸å…³æ–‡æ¡£

- [PRD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºéœ€æ±‚](../PRD/PRD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºéœ€æ±‚.md)
- [FD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºåŠŸèƒ½è®¾è®¡](../FD/FD-00007-å¯¹è¯ä¸Šä¸‹æ–‡è¿ç»­æ€§å¢å¼ºåŠŸèƒ½è®¾è®¡.md)
- [ContextBuilder.kt](../../../app/src/main/java/com/empathy/ai/domain/util/ContextBuilder.kt)
- [ConversationRepository.kt](../../../app/src/main/java/com/empathy/ai/domain/repository/ConversationRepository.kt)
- [AnalyzeChatUseCase.kt](../../../app/src/main/java/com/empathy/ai/domain/usecase/AnalyzeChatUseCase.kt)
