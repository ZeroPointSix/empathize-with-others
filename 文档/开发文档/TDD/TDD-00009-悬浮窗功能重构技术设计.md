# TDD-00009: æ‚¬æµ®çª—åŠŸèƒ½é‡æ„æŠ€æœ¯è®¾è®¡

## 1. æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç±»å‹ | TDD (Technical Design Document) |
| æ–‡æ¡£ç¼–å· | TDD-00009 |
| åŠŸèƒ½åç§° | æ‚¬æµ®çª—åŠŸèƒ½é‡æ„æŠ€æœ¯è®¾è®¡ |
| ç‰ˆæœ¬ | 1.0 |
| åˆ›å»ºæ—¥æœŸ | 2025-12-17 |
| æœ€åæ›´æ–° | 2025-12-17 |
| ä½œè€… | Kiro |
| å®¡æ ¸äºº | å¾…å®¡æ ¸ |
| å®¡æ ¸çŠ¶æ€ | ğŸ“ å¾…å®¡æ ¸ |
| å…³è”æ–‡æ¡£ | PRD-00009, FD-00009 |

### 1.1 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-17 | Kiro | åˆå§‹ç‰ˆæœ¬ |

### 1.2 å‚è€ƒæ ‡å‡†

| æ ‡å‡†æ–‡æ¡£ | ç‰ˆæœ¬ | è¯´æ˜ |
|---------|------|------|
| Clean Architecture | - | æ¶æ„æ¨¡å¼æ ‡å‡† |
| MVVM Pattern | - | UIæ¶æ„æ¨¡å¼ |
| Kotlin Coding Conventions | 2.0.21 | ä»£ç è§„èŒƒ |
| Material Design 3 | 1.3.1 | UIè®¾è®¡è§„èŒƒ |

### 1.3 æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

| å€ºåŠ¡ID | æè¿° | å½±å“ | ä¼˜å…ˆçº§ | è®¡åˆ’è§£å†³æ—¶é—´ |
|--------|------|------|--------|-------------|
| TD-009-01 | ActionType.CHECKå°†é€æ­¥åºŸå¼ƒ | ä½ | ğŸŸ¢ ä½ | åç»­ç‰ˆæœ¬ |
| TD-009-02 | FloatingViewä½¿ç”¨XMLå¸ƒå±€éœ€é‡æ„ä¸ºCompose | ä¸­ | ğŸŸ¡ ä¸­ | åç»­ç‰ˆæœ¬ |

---

## 2. æ¶æ„æ¦‚è¿°

### 2.1 æ¶æ„ç›®æ ‡

æ‚¬æµ®çª—åŠŸèƒ½é‡æ„é‡‡ç”¨ Clean Architecture åˆ†å±‚æ¶æ„ï¼Œå®ç°ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½çš„ç»Ÿä¸€ç®¡ç†ã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
- å°†ä¸‰å¤§åŠŸèƒ½ï¼ˆåˆ†æã€æ¶¦è‰²ã€å›å¤ï¼‰ç»Ÿä¸€åˆ°Tabåˆ‡æ¢ç•Œé¢
- å®ç°çŠ¶æ€ä¿æŒï¼Œæœ€å°åŒ–æ—¶ä¿å­˜å®Œæ•´çŠ¶æ€
- å®ç°è”ç³»äººè®°å¿†ï¼Œé»˜è®¤é€‰ä¸­ä¸Šæ¬¡å¯¹è¯çš„è”ç³»äºº
- å®ç°å¾®è°ƒé‡æ–°ç”ŸæˆåŠŸèƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### 2.2 æŠ€æœ¯æ ˆ

| æŠ€æœ¯é¢†åŸŸ | æŠ€æœ¯é€‰æ‹© | ç‰ˆæœ¬ | ç”¨é€” |
|---------|----------|------|------|
| UIæ¡†æ¶ | Android View + XML | - | æ‚¬æµ®çª—ç•Œé¢ï¼ˆç³»ç»Ÿé™åˆ¶ï¼‰ |
| ç»„ä»¶åº“ | Material Components | 1.3.1 | Tabã€Dialogç­‰ç»„ä»¶ |
| å¼‚æ­¥å¤„ç† | Kotlin Coroutines | 1.9.0 | å¼‚æ­¥AIè°ƒç”¨ |
| ä¾èµ–æ³¨å…¥ | Hilt | 2.52 | ä¾èµ–ç®¡ç† |
| JSONè§£æ | Moshi | 1.15.1 | AIå“åº”è§£æ |
| çŠ¶æ€æŒä¹…åŒ– | SharedPreferences | - | æ‚¬æµ®çª—çŠ¶æ€ä¿å­˜ |

### 2.3 è®¾è®¡åŸåˆ™

- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªUseCaseåªè´Ÿè´£ä¸€ç§åŠŸèƒ½ï¼ˆåˆ†æ/æ¶¦è‰²/å›å¤ï¼‰
- **å¼€é—­åŸåˆ™**ï¼šé€šè¿‡æ‰©å±•ActionTypeæšä¸¾æ”¯æŒæ–°åŠŸèƒ½ï¼Œä¸ä¿®æ”¹ç°æœ‰ä»£ç 
- **ä¾èµ–å€’ç½®**ï¼šUseCaseä¾èµ–Repositoryæ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
- **çŠ¶æ€ä¸å¯å˜**ï¼šFloatingWindowStateä½¿ç”¨data classï¼Œé€šè¿‡copyæ›´æ–°çŠ¶æ€
- **å‘åå…¼å®¹**ï¼šä¿ç•™CHECKç±»å‹ï¼Œé€æ­¥åºŸå¼ƒ


---

## 3. æ•´ä½“æ¶æ„è®¾è®¡

### 3.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              FloatingWindowService                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚FloatingViewâ”‚ â”‚TabSwitcher â”‚ â”‚RefinementDialogâ”‚   â”‚  â”‚
â”‚  â”‚  â”‚  (ä¸»è§†å›¾)  â”‚ â”‚ (Tabåˆ‡æ¢)  â”‚ â”‚  (å¾®è°ƒå¯¹è¯æ¡†) â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚  â”‚
â”‚  â”‚  â”‚ ResultCard â”‚ â”‚ContactPickerâ”‚                      â”‚  â”‚
â”‚  â”‚  â”‚ (ç»“æœå±•ç¤º) â”‚ â”‚(è”ç³»äººé€‰æ‹©)â”‚                      â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚AnalyzeChat   â”‚ â”‚PolishDraft   â”‚ â”‚ GenerateReply    â”‚   â”‚
â”‚  â”‚  UseCase     â”‚ â”‚  UseCase     â”‚ â”‚   UseCase        â”‚   â”‚
â”‚  â”‚  (å·²æœ‰)      â”‚ â”‚  (æ–°å¢)      â”‚ â”‚   (æ–°å¢)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Refinement   â”‚ â”‚PromptBuilder â”‚ â”‚IdentityPrefix    â”‚   â”‚
â”‚  â”‚  UseCase     â”‚ â”‚  (æç¤ºè¯)    â”‚ â”‚   Helper         â”‚   â”‚
â”‚  â”‚  (æ–°å¢)      â”‚ â”‚  (å·²æœ‰)      â”‚ â”‚   (å·²æœ‰)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Data Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚AiRepository  â”‚ â”‚FloatingWindowâ”‚ â”‚ ContactDao       â”‚   â”‚
â”‚  â”‚  Impl        â”‚ â”‚ Preferences  â”‚ â”‚                  â”‚   â”‚
â”‚  â”‚  (æ‰©å±•)      â”‚ â”‚  (æ‰©å±•)      â”‚ â”‚  (å·²æœ‰)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·æ“ä½œæµç¨‹                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·è¾“å…¥æ–‡æœ¬
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Tabé€‰æ‹©      â”‚ â† åˆ†æ/æ¶¦è‰²/å›å¤
  â”‚ (ActionType) â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚IdentityPrefixâ”‚ â† æ·»åŠ èº«ä»½å‰ç¼€
  â”‚   Helper     â”‚   ã€å¯¹æ–¹è¯´ã€‘/ã€æˆ‘æ­£åœ¨å›å¤ã€‘
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ PromptBuilderâ”‚ â† æ„å»ºç³»ç»Ÿæç¤ºè¯
  â”‚              â”‚   åœºæ™¯ï¼šANALYZE/POLISH/REPLY
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ AiRepository â”‚ â† è°ƒç”¨AIæ¥å£
  â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ç»“æœè§£æ     â”‚ â† AnalysisResult/PolishResult/ReplyResult
  â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ResultCard   â”‚ â† å±•ç¤ºç»“æœ
  â”‚ æ˜¾ç¤º         â”‚   æ”¯æŒå¤åˆ¶/é‡æ–°ç”Ÿæˆ
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ¨¡å—åˆ’åˆ†

```
domain/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ ActionType.kt              # æ“ä½œç±»å‹æšä¸¾ï¼ˆæ‰©å±•ï¼‰
â”‚   â”œâ”€â”€ PolishResult.kt            # æ¶¦è‰²ç»“æœæ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ ReplyResult.kt             # å›å¤ç»“æœæ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ FloatingWindowState.kt     # æ‚¬æµ®çª—çŠ¶æ€æ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ AiResult.kt                # AIç»“æœå¯†å°ç±»ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ RefinementRequest.kt       # å¾®è°ƒè¯·æ±‚æ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ usecase/
â”‚   â”œâ”€â”€ AnalyzeChatUseCase.kt      # åˆ†æç”¨ä¾‹ï¼ˆå·²æœ‰ï¼‰
â”‚   â”œâ”€â”€ PolishDraftUseCase.kt      # æ¶¦è‰²ç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ GenerateReplyUseCase.kt    # å›å¤ç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ RefinementUseCase.kt       # å¾®è°ƒç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ util/
â”‚   â”œâ”€â”€ SystemPrompts.kt           # ç³»ç»Ÿæç¤ºè¯ï¼ˆæ‰©å±•ï¼‰
â”‚   â””â”€â”€ IdentityPrefixHelper.kt    # èº«ä»½å‰ç¼€å·¥å…·ï¼ˆå·²æœ‰ï¼‰

data/
â”œâ”€â”€ local/
â”‚   â””â”€â”€ FloatingWindowPreferences.kt  # æ‚¬æµ®çª—åå¥½ï¼ˆæ‰©å±•ï¼‰
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ AiRepositoryImpl.kt        # AIä»“åº“å®ç°ï¼ˆæ‰©å±•ï¼‰

presentation/
â”œâ”€â”€ ui/
â”‚   â””â”€â”€ floating/
â”‚       â”œâ”€â”€ FloatingView.kt        # ä¸»è§†å›¾ï¼ˆé‡æ„ï¼‰
â”‚       â”œâ”€â”€ TabSwitcher.kt         # Tabåˆ‡æ¢ç»„ä»¶ï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ ResultCard.kt          # ç»“æœå¡ç‰‡ï¼ˆæ–°å¢ï¼‰
â”‚       â””â”€â”€ RefinementDialog.kt    # å¾®è°ƒå¯¹è¯æ¡†ï¼ˆæ–°å¢ï¼‰

di/
â””â”€â”€ FloatingWindowModule.kt        # ä¾èµ–æ³¨å…¥æ¨¡å—ï¼ˆæ–°å¢ï¼‰
```


---

## 4. è¯¦ç»†æŠ€æœ¯è®¾è®¡

### 4.1 æ•°æ®æ¨¡å‹è®¾è®¡

#### 4.1.1 ActionTypeï¼ˆæ“ä½œç±»å‹æšä¸¾ - æ‰©å±•ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/ActionType.kt`

```kotlin
enum class ActionType(
    val displayName: String,
    val icon: String,
    val identityPrefix: String
) {
    /**
     * å¸®æˆ‘åˆ†æ - åˆ†æå¯¹æ–¹è¯´çš„è¯
     */
    ANALYZE(
        displayName = "å¸®æˆ‘åˆ†æ",
        icon = "ğŸ”",
        identityPrefix = "ã€å¯¹æ–¹è¯´ã€‘"
    ),
    
    /**
     * å¸®æˆ‘æ¶¦è‰² - ä¼˜åŒ–æˆ‘è¦è¯´çš„è¯
     */
    POLISH(
        displayName = "å¸®æˆ‘æ¶¦è‰²",
        icon = "âœï¸",
        identityPrefix = "ã€æˆ‘æ­£åœ¨å›å¤ã€‘"
    ),
    
    /**
     * å¸®æˆ‘å›å¤ - æ ¹æ®å¯¹æ–¹çš„è¯ç”Ÿæˆå›å¤
     */
    REPLY(
        displayName = "å¸®æˆ‘å›å¤",
        icon = "ğŸ’¬",
        identityPrefix = "ã€å¯¹æ–¹è¯´ã€‘"
    ),
    
    /**
     * @deprecated ä½¿ç”¨POLISHæ›¿ä»£ï¼Œé£é™©æ£€æŸ¥å·²åˆå¹¶åˆ°æ¶¦è‰²åŠŸèƒ½
     */
    @Deprecated("ä½¿ç”¨POLISHæ›¿ä»£")
    CHECK(
        displayName = "å¸®æˆ‘æ£€æŸ¥",
        icon = "âš ï¸",
        identityPrefix = "ã€æˆ‘æ­£åœ¨å›å¤ã€‘"
    );
    
    companion object {
        fun default(): ActionType = ANALYZE
        
        /**
         * è·å–æœ‰æ•ˆçš„æ“ä½œç±»å‹ï¼ˆæ’é™¤åºŸå¼ƒçš„CHECKï¼‰
         */
        fun validTypes(): List<ActionType> = listOf(ANALYZE, POLISH, REPLY)
    }
}
```


#### 4.1.2 PolishResultï¼ˆæ¶¦è‰²ç»“æœæ¨¡å‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/PolishResult.kt`

```kotlin
import com.squareup.moshi.JsonClass

@JsonClass(generateAdapter = true)
data class PolishResult(
    /**
     * ä¼˜åŒ–åçš„æ–‡æœ¬ï¼ˆå¯ç›´æ¥å¤åˆ¶ä½¿ç”¨ï¼‰
     */
    val polishedText: String,
    
    /**
     * æ˜¯å¦æ£€æµ‹åˆ°é£é™©
     */
    val hasRisk: Boolean = false,
    
    /**
     * é£é™©æç¤ºï¼ˆå¦‚æœæœ‰é£é™©ï¼‰
     */
    val riskWarning: String? = null
) {
    /**
     * è·å–ç”¨äºå¤åˆ¶çš„æ–‡æœ¬
     */
    fun getCopyableText(): String = polishedText
    
    /**
     * è·å–ç”¨äºæ˜¾ç¤ºçš„å®Œæ•´å†…å®¹
     */
    fun getDisplayContent(): String = buildString {
        append(polishedText)
        if (hasRisk && !riskWarning.isNullOrBlank()) {
            appendLine()
            appendLine()
            append("âš ï¸ é£é™©æç¤ºï¼š$riskWarning")
        }
    }
}
```

#### 4.1.3 ReplyResultï¼ˆå›å¤ç»“æœæ¨¡å‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/ReplyResult.kt`

```kotlin
import com.squareup.moshi.JsonClass

@JsonClass(generateAdapter = true)
data class ReplyResult(
    /**
     * å»ºè®®çš„å›å¤å†…å®¹ï¼ˆå¯ç›´æ¥å¤åˆ¶ä½¿ç”¨ï¼‰
     */
    val suggestedReply: String,
    
    /**
     * ç­–ç•¥è¯´æ˜ï¼ˆä¸ºä»€ä¹ˆè¿™æ ·å›å¤ï¼‰
     */
    val strategyNote: String? = null
) {
    /**
     * è·å–ç”¨äºå¤åˆ¶çš„æ–‡æœ¬
     */
    fun getCopyableText(): String = suggestedReply
    
    /**
     * è·å–ç”¨äºæ˜¾ç¤ºçš„å®Œæ•´å†…å®¹
     */
    fun getDisplayContent(): String = buildString {
        append(suggestedReply)
        if (!strategyNote.isNullOrBlank()) {
            appendLine()
            appendLine()
            append("ğŸ’¡ ç­–ç•¥è¯´æ˜ï¼š$strategyNote")
        }
    }
}
```


#### 4.1.4 AiResultï¼ˆAIç»“æœå¯†å°ç±» - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/AiResult.kt`

```kotlin
/**
 * AIç»“æœçš„å¯†å°ç±»ï¼Œç»Ÿä¸€ä¸‰ç§åŠŸèƒ½çš„è¿”å›ç±»å‹
 */
sealed class AiResult {
    /**
     * åˆ†æç»“æœ
     */
    data class Analysis(val result: AnalysisResult) : AiResult()
    
    /**
     * æ¶¦è‰²ç»“æœ
     */
    data class Polish(val result: PolishResult) : AiResult()
    
    /**
     * å›å¤ç»“æœ
     */
    data class Reply(val result: ReplyResult) : AiResult()
    
    /**
     * è·å–å¯å¤åˆ¶çš„æ–‡æœ¬
     */
    fun getCopyableText(): String = when (this) {
        is Analysis -> result.replySuggestion
        is Polish -> result.getCopyableText()
        is Reply -> result.getCopyableText()
    }
    
    /**
     * è·å–æ˜¾ç¤ºå†…å®¹
     */
    fun getDisplayContent(): String = when (this) {
        is Analysis -> buildString {
            appendLine("ã€å†›å¸ˆåˆ†æã€‘")
            appendLine(result.strategyAnalysis)
            appendLine()
            appendLine("ã€è¯æœ¯å»ºè®®ã€‘")
            append(result.replySuggestion)
        }
        is Polish -> result.getDisplayContent()
        is Reply -> result.getDisplayContent()
    }
}
```

#### 4.1.5 FloatingWindowStateï¼ˆæ‚¬æµ®çª—çŠ¶æ€æ¨¡å‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/FloatingWindowState.kt`

```kotlin
data class FloatingWindowState(
    /**
     * å½“å‰é€‰ä¸­çš„Tab
     */
    val selectedTab: ActionType = ActionType.ANALYZE,
    
    /**
     * é€‰ä¸­çš„è”ç³»äººID
     */
    val selectedContactId: String? = null,
    
    /**
     * è¾“å…¥æ¡†å†…å®¹
     */
    val inputText: String = "",
    
    /**
     * AIè¿”å›çš„ç»“æœ
     */
    val lastResult: AiResult? = null,
    
    /**
     * æ˜¯å¦æ­£åœ¨åŠ è½½
     */
    val isLoading: Boolean = false,
    
    /**
     * é”™è¯¯ä¿¡æ¯
     */
    val errorMessage: String? = null
) {
    /**
     * æ˜¯å¦æœ‰ç»“æœå¯æ˜¾ç¤º
     */
    fun hasResult(): Boolean = lastResult != null
    
    /**
     * æ˜¯å¦å¯ä»¥å‘é€è¯·æ±‚
     */
    fun canSubmit(): Boolean = 
        !isLoading && 
        inputText.isNotBlank() && 
        selectedContactId != null
    
    /**
     * æ¸…ç©ºç»“æœå’Œé”™è¯¯
     */
    fun clearResult(): FloatingWindowState = copy(
        lastResult = null,
        errorMessage = null
    )
}
```


#### 4.1.6 RefinementRequestï¼ˆå¾®è°ƒè¯·æ±‚æ¨¡å‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/RefinementRequest.kt`

```kotlin
data class RefinementRequest(
    /**
     * åŸå§‹ç”¨æˆ·è¾“å…¥
     */
    val originalInput: String,
    
    /**
     * åŸå§‹ä»»åŠ¡ç±»å‹
     */
    val originalTask: ActionType,
    
    /**
     * AIä¸Šæ¬¡çš„å›å¤
     */
    val lastAiResponse: String,
    
    /**
     * ç”¨æˆ·çš„å¾®è°ƒæŒ‡ä»¤ï¼ˆå¯é€‰ï¼‰
     * ä¸ºç©ºè¡¨ç¤ºç›´æ¥é‡æ–°ç”Ÿæˆ
     */
    val refinementInstruction: String? = null,
    
    /**
     * è”ç³»äººID
     */
    val contactId: String
) {
    /**
     * æ˜¯å¦æœ‰å¾®è°ƒæŒ‡ä»¤
     */
    fun hasInstruction(): Boolean = !refinementInstruction.isNullOrBlank()
}
```

### 4.2 UseCaseè®¾è®¡

#### 4.2.1 PolishDraftUseCaseï¼ˆæ¶¦è‰²ç”¨ä¾‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/PolishDraftUseCase.kt`

```kotlin
class PolishDraftUseCase @Inject constructor(
    private val contactRepository: ContactRepository,
    private val brainTagRepository: BrainTagRepository,
    private val privacyRepository: PrivacyRepository,
    private val aiRepository: AiRepository,
    private val aiProviderRepository: AiProviderRepository,
    private val promptBuilder: PromptBuilder,
    private val identityPrefixHelper: IdentityPrefixHelper
) {
    suspend operator fun invoke(
        contactId: String,
        draftText: String
    ): Result<PolishResult> {
        return try {
            // 1. å‰ç½®æ£€æŸ¥
            val defaultProvider = aiProviderRepository.getDefaultProvider().getOrNull()
                ?: return Result.failure(IllegalStateException("æœªé…ç½®é»˜è®¤ AI æœåŠ¡å•†"))
            
            // 2. åŠ è½½è”ç³»äººæ•°æ®
            val profile = contactRepository.getProfile(contactId).getOrNull()
                ?: return Result.failure(IllegalStateException("æœªæ‰¾åˆ°è”ç³»äºº"))
            
            val brainTags = brainTagRepository.getTagsForContact(contactId).first()
            val redTags = brainTags.filter { it.type == TagType.RISK_RED }
            
            // 3. æ•°æ®è„±æ•
            val privacyMapping = privacyRepository.getPrivacyMapping().getOrElse { emptyMap() }
            val maskedDraft = PrivacyEngine.mask(draftText, privacyMapping)
            
            // 4. æ·»åŠ èº«ä»½å‰ç¼€
            val prefixedDraft = identityPrefixHelper.addPrefix(
                content = maskedDraft,
                actionType = ActionType.POLISH
            )
            
            // 5. æ„å»ºæç¤ºè¯
            val promptContext = PromptContext.fromContact(profile)
            val systemInstruction = promptBuilder.buildSystemInstruction(
                scene = PromptScene.POLISH,
                contactId = contactId,
                context = promptContext,
                runtimeData = buildRuntimeData(prefixedDraft, redTags)
            )
            
            // 6. è°ƒç”¨AI
            aiRepository.polishDraft(
                provider = defaultProvider,
                draft = prefixedDraft,
                systemInstruction = systemInstruction
            )
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    private fun buildRuntimeData(draft: String, redTags: List<BrainTag>): String {
        return buildString {
            appendLine("ã€ç”¨æˆ·è‰ç¨¿ã€‘")
            appendLine(draft)
            if (redTags.isNotEmpty()) {
                appendLine()
                appendLine("ã€é›·åŒºè­¦å‘Šã€‘")
                redTags.forEach { appendLine("- ${it.content}") }
            }
        }
    }
}
```


#### 4.2.2 GenerateReplyUseCaseï¼ˆå›å¤ç”¨ä¾‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/GenerateReplyUseCase.kt`

```kotlin
class GenerateReplyUseCase @Inject constructor(
    private val contactRepository: ContactRepository,
    private val brainTagRepository: BrainTagRepository,
    private val privacyRepository: PrivacyRepository,
    private val aiRepository: AiRepository,
    private val aiProviderRepository: AiProviderRepository,
    private val promptBuilder: PromptBuilder,
    private val conversationRepository: ConversationRepository,
    private val identityPrefixHelper: IdentityPrefixHelper
) {
    suspend operator fun invoke(
        contactId: String,
        theirMessage: String
    ): Result<ReplyResult> {
        return try {
            // 1. å‰ç½®æ£€æŸ¥
            val defaultProvider = aiProviderRepository.getDefaultProvider().getOrNull()
                ?: return Result.failure(IllegalStateException("æœªé…ç½®é»˜è®¤ AI æœåŠ¡å•†"))
            
            // 2. åŠ è½½è”ç³»äººæ•°æ®
            val profile = contactRepository.getProfile(contactId).getOrNull()
                ?: return Result.failure(IllegalStateException("æœªæ‰¾åˆ°è”ç³»äºº"))
            
            val brainTags = brainTagRepository.getTagsForContact(contactId).first()
            val redTags = brainTags.filter { it.type == TagType.RISK_RED }
            val greenTags = brainTags.filter { it.type == TagType.STRATEGY_GREEN }
            
            // 3. æ•°æ®è„±æ•
            val privacyMapping = privacyRepository.getPrivacyMapping().getOrElse { emptyMap() }
            val maskedMessage = PrivacyEngine.mask(theirMessage, privacyMapping)
            
            // 4. æ·»åŠ èº«ä»½å‰ç¼€
            val prefixedMessage = identityPrefixHelper.addPrefix(
                content = maskedMessage,
                actionType = ActionType.REPLY
            )
            
            // 5. ä¿å­˜ç”¨æˆ·è¾“å…¥åˆ°å¯¹è¯è®°å½•
            conversationRepository.saveUserInput(contactId, prefixedMessage)
            
            // 6. æ„å»ºæç¤ºè¯
            val promptContext = PromptContext.fromContact(profile)
            val systemInstruction = promptBuilder.buildSystemInstruction(
                scene = PromptScene.REPLY,
                contactId = contactId,
                context = promptContext,
                runtimeData = buildRuntimeData(prefixedMessage, redTags, greenTags, profile)
            )
            
            // 7. è°ƒç”¨AI
            aiRepository.generateReply(
                provider = defaultProvider,
                message = prefixedMessage,
                systemInstruction = systemInstruction
            )
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    private fun buildRuntimeData(
        message: String,
        redTags: List<BrainTag>,
        greenTags: List<BrainTag>,
        profile: ContactProfile
    ): String {
        return buildString {
            appendLine("ã€æ”»ç•¥ç›®æ ‡ã€‘")
            appendLine(profile.targetGoal ?: "ç»´æŠ¤è‰¯å¥½å…³ç³»")
            appendLine()
            appendLine("ã€å¯¹æ–¹æ¶ˆæ¯ã€‘")
            appendLine(message)
            if (redTags.isNotEmpty()) {
                appendLine()
                appendLine("ã€é›·åŒºè­¦å‘Šã€‘")
                redTags.forEach { appendLine("- ${it.content}") }
            }
            if (greenTags.isNotEmpty()) {
                appendLine()
                appendLine("ã€ç­–ç•¥å»ºè®®ã€‘")
                greenTags.forEach { appendLine("- ${it.content}") }
            }
        }
    }
}
```


#### 4.2.3 RefinementUseCaseï¼ˆå¾®è°ƒç”¨ä¾‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/RefinementUseCase.kt`

```kotlin
class RefinementUseCase @Inject constructor(
    private val analyzeChatUseCase: AnalyzeChatUseCase,
    private val polishDraftUseCase: PolishDraftUseCase,
    private val generateReplyUseCase: GenerateReplyUseCase,
    private val aiRepository: AiRepository,
    private val aiProviderRepository: AiProviderRepository
) {
    suspend operator fun invoke(request: RefinementRequest): Result<AiResult> {
        return try {
            if (request.hasInstruction()) {
                // æœ‰å¾®è°ƒæŒ‡ä»¤ï¼Œä½¿ç”¨ç‰¹æ®Šçš„å¾®è°ƒæç¤ºè¯
                refineWithInstruction(request)
            } else {
                // æ— å¾®è°ƒæŒ‡ä»¤ï¼Œç›´æ¥é‡æ–°è°ƒç”¨åŸUseCase
                regenerateDirectly(request)
            }
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    private suspend fun refineWithInstruction(
        request: RefinementRequest
    ): Result<AiResult> {
        val defaultProvider = aiProviderRepository.getDefaultProvider().getOrNull()
            ?: return Result.failure(IllegalStateException("æœªé…ç½®é»˜è®¤ AI æœåŠ¡å•†"))
        
        val refinementPrompt = buildRefinementPrompt(request)
        
        return when (request.originalTask) {
            ActionType.ANALYZE -> {
                aiRepository.refineAnalysis(defaultProvider, refinementPrompt)
                    .map { AiResult.Analysis(it) }
            }
            ActionType.POLISH -> {
                aiRepository.refinePolish(defaultProvider, refinementPrompt)
                    .map { AiResult.Polish(it) }
            }
            ActionType.REPLY -> {
                aiRepository.refineReply(defaultProvider, refinementPrompt)
                    .map { AiResult.Reply(it) }
            }
            else -> Result.failure(IllegalArgumentException("ä¸æ”¯æŒçš„æ“ä½œç±»å‹"))
        }
    }
    
    private suspend fun regenerateDirectly(
        request: RefinementRequest
    ): Result<AiResult> {
        return when (request.originalTask) {
            ActionType.ANALYZE -> {
                analyzeChatUseCase(request.contactId, listOf(request.originalInput))
                    .map { AiResult.Analysis(it) }
            }
            ActionType.POLISH -> {
                polishDraftUseCase(request.contactId, request.originalInput)
                    .map { AiResult.Polish(it) }
            }
            ActionType.REPLY -> {
                generateReplyUseCase(request.contactId, request.originalInput)
                    .map { AiResult.Reply(it) }
            }
            else -> Result.failure(IllegalArgumentException("ä¸æ”¯æŒçš„æ“ä½œç±»å‹"))
        }
    }
    
    private fun buildRefinementPrompt(request: RefinementRequest): String {
        return buildString {
            appendLine("ç”¨æˆ·å¯¹ä¸Šä¸€æ¬¡çš„ç”Ÿæˆç»“æœä¸æ»¡æ„ã€‚")
            appendLine()
            appendLine("ã€åŸå§‹è¾“å…¥ã€‘")
            appendLine(request.originalInput)
            appendLine()
            appendLine("ã€ä¸Šæ¬¡çš„ç»“æœã€‘")
            appendLine(request.lastAiResponse)
            appendLine()
            appendLine("ã€ç”¨æˆ·çš„ä¿®æ”¹æ„è§ã€‘")
            appendLine(request.refinementInstruction)
            appendLine()
            appendLine("è¯·åŸºäºç”¨æˆ·çš„æ„è§é‡æ–°ç”Ÿæˆï¼Œä¸è¦è§£é‡Šï¼Œç›´æ¥è¾“å‡ºæ–°çš„ç»“æœã€‚")
        }
    }
}
```


### 4.3 æç¤ºè¯è®¾è®¡

#### 4.3.1 PromptSceneæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/PromptScene.kt`

```kotlin
enum class PromptScene(
    val displayName: String,
    val description: String,
    val availableVariables: List<String>
) {
    ANALYZE(
        displayName = "èŠå¤©åˆ†æ",
        description = "åˆ†æèŠå¤©ä¸Šä¸‹æ–‡ï¼Œæä¾›æ²Ÿé€šå»ºè®®",
        availableVariables = listOf(
            "contact_name", "relationship_status",
            "risk_tags", "strategy_tags", "facts_count"
        )
    ),
    CHECK(
        displayName = "å®‰å…¨æ£€æŸ¥",
        description = "æ£€æŸ¥è‰ç¨¿å†…å®¹æ˜¯å¦è§¦å‘é£é™©è§„åˆ™",
        availableVariables = listOf("contact_name", "risk_tags")
    ),
    EXTRACT(
        displayName = "ä¿¡æ¯æå–",
        description = "ä»æ–‡æœ¬ä¸­æå–å…³é”®ä¿¡æ¯",
        availableVariables = listOf("contact_name")
    ),
    SUMMARY(
        displayName = "æ¯æ—¥æ€»ç»“",
        description = "ç”Ÿæˆæ¯æ—¥å¯¹è¯æ€»ç»“",
        availableVariables = listOf(
            "contact_name", "relationship_status",
            "facts_count", "today_date"
        )
    ),
    // æ–°å¢åœºæ™¯
    POLISH(
        displayName = "æ¶¦è‰²ä¼˜åŒ–",
        description = "ä¼˜åŒ–ç”¨æˆ·è‰ç¨¿ï¼Œä½¿è¡¨è¾¾æ›´å¾—ä½“",
        availableVariables = listOf(
            "contact_name", "relationship_status", "risk_tags"
        )
    ),
    REPLY(
        displayName = "ç”Ÿæˆå›å¤",
        description = "æ ¹æ®å¯¹æ–¹æ¶ˆæ¯ç”Ÿæˆåˆé€‚çš„å›å¤",
        availableVariables = listOf(
            "contact_name", "relationship_status",
            "risk_tags", "strategy_tags"
        )
    )
}
```

#### 4.3.2 SystemPromptsæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`domain/util/SystemPrompts.kt`

```kotlin
object SystemPrompts {
    
    // ==================== æ¶¦è‰²åœºæ™¯æç¤ºè¯ ====================
    
    private const val POLISH_HEADER = """ä½ æ˜¯ç”¨æˆ·çš„"é«˜æƒ…å•†å˜´æ›¿"ã€‚

ã€ä½ çš„äººè®¾ã€‘
ä½ æ˜¯ä¸€ä¸ªæƒ…å•†å¾ˆé«˜çš„æœ‹å‹ï¼Œå¸®ç”¨æˆ·æŠŠè¯è¯´å¾—æ›´å¥½å¬ã€æ›´å¾—ä½“ã€‚
è¯´è¯ç›´æ¥ï¼Œæ”¹å®Œå°±ç»™ç»“æœï¼Œåˆ«å•°å—¦ã€‚

ã€èº«ä»½è¯†åˆ«ã€‘
- ã€æˆ‘æ­£åœ¨å›å¤ã€‘å¼€å¤´ = ç”¨æˆ·æ‰“ç®—å‘é€çš„è‰ç¨¿ï¼Œä½ è¦å¸®ç”¨æˆ·ä¼˜åŒ–è¡¨è¾¾

ã€ä½ çš„ä»»åŠ¡ã€‘
1. æ£€æŸ¥è‰ç¨¿æœ‰æ²¡æœ‰è¸©é›·çš„åœ°æ–¹
2. ä¼˜åŒ–è¡¨è¾¾ï¼Œè®©è¯è¯´å¾—æ›´å¾—ä½“
3. ä¿æŒç”¨æˆ·çš„åŸæ„ï¼Œä¸è¦æ”¹å˜æ ¸å¿ƒå†…å®¹"""

    private const val POLISH_FOOTER = """ã€è¾“å‡ºè¦æ±‚ã€‘
è¯·ä»¥JSONæ ¼å¼è¿”å›ç»“æœï¼š
{
  "polishedText": "ä¼˜åŒ–åçš„æ–‡æœ¬",
  "hasRisk": false,
  "riskWarning": null
}

ã€å­—æ®µè¯´æ˜ã€‘
- polishedText: ä¼˜åŒ–åå¯ç›´æ¥ä½¿ç”¨çš„æ–‡æœ¬
- hasRisk: æ˜¯å¦æ£€æµ‹åˆ°é£é™©ï¼ˆtrue/falseï¼‰
- riskWarning: é£é™©æç¤ºï¼ˆæ²¡æœ‰é£é™©åˆ™ä¸ºnullï¼‰

ã€ç¦æ­¢äº‹é¡¹ã€‘
- ç¦æ­¢è¿”å›Markdownæ ¼å¼
- ç¦æ­¢åœ¨JSONå‰åæ·»åŠ ä»»ä½•æ–‡å­—"""

    // ==================== å›å¤åœºæ™¯æç¤ºè¯ ====================
    
    private const val REPLY_HEADER = """ä½ æ˜¯ç”¨æˆ·çš„"ç¥å›å¤ç”Ÿæˆå™¨"ã€‚

ã€ä½ çš„äººè®¾ã€‘
ä½ æ˜¯ä¸€ä¸ªé˜…äººæ— æ•°çš„è€å¸æœºï¼Œèƒ½æ ¹æ®å¯¹æ–¹çš„è¯ï¼Œç»™å‡ºæœ€åˆé€‚çš„å›å¤ã€‚
è¯´è¯ç›´æ¥ï¼Œç»™å®Œå›å¤ç®€å•è¯´ä¸€å¥ä¸ºä»€ä¹ˆè¿™æ ·å›å°±è¡Œã€‚

ã€èº«ä»½è¯†åˆ«ã€‘
- ã€å¯¹æ–¹è¯´ã€‘å¼€å¤´ = å¯¹æ–¹å‘ç»™ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œä½ è¦å¸®ç”¨æˆ·ç”Ÿæˆå›å¤

ã€ä½ çš„ä»»åŠ¡ã€‘
1. ç†è§£å¯¹æ–¹è¯é‡Œçš„æƒ…ç»ªå’Œæ„å›¾
2. ç»“åˆè”ç³»äººç”»åƒï¼Œç”Ÿæˆåˆé€‚çš„å›å¤
3. å›å¤è¦è‡ªç„¶ï¼Œåƒç”¨æˆ·è‡ªå·±è¯´çš„è¯"""

    private const val REPLY_FOOTER = """ã€è¾“å‡ºè¦æ±‚ã€‘
è¯·ä»¥JSONæ ¼å¼è¿”å›ç»“æœï¼š
{
  "suggestedReply": "å»ºè®®çš„å›å¤å†…å®¹",
  "strategyNote": "ç®€çŸ­çš„ç­–ç•¥è¯´æ˜"
}

ã€å­—æ®µè¯´æ˜ã€‘
- suggestedReply: å¯ç›´æ¥å¤åˆ¶å‘é€çš„å›å¤
- strategyNote: ä¸€å¥è¯è¯´æ˜ä¸ºä»€ä¹ˆè¿™æ ·å›å¤

ã€ç¦æ­¢äº‹é¡¹ã€‘
- ç¦æ­¢è¿”å›Markdownæ ¼å¼
- ç¦æ­¢åœ¨JSONå‰åæ·»åŠ ä»»ä½•æ–‡å­—"""

    fun getHeader(scene: PromptScene): String = when (scene) {
        PromptScene.ANALYZE -> ANALYZE_HEADER
        PromptScene.CHECK -> CHECK_HEADER
        PromptScene.EXTRACT -> EXTRACT_HEADER
        PromptScene.SUMMARY -> SUMMARY_HEADER
        PromptScene.POLISH -> POLISH_HEADER
        PromptScene.REPLY -> REPLY_HEADER
    }
    
    fun getFooter(scene: PromptScene): String = when (scene) {
        PromptScene.ANALYZE -> ANALYZE_FOOTER
        PromptScene.CHECK -> CHECK_FOOTER
        PromptScene.EXTRACT -> EXTRACT_FOOTER
        PromptScene.SUMMARY -> SUMMARY_FOOTER
        PromptScene.POLISH -> POLISH_FOOTER
        PromptScene.REPLY -> REPLY_FOOTER
    }
}
```


### 4.4 Repositoryæ‰©å±•

#### 4.4.1 AiRepositoryæ¥å£æ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`domain/repository/AiRepository.kt`

```kotlin
interface AiRepository {
    // ==================== å·²æœ‰æ–¹æ³• ====================
    
    suspend fun analyzeChat(
        provider: AiProvider,
        promptContext: String,
        systemInstruction: String
    ): Result<AnalysisResult>
    
    suspend fun checkDraftSafety(
        provider: AiProvider,
        draft: String,
        riskRules: List<String>,
        systemInstruction: String
    ): Result<SafetyCheckResult>
    
    // ==================== æ–°å¢æ–¹æ³• ====================
    
    /**
     * æ¶¦è‰²è‰ç¨¿
     */
    suspend fun polishDraft(
        provider: AiProvider,
        draft: String,
        systemInstruction: String
    ): Result<PolishResult>
    
    /**
     * ç”Ÿæˆå›å¤
     */
    suspend fun generateReply(
        provider: AiProvider,
        message: String,
        systemInstruction: String
    ): Result<ReplyResult>
    
    /**
     * å¾®è°ƒåˆ†æç»“æœ
     */
    suspend fun refineAnalysis(
        provider: AiProvider,
        refinementPrompt: String
    ): Result<AnalysisResult>
    
    /**
     * å¾®è°ƒæ¶¦è‰²ç»“æœ
     */
    suspend fun refinePolish(
        provider: AiProvider,
        refinementPrompt: String
    ): Result<PolishResult>
    
    /**
     * å¾®è°ƒå›å¤ç»“æœ
     */
    suspend fun refineReply(
        provider: AiProvider,
        refinementPrompt: String
    ): Result<ReplyResult>
}
```

#### 4.4.2 AiRepositoryImplå®ç°æ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`data/repository/AiRepositoryImpl.kt`

```kotlin
class AiRepositoryImpl @Inject constructor(
    private val openAiApi: OpenAiApi,
    private val moshi: Moshi,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) : AiRepository {
    
    // ... å·²æœ‰å®ç° ...
    
    override suspend fun polishDraft(
        provider: AiProvider,
        draft: String,
        systemInstruction: String
    ): Result<PolishResult> = withContext(ioDispatcher) {
        try {
            val response = callAi(provider, systemInstruction, draft)
            val result = parsePolishResult(response)
            Result.success(result)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun generateReply(
        provider: AiProvider,
        message: String,
        systemInstruction: String
    ): Result<ReplyResult> = withContext(ioDispatcher) {
        try {
            val response = callAi(provider, systemInstruction, message)
            val result = parseReplyResult(response)
            Result.success(result)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun refineAnalysis(
        provider: AiProvider,
        refinementPrompt: String
    ): Result<AnalysisResult> = withContext(ioDispatcher) {
        try {
            val systemInstruction = SystemPrompts.getHeader(PromptScene.ANALYZE) +
                "\n\n" + SystemPrompts.getFooter(PromptScene.ANALYZE)
            val response = callAi(provider, systemInstruction, refinementPrompt)
            val result = parseAnalysisResult(response)
            Result.success(result)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun refinePolish(
        provider: AiProvider,
        refinementPrompt: String
    ): Result<PolishResult> = withContext(ioDispatcher) {
        try {
            val systemInstruction = SystemPrompts.getHeader(PromptScene.POLISH) +
                "\n\n" + SystemPrompts.getFooter(PromptScene.POLISH)
            val response = callAi(provider, systemInstruction, refinementPrompt)
            val result = parsePolishResult(response)
            Result.success(result)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun refineReply(
        provider: AiProvider,
        refinementPrompt: String
    ): Result<ReplyResult> = withContext(ioDispatcher) {
        try {
            val systemInstruction = SystemPrompts.getHeader(PromptScene.REPLY) +
                "\n\n" + SystemPrompts.getFooter(PromptScene.REPLY)
            val response = callAi(provider, systemInstruction, refinementPrompt)
            val result = parseReplyResult(response)
            Result.success(result)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    private fun parsePolishResult(response: String): PolishResult {
        val cleanedJson = AiResponseCleaner.clean(response)
        val adapter = moshi.adapter(PolishResult::class.java)
        return adapter.fromJson(cleanedJson)
            ?: throw IllegalStateException("è§£ææ¶¦è‰²ç»“æœå¤±è´¥")
    }
    
    private fun parseReplyResult(response: String): ReplyResult {
        val cleanedJson = AiResponseCleaner.clean(response)
        val adapter = moshi.adapter(ReplyResult::class.java)
        return adapter.fromJson(cleanedJson)
            ?: throw IllegalStateException("è§£æå›å¤ç»“æœå¤±è´¥")
    }
}
```


### 4.5 çŠ¶æ€ç®¡ç†è®¾è®¡

#### 4.5.1 FloatingWindowPreferencesæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/FloatingWindowPreferences.kt`

```kotlin
@Singleton
class FloatingWindowPreferences @Inject constructor(
    @ApplicationContext private val context: Context
) {
    private val prefs = context.getSharedPreferences(
        "floating_window_prefs", Context.MODE_PRIVATE
    )
    
    companion object {
        // å·²æœ‰çš„é”®
        private const val KEY_ENABLED = "enabled"
        private const val KEY_BUTTON_X = "button_x"
        private const val KEY_BUTTON_Y = "button_y"
        
        // æ–°å¢çš„é”® - çŠ¶æ€ä¿æŒ
        private const val KEY_SELECTED_TAB = "selected_tab"
        private const val KEY_LAST_CONTACT_ID = "last_contact_id"
        private const val KEY_SAVED_INPUT_TEXT = "saved_input_text"
        private const val KEY_HAS_SAVED_STATE = "has_saved_state"
    }
    
    // ==================== å·²æœ‰æ–¹æ³• ====================
    
    fun isEnabled(): Boolean = prefs.getBoolean(KEY_ENABLED, false)
    fun setEnabled(enabled: Boolean) {
        prefs.edit().putBoolean(KEY_ENABLED, enabled).apply()
    }
    
    fun getButtonX(): Int = prefs.getInt(KEY_BUTTON_X, 0)
    fun getButtonY(): Int = prefs.getInt(KEY_BUTTON_Y, 100)
    fun saveButtonPosition(x: Int, y: Int) {
        prefs.edit()
            .putInt(KEY_BUTTON_X, x)
            .putInt(KEY_BUTTON_Y, y)
            .apply()
    }
    
    // ==================== æ–°å¢æ–¹æ³• - Tabè®°å¿† ====================
    
    fun getSelectedTab(): ActionType {
        val ordinal = prefs.getInt(KEY_SELECTED_TAB, ActionType.ANALYZE.ordinal)
        return ActionType.values().getOrElse(ordinal) { ActionType.ANALYZE }
    }
    
    fun saveSelectedTab(tab: ActionType) {
        prefs.edit().putInt(KEY_SELECTED_TAB, tab.ordinal).apply()
    }
    
    // ==================== æ–°å¢æ–¹æ³• - è”ç³»äººè®°å¿† ====================
    
    fun getLastContactId(): String? {
        return prefs.getString(KEY_LAST_CONTACT_ID, null)
    }
    
    fun saveLastContactId(contactId: String) {
        prefs.edit().putString(KEY_LAST_CONTACT_ID, contactId).apply()
    }
    
    // ==================== æ–°å¢æ–¹æ³• - çŠ¶æ€ä¿æŒ ====================
    
    fun saveState(state: FloatingWindowState) {
        prefs.edit()
            .putInt(KEY_SELECTED_TAB, state.selectedTab.ordinal)
            .putString(KEY_LAST_CONTACT_ID, state.selectedContactId)
            .putString(KEY_SAVED_INPUT_TEXT, state.inputText)
            .putBoolean(KEY_HAS_SAVED_STATE, true)
            .apply()
    }
    
    fun restoreState(): FloatingWindowState? {
        if (!prefs.getBoolean(KEY_HAS_SAVED_STATE, false)) {
            return null
        }
        
        val tabOrdinal = prefs.getInt(KEY_SELECTED_TAB, ActionType.ANALYZE.ordinal)
        val tab = ActionType.values().getOrElse(tabOrdinal) { ActionType.ANALYZE }
        
        return FloatingWindowState(
            selectedTab = tab,
            selectedContactId = prefs.getString(KEY_LAST_CONTACT_ID, null),
            inputText = prefs.getString(KEY_SAVED_INPUT_TEXT, "") ?: ""
        )
    }
    
    fun clearSavedState() {
        prefs.edit()
            .remove(KEY_SAVED_INPUT_TEXT)
            .putBoolean(KEY_HAS_SAVED_STATE, false)
            .apply()
    }
    
    fun hasSavedState(): Boolean {
        return prefs.getBoolean(KEY_HAS_SAVED_STATE, false)
    }
}
```


---

## 5. æ–‡ä»¶å˜æ›´æ¸…å•

### 5.1 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ç±»å‹ | è¯´æ˜ |
|---------|------|------|
| `domain/model/PolishResult.kt` | Model | æ¶¦è‰²ç»“æœæ•°æ®æ¨¡å‹ |
| `domain/model/ReplyResult.kt` | Model | å›å¤ç»“æœæ•°æ®æ¨¡å‹ |
| `domain/model/AiResult.kt` | Model | AIç»“æœå¯†å°ç±» |
| `domain/model/FloatingWindowState.kt` | Model | æ‚¬æµ®çª—çŠ¶æ€æ¨¡å‹ |
| `domain/model/RefinementRequest.kt` | Model | å¾®è°ƒè¯·æ±‚æ¨¡å‹ |
| `domain/usecase/PolishDraftUseCase.kt` | UseCase | æ¶¦è‰²ç”¨ä¾‹ |
| `domain/usecase/GenerateReplyUseCase.kt` | UseCase | å›å¤ç”¨ä¾‹ |
| `domain/usecase/RefinementUseCase.kt` | UseCase | å¾®è°ƒç”¨ä¾‹ |
| `presentation/ui/floating/TabSwitcher.kt` | UI | Tabåˆ‡æ¢ç»„ä»¶ |
| `presentation/ui/floating/ResultCard.kt` | UI | ç»“æœå¡ç‰‡ç»„ä»¶ |
| `presentation/ui/floating/RefinementDialog.kt` | UI | å¾®è°ƒå¯¹è¯æ¡† |
| `di/FloatingWindowModule.kt` | DI | ä¾èµ–æ³¨å…¥æ¨¡å— |
| `res/layout/floating_tab_switcher.xml` | Layout | Tabå¸ƒå±€ |
| `res/layout/floating_result_card.xml` | Layout | ç»“æœå¡ç‰‡å¸ƒå±€ |
| `res/layout/dialog_refinement.xml` | Layout | å¾®è°ƒå¯¹è¯æ¡†å¸ƒå±€ |

### 5.2 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|---------|----------|
| `domain/model/ActionType.kt` | æ·»åŠ POLISHã€REPLYç±»å‹ï¼ŒåºŸå¼ƒCHECK |
| `domain/model/PromptScene.kt` | æ·»åŠ POLISHã€REPLYåœºæ™¯ |
| `domain/util/SystemPrompts.kt` | æ·»åŠ æ¶¦è‰²å’Œå›å¤åœºæ™¯çš„æç¤ºè¯ |
| `domain/repository/AiRepository.kt` | æ·»åŠ polishDraftã€generateReplyã€refine*æ–¹æ³• |
| `data/repository/AiRepositoryImpl.kt` | å®ç°æ–°å¢çš„æ¥å£æ–¹æ³• |
| `data/local/FloatingWindowPreferences.kt` | æ·»åŠ çŠ¶æ€ä¿æŒç›¸å…³æ–¹æ³• |
| `domain/util/FloatingView.kt` | é‡æ„UIï¼Œæ·»åŠ Tabåˆ‡æ¢ |
| `domain/service/FloatingWindowService.kt` | é›†æˆæ–°UseCaseï¼Œå¤„ç†çŠ¶æ€ç®¡ç† |

### 5.3 æµ‹è¯•æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `test/domain/usecase/PolishDraftUseCaseTest.kt` | æ¶¦è‰²ç”¨ä¾‹å•å…ƒæµ‹è¯• |
| `test/domain/usecase/GenerateReplyUseCaseTest.kt` | å›å¤ç”¨ä¾‹å•å…ƒæµ‹è¯• |
| `test/domain/usecase/RefinementUseCaseTest.kt` | å¾®è°ƒç”¨ä¾‹å•å…ƒæµ‹è¯• |
| `test/data/local/FloatingWindowPreferencesTest.kt` | çŠ¶æ€ç®¡ç†å•å…ƒæµ‹è¯• |
| `test/domain/model/AiResultTest.kt` | AIç»“æœæ¨¡å‹æµ‹è¯• |
| `androidTest/presentation/ui/floating/TabSwitcherTest.kt` | Tabåˆ‡æ¢UIæµ‹è¯• |

### 5.4 RefinementDialogå®ç°æ–¹æ¡ˆï¼ˆé‡è¦ï¼‰

**é—®é¢˜èƒŒæ™¯**ï¼š
æ‚¬æµ®çª—è¿è¡Œåœ¨Serviceç¯å¢ƒä¸­ï¼Œä½¿ç”¨ç³»ç»Ÿçš„`AlertDialog`ä¼šå› ä¸ºç¼ºå°‘Activity Contextè€ŒæŠ›å‡º`BadTokenException`ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šé‡‡ç”¨è‡ªå®šä¹‰è¦†ç›–å±‚Viewæ¨¡æ‹ŸDialogï¼ˆæ–¹æ¡ˆAï¼‰

**è®¾è®¡å†³ç­–**ï¼š
- ä¸ä½¿ç”¨ç³»ç»ŸDialogç±»ï¼Œè€Œæ˜¯é€šè¿‡WindowManageræ·»åŠ ä¸€ä¸ªè¦†ç›–å…¨å±çš„åŠé€æ˜FrameLayout
- ä½¿ç”¨`TYPE_APPLICATION_OVERLAY`ç±»å‹çš„WindowManager.LayoutParams
- è¿™ç§æ–¹å¼åœ¨æ‰€æœ‰Androidç‰ˆæœ¬ä¸Šè¡Œä¸ºä¸€è‡´ï¼Œæœ€ç¨³å®š

```kotlin
/**
 * å¾®è°ƒå¯¹è¯æ¡† - ä½¿ç”¨WindowManagerè¦†ç›–å±‚å®ç°
 * 
 * æ³¨æ„ï¼šä¸èƒ½ä½¿ç”¨AlertDialogï¼Œå› ä¸ºæ‚¬æµ®çª—è¿è¡Œåœ¨Serviceç¯å¢ƒä¸­ï¼Œ
 * ä¼šå¯¼è‡´BadTokenException
 */
class RefinementOverlay(
    private val context: Context,
    private val windowManager: WindowManager
) {
    private var overlayView: View? = null
    private var isShowing = false
    
    var onDirectRegenerate: (() -> Unit)? = null
    var onRegenerateWithInstruction: ((String) -> Unit)? = null
    var onDismiss: (() -> Unit)? = null
    
    private val layoutParams = WindowManager.LayoutParams().apply {
        type = WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY
        format = PixelFormat.TRANSLUCENT
        flags = WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL or
                WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH
        width = WindowManager.LayoutParams.MATCH_PARENT
        height = WindowManager.LayoutParams.MATCH_PARENT
        gravity = Gravity.CENTER
    }
    
    fun show() {
        if (isShowing) return
        
        overlayView = LayoutInflater.from(context)
            .inflate(R.layout.overlay_refinement, null).apply {
                // è®¾ç½®åŠé€æ˜èƒŒæ™¯ï¼Œç‚¹å‡»èƒŒæ™¯å…³é—­
                findViewById<View>(R.id.overlay_background).setOnClickListener {
                    dismiss()
                }
                
                // å¯¹è¯æ¡†å†…å®¹åŒºåŸŸï¼Œé˜»æ­¢ç‚¹å‡»ç©¿é€
                findViewById<View>(R.id.dialog_content).setOnClickListener { 
                    // æ¶ˆè´¹ç‚¹å‡»äº‹ä»¶ï¼Œé˜²æ­¢ç©¿é€åˆ°èƒŒæ™¯
                }
                
                // è¾“å…¥æ¡†
                val instructionInput = findViewById<EditText>(R.id.instruction_input)
                instructionInput.hint = "ä¾‹å¦‚ï¼šå¼ºç¡¬ä¸€ç‚¹ã€å¹½é»˜ä¸€ç‚¹ã€ç®€çŸ­ç‚¹..."
                
                // ç›´æ¥é‡æ–°ç”ŸæˆæŒ‰é’®
                findViewById<MaterialButton>(R.id.btn_direct).setOnClickListener {
                    onDirectRegenerate?.invoke()
                    dismiss()
                }
                
                // æŒ‰æ–¹å‘ç”ŸæˆæŒ‰é’®
                findViewById<MaterialButton>(R.id.btn_with_instruction).setOnClickListener {
                    val instruction = instructionInput.text.toString()
                    if (instruction.isNotBlank()) {
                        onRegenerateWithInstruction?.invoke(instruction)
                        dismiss()
                    } else {
                        instructionInput.error = "è¯·è¾“å…¥è°ƒæ•´æ–¹å‘"
                    }
                }
                
                // å…³é—­æŒ‰é’®
                findViewById<ImageButton>(R.id.btn_close).setOnClickListener {
                    dismiss()
                }
            }
        
        try {
            windowManager.addView(overlayView, layoutParams)
            isShowing = true
        } catch (e: Exception) {
            Log.e("RefinementOverlay", "æ˜¾ç¤ºè¦†ç›–å±‚å¤±è´¥", e)
        }
    }
    
    fun dismiss() {
        if (!isShowing) return
        
        try {
            overlayView?.let { windowManager.removeView(it) }
            overlayView = null
            isShowing = false
            onDismiss?.invoke()
        } catch (e: Exception) {
            Log.e("RefinementOverlay", "ç§»é™¤è¦†ç›–å±‚å¤±è´¥", e)
        }
    }
    
    fun isShowing(): Boolean = isShowing
    
    companion object {
        fun show(
            context: Context,
            windowManager: WindowManager,
            onDirect: () -> Unit,
            onWithInstruction: (String) -> Unit
        ): RefinementOverlay {
            return RefinementOverlay(context, windowManager).apply {
                onDirectRegenerate = onDirect
                onRegenerateWithInstruction = onWithInstruction
                show()
            }
        }
    }
}
```

**å¯¹åº”çš„å¸ƒå±€æ–‡ä»¶** `res/layout/overlay_refinement.xml`ï¼š

```xml
<?xml version="1.0" encoding="utf-8"?>
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <!-- åŠé€æ˜èƒŒæ™¯é®ç½© -->
    <View
        android:id="@+id/overlay_background"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:background="#80000000" />

    <!-- å¯¹è¯æ¡†å†…å®¹å¡ç‰‡ -->
    <com.google.android.material.card.MaterialCardView
        android:id="@+id/dialog_content"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_gravity="center"
        android:layout_marginHorizontal="24dp"
        app:cardCornerRadius="16dp"
        app:cardElevation="8dp">

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            android:padding="20dp">

            <!-- æ ‡é¢˜æ  -->
            <RelativeLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content">

                <TextView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:layout_centerVertical="true"
                    android:text="éœ€è¦è°ƒæ•´æ–¹å‘å—ï¼Ÿ"
                    android:textSize="18sp"
                    android:textStyle="bold" />

                <ImageButton
                    android:id="@+id/btn_close"
                    android:layout_width="32dp"
                    android:layout_height="32dp"
                    android:layout_alignParentEnd="true"
                    android:background="?attr/selectableItemBackgroundBorderless"
                    android:src="@drawable/ic_close"
                    android:contentDescription="å…³é—­" />
            </RelativeLayout>

            <!-- è¾“å…¥æ¡† -->
            <com.google.android.material.textfield.TextInputLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_marginTop="16dp"
                style="@style/Widget.MaterialComponents.TextInputLayout.OutlinedBox">

                <com.google.android.material.textfield.TextInputEditText
                    android:id="@+id/instruction_input"
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:hint="ä¾‹å¦‚ï¼šå¼ºç¡¬ä¸€ç‚¹ã€å¹½é»˜ä¸€ç‚¹ã€ç®€çŸ­ç‚¹..."
                    android:inputType="text"
                    android:maxLines="2" />
            </com.google.android.material.textfield.TextInputLayout>

            <!-- æŒ‰é’®ç»„ -->
            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_marginTop="20dp"
                android:orientation="horizontal">

                <com.google.android.material.button.MaterialButton
                    android:id="@+id/btn_direct"
                    android:layout_width="0dp"
                    android:layout_height="wrap_content"
                    android:layout_weight="1"
                    android:layout_marginEnd="8dp"
                    android:text="ç›´æ¥é‡æ–°ç”Ÿæˆ"
                    style="@style/Widget.MaterialComponents.Button.OutlinedButton" />

                <com.google.android.material.button.MaterialButton
                    android:id="@+id/btn_with_instruction"
                    android:layout_width="0dp"
                    android:layout_height="wrap_content"
                    android:layout_weight="1"
                    android:layout_marginStart="8dp"
                    android:text="æŒ‰æ–¹å‘ç”Ÿæˆ" />
            </LinearLayout>
        </LinearLayout>
    </com.google.android.material.card.MaterialCardView>
</FrameLayout>
```

**åœ¨FloatingWindowServiceä¸­çš„ä½¿ç”¨**ï¼š

```kotlin
class FloatingWindowService : Service() {
    
    private var refinementOverlay: RefinementOverlay? = null
    
    private fun showRefinementDialog() {
        refinementOverlay = RefinementOverlay.show(
            context = this,
            windowManager = windowManager,
            onDirect = {
                handleRegenerate(instruction = null)
            },
            onWithInstruction = { instruction ->
                handleRegenerate(instruction = instruction)
            }
        )
    }
    
    override fun onDestroy() {
        super.onDestroy()
        // ç¡®ä¿æ¸…ç†è¦†ç›–å±‚
        refinementOverlay?.dismiss()
        refinementOverlay = null
    }
}
```

---

## 6. æµ‹è¯•ç­–ç•¥

### 6.1 å•å…ƒæµ‹è¯•

#### 6.1.1 PolishDraftUseCaseTest

```kotlin
@OptIn(ExperimentalCoroutinesApi::class)
class PolishDraftUseCaseTest {
    
    @MockK private lateinit var contactRepository: ContactRepository
    @MockK private lateinit var brainTagRepository: BrainTagRepository
    @MockK private lateinit var privacyRepository: PrivacyRepository
    @MockK private lateinit var aiRepository: AiRepository
    @MockK private lateinit var aiProviderRepository: AiProviderRepository
    @MockK private lateinit var promptBuilder: PromptBuilder
    @MockK private lateinit var identityPrefixHelper: IdentityPrefixHelper
    
    private lateinit var useCase: PolishDraftUseCase
    
    @Before
    fun setup() {
        MockKAnnotations.init(this)
        useCase = PolishDraftUseCase(
            contactRepository, brainTagRepository, privacyRepository,
            aiRepository, aiProviderRepository, promptBuilder, identityPrefixHelper
        )
    }
    
    @Test
    fun `æ¶¦è‰²æˆåŠŸæ—¶è¿”å›PolishResult`() = runTest {
        // Given
        val contactId = "contact_1"
        val draftText = "ä¸å»ï¼Œè¦å‡è‚¥"
        
        coEvery { aiProviderRepository.getDefaultProvider() } returns 
            Result.success(mockProvider)
        coEvery { contactRepository.getProfile(contactId) } returns 
            Result.success(mockProfile)
        coEvery { brainTagRepository.getTagsForContact(contactId) } returns 
            flowOf(emptyList())
        coEvery { privacyRepository.getPrivacyMapping() } returns 
            Result.success(emptyMap())
        coEvery { identityPrefixHelper.addPrefix(any(), ActionType.POLISH) } returns 
            "ã€æˆ‘æ­£åœ¨å›å¤ã€‘ä¸å»ï¼Œè¦å‡è‚¥"
        coEvery { promptBuilder.buildSystemInstruction(any(), any(), any(), any()) } returns 
            "system instruction"
        coEvery { aiRepository.polishDraft(any(), any(), any()) } returns 
            Result.success(PolishResult(
                polishedText = "äº²çˆ±çš„ï¼Œä»Šæ™šæƒ³åœ¨å®¶ä¼‘æ¯ä¸€ä¸‹ï½",
                hasRisk = false
            ))
        
        // When
        val result = useCase(contactId, draftText)
        
        // Then
        assertTrue(result.isSuccess)
        assertEquals("äº²çˆ±çš„ï¼Œä»Šæ™šæƒ³åœ¨å®¶ä¼‘æ¯ä¸€ä¸‹ï½", result.getOrNull()?.polishedText)
    }
    
    @Test
    fun `æ£€æµ‹åˆ°é£é™©æ—¶è¿”å›é£é™©æç¤º`() = runTest {
        // Given
        setupMocks()
        coEvery { aiRepository.polishDraft(any(), any(), any()) } returns 
            Result.success(PolishResult(
                polishedText = "ä»Šæ™šä¸æƒ³å»",
                hasRisk = true,
                riskWarning = "è¯­æ°”å¯èƒ½è¿‡äºç›´æ¥"
            ))
        
        // When
        val result = useCase("contact_1", "ä¸å»")
        
        // Then
        assertTrue(result.getOrNull()?.hasRisk == true)
        assertEquals("è¯­æ°”å¯èƒ½è¿‡äºç›´æ¥", result.getOrNull()?.riskWarning)
    }
    
    @Test
    fun `æœªé…ç½®AIæœåŠ¡å•†æ—¶è¿”å›é”™è¯¯`() = runTest {
        // Given
        coEvery { aiProviderRepository.getDefaultProvider() } returns 
            Result.failure(Exception("æœªé…ç½®"))
        
        // When
        val result = useCase("contact_1", "æµ‹è¯•")
        
        // Then
        assertTrue(result.isFailure)
    }
}
```

#### 6.1.2 RefinementUseCaseTest

```kotlin
@OptIn(ExperimentalCoroutinesApi::class)
class RefinementUseCaseTest {
    
    @MockK private lateinit var analyzeChatUseCase: AnalyzeChatUseCase
    @MockK private lateinit var polishDraftUseCase: PolishDraftUseCase
    @MockK private lateinit var generateReplyUseCase: GenerateReplyUseCase
    @MockK private lateinit var aiRepository: AiRepository
    @MockK private lateinit var aiProviderRepository: AiProviderRepository
    
    private lateinit var useCase: RefinementUseCase
    
    @Before
    fun setup() {
        MockKAnnotations.init(this)
        useCase = RefinementUseCase(
            analyzeChatUseCase, polishDraftUseCase, generateReplyUseCase,
            aiRepository, aiProviderRepository
        )
    }
    
    @Test
    fun `æ— å¾®è°ƒæŒ‡ä»¤æ—¶ç›´æ¥é‡æ–°ç”Ÿæˆ`() = runTest {
        // Given
        val request = RefinementRequest(
            originalInput = "å¥¹è¯´ä»Šæ™šä¸æƒ³å‡ºé—¨",
            originalTask = ActionType.ANALYZE,
            lastAiResponse = "å¥¹å¯èƒ½åœ¨è¯•æ¢ä½ ",
            refinementInstruction = null,
            contactId = "contact_1"
        )
        
        coEvery { analyzeChatUseCase(any(), any()) } returns 
            Result.success(mockAnalysisResult)
        
        // When
        val result = useCase(request)
        
        // Then
        coVerify { analyzeChatUseCase(any(), any()) }
        coVerify(exactly = 0) { aiRepository.refineAnalysis(any(), any()) }
        assertTrue(result.isSuccess)
    }
    
    @Test
    fun `æœ‰å¾®è°ƒæŒ‡ä»¤æ—¶ä½¿ç”¨å¾®è°ƒæç¤ºè¯`() = runTest {
        // Given
        val request = RefinementRequest(
            originalInput = "å¥¹è¯´ä»Šæ™šä¸æƒ³å‡ºé—¨",
            originalTask = ActionType.ANALYZE,
            lastAiResponse = "å¥¹å¯èƒ½åœ¨è¯•æ¢ä½ ",
            refinementInstruction = "åˆ†æå¾—æ›´è¯¦ç»†ä¸€ç‚¹",
            contactId = "contact_1"
        )
        
        coEvery { aiProviderRepository.getDefaultProvider() } returns 
            Result.success(mockProvider)
        coEvery { aiRepository.refineAnalysis(any(), any()) } returns 
            Result.success(mockAnalysisResult)
        
        // When
        val result = useCase(request)
        
        // Then
        coVerify { aiRepository.refineAnalysis(any(), any()) }
        coVerify(exactly = 0) { analyzeChatUseCase(any(), any()) }
        assertTrue(result.isSuccess)
    }
    
    @Test
    fun `æ¶¦è‰²ä»»åŠ¡çš„å¾®è°ƒæ­£ç¡®è°ƒç”¨refinePolish`() = runTest {
        // Given
        val request = RefinementRequest(
            originalInput = "ä¸å»",
            originalTask = ActionType.POLISH,
            lastAiResponse = "ä»Šæ™šä¸æƒ³å»",
            refinementInstruction = "å¼ºç¡¬ä¸€ç‚¹",
            contactId = "contact_1"
        )
        
        coEvery { aiProviderRepository.getDefaultProvider() } returns 
            Result.success(mockProvider)
        coEvery { aiRepository.refinePolish(any(), any()) } returns 
            Result.success(PolishResult("ä¸å»å°±æ˜¯ä¸å»", false))
        
        // When
        val result = useCase(request)
        
        // Then
        coVerify { aiRepository.refinePolish(any(), any()) }
        assertTrue(result.getOrNull() is AiResult.Polish)
    }
}
```


### 6.2 çŠ¶æ€ç®¡ç†æµ‹è¯•

```kotlin
class FloatingWindowPreferencesTest {
    
    private lateinit var context: Context
    private lateinit var preferences: FloatingWindowPreferences
    
    @Before
    fun setup() {
        context = ApplicationProvider.getApplicationContext()
        preferences = FloatingWindowPreferences(context)
    }
    
    @After
    fun tearDown() {
        // æ¸…ç†æµ‹è¯•æ•°æ®
        preferences.clearSavedState()
    }
    
    @Test
    fun `ä¿å­˜çŠ¶æ€åå¯ä»¥æ­£ç¡®æ¢å¤`() {
        // Given
        val state = FloatingWindowState(
            selectedTab = ActionType.POLISH,
            selectedContactId = "contact_1",
            inputText = "æµ‹è¯•å†…å®¹"
        )
        
        // When
        preferences.saveState(state)
        val restored = preferences.restoreState()
        
        // Then
        assertNotNull(restored)
        assertEquals(ActionType.POLISH, restored?.selectedTab)
        assertEquals("contact_1", restored?.selectedContactId)
        assertEquals("æµ‹è¯•å†…å®¹", restored?.inputText)
    }
    
    @Test
    fun `æ¸…é™¤çŠ¶æ€åæ¢å¤è¿”å›null`() {
        // Given
        preferences.saveState(FloatingWindowState(inputText = "test"))
        
        // When
        preferences.clearSavedState()
        val restored = preferences.restoreState()
        
        // Then
        assertNull(restored)
    }
    
    @Test
    fun `Tabé€‰æ‹©æ­£ç¡®ä¿å­˜å’Œæ¢å¤`() {
        // Given & When
        preferences.saveSelectedTab(ActionType.REPLY)
        
        // Then
        assertEquals(ActionType.REPLY, preferences.getSelectedTab())
    }
    
    @Test
    fun `è”ç³»äººIDæ­£ç¡®ä¿å­˜å’Œæ¢å¤`() {
        // Given & When
        preferences.saveLastContactId("contact_123")
        
        // Then
        assertEquals("contact_123", preferences.getLastContactId())
    }
    
    @Test
    fun `hasSavedStateæ­£ç¡®åæ˜ çŠ¶æ€`() {
        // Given
        assertFalse(preferences.hasSavedState())
        
        // When
        preferences.saveState(FloatingWindowState())
        
        // Then
        assertTrue(preferences.hasSavedState())
        
        // When
        preferences.clearSavedState()
        
        // Then
        assertFalse(preferences.hasSavedState())
    }
}
```

### 6.3 é›†æˆæµ‹è¯•

```kotlin
@HiltAndroidTest
class FloatingWindowIntegrationTest {
    
    @get:Rule
    val hiltRule = HiltAndroidRule(this)
    
    @Inject lateinit var polishDraftUseCase: PolishDraftUseCase
    @Inject lateinit var generateReplyUseCase: GenerateReplyUseCase
    @Inject lateinit var refinementUseCase: RefinementUseCase
    @Inject lateinit var preferences: FloatingWindowPreferences
    
    @Before
    fun setup() {
        hiltRule.inject()
    }
    
    @Test
    fun `å®Œæ•´æµç¨‹æµ‹è¯•_æ¶¦è‰²åå¾®è°ƒ`() = runTest {
        // 1. æ‰§è¡Œæ¶¦è‰²
        val polishResult = polishDraftUseCase("contact_1", "ä¸å»")
        assertTrue(polishResult.isSuccess)
        
        // 2. æ‰§è¡Œå¾®è°ƒ
        val refinementRequest = RefinementRequest(
            originalInput = "ä¸å»",
            originalTask = ActionType.POLISH,
            lastAiResponse = polishResult.getOrNull()?.polishedText ?: "",
            refinementInstruction = "å¼ºç¡¬ä¸€ç‚¹",
            contactId = "contact_1"
        )
        
        val refinedResult = refinementUseCase(refinementRequest)
        assertTrue(refinedResult.isSuccess)
        assertTrue(refinedResult.getOrNull() is AiResult.Polish)
    }
    
    @Test
    fun `çŠ¶æ€ä¿æŒæµç¨‹æµ‹è¯•`() {
        // 1. ä¿å­˜çŠ¶æ€
        val state = FloatingWindowState(
            selectedTab = ActionType.REPLY,
            selectedContactId = "contact_1",
            inputText = "å¥¹è¯´ä»Šæ™šä¸æƒ³å‡ºé—¨"
        )
        preferences.saveState(state)
        
        // 2. æ¨¡æ‹Ÿæœ€å°åŒ–åæ¢å¤
        val restored = preferences.restoreState()
        
        // 3. éªŒè¯çŠ¶æ€å®Œæ•´æ¢å¤
        assertEquals(state.selectedTab, restored?.selectedTab)
        assertEquals(state.selectedContactId, restored?.selectedContactId)
        assertEquals(state.inputText, restored?.inputText)
    }
}
```

### 6.4 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | é‡ç‚¹æµ‹è¯•é¡¹ |
|------|-----------|-----------|
| PolishDraftUseCase | â‰¥90% | æ­£å¸¸æµç¨‹ã€é£é™©æ£€æµ‹ã€é”™è¯¯å¤„ç† |
| GenerateReplyUseCase | â‰¥90% | æ­£å¸¸æµç¨‹ã€æ ‡ç­¾é›†æˆã€é”™è¯¯å¤„ç† |
| RefinementUseCase | â‰¥90% | æœ‰/æ— æŒ‡ä»¤åˆ†æ”¯ã€å„ä»»åŠ¡ç±»å‹ |
| FloatingWindowPreferences | â‰¥95% | çŠ¶æ€ä¿å­˜/æ¢å¤/æ¸…é™¤ |
| AiResult | 100% | getCopyableTextã€getDisplayContent |


---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| Tabåˆ‡æ¢å“åº” | <50ms | ç”¨æˆ·æ„ŸçŸ¥æ— å»¶è¿Ÿ |
| çŠ¶æ€ä¿å­˜ | <100ms | æœ€å°åŒ–æ—¶å¿«é€Ÿä¿å­˜ |
| çŠ¶æ€æ¢å¤ | <100ms | æ¢å¤æ—¶å¿«é€ŸåŠ è½½ |
| AIè°ƒç”¨è¶…æ—¶ | 45sï¼ˆå¯é…ç½®ï¼‰ | ç½‘ç»œè¯·æ±‚è¶…æ—¶é™åˆ¶ï¼Œè€ƒè™‘AIæ€è€ƒæ—¶é—´ |
| å†…å­˜å ç”¨å¢é‡ | <5MB | æ–°åŠŸèƒ½å¸¦æ¥çš„é¢å¤–å†…å­˜ |

### 7.2 ä¼˜åŒ–ç­–ç•¥

#### 7.2.1 çŠ¶æ€ç®¡ç†ä¼˜åŒ–

```kotlin
// ä½¿ç”¨apply()å¼‚æ­¥å†™å…¥ï¼Œä¸é˜»å¡UIçº¿ç¨‹
fun saveState(state: FloatingWindowState) {
    prefs.edit()
        .putInt(KEY_SELECTED_TAB, state.selectedTab.ordinal)
        .putString(KEY_LAST_CONTACT_ID, state.selectedContactId)
        .putString(KEY_SAVED_INPUT_TEXT, state.inputText)
        .putBoolean(KEY_HAS_SAVED_STATE, true)
        .apply()  // å¼‚æ­¥å†™å…¥
}
```

#### 7.2.2 AIè°ƒç”¨ä¼˜åŒ–

**è®¾è®¡å†³ç­–**ï¼š
- é»˜è®¤è¶…æ—¶è®¾ç½®ä¸º45ç§’ï¼Œè€ƒè™‘åˆ°ç½‘ç»œæ³¢åŠ¨å’ŒAIæ€è€ƒæ—¶é—´
- è¶…æ—¶æ—¶é—´å¯é€šè¿‡SettingsRepositoryé…ç½®ï¼Œç”¨æˆ·å¯æ ¹æ®ç½‘ç»œæƒ…å†µè°ƒæ•´
- å¯¹äºæµå¼è¾“å‡ºåœºæ™¯ï¼Œ30ç§’è¶³å¤Ÿï¼›æ™®é€šREST APIå»ºè®®45-60ç§’
- ç½‘ç»œè¶…æ—¶è‡ªåŠ¨é‡è¯•1æ¬¡ï¼Œæå‡ç§»åŠ¨ç½‘ç»œç¯å¢ƒä¸‹çš„æˆåŠŸç‡

**é‡è¯•ç­–ç•¥**ï¼š
- ä»…å¯¹`NetworkTimeout`ç±»å‹é”™è¯¯è‡ªåŠ¨é‡è¯•
- æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š1æ¬¡
- å…¶ä»–é”™è¯¯ï¼ˆå¦‚è§£æå¤±è´¥ã€æœåŠ¡å•†æœªé…ç½®ï¼‰ç›´æ¥è¿”å›ï¼Œç”±UIå±‚æ˜¾ç¤ºé‡è¯•æŒ‰é’®

```kotlin
// é‡è¯•é…ç½®
data class RetryConfig(
    val maxRetries: Int = 1,
    val retryableErrors: Set<Class<out Throwable>> = setOf(
        TimeoutCancellationException::class.java,
        SocketTimeoutException::class.java,
        ConnectException::class.java
    )
) {
    fun shouldRetry(error: Throwable, currentAttempt: Int): Boolean {
        return currentAttempt < maxRetries && 
               retryableErrors.any { it.isInstance(error) }
    }
}

// ä½¿ç”¨åç¨‹è¶…æ—¶æ§åˆ¶ï¼Œè¶…æ—¶æ—¶é—´å¯é…ç½®ï¼Œæ”¯æŒè‡ªåŠ¨é‡è¯•
suspend fun polishDraft(...): Result<PolishResult> = withContext(ioDispatcher) {
    val timeoutMs = settingsRepository.getAiTimeoutMs() ?: DEFAULT_AI_TIMEOUT_MS
    val retryConfig = RetryConfig()
    
    var lastError: Throwable? = null
    repeat(retryConfig.maxRetries + 1) { attempt ->
        try {
            return@withContext withTimeout(timeoutMs) {
                val response = callAi(provider, systemInstruction, draft)
                val result = parsePolishResult(response)
                Result.success(result)
            }
        } catch (e: Exception) {
            lastError = e
            if (!retryConfig.shouldRetry(e, attempt)) {
                return@withContext Result.failure(e)
            }
            // é‡è¯•å‰çŸ­æš‚å»¶è¿Ÿ
            delay(1000L)
        }
    }
    Result.failure(lastError ?: Exception("æœªçŸ¥é”™è¯¯"))
}

companion object {
    const val DEFAULT_AI_TIMEOUT_MS = 45_000L  // é»˜è®¤45ç§’
    const val MIN_AI_TIMEOUT_MS = 15_000L      // æœ€å°15ç§’
    const val MAX_AI_TIMEOUT_MS = 120_000L     // æœ€å¤§120ç§’
}
```

#### 7.2.3 UIæ¸²æŸ“ä¼˜åŒ–

**è®¾è®¡å†³ç­–**ï¼š
- ä½¿ç”¨é¢„åŠ è½½ç­–ç•¥ï¼šåˆå§‹åŒ–æ—¶å°†3ä¸ªTabçš„Viewå…¨éƒ¨inflateå‡ºæ¥
- é€šè¿‡`View.GONE`/`View.VISIBLE`åˆ‡æ¢æ˜¾ç¤ºï¼Œé¿å…é‡å¤inflate
- è€ƒè™‘åˆ°æ‚¬æµ®çª—ç•Œé¢ç®€å•ï¼Œå…¨åŠ è½½çš„åˆå§‹è€—æ—¶å¯æ¥å—ï¼ˆ<100msï¼‰

```kotlin
// Tabåˆ‡æ¢æ—¶é¿å…é‡å¤åˆ›å»ºView - ä½¿ç”¨GONE/VISIBLEåˆ‡æ¢
class TabSwitcher(context: Context) : FrameLayout(context) {
    
    // åˆå§‹åŒ–æ—¶é¢„åŠ è½½æ‰€æœ‰Tabå†…å®¹View
    private val tabContentViews: Map<ActionType, View> by lazy {
        ActionType.validTypes().associateWith { actionType ->
            inflateTabContent(actionType).also { view ->
                addView(view)
                view.visibility = View.GONE  // åˆå§‹éšè—
            }
        }
    }
    
    private var currentTab: ActionType = ActionType.ANALYZE
    
    init {
        // è§¦å‘æ‡’åŠ è½½ï¼Œé¢„åˆ›å»ºæ‰€æœ‰View
        tabContentViews[ActionType.ANALYZE]?.visibility = View.VISIBLE
    }
    
    fun setSelectedTab(actionType: ActionType) {
        if (currentTab == actionType) return
        
        // éšè—å½“å‰Tab
        tabContentViews[currentTab]?.visibility = View.GONE
        
        // æ˜¾ç¤ºæ–°Tab
        tabContentViews[actionType]?.visibility = View.VISIBLE
        
        currentTab = actionType
    }
    
    private fun inflateTabContent(actionType: ActionType): View {
        // æ ¹æ®Tabç±»å‹inflateå¯¹åº”çš„å¸ƒå±€
        return when (actionType) {
            ActionType.ANALYZE -> LayoutInflater.from(context)
                .inflate(R.layout.floating_tab_analyze, this, false)
            ActionType.POLISH -> LayoutInflater.from(context)
                .inflate(R.layout.floating_tab_polish, this, false)
            ActionType.REPLY -> LayoutInflater.from(context)
                .inflate(R.layout.floating_tab_reply, this, false)
            else -> throw IllegalArgumentException("ä¸æ”¯æŒçš„Tabç±»å‹")
        }
    }
}
```

### 7.3 å†…å­˜ç®¡ç†

```kotlin
// FloatingWindowServiceä¸­çš„å†…å­˜ç®¡ç†
class FloatingWindowService : Service() {
    
    // ä½¿ç”¨WeakReferenceé¿å…å†…å­˜æ³„æ¼
    private var floatingViewRef: WeakReference<FloatingView>? = null
    
    override fun onDestroy() {
        super.onDestroy()
        // æ¸…ç†èµ„æº
        floatingViewRef?.clear()
        floatingViewRef = null
        serviceScope.cancel()
    }
    
    // æœ€å°åŒ–æ—¶é‡Šæ”¾ä¸å¿…è¦çš„èµ„æº
    private fun handleMinimize() {
        preferences.saveState(currentState)
        // æ¸…ç©ºç»“æœç¼“å­˜ï¼Œé‡Šæ”¾å†…å­˜
        currentState = currentState.copy(lastResult = null)
    }
}
```

---

## 8. é”™è¯¯å¤„ç†

### 8.1 é”™è¯¯ç±»å‹å®šä¹‰

```kotlin
sealed class FloatingWindowError : Exception() {
    
    /** AIæœåŠ¡å•†æœªé…ç½® */
    data object NoProviderConfigured : FloatingWindowError() {
        override val message = "è¯·å…ˆé…ç½®AIæœåŠ¡å•†"
    }
    
    /** è”ç³»äººæœªæ‰¾åˆ° */
    data class ContactNotFound(val contactId: String) : FloatingWindowError() {
        override val message = "æœªæ‰¾åˆ°è”ç³»äºº"
    }
    
    /** AIè°ƒç”¨å¤±è´¥ */
    data class AiCallFailed(override val cause: Throwable?) : FloatingWindowError() {
        override val message = "AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"
    }
    
    /** AIå“åº”è§£æå¤±è´¥ */
    data class ParseFailed(val response: String) : FloatingWindowError() {
        override val message = "AIè¿”å›æ ¼å¼å¼‚å¸¸ï¼Œè¯·é‡è¯•"
    }
    
    /** ç½‘ç»œè¶…æ—¶ */
    data object NetworkTimeout : FloatingWindowError() {
        override val message = "ç½‘ç»œè¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•"
    }
    
    /** è¾“å…¥ä¸ºç©º */
    data object EmptyInput : FloatingWindowError() {
        override val message = "è¯·è¾“å…¥å†…å®¹"
    }
    
    /** æœªé€‰æ‹©è”ç³»äºº */
    data object NoContactSelected : FloatingWindowError() {
        override val message = "è¯·é€‰æ‹©è”ç³»äºº"
    }
    
    /**
     * è·å–ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
     */
    fun getUserMessage(): String = message ?: "æœªçŸ¥é”™è¯¯"
    
    /**
     * æ˜¯å¦å¯é‡è¯•
     */
    fun isRetryable(): Boolean = when (this) {
        is AiCallFailed, NetworkTimeout, is ParseFailed -> true
        else -> false
    }
}
```

### 8.2 é”™è¯¯å¤„ç†æµç¨‹

```kotlin
// FloatingWindowServiceä¸­çš„é”™è¯¯å¤„ç†
private fun handleSubmit(contactId: String, text: String) {
    // å‰ç½®æ ¡éªŒ
    if (text.isBlank()) {
        showError(FloatingWindowError.EmptyInput)
        return
    }
    if (contactId.isBlank()) {
        showError(FloatingWindowError.NoContactSelected)
        return
    }
    
    serviceScope.launch {
        currentState = currentState.copy(isLoading = true)
        floatingView?.showLoading(getLoadingText(currentState.selectedTab))
        
        val result = when (currentState.selectedTab) {
            ActionType.ANALYZE -> analyzeChatUseCase(contactId, listOf(text))
                .map { AiResult.Analysis(it) }
            ActionType.POLISH -> polishDraftUseCase(contactId, text)
                .map { AiResult.Polish(it) }
            ActionType.REPLY -> generateReplyUseCase(contactId, text)
                .map { AiResult.Reply(it) }
            else -> Result.failure(IllegalArgumentException("ä¸æ”¯æŒçš„æ“ä½œç±»å‹"))
        }
        
        result.onSuccess { aiResult ->
            currentState = currentState.copy(
                isLoading = false,
                lastResult = aiResult,
                errorMessage = null
            )
            floatingView?.showResult(aiResult)
        }.onFailure { error ->
            val floatingError = mapToFloatingWindowError(error)
            currentState = currentState.copy(
                isLoading = false,
                errorMessage = floatingError.getUserMessage()
            )
            showError(floatingError)
        }
    }
}

private fun mapToFloatingWindowError(error: Throwable): FloatingWindowError {
    return when (error) {
        is IllegalStateException -> when {
            error.message?.contains("AI æœåŠ¡å•†") == true -> 
                FloatingWindowError.NoProviderConfigured
            error.message?.contains("è”ç³»äºº") == true -> 
                FloatingWindowError.ContactNotFound("")
            error.message?.contains("è§£æ") == true -> 
                FloatingWindowError.ParseFailed(error.message ?: "")
            else -> FloatingWindowError.AiCallFailed(error)
        }
        is TimeoutCancellationException -> FloatingWindowError.NetworkTimeout
        else -> FloatingWindowError.AiCallFailed(error)
    }
}

private fun showError(error: FloatingWindowError) {
    floatingView?.showError(
        message = error.getUserMessage(),
        showRetry = error.isRetryable()
    )
}
```


---

## 9. å®æ–½è®¡åˆ’

### 9.1 é˜¶æ®µåˆ’åˆ†

#### é˜¶æ®µä¸€ï¼šåç«¯é‡æ„ï¼ˆé¢„è®¡3å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|--------|----------|--------|----------|------|
| T1.1 | æ‰©å±•ActionTypeæšä¸¾ï¼Œæ·»åŠ POLISHã€REPLY | P0 | 2h | æ—  |
| T1.2 | æ–°å¢PolishResultã€ReplyResultæ¨¡å‹ | P0 | 2h | T1.1 |
| T1.3 | æ–°å¢AiResultå¯†å°ç±» | P0 | 1h | T1.2 |
| T1.4 | æ–°å¢FloatingWindowStateã€RefinementRequestæ¨¡å‹ | P0 | 2h | T1.1 |
| T1.5 | æ‰©å±•PromptSceneæšä¸¾ | P0 | 1h | æ—  |
| T1.6 | æ‰©å±•SystemPromptsï¼Œæ·»åŠ POLISHã€REPLYæç¤ºè¯ | P0 | 3h | T1.5 |
| T1.7 | å®ç°PolishDraftUseCase | P0 | 4h | T1.2, T1.6 |
| T1.8 | å®ç°GenerateReplyUseCase | P0 | 4h | T1.2, T1.6 |
| T1.9 | å®ç°RefinementUseCase | P1 | 3h | T1.7, T1.8 |
| T1.10 | æ‰©å±•AiRepositoryæ¥å£ | P0 | 2h | T1.2 |
| T1.11 | å®ç°AiRepositoryImplæ–°å¢æ–¹æ³• | P0 | 4h | T1.10 |

#### é˜¶æ®µäºŒï¼šçŠ¶æ€ç®¡ç†ï¼ˆé¢„è®¡1å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|--------|----------|--------|----------|------|
| T2.1 | æ‰©å±•FloatingWindowPreferences | P0 | 3h | T1.4 |
| T2.2 | å®ç°çŠ¶æ€ä¿å­˜/æ¢å¤é€»è¾‘ | P0 | 2h | T2.1 |
| T2.3 | å®ç°Tabè®°å¿†åŠŸèƒ½ | P0 | 1h | T2.1 |
| T2.4 | å®ç°è”ç³»äººè®°å¿†åŠŸèƒ½ | P0 | 1h | T2.1 |

#### é˜¶æ®µä¸‰ï¼šUIé‡æ„ï¼ˆé¢„è®¡3å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|--------|----------|--------|----------|------|
| T3.1 | åˆ›å»ºTabSwitcherç»„ä»¶ | P0 | 4h | T1.1 |
| T3.2 | åˆ›å»ºResultCardç»„ä»¶ | P0 | 4h | T1.3 |
| T3.3 | åˆ›å»ºRefinementDialogç»„ä»¶ | P1 | 3h | æ—  |
| T3.4 | é‡æ„FloatingViewé›†æˆTab | P0 | 6h | T3.1, T3.2 |
| T3.5 | é‡æ„FloatingWindowService | P0 | 6h | T3.4, T2.2 |

#### é˜¶æ®µå››ï¼šæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆé¢„è®¡2å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|--------|----------|--------|----------|------|
| T4.1 | UseCaseå•å…ƒæµ‹è¯• | P0 | 4h | é˜¶æ®µä¸€ |
| T4.2 | çŠ¶æ€ç®¡ç†å•å…ƒæµ‹è¯• | P0 | 2h | é˜¶æ®µäºŒ |
| T4.3 | é›†æˆæµ‹è¯• | P0 | 4h | é˜¶æ®µä¸‰ |
| T4.4 | UIæµ‹è¯• | P1 | 3h | é˜¶æ®µä¸‰ |
| T4.5 | æ€§èƒ½ä¼˜åŒ– | P1 | 2h | T4.3 |
| T4.6 | Bugä¿®å¤ | P0 | é¢„ç•™ | T4.3 |

### 9.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | å®Œæˆæ ‡å‡† | é¢„è®¡æ—¥æœŸ |
|--------|----------|----------|
| M1: åç«¯å®Œæˆ | æ‰€æœ‰UseCaseå¯ç‹¬ç«‹è¿è¡Œ | Day 3 |
| M2: çŠ¶æ€ç®¡ç†å®Œæˆ | çŠ¶æ€ä¿å­˜/æ¢å¤åŠŸèƒ½å¯ç”¨ | Day 4 |
| M3: UIå®Œæˆ | ä¸‰Tabåˆ‡æ¢ã€ç»“æœå±•ç¤ºã€å¾®è°ƒåŠŸèƒ½å¯ç”¨ | Day 7 |
| M4: æµ‹è¯•å®Œæˆ | æµ‹è¯•è¦†ç›–ç‡â‰¥90%ï¼Œæ— P0 Bug | Day 9 |

### 9.3 é£é™©è¯„ä¼°

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| AIå“åº”æ ¼å¼ä¸ç¨³å®š | ä¸­ | ä¸­ | ä½¿ç”¨AiResponseCleanerï¼Œæ·»åŠ é™çº§å¤„ç† |
| çŠ¶æ€ä¿æŒå¯¼è‡´å†…å­˜æ³„æ¼ | ä¸­ | ä½ | ä½¿ç”¨WeakReferenceï¼ŒåŠæ—¶æ¸…ç† |
| Tabåˆ‡æ¢å½±å“ç°æœ‰é€»è¾‘ | ä¸­ | ä¸­ | ä¿æŒå‘åå…¼å®¹ï¼Œæ¸è¿›å¼é‡æ„ |
| å¾®è°ƒåŠŸèƒ½å¢åŠ APIæˆæœ¬ | ä½ | ä¸­ | é™åˆ¶å¾®è°ƒæ¬¡æ•°ï¼Œæç¤ºç”¨æˆ· |
| FloatingViewé‡æ„å¤æ‚åº¦é«˜ | é«˜ | ä¸­ | åˆ†æ­¥é‡æ„ï¼Œä¿æŒå¯å›æ»š |

---

## 10. é™„å½•

### 10.1 ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [PRD-00009](../PRD/PRD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„éœ€æ±‚.md) | éœ€æ±‚æ–‡æ¡£ |
| [FD-00009](../FD/FD-00009-æ‚¬æµ®çª—åŠŸèƒ½é‡æ„åŠŸèƒ½è®¾è®¡.md) | åŠŸèƒ½è®¾è®¡æ–‡æ¡£ |
| [PRD-00001](../PRD/PRD-00001-æ‚¬æµ®çª—åŠŸèƒ½éœ€æ±‚.md) | åŸæ‚¬æµ®çª—éœ€æ±‚ |
| [TDD-00005](./TDD-00005-æç¤ºè¯ç®¡ç†ç³»ç»ŸæŠ€æœ¯è®¾è®¡.md) | æç¤ºè¯ç³»ç»Ÿè®¾è®¡ï¼ˆå‚è€ƒï¼‰ |

### 10.2 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| ActionType | æ“ä½œç±»å‹æšä¸¾ï¼Œå®šä¹‰æ‚¬æµ®çª—æ”¯æŒçš„åŠŸèƒ½ï¼ˆåˆ†æ/æ¶¦è‰²/å›å¤ï¼‰ |
| PolishResult | æ¶¦è‰²ç»“æœæ¨¡å‹ï¼ŒåŒ…å«ä¼˜åŒ–åçš„æ–‡æœ¬å’Œé£é™©æç¤º |
| ReplyResult | å›å¤ç»“æœæ¨¡å‹ï¼ŒåŒ…å«å»ºè®®çš„å›å¤å’Œç­–ç•¥è¯´æ˜ |
| AiResult | AIç»“æœå¯†å°ç±»ï¼Œç»Ÿä¸€ä¸‰ç§åŠŸèƒ½çš„è¿”å›ç±»å‹ |
| FloatingWindowState | æ‚¬æµ®çª—çŠ¶æ€æ¨¡å‹ï¼Œç”¨äºçŠ¶æ€ä¿æŒå’Œæ¢å¤ |
| RefinementRequest | å¾®è°ƒè¯·æ±‚æ¨¡å‹ï¼ŒåŒ…å«åŸå§‹è¾“å…¥å’Œå¾®è°ƒæŒ‡ä»¤ |
| PromptScene | æç¤ºè¯åœºæ™¯æšä¸¾ï¼Œå®šä¹‰ä¸åŒåŠŸèƒ½çš„æç¤ºè¯æ¨¡æ¿ |

### 10.3 å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| 2025-12-17 | 1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´æŠ€æœ¯è®¾è®¡ | Kiro |

---

## 11. å®¡æ ¸æ£€æŸ¥æ¸…å•

### 11.1 æ¶æ„å®¡æ ¸

- [ ] ç¬¦åˆClean Architectureåˆ†å±‚åŸåˆ™
- [ ] UseCaseèŒè´£å•ä¸€ï¼Œæ— è·¨å±‚ä¾èµ–
- [ ] Repositoryæ¥å£å®šä¹‰åœ¨Domainå±‚
- [ ] æ•°æ®æ¨¡å‹ä½¿ç”¨ä¸å¯å˜data class

### 11.2 ä»£ç è§„èŒƒå®¡æ ¸

- [ ] å‘½åç¬¦åˆKotlin Coding Conventions
- [ ] æ‰€æœ‰å…¬å¼€æ–¹æ³•æœ‰KDocæ³¨é‡Š
- [ ] é”™è¯¯å¤„ç†ä½¿ç”¨Resultç±»å‹
- [ ] åç¨‹ä½¿ç”¨æ­£ç¡®çš„Dispatcher

### 11.3 æµ‹è¯•å®¡æ ¸

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥90%
- [ ] å…³é”®è·¯å¾„æœ‰é›†æˆæµ‹è¯•
- [ ] Mockä½¿ç”¨MockKæ¡†æ¶
- [ ] æµ‹è¯•å‘½åæ¸…æ™°æè¿°åœºæ™¯

### 11.4 æ€§èƒ½å®¡æ ¸

- [ ] æ— ä¸»çº¿ç¨‹é˜»å¡æ“ä½œ
- [ ] SharedPreferencesä½¿ç”¨apply()
- [ ] åç¨‹æœ‰è¶…æ—¶æ§åˆ¶
- [ ] æ— å†…å­˜æ³„æ¼é£é™©