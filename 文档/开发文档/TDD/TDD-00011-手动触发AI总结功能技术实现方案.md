# TDD-00011 手动触发AI总结功能技术实现方案

## 1. 实现概述

### 1.1 技术目标
基于现有AI总结系统，实现用户手动触发特定时间段对话总结的功能，保持与现有系统的兼容性，同时提供灵活的日期范围选择和进度反馈机制。

### 1.2 实现原则
- **最小侵入**：尽可能复用现有组件和逻辑，减少对现有代码的修改
- **渐进增强**：在现有功能基础上添加新能力，不影响原有体验
- **可扩展性**：设计支持未来功能扩展的架构
- **性能优先**：确保新功能不影响应用整体性能

## 2. 架构实现

### 2.1 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    UI Layer                                │
├─────────────────────────────────────────────────────────────┤
│ ContactDetailScreen                                        │
│ ├── SummaryGenerationButton                                │
│ ├── DateRangePickerDialog                                  │
│ └── SummaryProgressDialog                                  │
├─────────────────────────────────────────────────────────────┤
│                  Presentation Layer                        │
├─────────────────────────────────────────────────────────────┤
│ ContactDetailViewModel                                     │
│ ├── generateSummary()                                      │
│ ├── selectDateRange()                                      │
│ └── observeSummaryProgress()                               │
├─────────────────────────────────────────────────────────────┤
│                    Domain Layer                            │
├─────────────────────────────────────────────────────────────┤
│ ManualSummaryUseCase                                       │
│ ├── validateDateRange()                                    │
│ ├── checkExistingSummary()                                 │
│ └── executeSummaryGeneration()                            │
│                                                            │
│ SummaryGenerationService                                   │
│ ├── createSummaryTask()                                    │
│ ├── processSummaryTask()                                   │
│ └── handleSummaryResult()                                  │
├─────────────────────────────────────────────────────────────┤
│                     Data Layer                             │
├─────────────────────────────────────────────────────────────┤
│ ConversationRepository                                     │
│ ├── getConversationsByDateRange()                          │
│ └── markConversationsAsSummarized()                         │
│                                                            │
│ DailySummaryRepository                                     │
│ ├── getSummaryByDateRange()                                │
│ ├── saveCustomSummary()                                    │
│ └── updateExistingSummary()                                │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 关键组件实现

#### 2.2.1 ManualSummaryUseCase实现
```kotlin
@Singleton
class ManualSummaryUseCase @Inject constructor(
    private val conversationRepository: ConversationRepository,
    private val dailySummaryRepository: DailySummaryRepository,
    private val contactRepository: ContactRepository,
    private val aiSummaryProcessor: AiSummaryProcessor,
    private val localSummaryProcessor: LocalSummaryProcessor,
    private val summaryGenerationService: SummaryGenerationService
) {
    /**
     * 执行手动总结
     */
    suspend operator fun invoke(
        contactId: String,
        startDate: String,
        endDate: String,
        forceRegenerate: Boolean = false
    ): Flow<SummaryGenerationState> = flow {
        emit(SummaryGenerationState.Validating(0.1f))
        
        // 验证日期范围
        val validationResult = validateDateRange(contactId, startDate, endDate)
        if (validationResult.isFailure) {
            emit(SummaryGenerationState.Failed(
                validationResult.exceptionOrNull() ?: Exception("验证失败"),
                canRetry = true
            ))
            return@flow
        }
        
        emit(SummaryGenerationState.Validating(0.3f))
        
        // 检查现有总结
        if (!forceRegenerate) {
            val existingSummaries = checkExistingSummaries(contactId, startDate, endDate)
            if (existingSummaries.isNotEmpty()) {
                emit(SummaryGenerationState.Failed(
                    Exception("该时间段已存在总结，请选择强制重新生成"),
                    canRetry = true
                ))
                return@flow
            }
        }
        
        emit(SummaryGenerationState.Preparing(0.5f))
        
        // 创建总结任务
        val taskId = summaryGenerationService.createSummaryTask(
            contactId, startDate, endDate, forceRegenerate
        )
        
        // 处理总结任务
        summaryGenerationService.processSummaryTask(taskId).collect { progress ->
            when (progress.currentStep) {
                SummaryProgress.GenerationStep.FETCHING_CONVERSATIONS -> 
                    emit(SummaryGenerationState.Generating(
                        0.2f + progress.progress * 0.3f,
                        "获取对话记录..."
                    ))
                SummaryProgress.GenerationStep.PROCESSING_WITH_AI -> 
                    emit(SummaryGenerationState.Generating(
                        0.5f + progress.progress * 0.4f,
                        "AI分析中..."
                    ))
                SummaryProgress.GenerationStep.SAVING_RESULTS -> 
                    emit(SummaryGenerationState.Generating(
                        0.9f + progress.progress * 0.1f,
                        "保存结果..."
                    ))
                else -> emit(SummaryGenerationState.Generating(
                    progress.progress,
                    progress.message
                ))
            }
        }
    }
    
    /**
     * 验证日期范围
     */
    private suspend fun validateDateRange(
        contactId: String,
        startDate: String,
        endDate: String
    ): Result<DateRangeValidation> {
        return try {
            // 验证日期格式
            val start = LocalDate.parse(startDate)
            val end = LocalDate.parse(endDate)
            
            // 验证日期范围合理性
            if (start.isAfter(end)) {
                return Result.failure(Exception("开始日期不能晚于结束日期"))
            }
            
            // 验证日期范围不超过限制（如90天）
            val daysBetween = ChronoUnit.DAYS.between(start, end)
            if (daysBetween > 90) {
                return Result.failure(Exception("日期范围不能超过90天"))
            }
            
            // 验证联系人是否存在
            val profile = contactRepository.getProfile(contactId).getOrNull()
                ?: return Result.failure(Exception("联系人不存在"))
            
            Result.success(DateRangeValidation.Valid)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    /**
     * 检查现有总结
     */
    private suspend fun checkExistingSummaries(
        contactId: String,
        startDate: String,
        endDate: String
    ): List<ExistingSummary> {
        return dailySummaryRepository.getSummariesByDateRange(
            contactId, startDate, endDate
        ).getOrNull()?.map { summary ->
            ExistingSummary(
                id = summary.id,
                date = summary.summaryDate,
                type = if (summary is CustomSummary) 
                    ExistingSummary.Type.CUSTOM 
                else 
                    ExistingSummary.Type.DAILY
            )
        } ?: emptyList()
    }
}
```

#### 2.2.2 SummaryGenerationService实现
```kotlin
@Singleton
class SummaryGenerationService @Inject constructor(
    private val conversationRepository: ConversationRepository,
    private val dailySummaryRepository: DailySummaryRepository,
    private val aiSummaryProcessor: AiSummaryProcessor,
    private val localSummaryProcessor: LocalSummaryProcessor,
    private val taskManager: SummaryTaskManager
) {
    /**
     * 创建总结任务
     */
    suspend fun createSummaryTask(
        contactId: String,
        dateRange: DateRange,
        forceRegenerate: Boolean
    ): String {
        val task = SummaryTask(
            id = UUID.randomUUID().toString(),
            contactId = contactId,
            startDate = dateRange.startDate,
            endDate = dateRange.endDate,
            status = TaskStatus.PENDING,
            progress = 0f,
            currentStep = "",
            createdAt = System.currentTimeMillis(),
            startedAt = null,
            completedAt = null,
            error = null
        )
        
        taskManager.createTask(task)
        return task.id
    }
    
    /**
     * 处理总结任务
     */
    suspend fun processSummaryTask(taskId: String): Flow<SummaryProgress> = flow {
        val task = taskManager.getTask(taskId) ?: return@flow
        
        try {
            // 更新任务状态为进行中
            taskManager.updateTaskStatus(taskId, TaskStatus.RUNNING)
            
            // 获取对话记录
            emit(SummaryProgress(
                taskId = taskId,
                currentStep = SummaryProgress.GenerationStep.FETCHING_CONVERSATIONS,
                progress = 0.1f,
                message = "获取对话记录..."
            ))
            
            val conversations = conversationRepository
                .getConversationsByDateRange(
                    task.contactId,
                    task.startDate,
                    task.endDate
                ).getOrNull() ?: emptyList()
            
            if (conversations.isEmpty()) {
                throw Exception("该时间段没有对话记录")
            }
            
            // 获取联系人画像
            val profile = contactRepository.getProfile(task.contactId).getOrNull()
                ?: throw Exception("联系人不存在")
            
            // AI处理
            emit(SummaryProgress(
                taskId = taskId,
                currentStep = SummaryProgress.GenerationStep.PROCESSING_WITH_AI,
                progress = 0.3f,
                message = "AI分析中..."
            ))
            
            val aiResult = aiSummaryProcessor.processRange(
                profile, conversations, task.startDate, task.endDate
            )
            
            val summary = if (aiResult.isSuccess) {
                aiResult.getOrNull()
            } else {
                // 降级处理
                emit(SummaryProgress(
                    taskId = taskId,
                    currentStep = SummaryProgress.GenerationStep.FALLBACK_PROCESSING,
                    progress = 0.7f,
                    message = "使用本地处理..."
                ))
                
                localSummaryProcessor.processRange(
                    profile, conversations, task.startDate, task.endDate
                ).getOrNull()
            }
            
            // 保存结果
            emit(SummaryProgress(
                taskId = taskId,
                currentStep = SummaryProgress.GenerationStep.SAVING_RESULTS,
                progress = 0.9f,
                message = "保存结果..."
            ))
            
            summary?.let {
                val customSummary = CustomSummary(
                    id = 0,
                    contactId = task.contactId,
                    startDate = task.startDate,
                    endDate = task.endDate,
                    content = it.content,
                    keyEvents = it.keyEvents,
                    newFacts = it.newFacts,
                    updatedTags = it.updatedTags,
                    relationshipScoreChange = it.relationshipScoreChange,
                    relationshipTrend = it.relationshipTrend,
                    summaryType = CustomSummary.SummaryType.CUSTOM_RANGE,
                    generationSource = CustomSummary.GenerationSource.MANUAL,
                    generatedAt = System.currentTimeMillis()
                )
                
                dailySummaryRepository.saveCustomSummary(customSummary)
                
                // 标记对话为已总结
                conversationRepository.markConversationsAsSummarized(
                    conversations.map { it.id }
                )
            }
            
            // 更新任务状态为完成
            taskManager.updateTaskStatus(taskId, TaskStatus.COMPLETED)
            
            emit(SummaryProgress(
                taskId = taskId,
                currentStep = SummaryProgress.GenerationStep.SAVING_RESULTS,
                progress = 1.0f,
                message = "完成"
            ))
            
        } catch (e: Exception) {
            // 更新任务状态为失败
            taskManager.updateTaskError(taskId, e.message)
            
            emit(SummaryProgress(
                taskId = taskId,
                currentStep = SummaryProgress.GenerationStep.SAVING_RESULTS,
                progress = 0f,
                message = "失败: ${e.message}"
            ))
        }
    }
    
    /**
     * 取消总结任务
     */
    suspend fun cancelSummaryTask(taskId: String): Result<Unit> {
        return try {
            taskManager.updateTaskStatus(taskId, TaskStatus.CANCELLED)
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

### 2.3 UI组件实现

#### 2.3.1 ContactDetailViewModel扩展
```kotlin
@HiltViewModel
class ContactDetailViewModel @Inject constructor(
    // 现有依赖...
    private val manualSummaryUseCase: ManualSummaryUseCase
) : ViewModel() {
    
    // 现有状态...
    
    // 手动总结相关状态
    private val _summaryGenerationState = 
        MutableStateFlow<SummaryGenerationState>(SummaryGenerationState.Idle)
    val summaryGenerationState = _summaryGenerationState.asStateFlow()
    
    private val _showDateRangePicker = MutableStateFlow(false)
    val showDateRangePicker = _showDateRangePicker.asStateFlow()
    
    /**
     * 触发总结生成
     */
    fun generateSummary(contactId: String) {
        _showDateRangePicker.value = true
    }
    
    /**
     * 选择日期范围并生成总结
     */
    fun generateSummaryWithDateRange(
        contactId: String,
        startDate: String,
        endDate: String,
        forceRegenerate: Boolean = false
    ) {
        viewModelScope.launch {
            _showDateRangePicker.value = false
            
            manualSummaryUseCase(
                contactId, startDate, endDate, forceRegenerate
            ).collect { state ->
                _summaryGenerationState.value = state
            }
        }
    }
    
    /**
     * 取消总结生成
     */
    fun cancelSummaryGeneration() {
        _summaryGenerationState.value = SummaryGenerationState.Idle
    }
    
    /**
     * 隐藏日期选择器
     */
    fun hideDateRangePicker() {
        _showDateRangePicker.value = false
    }
}
```

#### 2.3.2 ContactDetailScreen扩展
```kotlin
@Composable
fun ContactDetailScreen(
    // 现有参数...
    viewModel: ContactDetailViewModel = hiltViewModel()
) {
    // 现有状态...
    
    // 手动总结相关状态
    val summaryGenerationState by viewModel.summaryGenerationState.collectAsState()
    val showDateRangePicker by viewModel.showDateRangePicker.collectAsState()
    
    // 现有UI...
    
    // 添加总结生成按钮
    FloatingActionButton(
        onClick = { viewModel.generateSummary(contactId) },
        modifier = Modifier
            .padding(16.dp)
            .align(Alignment.BottomEnd)
    ) {
        Icon(
            imageVector = Icons.Default.AutoAwesome,
            contentDescription = "生成总结"
        )
    }
    
    // 日期范围选择对话框
    if (showDateRangePicker) {
        DateRangePickerDialog(
            contactId = contactId,
            onDismiss = { viewModel.hideDateRangePicker() },
            onDateRangeSelected = { startDate, endDate, forceRegenerate ->
                viewModel.generateSummaryWithDateRange(
                    contactId, startDate, endDate, forceRegenerate
                )
            }
        )
    }
    
    // 总结进度对话框
    SummaryProgressDialog(
        summaryState = summaryGenerationState,
        onDismiss = { viewModel.cancelSummaryGeneration() },
        onCancel = { viewModel.cancelSummaryGeneration() }
    )
}
```

## 3. 数据层实现

### 3.1 数据库扩展

#### 3.1.1 CustomSummary实体
```kotlin
@Entity(tableName = "custom_summaries")
data class CustomSummaryEntity(
    @PrimaryKey(autoGenerate = true)
    val id: Long = 0,
    val contactId: String,
    val startDate: String,
    val endDate: String,
    val content: String,
    val keyEvents: String, // JSON存储
    val newFacts: String, // JSON存储
    val updatedTags: String, // JSON存储
    val relationshipScoreChange: Int,
    val relationshipTrend: String,
    val summaryType: String,
    val generationSource: String,
    val generatedAt: Long,
    val template: String? = null
)
```

#### 3.1.2 SummaryTask实体
```kotlin
@Entity(tableName = "summary_tasks")
data class SummaryTaskEntity(
    @PrimaryKey
    val id: String,
    val contactId: String,
    val startDate: String,
    val endDate: String,
    val status: String,
    val progress: Float,
    val currentStep: String,
    val createdAt: Long,
    val startedAt: Long?,
    val completedAt: Long?,
    val error: String?
)
```

### 3.2 DAO扩展

#### 3.2.1 CustomSummaryDao
```kotlin
@Dao
interface CustomSummaryDao {
    @Query("SELECT * FROM custom_summaries WHERE contactId = :contactId AND startDate >= :startDate AND endDate <= :endDate")
    suspend fun getSummariesByDateRange(
        contactId: String,
        startDate: String,
        endDate: String
    ): List<CustomSummaryEntity>
    
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertSummary(summary: CustomSummaryEntity): Long
    
    @Update
    suspend fun updateSummary(summary: CustomSummaryEntity)
    
    @Query("DELETE FROM custom_summaries WHERE id = :id")
    suspend fun deleteSummary(id: Long)
}
```

#### 3.2.2 SummaryTaskDao
```kotlin
@Dao
interface SummaryTaskDao {
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertTask(task: SummaryTaskEntity)
    
    @Query("SELECT * FROM summary_tasks WHERE id = :id")
    suspend fun getTask(id: String): SummaryTaskEntity?
    
    @Update
    suspend fun updateTask(task: SummaryTaskEntity)
    
    @Query("UPDATE summary_tasks SET status = :status WHERE id = :id")
    suspend fun updateTaskStatus(id: String, status: String)
    
    @Query("UPDATE summary_tasks SET error = :error WHERE id = :id")
    suspend fun updateTaskError(id: String, error: String?)
}
```

### 3.3 Repository扩展

#### 3.3.1 DailySummaryRepositoryImpl扩展
```kotlin
class DailySummaryRepositoryImpl @Inject constructor(
    // 现有依赖...
    private val customSummaryDao: CustomSummaryDao
) : DailySummaryRepository {
    
    // 现有方法...
    
    override suspend fun getSummariesByDateRange(
        contactId: String,
        startDate: String,
        endDate: String
    ): Result<List<DailySummary>> {
        return try {
            val dailySummaries = dailySummaryDao.getSummariesByDateRange(
                contactId, startDate, endDate
            )
            
            val customSummaries = customSummaryDao.getSummariesByDateRange(
                contactId, startDate, endDate
            ).map { it.toDomainModel() }
            
            Result.success(dailySummaries + customSummaries)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun saveCustomSummary(summary: CustomSummary): Result<Long> {
        return try {
            val entity = summary.toEntity()
            val id = customSummaryDao.insertSummary(entity)
            Result.success(id)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun updateExistingSummary(
        summaryId: Long,
        newContent: String
    ): Result<Unit> {
        return try {
            // 实现更新逻辑
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

## 4. 性能优化实现

### 4.1 数据处理优化

#### 4.1.1 分批处理
```kotlin
class BatchConversationProcessor {
    private val batchSize = 50
    
    suspend fun processConversations(
        conversations: List<ConversationLog>,
        processor: (List<ConversationLog>) -> Unit
    ) {
        conversations.chunked(batchSize).forEach { batch ->
            processor(batch)
            // 给UI线程更新机会
            yield()
        }
    }
}
```

#### 4.1.2 缓存策略
```kotlin
@Singleton
class SummaryCache @Inject constructor() {
    private val cache = mutableMapOf<String, CachedSummary>()
    
    suspend fun getSummary(key: String): CustomSummary? {
        return cache[key]?.let {
            if (!it.isExpired()) it.summary else null
        }
    }
    
    suspend fun putSummary(key: String, summary: CustomSummary) {
        cache[key] = CachedSummary(summary, System.currentTimeMillis())
    }
    
    private data class CachedSummary(
        val summary: CustomSummary,
        val timestamp: Long
    ) {
        fun isExpired(): Boolean {
            val expiryTime = 30 * 60 * 1000L // 30分钟
            return System.currentTimeMillis() - timestamp > expiryTime
        }
    }
}
```

### 4.2 UI性能优化

#### 4.2.1 状态优化
```kotlin
@Stable
class SummaryGenerationState(
    val status: Status,
    val progress: Float,
    val message: String
) {
    enum class Status {
        IDLE, VALIDATING, PREPARING, GENERATING, COMPLETED, FAILED, CANCELLED
    }
}
```

#### 4.2.2 懒加载
```kotlin
@Composable
fun LazySummaryContent(
    summaryId: String,
    onLoad: (String) -> CustomSummary
) {
    val summary by remember(summaryId) {
        derivedStateOf { onLoad(summaryId) }
    }
    
    // 只有在需要时才加载总结内容
    if (summary != null) {
        SummaryContent(summary)
    }
}
```

## 5. 错误处理实现

### 5.1 错误分类
```kotlin
sealed class SummaryError : Exception() {
    object InvalidDateRange : SummaryError()
    object NoConversationsFound : SummaryError()
    object NetworkUnavailable : SummaryError()
    data class ApiError(val code: Int, override val message: String) : SummaryError()
    data class ProcessingError(override val message: String) : SummaryError()
    object TaskNotFound : SummaryError()
    object TaskAlreadyRunning : SummaryError()
}
```

### 5.2 错误处理策略
```kotlin
class SummaryErrorHandler {
    fun handleError(error: SummaryError): ErrorHandlingResult {
        return when (error) {
            is SummaryError.InvalidDateRange -> ErrorHandlingResult(
                userMessage = "选择的日期范围无效，请重新选择",
                canRetry = true,
                recoveryAction = RecoveryAction.SHOW_DATE_PICKER
            )
            
            is SummaryError.NoConversationsFound -> ErrorHandlingResult(
                userMessage = "该时间段没有对话记录",
                canRetry = false,
                recoveryAction = RecoveryAction.SHOW_EMPTY_STATE
            )
            
            is SummaryError.NetworkUnavailable -> ErrorHandlingResult(
                userMessage = "网络不可用，请检查网络连接",
                canRetry = true,
                recoveryAction = RecoveryAction.RETRY
            )
            
            is SummaryError.ApiError -> ErrorHandlingResult(
                userMessage = "服务暂时不可用，请稍后重试",
                canRetry = true,
                recoveryAction = RecoveryAction.RETRY
            )
            
            else -> ErrorHandlingResult(
                userMessage = "发生未知错误，请稍后重试",
                canRetry = true,
                recoveryAction = RecoveryAction.RETRY
            )
        }
    }
}
```

## 6. 测试实现

### 6.1 单元测试
```kotlin
@Test
fun `手动总结用例 - 有效日期范围 - 应该成功生成总结`() = runTest {
    // Given
    val contactId = "test_contact"
    val startDate = "2025-12-01"
    val endDate = "2025-12-07"
    
    // When
    val result = manualSummaryUseCase(contactId, startDate, endDate).first()
    
    // Then
    assertTrue(result is SummaryGenerationState.Validating)
}
```

### 6.2 集成测试
```kotlin
@Test
fun `完整流程 - 从触发到完成 - 应该正常工作`() = runTest {
    // Given
    val contactId = "test_contact"
    
    // When
    viewModel.generateSummary(contactId)
    viewModel.generateSummaryWithDateRange(contactId, "2025-12-01", "2025-12-07")
    
    // Then
    val states = mutableListOf<SummaryGenerationState>()
    viewModel.summaryGenerationState.test {
        states.addAll(this.values)
    }
    
    assertTrue(states.any { it is SummaryGenerationState.Completed })
}
```

## 7. 发布计划

### 7.1 实现阶段
1. **阶段一**（3天）：基础架构和核心逻辑
2. **阶段二**（4天）：UI组件和交互实现
3. **阶段三**（3天）：优化和测试

### 7.2 测试阶段
1. **内部测试**（2天）：功能和性能测试
2. **用户测试**（2天）：小范围试用

### 7.3 发布阶段
1. **灰度发布**（1天）：小比例用户
2. **全量发布**（1天）：全部用户

---

**文档版本**: 1.0  
**创建日期**: 2025-12-19  
**负责人**: 技术团队  
**审核人**: 架构师