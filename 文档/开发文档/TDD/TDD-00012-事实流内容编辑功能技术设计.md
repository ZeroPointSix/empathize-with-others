# TDD-00012: äº‹å®æµå†…å®¹ç¼–è¾‘åŠŸèƒ½æŠ€æœ¯è®¾è®¡

---
**æ–‡æ¡£ç±»å‹**: TDD (Technical Design Document) - å¼€å‘è¿‡ç¨‹æ–‡æ¡£  
**å­˜æ”¾è§„èŒƒ**: ç¬¦åˆé¡¹ç›®å®ªæ³•ç¬¬IVæ¡ - æ–‡æ¡£è§„èŒƒ  
**ç‰ˆæœ¬æ§åˆ¶**: Gitç®¡ç†ï¼Œè§.commité’©å­  
---

## 1. æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç±»å‹ | TDD (Technical Design Document) |
| æ–‡æ¡£ç¼–å· | TDD-00012 |
| åŠŸèƒ½åç§° | äº‹å®æµå†…å®¹ç¼–è¾‘åŠŸèƒ½ |
| ç‰ˆæœ¬ | 1.0 |
| åˆ›å»ºæ—¥æœŸ | 2025-12-20 |
| æœ€åæ›´æ–° | 2025-12-20 |
| ä½œè€… | Kiro |
| å®¡æ ¸äºº | å¾…å®¡æ ¸ |
| å®¡æ ¸çŠ¶æ€ | ğŸ“ å¾…å®¡æ ¸ |
| å…³è”æ–‡æ¡£ | PRD-00012, FD-00012 |

### 1.1 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-20 | Kiro | åˆå§‹ç‰ˆæœ¬ |

### 1.2 å‚è€ƒæ ‡å‡†

| æ ‡å‡†æ–‡æ¡£ | ç‰ˆæœ¬ | è¯´æ˜ |
|---------|------|------|
| Clean Architecture | - | æ¶æ„æ¨¡å¼æ ‡å‡† |
| MVVM Pattern | - | UIæ¶æ„æ¨¡å¼ |
| Kotlin Coding Conventions | 2.0.21 | ä»£ç è§„èŒƒ |
| Material Design 3 | 1.3.1 | UIè®¾è®¡è§„èŒƒ |

### 1.3 æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

| å€ºåŠ¡ID | æè¿° | å½±å“ | ä¼˜å…ˆçº§ | è®¡åˆ’è§£å†³æ—¶é—´ |
|--------|------|------|--------|-------------|
| TD-012-01 | Factæ¨¡å‹éœ€æ‰©å±•ç¼–è¾‘ç›¸å…³å­—æ®µ | ä¸­ | ğŸŸ¡ ä¸­ | æœ¬æ¬¡è¿­ä»£ |
| TD-012-02 | ConversationLogæ¨¡å‹éœ€æ‰©å±•ç¼–è¾‘å­—æ®µ | ä¸­ | ğŸŸ¡ ä¸­ | æœ¬æ¬¡è¿­ä»£ |
| TD-012-03 | DailySummaryæ¨¡å‹éœ€æ‰©å±•ç¼–è¾‘å­—æ®µ | ä¸­ | ğŸŸ¡ ä¸­ | æœ¬æ¬¡è¿­ä»£ |
| TD-012-04 | ContactProfileæ¨¡å‹éœ€æ‰©å±•ç¼–è¾‘å­—æ®µ | ä¸­ | ğŸŸ¡ ä¸­ | æœ¬æ¬¡è¿­ä»£ |

### 1.4 ç›¸å…³æŠ€æœ¯æ–‡æ¡£

| æ–‡æ¡£ç¼–å· | æ–‡æ¡£åç§° | å…³è”è¯´æ˜ |
|---------|---------|---------|
| TDD-00003 | è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸæŠ€æœ¯è®¾è®¡ | å¤ç”¨Factã€ConversationLogã€DailySummaryæ¨¡å‹ |
| TDD-00004 | è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIæ¶æ„è®¾è®¡ | å¤ç”¨äº‹å®æµUIç»„ä»¶ |
| TDD-00008 | è¾“å…¥å†…å®¹èº«ä»½è¯†åˆ«æŠ€æœ¯è®¾è®¡ | å¤ç”¨IdentityPrefixHelperå¤„ç†å¯¹è¯ç¼–è¾‘ |
| FD-00012 | äº‹å®æµå†…å®¹ç¼–è¾‘åŠŸèƒ½è®¾è®¡ | åŠŸèƒ½è®¾è®¡æ–‡æ¡£ |
| PRD-00012 | äº‹å®æµå†…å®¹ç¼–è¾‘åŠŸèƒ½éœ€æ±‚ | äº§å“éœ€æ±‚æ–‡æ¡£ |

---

## 2. æ¶æ„æ¦‚è¿°

### 2.1 æ¶æ„ç›®æ ‡

äº‹å®æµå†…å®¹ç¼–è¾‘åŠŸèƒ½é‡‡ç”¨ Clean Architecture åˆ†å±‚æ¶æ„ï¼Œæ‰©å±•ç°æœ‰æ¨¡å‹å’Œç»„ä»¶ã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
- æ‰©å±•ç°æœ‰æ•°æ®æ¨¡å‹æ”¯æŒç¼–è¾‘æ ‡è®°
- å®ç°ç»Ÿä¸€çš„å†…å®¹éªŒè¯æœåŠ¡
- æä¾›ä¸€è‡´çš„ç¼–è¾‘å¯¹è¯æ¡†ä½“éªŒ
- ä¿è¯æ•°æ®å®Œæ•´æ€§å’Œå‘åå…¼å®¹

### 2.2 æŠ€æœ¯æ ˆ

| æŠ€æœ¯é¢†åŸŸ | æŠ€æœ¯é€‰æ‹© | ç‰ˆæœ¬ | ç”¨é€” |
|---------|----------|------|------|
| UIæ¡†æ¶ | Jetpack Compose | BOM 2024.12.01 | ç¼–è¾‘å¯¹è¯æ¡†ç»„ä»¶ |
| ç»„ä»¶åº“ | Material 3 | 1.3.1 | Dialogã€TextField |
| å¼‚æ­¥å¤„ç† | Kotlin Coroutines | 1.9.0 | å¼‚æ­¥ä¿å­˜æ“ä½œ |
| ä¾èµ–æ³¨å…¥ | Hilt | 2.52 | ä¾èµ–ç®¡ç† |
| æ•°æ®åº“ | Room | 2.6.1 | æ•°æ®æŒä¹…åŒ– |

### 2.3 è®¾è®¡åŸåˆ™

- **æœ€å°ä¾µå…¥**ï¼šæ‰©å±•ç°æœ‰æ¨¡å‹ï¼Œä¸ç ´åå·²æœ‰åŠŸèƒ½
- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªUseCaseåªè´Ÿè´£ä¸€ç§å†…å®¹ç±»å‹çš„ç¼–è¾‘
- **çŠ¶æ€ä¸å¯å˜**ï¼šä½¿ç”¨data classçš„copyæ–¹æ³•æ›´æ–°çŠ¶æ€
- **å‘åå…¼å®¹**ï¼šæ–°å¢å­—æ®µä½¿ç”¨é»˜è®¤å€¼ï¼Œæ—§æ•°æ®æ­£å¸¸æ˜¾ç¤º


---

## 3. æ•´ä½“æ¶æ„è®¾è®¡

### 3.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           ContactDetailTabViewModel (æ‰©å±•)            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚EditFactDialog  â”‚ â”‚EditConversationDialog      â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  (äº‹å®ç¼–è¾‘)    â”‚ â”‚ (å¯¹è¯ç¼–è¾‘-å·²æœ‰,æ‰©å±•)       â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚EditSummary     â”‚ â”‚EditContactInfoDialog       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚Dialog(æ€»ç»“)    â”‚ â”‚ (è”ç³»äººä¿¡æ¯ç¼–è¾‘)           â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚EditedBadge     â”‚ â”‚DeleteConfirmDialog         â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ (å·²ç¼–è¾‘æ ‡è¯†)   â”‚ â”‚ (åˆ é™¤ç¡®è®¤)                 â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚EditFactUseCase   â”‚ â”‚EditConversationUseCase           â”‚ â”‚
â”‚  â”‚  (äº‹å®ç¼–è¾‘)      â”‚ â”‚  (å¯¹è¯ç¼–è¾‘)                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚EditSummaryUseCaseâ”‚ â”‚EditContactInfoUseCase            â”‚ â”‚
â”‚  â”‚  (æ€»ç»“ç¼–è¾‘)      â”‚ â”‚  (è”ç³»äººä¿¡æ¯ç¼–è¾‘)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ContentValidator  â”‚ â”‚IdentityPrefixHelper              â”‚ â”‚
â”‚  â”‚  (å†…å®¹éªŒè¯)      â”‚ â”‚  (å·²æœ‰-å¤ç”¨)                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Data Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Contact           â”‚ â”‚Conversation                      â”‚ â”‚
â”‚  â”‚  Repository      â”‚ â”‚  Repository                      â”‚ â”‚
â”‚  â”‚  (æ‰©å±•)          â”‚ â”‚  (æ‰©å±•)                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚DailySummary      â”‚ â”‚AppDatabase                       â”‚ â”‚
â”‚  â”‚  Repository      â”‚ â”‚  (Migration v9â†’v10)              â”‚ â”‚
â”‚  â”‚  (æ‰©å±•)          â”‚ â”‚                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å†…å®¹ç¼–è¾‘æ•°æ®æµ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·ç‚¹å‡»å¯ç¼–è¾‘å†…å®¹
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ˜¾ç¤ºç¼–è¾‘     â”‚ â† EditXxxDialog
  â”‚    å¯¹è¯æ¡†    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ç”¨æˆ·ä¿®æ”¹å†…å®¹
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚Content       â”‚ â† éªŒè¯è¾“å…¥å†…å®¹
  â”‚  Validator   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ éªŒè¯é€šè¿‡?
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     å¦      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ éªŒè¯åˆ¤æ–­     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æ˜¾ç¤ºé”™è¯¯æç¤º â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â”‚ æ˜¯                        â”‚
         â–¼                           â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚EditXxxUseCaseâ”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ æ‰§è¡Œç¼–è¾‘æµç¨‹
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1.åˆ›å»ºç¼–è¾‘   â”‚ â† model.copyWithEdit()
  â”‚   åçš„å‰¯æœ¬   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 2.ä¿å­˜åˆ°     â”‚ â† Repository.update()
  â”‚   æ•°æ®åº“     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 3.åˆ·æ–°UI     â”‚ â† StateFlowæ›´æ–°
  â”‚   æ˜¾ç¤ºæ ‡è¯†   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ¨¡å—åˆ’åˆ†

```
domain/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ Fact.kt                        # æ‰©å±•ç¼–è¾‘å­—æ®µ
â”‚   â”œâ”€â”€ ConversationLog.kt             # æ‰©å±•ç¼–è¾‘å­—æ®µ
â”‚   â”œâ”€â”€ DailySummary.kt                # æ‰©å±•ç¼–è¾‘å­—æ®µ
â”‚   â”œâ”€â”€ ContactProfile.kt              # æ‰©å±•ç¼–è¾‘å­—æ®µ
â”‚   â””â”€â”€ EditResult.kt                  # ç¼–è¾‘ç»“æœå¯†å°ç±»ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ usecase/
â”‚   â”œâ”€â”€ EditFactUseCase.kt             # äº‹å®ç¼–è¾‘ç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ EditConversationUseCase.kt     # å¯¹è¯ç¼–è¾‘ç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ EditSummaryUseCase.kt          # æ€»ç»“ç¼–è¾‘ç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ EditContactInfoUseCase.kt      # è”ç³»äººä¿¡æ¯ç¼–è¾‘ç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ util/
â”‚   â”œâ”€â”€ ContentValidator.kt            # å†…å®¹éªŒè¯æœåŠ¡ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ IdentityPrefixHelper.kt        # å·²æœ‰-å¤ç”¨

data/
â”œâ”€â”€ local/
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ ContactProfileEntity.kt    # æ‰©å±•å­—æ®µ
â”‚   â”‚   â”œâ”€â”€ ConversationLogEntity.kt   # æ‰©å±•å­—æ®µ
â”‚   â”‚   â””â”€â”€ DailySummaryEntity.kt      # æ‰©å±•å­—æ®µ
â”‚   â”œâ”€â”€ dao/
â”‚   â”‚   â”œâ”€â”€ ContactDao.kt              # æ‰©å±•æ›´æ–°æ–¹æ³•
â”‚   â”‚   â”œâ”€â”€ ConversationLogDao.kt      # æ‰©å±•æ›´æ–°æ–¹æ³•
â”‚   â”‚   â””â”€â”€ DailySummaryDao.kt         # æ‰©å±•æ›´æ–°æ–¹æ³•
â”‚   â””â”€â”€ AppDatabase.kt                 # Migration v9â†’v10
â”œâ”€â”€ repository/
â”‚   â”œâ”€â”€ ContactRepositoryImpl.kt       # æ‰©å±•ç¼–è¾‘æ–¹æ³•
â”‚   â”œâ”€â”€ ConversationRepositoryImpl.kt  # æ‰©å±•ç¼–è¾‘æ–¹æ³•
â”‚   â””â”€â”€ DailySummaryRepositoryImpl.kt  # æ‰©å±•ç¼–è¾‘æ–¹æ³•

presentation/
â”œâ”€â”€ ui/
â”‚   â””â”€â”€ component/
â”‚       â””â”€â”€ dialog/
â”‚           â”œâ”€â”€ EditFactDialog.kt              # æ–°å¢
â”‚           â”œâ”€â”€ EditConversationDialog.kt      # å·²æœ‰-æ‰©å±•
â”‚           â”œâ”€â”€ EditSummaryDialog.kt           # æ–°å¢
â”‚           â”œâ”€â”€ EditContactNameDialog.kt       # æ–°å¢
â”‚           â”œâ”€â”€ EditContactGoalDialog.kt       # æ–°å¢
â”‚           â””â”€â”€ DeleteConfirmDialog.kt         # æ–°å¢
â”‚       â””â”€â”€ state/
â”‚           â””â”€â”€ EditedBadge.kt                 # æ–°å¢
â”œâ”€â”€ viewmodel/
â”‚   â””â”€â”€ ContactDetailTabViewModel.kt   # æ‰©å±•ç¼–è¾‘äº‹ä»¶å¤„ç†
```



---

## 4. è¯¦ç»†æŠ€æœ¯è®¾è®¡

### 4.1 æ•°æ®æ¨¡å‹è®¾è®¡

#### 4.1.1 Factæ¨¡å‹æ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/Fact.kt`

```kotlin
/**
 * äº‹å®é¢†åŸŸæ¨¡å‹ï¼ˆæ‰©å±•ç‰ˆï¼‰
 *
 * æ–°å¢å­—æ®µæ”¯æŒç¼–è¾‘è¿½è¸ª
 */
data class Fact(
    val id: String = UUID.randomUUID().toString(),
    val key: String,
    val value: String,
    val timestamp: Long,
    val source: FactSource,
    // ==================== æ–°å¢å­—æ®µ ====================
    val isUserModified: Boolean = false,        // æ˜¯å¦è¢«ç”¨æˆ·ä¿®æ”¹è¿‡
    val lastModifiedTime: Long = timestamp,     // æœ€åä¿®æ”¹æ—¶é—´
    val originalKey: String? = null,            // åŸå§‹é”®ï¼ˆä¿®æ”¹å‰ï¼‰
    val originalValue: String? = null           // åŸå§‹å€¼ï¼ˆä¿®æ”¹å‰ï¼‰
) {
    init {
        require(id.isNotBlank()) { "Factçš„idä¸èƒ½ä¸ºç©º" }
        require(key.isNotBlank()) { "Factçš„keyä¸èƒ½ä¸ºç©º" }
        require(value.isNotBlank()) { "Factçš„valueä¸èƒ½ä¸ºç©º" }
        require(timestamp > 0) { "Factçš„timestampå¿…é¡»å¤§äº0" }
    }

    /**
     * åˆ›å»ºç¼–è¾‘åçš„å‰¯æœ¬
     * 
     * @param newKey æ–°çš„é”®
     * @param newValue æ–°çš„å€¼
     * @return ç¼–è¾‘åçš„Factå‰¯æœ¬
     */
    fun copyWithEdit(newKey: String, newValue: String): Fact {
        return copy(
            key = newKey,
            value = newValue,
            isUserModified = true,
            lastModifiedTime = System.currentTimeMillis(),
            // ä»…é¦–æ¬¡ç¼–è¾‘æ—¶ä¿å­˜åŸå§‹å€¼
            originalKey = if (originalKey == null) key else originalKey,
            originalValue = if (originalValue == null) value else originalValue
        )
    }

    /**
     * åˆ¤æ–­å†…å®¹æ˜¯å¦æœ‰å˜åŒ–
     */
    fun hasChanges(newKey: String, newValue: String): Boolean {
        return key != newKey || value != newValue
    }

    /**
     * åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼ˆè¶…è¿‡90å¤©ï¼‰
     */
    fun isExpired(now: Long = System.currentTimeMillis()): Boolean {
        val expiryThreshold = now - MemoryConstants.EXPIRY_DAYS * MemoryConstants.ONE_DAY_MILLIS
        return timestamp < expiryThreshold
    }

    /**
     * æ ¼å¼åŒ–æœ€åä¿®æ”¹æ—¶é—´
     */
    fun formatLastModifiedTime(): String = DateUtils.formatRelativeTime(lastModifiedTime)
}
```

#### 4.1.2 ConversationLogæ¨¡å‹æ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/ConversationLog.kt`

```kotlin
/**
 * å¯¹è¯è®°å½•é¢†åŸŸæ¨¡å‹ï¼ˆæ‰©å±•ç‰ˆï¼‰
 *
 * æ–°å¢å­—æ®µæ”¯æŒç¼–è¾‘è¿½è¸ª
 */
data class ConversationLog(
    val id: Long = 0,
    val contactId: String,
    val userInput: String,
    val aiResponse: String?,
    val timestamp: Long,
    val isSummarized: Boolean = false,
    // ==================== æ–°å¢å­—æ®µ ====================
    val isUserModified: Boolean = false,        // æ˜¯å¦è¢«ç”¨æˆ·ä¿®æ”¹è¿‡
    val lastModifiedTime: Long = timestamp,     // æœ€åä¿®æ”¹æ—¶é—´
    val originalUserInput: String? = null       // åŸå§‹ç”¨æˆ·è¾“å…¥ï¼ˆä¿®æ”¹å‰ï¼‰
) {
    init {
        require(contactId.isNotBlank()) { "contactIdä¸èƒ½ä¸ºç©º" }
        require(userInput.isNotBlank()) { "userInputä¸èƒ½ä¸ºç©º" }
        require(timestamp > 0) { "timestampå¿…é¡»å¤§äº0" }
    }

    /**
     * åˆ›å»ºç¼–è¾‘åçš„å‰¯æœ¬
     * 
     * @param newUserInput æ–°çš„ç”¨æˆ·è¾“å…¥å†…å®¹
     * @return ç¼–è¾‘åçš„ConversationLogå‰¯æœ¬
     */
    fun copyWithEdit(newUserInput: String): ConversationLog {
        return copy(
            userInput = newUserInput,
            isUserModified = true,
            lastModifiedTime = System.currentTimeMillis(),
            originalUserInput = if (originalUserInput == null) userInput else originalUserInput
        )
    }

    /**
     * åˆ¤æ–­å†…å®¹æ˜¯å¦æœ‰å˜åŒ–
     */
    fun hasChanges(newUserInput: String): Boolean {
        return userInput != newUserInput
    }

    /**
     * è·å–æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆyyyy-MM-ddï¼‰
     */
    fun getDateString(): String = DateUtils.formatDate(timestamp)

    /**
     * æ ¼å¼åŒ–æœ€åä¿®æ”¹æ—¶é—´
     */
    fun formatLastModifiedTime(): String = DateUtils.formatRelativeTime(lastModifiedTime)
}
```

#### 4.1.3 DailySummaryæ¨¡å‹æ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/DailySummary.kt`

```kotlin
/**
 * æ¯æ—¥æ€»ç»“é¢†åŸŸæ¨¡å‹ï¼ˆæ‰©å±•ç‰ˆï¼‰
 *
 * æ–°å¢å­—æ®µæ”¯æŒç¼–è¾‘è¿½è¸ª
 */
data class DailySummary(
    val id: Long = 0,
    val contactId: String,
    val summaryDate: String,
    val content: String,
    val keyEvents: List<KeyEvent>,
    val newFacts: List<Fact>,
    val updatedTags: List<TagUpdate>,
    val relationshipScoreChange: Int,
    val relationshipTrend: RelationshipTrend,
    val startDate: String? = null,
    val endDate: String? = null,
    val summaryType: SummaryType = SummaryType.DAILY,
    val generationSource: GenerationSource = GenerationSource.AUTO,
    val conversationCount: Int = 0,
    val generatedAt: Long = System.currentTimeMillis(),
    // ==================== æ–°å¢å­—æ®µ ====================
    val isUserModified: Boolean = false,        // æ˜¯å¦è¢«ç”¨æˆ·ä¿®æ”¹è¿‡
    val lastModifiedTime: Long = generatedAt,   // æœ€åä¿®æ”¹æ—¶é—´
    val originalContent: String? = null         // åŸå§‹å†…å®¹ï¼ˆä¿®æ”¹å‰ï¼‰
) {
    init {
        require(contactId.isNotBlank()) { "contactIdä¸èƒ½ä¸ºç©º" }
        require(summaryDate.matches(Regex("\\d{4}-\\d{2}-\\d{2}"))) {
            "summaryDateæ ¼å¼å¿…é¡»ä¸ºyyyy-MM-dd"
        }
        require(relationshipScoreChange in -10..10) {
            "relationshipScoreChangeå¿…é¡»åœ¨-10åˆ°10ä¹‹é—´"
        }
    }

    /**
     * åˆ›å»ºç¼–è¾‘åçš„å‰¯æœ¬
     * 
     * @param newContent æ–°çš„æ€»ç»“å†…å®¹
     * @return ç¼–è¾‘åçš„DailySummaryå‰¯æœ¬
     */
    fun copyWithEdit(newContent: String): DailySummary {
        return copy(
            content = newContent,
            isUserModified = true,
            lastModifiedTime = System.currentTimeMillis(),
            originalContent = if (originalContent == null) content else originalContent
        )
    }

    /**
     * åˆ¤æ–­å†…å®¹æ˜¯å¦æœ‰å˜åŒ–
     */
    fun hasChanges(newContent: String): Boolean {
        return content != newContent
    }

    /**
     * æ ¼å¼åŒ–æœ€åä¿®æ”¹æ—¶é—´
     */
    fun formatLastModifiedTime(): String = DateUtils.formatRelativeTime(lastModifiedTime)
}
```

#### 4.1.4 ContactProfileæ¨¡å‹æ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/ContactProfile.kt`

```kotlin
/**
 * è”ç³»äººç”»åƒæ¨¡å‹ï¼ˆæ‰©å±•ç‰ˆï¼‰
 *
 * æ–°å¢å­—æ®µæ”¯æŒå§“åå’Œç›®æ ‡çš„ç¼–è¾‘è¿½è¸ª
 */
data class ContactProfile(
    val id: String,
    val name: String,
    val targetGoal: String,
    val contextDepth: Int = 10,
    val facts: List<Fact> = emptyList(),
    val relationshipScore: Int = MemoryConstants.DEFAULT_RELATIONSHIP_SCORE,
    val lastInteractionDate: String? = null,
    val avatarUrl: String? = null,
    // ==================== æ–°å¢å­—æ®µ ====================
    val isNameUserModified: Boolean = false,    // å§“åæ˜¯å¦è¢«ç”¨æˆ·ä¿®æ”¹è¿‡
    val isGoalUserModified: Boolean = false,    // ç›®æ ‡æ˜¯å¦è¢«ç”¨æˆ·ä¿®æ”¹è¿‡
    val nameLastModifiedTime: Long = 0L,        // å§“åæœ€åä¿®æ”¹æ—¶é—´
    val goalLastModifiedTime: Long = 0L,        // ç›®æ ‡æœ€åä¿®æ”¹æ—¶é—´
    val originalName: String? = null,           // åŸå§‹å§“åï¼ˆä¿®æ”¹å‰ï¼‰
    val originalGoal: String? = null            // åŸå§‹ç›®æ ‡ï¼ˆä¿®æ”¹å‰ï¼‰
) {
    init {
        require(id.isNotBlank()) { "idä¸èƒ½ä¸ºç©º" }
        require(name.isNotBlank()) { "nameä¸èƒ½ä¸ºç©º" }
        require(contextDepth > 0) { "contextDepthå¿…é¡»å¤§äº0" }
    }

    /**
     * åˆ›å»ºå§“åç¼–è¾‘åçš„å‰¯æœ¬
     */
    fun copyWithNameEdit(newName: String): ContactProfile {
        return copy(
            name = newName,
            isNameUserModified = true,
            nameLastModifiedTime = System.currentTimeMillis(),
            originalName = if (originalName == null) name else originalName
        )
    }

    /**
     * åˆ›å»ºç›®æ ‡ç¼–è¾‘åçš„å‰¯æœ¬
     */
    fun copyWithGoalEdit(newGoal: String): ContactProfile {
        return copy(
            targetGoal = newGoal,
            isGoalUserModified = true,
            goalLastModifiedTime = System.currentTimeMillis(),
            originalGoal = if (originalGoal == null) targetGoal else originalGoal
        )
    }

    /**
     * åˆ¤æ–­å§“åæ˜¯å¦æœ‰å˜åŒ–
     */
    fun hasNameChanges(newName: String): Boolean = name != newName

    /**
     * åˆ¤æ–­ç›®æ ‡æ˜¯å¦æœ‰å˜åŒ–
     */
    fun hasGoalChanges(newGoal: String): Boolean = targetGoal != newGoal
}
```

#### 4.1.5 EditResultï¼ˆç¼–è¾‘ç»“æœå¯†å°ç±» - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/EditResult.kt`

```kotlin
/**
 * ç¼–è¾‘ç»“æœå¯†å°ç±»
 */
sealed class EditResult {
    /**
     * ç¼–è¾‘æˆåŠŸ
     */
    object Success : EditResult()
    
    /**
     * éªŒè¯é”™è¯¯
     */
    data class ValidationError(val message: String) : EditResult()
    
    /**
     * æ•°æ®åº“é”™è¯¯
     */
    data class DatabaseError(val exception: Exception) : EditResult()
    
    /**
     * æ•°æ®ä¸å­˜åœ¨
     */
    object NotFound : EditResult()
    
    /**
     * æ— å˜åŒ–ï¼ˆå†…å®¹ç›¸åŒï¼‰
     */
    object NoChanges : EditResult()
    
    /**
     * æ˜¯å¦æˆåŠŸ
     */
    fun isSuccess(): Boolean = this is Success
    
    /**
     * è·å–é”™è¯¯æ¶ˆæ¯
     */
    fun getErrorMessage(): String? = when (this) {
        is Success -> null
        is ValidationError -> message
        is DatabaseError -> "ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•"
        is NotFound -> "å†…å®¹å·²è¢«åˆ é™¤"
        is NoChanges -> null
    }
}
```



### 4.2 æ•°æ®åº“æ‰©å±•è®¾è®¡

#### 4.2.1 ContactProfileEntityæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/entity/ContactProfileEntity.kt`

```kotlin
@Entity(tableName = "contact_profiles")
data class ContactProfileEntity(
    @PrimaryKey
    @ColumnInfo(name = "id")
    val id: String,

    @ColumnInfo(name = "name")
    val name: String,

    @ColumnInfo(name = "target_goal")
    val targetGoal: String,

    @ColumnInfo(name = "context_depth")
    val contextDepth: Int,

    @ColumnInfo(name = "facts_json")
    val factsJson: String,

    @ColumnInfo(name = "relationship_score")
    val relationshipScore: Int,

    @ColumnInfo(name = "last_interaction_date")
    val lastInteractionDate: String?,

    @ColumnInfo(name = "avatar_url")
    val avatarUrl: String?,
    
    // ==================== æ–°å¢å­—æ®µ ====================
    
    @ColumnInfo(name = "is_name_user_modified", defaultValue = "0")
    val isNameUserModified: Boolean = false,
    
    @ColumnInfo(name = "is_goal_user_modified", defaultValue = "0")
    val isGoalUserModified: Boolean = false,
    
    @ColumnInfo(name = "name_last_modified_time", defaultValue = "0")
    val nameLastModifiedTime: Long = 0L,
    
    @ColumnInfo(name = "goal_last_modified_time", defaultValue = "0")
    val goalLastModifiedTime: Long = 0L,
    
    @ColumnInfo(name = "original_name", defaultValue = "NULL")
    val originalName: String? = null,
    
    @ColumnInfo(name = "original_goal", defaultValue = "NULL")
    val originalGoal: String? = null
)
```

#### 4.2.2 ConversationLogEntityæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/entity/ConversationLogEntity.kt`

```kotlin
@Entity(
    tableName = "conversation_logs",
    foreignKeys = [
        ForeignKey(
            entity = ContactProfileEntity::class,
            parentColumns = ["id"],
            childColumns = ["contact_id"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [Index(value = ["contact_id"])]
)
data class ConversationLogEntity(
    @PrimaryKey(autoGenerate = true)
    @ColumnInfo(name = "id")
    val id: Long = 0,

    @ColumnInfo(name = "contact_id")
    val contactId: String,

    @ColumnInfo(name = "user_input")
    val userInput: String,

    @ColumnInfo(name = "ai_response")
    val aiResponse: String?,

    @ColumnInfo(name = "timestamp")
    val timestamp: Long,

    @ColumnInfo(name = "is_summarized")
    val isSummarized: Boolean,
    
    // ==================== æ–°å¢å­—æ®µ ====================
    
    @ColumnInfo(name = "is_user_modified", defaultValue = "0")
    val isUserModified: Boolean = false,
    
    @ColumnInfo(name = "last_modified_time", defaultValue = "0")
    val lastModifiedTime: Long = 0L,
    
    @ColumnInfo(name = "original_user_input", defaultValue = "NULL")
    val originalUserInput: String? = null
)
```

#### 4.2.3 DailySummaryEntityæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/entity/DailySummaryEntity.kt`

```kotlin
@Entity(
    tableName = "daily_summaries",
    foreignKeys = [
        ForeignKey(
            entity = ContactProfileEntity::class,
            parentColumns = ["id"],
            childColumns = ["contact_id"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [
        Index(value = ["contact_id"]),
        Index(value = ["summary_date"]),
        Index(value = ["contact_id", "summary_date"], unique = true)
    ]
)
data class DailySummaryEntity(
    @PrimaryKey(autoGenerate = true)
    @ColumnInfo(name = "id")
    val id: Long = 0,

    @ColumnInfo(name = "contact_id")
    val contactId: String,

    @ColumnInfo(name = "summary_date")
    val summaryDate: String,

    @ColumnInfo(name = "content")
    val content: String,

    @ColumnInfo(name = "key_events_json")
    val keyEventsJson: String,

    @ColumnInfo(name = "relationship_score")
    val relationshipScore: Int,

    @ColumnInfo(name = "created_at")
    val createdAt: Long,
    
    // v9æ–°å¢å­—æ®µï¼ˆæ‰‹åŠ¨æ€»ç»“æ”¯æŒï¼‰
    @ColumnInfo(name = "start_date", defaultValue = "NULL")
    val startDate: String? = null,
    
    @ColumnInfo(name = "end_date", defaultValue = "NULL")
    val endDate: String? = null,
    
    @ColumnInfo(name = "summary_type", defaultValue = "'DAILY'")
    val summaryType: String = "DAILY",
    
    @ColumnInfo(name = "generation_source", defaultValue = "'AUTO'")
    val generationSource: String = "AUTO",
    
    @ColumnInfo(name = "conversation_count", defaultValue = "0")
    val conversationCount: Int = 0,
    
    @ColumnInfo(name = "generated_at", defaultValue = "0")
    val generatedAt: Long = 0,
    
    // ==================== v10æ–°å¢å­—æ®µï¼ˆç¼–è¾‘æ”¯æŒï¼‰ ====================
    
    @ColumnInfo(name = "is_user_modified", defaultValue = "0")
    val isUserModified: Boolean = false,
    
    @ColumnInfo(name = "last_modified_time", defaultValue = "0")
    val lastModifiedTime: Long = 0L,
    
    @ColumnInfo(name = "original_content", defaultValue = "NULL")
    val originalContent: String? = null
)
```

#### 4.2.4 æ•°æ®åº“è¿ç§»è„šæœ¬

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/AppDatabase.kt`

```kotlin
/**
 * Migration 9 -> 10: æ·»åŠ ç¼–è¾‘ç›¸å…³å­—æ®µ
 */
val MIGRATION_9_10 = object : Migration(9, 10) {
    override fun migrate(database: SupportSQLiteDatabase) {
        // 1. æ‰©å±• contact_profiles è¡¨
        database.execSQL("""
            ALTER TABLE contact_profiles 
            ADD COLUMN is_name_user_modified INTEGER NOT NULL DEFAULT 0
        """)
        database.execSQL("""
            ALTER TABLE contact_profiles 
            ADD COLUMN is_goal_user_modified INTEGER NOT NULL DEFAULT 0
        """)
        database.execSQL("""
            ALTER TABLE contact_profiles 
            ADD COLUMN name_last_modified_time INTEGER NOT NULL DEFAULT 0
        """)
        database.execSQL("""
            ALTER TABLE contact_profiles 
            ADD COLUMN goal_last_modified_time INTEGER NOT NULL DEFAULT 0
        """)
        database.execSQL("""
            ALTER TABLE contact_profiles 
            ADD COLUMN original_name TEXT DEFAULT NULL
        """)
        database.execSQL("""
            ALTER TABLE contact_profiles 
            ADD COLUMN original_goal TEXT DEFAULT NULL
        """)

        // 2. æ‰©å±• conversation_logs è¡¨
        database.execSQL("""
            ALTER TABLE conversation_logs 
            ADD COLUMN is_user_modified INTEGER NOT NULL DEFAULT 0
        """)
        database.execSQL("""
            ALTER TABLE conversation_logs 
            ADD COLUMN last_modified_time INTEGER NOT NULL DEFAULT 0
        """)
        database.execSQL("""
            ALTER TABLE conversation_logs 
            ADD COLUMN original_user_input TEXT DEFAULT NULL
        """)

        // 3. æ‰©å±• daily_summaries è¡¨
        database.execSQL("""
            ALTER TABLE daily_summaries 
            ADD COLUMN is_user_modified INTEGER NOT NULL DEFAULT 0
        """)
        database.execSQL("""
            ALTER TABLE daily_summaries 
            ADD COLUMN last_modified_time INTEGER NOT NULL DEFAULT 0
        """)
        database.execSQL("""
            ALTER TABLE daily_summaries 
            ADD COLUMN original_content TEXT DEFAULT NULL
        """)
    }
}
```

#### 4.2.5 DAOæ‰©å±•

**ContactDaoæ‰©å±•**ï¼š

```kotlin
@Dao
interface ContactDao {
    // ... å·²æœ‰æ–¹æ³• ...
    
    /**
     * æ›´æ–°è”ç³»äººå§“åï¼ˆç¼–è¾‘ï¼‰
     */
    @Query("""
        UPDATE contact_profiles SET 
            name = :newName,
            is_name_user_modified = 1,
            name_last_modified_time = :modifiedTime,
            original_name = CASE WHEN original_name IS NULL THEN :originalName ELSE original_name END
        WHERE id = :contactId
    """)
    suspend fun updateName(
        contactId: String,
        newName: String,
        modifiedTime: Long,
        originalName: String
    ): Int
    
    /**
     * æ›´æ–°è”ç³»äººç›®æ ‡ï¼ˆç¼–è¾‘ï¼‰
     */
    @Query("""
        UPDATE contact_profiles SET 
            target_goal = :newGoal,
            is_goal_user_modified = 1,
            goal_last_modified_time = :modifiedTime,
            original_goal = CASE WHEN original_goal IS NULL THEN :originalGoal ELSE original_goal END
        WHERE id = :contactId
    """)
    suspend fun updateGoal(
        contactId: String,
        newGoal: String,
        modifiedTime: Long,
        originalGoal: String
    ): Int
}
```

**ConversationLogDaoæ‰©å±•**ï¼š

```kotlin
@Dao
interface ConversationLogDao {
    // ... å·²æœ‰æ–¹æ³• ...
    
    /**
     * æ›´æ–°å¯¹è¯å†…å®¹ï¼ˆç¼–è¾‘ï¼‰
     */
    @Query("""
        UPDATE conversation_logs SET 
            user_input = :newUserInput,
            is_user_modified = 1,
            last_modified_time = :modifiedTime,
            original_user_input = CASE WHEN original_user_input IS NULL THEN :originalInput ELSE original_user_input END
        WHERE id = :logId
    """)
    suspend fun updateUserInput(
        logId: Long,
        newUserInput: String,
        modifiedTime: Long,
        originalInput: String
    ): Int
    
    /**
     * æ ¹æ®IDè·å–å¯¹è¯è®°å½•
     */
    @Query("SELECT * FROM conversation_logs WHERE id = :logId")
    suspend fun getById(logId: Long): ConversationLogEntity?
}
```

**DailySummaryDaoæ‰©å±•**ï¼š

```kotlin
@Dao
interface DailySummaryDao {
    // ... å·²æœ‰æ–¹æ³• ...
    
    /**
     * æ›´æ–°æ€»ç»“å†…å®¹ï¼ˆç¼–è¾‘ï¼‰
     */
    @Query("""
        UPDATE daily_summaries SET 
            content = :newContent,
            is_user_modified = 1,
            last_modified_time = :modifiedTime,
            original_content = CASE WHEN original_content IS NULL THEN :originalContent ELSE original_content END
        WHERE id = :summaryId
    """)
    suspend fun updateContent(
        summaryId: Long,
        newContent: String,
        modifiedTime: Long,
        originalContent: String
    ): Int
    
    /**
     * æ ¹æ®IDè·å–æ€»ç»“
     */
    @Query("SELECT * FROM daily_summaries WHERE id = :summaryId")
    suspend fun getById(summaryId: Long): DailySummaryEntity?
}
```



### 4.3 UseCaseè®¾è®¡

#### 4.3.1 ContentValidatorï¼ˆå†…å®¹éªŒè¯æœåŠ¡ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/util/ContentValidator.kt`

```kotlin
/**
 * å†…å®¹éªŒè¯æœåŠ¡
 *
 * æä¾›ç»Ÿä¸€çš„å†…å®¹éªŒè¯é€»è¾‘
 */
@Singleton
class ContentValidator @Inject constructor() {
    
    companion object {
        // å­—ç¬¦é™åˆ¶
        const val MAX_FACT_KEY_LENGTH = 50
        const val MAX_FACT_VALUE_LENGTH = 500
        const val MAX_CONVERSATION_LENGTH = 1000
        const val MAX_SUMMARY_LENGTH = 2000
        const val MAX_CONTACT_NAME_LENGTH = 50
        const val MAX_CONTACT_GOAL_LENGTH = 200
    }
    
    /**
     * éªŒè¯äº‹å®é”®
     */
    fun validateFactKey(key: String): ValidationResult {
        return when {
            key.isBlank() -> ValidationResult.Error("äº‹å®ç±»å‹ä¸èƒ½ä¸ºç©º")
            key.length > MAX_FACT_KEY_LENGTH -> 
                ValidationResult.Error("äº‹å®ç±»å‹ä¸èƒ½è¶…è¿‡${MAX_FACT_KEY_LENGTH}å­—")
            else -> ValidationResult.Valid
        }
    }
    
    /**
     * éªŒè¯äº‹å®å€¼
     */
    fun validateFactValue(value: String): ValidationResult {
        return when {
            value.isBlank() -> ValidationResult.Error("äº‹å®å†…å®¹ä¸èƒ½ä¸ºç©º")
            value.length > MAX_FACT_VALUE_LENGTH -> 
                ValidationResult.Error("äº‹å®å†…å®¹ä¸èƒ½è¶…è¿‡${MAX_FACT_VALUE_LENGTH}å­—")
            else -> ValidationResult.Valid
        }
    }
    
    /**
     * éªŒè¯å¯¹è¯å†…å®¹
     */
    fun validateConversation(content: String): ValidationResult {
        return when {
            content.isBlank() -> ValidationResult.Error("å¯¹è¯å†…å®¹ä¸èƒ½ä¸ºç©º")
            content.length > MAX_CONVERSATION_LENGTH -> 
                ValidationResult.Error("å¯¹è¯å†…å®¹ä¸èƒ½è¶…è¿‡${MAX_CONVERSATION_LENGTH}å­—")
            else -> ValidationResult.Valid
        }
    }
    
    /**
     * éªŒè¯æ€»ç»“å†…å®¹
     */
    fun validateSummary(content: String): ValidationResult {
        return when {
            content.isBlank() -> ValidationResult.Error("æ€»ç»“å†…å®¹ä¸èƒ½ä¸ºç©º")
            content.length > MAX_SUMMARY_LENGTH -> 
                ValidationResult.Error("æ€»ç»“å†…å®¹ä¸èƒ½è¶…è¿‡${MAX_SUMMARY_LENGTH}å­—")
            else -> ValidationResult.Valid
        }
    }
    
    /**
     * éªŒè¯è”ç³»äººå§“å
     */
    fun validateContactName(name: String): ValidationResult {
        return when {
            name.isBlank() -> ValidationResult.Error("è”ç³»äººå§“åä¸èƒ½ä¸ºç©º")
            name.length > MAX_CONTACT_NAME_LENGTH -> 
                ValidationResult.Error("è”ç³»äººå§“åä¸èƒ½è¶…è¿‡${MAX_CONTACT_NAME_LENGTH}å­—")
            else -> ValidationResult.Valid
        }
    }
    
    /**
     * éªŒè¯è”ç³»äººç›®æ ‡
     */
    fun validateContactGoal(goal: String): ValidationResult {
        return when {
            goal.isBlank() -> ValidationResult.Error("è”ç³»äººç›®æ ‡ä¸èƒ½ä¸ºç©º")
            goal.length > MAX_CONTACT_GOAL_LENGTH -> 
                ValidationResult.Error("è”ç³»äººç›®æ ‡ä¸èƒ½è¶…è¿‡${MAX_CONTACT_GOAL_LENGTH}å­—")
            else -> ValidationResult.Valid
        }
    }
    
    /**
     * éªŒè¯ç»“æœ
     */
    sealed class ValidationResult {
        object Valid : ValidationResult()
        data class Error(val message: String) : ValidationResult()
        
        fun isValid(): Boolean = this is Valid
        fun getErrorMessage(): String? = (this as? Error)?.message
    }
}
```

#### 4.3.2 EditFactUseCaseï¼ˆäº‹å®ç¼–è¾‘ç”¨ä¾‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/EditFactUseCase.kt`

```kotlin
/**
 * äº‹å®ç¼–è¾‘ç”¨ä¾‹
 *
 * è´Ÿè´£äº‹å®å†…å®¹çš„ç¼–è¾‘å’Œä¿å­˜
 */
@Singleton
class EditFactUseCase @Inject constructor(
    private val contactRepository: ContactRepository,
    private val contentValidator: ContentValidator,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) {
    companion object {
        private const val TAG = "EditFactUseCase"
    }
    
    /**
     * ç¼–è¾‘äº‹å®
     *
     * @param contactId è”ç³»äººID
     * @param factId äº‹å®ID
     * @param newKey æ–°çš„é”®
     * @param newValue æ–°çš„å€¼
     * @return ç¼–è¾‘ç»“æœ
     */
    suspend operator fun invoke(
        contactId: String,
        factId: String,
        newKey: String,
        newValue: String
    ): Result<EditResult> = withContext(ioDispatcher) {
        try {
            // 1. éªŒè¯è¾“å…¥
            val keyValidation = contentValidator.validateFactKey(newKey.trim())
            if (!keyValidation.isValid()) {
                return@withContext Result.success(
                    EditResult.ValidationError(keyValidation.getErrorMessage()!!)
                )
            }
            
            val valueValidation = contentValidator.validateFactValue(newValue.trim())
            if (!valueValidation.isValid()) {
                return@withContext Result.success(
                    EditResult.ValidationError(valueValidation.getErrorMessage()!!)
                )
            }
            
            // 2. è·å–è”ç³»äºº
            val profile = contactRepository.getProfile(contactId).getOrNull()
                ?: return@withContext Result.success(EditResult.NotFound)
            
            // 3. æŸ¥æ‰¾äº‹å®
            val fact = profile.facts.find { it.id == factId }
                ?: return@withContext Result.success(EditResult.NotFound)
            
            // 4. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            if (!fact.hasChanges(newKey.trim(), newValue.trim())) {
                return@withContext Result.success(EditResult.NoChanges)
            }
            
            // 5. åˆ›å»ºç¼–è¾‘åçš„äº‹å®
            val updatedFact = fact.copyWithEdit(newKey.trim(), newValue.trim())
            
            // 6. æ›´æ–°è”ç³»äººçš„factsåˆ—è¡¨
            val updatedFacts = profile.facts.map { 
                if (it.id == factId) updatedFact else it 
            }
            val updatedProfile = profile.copy(facts = updatedFacts)
            
            // 7. ä¿å­˜
            contactRepository.updateProfile(updatedProfile)
            
            DebugLogger.d(TAG, "äº‹å®ç¼–è¾‘æˆåŠŸ: factId=$factId")
            Result.success(EditResult.Success)
        } catch (e: Exception) {
            DebugLogger.e(TAG, "äº‹å®ç¼–è¾‘å¤±è´¥", e)
            Result.success(EditResult.DatabaseError(e))
        }
    }
}
```

#### 4.3.3 EditConversationUseCaseï¼ˆå¯¹è¯ç¼–è¾‘ç”¨ä¾‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/EditConversationUseCase.kt`

```kotlin
/**
 * å¯¹è¯è®°å½•ç¼–è¾‘ç”¨ä¾‹
 *
 * è´Ÿè´£å¯¹è¯å†…å®¹çš„ç¼–è¾‘å’Œä¿å­˜
 * æ³¨æ„ï¼šéœ€è¦å¤„ç†èº«ä»½å‰ç¼€
 */
@Singleton
class EditConversationUseCase @Inject constructor(
    private val conversationRepository: ConversationRepository,
    private val contentValidator: ContentValidator,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) {
    companion object {
        private const val TAG = "EditConversationUseCase"
    }
    
    /**
     * ç¼–è¾‘å¯¹è¯è®°å½•
     *
     * @param logId å¯¹è¯è®°å½•ID
     * @param newContent æ–°çš„å†…å®¹ï¼ˆå·²åŒ…å«èº«ä»½å‰ç¼€ï¼‰
     * @return ç¼–è¾‘ç»“æœ
     */
    suspend operator fun invoke(
        logId: Long,
        newContent: String
    ): Result<EditResult> = withContext(ioDispatcher) {
        try {
            // 1. éªŒè¯è¾“å…¥ï¼ˆè§£æåçš„çº¯æ–‡æœ¬ï¼‰
            val parseResult = IdentityPrefixHelper.parse(newContent)
            val validation = contentValidator.validateConversation(parseResult.content.trim())
            if (!validation.isValid()) {
                return@withContext Result.success(
                    EditResult.ValidationError(validation.getErrorMessage()!!)
                )
            }
            
            // 2. è·å–åŸå¯¹è¯è®°å½•
            val log = conversationRepository.getById(logId)
                ?: return@withContext Result.success(EditResult.NotFound)
            
            // 3. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            if (!log.hasChanges(newContent.trim())) {
                return@withContext Result.success(EditResult.NoChanges)
            }
            
            // 4. æ›´æ–°å¯¹è¯è®°å½•
            conversationRepository.updateUserInput(
                logId = logId,
                newUserInput = newContent.trim(),
                modifiedTime = System.currentTimeMillis(),
                originalInput = log.userInput
            )
            
            DebugLogger.d(TAG, "å¯¹è¯ç¼–è¾‘æˆåŠŸ: logId=$logId")
            Result.success(EditResult.Success)
        } catch (e: Exception) {
            DebugLogger.e(TAG, "å¯¹è¯ç¼–è¾‘å¤±è´¥", e)
            Result.success(EditResult.DatabaseError(e))
        }
    }
}
```

#### 4.3.4 EditSummaryUseCaseï¼ˆæ€»ç»“ç¼–è¾‘ç”¨ä¾‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/EditSummaryUseCase.kt`

```kotlin
/**
 * AIæ€»ç»“ç¼–è¾‘ç”¨ä¾‹
 *
 * è´Ÿè´£æ€»ç»“å†…å®¹çš„ç¼–è¾‘å’Œä¿å­˜
 */
@Singleton
class EditSummaryUseCase @Inject constructor(
    private val dailySummaryRepository: DailySummaryRepository,
    private val contentValidator: ContentValidator,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) {
    companion object {
        private const val TAG = "EditSummaryUseCase"
    }
    
    /**
     * ç¼–è¾‘æ€»ç»“
     *
     * @param summaryId æ€»ç»“ID
     * @param newContent æ–°çš„å†…å®¹
     * @return ç¼–è¾‘ç»“æœ
     */
    suspend operator fun invoke(
        summaryId: Long,
        newContent: String
    ): Result<EditResult> = withContext(ioDispatcher) {
        try {
            // 1. éªŒè¯è¾“å…¥
            val validation = contentValidator.validateSummary(newContent.trim())
            if (!validation.isValid()) {
                return@withContext Result.success(
                    EditResult.ValidationError(validation.getErrorMessage()!!)
                )
            }
            
            // 2. è·å–åŸæ€»ç»“
            val summary = dailySummaryRepository.getById(summaryId)
                ?: return@withContext Result.success(EditResult.NotFound)
            
            // 3. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            if (!summary.hasChanges(newContent.trim())) {
                return@withContext Result.success(EditResult.NoChanges)
            }
            
            // 4. æ›´æ–°æ€»ç»“
            dailySummaryRepository.updateContent(
                summaryId = summaryId,
                newContent = newContent.trim(),
                modifiedTime = System.currentTimeMillis(),
                originalContent = summary.content
            )
            
            DebugLogger.d(TAG, "æ€»ç»“ç¼–è¾‘æˆåŠŸ: summaryId=$summaryId")
            Result.success(EditResult.Success)
        } catch (e: Exception) {
            DebugLogger.e(TAG, "æ€»ç»“ç¼–è¾‘å¤±è´¥", e)
            Result.success(EditResult.DatabaseError(e))
        }
    }
}
```

#### 4.3.5 EditContactInfoUseCaseï¼ˆè”ç³»äººä¿¡æ¯ç¼–è¾‘ç”¨ä¾‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/EditContactInfoUseCase.kt`

```kotlin
/**
 * è”ç³»äººä¿¡æ¯ç¼–è¾‘ç”¨ä¾‹
 *
 * è´Ÿè´£è”ç³»äººå§“åå’Œç›®æ ‡çš„ç¼–è¾‘
 */
@Singleton
class EditContactInfoUseCase @Inject constructor(
    private val contactRepository: ContactRepository,
    private val contentValidator: ContentValidator,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) {
    companion object {
        private const val TAG = "EditContactInfoUseCase"
    }
    
    /**
     * ç¼–è¾‘è”ç³»äººå§“å
     */
    suspend fun editName(
        contactId: String,
        newName: String
    ): Result<EditResult> = withContext(ioDispatcher) {
        try {
            // 1. éªŒè¯è¾“å…¥
            val validation = contentValidator.validateContactName(newName.trim())
            if (!validation.isValid()) {
                return@withContext Result.success(
                    EditResult.ValidationError(validation.getErrorMessage()!!)
                )
            }
            
            // 2. è·å–è”ç³»äºº
            val profile = contactRepository.getProfile(contactId).getOrNull()
                ?: return@withContext Result.success(EditResult.NotFound)
            
            // 3. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            if (!profile.hasNameChanges(newName.trim())) {
                return@withContext Result.success(EditResult.NoChanges)
            }
            
            // 4. æ›´æ–°å§“å
            contactRepository.updateName(
                contactId = contactId,
                newName = newName.trim(),
                modifiedTime = System.currentTimeMillis(),
                originalName = profile.name
            )
            
            DebugLogger.d(TAG, "è”ç³»äººå§“åç¼–è¾‘æˆåŠŸ: contactId=$contactId")
            Result.success(EditResult.Success)
        } catch (e: Exception) {
            DebugLogger.e(TAG, "è”ç³»äººå§“åç¼–è¾‘å¤±è´¥", e)
            Result.success(EditResult.DatabaseError(e))
        }
    }
    
    /**
     * ç¼–è¾‘è”ç³»äººç›®æ ‡
     */
    suspend fun editGoal(
        contactId: String,
        newGoal: String
    ): Result<EditResult> = withContext(ioDispatcher) {
        try {
            // 1. éªŒè¯è¾“å…¥
            val validation = contentValidator.validateContactGoal(newGoal.trim())
            if (!validation.isValid()) {
                return@withContext Result.success(
                    EditResult.ValidationError(validation.getErrorMessage()!!)
                )
            }
            
            // 2. è·å–è”ç³»äºº
            val profile = contactRepository.getProfile(contactId).getOrNull()
                ?: return@withContext Result.success(EditResult.NotFound)
            
            // 3. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            if (!profile.hasGoalChanges(newGoal.trim())) {
                return@withContext Result.success(EditResult.NoChanges)
            }
            
            // 4. æ›´æ–°ç›®æ ‡
            contactRepository.updateGoal(
                contactId = contactId,
                newGoal = newGoal.trim(),
                modifiedTime = System.currentTimeMillis(),
                originalGoal = profile.targetGoal
            )
            
            DebugLogger.d(TAG, "è”ç³»äººç›®æ ‡ç¼–è¾‘æˆåŠŸ: contactId=$contactId")
            Result.success(EditResult.Success)
        } catch (e: Exception) {
            DebugLogger.e(TAG, "è”ç³»äººç›®æ ‡ç¼–è¾‘å¤±è´¥", e)
            Result.success(EditResult.DatabaseError(e))
        }
    }
}
```



### 4.4 UIç»„ä»¶è®¾è®¡

#### 4.4.1 EditFactDialogï¼ˆäº‹å®ç¼–è¾‘å¯¹è¯æ¡† - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/component/dialog/EditFactDialog.kt`

```kotlin
/**
 * äº‹å®ç¼–è¾‘å¯¹è¯æ¡†
 *
 * @param fact è¦ç¼–è¾‘çš„äº‹å®
 * @param onDismiss å…³é—­å¯¹è¯æ¡†å›è°ƒ
 * @param onConfirm ç¡®è®¤ç¼–è¾‘å›è°ƒ
 * @param onDelete åˆ é™¤å›è°ƒ
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun EditFactDialog(
    fact: Fact,
    onDismiss: () -> Unit,
    onConfirm: (newKey: String, newValue: String) -> Unit,
    onDelete: () -> Unit,
    modifier: Modifier = Modifier
) {
    var factKey by remember { mutableStateOf(fact.key) }
    var factValue by remember { mutableStateOf(fact.value) }
    var keyError by remember { mutableStateOf<String?>(null) }
    var valueError by remember { mutableStateOf<String?>(null) }
    var showDeleteConfirm by remember { mutableStateOf(false) }
    var showOriginal by remember { mutableStateOf(false) }
    var expanded by remember { mutableStateOf(false) }
    
    // é¢„è®¾çš„äº‹å®ç±»å‹
    val presetKeys = listOf(
        "æ€§æ ¼ç‰¹ç‚¹", "å…´è¶£çˆ±å¥½", "å·¥ä½œä¿¡æ¯", "å®¶åº­æƒ…å†µ",
        "é‡è¦æ—¥æœŸ", "ç¦å¿Œè¯é¢˜", "æ²Ÿé€šç­–ç•¥", "å…¶ä»–"
    )

    if (showDeleteConfirm) {
        DeleteConfirmDialog(
            title = "ç¡®è®¤åˆ é™¤",
            message = "ç¡®å®šè¦åˆ é™¤è¿™æ¡äº‹å®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚",
            onConfirm = {
                showDeleteConfirm = false
                onDelete()
            },
            onDismiss = { showDeleteConfirm = false }
        )
    } else {
        AlertDialog(
            onDismissRequest = onDismiss,
            title = { Text("ç¼–è¾‘äº‹å®") },
            text = {
                Column(
                    modifier = Modifier.fillMaxWidth(),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    // æ¥æºå’Œæ—¶é—´ä¿¡æ¯
                    Row(
                        horizontalArrangement = Arrangement.spacedBy(8.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Icon(
                            imageVector = if (fact.source == FactSource.MANUAL) 
                                Icons.Default.Person else Icons.Default.AutoAwesome,
                            contentDescription = null,
                            modifier = Modifier.size(16.dp),
                            tint = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                        Text(
                            text = if (fact.source == FactSource.MANUAL) "æ‰‹åŠ¨æ·»åŠ " else "AIæ¨æ–­",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                        Text(
                            text = "Â· ${fact.formatDate()}",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                    
                    // äº‹å®ç±»å‹é€‰æ‹©
                    ExposedDropdownMenuBox(
                        expanded = expanded,
                        onExpandedChange = { expanded = it }
                    ) {
                        OutlinedTextField(
                            value = factKey,
                            onValueChange = { 
                                factKey = it
                                keyError = if (it.isBlank()) "äº‹å®ç±»å‹ä¸èƒ½ä¸ºç©º" 
                                          else if (it.length > 50) "ä¸èƒ½è¶…è¿‡50å­—" 
                                          else null
                            },
                            label = { Text("äº‹å®ç±»å‹ *") },
                            isError = keyError != null,
                            supportingText = keyError?.let { { Text(it) } },
                            singleLine = true,
                            trailingIcon = { 
                                ExposedDropdownMenuDefaults.TrailingIcon(expanded = expanded) 
                            },
                            modifier = Modifier
                                .fillMaxWidth()
                                .menuAnchor()
                        )
                        
                        ExposedDropdownMenu(
                            expanded = expanded,
                            onDismissRequest = { expanded = false }
                        ) {
                            presetKeys.forEach { key ->
                                DropdownMenuItem(
                                    text = { Text(key) },
                                    onClick = {
                                        factKey = key
                                        expanded = false
                                        keyError = null
                                    }
                                )
                            }
                        }
                    }
                    
                    // äº‹å®å†…å®¹è¾“å…¥
                    OutlinedTextField(
                        value = factValue,
                        onValueChange = { 
                            factValue = it
                            valueError = if (it.isBlank()) "äº‹å®å†…å®¹ä¸èƒ½ä¸ºç©º"
                                        else if (it.length > 500) "ä¸èƒ½è¶…è¿‡500å­—"
                                        else null
                        },
                        label = { Text("äº‹å®å†…å®¹ *") },
                        isError = valueError != null,
                        supportingText = {
                            Row(
                                modifier = Modifier.fillMaxWidth(),
                                horizontalArrangement = Arrangement.SpaceBetween
                            ) {
                                valueError?.let { Text(it) } ?: Spacer(Modifier)
                                Text("${factValue.length}/500")
                            }
                        },
                        minLines = 2,
                        maxLines = 6,
                        modifier = Modifier.fillMaxWidth()
                    )
                    
                    // åŸå§‹å†…å®¹ï¼ˆå¦‚æœæœ‰ä¸”å·²ç¼–è¾‘è¿‡ï¼‰
                    if (fact.isUserModified && fact.originalValue != null) {
                        TextButton(
                            onClick = { showOriginal = !showOriginal }
                        ) {
                            Text(if (showOriginal) "éšè—åŸå§‹å†…å®¹" else "æŸ¥çœ‹åŸå§‹å†…å®¹")
                        }
                        
                        if (showOriginal) {
                            Card(
                                colors = CardDefaults.cardColors(
                                    containerColor = MaterialTheme.colorScheme.surfaceVariant
                                )
                            ) {
                                Column(
                                    modifier = Modifier.padding(12.dp)
                                ) {
                                    Text(
                                        text = "åŸå§‹ç±»å‹ï¼š${fact.originalKey ?: fact.key}",
                                        style = MaterialTheme.typography.bodySmall
                                    )
                                    Text(
                                        text = "åŸå§‹å†…å®¹ï¼š${fact.originalValue}",
                                        style = MaterialTheme.typography.bodySmall
                                    )
                                }
                            }
                        }
                    }
                }
            },
            confirmButton = {
                TextButton(
                    onClick = { onConfirm(factKey.trim(), factValue.trim()) },
                    enabled = factKey.isNotBlank() && factValue.isNotBlank() 
                              && keyError == null && valueError == null
                ) {
                    Text("ä¿å­˜")
                }
            },
            dismissButton = {
                Row {
                    IconButton(onClick = { showDeleteConfirm = true }) {
                        Icon(
                            imageVector = Icons.Default.Delete,
                            contentDescription = "åˆ é™¤",
                            tint = MaterialTheme.colorScheme.error
                        )
                    }
                    TextButton(onClick = onDismiss) {
                        Text("å–æ¶ˆ")
                    }
                }
            },
            modifier = modifier
        )
    }
}
```

#### 4.4.2 EditSummaryDialogï¼ˆæ€»ç»“ç¼–è¾‘å¯¹è¯æ¡† - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/component/dialog/EditSummaryDialog.kt`

```kotlin
/**
 * AIæ€»ç»“ç¼–è¾‘å¯¹è¯æ¡†
 *
 * @param summary è¦ç¼–è¾‘çš„æ€»ç»“
 * @param onDismiss å…³é—­å¯¹è¯æ¡†å›è°ƒ
 * @param onConfirm ç¡®è®¤ç¼–è¾‘å›è°ƒ
 */
@Composable
fun EditSummaryDialog(
    summary: DailySummary,
    onDismiss: () -> Unit,
    onConfirm: (newContent: String) -> Unit,
    modifier: Modifier = Modifier
) {
    var content by remember { mutableStateOf(summary.content) }
    var contentError by remember { mutableStateOf<String?>(null) }
    var showOriginal by remember { mutableStateOf(false) }

    AlertDialog(
        onDismissRequest = onDismiss,
        title = { 
            Text("ç¼–è¾‘æ€»ç»“ (${summary.getDisplayDateRange()})") 
        },
        text = {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .verticalScroll(rememberScrollState()),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                // å…ƒä¿¡æ¯æ˜¾ç¤º
                Row(
                    horizontalArrangement = Arrangement.spacedBy(8.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    SummarySourceBadge(source = summary.generationSource)
                    Text(
                        text = "åˆ†æäº†${summary.conversationCount}æ¡å¯¹è¯",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
                
                // å†…å®¹ç¼–è¾‘æ¡†
                OutlinedTextField(
                    value = content,
                    onValueChange = { 
                        content = it
                        contentError = if (it.isBlank()) "æ€»ç»“å†…å®¹ä¸èƒ½ä¸ºç©º"
                                      else if (it.length > 2000) "ä¸èƒ½è¶…è¿‡2000å­—"
                                      else null
                    },
                    label = { Text("æ€»ç»“å†…å®¹") },
                    isError = contentError != null,
                    supportingText = {
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            horizontalArrangement = Arrangement.SpaceBetween
                        ) {
                            contentError?.let { Text(it) } ?: Spacer(Modifier)
                            Text("${content.length}/2000")
                        }
                    },
                    minLines = 5,
                    maxLines = 10,
                    modifier = Modifier.fillMaxWidth()
                )
                
                // åŸå§‹å†…å®¹å‚è€ƒï¼ˆå¦‚æœæœ‰ï¼‰
                if (summary.isUserModified && summary.originalContent != null) {
                    TextButton(
                        onClick = { showOriginal = !showOriginal }
                    ) {
                        Text(if (showOriginal) "éšè—åŸå§‹å†…å®¹" else "æŸ¥çœ‹åŸå§‹å†…å®¹")
                    }
                    
                    if (showOriginal) {
                        Card(
                            colors = CardDefaults.cardColors(
                                containerColor = MaterialTheme.colorScheme.surfaceVariant
                            )
                        ) {
                            Text(
                                text = summary.originalContent,
                                style = MaterialTheme.typography.bodySmall,
                                modifier = Modifier.padding(12.dp)
                            )
                        }
                    }
                }
            }
        },
        confirmButton = {
            TextButton(
                onClick = { onConfirm(content.trim()) },
                enabled = content.isNotBlank() && contentError == null
            ) {
                Text("ä¿å­˜")
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("å–æ¶ˆ")
            }
        },
        modifier = modifier
    )
}
```

#### 4.4.3 EditedBadgeï¼ˆå·²ç¼–è¾‘æ ‡è¯† - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/component/state/EditedBadge.kt`

```kotlin
/**
 * å·²ç¼–è¾‘æ ‡è¯†å¾½ç« 
 *
 * @param lastModifiedTime æœ€åä¿®æ”¹æ—¶é—´
 * @param modifier Modifier
 */
@Composable
fun EditedBadge(
    lastModifiedTime: Long,
    modifier: Modifier = Modifier
) {
    Row(
        modifier = modifier,
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(4.dp)
    ) {
        Icon(
            imageVector = Icons.Default.Edit,
            contentDescription = "å·²ç¼–è¾‘",
            modifier = Modifier.size(12.dp),
            tint = MaterialTheme.colorScheme.onSurfaceVariant
        )
        Text(
            text = "å·²ç¼–è¾‘ Â· ${DateUtils.formatRelativeTime(lastModifiedTime)}",
            style = MaterialTheme.typography.labelSmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}

/**
 * æ ¼å¼åŒ–ç›¸å¯¹æ—¶é—´
 */
object DateUtils {
    fun formatRelativeTime(timestamp: Long): String {
        val now = System.currentTimeMillis()
        val diff = now - timestamp
        
        return when {
            diff < 60_000 -> "åˆšåˆš"
            diff < 3600_000 -> "${diff / 60_000}åˆ†é’Ÿå‰"
            diff < 86400_000 -> "${diff / 3600_000}å°æ—¶å‰"
            diff < 604800_000 -> "${diff / 86400_000}å¤©å‰"
            else -> {
                val sdf = java.text.SimpleDateFormat("MM-dd", java.util.Locale.getDefault())
                sdf.format(java.util.Date(timestamp))
            }
        }
    }
}
```

#### 4.4.4 DeleteConfirmDialogï¼ˆåˆ é™¤ç¡®è®¤å¯¹è¯æ¡† - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/component/dialog/DeleteConfirmDialog.kt`

```kotlin
/**
 * åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
 *
 * @param title æ ‡é¢˜
 * @param message æç¤ºæ¶ˆæ¯
 * @param onConfirm ç¡®è®¤åˆ é™¤å›è°ƒ
 * @param onDismiss å–æ¶ˆå›è°ƒ
 */
@Composable
fun DeleteConfirmDialog(
    title: String,
    message: String,
    onConfirm: () -> Unit,
    onDismiss: () -> Unit,
    modifier: Modifier = Modifier
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        icon = {
            Icon(
                imageVector = Icons.Default.Warning,
                contentDescription = null,
                tint = MaterialTheme.colorScheme.error
            )
        },
        title = { Text(title) },
        text = { Text(message) },
        confirmButton = {
            TextButton(onClick = onConfirm) {
                Text(
                    text = "åˆ é™¤",
                    color = MaterialTheme.colorScheme.error
                )
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("å–æ¶ˆ")
            }
        },
        modifier = modifier
    )
}
```



### 4.5 ViewModelæ‰©å±•è®¾è®¡

#### 4.5.1 ContactDetailTabViewModelæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/viewmodel/ContactDetailTabViewModel.kt`

```kotlin
/**
 * è”ç³»äººè¯¦æƒ…æ ‡ç­¾é¡µViewModelï¼ˆæ‰©å±•ç¼–è¾‘åŠŸèƒ½ï¼‰
 */
@HiltViewModel
class ContactDetailTabViewModel @Inject constructor(
    // ... å·²æœ‰ä¾èµ– ...
    private val editFactUseCase: EditFactUseCase,
    private val editConversationUseCase: EditConversationUseCase,
    private val editSummaryUseCase: EditSummaryUseCase,
    private val editContactInfoUseCase: EditContactInfoUseCase
) : ViewModel() {
    
    // ==================== ç¼–è¾‘ç›¸å…³çŠ¶æ€ ====================
    
    private val _editingFact = MutableStateFlow<Fact?>(null)
    val editingFact: StateFlow<Fact?> = _editingFact.asStateFlow()
    
    private val _editingConversation = MutableStateFlow<ConversationLog?>(null)
    val editingConversation: StateFlow<ConversationLog?> = _editingConversation.asStateFlow()
    
    private val _editingSummary = MutableStateFlow<DailySummary?>(null)
    val editingSummary: StateFlow<DailySummary?> = _editingSummary.asStateFlow()
    
    private val _editingContactName = MutableStateFlow(false)
    val editingContactName: StateFlow<Boolean> = _editingContactName.asStateFlow()
    
    private val _editingContactGoal = MutableStateFlow(false)
    val editingContactGoal: StateFlow<Boolean> = _editingContactGoal.asStateFlow()
    
    private val _editError = MutableStateFlow<String?>(null)
    val editError: StateFlow<String?> = _editError.asStateFlow()
    
    private val _editSuccess = MutableStateFlow(false)
    val editSuccess: StateFlow<Boolean> = _editSuccess.asStateFlow()
    
    // ==================== ç¼–è¾‘äº‹ä»¶å¤„ç† ====================
    
    fun onEvent(event: ContactDetailUiEvent) {
        when (event) {
            // ... å·²æœ‰äº‹ä»¶å¤„ç† ...
            
            // ç¼–è¾‘ç›¸å…³äº‹ä»¶
            is ContactDetailUiEvent.StartEditFact -> {
                _editingFact.value = event.fact
            }
            is ContactDetailUiEvent.ConfirmEditFact -> {
                editFact(event.factId, event.newKey, event.newValue)
            }
            is ContactDetailUiEvent.CancelEditFact -> {
                _editingFact.value = null
            }
            is ContactDetailUiEvent.DeleteFact -> {
                deleteFact(event.factId)
            }
            
            is ContactDetailUiEvent.StartEditConversation -> {
                _editingConversation.value = event.conversation
            }
            is ContactDetailUiEvent.ConfirmEditConversation -> {
                editConversation(event.logId, event.newContent)
            }
            is ContactDetailUiEvent.CancelEditConversation -> {
                _editingConversation.value = null
            }
            is ContactDetailUiEvent.DeleteConversation -> {
                deleteConversation(event.logId)
            }
            
            is ContactDetailUiEvent.StartEditSummary -> {
                _editingSummary.value = event.summary
            }
            is ContactDetailUiEvent.ConfirmEditSummary -> {
                editSummary(event.summaryId, event.newContent)
            }
            is ContactDetailUiEvent.CancelEditSummary -> {
                _editingSummary.value = null
            }
            
            is ContactDetailUiEvent.StartEditContactName -> {
                _editingContactName.value = true
            }
            is ContactDetailUiEvent.ConfirmEditContactName -> {
                editContactName(event.newName)
            }
            is ContactDetailUiEvent.CancelEditContactName -> {
                _editingContactName.value = false
            }
            
            is ContactDetailUiEvent.StartEditContactGoal -> {
                _editingContactGoal.value = true
            }
            is ContactDetailUiEvent.ConfirmEditContactGoal -> {
                editContactGoal(event.newGoal)
            }
            is ContactDetailUiEvent.CancelEditContactGoal -> {
                _editingContactGoal.value = false
            }
            
            is ContactDetailUiEvent.ClearEditError -> {
                _editError.value = null
            }
            is ContactDetailUiEvent.ClearEditSuccess -> {
                _editSuccess.value = false
            }
            
            else -> { /* å…¶ä»–äº‹ä»¶å¤„ç† */ }
        }
    }
    
    // ==================== ç¼–è¾‘æ“ä½œå®ç° ====================
    
    private fun editFact(factId: String, newKey: String, newValue: String) {
        viewModelScope.launch {
            val contactId = _uiState.value.contactId ?: return@launch
            
            editFactUseCase(contactId, factId, newKey, newValue)
                .onSuccess { result ->
                    handleEditResult(result, "äº‹å®")
                    if (result.isSuccess()) {
                        _editingFact.value = null
                        refreshData()
                    }
                }
                .onFailure { e ->
                    _editError.value = "ç¼–è¾‘å¤±è´¥ï¼š${e.message}"
                }
        }
    }
    
    private fun editConversation(logId: Long, newContent: String) {
        viewModelScope.launch {
            editConversationUseCase(logId, newContent)
                .onSuccess { result ->
                    handleEditResult(result, "å¯¹è¯")
                    if (result.isSuccess()) {
                        _editingConversation.value = null
                        refreshData()
                    }
                }
                .onFailure { e ->
                    _editError.value = "ç¼–è¾‘å¤±è´¥ï¼š${e.message}"
                }
        }
    }
    
    private fun editSummary(summaryId: Long, newContent: String) {
        viewModelScope.launch {
            editSummaryUseCase(summaryId, newContent)
                .onSuccess { result ->
                    handleEditResult(result, "æ€»ç»“")
                    if (result.isSuccess()) {
                        _editingSummary.value = null
                        refreshData()
                    }
                }
                .onFailure { e ->
                    _editError.value = "ç¼–è¾‘å¤±è´¥ï¼š${e.message}"
                }
        }
    }
    
    private fun editContactName(newName: String) {
        viewModelScope.launch {
            val contactId = _uiState.value.contactId ?: return@launch
            
            editContactInfoUseCase.editName(contactId, newName)
                .onSuccess { result ->
                    handleEditResult(result, "å§“å")
                    if (result.isSuccess()) {
                        _editingContactName.value = false
                        refreshData()
                    }
                }
                .onFailure { e ->
                    _editError.value = "ç¼–è¾‘å¤±è´¥ï¼š${e.message}"
                }
        }
    }
    
    private fun editContactGoal(newGoal: String) {
        viewModelScope.launch {
            val contactId = _uiState.value.contactId ?: return@launch
            
            editContactInfoUseCase.editGoal(contactId, newGoal)
                .onSuccess { result ->
                    handleEditResult(result, "ç›®æ ‡")
                    if (result.isSuccess()) {
                        _editingContactGoal.value = false
                        refreshData()
                    }
                }
                .onFailure { e ->
                    _editError.value = "ç¼–è¾‘å¤±è´¥ï¼š${e.message}"
                }
        }
    }
    
    private fun handleEditResult(result: EditResult, itemName: String) {
        when (result) {
            is EditResult.Success -> {
                _editSuccess.value = true
            }
            is EditResult.ValidationError -> {
                _editError.value = result.message
            }
            is EditResult.DatabaseError -> {
                _editError.value = "${itemName}ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•"
            }
            is EditResult.NotFound -> {
                _editError.value = "${itemName}å·²è¢«åˆ é™¤"
            }
            is EditResult.NoChanges -> {
                // æ— å˜åŒ–ï¼Œé™é»˜å…³é—­å¯¹è¯æ¡†
            }
        }
    }
    
    private fun deleteFact(factId: String) {
        viewModelScope.launch {
            val contactId = _uiState.value.contactId ?: return@launch
            // è°ƒç”¨å·²æœ‰çš„åˆ é™¤é€»è¾‘
            // ...
            refreshData()
        }
    }
    
    private fun deleteConversation(logId: Long) {
        viewModelScope.launch {
            // è°ƒç”¨å·²æœ‰çš„åˆ é™¤é€»è¾‘
            // ...
            refreshData()
        }
    }
    
    private fun refreshData() {
        // åˆ·æ–°æ•°æ®
        loadContactDetail()
    }
}
```

#### 4.5.2 ContactDetailUiEventæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/ContactDetailUiEvent.kt`

```kotlin
/**
 * è”ç³»äººè¯¦æƒ…UIäº‹ä»¶ï¼ˆæ‰©å±•ç¼–è¾‘äº‹ä»¶ï¼‰
 */
sealed class ContactDetailUiEvent {
    // ... å·²æœ‰äº‹ä»¶ ...
    
    // ==================== äº‹å®ç¼–è¾‘äº‹ä»¶ ====================
    
    /** å¼€å§‹ç¼–è¾‘äº‹å® */
    data class StartEditFact(val fact: Fact) : ContactDetailUiEvent()
    
    /** ç¡®è®¤ç¼–è¾‘äº‹å® */
    data class ConfirmEditFact(
        val factId: String,
        val newKey: String,
        val newValue: String
    ) : ContactDetailUiEvent()
    
    /** å–æ¶ˆç¼–è¾‘äº‹å® */
    object CancelEditFact : ContactDetailUiEvent()
    
    /** åˆ é™¤äº‹å® */
    data class DeleteFact(val factId: String) : ContactDetailUiEvent()
    
    // ==================== å¯¹è¯ç¼–è¾‘äº‹ä»¶ ====================
    
    /** å¼€å§‹ç¼–è¾‘å¯¹è¯ */
    data class StartEditConversation(val conversation: ConversationLog) : ContactDetailUiEvent()
    
    /** ç¡®è®¤ç¼–è¾‘å¯¹è¯ */
    data class ConfirmEditConversation(
        val logId: Long,
        val newContent: String
    ) : ContactDetailUiEvent()
    
    /** å–æ¶ˆç¼–è¾‘å¯¹è¯ */
    object CancelEditConversation : ContactDetailUiEvent()
    
    /** åˆ é™¤å¯¹è¯ */
    data class DeleteConversation(val logId: Long) : ContactDetailUiEvent()
    
    // ==================== æ€»ç»“ç¼–è¾‘äº‹ä»¶ ====================
    
    /** å¼€å§‹ç¼–è¾‘æ€»ç»“ */
    data class StartEditSummary(val summary: DailySummary) : ContactDetailUiEvent()
    
    /** ç¡®è®¤ç¼–è¾‘æ€»ç»“ */
    data class ConfirmEditSummary(
        val summaryId: Long,
        val newContent: String
    ) : ContactDetailUiEvent()
    
    /** å–æ¶ˆç¼–è¾‘æ€»ç»“ */
    object CancelEditSummary : ContactDetailUiEvent()
    
    // ==================== è”ç³»äººä¿¡æ¯ç¼–è¾‘äº‹ä»¶ ====================
    
    /** å¼€å§‹ç¼–è¾‘è”ç³»äººå§“å */
    object StartEditContactName : ContactDetailUiEvent()
    
    /** ç¡®è®¤ç¼–è¾‘è”ç³»äººå§“å */
    data class ConfirmEditContactName(val newName: String) : ContactDetailUiEvent()
    
    /** å–æ¶ˆç¼–è¾‘è”ç³»äººå§“å */
    object CancelEditContactName : ContactDetailUiEvent()
    
    /** å¼€å§‹ç¼–è¾‘è”ç³»äººç›®æ ‡ */
    object StartEditContactGoal : ContactDetailUiEvent()
    
    /** ç¡®è®¤ç¼–è¾‘è”ç³»äººç›®æ ‡ */
    data class ConfirmEditContactGoal(val newGoal: String) : ContactDetailUiEvent()
    
    /** å–æ¶ˆç¼–è¾‘è”ç³»äººç›®æ ‡ */
    object CancelEditContactGoal : ContactDetailUiEvent()
    
    // ==================== é”™è¯¯å¤„ç†äº‹ä»¶ ====================
    
    /** æ¸…é™¤ç¼–è¾‘é”™è¯¯ */
    object ClearEditError : ContactDetailUiEvent()
    
    /** æ¸…é™¤ç¼–è¾‘æˆåŠŸçŠ¶æ€ */
    object ClearEditSuccess : ContactDetailUiEvent()
}
``` ContactDetailUiEvent.DismissEditError -> {
                _editError.value = null
            }
            is ContactDetailUiEvent.DismissEditSuccess -> {
                _editSuccess.value = false
            }
            
            else -> { /* å…¶ä»–äº‹ä»¶ */ }
        }
    }
    
    // ==================== ç¼–è¾‘æ“ä½œå®ç° ====================
    
    private fun editFact(factId: String, newKey: String, newValue: String) {
        viewModelScope.launch {
            val contactId = _uiState.value.contactId ?: return@launch
            
            editFactUseCase(contactId, factId, newKey, newValue)
                .onSuccess { result ->
                    when (result) {
                        is EditResult.Success -> {
                            _editingFact.value = null
                            _editSuccess.value = true
                            refreshData()
                        }
                        is EditResult.ValidationError -> {
                            _editError.value = result.message
                        }
                        is EditResult.DatabaseError -> {
                            _editError.value = "ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•"
                        }
                        is EditResult.NotFound -> {
                            _editError.value = "äº‹å®å·²è¢«åˆ é™¤"
                            _editingFact.value = null
                            refreshData()
                        }
                        is EditResult.NoChanges -> {
                            _editingFact.value = null
                        }
                    }
                }
                .onFailure { e ->
                    _editError.value = "æ“ä½œå¤±è´¥ï¼š${e.message}"
                }
        }
    }
    
    private fun editConversation(logId: Long, newContent: String) {
        viewModelScope.launch {
            editConversationUseCase(logId, newContent)
                .onSuccess { result ->
                    when (result) {
                        is EditResult.Success -> {
                            _editingConversation.value = null
                            _editSuccess.value = true
                            refreshData()
                        }
                        is EditResult.ValidationError -> {
                            _editError.value = result.message
                        }
                        is EditResult.DatabaseError -> {
                            _editError.value = "ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•"
                        }
                        is EditResult.NotFound -> {
                            _editError.value = "å¯¹è¯å·²è¢«åˆ é™¤"
                            _editingConversation.value = null
                            refreshData()
                        }
                        is EditResult.NoChanges -> {
                            _editingConversation.value = null
                        }
                    }
                }
                .onFailure { e ->
                    _editError.value = "æ“ä½œå¤±è´¥ï¼š${e.message}"
                }
        }
    }
    
    private fun editSummary(summaryId: Long, newContent: String) {
        viewModelScope.launch {
            editSummaryUseCase(summaryId, newContent)
                .onSuccess { result ->
                    when (result) {
                        is EditResult.Success -> {
                            _editingSummary.value = null
                            _editSuccess.value = true
                            refreshData()
                        }
                        is EditResult.ValidationError -> {
                            _editError.value = result.message
                        }
                        is EditResult.DatabaseError -> {
                            _editError.value = "ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•"
                        }
                        is EditResult.NotFound -> {
                            _editError.value = "æ€»ç»“å·²è¢«åˆ é™¤"
                            _editingSummary.value = null
                            refreshData()
                        }
                        is EditResult.NoChanges -> {
                            _editingSummary.value = null
                        }
                    }
                }
                .onFailure { e ->
                    _editError.value = "æ“ä½œå¤±è´¥ï¼š${e.message}"
                }
        }
    }
    
    private fun editContactName(newName: String) {
        viewModelScope.launch {
            val contactId = _uiState.value.contactId ?: return@launch
            
            editContactInfoUseCase.editName(contactId, newName)
                .onSuccess { result ->
                    when (result) {
                        is EditResult.Success -> {
                            _editingContactName.value = false
                            _editSuccess.value = true
                            refreshData()
                        }
                        is EditResult.ValidationError -> {
                            _editError.value = result.message
                        }
                        else -> {
                            _editError.value = "ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•"
                        }
                    }
                }
                .onFailure { e ->
                    _editError.value = "æ“ä½œå¤±è´¥ï¼š${e.message}"
                }
        }
    }
    
    private fun editContactGoal(newGoal: String) {
        viewModelScope.launch {
            val contactId = _uiState.value.contactId ?: return@launch
            
            editContactInfoUseCase.editGoal(contactId, newGoal)
                .onSuccess { result ->
                    when (result) {
                        is EditResult.Success -> {
                            _editingContactGoal.value = false
                            _editSuccess.value = true
                            refreshData()
                        }
                        is EditResult.ValidationError -> {
                            _editError.value = result.message
                        }
                        else -> {
                            _editError.value = "ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•"
                        }
                    }
                }
                .onFailure { e ->
                    _editError.value = "æ“ä½œå¤±è´¥ï¼š${e.message}"
                }
        }
    }
    
    // ... åˆ é™¤æ“ä½œå®ç° ...
}
```

#### 4.5.2 ContactDetailUiEventæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/ContactDetailUiEvent.kt`

```kotlin
/**
 * è”ç³»äººè¯¦æƒ…UIäº‹ä»¶ï¼ˆæ‰©å±•ç¼–è¾‘äº‹ä»¶ï¼‰
 */
sealed class ContactDetailUiEvent {
    // ... å·²æœ‰äº‹ä»¶ ...
    
    // ==================== äº‹å®ç¼–è¾‘äº‹ä»¶ ====================
    data class StartEditFact(val fact: Fact) : ContactDetailUiEvent()
    data class ConfirmEditFact(
        val factId: String,
        val newKey: String,
        val newValue: String
    ) : ContactDetailUiEvent()
    object CancelEditFact : ContactDetailUiEvent()
    data class DeleteFact(val factId: String) : ContactDetailUiEvent()
    
    // ==================== å¯¹è¯ç¼–è¾‘äº‹ä»¶ ====================
    data class StartEditConversation(val conversation: ConversationLog) : ContactDetailUiEvent()
    data class ConfirmEditConversation(
        val logId: Long,
        val newContent: String
    ) : ContactDetailUiEvent()
    object CancelEditConversation : ContactDetailUiEvent()
    data class DeleteConversation(val logId: Long) : ContactDetailUiEvent()
    
    // ==================== æ€»ç»“ç¼–è¾‘äº‹ä»¶ ====================
    data class StartEditSummary(val summary: DailySummary) : ContactDetailUiEvent()
    data class ConfirmEditSummary(
        val summaryId: Long,
        val newContent: String
    ) : ContactDetailUiEvent()
    object CancelEditSummary : ContactDetailUiEvent()
    
    // ==================== è”ç³»äººä¿¡æ¯ç¼–è¾‘äº‹ä»¶ ====================
    object StartEditContactName : ContactDetailUiEvent()
    data class ConfirmEditContactName(val newName: String) : ContactDetailUiEvent()
    object CancelEditContactName : ContactDetailUiEvent()
    
    object StartEditContactGoal : ContactDetailUiEvent()
    data class ConfirmEditContactGoal(val newGoal: String) : ContactDetailUiEvent()
    object CancelEditContactGoal : ContactDetailUiEvent()
    
    // ==================== ç¼–è¾‘åé¦ˆäº‹ä»¶ ====================
    object DismissEditError : ContactDetailUiEvent()
    object DismissEditSuccess : ContactDetailUiEvent()
}
```



---

## 5. ä¾èµ–æ³¨å…¥è®¾è®¡

### 5.1 EditModuleï¼ˆç¼–è¾‘æ¨¡å— - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`di/EditModule.kt`

```kotlin
/**
 * ç¼–è¾‘åŠŸèƒ½ä¾èµ–æ³¨å…¥æ¨¡å—
 */
@Module
@InstallIn(SingletonComponent::class)
object EditModule {
    
    /**
     * æä¾›å†…å®¹éªŒè¯æœåŠ¡
     */
    @Provides
    @Singleton
    fun provideContentValidator(): ContentValidator {
        return ContentValidator()
    }
    
    /**
     * æä¾›äº‹å®ç¼–è¾‘ç”¨ä¾‹
     */
    @Provides
    @Singleton
    fun provideEditFactUseCase(
        contactRepository: ContactRepository,
        contentValidator: ContentValidator,
        @IoDispatcher ioDispatcher: CoroutineDispatcher
    ): EditFactUseCase {
        return EditFactUseCase(contactRepository, contentValidator, ioDispatcher)
    }
    
    /**
     * æä¾›å¯¹è¯ç¼–è¾‘ç”¨ä¾‹
     */
    @Provides
    @Singleton
    fun provideEditConversationUseCase(
        conversationRepository: ConversationRepository,
        contentValidator: ContentValidator,
        @IoDispatcher ioDispatcher: CoroutineDispatcher
    ): EditConversationUseCase {
        return EditConversationUseCase(conversationRepository, contentValidator, ioDispatcher)
    }
    
    /**
     * æä¾›æ€»ç»“ç¼–è¾‘ç”¨ä¾‹
     */
    @Provides
    @Singleton
    fun provideEditSummaryUseCase(
        dailySummaryRepository: DailySummaryRepository,
        contentValidator: ContentValidator,
        @IoDispatcher ioDispatcher: CoroutineDispatcher
    ): EditSummaryUseCase {
        return EditSummaryUseCase(dailySummaryRepository, contentValidator, ioDispatcher)
    }

    /**
     * æä¾›è”ç³»äººä¿¡æ¯ç¼–è¾‘ç”¨ä¾‹
     */
    @Provides
    @Singleton
    fun provideEditContactInfoUseCase(
        contactRepository: ContactRepository,
        contentValidator: ContentValidator,
        @IoDispatcher ioDispatcher: CoroutineDispatcher
    ): EditContactInfoUseCase {
        return EditContactInfoUseCase(contactRepository, contentValidator, ioDispatcher)
    }
}
```

### 5.2 ä¾èµ–å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EditModule                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                    â”‚                    â”‚
         â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ContentValidator â”‚ â”‚ IoDispatcher    â”‚ â”‚  Repositories   â”‚
â”‚   (Singleton)   â”‚ â”‚ (from Dispatch  â”‚ â”‚ (from existing  â”‚
â”‚                 â”‚ â”‚    Module)      â”‚ â”‚    modules)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                    â”‚                    â”‚
         â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚EditFactUseCase  â”‚ â”‚EditConversation â”‚ â”‚EditSummary      â”‚
â”‚                 â”‚ â”‚UseCase          â”‚ â”‚UseCase          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ContactDetailTabViewModelâ”‚
                 â”‚      (HiltViewModel)    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 6. æµ‹è¯•ç­–ç•¥

### 6.1 å•å…ƒæµ‹è¯•

#### 6.1.1 ContentValidatoræµ‹è¯•

**æ–‡ä»¶ä½ç½®**ï¼š`test/domain/util/ContentValidatorTest.kt`

```kotlin
@Test
fun `validateFactKey - ç©ºå­—ç¬¦ä¸²è¿”å›é”™è¯¯`() {
    val result = validator.validateFactKey("")
    assertThat(result).isInstanceOf(ValidationResult.Error::class.java)
    assertThat((result as ValidationResult.Error).message).isEqualTo("äº‹å®ç±»å‹ä¸èƒ½ä¸ºç©º")
}

@Test
fun `validateFactKey - è¶…è¿‡50å­—è¿”å›é”™è¯¯`() {
    val longKey = "a".repeat(51)
    val result = validator.validateFactKey(longKey)
    assertThat(result).isInstanceOf(ValidationResult.Error::class.java)
}

@Test
fun `validateFactKey - æ­£å¸¸è¾“å…¥è¿”å›Valid`() {
    val result = validator.validateFactKey("æ€§æ ¼ç‰¹ç‚¹")
    assertThat(result).isEqualTo(ValidationResult.Valid)
}
```

#### 6.1.2 EditFactUseCaseæµ‹è¯•

**æ–‡ä»¶ä½ç½®**ï¼š`test/domain/usecase/EditFactUseCaseTest.kt`

```kotlin
@Test
fun `invoke - éªŒè¯å¤±è´¥è¿”å›ValidationError`() = runTest {
    val result = useCase("contactId", "factId", "", "value")
    assertThat(result.getOrNull()).isInstanceOf(EditResult.ValidationError::class.java)
}

@Test
fun `invoke - è”ç³»äººä¸å­˜åœ¨è¿”å›NotFound`() = runTest {
    coEvery { contactRepository.getProfile(any()) } returns Result.success(null)
    val result = useCase("contactId", "factId", "key", "value")
    assertThat(result.getOrNull()).isEqualTo(EditResult.NotFound)
}

@Test
fun `invoke - äº‹å®ä¸å­˜åœ¨è¿”å›NotFound`() = runTest {
    val profile = ContactProfile(id = "1", name = "Test", targetGoal = "Goal", facts = emptyList())
    coEvery { contactRepository.getProfile(any()) } returns Result.success(profile)
    val result = useCase("1", "nonexistent", "key", "value")
    assertThat(result.getOrNull()).isEqualTo(EditResult.NotFound)
}

@Test
fun `invoke - å†…å®¹æ— å˜åŒ–è¿”å›NoChanges`() = runTest {
    val fact = Fact(id = "f1", key = "key", value = "value", timestamp = 1000L, source = FactSource.MANUAL)
    val profile = ContactProfile(id = "1", name = "Test", targetGoal = "Goal", facts = listOf(fact))
    coEvery { contactRepository.getProfile(any()) } returns Result.success(profile)
    val result = useCase("1", "f1", "key", "value")
    assertThat(result.getOrNull()).isEqualTo(EditResult.NoChanges)
}

@Test
fun `invoke - ç¼–è¾‘æˆåŠŸè¿”å›Success`() = runTest {
    val fact = Fact(id = "f1", key = "key", value = "value", timestamp = 1000L, source = FactSource.MANUAL)
    val profile = ContactProfile(id = "1", name = "Test", targetGoal = "Goal", facts = listOf(fact))
    coEvery { contactRepository.getProfile(any()) } returns Result.success(profile)
    coEvery { contactRepository.updateProfile(any()) } returns Result.success(Unit)
    
    val result = useCase("1", "f1", "newKey", "newValue")
    assertThat(result.getOrNull()).isEqualTo(EditResult.Success)
}
```


#### 6.1.3 Factæ¨¡å‹æµ‹è¯•

**æ–‡ä»¶ä½ç½®**ï¼š`test/domain/model/FactEditTest.kt`

```kotlin
@Test
fun `copyWithEdit - é¦–æ¬¡ç¼–è¾‘ä¿å­˜åŸå§‹å€¼`() {
    val fact = Fact(id = "1", key = "key", value = "value", timestamp = 1000L, source = FactSource.MANUAL)
    val edited = fact.copyWithEdit("newKey", "newValue")
    
    assertThat(edited.key).isEqualTo("newKey")
    assertThat(edited.value).isEqualTo("newValue")
    assertThat(edited.isUserModified).isTrue()
    assertThat(edited.originalKey).isEqualTo("key")
    assertThat(edited.originalValue).isEqualTo("value")
}

@Test
fun `copyWithEdit - å†æ¬¡ç¼–è¾‘ä¿ç•™é¦–æ¬¡åŸå§‹å€¼`() {
    val fact = Fact(
        id = "1", key = "key", value = "value", timestamp = 1000L, source = FactSource.MANUAL,
        isUserModified = true, originalKey = "originalKey", originalValue = "originalValue"
    )
    val edited = fact.copyWithEdit("newKey2", "newValue2")
    
    assertThat(edited.originalKey).isEqualTo("originalKey")
    assertThat(edited.originalValue).isEqualTo("originalValue")
}

@Test
fun `hasChanges - å†…å®¹ç›¸åŒè¿”å›false`() {
    val fact = Fact(id = "1", key = "key", value = "value", timestamp = 1000L, source = FactSource.MANUAL)
    assertThat(fact.hasChanges("key", "value")).isFalse()
}

@Test
fun `hasChanges - å†…å®¹ä¸åŒè¿”å›true`() {
    val fact = Fact(id = "1", key = "key", value = "value", timestamp = 1000L, source = FactSource.MANUAL)
    assertThat(fact.hasChanges("newKey", "value")).isTrue()
    assertThat(fact.hasChanges("key", "newValue")).isTrue()
}
```

### 6.2 é›†æˆæµ‹è¯•

#### 6.2.1 æ•°æ®åº“è¿ç§»æµ‹è¯•

**æ–‡ä»¶ä½ç½®**ï¼š`androidTest/data/local/DatabaseMigration9To10Test.kt`

```kotlin
@RunWith(AndroidJUnit4::class)
class DatabaseMigration9To10Test {
    
    @get:Rule
    val helper = MigrationTestHelper(
        InstrumentationRegistry.getInstrumentation(),
        AppDatabase::class.java
    )
    
    @Test
    fun migrate9To10_contactProfiles() {
        // åˆ›å»ºv9æ•°æ®åº“
        helper.createDatabase(TEST_DB, 9).apply {
            execSQL("""
                INSERT INTO contact_profiles (id, name, target_goal, context_depth, facts_json, relationship_score)
                VALUES ('1', 'Test', 'Goal', 10, '[]', 50)
            """)
            close()
        }
        
        // æ‰§è¡Œè¿ç§»
        helper.runMigrationsAndValidate(TEST_DB, 10, true, MIGRATION_9_10)
        
        // éªŒè¯æ–°å­—æ®µå­˜åœ¨ä¸”æœ‰é»˜è®¤å€¼
        val db = helper.openDatabase(TEST_DB, 10)
        db.query("SELECT * FROM contact_profiles WHERE id = '1'").use { cursor ->
            cursor.moveToFirst()
            assertThat(cursor.getInt(cursor.getColumnIndex("is_name_user_modified"))).isEqualTo(0)
            assertThat(cursor.getInt(cursor.getColumnIndex("is_goal_user_modified"))).isEqualTo(0)
        }
    }
    
    @Test
    fun migrate9To10_conversationLogs() {
        helper.createDatabase(TEST_DB, 9).apply {
            execSQL("""
                INSERT INTO conversation_logs (contact_id, user_input, timestamp, is_summarized)
                VALUES ('1', 'Hello', 1000, 0)
            """)
            close()
        }
        
        helper.runMigrationsAndValidate(TEST_DB, 10, true, MIGRATION_9_10)
        
        val db = helper.openDatabase(TEST_DB, 10)
        db.query("SELECT * FROM conversation_logs").use { cursor ->
            cursor.moveToFirst()
            assertThat(cursor.getInt(cursor.getColumnIndex("is_user_modified"))).isEqualTo(0)
        }
    }
}
```


### 6.3 UIæµ‹è¯•

#### 6.3.1 EditFactDialogæµ‹è¯•

**æ–‡ä»¶ä½ç½®**ï¼š`androidTest/presentation/ui/component/dialog/EditFactDialogTest.kt`

```kotlin
@Test
fun editFactDialog_displaysFactInfo() {
    val fact = Fact(id = "1", key = "æ€§æ ¼", value = "å¼€æœ—", timestamp = 1000L, source = FactSource.MANUAL)
    
    composeTestRule.setContent {
        EditFactDialog(fact = fact, onDismiss = {}, onConfirm = { _, _ -> }, onDelete = {})
    }
    
    composeTestRule.onNodeWithText("æ€§æ ¼").assertIsDisplayed()
    composeTestRule.onNodeWithText("å¼€æœ—").assertIsDisplayed()
}

@Test
fun editFactDialog_showsErrorForEmptyKey() {
    val fact = Fact(id = "1", key = "æ€§æ ¼", value = "å¼€æœ—", timestamp = 1000L, source = FactSource.MANUAL)
    
    composeTestRule.setContent {
        EditFactDialog(fact = fact, onDismiss = {}, onConfirm = { _, _ -> }, onDelete = {})
    }
    
    // æ¸…ç©ºé”®è¾“å…¥
    composeTestRule.onNodeWithText("æ€§æ ¼").performTextClearance()
    composeTestRule.onNodeWithText("äº‹å®ç±»å‹ä¸èƒ½ä¸ºç©º").assertIsDisplayed()
}

@Test
fun editFactDialog_confirmButtonDisabledWhenInvalid() {
    val fact = Fact(id = "1", key = "æ€§æ ¼", value = "å¼€æœ—", timestamp = 1000L, source = FactSource.MANUAL)
    
    composeTestRule.setContent {
        EditFactDialog(fact = fact, onDismiss = {}, onConfirm = { _, _ -> }, onDelete = {})
    }
    
    composeTestRule.onNodeWithText("æ€§æ ¼").performTextClearance()
    composeTestRule.onNodeWithText("ä¿å­˜").assertIsNotEnabled()
}
```

### 6.4 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | æµ‹è¯•ç±»å‹ |
|------|-----------|---------|
| ContentValidator | 100% | å•å…ƒæµ‹è¯• |
| EditFactUseCase | 95% | å•å…ƒæµ‹è¯• |
| EditConversationUseCase | 95% | å•å…ƒæµ‹è¯• |
| EditSummaryUseCase | 95% | å•å…ƒæµ‹è¯• |
| EditContactInfoUseCase | 95% | å•å…ƒæµ‹è¯• |
| Fact.copyWithEdit | 100% | å•å…ƒæµ‹è¯• |
| Migration 9â†’10 | 100% | é›†æˆæµ‹è¯• |
| EditFactDialog | 80% | UIæµ‹è¯• |
| EditSummaryDialog | 80% | UIæµ‹è¯• |


---

## 7. æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### 7.1 æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| ç¼–è¾‘å¯¹è¯æ¡†æ‰“å¼€æ—¶é—´ | < 100ms | ä»ç‚¹å‡»åˆ°å¯¹è¯æ¡†æ˜¾ç¤º |
| ä¿å­˜æ“ä½œå“åº”æ—¶é—´ | < 200ms | ä»ç‚¹å‡»ä¿å­˜åˆ°UIæ›´æ–° |
| å†…å­˜å¢é‡ | < 5MB | ç¼–è¾‘åŠŸèƒ½å¼•å…¥çš„é¢å¤–å†…å­˜ |
| æ•°æ®åº“æ“ä½œæ—¶é—´ | < 50ms | å•æ¬¡æ›´æ–°æ“ä½œ |

### 7.2 ä¼˜åŒ–ç­–ç•¥

#### 7.2.1 æ•°æ®åº“ä¼˜åŒ–

```kotlin
// 1. ä½¿ç”¨éƒ¨åˆ†æ›´æ–°è€Œéå…¨é‡æ›´æ–°
@Query("""
    UPDATE contact_profiles SET 
        name = :newName,
        is_name_user_modified = 1,
        name_last_modified_time = :modifiedTime
    WHERE id = :contactId
""")
suspend fun updateName(contactId: String, newName: String, modifiedTime: Long): Int

// 2. é¿å…ä¸å¿…è¦çš„æ•°æ®åŠ è½½
// ç¼–è¾‘å‰åªåŠ è½½å¿…è¦å­—æ®µï¼Œè€Œéæ•´ä¸ªå®ä½“
```

#### 7.2.2 UIä¼˜åŒ–

```kotlin
// 1. ä½¿ç”¨rememberç¼“å­˜çŠ¶æ€
var factKey by remember { mutableStateOf(fact.key) }

// 2. å»¶è¿ŸéªŒè¯ï¼Œé¿å…æ¯æ¬¡è¾“å…¥éƒ½è§¦å‘
LaunchedEffect(factKey) {
    delay(300) // é˜²æŠ–
    keyError = validateKey(factKey)
}

// 3. ä½¿ç”¨derivedStateOfä¼˜åŒ–é‡ç»„
val isValid by remember {
    derivedStateOf { factKey.isNotBlank() && factValue.isNotBlank() }
}
```

#### 7.2.3 å†…å­˜ä¼˜åŒ–

```kotlin
// 1. åŸå§‹å€¼åªåœ¨é¦–æ¬¡ç¼–è¾‘æ—¶ä¿å­˜
originalKey = if (originalKey == null) key else originalKey

// 2. ç¼–è¾‘å¯¹è¯æ¡†å…³é—­æ—¶æ¸…ç†çŠ¶æ€
DisposableEffect(Unit) {
    onDispose {
        // æ¸…ç†ä¸´æ—¶çŠ¶æ€
    }
}
```

### 7.3 æ€§èƒ½ç›‘æ§

```kotlin
/**
 * ç¼–è¾‘æ“ä½œæ€§èƒ½ç›‘æ§
 */
object EditPerformanceMonitor {
    fun trackEditOperation(
        operationType: String,
        durationMs: Long,
        success: Boolean
    ) {
        DebugLogger.d("EditPerformance", 
            "operation=$operationType, duration=${durationMs}ms, success=$success")
        
        if (durationMs > 200) {
            DebugLogger.w("EditPerformance", "æ“ä½œè€—æ—¶è¿‡é•¿: $operationType")
        }
    }
}
```


---

## 8. é”™è¯¯å¤„ç†è®¾è®¡

### 8.1 é”™è¯¯ç±»å‹å®šä¹‰

```kotlin
/**
 * ç¼–è¾‘é”™è¯¯ç±»å‹
 */
sealed class EditError {
    /** éªŒè¯é”™è¯¯ */
    data class Validation(val field: String, val message: String) : EditError()
    
    /** æ•°æ®åº“é”™è¯¯ */
    data class Database(val operation: String, val cause: Exception) : EditError()
    
    /** æ•°æ®ä¸å­˜åœ¨ */
    data class NotFound(val entityType: String, val entityId: String) : EditError()
    
    /** å¹¶å‘å†²çª */
    data class Conflict(val message: String) : EditError()
    
    /** ç½‘ç»œé”™è¯¯ï¼ˆå¦‚æœæ¶‰åŠåŒæ­¥ï¼‰ */
    data class Network(val cause: Exception) : EditError()
}
```

### 8.2 é”™è¯¯å¤„ç†ç­–ç•¥

| é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·æç¤º |
|---------|---------|---------|
| éªŒè¯é”™è¯¯ | æ˜¾ç¤ºå†…è”é”™è¯¯ï¼Œç¦ç”¨ä¿å­˜æŒ‰é’® | å…·ä½“çš„éªŒè¯é”™è¯¯ä¿¡æ¯ |
| æ•°æ®åº“é”™è¯¯ | è®°å½•æ—¥å¿—ï¼Œæ˜¾ç¤ºToast | "ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•" |
| æ•°æ®ä¸å­˜åœ¨ | å…³é—­å¯¹è¯æ¡†ï¼Œåˆ·æ–°åˆ—è¡¨ | "å†…å®¹å·²è¢«åˆ é™¤" |
| å¹¶å‘å†²çª | æç¤ºç”¨æˆ·åˆ·æ–° | "å†…å®¹å·²è¢«ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•" |

### 8.3 é”™è¯¯æ¢å¤æœºåˆ¶

```kotlin
/**
 * ç¼–è¾‘æ“ä½œé‡è¯•æœºåˆ¶
 */
suspend fun <T> retryEditOperation(
    maxRetries: Int = 3,
    delayMs: Long = 100,
    operation: suspend () -> Result<T>
): Result<T> {
    var lastException: Exception? = null
    
    repeat(maxRetries) { attempt ->
        operation().onSuccess { return Result.success(it) }
            .onFailure { e ->
                lastException = e as? Exception
                if (attempt < maxRetries - 1) {
                    delay(delayMs * (attempt + 1))
                }
            }
    }
    
    return Result.failure(lastException ?: Exception("æ“ä½œå¤±è´¥"))
}
```

### 8.4 ç”¨æˆ·åé¦ˆè®¾è®¡

```kotlin
/**
 * ç¼–è¾‘ç»“æœåé¦ˆ
 */
@Composable
fun EditResultFeedback(
    editSuccess: Boolean,
    editError: String?,
    onDismissSuccess: () -> Unit,
    onDismissError: () -> Unit
) {
    // æˆåŠŸæç¤º
    if (editSuccess) {
        LaunchedEffect(Unit) {
            delay(1500)
            onDismissSuccess()
        }
        Snackbar(
            modifier = Modifier.padding(16.dp)
        ) {
            Text("ä¿å­˜æˆåŠŸ")
        }
    }
    
    // é”™è¯¯æç¤º
    editError?.let { error ->
        Snackbar(
            modifier = Modifier.padding(16.dp),
            action = {
                TextButton(onClick = onDismissError) {
                    Text("çŸ¥é“äº†")
                }
            }
        ) {
            Text(error)
        }
    }
}
```


---

## 9. éªŒæ”¶æ ‡å‡†

### 9.1 åŠŸèƒ½éªŒæ”¶æ ‡å‡†

#### 9.1.1 äº‹å®ç¼–è¾‘

| ç¼–å· | éªŒæ”¶é¡¹ | éªŒæ”¶æ ‡å‡† | ä¼˜å…ˆçº§ |
|------|--------|---------|--------|
| F-001 | ç‚¹å‡»äº‹å®å¡ç‰‡ | å¼¹å‡ºç¼–è¾‘å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºå½“å‰é”®å€¼ | P0 |
| F-002 | ä¿®æ”¹äº‹å®ç±»å‹ | æ”¯æŒä¸‹æ‹‰é€‰æ‹©é¢„è®¾ç±»å‹æˆ–è‡ªå®šä¹‰è¾“å…¥ | P0 |
| F-003 | ä¿®æ”¹äº‹å®å†…å®¹ | æ”¯æŒå¤šè¡Œè¾“å…¥ï¼Œæœ€å¤š500å­— | P0 |
| F-004 | ä¿å­˜ç¼–è¾‘ | éªŒè¯é€šè¿‡åä¿å­˜ï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º | P0 |
| F-005 | åˆ é™¤äº‹å® | äºŒæ¬¡ç¡®è®¤ååˆ é™¤ï¼Œåˆ·æ–°åˆ—è¡¨ | P1 |
| F-006 | å·²ç¼–è¾‘æ ‡è¯† | ç¼–è¾‘åæ˜¾ç¤º"å·²ç¼–è¾‘"å¾½ç«  | P1 |
| F-007 | æŸ¥çœ‹åŸå§‹å†…å®¹ | å¯å±•å¼€æŸ¥çœ‹ç¼–è¾‘å‰çš„åŸå§‹å†…å®¹ | P2 |

#### 9.1.2 å¯¹è¯ç¼–è¾‘

| ç¼–å· | éªŒæ”¶é¡¹ | éªŒæ”¶æ ‡å‡† | ä¼˜å…ˆçº§ |
|------|--------|---------|--------|
| C-001 | ç‚¹å‡»å¯¹è¯æ°”æ³¡ | å¼¹å‡ºç¼–è¾‘å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºå½“å‰å†…å®¹ | P0 |
| C-002 | ä¿®æ”¹å¯¹è¯å†…å®¹ | æ”¯æŒå¤šè¡Œè¾“å…¥ï¼Œæœ€å¤š1000å­— | P0 |
| C-003 | èº«ä»½å‰ç¼€ä¿ç•™ | ç¼–è¾‘æ—¶ä¿ç•™"æˆ‘ï¼š"æˆ–"å¯¹æ–¹ï¼š"å‰ç¼€ | P0 |
| C-004 | ä¿å­˜ç¼–è¾‘ | éªŒè¯é€šè¿‡åä¿å­˜ï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º | P0 |
| C-005 | åˆ é™¤å¯¹è¯ | äºŒæ¬¡ç¡®è®¤ååˆ é™¤ï¼Œåˆ·æ–°åˆ—è¡¨ | P1 |

#### 9.1.3 æ€»ç»“ç¼–è¾‘

| ç¼–å· | éªŒæ”¶é¡¹ | éªŒæ”¶æ ‡å‡† | ä¼˜å…ˆçº§ |
|------|--------|---------|--------|
| S-001 | ç‚¹å‡»æ€»ç»“å¡ç‰‡ | å¼¹å‡ºç¼–è¾‘å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºå½“å‰å†…å®¹ | P0 |
| S-002 | ä¿®æ”¹æ€»ç»“å†…å®¹ | æ”¯æŒå¤šè¡Œè¾“å…¥ï¼Œæœ€å¤š2000å­— | P0 |
| S-003 | ä¿å­˜ç¼–è¾‘ | éªŒè¯é€šè¿‡åä¿å­˜ï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º | P0 |
| S-004 | æ¥æºæ ‡è¯† | æ˜¾ç¤º"AIç”Ÿæˆ"æˆ–"æ‰‹åŠ¨ç¼–è¾‘"æ ‡è¯† | P1 |

#### 9.1.4 è”ç³»äººä¿¡æ¯ç¼–è¾‘

| ç¼–å· | éªŒæ”¶é¡¹ | éªŒæ”¶æ ‡å‡† | ä¼˜å…ˆçº§ |
|------|--------|---------|--------|
| P-001 | ç‚¹å‡»å§“å | å¼¹å‡ºç¼–è¾‘å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºå½“å‰å§“å | P0 |
| P-002 | ä¿®æ”¹å§“å | å•è¡Œè¾“å…¥ï¼Œæœ€å¤š50å­— | P0 |
| P-003 | ç‚¹å‡»ç›®æ ‡ | å¼¹å‡ºç¼–è¾‘å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºå½“å‰ç›®æ ‡ | P0 |
| P-004 | ä¿®æ”¹ç›®æ ‡ | å¤šè¡Œè¾“å…¥ï¼Œæœ€å¤š200å­— | P0 |

### 9.2 éåŠŸèƒ½éªŒæ”¶æ ‡å‡†

| ç¼–å· | éªŒæ”¶é¡¹ | éªŒæ”¶æ ‡å‡† | ä¼˜å…ˆçº§ |
|------|--------|---------|--------|
| NF-001 | å“åº”æ—¶é—´ | ç¼–è¾‘å¯¹è¯æ¡†æ‰“å¼€ < 100ms | P0 |
| NF-002 | ä¿å­˜æ—¶é—´ | ä¿å­˜æ“ä½œ < 200ms | P0 |
| NF-003 | æ•°æ®å®Œæ•´æ€§ | ç¼–è¾‘åæ•°æ®æ­£ç¡®ä¿å­˜ï¼Œæ— ä¸¢å¤± | P0 |
| NF-004 | å‘åå…¼å®¹ | æ—§æ•°æ®æ­£å¸¸æ˜¾ç¤ºï¼Œæ— ç¼–è¾‘æ ‡è¯† | P0 |
| NF-005 | é”™è¯¯å¤„ç† | æ‰€æœ‰é”™è¯¯æœ‰å‹å¥½æç¤º | P1 |


---

## 10. å¼€å‘è®¡åˆ’

### 10.1 å¼€å‘é˜¶æ®µ

| é˜¶æ®µ | å†…å®¹ | é¢„ä¼°å·¥æ—¶ | ä¾èµ– |
|------|------|---------|------|
| é˜¶æ®µ1 | æ•°æ®æ¨¡å‹æ‰©å±• | 4h | æ—  |
| é˜¶æ®µ2 | æ•°æ®åº“è¿ç§» | 3h | é˜¶æ®µ1 |
| é˜¶æ®µ3 | UseCaseå®ç° | 6h | é˜¶æ®µ2 |
| é˜¶æ®µ4 | UIç»„ä»¶å¼€å‘ | 8h | é˜¶æ®µ3 |
| é˜¶æ®µ5 | ViewModelé›†æˆ | 4h | é˜¶æ®µ4 |
| é˜¶æ®µ6 | å•å…ƒæµ‹è¯• | 6h | é˜¶æ®µ3 |
| é˜¶æ®µ7 | é›†æˆæµ‹è¯• | 4h | é˜¶æ®µ5 |
| é˜¶æ®µ8 | UIæµ‹è¯• | 3h | é˜¶æ®µ5 |
| **æ€»è®¡** | | **38h** | |

### 10.2 ä»»åŠ¡åˆ†è§£

#### é˜¶æ®µ1ï¼šæ•°æ®æ¨¡å‹æ‰©å±•ï¼ˆ4hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼° | çŠ¶æ€ |
|--------|---------|------|------|
| T-1.1 | æ‰©å±•Factæ¨¡å‹æ·»åŠ ç¼–è¾‘å­—æ®µ | 1h | å¾…å¼€å§‹ |
| T-1.2 | æ‰©å±•ConversationLogæ¨¡å‹ | 1h | å¾…å¼€å§‹ |
| T-1.3 | æ‰©å±•DailySummaryæ¨¡å‹ | 1h | å¾…å¼€å§‹ |
| T-1.4 | æ‰©å±•ContactProfileæ¨¡å‹ | 1h | å¾…å¼€å§‹ |

#### é˜¶æ®µ2ï¼šæ•°æ®åº“è¿ç§»ï¼ˆ3hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼° | çŠ¶æ€ |
|--------|---------|------|------|
| T-2.1 | æ‰©å±•Entityç±»æ·»åŠ æ–°å­—æ®µ | 1h | å¾…å¼€å§‹ |
| T-2.2 | ç¼–å†™Migration 9â†’10è„šæœ¬ | 1h | å¾…å¼€å§‹ |
| T-2.3 | æ‰©å±•DAOæ·»åŠ æ›´æ–°æ–¹æ³• | 1h | å¾…å¼€å§‹ |

#### é˜¶æ®µ3ï¼šUseCaseå®ç°ï¼ˆ6hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼° | çŠ¶æ€ |
|--------|---------|------|------|
| T-3.1 | å®ç°ContentValidator | 1h | å¾…å¼€å§‹ |
| T-3.2 | å®ç°EditFactUseCase | 1.5h | å¾…å¼€å§‹ |
| T-3.3 | å®ç°EditConversationUseCase | 1.5h | å¾…å¼€å§‹ |
| T-3.4 | å®ç°EditSummaryUseCase | 1h | å¾…å¼€å§‹ |
| T-3.5 | å®ç°EditContactInfoUseCase | 1h | å¾…å¼€å§‹ |

#### é˜¶æ®µ4ï¼šUIç»„ä»¶å¼€å‘ï¼ˆ8hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼° | çŠ¶æ€ |
|--------|---------|------|------|
| T-4.1 | å®ç°EditFactDialog | 2h | å¾…å¼€å§‹ |
| T-4.2 | æ‰©å±•EditConversationDialog | 1.5h | å¾…å¼€å§‹ |
| T-4.3 | å®ç°EditSummaryDialog | 2h | å¾…å¼€å§‹ |
| T-4.4 | å®ç°EditedBadge | 0.5h | å¾…å¼€å§‹ |
| T-4.5 | å®ç°DeleteConfirmDialog | 0.5h | å¾…å¼€å§‹ |
| T-4.6 | å®ç°EditContactNameDialog | 0.75h | å¾…å¼€å§‹ |
| T-4.7 | å®ç°EditContactGoalDialog | 0.75h | å¾…å¼€å§‹ |

#### é˜¶æ®µ5ï¼šViewModelé›†æˆï¼ˆ4hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼° | çŠ¶æ€ |
|--------|---------|------|------|
| T-5.1 | æ‰©å±•ContactDetailUiEvent | 1h | å¾…å¼€å§‹ |
| T-5.2 | æ‰©å±•ContactDetailTabViewModel | 2h | å¾…å¼€å§‹ |
| T-5.3 | é…ç½®EditModuleä¾èµ–æ³¨å…¥ | 1h | å¾…å¼€å§‹ |

#### é˜¶æ®µ6ï¼šå•å…ƒæµ‹è¯•ï¼ˆ6hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼° | çŠ¶æ€ |
|--------|---------|------|------|
| T-6.1 | ContentValidatoræµ‹è¯• | 1h | å¾…å¼€å§‹ |
| T-6.2 | EditFactUseCaseæµ‹è¯• | 1.5h | å¾…å¼€å§‹ |
| T-6.3 | EditConversationUseCaseæµ‹è¯• | 1.5h | å¾…å¼€å§‹ |
| T-6.4 | EditSummaryUseCaseæµ‹è¯• | 1h | å¾…å¼€å§‹ |
| T-6.5 | æ¨¡å‹æ‰©å±•æ–¹æ³•æµ‹è¯• | 1h | å¾…å¼€å§‹ |

#### é˜¶æ®µ7ï¼šé›†æˆæµ‹è¯•ï¼ˆ4hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼° | çŠ¶æ€ |
|--------|---------|------|------|
| T-7.1 | æ•°æ®åº“è¿ç§»æµ‹è¯• | 2h | å¾…å¼€å§‹ |
| T-7.2 | Repositoryé›†æˆæµ‹è¯• | 2h | å¾…å¼€å§‹ |

#### é˜¶æ®µ8ï¼šUIæµ‹è¯•ï¼ˆ3hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼° | çŠ¶æ€ |
|--------|---------|------|------|
| T-8.1 | EditFactDialogæµ‹è¯• | 1h | å¾…å¼€å§‹ |
| T-8.2 | EditSummaryDialogæµ‹è¯• | 1h | å¾…å¼€å§‹ |
| T-8.3 | ç¼–è¾‘æµç¨‹ç«¯åˆ°ç«¯æµ‹è¯• | 1h | å¾…å¼€å§‹ |


---

## 11. é£é™©è¯„ä¼°

### 11.1 æŠ€æœ¯é£é™©

| é£é™©ID | é£é™©æè¿° | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|--------|---------|--------|------|---------|
| R-001 | æ•°æ®åº“è¿ç§»å¤±è´¥å¯¼è‡´æ•°æ®ä¸¢å¤± | ä½ | é«˜ | å®Œæ•´çš„è¿ç§»æµ‹è¯•ï¼Œä½¿ç”¨é»˜è®¤å€¼ |
| R-002 | ç¼–è¾‘æ“ä½œä¸å…¶ä»–æ“ä½œå¹¶å‘å†²çª | ä¸­ | ä¸­ | ä¹è§‚é”æœºåˆ¶ï¼Œå†²çªæ£€æµ‹ |
| R-003 | å¤§é‡ç¼–è¾‘æ“ä½œå½±å“æ€§èƒ½ | ä½ | ä¸­ | éƒ¨åˆ†æ›´æ–°ï¼Œå¼‚æ­¥å¤„ç† |
| R-004 | UIç»„ä»¶å¤æ‚åº¦å¢åŠ ç»´æŠ¤æˆæœ¬ | ä¸­ | ä½ | ç»„ä»¶å¤ç”¨ï¼Œç»Ÿä¸€è®¾è®¡ |

### 11.2 ä¸šåŠ¡é£é™©

| é£é™©ID | é£é™©æè¿° | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|--------|---------|--------|------|---------|
| R-005 | ç”¨æˆ·è¯¯åˆ é‡è¦æ•°æ® | ä¸­ | é«˜ | äºŒæ¬¡ç¡®è®¤ï¼Œä¿ç•™åŸå§‹å€¼ |
| R-006 | ç¼–è¾‘åæ•°æ®ä¸AIåˆ†æä¸ä¸€è‡´ | ä½ | ä¸­ | æ ‡è®°å·²ç¼–è¾‘ï¼Œæç¤ºç”¨æˆ· |

### 11.3 é£é™©åº”å¯¹è®¡åˆ’

#### R-001 æ•°æ®åº“è¿ç§»é£é™©åº”å¯¹

```kotlin
// 1. ä½¿ç”¨é»˜è®¤å€¼ç¡®ä¿å‘åå…¼å®¹
@ColumnInfo(name = "is_user_modified", defaultValue = "0")
val isUserModified: Boolean = false

// 2. è¿ç§»å‰å¤‡ä»½æ£€æŸ¥
fun checkMigrationSafety(): Boolean {
    // éªŒè¯è¿ç§»è„šæœ¬
    return true
}

// 3. è¿ç§»å¤±è´¥å›æ»šæœºåˆ¶
// Roomè‡ªåŠ¨å¤„ç†äº‹åŠ¡å›æ»š
```

#### R-005 è¯¯åˆ æ•°æ®é£é™©åº”å¯¹

```kotlin
// 1. äºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†
DeleteConfirmDialog(
    title = "ç¡®è®¤åˆ é™¤",
    message = "ç¡®å®šè¦åˆ é™¤è¿™æ¡äº‹å®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚",
    onConfirm = { /* æ‰§è¡Œåˆ é™¤ */ },
    onDismiss = { /* å–æ¶ˆ */ }
)

// 2. ä¿ç•™åŸå§‹å€¼ï¼ˆå¯é€‰çš„è½¯åˆ é™¤ï¼‰
// ç¼–è¾‘æ—¶ä¿ç•™originalValueï¼Œä¾¿äºè¿½æº¯
```


---

## 12. ç›¸å…³æ–‡æ¡£

### 12.1 éœ€æ±‚æ–‡æ¡£

| æ–‡æ¡£ç¼–å· | æ–‡æ¡£åç§° | è¯´æ˜ |
|---------|---------|------|
| PRD-00012 | äº‹å®æµå†…å®¹ç¼–è¾‘åŠŸèƒ½éœ€æ±‚ | äº§å“éœ€æ±‚æ–‡æ¡£ |
| FD-00012 | äº‹å®æµå†…å®¹ç¼–è¾‘åŠŸèƒ½è®¾è®¡ | åŠŸèƒ½è®¾è®¡æ–‡æ¡£ |

### 12.2 æŠ€æœ¯å‚è€ƒ

| æ–‡æ¡£ç¼–å· | æ–‡æ¡£åç§° | è¯´æ˜ |
|---------|---------|------|
| TDD-00003 | è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸæŠ€æœ¯è®¾è®¡ | Factã€ConversationLogæ¨¡å‹å®šä¹‰ |
| TDD-00004 | è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIæ¶æ„è®¾è®¡ | äº‹å®æµUIç»„ä»¶è®¾è®¡ |
| TDD-00008 | è¾“å…¥å†…å®¹èº«ä»½è¯†åˆ«æŠ€æœ¯è®¾è®¡ | IdentityPrefixHelperå¤ç”¨ |
| TDD-00011 | æ‰‹åŠ¨è§¦å‘AIæ€»ç»“åŠŸèƒ½æŠ€æœ¯è®¾è®¡ | DailySummaryæ¨¡å‹æ‰©å±•å‚è€ƒ |

### 12.3 ä»£ç å‚è€ƒ

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `domain/model/Fact.kt` | äº‹å®æ¨¡å‹ï¼ˆå¾…æ‰©å±•ï¼‰ |
| `domain/model/ConversationLog.kt` | å¯¹è¯è®°å½•æ¨¡å‹ï¼ˆå¾…æ‰©å±•ï¼‰ |
| `domain/model/DailySummary.kt` | æ¯æ—¥æ€»ç»“æ¨¡å‹ï¼ˆå¾…æ‰©å±•ï¼‰ |
| `domain/model/ContactProfile.kt` | è”ç³»äººç”»åƒæ¨¡å‹ï¼ˆå¾…æ‰©å±•ï¼‰ |
| `presentation/ui/component/dialog/EditConversationDialog.kt` | å·²æœ‰å¯¹è¯ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆå¾…æ‰©å±•ï¼‰ |
| `presentation/ui/component/relationship/FactItem.kt` | äº‹å®é¡¹ç»„ä»¶ï¼ˆå¾…é›†æˆç¼–è¾‘ï¼‰ |
| `domain/util/IdentityPrefixHelper.kt` | èº«ä»½å‰ç¼€å·¥å…·ç±»ï¼ˆå¤ç”¨ï¼‰ |

---

## 13. ä¿®è®¢å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-20 | Kiro | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆå…¨éƒ¨æŠ€æœ¯è®¾è®¡ |

---

## é™„å½•

### é™„å½•Aï¼šå­—æ®µå‘½åå¯¹ç…§è¡¨

| é¢†åŸŸæ¨¡å‹å­—æ®µ | Entityå­—æ®µ | æ•°æ®åº“åˆ—å | è¯´æ˜ |
|-------------|-----------|-----------|------|
| isUserModified | isUserModified | is_user_modified | æ˜¯å¦è¢«ç”¨æˆ·ä¿®æ”¹ |
| lastModifiedTime | lastModifiedTime | last_modified_time | æœ€åä¿®æ”¹æ—¶é—´ |
| originalKey | originalKey | original_key | åŸå§‹é”®ï¼ˆFactï¼‰ |
| originalValue | originalValue | original_value | åŸå§‹å€¼ï¼ˆFactï¼‰ |
| originalUserInput | originalUserInput | original_user_input | åŸå§‹ç”¨æˆ·è¾“å…¥ï¼ˆConversationLogï¼‰ |
| originalContent | originalContent | original_content | åŸå§‹å†…å®¹ï¼ˆDailySummaryï¼‰ |
| isNameUserModified | isNameUserModified | is_name_user_modified | å§“åæ˜¯å¦è¢«ä¿®æ”¹ï¼ˆContactProfileï¼‰ |
| isGoalUserModified | isGoalUserModified | is_goal_user_modified | ç›®æ ‡æ˜¯å¦è¢«ä¿®æ”¹ï¼ˆContactProfileï¼‰ |
| originalName | originalName | original_name | åŸå§‹å§“åï¼ˆContactProfileï¼‰ |
| originalGoal | originalGoal | original_goal | åŸå§‹ç›®æ ‡ï¼ˆContactProfileï¼‰ |

### é™„å½•Bï¼šéªŒè¯è§„åˆ™æ±‡æ€»

| å†…å®¹ç±»å‹ | å­—æ®µ | æœ€å¤§é•¿åº¦ | å¿…å¡« | å…¶ä»–è§„åˆ™ |
|---------|------|---------|------|---------|
| äº‹å® | key | 50 | æ˜¯ | ä¸èƒ½ä¸ºç©ºç™½ |
| äº‹å® | value | 500 | æ˜¯ | ä¸èƒ½ä¸ºç©ºç™½ |
| å¯¹è¯ | userInput | 1000 | æ˜¯ | ä¸èƒ½ä¸ºç©ºç™½ |
| æ€»ç»“ | content | 2000 | æ˜¯ | ä¸èƒ½ä¸ºç©ºç™½ |
| è”ç³»äºº | name | 50 | æ˜¯ | ä¸èƒ½ä¸ºç©ºç™½ |
| è”ç³»äºº | targetGoal | 200 | æ˜¯ | ä¸èƒ½ä¸ºç©ºç™½ |

---

**æ–‡æ¡£ç»“æŸ**
