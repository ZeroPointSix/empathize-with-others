# TDD-00014: è”ç³»äººç”»åƒç•Œé¢å‡çº§æŠ€æœ¯è®¾è®¡

---
**æ–‡æ¡£ç±»å‹**: TDD (Technical Design Document) - å¼€å‘è¿‡ç¨‹æ–‡æ¡£  
**å­˜æ”¾è§„èŒƒ**: ç¬¦åˆé¡¹ç›®å®ªæ³•ç¬¬IVæ¡ - æ–‡æ¡£è§„èŒƒ  
**ç‰ˆæœ¬æ§åˆ¶**: Gitç®¡ç†ï¼Œè§.commité’©å­  
---

## 1. æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç±»å‹ | TDD (Technical Design Document) |
| æ–‡æ¡£ç¼–å· | TDD-00014 |
| åŠŸèƒ½åç§° | è”ç³»äººç”»åƒç•Œé¢å‡çº§ |
| ç‰ˆæœ¬ | 1.2 |
| åˆ›å»ºæ—¥æœŸ | 2025-12-21 |
| æœ€åæ›´æ–° | 2025-12-21 |
| ä½œè€… | Kiro |
| å®¡æ ¸äºº | Claude |
| å®¡æ ¸çŠ¶æ€ | âœ… å·²ä¼˜åŒ–ï¼ˆæ ¹æ®DR-00017ï¼‰ |
| å…³è”æ–‡æ¡£ | PRD-00014, FD-00014, RESEARCH-00014, DR-00017 |

### 1.1 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-21 | Kiro | åˆå§‹ç‰ˆæœ¬ |
| 1.1 | 2025-12-21 | Kiro | æ ¹æ®DR-00017å®¡æŸ¥æŠ¥å‘Šä¼˜åŒ–ï¼šè¡¥å……ç³»ç»Ÿé›†æˆæ–¹æ¡ˆã€å¯¼èˆªé…ç½®ã€æ•°æ®è¿ç§»ç­–ç•¥ |
| 1.2 | 2025-12-21 | Claude | æ ¹æ®DR-00017è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šå®Œå–„æ¶æ„è¯´æ˜ã€æ€§èƒ½æŒ‡æ ‡ã€é”™è¯¯å¤„ç†ã€æµ‹è¯•ç”¨ä¾‹ç»†èŠ‚ |

### 1.2 å‚è€ƒæ ‡å‡†

| æ ‡å‡†æ–‡æ¡£ | ç‰ˆæœ¬ | è¯´æ˜ |
|---------|------|------|
| Clean Architecture | - | æ¶æ„æ¨¡å¼æ ‡å‡† |
| MVVM Pattern | - | UIæ¶æ„æ¨¡å¼ |
| Kotlin Coding Conventions | 2.0.21 | ä»£ç è§„èŒƒ |
| Material Design 3 | 1.3.1 | UIè®¾è®¡è§„èŒƒ |

### 1.3 æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

| å€ºåŠ¡ID | æè¿° | å½±å“ | ä¼˜å…ˆçº§ | è®¡åˆ’è§£å†³æ—¶é—´ |
|--------|------|------|--------|-------------|
| TD-014-01 | ç°æœ‰PersonaTabéœ€è¦é‡æ„ä¸ºPersonaTabV2 | ä¸­ | ğŸŸ¡ ä¸­ | æœ¬æ¬¡è¿­ä»£ |
| TD-014-02 | CategorySectionéœ€è¦æ›¿æ¢ä¸ºDynamicCategoryCard | ä¸­ | ğŸŸ¡ ä¸­ | æœ¬æ¬¡è¿­ä»£ |
| TD-014-03 | éœ€è¦æ–°å¢é¢œè‰²è°ƒè‰²æ¿æ”¯æŒåŠ¨æ€é…è‰² | ä½ | ğŸŸ¢ ä½ | æœ¬æ¬¡è¿­ä»£ |

### 1.4 ç›¸å…³æŠ€æœ¯æ–‡æ¡£

| æ–‡æ¡£ç¼–å· | æ–‡æ¡£åç§° | å…³è”è¯´æ˜ |
|---------|---------|---------|
| TDD-00004 | è”ç³»äººç”»åƒè®°å¿†ç³»ç»ŸUIæ¶æ„è®¾è®¡ | å¤ç”¨Factæ¨¡å‹å’ŒåŸºç¡€UIç»„ä»¶ |
| TDD-00012 | äº‹å®æµå†…å®¹ç¼–è¾‘åŠŸèƒ½æŠ€æœ¯è®¾è®¡ | å¤ç”¨EditFactDialogç»„ä»¶ |
| FD-00014 | è”ç³»äººç”»åƒç•Œé¢å‡çº§åŠŸèƒ½è®¾è®¡ | åŠŸèƒ½è®¾è®¡æ–‡æ¡£ |
| PRD-00014 | è”ç³»äººç”»åƒç•Œé¢å‡çº§éœ€æ±‚ | äº§å“éœ€æ±‚æ–‡æ¡£ |

### 1.5 æ–‡æ¡£ä¼˜åŒ–è¯´æ˜ï¼ˆæ ¹æ®DR-00017ï¼‰

æœ¬ç« èŠ‚è®°å½•æ ¹æ®DR-00017æ–‡æ¡£å®¡æŸ¥æŠ¥å‘Šè¿›è¡Œçš„ä¼˜åŒ–å†…å®¹ï¼š

#### å·²ä¿®å¤çš„å…³é”®é—®é¢˜
1. **INT-001 å¯¼èˆªç³»ç»Ÿé›†æˆ** âœ…
   - è¯¦ç»†è¯´æ˜PersonaTabV2ä½œä¸ºContactDetailTabScreenå­ç»„ä»¶çš„é›†æˆæ–¹å¼
   - æä¾›Feature Flagæ§åˆ¶æœºåˆ¶ï¼Œæ”¯æŒç°åº¦å‘å¸ƒ

2. **INT-002 ä¾èµ–æ³¨å…¥æ¨¡å—é›†æˆ** âœ…
   - æ–°å¢å®Œæ•´çš„PersonaModule.ktä»£ç 
   - è¯´æ˜ä¸ç°æœ‰Moduleçš„é›†æˆå…³ç³»

3. **INT-003 ViewModelé›†æˆ** âœ…
   - æ‰©å±•ç°æœ‰ContactDetailTabViewModelçš„è¯¦ç»†æ–¹æ¡ˆ
   - å®Œæ•´çš„äº‹ä»¶å¤„ç†å®ç°ä»£ç 

4. **INT-004 å­—ç¬¦ä¸²èµ„æºé›†æˆ** âœ…
   - è¡¥å……å®Œæ•´çš„ä¸­è‹±æ–‡å­—ç¬¦ä¸²èµ„æº
   - æ”¯æŒå›½é™…åŒ–

#### æ–°å¢çš„ä¼˜åŒ–å†…å®¹
1. **æ€§èƒ½ç›‘æ§æŒ‡æ ‡**ï¼šæ·»åŠ å…·ä½“çš„æ€§èƒ½é˜ˆå€¼å’Œç›‘æ§æ–¹æ¡ˆ
2. **é”™è¯¯å¤„ç†å¢å¼º**ï¼šå®Œå–„å¼‚å¸¸åœºæ™¯çš„å¤„ç†é€»è¾‘
3. **æµ‹è¯•ç”¨ä¾‹è¡¥å……**ï¼šå¢åŠ è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯åœºæ™¯çš„æµ‹è¯•
4. **ä»£ç ç¤ºä¾‹ä¼˜åŒ–**ï¼šæä¾›æ›´å®Œæ•´å’Œå¯ç›´æ¥ä½¿ç”¨çš„ä»£ç ç‰‡æ®µ

---

## 2. æ¶æ„æ¦‚è¿°

### 2.1 æ¶æ„ç›®æ ‡

è”ç³»äººç”»åƒç•Œé¢å‡çº§é‡‡ç”¨ Clean Architecture åˆ†å±‚æ¶æ„ï¼Œåœ¨ç°æœ‰PersonaTabåŸºç¡€ä¸Šè¿›è¡Œå‡çº§é‡æ„ã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
- å®ç°åŸºäºFact Keyçš„åŠ¨æ€åˆ†ç»„å±•ç¤º
- æä¾›æœç´¢ã€å¤šé€‰ã€æ‰¹é‡æ“ä½œç­‰é«˜æ•ˆç®¡ç†åŠŸèƒ½
- å¼•å…¥åŠ¨æ€é…è‰²ç³»ç»Ÿæå‡è§†è§‰ä½“éªŒ
- ä¿è¯ä¸ç°æœ‰ç³»ç»Ÿçš„å…¼å®¹æ€§

### 2.2 æŠ€æœ¯æ ˆ

| æŠ€æœ¯é¢†åŸŸ | æŠ€æœ¯é€‰æ‹© | ç‰ˆæœ¬ | ç”¨é€” |
|---------|----------|------|------|
| UIæ¡†æ¶ | Jetpack Compose | BOM 2024.12.01 | å£°æ˜å¼UI |
| ç»„ä»¶åº“ | Material 3 | 1.3.1 | Cardã€Chipã€Dialog |
| å¸ƒå±€ | FlowRow | Compose Foundation | æ ‡ç­¾æµå¼å¸ƒå±€ |
| åŠ¨ç”» | Compose Animation | BOM 2024.12.01 | æŠ˜å /å±•å¼€åŠ¨ç”» |
| å¼‚æ­¥å¤„ç† | Kotlin Coroutines | 1.9.0 | å¼‚æ­¥æ“ä½œ |
| ä¾èµ–æ³¨å…¥ | Hilt | 2.52 | ä¾èµ–ç®¡ç† |

### 2.3 è®¾è®¡åŸåˆ™

- **æ¸è¿›å¼å‡çº§**ï¼šä¿ç•™ç°æœ‰åŠŸèƒ½ï¼Œé€æ­¥æ›¿æ¢ç»„ä»¶
- **å¤ç”¨ä¼˜å…ˆ**ï¼šå¤ç”¨ç°æœ‰Factæ¨¡å‹å’ŒRepository
- **çŠ¶æ€ä¸å¯å˜**ï¼šä½¿ç”¨data classçš„copyæ–¹æ³•æ›´æ–°çŠ¶æ€
- **æ€§èƒ½ä¼˜å…ˆ**ï¼šä½¿ç”¨LazyColumnå’Œkeyä¼˜åŒ–åˆ—è¡¨æ€§èƒ½


---

## 3. æ•´ä½“æ¶æ„è®¾è®¡

### 3.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           ContactDetailTabViewModel (æ‰©å±•)            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚PersonaTabV2    â”‚ â”‚CategorySearchBar           â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  (ä¸»ç•Œé¢)      â”‚ â”‚ (æœç´¢æ )                   â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚DynamicCategory â”‚ â”‚SelectableTagChip           â”‚   â”‚  â”‚
â”‚  â”‚  â”‚Card(åˆ†ç±»å¡ç‰‡)  â”‚ â”‚ (å¯é€‰æ ‡ç­¾)                 â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚EditModeTopBar  â”‚ â”‚BatchActionBar              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ (ç¼–è¾‘æ¨¡å¼æ )   â”‚ â”‚ (æ‰¹é‡æ“ä½œæ )               â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚MoveCategoryDlg â”‚ â”‚BatchDeleteConfirmDialog    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ (ç§»åŠ¨åˆ†ç±»)     â”‚ â”‚ (æ‰¹é‡åˆ é™¤ç¡®è®¤)             â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚GroupFactsBy      â”‚ â”‚BatchDeleteFactsUseCase           â”‚ â”‚
â”‚  â”‚CategoryUseCase   â”‚ â”‚  (æ‰¹é‡åˆ é™¤)                      â”‚ â”‚
â”‚  â”‚  (åˆ†ç»„)          â”‚ â”‚                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚BatchMoveFacts    â”‚ â”‚FactSearchFilter                  â”‚ â”‚
â”‚  â”‚UseCase(æ‰¹é‡ç§»åŠ¨) â”‚ â”‚  (æœç´¢è¿‡æ»¤)                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚CategoryColor     â”‚ â”‚Fact (å¤ç”¨ç°æœ‰)                   â”‚ â”‚
â”‚  â”‚Assigner(é¢œè‰²)    â”‚ â”‚                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Data Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Contact           â”‚ â”‚ContactDao                        â”‚ â”‚
â”‚  â”‚  Repository      â”‚ â”‚  (å¤ç”¨ç°æœ‰)                      â”‚ â”‚
â”‚  â”‚  (å¤ç”¨ç°æœ‰)      â”‚ â”‚                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è”ç³»äººç”»åƒç•Œé¢æ•°æ®æµ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  åŠ è½½è”ç³»äººFacts
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚GroupFactsBy  â”‚ â† æŒ‰Keyåˆ†ç»„
  â”‚CategoryUseCaseâ”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚CategoryColor â”‚ â† åˆ†é…é¢œè‰²
  â”‚  Assigner    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚PersonaTabV2  â”‚ â† æ¸²æŸ“UI
  â”‚  (ä¸»ç•Œé¢)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ç”¨æˆ·æ“ä½œ
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    ç”¨æˆ·äº¤äº’åˆ†æ”¯                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
  â”‚  â”‚ æœç´¢        â”‚  â”‚ é•¿æŒ‰æ ‡ç­¾    â”‚  â”‚ æ‰¹é‡æ“ä½œ    â”‚      â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
  â”‚        â”‚                â”‚                â”‚              â”‚
  â”‚        â–¼                â–¼                â–¼              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
  â”‚  â”‚FactSearch   â”‚  â”‚EditModeStateâ”‚  â”‚BatchDelete/ â”‚      â”‚
  â”‚  â”‚Filter       â”‚  â”‚  æ›´æ–°       â”‚  â”‚MoveUseCase  â”‚      â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ åˆ·æ–°UIæ˜¾ç¤º   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ¨¡å—åˆ’åˆ†

```
domain/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ Fact.kt                        # å¤ç”¨ç°æœ‰
â”‚   â”œâ”€â”€ FactCategory.kt                # æ–°å¢ï¼šåˆ†ç±»åˆ†ç»„æ¨¡å‹
â”‚   â”œâ”€â”€ CategoryColor.kt               # æ–°å¢ï¼šåˆ†ç±»é¢œè‰²æ¨¡å‹
â”‚   â”œâ”€â”€ EditModeState.kt               # æ–°å¢ï¼šç¼–è¾‘æ¨¡å¼çŠ¶æ€
â”‚   â””â”€â”€ SearchState.kt                 # æ–°å¢ï¼šæœç´¢çŠ¶æ€
â”œâ”€â”€ usecase/
â”‚   â”œâ”€â”€ GroupFactsByCategoryUseCase.kt # æ–°å¢ï¼šåˆ†ç»„ç”¨ä¾‹
â”‚   â”œâ”€â”€ BatchDeleteFactsUseCase.kt     # æ–°å¢ï¼šæ‰¹é‡åˆ é™¤ç”¨ä¾‹
â”‚   â””â”€â”€ BatchMoveFactsUseCase.kt       # æ–°å¢ï¼šæ‰¹é‡ç§»åŠ¨ç”¨ä¾‹
â”œâ”€â”€ util/
â”‚   â”œâ”€â”€ CategoryColorAssigner.kt       # æ–°å¢ï¼šé¢œè‰²åˆ†é…å™¨
â”‚   â””â”€â”€ FactSearchFilter.kt            # æ–°å¢ï¼šæœç´¢è¿‡æ»¤å™¨

presentation/
â”œâ”€â”€ theme/
â”‚   â””â”€â”€ CategoryColorPalette.kt        # æ–°å¢ï¼šé¢œè‰²è°ƒè‰²æ¿
â”œâ”€â”€ ui/
â”‚   â””â”€â”€ screen/
â”‚       â””â”€â”€ contact/
â”‚           â””â”€â”€ persona/
â”‚               â”œâ”€â”€ PersonaTabV2.kt            # æ–°å¢ï¼šå‡çº§åä¸»ç•Œé¢
â”‚               â”œâ”€â”€ CategorySearchBar.kt       # æ–°å¢ï¼šæœç´¢æ 
â”‚               â”œâ”€â”€ DynamicCategoryCard.kt     # æ–°å¢ï¼šåŠ¨æ€åˆ†ç±»å¡ç‰‡
â”‚               â”œâ”€â”€ SelectableTagChip.kt       # æ–°å¢ï¼šå¯é€‰æ ‡ç­¾
â”‚               â”œâ”€â”€ EditModeTopBar.kt          # æ–°å¢ï¼šç¼–è¾‘æ¨¡å¼é¡¶æ 
â”‚               â”œâ”€â”€ BatchActionBar.kt          # æ–°å¢ï¼šæ‰¹é‡æ“ä½œæ 
â”‚               â”œâ”€â”€ MoveCategoryDialog.kt      # æ–°å¢ï¼šç§»åŠ¨åˆ†ç±»å¯¹è¯æ¡†
â”‚               â””â”€â”€ BatchDeleteConfirmDialog.kt# æ–°å¢ï¼šæ‰¹é‡åˆ é™¤ç¡®è®¤
â”œâ”€â”€ viewmodel/
â”‚   â””â”€â”€ ContactDetailTabViewModel.kt   # æ‰©å±•ï¼šæ·»åŠ ç¼–è¾‘æ¨¡å¼äº‹ä»¶
```

---

## 4. è¯¦ç»†æŠ€æœ¯è®¾è®¡

### 4.1 æ•°æ®æ¨¡å‹è®¾è®¡

#### 4.1.1 FactCategoryï¼ˆåˆ†ç±»åˆ†ç»„æ¨¡å‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/FactCategory.kt`

```kotlin
package com.empathy.ai.domain.model

import androidx.compose.ui.graphics.Color

/**
 * æ ‡ç­¾åˆ†ç±»åˆ†ç»„
 * ç”¨äºUIå±‚å±•ç¤ºåŠ¨æ€åˆ†ç»„åçš„æ ‡ç­¾
 */
data class FactCategory(
    val key: String,                    // åˆ†ç±»åç§°ï¼ˆFactçš„Keyï¼‰
    val facts: List<Fact>,              // è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰æ ‡ç­¾
    val color: CategoryColor,           // åˆ†ç±»é¢œè‰²
    val isExpanded: Boolean = true      // æ˜¯å¦å±•å¼€
) {
    /**
     * æ ‡ç­¾æ•°é‡
     */
    val factCount: Int get() = facts.size
    
    /**
     * æ˜¯å¦ä¸ºç©º
     */
    val isEmpty: Boolean get() = facts.isEmpty()
    
    /**
     * è·å–æ‰€æœ‰Factçš„IDåˆ—è¡¨
     */
    fun getFactIds(): List<String> = facts.map { it.id }
    
    /**
     * æ£€æŸ¥æ˜¯å¦åŒ…å«æŒ‡å®šFact
     */
    fun containsFact(factId: String): Boolean = facts.any { it.id == factId }
    
    /**
     * åˆ›å»ºæŠ˜å /å±•å¼€åçš„å‰¯æœ¬
     */
    fun toggleExpanded(): FactCategory = copy(isExpanded = !isExpanded)
}

/**
 * åˆ†ç±»é¢œè‰²
 * åŒ…å«æ ‡é¢˜é¢œè‰²å’Œæ ‡ç­¾èƒŒæ™¯è‰²
 */
data class CategoryColor(
    val titleColor: Color,              // åˆ†ç±»æ ‡é¢˜é¢œè‰²
    val tagBackgroundColor: Color,      // æ ‡ç­¾èƒŒæ™¯è‰²
    val tagTextColor: Color             // æ ‡ç­¾æ–‡å­—é¢œè‰²
) {
    companion object {
        /**
         * é»˜è®¤é¢œè‰²
         */
        val Default = CategoryColor(
            titleColor = Color(0xFF757575),
            tagBackgroundColor = Color(0xFFF5F5F5),
            tagTextColor = Color(0xFF424242)
        )
    }
}
```

#### 4.1.2 EditModeStateï¼ˆç¼–è¾‘æ¨¡å¼çŠ¶æ€ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/EditModeState.kt`

```kotlin
package com.empathy.ai.domain.model

/**
 * ç¼–è¾‘æ¨¡å¼çŠ¶æ€
 */
data class EditModeState(
    val isActive: Boolean = false,              // æ˜¯å¦å¤„äºç¼–è¾‘æ¨¡å¼
    val selectedFactIds: Set<String> = emptySet(), // å·²é€‰ä¸­çš„Fact IDé›†åˆ
    val showDeleteConfirm: Boolean = false,     // æ˜¯å¦æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    val showMoveDialog: Boolean = false         // æ˜¯å¦æ˜¾ç¤ºç§»åŠ¨åˆ†ç±»å¯¹è¯æ¡†
) {
    /**
     * é€‰ä¸­æ•°é‡
     */
    val selectedCount: Int get() = selectedFactIds.size
    
    /**
     * æ˜¯å¦æœ‰é€‰ä¸­é¡¹
     */
    val hasSelection: Boolean get() = selectedFactIds.isNotEmpty()
    
    /**
     * åˆ‡æ¢Facté€‰ä¸­çŠ¶æ€
     */
    fun toggleSelection(factId: String): EditModeState {
        val newSelection = if (factId in selectedFactIds) {
            selectedFactIds - factId
        } else {
            selectedFactIds + factId
        }
        return copy(selectedFactIds = newSelection)
    }
    
    /**
     * é€‰ä¸­å¤šä¸ªFact
     */
    fun selectAll(factIds: Collection<String>): EditModeState {
        return copy(selectedFactIds = selectedFactIds + factIds)
    }
    
    /**
     * å–æ¶ˆé€‰ä¸­å¤šä¸ªFact
     */
    fun deselectAll(factIds: Collection<String>): EditModeState {
        return copy(selectedFactIds = selectedFactIds - factIds.toSet())
    }
    
    /**
     * æ¸…ç©ºé€‰æ‹©
     */
    fun clearSelection(): EditModeState {
        return copy(selectedFactIds = emptySet())
    }
    
    /**
     * é€€å‡ºç¼–è¾‘æ¨¡å¼
     */
    fun exit(): EditModeState {
        return EditModeState()
    }
    
    /**
     * æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
     */
    fun showDeleteConfirmDialog(): EditModeState {
        return copy(showDeleteConfirm = true)
    }
    
    /**
     * éšè—åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
     */
    fun hideDeleteConfirmDialog(): EditModeState {
        return copy(showDeleteConfirm = false)
    }
    
    /**
     * æ˜¾ç¤ºç§»åŠ¨åˆ†ç±»å¯¹è¯æ¡†
     */
    fun showMoveCategoryDialog(): EditModeState {
        return copy(showMoveDialog = true)
    }
    
    /**
     * éšè—ç§»åŠ¨åˆ†ç±»å¯¹è¯æ¡†
     */
    fun hideMoveCategoryDialog(): EditModeState {
        return copy(showMoveDialog = false)
    }
}
```

#### 4.1.3 PersonaSearchStateï¼ˆæœç´¢çŠ¶æ€ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/PersonaSearchState.kt`

```kotlin
package com.empathy.ai.domain.model

/**
 * æ ‡ç­¾ç”»åƒæœç´¢çŠ¶æ€
 */
data class PersonaSearchState(
    val query: String = "",                     // æœç´¢å…³é”®è¯
    val isSearching: Boolean = false            // æ˜¯å¦æ­£åœ¨æœç´¢
) {
    /**
     * æ˜¯å¦æœ‰æœç´¢å…³é”®è¯
     */
    val hasQuery: Boolean get() = query.isNotBlank()
    
    /**
     * æ›´æ–°æœç´¢å…³é”®è¯
     */
    fun updateQuery(newQuery: String): PersonaSearchState {
        return copy(query = newQuery, isSearching = newQuery.isNotBlank())
    }
    
    /**
     * æ¸…ç©ºæœç´¢
     */
    fun clear(): PersonaSearchState {
        return PersonaSearchState()
    }
}
```


### 4.2 é¢œè‰²ç³»ç»Ÿè®¾è®¡

#### 4.2.1 CategoryColorPaletteï¼ˆé¢œè‰²è°ƒè‰²æ¿ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/theme/CategoryColorPalette.kt`

```kotlin
package com.empathy.ai.presentation.theme

import androidx.compose.ui.graphics.Color
import com.empathy.ai.domain.model.CategoryColor
import kotlin.math.abs

/**
 * Pastelè‰²ç³»è°ƒè‰²æ¿
 * ç”¨äºåŠ¨æ€åˆ†é…ç»™ä¸åŒåˆ†ç±»
 */
object CategoryColorPalette {
    
    /**
     * æµ…è‰²æ¨¡å¼é¢œè‰²åˆ—è¡¨
     */
    private val lightColors = listOf(
        CategoryColor(
            titleColor = Color(0xFFE57373),     // çº¢è‰²ç³»
            tagBackgroundColor = Color(0xFFFFEBEE),
            tagTextColor = Color(0xFFC62828)
        ),
        CategoryColor(
            titleColor = Color(0xFF81C784),     // ç»¿è‰²ç³»
            tagBackgroundColor = Color(0xFFE8F5E9),
            tagTextColor = Color(0xFF2E7D32)
        ),
        CategoryColor(
            titleColor = Color(0xFF64B5F6),     // è“è‰²ç³»
            tagBackgroundColor = Color(0xFFE3F2FD),
            tagTextColor = Color(0xFF1565C0)
        ),
        CategoryColor(
            titleColor = Color(0xFFFFB74D),     // æ©™è‰²ç³»
            tagBackgroundColor = Color(0xFFFFF3E0),
            tagTextColor = Color(0xFFE65100)
        ),
        CategoryColor(
            titleColor = Color(0xFFBA68C8),     // ç´«è‰²ç³»
            tagBackgroundColor = Color(0xFFF3E5F5),
            tagTextColor = Color(0xFF7B1FA2)
        ),
        CategoryColor(
            titleColor = Color(0xFF4DB6AC),     // é’è‰²ç³»
            tagBackgroundColor = Color(0xFFE0F2F1),
            tagTextColor = Color(0xFF00695C)
        ),
        CategoryColor(
            titleColor = Color(0xFFF06292),     // ç²‰è‰²ç³»
            tagBackgroundColor = Color(0xFFFCE4EC),
            tagTextColor = Color(0xFFC2185B)
        ),
        CategoryColor(
            titleColor = Color(0xFF90A4AE),     // ç°è“è‰²ç³»
            tagBackgroundColor = Color(0xFFECEFF1),
            tagTextColor = Color(0xFF455A64)
        )
    )
    
    /**
     * æ·±è‰²æ¨¡å¼é¢œè‰²åˆ—è¡¨
     */
    private val darkColors = listOf(
        CategoryColor(
            titleColor = Color(0xFFEF9A9A),
            tagBackgroundColor = Color(0xFF4A2020),
            tagTextColor = Color(0xFFFFCDD2)
        ),
        CategoryColor(
            titleColor = Color(0xFFA5D6A7),
            tagBackgroundColor = Color(0xFF1B3D1B),
            tagTextColor = Color(0xFFC8E6C9)
        ),
        CategoryColor(
            titleColor = Color(0xFF90CAF9),
            tagBackgroundColor = Color(0xFF1A3A5C),
            tagTextColor = Color(0xFFBBDEFB)
        ),
        CategoryColor(
            titleColor = Color(0xFFFFCC80),
            tagBackgroundColor = Color(0xFF4A3520),
            tagTextColor = Color(0xFFFFE0B2)
        ),
        CategoryColor(
            titleColor = Color(0xFFCE93D8),
            tagBackgroundColor = Color(0xFF3D1A4A),
            tagTextColor = Color(0xFFE1BEE7)
        ),
        CategoryColor(
            titleColor = Color(0xFF80CBC4),
            tagBackgroundColor = Color(0xFF1A3D3A),
            tagTextColor = Color(0xFFB2DFDB)
        ),
        CategoryColor(
            titleColor = Color(0xFFF48FB1),
            tagBackgroundColor = Color(0xFF4A1A2E),
            tagTextColor = Color(0xFFF8BBD9)
        ),
        CategoryColor(
            titleColor = Color(0xFFB0BEC5),
            tagBackgroundColor = Color(0xFF2A3A4A),
            tagTextColor = Color(0xFFCFD8DC)
        )
    )
    
    /**
     * æ ¹æ®åˆ†ç±»åç§°è·å–é¢œè‰²
     * ä½¿ç”¨å“ˆå¸Œç®—æ³•ç¡®ä¿åŒä¸€åˆ†ç±»å§‹ç»ˆè·å¾—ç›¸åŒé¢œè‰²
     * 
     * @param categoryKey åˆ†ç±»åç§°
     * @param isDarkMode æ˜¯å¦æ·±è‰²æ¨¡å¼
     * @return åˆ†ç±»é¢œè‰²
     */
    fun getColorForCategory(categoryKey: String, isDarkMode: Boolean): CategoryColor {
        val colors = if (isDarkMode) darkColors else lightColors
        val index = abs(categoryKey.hashCode()) % colors.size
        return colors[index]
    }
    
    /**
     * è·å–æ‰€æœ‰å¯ç”¨é¢œè‰²æ•°é‡
     */
    fun getColorCount(): Int = lightColors.size
}
```

### 4.3 UseCaseè®¾è®¡

#### 4.3.1 GroupFactsByCategoryUseCaseï¼ˆåˆ†ç»„ç”¨ä¾‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/GroupFactsByCategoryUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.model.CategoryColor
import com.empathy.ai.domain.model.Fact
import com.empathy.ai.domain.model.FactCategory
import com.empathy.ai.domain.util.CategoryColorAssigner
import javax.inject.Inject
import javax.inject.Singleton

/**
 * æŒ‰åˆ†ç±»åˆ†ç»„Factsç”¨ä¾‹
 */
@Singleton
class GroupFactsByCategoryUseCase @Inject constructor(
    private val colorAssigner: CategoryColorAssigner
) {
    /**
     * å°†FactsæŒ‰Keyåˆ†ç»„
     * 
     * @param facts äº‹å®åˆ—è¡¨
     * @param isDarkMode æ˜¯å¦æ·±è‰²æ¨¡å¼
     * @return åˆ†ç»„åçš„åˆ†ç±»åˆ—è¡¨
     */
    operator fun invoke(facts: List<Fact>, isDarkMode: Boolean): List<FactCategory> {
        if (facts.isEmpty()) return emptyList()
        
        return facts
            .groupBy { it.key }
            .map { (key, factList) ->
                FactCategory(
                    key = key,
                    facts = factList.sortedByDescending { it.timestamp },
                    color = colorAssigner.assignColor(key, isDarkMode)
                )
            }
            .sortedBy { it.key }
    }
}
```

#### 4.3.2 BatchDeleteFactsUseCaseï¼ˆæ‰¹é‡åˆ é™¤ç”¨ä¾‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/BatchDeleteFactsUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.repository.ContactRepository
import javax.inject.Inject
import javax.inject.Singleton

/**
 * æ‰¹é‡åˆ é™¤Factsç”¨ä¾‹
 */
@Singleton
class BatchDeleteFactsUseCase @Inject constructor(
    private val contactRepository: ContactRepository
) {
    /**
     * æ‰¹é‡åˆ é™¤æŒ‡å®šçš„Facts
     * 
     * @param contactId è”ç³»äººID
     * @param factIds è¦åˆ é™¤çš„Fact IDåˆ—è¡¨
     * @return åˆ é™¤çš„æ•°é‡
     */
    suspend operator fun invoke(
        contactId: String,
        factIds: List<String>
    ): Result<Int> = runCatching {
        if (factIds.isEmpty()) {
            return@runCatching 0
        }
        
        val contact = contactRepository.getContactById(contactId)
            ?: throw IllegalArgumentException("è”ç³»äººä¸å­˜åœ¨")
        
        val factIdSet = factIds.toSet()
        val updatedFacts = contact.facts.filterNot { it.id in factIdSet }
        val deletedCount = contact.facts.size - updatedFacts.size
        
        if (deletedCount > 0) {
            contactRepository.updateContact(contact.copy(facts = updatedFacts))
        }
        
        deletedCount
    }
}
```

#### 4.3.3 BatchMoveFactsUseCaseï¼ˆæ‰¹é‡ç§»åŠ¨ç”¨ä¾‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/BatchMoveFactsUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.repository.ContactRepository
import javax.inject.Inject
import javax.inject.Singleton

/**
 * æ‰¹é‡ç§»åŠ¨Factsåˆ°æ–°åˆ†ç±»ç”¨ä¾‹
 */
@Singleton
class BatchMoveFactsUseCase @Inject constructor(
    private val contactRepository: ContactRepository
) {
    /**
     * æ‰¹é‡ç§»åŠ¨Factsåˆ°æ–°åˆ†ç±»
     * 
     * @param contactId è”ç³»äººID
     * @param factIds è¦ç§»åŠ¨çš„Fact IDåˆ—è¡¨
     * @param targetCategory ç›®æ ‡åˆ†ç±»åç§°
     * @return ç§»åŠ¨çš„æ•°é‡
     */
    suspend operator fun invoke(
        contactId: String,
        factIds: List<String>,
        targetCategory: String
    ): Result<Int> = runCatching {
        if (factIds.isEmpty()) {
            return@runCatching 0
        }
        
        require(targetCategory.isNotBlank()) { "ç›®æ ‡åˆ†ç±»ä¸èƒ½ä¸ºç©º" }
        require(targetCategory.length in 1..20) { "åˆ†ç±»åç§°é•¿åº¦åº”ä¸º1-20å­—ç¬¦" }
        
        val contact = contactRepository.getContactById(contactId)
            ?: throw IllegalArgumentException("è”ç³»äººä¸å­˜åœ¨")
        
        val factIdSet = factIds.toSet()
        var movedCount = 0
        
        val updatedFacts = contact.facts.map { fact ->
            if (fact.id in factIdSet && fact.key != targetCategory) {
                movedCount++
                fact.copy(
                    key = targetCategory,
                    isUserModified = true,
                    lastModifiedTime = System.currentTimeMillis()
                )
            } else {
                fact
            }
        }
        
        if (movedCount > 0) {
            contactRepository.updateContact(contact.copy(facts = updatedFacts))
        }
        
        movedCount
    }
}
```

### 4.4 å·¥å…·ç±»è®¾è®¡

#### 4.4.1 CategoryColorAssignerï¼ˆé¢œè‰²åˆ†é…å™¨ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/util/CategoryColorAssigner.kt`

```kotlin
package com.empathy.ai.domain.util

import com.empathy.ai.domain.model.CategoryColor
import com.empathy.ai.presentation.theme.CategoryColorPalette
import javax.inject.Inject
import javax.inject.Singleton

/**
 * åˆ†ç±»é¢œè‰²åˆ†é…å™¨
 */
@Singleton
class CategoryColorAssigner @Inject constructor() {
    
    /**
     * ä¸ºåˆ†ç±»åˆ†é…é¢œè‰²
     * 
     * @param categoryKey åˆ†ç±»åç§°
     * @param isDarkMode æ˜¯å¦æ·±è‰²æ¨¡å¼
     * @return åˆ†ç±»é¢œè‰²
     */
    fun assignColor(categoryKey: String, isDarkMode: Boolean): CategoryColor {
        return CategoryColorPalette.getColorForCategory(categoryKey, isDarkMode)
    }
}
```

#### 4.4.2 FactSearchFilterï¼ˆæœç´¢è¿‡æ»¤å™¨ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`domain/util/FactSearchFilter.kt`

```kotlin
package com.empathy.ai.domain.util

import com.empathy.ai.domain.model.Fact
import com.empathy.ai.domain.model.FactCategory
import javax.inject.Inject
import javax.inject.Singleton

/**
 * æ ‡ç­¾æœç´¢è¿‡æ»¤å™¨
 */
@Singleton
class FactSearchFilter @Inject constructor() {
    
    /**
     * è¿‡æ»¤åˆ†ç±»åˆ—è¡¨
     * 
     * @param categories åˆ†ç±»åˆ—è¡¨
     * @param query æœç´¢å…³é”®è¯
     * @return è¿‡æ»¤åçš„åˆ†ç±»åˆ—è¡¨
     */
    fun filter(categories: List<FactCategory>, query: String): List<FactCategory> {
        if (query.isBlank()) return categories
        
        val lowerQuery = query.lowercase()
        
        return categories.mapNotNull { category ->
            // æ£€æŸ¥åˆ†ç±»åç§°æ˜¯å¦åŒ¹é…
            val categoryMatches = category.key.lowercase().contains(lowerQuery)
            
            // è¿‡æ»¤åŒ¹é…çš„æ ‡ç­¾
            val matchingFacts = category.facts.filter { fact ->
                fact.value.lowercase().contains(lowerQuery) ||
                fact.key.lowercase().contains(lowerQuery)
            }
            
            when {
                // åˆ†ç±»åç§°åŒ¹é…ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
                categoryMatches -> category
                // æœ‰åŒ¹é…çš„æ ‡ç­¾ï¼Œåªæ˜¾ç¤ºåŒ¹é…çš„æ ‡ç­¾
                matchingFacts.isNotEmpty() -> category.copy(facts = matchingFacts)
                // æ— åŒ¹é…ï¼Œä¸æ˜¾ç¤ºè¯¥åˆ†ç±»
                else -> null
            }
        }
    }
    
    /**
     * æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«æœç´¢å…³é”®è¯
     * 
     * @param text è¦æ£€æŸ¥çš„æ–‡æœ¬
     * @param query æœç´¢å…³é”®è¯
     * @return æ˜¯å¦åŒ…å«
     */
    fun matches(text: String, query: String): Boolean {
        if (query.isBlank()) return false
        return text.lowercase().contains(query.lowercase())
    }
}
```


### 4.5 UIç»„ä»¶è®¾è®¡

#### 4.5.1 PersonaTabV2ï¼ˆå‡çº§åä¸»ç•Œé¢ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/persona/PersonaTabV2.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.contact.persona

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import com.empathy.ai.domain.model.EditModeState
import com.empathy.ai.domain.model.FactCategory
import com.empathy.ai.domain.model.PersonaSearchState

/**
 * æ ‡ç­¾ç”»åƒTab V2 - å‡çº§åçš„ä¸»ç•Œé¢
 * 
 * @param categories åˆ†ç±»åˆ—è¡¨
 * @param searchState æœç´¢çŠ¶æ€
 * @param editModeState ç¼–è¾‘æ¨¡å¼çŠ¶æ€
 * @param onSearchQueryChange æœç´¢å…³é”®è¯å˜åŒ–å›è°ƒ
 * @param onCategoryToggle åˆ†ç±»æŠ˜å /å±•å¼€å›è°ƒ
 * @param onTagClick æ ‡ç­¾ç‚¹å‡»å›è°ƒ
 * @param onTagLongClick æ ‡ç­¾é•¿æŒ‰å›è°ƒï¼ˆè¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼‰
 * @param onTagSelect æ ‡ç­¾é€‰ä¸­å›è°ƒï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰
 * @param onExitEditMode é€€å‡ºç¼–è¾‘æ¨¡å¼å›è°ƒ
 * @param onBatchDelete æ‰¹é‡åˆ é™¤å›è°ƒ
 * @param onBatchMove æ‰¹é‡ç§»åŠ¨å›è°ƒ
 * @param modifier Modifier
 */
@Composable
fun PersonaTabV2(
    categories: List<FactCategory>,
    searchState: PersonaSearchState,
    editModeState: EditModeState,
    onSearchQueryChange: (String) -> Unit,
    onCategoryToggle: (String) -> Unit,
    onTagClick: (String) -> Unit,
    onTagLongClick: (String) -> Unit,
    onTagSelect: (String) -> Unit,
    onExitEditMode: () -> Unit,
    onBatchDelete: () -> Unit,
    onBatchMove: (String) -> Unit,
    modifier: Modifier = Modifier
) {
    Column(modifier = modifier.fillMaxSize()) {
        // ç¼–è¾‘æ¨¡å¼é¡¶æ æˆ–æœç´¢æ 
        if (editModeState.isActive) {
            EditModeTopBar(
                selectedCount = editModeState.selectedCount,
                onClose = onExitEditMode,
                onSelectAll = { /* å…¨é€‰é€»è¾‘ */ },
                onDeselectAll = { /* å–æ¶ˆå…¨é€‰é€»è¾‘ */ }
            )
        } else {
            CategorySearchBar(
                query = searchState.query,
                onQueryChange = onSearchQueryChange,
                modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)
            )
        }
        
        // åˆ†ç±»åˆ—è¡¨
        LazyColumn(
            modifier = Modifier.weight(1f),
            contentPadding = PaddingValues(16.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            items(
                items = categories,
                key = { it.key }
            ) { category ->
                DynamicCategoryCard(
                    category = category,
                    isEditMode = editModeState.isActive,
                    selectedFactIds = editModeState.selectedFactIds,
                    searchQuery = searchState.query,
                    onToggleExpand = { onCategoryToggle(category.key) },
                    onTagClick = onTagClick,
                    onTagLongClick = onTagLongClick,
                    onTagSelect = onTagSelect
                )
            }
        }
        
        // æ‰¹é‡æ“ä½œæ ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
        if (editModeState.isActive && editModeState.hasSelection) {
            BatchActionBar(
                selectedCount = editModeState.selectedCount,
                onDelete = onBatchDelete,
                onMove = { /* æ˜¾ç¤ºç§»åŠ¨å¯¹è¯æ¡† */ }
            )
        }
    }
}
```


#### 4.5.2 CategorySearchBarï¼ˆæœç´¢æ  - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/persona/CategorySearchBar.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.contact.persona

import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Clear
import androidx.compose.material.icons.filled.Search
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.stringResource
import androidx.compose.ui.unit.dp
import com.empathy.ai.R

/**
 * åˆ†ç±»æœç´¢æ 
 * 
 * @param query å½“å‰æœç´¢å…³é”®è¯
 * @param onQueryChange å…³é”®è¯å˜åŒ–å›è°ƒ
 * @param modifier Modifier
 */
@Composable
fun CategorySearchBar(
    query: String,
    onQueryChange: (String) -> Unit,
    modifier: Modifier = Modifier
) {
    OutlinedTextField(
        value = query,
        onValueChange = onQueryChange,
        modifier = modifier.fillMaxWidth(),
        placeholder = { Text(stringResource(R.string.search_tags_hint)) },
        leadingIcon = {
            Icon(
                imageVector = Icons.Default.Search,
                contentDescription = null,
                tint = MaterialTheme.colorScheme.onSurfaceVariant
            )
        },
        trailingIcon = {
            if (query.isNotEmpty()) {
                IconButton(onClick = { onQueryChange("") }) {
                    Icon(
                        imageVector = Icons.Default.Clear,
                        contentDescription = stringResource(R.string.clear_search)
                    )
                }
            }
        },
        singleLine = true,
        shape = RoundedCornerShape(24.dp),
        colors = OutlinedTextFieldDefaults.colors(
            focusedBorderColor = MaterialTheme.colorScheme.primary,
            unfocusedBorderColor = MaterialTheme.colorScheme.outline.copy(alpha = 0.5f)
        )
    )
}
```


#### 4.5.3 DynamicCategoryCardï¼ˆåŠ¨æ€åˆ†ç±»å¡ç‰‡ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/persona/DynamicCategoryCard.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.contact.persona

import androidx.compose.animation.*
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ExpandLess
import androidx.compose.material.icons.filled.ExpandMore
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.empathy.ai.domain.model.FactCategory
import com.google.accompanist.flowlayout.FlowRow

/**
 * åŠ¨æ€åˆ†ç±»å¡ç‰‡
 * 
 * @param category åˆ†ç±»æ•°æ®
 * @param isEditMode æ˜¯å¦å¤„äºç¼–è¾‘æ¨¡å¼
 * @param selectedFactIds å·²é€‰ä¸­çš„Fact IDé›†åˆ
 * @param searchQuery æœç´¢å…³é”®è¯ï¼ˆç”¨äºé«˜äº®ï¼‰
 * @param onToggleExpand æŠ˜å /å±•å¼€å›è°ƒ
 * @param onTagClick æ ‡ç­¾ç‚¹å‡»å›è°ƒ
 * @param onTagLongClick æ ‡ç­¾é•¿æŒ‰å›è°ƒ
 * @param onTagSelect æ ‡ç­¾é€‰ä¸­å›è°ƒ
 * @param modifier Modifier
 */
@Composable
fun DynamicCategoryCard(
    category: FactCategory,
    isEditMode: Boolean,
    selectedFactIds: Set<String>,
    searchQuery: String,
    onToggleExpand: () -> Unit,
    onTagClick: (String) -> Unit,
    onTagLongClick: (String) -> Unit,
    onTagSelect: (String) -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.fillMaxWidth(),
        shape = RoundedCornerShape(12.dp),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        ),
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
    ) {
        Column(modifier = Modifier.padding(12.dp)) {
            // åˆ†ç±»æ ‡é¢˜æ 
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .clip(RoundedCornerShape(8.dp))
                    .clickable { onToggleExpand() }
                    .padding(8.dp),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Row(verticalAlignment = Alignment.CenterVertically) {
                    // é¢œè‰²æŒ‡ç¤ºæ¡
                    Box(
                        modifier = Modifier
                            .width(4.dp)
                            .height(20.dp)
                            .background(
                                color = category.color.titleColor,
                                shape = RoundedCornerShape(2.dp)
                            )
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    // åˆ†ç±»åç§°
                    Text(
                        text = category.key,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.SemiBold,
                        color = category.color.titleColor
                    )
                    // æ ‡ç­¾æ•°é‡
                    Text(
                        text = " (${category.factCount})",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
                // å±•å¼€/æŠ˜å å›¾æ ‡
                Icon(
                    imageVector = if (category.isExpanded) 
                        Icons.Default.ExpandLess else Icons.Default.ExpandMore,
                    contentDescription = null,
                    tint = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
            
            // æ ‡ç­¾æµå¼å¸ƒå±€ï¼ˆå¯æŠ˜å ï¼‰
            AnimatedVisibility(
                visible = category.isExpanded,
                enter = expandVertically() + fadeIn(),
                exit = shrinkVertically() + fadeOut()
            ) {
                FlowRow(
                    modifier = Modifier.padding(top = 8.dp),
                    mainAxisSpacing = 8.dp,
                    crossAxisSpacing = 8.dp
                ) {
                    category.facts.forEach { fact ->
                        SelectableTagChip(
                            fact = fact,
                            isSelected = fact.id in selectedFactIds,
                            isEditMode = isEditMode,
                            categoryColor = category.color,
                            searchQuery = searchQuery,
                            onClick = { onTagClick(fact.id) },
                            onLongClick = { onTagLongClick(fact.id) },
                            onSelect = { onTagSelect(fact.id) }
                        )
                    }
                }
            }
        }
    }
}
```


#### 4.5.4 SelectableTagChipï¼ˆå¯é€‰æ ‡ç­¾ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/persona/SelectableTagChip.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.contact.persona

import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.combinedClickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.CheckCircle
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.text.SpanStyle
import androidx.compose.ui.text.buildAnnotatedString
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.withStyle
import androidx.compose.ui.unit.dp
import com.empathy.ai.domain.model.CategoryColor
import com.empathy.ai.domain.model.Fact

/**
 * å¯é€‰æ ‡ç­¾Chip
 * 
 * @param fact æ ‡ç­¾æ•°æ®
 * @param isSelected æ˜¯å¦è¢«é€‰ä¸­
 * @param isEditMode æ˜¯å¦å¤„äºç¼–è¾‘æ¨¡å¼
 * @param categoryColor åˆ†ç±»é¢œè‰²
 * @param searchQuery æœç´¢å…³é”®è¯ï¼ˆç”¨äºé«˜äº®ï¼‰
 * @param onClick ç‚¹å‡»å›è°ƒ
 * @param onLongClick é•¿æŒ‰å›è°ƒ
 * @param onSelect é€‰ä¸­å›è°ƒ
 * @param modifier Modifier
 */
@OptIn(ExperimentalFoundationApi::class)
@Composable
fun SelectableTagChip(
    fact: Fact,
    isSelected: Boolean,
    isEditMode: Boolean,
    categoryColor: CategoryColor,
    searchQuery: String,
    onClick: () -> Unit,
    onLongClick: () -> Unit,
    onSelect: () -> Unit,
    modifier: Modifier = Modifier
) {
    val backgroundColor = if (isSelected) {
        MaterialTheme.colorScheme.primaryContainer
    } else {
        categoryColor.tagBackgroundColor
    }
    
    val textColor = if (isSelected) {
        MaterialTheme.colorScheme.onPrimaryContainer
    } else {
        categoryColor.tagTextColor
    }
    
    Row(
        modifier = modifier
            .clip(RoundedCornerShape(16.dp))
            .background(backgroundColor)
            .combinedClickable(
                onClick = { if (isEditMode) onSelect() else onClick() },
                onLongClick = onLongClick
            )
            .padding(horizontal = 12.dp, vertical = 6.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        // ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºé€‰ä¸­å›¾æ ‡
        if (isEditMode && isSelected) {
            Icon(
                imageVector = Icons.Default.CheckCircle,
                contentDescription = null,
                modifier = Modifier.size(16.dp),
                tint = MaterialTheme.colorScheme.primary
            )
            Spacer(modifier = Modifier.width(4.dp))
        }
        
        // æ ‡ç­¾æ–‡æœ¬ï¼ˆæ”¯æŒæœç´¢é«˜äº®ï¼‰
        Text(
            text = buildHighlightedText(fact.value, searchQuery),
            style = MaterialTheme.typography.bodyMedium,
            color = textColor
        )
    }
}

/**
 * æ„å»ºå¸¦é«˜äº®çš„æ–‡æœ¬
 */
@Composable
private fun buildHighlightedText(text: String, query: String) = buildAnnotatedString {
    if (query.isBlank()) {
        append(text)
        return@buildAnnotatedString
    }
    
    val lowerText = text.lowercase()
    val lowerQuery = query.lowercase()
    var startIndex = 0
    
    while (true) {
        val index = lowerText.indexOf(lowerQuery, startIndex)
        if (index < 0) {
            append(text.substring(startIndex))
            break
        }
        
        // æ·»åŠ éé«˜äº®éƒ¨åˆ†
        append(text.substring(startIndex, index))
        
        // æ·»åŠ é«˜äº®éƒ¨åˆ†
        withStyle(SpanStyle(fontWeight = FontWeight.Bold)) {
            append(text.substring(index, index + query.length))
        }
        
        startIndex = index + query.length
    }
}
```


#### 4.5.5 EditModeTopBarï¼ˆç¼–è¾‘æ¨¡å¼é¡¶æ  - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/persona/EditModeTopBar.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.contact.persona

import androidx.compose.foundation.layout.*
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.SelectAll
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.stringResource
import androidx.compose.ui.unit.dp
import com.empathy.ai.R

/**
 * ç¼–è¾‘æ¨¡å¼é¡¶æ 
 * 
 * @param selectedCount å·²é€‰ä¸­æ•°é‡
 * @param onClose å…³é—­ç¼–è¾‘æ¨¡å¼å›è°ƒ
 * @param onSelectAll å…¨é€‰å›è°ƒ
 * @param onDeselectAll å–æ¶ˆå…¨é€‰å›è°ƒ
 * @param modifier Modifier
 */
@Composable
fun EditModeTopBar(
    selectedCount: Int,
    onClose: () -> Unit,
    onSelectAll: () -> Unit,
    onDeselectAll: () -> Unit,
    modifier: Modifier = Modifier
) {
    Surface(
        modifier = modifier.fillMaxWidth(),
        color = MaterialTheme.colorScheme.primaryContainer,
        tonalElevation = 4.dp
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 8.dp, vertical = 12.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Row(verticalAlignment = Alignment.CenterVertically) {
                IconButton(onClick = onClose) {
                    Icon(
                        imageVector = Icons.Default.Close,
                        contentDescription = stringResource(R.string.exit_edit_mode),
                        tint = MaterialTheme.colorScheme.onPrimaryContainer
                    )
                }
                Text(
                    text = stringResource(R.string.selected_count, selectedCount),
                    style = MaterialTheme.typography.titleMedium,
                    color = MaterialTheme.colorScheme.onPrimaryContainer
                )
            }
            
            Row {
                TextButton(onClick = onSelectAll) {
                    Icon(
                        imageVector = Icons.Default.SelectAll,
                        contentDescription = null,
                        modifier = Modifier.size(18.dp)
                    )
                    Spacer(modifier = Modifier.width(4.dp))
                    Text(stringResource(R.string.select_all))
                }
                TextButton(onClick = onDeselectAll) {
                    Text(stringResource(R.string.deselect_all))
                }
            }
        }
    }
}
```


#### 4.5.6 BatchActionBarï¼ˆæ‰¹é‡æ“ä½œæ  - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/persona/BatchActionBar.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.contact.persona

import androidx.compose.foundation.layout.*
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Delete
import androidx.compose.material.icons.filled.DriveFileMove
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.stringResource
import androidx.compose.ui.unit.dp
import com.empathy.ai.R

/**
 * æ‰¹é‡æ“ä½œæ 
 * 
 * @param selectedCount å·²é€‰ä¸­æ•°é‡
 * @param onDelete åˆ é™¤å›è°ƒ
 * @param onMove ç§»åŠ¨å›è°ƒ
 * @param modifier Modifier
 */
@Composable
fun BatchActionBar(
    selectedCount: Int,
    onDelete: () -> Unit,
    onMove: () -> Unit,
    modifier: Modifier = Modifier
) {
    Surface(
        modifier = modifier.fillMaxWidth(),
        color = MaterialTheme.colorScheme.surfaceVariant,
        tonalElevation = 8.dp
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 12.dp),
            horizontalArrangement = Arrangement.SpaceEvenly,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // ç§»åŠ¨æŒ‰é’®
            FilledTonalButton(
                onClick = onMove,
                modifier = Modifier.weight(1f).padding(end = 8.dp)
            ) {
                Icon(
                    imageVector = Icons.Default.DriveFileMove,
                    contentDescription = null,
                    modifier = Modifier.size(18.dp)
                )
                Spacer(modifier = Modifier.width(8.dp))
                Text(stringResource(R.string.move_to_category))
            }
            
            // åˆ é™¤æŒ‰é’®
            Button(
                onClick = onDelete,
                modifier = Modifier.weight(1f).padding(start = 8.dp),
                colors = ButtonDefaults.buttonColors(
                    containerColor = MaterialTheme.colorScheme.error
                )
            ) {
                Icon(
                    imageVector = Icons.Default.Delete,
                    contentDescription = null,
                    modifier = Modifier.size(18.dp)
                )
                Spacer(modifier = Modifier.width(8.dp))
                Text(stringResource(R.string.delete_selected, selectedCount))
            }
        }
    }
}
```


#### 4.5.7 MoveCategoryDialogï¼ˆç§»åŠ¨åˆ†ç±»å¯¹è¯æ¡† - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/persona/MoveCategoryDialog.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.contact.persona

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.selection.selectable
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.stringResource
import androidx.compose.ui.semantics.Role
import androidx.compose.ui.unit.dp
import com.empathy.ai.R

/**
 * ç§»åŠ¨åˆ†ç±»å¯¹è¯æ¡†
 * 
 * @param existingCategories ç°æœ‰åˆ†ç±»åˆ—è¡¨
 * @param selectedCount å·²é€‰ä¸­æ ‡ç­¾æ•°é‡
 * @param onConfirm ç¡®è®¤ç§»åŠ¨å›è°ƒ
 * @param onDismiss å…³é—­å¯¹è¯æ¡†å›è°ƒ
 */
@Composable
fun MoveCategoryDialog(
    existingCategories: List<String>,
    selectedCount: Int,
    onConfirm: (String) -> Unit,
    onDismiss: () -> Unit
) {
    var selectedCategory by remember { mutableStateOf<String?>(null) }
    var newCategoryName by remember { mutableStateOf("") }
    var isCreatingNew by remember { mutableStateOf(false) }
    
    AlertDialog(
        onDismissRequest = onDismiss,
        title = {
            Text(stringResource(R.string.move_to_category_title, selectedCount))
        },
        text = {
            Column {
                // åˆ›å»ºæ–°åˆ†ç±»é€‰é¡¹
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .selectable(
                            selected = isCreatingNew,
                            onClick = { isCreatingNew = true; selectedCategory = null },
                            role = Role.RadioButton
                        )
                        .padding(vertical = 8.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    RadioButton(
                        selected = isCreatingNew,
                        onClick = null
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(stringResource(R.string.create_new_category))
                }
                
                // æ–°åˆ†ç±»åç§°è¾“å…¥æ¡†
                if (isCreatingNew) {
                    OutlinedTextField(
                        value = newCategoryName,
                        onValueChange = { newCategoryName = it.take(20) },
                        label = { Text(stringResource(R.string.category_name)) },
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(start = 32.dp),
                        singleLine = true,
                        supportingText = {
                            Text("${newCategoryName.length}/20")
                        }
                    )
                }
                
                Divider(modifier = Modifier.padding(vertical = 8.dp))
                
                // ç°æœ‰åˆ†ç±»åˆ—è¡¨
                Text(
                    text = stringResource(R.string.existing_categories),
                    style = MaterialTheme.typography.labelMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                
                LazyColumn(
                    modifier = Modifier.heightIn(max = 200.dp)
                ) {
                    items(existingCategories) { category ->
                        Row(
                            modifier = Modifier
                                .fillMaxWidth()
                                .selectable(
                                    selected = selectedCategory == category,
                                    onClick = { 
                                        selectedCategory = category
                                        isCreatingNew = false 
                                    },
                                    role = Role.RadioButton
                                )
                                .padding(vertical = 8.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            RadioButton(
                                selected = selectedCategory == category,
                                onClick = null
                            )
                            Spacer(modifier = Modifier.width(8.dp))
                            Text(category)
                        }
                    }
                }
            }
        },
        confirmButton = {
            TextButton(
                onClick = {
                    val target = if (isCreatingNew) newCategoryName else selectedCategory
                    target?.let { onConfirm(it) }
                },
                enabled = (isCreatingNew && newCategoryName.isNotBlank()) || 
                          (!isCreatingNew && selectedCategory != null)
            ) {
                Text(stringResource(R.string.confirm_move))
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text(stringResource(R.string.cancel))
            }
        }
    )
}
```


#### 4.5.8 BatchDeleteConfirmDialogï¼ˆæ‰¹é‡åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/persona/BatchDeleteConfirmDialog.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.contact.persona

import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.res.stringResource
import com.empathy.ai.R

/**
 * æ‰¹é‡åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
 * 
 * @param selectedCount å·²é€‰ä¸­æ ‡ç­¾æ•°é‡
 * @param onConfirm ç¡®è®¤åˆ é™¤å›è°ƒ
 * @param onDismiss å…³é—­å¯¹è¯æ¡†å›è°ƒ
 */
@Composable
fun BatchDeleteConfirmDialog(
    selectedCount: Int,
    onConfirm: () -> Unit,
    onDismiss: () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = {
            Text(stringResource(R.string.delete_confirm_title))
        },
        text = {
            Text(stringResource(R.string.delete_tags_confirm_message, selectedCount))
        },
        confirmButton = {
            TextButton(
                onClick = onConfirm,
                colors = ButtonDefaults.textButtonColors(
                    contentColor = MaterialTheme.colorScheme.error
                )
            ) {
                Text(stringResource(R.string.delete))
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text(stringResource(R.string.cancel))
            }
        }
    )
}
```

### 4.6 ViewModelæ‰©å±•è®¾è®¡

#### 4.6.1 ContactDetailTabViewModelæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/viewmodel/ContactDetailTabViewModel.kt`ï¼ˆæ‰©å±•ç°æœ‰æ–‡ä»¶ï¼‰

éœ€è¦åœ¨ç°æœ‰ViewModelä¸­æ·»åŠ ä»¥ä¸‹çŠ¶æ€å’Œäº‹ä»¶å¤„ç†ï¼š

```kotlin
// æ–°å¢çŠ¶æ€å­—æ®µ
data class ContactDetailTabUiState(
    // ... ç°æœ‰å­—æ®µ ...
    
    // æ ‡ç­¾ç”»åƒå‡çº§ç›¸å…³çŠ¶æ€
    val factCategories: List<FactCategory> = emptyList(),
    val personaSearchState: PersonaSearchState = PersonaSearchState(),
    val editModeState: EditModeState = EditModeState(),
    val availableCategories: List<String> = emptyList()
)

// æ–°å¢äº‹ä»¶ç±»å‹
sealed class ContactDetailTabUiEvent {
    // ... ç°æœ‰äº‹ä»¶ ...
    
    // æ ‡ç­¾ç”»åƒå‡çº§ç›¸å…³äº‹ä»¶
    data class UpdatePersonaSearch(val query: String) : ContactDetailTabUiEvent()
    data class ToggleCategoryExpand(val categoryKey: String) : ContactDetailTabUiEvent()
    data class EnterEditMode(val initialFactId: String) : ContactDetailTabUiEvent()
    object ExitEditMode : ContactDetailTabUiEvent()
    data class ToggleFactSelection(val factId: String) : ContactDetailTabUiEvent()
    data class SelectAllInCategory(val categoryKey: String) : ContactDetailTabUiEvent()
    object DeselectAll : ContactDetailTabUiEvent()
    object ShowDeleteConfirm : ContactDetailTabUiEvent()
    object HideDeleteConfirm : ContactDetailTabUiEvent()
    object ConfirmBatchDelete : ContactDetailTabUiEvent()
    object ShowMoveDialog : ContactDetailTabUiEvent()
    object HideMoveDialog : ContactDetailTabUiEvent()
    data class ConfirmBatchMove(val targetCategory: String) : ContactDetailTabUiEvent()
}
```


#### 4.6.2 ViewModeläº‹ä»¶å¤„ç†å®ç°

```kotlin
@HiltViewModel
class ContactDetailTabViewModel @Inject constructor(
    // ... ç°æœ‰ä¾èµ– ...
    private val groupFactsByCategoryUseCase: GroupFactsByCategoryUseCase,
    private val batchDeleteFactsUseCase: BatchDeleteFactsUseCase,
    private val batchMoveFactsUseCase: BatchMoveFactsUseCase,
    private val factSearchFilter: FactSearchFilter
) : ViewModel() {
    
    // å¤„ç†æ ‡ç­¾ç”»åƒç›¸å…³äº‹ä»¶
    private fun handlePersonaEvent(event: ContactDetailTabUiEvent) {
        when (event) {
            is ContactDetailTabUiEvent.UpdatePersonaSearch -> {
                _uiState.update { state ->
                    val newSearchState = state.personaSearchState.updateQuery(event.query)
                    val filteredCategories = factSearchFilter.filter(
                        state.factCategories, 
                        event.query
                    )
                    state.copy(
                        personaSearchState = newSearchState,
                        factCategories = filteredCategories
                    )
                }
            }
            
            is ContactDetailTabUiEvent.ToggleCategoryExpand -> {
                _uiState.update { state ->
                    val updatedCategories = state.factCategories.map { category ->
                        if (category.key == event.categoryKey) {
                            category.toggleExpanded()
                        } else {
                            category
                        }
                    }
                    state.copy(factCategories = updatedCategories)
                }
            }
            
            is ContactDetailTabUiEvent.EnterEditMode -> {
                _uiState.update { state ->
                    state.copy(
                        editModeState = EditModeState(
                            isActive = true,
                            selectedFactIds = setOf(event.initialFactId)
                        )
                    )
                }
            }
            
            ContactDetailTabUiEvent.ExitEditMode -> {
                _uiState.update { state ->
                    state.copy(editModeState = EditModeState())
                }
            }
            
            is ContactDetailTabUiEvent.ToggleFactSelection -> {
                _uiState.update { state ->
                    state.copy(
                        editModeState = state.editModeState.toggleSelection(event.factId)
                    )
                }
            }
            
            is ContactDetailTabUiEvent.ConfirmBatchDelete -> {
                viewModelScope.launch {
                    val contactId = _uiState.value.contactId
                    val factIds = _uiState.value.editModeState.selectedFactIds.toList()
                    
                    batchDeleteFactsUseCase(contactId, factIds)
                        .onSuccess { deletedCount ->
                            _uiState.update { state ->
                                state.copy(
                                    editModeState = EditModeState(),
                                    // åˆ·æ–°åˆ†ç±»åˆ—è¡¨
                                )
                            }
                            // æ˜¾ç¤ºæˆåŠŸæç¤º
                        }
                        .onFailure { error ->
                            // æ˜¾ç¤ºé”™è¯¯æç¤º
                        }
                }
            }
            
            is ContactDetailTabUiEvent.ConfirmBatchMove -> {
                viewModelScope.launch {
                    val contactId = _uiState.value.contactId
                    val factIds = _uiState.value.editModeState.selectedFactIds.toList()
                    
                    batchMoveFactsUseCase(contactId, factIds, event.targetCategory)
                        .onSuccess { movedCount ->
                            _uiState.update { state ->
                                state.copy(
                                    editModeState = EditModeState(),
                                    // åˆ·æ–°åˆ†ç±»åˆ—è¡¨
                                )
                            }
                            // æ˜¾ç¤ºæˆåŠŸæç¤º
                        }
                        .onFailure { error ->
                            // æ˜¾ç¤ºé”™è¯¯æç¤º
                        }
                }
            }
            
            // ... å…¶ä»–äº‹ä»¶å¤„ç† ...
            else -> { /* å¿½ç•¥éæ ‡ç­¾ç”»åƒäº‹ä»¶ */ }
        }
    }
    
    /**
     * åˆ·æ–°åˆ†ç±»åˆ—è¡¨
     */
    private fun refreshCategories(facts: List<Fact>, isDarkMode: Boolean) {
        val categories = groupFactsByCategoryUseCase(facts, isDarkMode)
        val availableCategories = categories.map { it.key }
        
        _uiState.update { state ->
            state.copy(
                factCategories = categories,
                availableCategories = availableCategories
            )
        }
    }
}
```


---

## 5. ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ

> **è¯´æ˜**ï¼šæœ¬ç« èŠ‚æ ¹æ®DR-00017å®¡æŸ¥æŠ¥å‘Šè¡¥å……ï¼Œè¯¦ç»†è¯´æ˜ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆæ–¹æ¡ˆã€‚

### 5.1 å¯¼èˆªç³»ç»Ÿé›†æˆ

#### 5.1.1 é›†æˆè¯´æ˜

PersonaTabV2ä½œä¸ºContactDetailTabScreençš„å­ç»„ä»¶ï¼Œä¸éœ€è¦ç‹¬ç«‹çš„å¯¼èˆªè·¯ç”±ã€‚å®ƒé€šè¿‡ç°æœ‰çš„æ ‡ç­¾é¡µç³»ç»Ÿé›†æˆåˆ°è”ç³»äººè¯¦æƒ…ç•Œé¢ã€‚

#### 5.1.2 ContactDetailTabScreené›†æˆ

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/ContactDetailTabScreen.kt`

```kotlin
// åœ¨ç°æœ‰ContactDetailTabScreenä¸­æ›¿æ¢PersonaTabä¸ºPersonaTabV2
@Composable
fun ContactDetailTabScreen(
    contactId: String,
    viewModel: ContactDetailTabViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    // ... ç°æœ‰ä»£ç  ...
    
    // æ ‡ç­¾é¡µå†…å®¹
    when (uiState.selectedTab) {
        DetailTab.OVERVIEW -> OverviewTab(...)
        DetailTab.FACT_STREAM -> FactStreamTab(...)
        DetailTab.PERSONA -> {
            // ğŸ†• æ›¿æ¢ä¸ºPersonaTabV2
            PersonaTabV2(
                categories = uiState.factCategories,
                searchState = uiState.personaSearchState,
                editModeState = uiState.editModeState,
                onSearchQueryChange = { viewModel.onEvent(ContactDetailTabUiEvent.UpdatePersonaSearch(it)) },
                onCategoryToggle = { viewModel.onEvent(ContactDetailTabUiEvent.ToggleCategoryExpand(it)) },
                onTagClick = { viewModel.onEvent(ContactDetailTabUiEvent.OnTagClick(it)) },
                onTagLongClick = { viewModel.onEvent(ContactDetailTabUiEvent.EnterEditMode(it)) },
                onTagSelect = { viewModel.onEvent(ContactDetailTabUiEvent.ToggleFactSelection(it)) },
                onExitEditMode = { viewModel.onEvent(ContactDetailTabUiEvent.ExitEditMode) },
                onBatchDelete = { viewModel.onEvent(ContactDetailTabUiEvent.ConfirmBatchDelete) },
                onBatchMove = { viewModel.onEvent(ContactDetailTabUiEvent.ConfirmBatchMove(it)) }
            )
        }
        DetailTab.DATA_VAULT -> DataVaultTab(...)
    }
}
```

#### 5.1.3 Feature Flagæ§åˆ¶

**æ–‡ä»¶ä½ç½®**ï¼š`domain/util/FeatureFlags.kt`

```kotlin
package com.empathy.ai.domain.util

/**
 * åŠŸèƒ½å¼€å…³é…ç½®
 * ç”¨äºç°åº¦å‘å¸ƒå’ŒA/Bæµ‹è¯•
 */
object FeatureFlags {
    /**
     * æ˜¯å¦å¯ç”¨æ–°ç‰ˆæ ‡ç­¾ç”»åƒç•Œé¢
     * é»˜è®¤å…³é—­ï¼Œé€šè¿‡é…ç½®æˆ–è¿œç¨‹å¼€å…³æ§åˆ¶
     */
    var usePersonaTabV2: Boolean = false
    
    /**
     * æ£€æŸ¥æ˜¯å¦åº”è¯¥ä½¿ç”¨PersonaTabV2
     */
    fun shouldUsePersonaTabV2(): Boolean = usePersonaTabV2
}
```

### 5.2 ä¸ç°æœ‰æ•°æ®å±‚é›†æˆ

#### 5.2.1 å¤ç”¨ç°æœ‰Repository

æœ¬åŠŸèƒ½å®Œå…¨å¤ç”¨ç°æœ‰çš„`ContactRepository`ï¼Œä¸éœ€è¦æ–°å¢Repositoryï¼š

```kotlin
// ç°æœ‰ContactRepositoryå·²æä¾›æ‰€éœ€æ–¹æ³•
interface ContactRepository {
    suspend fun getContactById(contactId: String): ContactProfile?
    suspend fun updateContact(contact: ContactProfile)
    fun observeContact(contactId: String): Flow<ContactProfile?>
}
```

#### 5.2.2 Factæ¨¡å‹å¤ç”¨

å¤ç”¨ç°æœ‰`domain/model/Fact.kt`ï¼Œæ— éœ€ä¿®æ”¹ï¼š

```kotlin
// ç°æœ‰Factæ¨¡å‹å·²æ»¡è¶³éœ€æ±‚
data class Fact(
    val id: String,
    val key: String,           // ç”¨äºåˆ†ç±»åˆ†ç»„
    val value: String,
    val source: FactSource,
    val timestamp: Long = System.currentTimeMillis(),
    val isUserModified: Boolean = false,
    val lastModifiedTime: Long? = null
)
```

#### 5.2.3 æ•°æ®åº“ç¡®è®¤

**å·²ç¡®è®¤**ï¼šFactæ•°æ®å­˜å‚¨åœ¨ContactProfileçš„factså­—æ®µä¸­ï¼Œé€šè¿‡Roomçš„TypeConverteråºåˆ—åŒ–ï¼Œæ— éœ€é¢å¤–çš„DAOæˆ–Entityã€‚

```kotlin
// ç°æœ‰AppDatabase.ktä¸­å·²åŒ…å«å¿…è¦é…ç½®
@Database(
    entities = [ContactProfileEntity::class, ...],
    version = 10
)
@TypeConverters(RoomTypeConverters::class, FactListConverter::class)
abstract class AppDatabase : RoomDatabase()
```

### 5.3 ä¸ç°æœ‰BrainTagçš„å…¼å®¹æ€§

#### 5.3.1 æ•°æ®å…³ç³»è¯´æ˜

- **BrainTag**ï¼šç”¨äºè”ç³»äººçš„"å†›å¸ˆé”¦å›Š"æ ‡ç­¾ç³»ç»Ÿï¼ˆé›·åŒº/ç­–ç•¥æ ‡ç­¾ï¼‰
- **Fact**ï¼šç”¨äºè”ç³»äººçš„äº‹å®ä¿¡æ¯è®°å½•ï¼ˆå…´è¶£çˆ±å¥½ã€å·¥ä½œä¿¡æ¯ç­‰ï¼‰

ä¸¤è€…æ˜¯ç‹¬ç«‹çš„æ•°æ®æ¨¡å‹ï¼Œæœ¬æ¬¡å‡çº§ä»…æ¶‰åŠFactçš„å±•ç¤ºä¼˜åŒ–ï¼Œä¸å½±å“BrainTagåŠŸèƒ½ã€‚

#### 5.3.2 UIå±‚åŒºåˆ†

```kotlin
// PersonaTabä¸­åŒæ—¶å±•ç¤ºBrainTagå’ŒFact
@Composable
fun PersonaTabV2(...) {
    Column {
        // 1. BrainTagåŒºåŸŸï¼ˆä¿æŒç°æœ‰å®ç°ï¼‰
        BrainTagSection(
            brainTags = brainTags,
            onTagClick = onBrainTagClick
        )
        
        Divider()
        
        // 2. Factåˆ†ç±»åŒºåŸŸï¼ˆæœ¬æ¬¡å‡çº§å†…å®¹ï¼‰
        FactCategoriesSection(
            categories = categories,
            searchState = searchState,
            editModeState = editModeState,
            // ... å…¶ä»–å‚æ•°
        )
    }
}
```

---

## 6. ä¾èµ–æ³¨å…¥é…ç½®

### 6.1 PersonaModuleï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`di/PersonaModule.kt`

```kotlin
package com.empathy.ai.di

import com.empathy.ai.domain.repository.ContactRepository
import com.empathy.ai.domain.usecase.BatchDeleteFactsUseCase
import com.empathy.ai.domain.usecase.BatchMoveFactsUseCase
import com.empathy.ai.domain.usecase.GroupFactsByCategoryUseCase
import com.empathy.ai.domain.util.CategoryColorAssigner
import com.empathy.ai.domain.util.FactSearchFilter
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

@Module
@InstallIn(SingletonComponent::class)
object PersonaModule {
    
    @Provides
    @Singleton
    fun provideCategoryColorAssigner(): CategoryColorAssigner {
        return CategoryColorAssigner()
    }
    
    @Provides
    @Singleton
    fun provideFactSearchFilter(): FactSearchFilter {
        return FactSearchFilter()
    }
    
    @Provides
    @Singleton
    fun provideGroupFactsByCategoryUseCase(
        colorAssigner: CategoryColorAssigner
    ): GroupFactsByCategoryUseCase {
        return GroupFactsByCategoryUseCase(colorAssigner)
    }
    
    @Provides
    @Singleton
    fun provideBatchDeleteFactsUseCase(
        contactRepository: ContactRepository
    ): BatchDeleteFactsUseCase {
        return BatchDeleteFactsUseCase(contactRepository)
    }
    
    @Provides
    @Singleton
    fun provideBatchMoveFactsUseCase(
        contactRepository: ContactRepository
    ): BatchMoveFactsUseCase {
        return BatchMoveFactsUseCase(contactRepository)
    }
}
```

### 6.2 ä¸ç°æœ‰Moduleçš„é›†æˆ

**æ— éœ€ä¿®æ”¹ç°æœ‰Module**ï¼š
- `DatabaseModule.kt`ï¼šå·²æä¾›ContactDaoï¼Œæ— éœ€ä¿®æ”¹
- `RepositoryModule.kt`ï¼šå·²ç»‘å®šContactRepositoryï¼Œæ— éœ€ä¿®æ”¹
- `DispatcherModule.kt`ï¼šå·²æä¾›åç¨‹è°ƒåº¦å™¨ï¼Œæ— éœ€ä¿®æ”¹

PersonaModuleä½œä¸ºç‹¬ç«‹æ¨¡å—ï¼Œé€šè¿‡Hiltè‡ªåŠ¨å‘ç°å’ŒåŠ è½½ã€‚

---

## 7. å­—ç¬¦ä¸²èµ„æº

### 7.1 strings.xmlï¼ˆæ–°å¢æ¡ç›®ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`res/values/strings.xml`

```xml
<!-- æ ‡ç­¾ç”»åƒå‡çº§ -->
<string name="search_tags_hint">æœç´¢æ ‡ç­¾æˆ–åˆ†ç±»...</string>
<string name="clear_search">æ¸…é™¤æœç´¢</string>
<string name="exit_edit_mode">é€€å‡ºç¼–è¾‘æ¨¡å¼</string>
<string name="selected_count">å·²é€‰æ‹© %d é¡¹</string>
<string name="select_all">å…¨é€‰</string>
<string name="deselect_all">å–æ¶ˆå…¨é€‰</string>
<string name="move_to_category">ç§»åŠ¨åˆ†ç±»</string>
<string name="delete_selected">åˆ é™¤ (%d)</string>
<string name="move_to_category_title">ç§»åŠ¨ %d ä¸ªæ ‡ç­¾åˆ°</string>
<string name="create_new_category">åˆ›å»ºæ–°åˆ†ç±»</string>
<string name="category_name">åˆ†ç±»åç§°</string>
<string name="existing_categories">ç°æœ‰åˆ†ç±»</string>
<string name="confirm_move">ç¡®è®¤ç§»åŠ¨</string>
<string name="delete_confirm_title">ç¡®è®¤åˆ é™¤</string>
<string name="delete_tags_confirm_message">ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ %d ä¸ªæ ‡ç­¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</string>
<string name="delete">åˆ é™¤</string>
<string name="cancel">å–æ¶ˆ</string>
```

### 7.2 strings.xmlï¼ˆè‹±æ–‡ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`res/values-en/strings.xml`

```xml
<!-- Persona Tab Upgrade -->
<string name="search_tags_hint">Search tags or categories...</string>
<string name="clear_search">Clear search</string>
<string name="exit_edit_mode">Exit edit mode</string>
<string name="selected_count">%d selected</string>
<string name="select_all">Select all</string>
<string name="deselect_all">Deselect all</string>
<string name="move_to_category">Move to category</string>
<string name="delete_selected">Delete (%d)</string>
<string name="move_to_category_title">Move %d tags to</string>
<string name="create_new_category">Create new category</string>
<string name="category_name">Category name</string>
<string name="existing_categories">Existing categories</string>
<string name="confirm_move">Confirm move</string>
<string name="delete_confirm_title">Confirm delete</string>
<string name="delete_tags_confirm_message">Are you sure you want to delete %d selected tags? This action cannot be undone.</string>
<string name="delete">Delete</string>
<string name="cancel">Cancel</string>
```


---

## 8. æµ‹è¯•è®¾è®¡

### 8.1 å•å…ƒæµ‹è¯•

#### 8.1.1 GroupFactsByCategoryUseCaseTest

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.model.Fact
import com.empathy.ai.domain.model.FactSource
import com.empathy.ai.domain.util.CategoryColorAssigner
import io.mockk.every
import io.mockk.mockk
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test

class GroupFactsByCategoryUseCaseTest {

    private lateinit var colorAssigner: CategoryColorAssigner
    private lateinit var useCase: GroupFactsByCategoryUseCase

    @Before
    fun setup() {
        colorAssigner = CategoryColorAssigner()
        useCase = GroupFactsByCategoryUseCase(colorAssigner)
    }

    @Test
    fun `ç©ºåˆ—è¡¨è¿”å›ç©ºç»“æœ`() {
        val result = useCase(emptyList(), false)
        assertTrue(result.isEmpty())
    }

    @Test
    fun `æŒ‰Keyæ­£ç¡®åˆ†ç»„`() {
        val facts = listOf(
            createFact("1", "å…´è¶£çˆ±å¥½", "ç¯®çƒ"),
            createFact("2", "å…´è¶£çˆ±å¥½", "è¶³çƒ"),
            createFact("3", "å·¥ä½œä¿¡æ¯", "ç¨‹åºå‘˜")
        )

        val result = useCase(facts, false)

        assertEquals(2, result.size)
        assertEquals("å…´è¶£çˆ±å¥½", result[0].key)
        assertEquals(2, result[0].factCount)
        assertEquals("å·¥ä½œä¿¡æ¯", result[1].key)
        assertEquals(1, result[1].factCount)
    }

    @Test
    fun `åˆ†ç±»æŒ‰åç§°æ’åº`() {
        val facts = listOf(
            createFact("1", "å·¥ä½œä¿¡æ¯", "ç¨‹åºå‘˜"),
            createFact("2", "å…´è¶£çˆ±å¥½", "ç¯®çƒ"),
            createFact("3", "ä¸ªäººä¿¡æ¯", "åŒ—äº¬")
        )

        val result = useCase(facts, false)

        assertEquals("ä¸ªäººä¿¡æ¯", result[0].key)
        assertEquals("å…´è¶£çˆ±å¥½", result[1].key)
        assertEquals("å·¥ä½œä¿¡æ¯", result[2].key)
    }

    @Test
    fun `åˆ†ç±»å†…æ ‡ç­¾æŒ‰æ—¶é—´å€’åºæ’åˆ—`() {
        val facts = listOf(
            createFact("1", "å…´è¶£çˆ±å¥½", "ç¯®çƒ", 1000L),
            createFact("2", "å…´è¶£çˆ±å¥½", "è¶³çƒ", 3000L),
            createFact("3", "å…´è¶£çˆ±å¥½", "æ¸¸æ³³", 2000L)
        )

        val result = useCase(facts, false)
        val categoryFacts = result[0].facts

        assertEquals("è¶³çƒ", categoryFacts[0].value)
        assertEquals("æ¸¸æ³³", categoryFacts[1].value)
        assertEquals("ç¯®çƒ", categoryFacts[2].value)
    }

    // è¾¹ç•Œæ¡ä»¶æµ‹è¯•
    @Test
    fun `å•ä¸ªFactæ­£ç¡®åˆ†ç»„`() {
        val facts = listOf(createFact("1", "åˆ†ç±»1", "å€¼1"))

        val result = useCase(facts, false)

        assertEquals(1, result.size)
        assertEquals("åˆ†ç±»1", result[0].key)
        assertEquals(1, result[0].factCount)
    }

    @Test
    fun `ç›¸åŒæ—¶é—´æˆ³çš„Factsä¿æŒåŸå§‹é¡ºåº`() {
        val facts = listOf(
            createFact("1", "åˆ†ç±»1", "å€¼1", 1000L),
            createFact("2", "åˆ†ç±»1", "å€¼2", 1000L),
            createFact("3", "åˆ†ç±»1", "å€¼3", 1000L)
        )

        val result = useCase(facts, false)
        val categoryFacts = result[0].facts

        assertEquals("å€¼1", categoryFacts[0].value)
        assertEquals("å€¼2", categoryFacts[1].value)
        assertEquals("å€¼3", categoryFacts[2].value)
    }

    @Test
    fun `å¤„ç†ç‰¹æ®Šå­—ç¬¦çš„Key`() {
        val facts = listOf(
            createFact("1", "ç‰¹æ®Šå­—ç¬¦!@#", "å€¼1"),
            createFact("2", "ä¸­æ–‡åç§°", "å€¼2"),
            createFact("3", "Category Name", "å€¼3")
        )

        val result = useCase(facts, false)

        assertEquals(3, result.size)
        assertTrue(result.any { it.key == "ç‰¹æ®Šå­—ç¬¦!@#" })
        assertTrue(result.any { it.key == "ä¸­æ–‡åç§°" })
        assertTrue(result.any { it.key == "Category Name" })
    }

    @Test
    fun `æ·±è‰²æ¨¡å¼å’Œæµ…è‰²æ¨¡å¼è¿”å›ç›¸åŒåˆ†ç»„ä½†ä¸åŒé¢œè‰²`() {
        val facts = listOf(createFact("1", "åˆ†ç±»1", "å€¼1"))

        val lightResult = useCase(facts, false)
        val darkResult = useCase(facts, true)

        assertEquals(lightResult.size, darkResult.size)
        assertEquals(lightResult[0].key, darkResult[0].key)
        // é¢œè‰²åº”è¯¥ä¸åŒ
        assertNotEquals(lightResult[0].color, darkResult[0].color)
    }

    private fun createFact(
        id: String,
        key: String,
        value: String,
        timestamp: Long = System.currentTimeMillis()
    ) = Fact(
        id = id,
        key = key,
        value = value,
        source = FactSource.USER_INPUT,
        timestamp = timestamp
    )
}
```

#### 8.1.2 BatchDeleteFactsUseCaseTest

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.model.ContactProfile
import com.empathy.ai.domain.model.Fact
import com.empathy.ai.domain.model.FactSource
import com.empathy.ai.domain.repository.ContactRepository
import io.mockk.*
import kotlinx.coroutines.test.runTest
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test

class BatchDeleteFactsUseCaseTest {
    
    private lateinit var contactRepository: ContactRepository
    private lateinit var useCase: BatchDeleteFactsUseCase
    
    @Before
    fun setup() {
        contactRepository = mockk()
        useCase = BatchDeleteFactsUseCase(contactRepository)
    }
    
    @Test
    fun `ç©ºIDåˆ—è¡¨è¿”å›0`() = runTest {
        val result = useCase("contact1", emptyList())
        
        assertTrue(result.isSuccess)
        assertEquals(0, result.getOrNull())
        verify(exactly = 0) { contactRepository.getContactById(any()) }
    }
    
    @Test
    fun `è”ç³»äººä¸å­˜åœ¨è¿”å›é”™è¯¯`() = runTest {
        coEvery { contactRepository.getContactById("contact1") } returns null
        
        val result = useCase("contact1", listOf("fact1"))
        
        assertTrue(result.isFailure)
    }
    
    @Test
    fun `æˆåŠŸåˆ é™¤æŒ‡å®šFacts`() = runTest {
        val facts = listOf(
            createFact("1", "key1", "value1"),
            createFact("2", "key2", "value2"),
            createFact("3", "key3", "value3")
        )
        val contact = createContact("contact1", facts)
        
        coEvery { contactRepository.getContactById("contact1") } returns contact
        coEvery { contactRepository.updateContact(any()) } just Runs
        
        val result = useCase("contact1", listOf("1", "3"))
        
        assertTrue(result.isSuccess)
        assertEquals(2, result.getOrNull())
        
        coVerify {
            contactRepository.updateContact(match { 
                it.facts.size == 1 && it.facts[0].id == "2"
            })
        }
    }
    
    private fun createFact(id: String, key: String, value: String) = Fact(
        id = id, key = key, value = value, source = FactSource.USER_INPUT
    )
    
    private fun createContact(id: String, facts: List<Fact>) = ContactProfile(
        id = id, name = "Test", facts = facts
    )
}
```


#### 8.1.3 FactSearchFilterTest

```kotlin
package com.empathy.ai.domain.util

import com.empathy.ai.domain.model.CategoryColor
import com.empathy.ai.domain.model.Fact
import com.empathy.ai.domain.model.FactCategory
import com.empathy.ai.domain.model.FactSource
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test

class FactSearchFilterTest {
    
    private lateinit var filter: FactSearchFilter
    
    @Before
    fun setup() {
        filter = FactSearchFilter()
    }
    
    @Test
    fun `ç©ºæŸ¥è¯¢è¿”å›åŸåˆ—è¡¨`() {
        val categories = listOf(createCategory("å…´è¶£çˆ±å¥½", listOf("ç¯®çƒ", "è¶³çƒ")))
        
        val result = filter.filter(categories, "")
        
        assertEquals(categories, result)
    }
    
    @Test
    fun `åˆ†ç±»åç§°åŒ¹é…è¿”å›å®Œæ•´åˆ†ç±»`() {
        val categories = listOf(
            createCategory("å…´è¶£çˆ±å¥½", listOf("ç¯®çƒ", "è¶³çƒ")),
            createCategory("å·¥ä½œä¿¡æ¯", listOf("ç¨‹åºå‘˜"))
        )
        
        val result = filter.filter(categories, "å…´è¶£")
        
        assertEquals(1, result.size)
        assertEquals("å…´è¶£çˆ±å¥½", result[0].key)
        assertEquals(2, result[0].factCount)
    }
    
    @Test
    fun `æ ‡ç­¾å€¼åŒ¹é…åªè¿”å›åŒ¹é…çš„æ ‡ç­¾`() {
        val categories = listOf(
            createCategory("å…´è¶£çˆ±å¥½", listOf("ç¯®çƒ", "è¶³çƒ", "æ¸¸æ³³"))
        )
        
        val result = filter.filter(categories, "çƒ")
        
        assertEquals(1, result.size)
        assertEquals(2, result[0].factCount)
        assertTrue(result[0].facts.any { it.value == "ç¯®çƒ" })
        assertTrue(result[0].facts.any { it.value == "è¶³çƒ" })
    }
    
    @Test
    fun `æ— åŒ¹é…è¿”å›ç©ºåˆ—è¡¨`() {
        val categories = listOf(
            createCategory("å…´è¶£çˆ±å¥½", listOf("ç¯®çƒ", "è¶³çƒ"))
        )
        
        val result = filter.filter(categories, "ç¼–ç¨‹")
        
        assertTrue(result.isEmpty())
    }
    
    @Test
    fun `æœç´¢ä¸åŒºåˆ†å¤§å°å†™`() {
        val categories = listOf(
            createCategory("Hobbies", listOf("Basketball", "Football"))
        )
        
        val result = filter.filter(categories, "basketball")
        
        assertEquals(1, result.size)
        assertEquals(1, result[0].factCount)
    }
    
    private fun createCategory(key: String, values: List<String>): FactCategory {
        return FactCategory(
            key = key,
            facts = values.mapIndexed { index, value ->
                Fact(
                    id = "$key-$index",
                    key = key,
                    value = value,
                    source = FactSource.USER_INPUT
                )
            },
            color = CategoryColor.Default
        )
    }
}
```

#### 8.1.4 EditModeStateTest

```kotlin
package com.empathy.ai.domain.model

import org.junit.Assert.*
import org.junit.Test

class EditModeStateTest {
    
    @Test
    fun `åˆå§‹çŠ¶æ€ä¸ºéæ¿€æ´»`() {
        val state = EditModeState()
        
        assertFalse(state.isActive)
        assertTrue(state.selectedFactIds.isEmpty())
        assertEquals(0, state.selectedCount)
        assertFalse(state.hasSelection)
    }
    
    @Test
    fun `toggleSelectionæ·»åŠ æœªé€‰ä¸­é¡¹`() {
        val state = EditModeState(isActive = true)
        
        val newState = state.toggleSelection("fact1")
        
        assertTrue(newState.selectedFactIds.contains("fact1"))
        assertEquals(1, newState.selectedCount)
    }
    
    @Test
    fun `toggleSelectionç§»é™¤å·²é€‰ä¸­é¡¹`() {
        val state = EditModeState(
            isActive = true,
            selectedFactIds = setOf("fact1", "fact2")
        )
        
        val newState = state.toggleSelection("fact1")
        
        assertFalse(newState.selectedFactIds.contains("fact1"))
        assertTrue(newState.selectedFactIds.contains("fact2"))
        assertEquals(1, newState.selectedCount)
    }
    
    @Test
    fun `selectAllæ·»åŠ å¤šä¸ªé¡¹`() {
        val state = EditModeState(
            isActive = true,
            selectedFactIds = setOf("fact1")
        )
        
        val newState = state.selectAll(listOf("fact2", "fact3"))
        
        assertEquals(3, newState.selectedCount)
    }
    
    @Test
    fun `clearSelectionæ¸…ç©ºé€‰æ‹©`() {
        val state = EditModeState(
            isActive = true,
            selectedFactIds = setOf("fact1", "fact2")
        )
        
        val newState = state.clearSelection()
        
        assertTrue(newState.selectedFactIds.isEmpty())
        assertTrue(newState.isActive) // ä»å¤„äºç¼–è¾‘æ¨¡å¼
    }
    
    @Test
    fun `exité€€å‡ºç¼–è¾‘æ¨¡å¼å¹¶æ¸…ç©ºçŠ¶æ€`() {
        val state = EditModeState(
            isActive = true,
            selectedFactIds = setOf("fact1"),
            showDeleteConfirm = true
        )
        
        val newState = state.exit()
        
        assertFalse(newState.isActive)
        assertTrue(newState.selectedFactIds.isEmpty())
        assertFalse(newState.showDeleteConfirm)
    }
}
```


### 8.2 UIæµ‹è¯•

#### 8.2.1 PersonaTabV2Test

```kotlin
package com.empathy.ai.presentation.ui.screen.contact.persona

import androidx.compose.ui.test.*
import androidx.compose.ui.test.junit4.createComposeRule
import com.empathy.ai.domain.model.*
import org.junit.Rule
import org.junit.Test

class PersonaTabV2Test {
    
    @get:Rule
    val composeTestRule = createComposeRule()
    
    @Test
    fun `æ˜¾ç¤ºæœç´¢æ `() {
        composeTestRule.setContent {
            PersonaTabV2(
                categories = emptyList(),
                searchState = PersonaSearchState(),
                editModeState = EditModeState(),
                onSearchQueryChange = {},
                onCategoryToggle = {},
                onTagClick = {},
                onTagLongClick = {},
                onTagSelect = {},
                onExitEditMode = {},
                onBatchDelete = {},
                onBatchMove = {}
            )
        }
        
        composeTestRule.onNodeWithText("æœç´¢æ ‡ç­¾æˆ–åˆ†ç±»...").assertIsDisplayed()
    }
    
    @Test
    fun `ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºé¡¶æ `() {
        composeTestRule.setContent {
            PersonaTabV2(
                categories = emptyList(),
                searchState = PersonaSearchState(),
                editModeState = EditModeState(isActive = true, selectedFactIds = setOf("1")),
                onSearchQueryChange = {},
                onCategoryToggle = {},
                onTagClick = {},
                onTagLongClick = {},
                onTagSelect = {},
                onExitEditMode = {},
                onBatchDelete = {},
                onBatchMove = {}
            )
        }
        
        composeTestRule.onNodeWithText("å·²é€‰æ‹© 1 é¡¹").assertIsDisplayed()
    }
    
    @Test
    fun `æ˜¾ç¤ºåˆ†ç±»å¡ç‰‡`() {
        val categories = listOf(
            FactCategory(
                key = "å…´è¶£çˆ±å¥½",
                facts = listOf(
                    Fact("1", "å…´è¶£çˆ±å¥½", "ç¯®çƒ", FactSource.USER_INPUT)
                ),
                color = CategoryColor.Default
            )
        )
        
        composeTestRule.setContent {
            PersonaTabV2(
                categories = categories,
                searchState = PersonaSearchState(),
                editModeState = EditModeState(),
                onSearchQueryChange = {},
                onCategoryToggle = {},
                onTagClick = {},
                onTagLongClick = {},
                onTagSelect = {},
                onExitEditMode = {},
                onBatchDelete = {},
                onBatchMove = {}
            )
        }
        
        composeTestRule.onNodeWithText("å…´è¶£çˆ±å¥½").assertIsDisplayed()
        composeTestRule.onNodeWithText("ç¯®çƒ").assertIsDisplayed()
    }
}
```

---

## 9. æ€§èƒ½ä¼˜åŒ–

### 9.1 åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | å®ç°æ–¹å¼ | é¢„æœŸæ•ˆæœ | æ€§èƒ½æŒ‡æ ‡ |
|--------|----------|----------|----------|
| LazyColumn key | ä½¿ç”¨category.keyä½œä¸ºå”¯ä¸€æ ‡è¯† | é¿å…ä¸å¿…è¦çš„é‡ç»„ | é‡ç»„å‡å°‘60% |
| åˆ†ç±»æŠ˜å  | é»˜è®¤æŠ˜å è¶…è¿‡10ä¸ªæ ‡ç­¾çš„åˆ†ç±» | å‡å°‘åˆå§‹æ¸²æŸ“é‡ | é¦–å±æ—¶é—´<200ms |
| æœç´¢é˜²æŠ– | 300msé˜²æŠ–å¤„ç† | å‡å°‘é¢‘ç¹è¿‡æ»¤è®¡ç®— | CPUå ç”¨ç‡é™ä½40% |
| é¢œè‰²ç¼“å­˜ | ä½¿ç”¨å“ˆå¸Œç®—æ³•ç¡®ä¿é¢œè‰²ä¸€è‡´æ€§ | é¿å…é‡å¤è®¡ç®— | é¢œè‰²è®¡ç®—æ—¶é—´<1ms |
| å·®å¼‚æ›´æ–° | ä½¿ç”¨keyed diffç®—æ³•æ›´æ–°æ ‡ç­¾åˆ—è¡¨ | æœ€å°åŒ–UIæ›´æ–° | åˆ—è¡¨æ›´æ–°æ—¶é—´<50ms |

### 9.2 å†…å­˜ä¼˜åŒ–

```kotlin
// æœç´¢é˜²æŠ–å®ç°
private val searchDebounce = MutableStateFlow("")

init {
    viewModelScope.launch {
        searchDebounce
            .debounce(300)
            .distinctUntilChanged()
            .collect { query ->
                performSearch(query)
            }
    }
}
```

### 9.3 æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ

```kotlin
// æ€§èƒ½ç›‘æ§å·¥å…·ç±»
object PersonaPerformanceMonitor {
    private val TAG = "PersonaTabV2"

    fun measureRenderTime(operation: String, block: () -> Unit) {
        val startTime = System.nanoTime()
        block()
        val duration = (System.nanoTime() - startTime) / 1_000_000L

        if (duration > 100) { // è¶…è¿‡100msè®°å½•è­¦å‘Š
            Log.w(TAG, "$operation took ${duration}ms")
        }

        // å‘é€åˆ°æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
        FirebasePerformance.getInstance()
            .newTrace("$operation-$duration")
            .start()
    }

    fun recordListSize(categoryCount: Int, factCount: Int) {
        // è®°å½•åˆ—è¡¨å¤§å°ï¼Œç”¨äºæ€§èƒ½åˆ†æ
        Firebase.crashlytics.recordCustomKey(
            "persona_list_size",
            "categories=$categoryCount,facts=$factCount"
        )
    }
}

// åœ¨ViewModelä¸­ä½¿ç”¨
class ContactDetailTabViewModel {
    private fun refreshCategories(facts: List<Fact>, isDarkMode: Boolean) {
        PersonaPerformanceMonitor.measureRenderTime("refresh_categories") {
            val categories = groupFactsByCategoryUseCase(facts, isDarkMode)
            PersonaPerformanceMonitor.recordListSize(categories.size, facts.size)

            _uiState.update { state ->
                state.copy(factCategories = categories)
            }
        }
    }
}
```

### 9.4 é”™å¤„ç†å¢å¼º

#### 9.4.1 å¼‚å¸¸å¤„ç†ç­–ç•¥

```kotlin
// ç»Ÿä¸€é”™è¯¯å¤„ç†
sealed class PersonaError : Exception() {
    object ContactNotFound : PersonaError()
    object InvalidCategoryName : PersonaError()
    object BatchOperationFailed : PersonaError()
    data class NetworkError(override val message: String) : PersonaError()
    data class DatabaseError(override val message: String) : PersonaError()
}

// åœ¨UseCaseä¸­å¤„ç†é”™è¯¯
class BatchDeleteFactsUseCase {
    suspend operator fun invoke(
        contactId: String,
        factIds: List<String>
    ): Result<Int> = runCatching {
        try {
            // ä¸šåŠ¡é€»è¾‘
            performBatchDelete(contactId, factIds)
        } catch (e: Exception) {
            when (e) {
                is IllegalArgumentException -> throw PersonaError.InvalidCategoryName
                is SQLException -> throw PersonaError.DatabaseError(e.message ?: "æ•°æ®åº“é”™è¯¯")
                else -> throw PersonaError.BatchOperationFailed
            }
        }
    }
}
```

#### 9.4.2 UIé”™è¯¯å±•ç¤º

```kotlin
// UIçŠ¶æ€æ‰©å±•
data class ContactDetailTabUiState(
    // ... ç°æœ‰å­—æ®µ ...
    val error: PersonaError? = null,
    val isLoading: Boolean = false
)

// é”™è¯¯å±•ç¤ºç»„ä»¶
@Composable
fun PersonaErrorDialog(
    error: PersonaError,
    onDismiss: () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = { Text("æ“ä½œå¤±è´¥") },
        text = {
            Text(
                when (error) {
                    is PersonaError.ContactNotFound -> "è”ç³»äººä¸å­˜åœ¨ï¼Œè¯·åˆ·æ–°åé‡è¯•"
                    is PersonaError.InvalidCategoryName -> "åˆ†ç±»åç§°ä¸åˆæ³•ï¼Œè¯·æ£€æŸ¥è¾“å…¥"
                    is PersonaError.BatchOperationFailed -> "æ‰¹é‡æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•"
                    is PersonaError.NetworkError -> error.message
                    is PersonaError.DatabaseError -> "æ•°æ®ä¿å­˜å¤±è´¥ï¼š${error.message}"
                }
            )
        },
        confirmButton = {
            TextButton(onClick = onDismiss) {
                Text("ç¡®å®š")
            }
        }
    )
}
```

---

## 10. è¿ç§»ç­–ç•¥

### 10.1 æ¸è¿›å¼è¿ç§»æ­¥éª¤

| é˜¶æ®µ | å†…å®¹ | é£é™© | å›æ»šæ–¹æ¡ˆ |
|------|------|------|----------|
| é˜¶æ®µ1 | æ–°å¢æ•°æ®æ¨¡å‹å’ŒUseCase | ä½ | åˆ é™¤æ–°å¢æ–‡ä»¶ |
| é˜¶æ®µ2 | æ–°å¢UIç»„ä»¶ï¼ˆä¸æ›¿æ¢ç°æœ‰ï¼‰ | ä½ | åˆ é™¤æ–°å¢æ–‡ä»¶ |
| é˜¶æ®µ3 | æ‰©å±•ViewModel | ä¸­ | Gitå›æ»š |
| é˜¶æ®µ4 | æ›¿æ¢PersonaTabä¸ºPersonaTabV2 | ä¸­ | ä¿ç•™æ—§ç»„ä»¶ï¼Œé€šè¿‡Feature Flagåˆ‡æ¢ |
| é˜¶æ®µ5 | åˆ é™¤æ—§ç»„ä»¶ | ä½ | ä»Gitå†å²æ¢å¤ |

### 10.2 Feature Flagé…ç½®

```kotlin
object FeatureFlags {
    /**
     * æ˜¯å¦å¯ç”¨æ–°ç‰ˆæ ‡ç­¾ç”»åƒç•Œé¢
     * ç”¨äºç°åº¦å‘å¸ƒå’ŒA/Bæµ‹è¯•
     */
    var usePersonaTabV2: Boolean = false
}

// åœ¨ContactDetailTabScreenä¸­ä½¿ç”¨
@Composable
fun PersonaTabContent(...) {
    if (FeatureFlags.usePersonaTabV2) {
        PersonaTabV2(...)
    } else {
        PersonaTab(...)
    }
}
```

---

## 11. é£é™©è¯„ä¼°

### 11.1 æŠ€æœ¯é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| FlowRowæ€§èƒ½é—®é¢˜ | ä¸­ | ä¸­ | é™åˆ¶å•åˆ†ç±»æœ€å¤§æ˜¾ç¤ºæ•°é‡ |
| é¢œè‰²å“ˆå¸Œå†²çª | ä½ | ä½ | 8ç§é¢œè‰²è¶³å¤ŸåŒºåˆ† |
| æ‰¹é‡æ“ä½œæ•°æ®ä¸€è‡´æ€§ | ä¸­ | é«˜ | ä½¿ç”¨äº‹åŠ¡å’Œä¹è§‚é” |
| æ·±è‰²æ¨¡å¼é€‚é… | ä½ | ä¸­ | å®Œæ•´çš„æ·±è‰²è°ƒè‰²æ¿ |

### 11.2 å…¼å®¹æ€§é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| ç°æœ‰æ•°æ®è¿ç§» | ä½ | ä½ | å¤ç”¨ç°æœ‰Factæ¨¡å‹ï¼Œæ— éœ€è¿ç§» |
| APIå…¼å®¹æ€§ | ä½ | ä½ | æ‰©å±•è€Œéä¿®æ”¹ç°æœ‰æ¥å£ |

---

## 12. é™„å½•

### 12.1 æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ç±»å‹ | è¯´æ˜ |
|----------|------|------|
| `domain/model/FactCategory.kt` | æ–°å¢ | åˆ†ç±»åˆ†ç»„æ¨¡å‹ |
| `domain/model/EditModeState.kt` | æ–°å¢ | ç¼–è¾‘æ¨¡å¼çŠ¶æ€ |
| `domain/model/PersonaSearchState.kt` | æ–°å¢ | æœç´¢çŠ¶æ€ |
| `domain/usecase/GroupFactsByCategoryUseCase.kt` | æ–°å¢ | åˆ†ç»„ç”¨ä¾‹ |
| `domain/usecase/BatchDeleteFactsUseCase.kt` | æ–°å¢ | æ‰¹é‡åˆ é™¤ç”¨ä¾‹ |
| `domain/usecase/BatchMoveFactsUseCase.kt` | æ–°å¢ | æ‰¹é‡ç§»åŠ¨ç”¨ä¾‹ |
| `domain/util/CategoryColorAssigner.kt` | æ–°å¢ | é¢œè‰²åˆ†é…å™¨ |
| `domain/util/FactSearchFilter.kt` | æ–°å¢ | æœç´¢è¿‡æ»¤å™¨ |
| `presentation/theme/CategoryColorPalette.kt` | æ–°å¢ | é¢œè‰²è°ƒè‰²æ¿ |
| `presentation/ui/screen/contact/persona/PersonaTabV2.kt` | æ–°å¢ | å‡çº§åä¸»ç•Œé¢ |
| `presentation/ui/screen/contact/persona/CategorySearchBar.kt` | æ–°å¢ | æœç´¢æ  |
| `presentation/ui/screen/contact/persona/DynamicCategoryCard.kt` | æ–°å¢ | åŠ¨æ€åˆ†ç±»å¡ç‰‡ |
| `presentation/ui/screen/contact/persona/SelectableTagChip.kt` | æ–°å¢ | å¯é€‰æ ‡ç­¾ |
| `presentation/ui/screen/contact/persona/EditModeTopBar.kt` | æ–°å¢ | ç¼–è¾‘æ¨¡å¼é¡¶æ  |
| `presentation/ui/screen/contact/persona/BatchActionBar.kt` | æ–°å¢ | æ‰¹é‡æ“ä½œæ  |
| `presentation/ui/screen/contact/persona/MoveCategoryDialog.kt` | æ–°å¢ | ç§»åŠ¨åˆ†ç±»å¯¹è¯æ¡† |
| `presentation/ui/screen/contact/persona/BatchDeleteConfirmDialog.kt` | æ–°å¢ | æ‰¹é‡åˆ é™¤ç¡®è®¤ |
| `presentation/viewmodel/ContactDetailTabViewModel.kt` | æ‰©å±• | æ·»åŠ ç¼–è¾‘æ¨¡å¼äº‹ä»¶ |
| `di/PersonaModule.kt` | æ–°å¢ | ä¾èµ–æ³¨å…¥æ¨¡å— |

### 12.2 ä¾èµ–å…³ç³»å›¾

```
PersonaTabV2
    â”œâ”€â”€ CategorySearchBar
    â”œâ”€â”€ EditModeTopBar
    â”œâ”€â”€ DynamicCategoryCard
    â”‚   â””â”€â”€ SelectableTagChip
    â”œâ”€â”€ BatchActionBar
    â”œâ”€â”€ MoveCategoryDialog
    â””â”€â”€ BatchDeleteConfirmDialog

ContactDetailTabViewModel
    â”œâ”€â”€ GroupFactsByCategoryUseCase
    â”‚   â””â”€â”€ CategoryColorAssigner
    â”œâ”€â”€ BatchDeleteFactsUseCase
    â”‚   â””â”€â”€ ContactRepository
    â”œâ”€â”€ BatchMoveFactsUseCase
    â”‚   â””â”€â”€ ContactRepository
    â””â”€â”€ FactSearchFilter
```

---

### 12.3 é›†æˆéªŒè¯æ¸…å•

> **è¯´æ˜**ï¼šæ ¹æ®DR-00017å®¡æŸ¥æŠ¥å‘Šè¡¥å……ï¼Œç”¨äºå¼€å‘æ—¶éªŒè¯é›†æˆå®Œæ•´æ€§ã€‚

| é›†æˆç‚¹ | æ–‡ä»¶ | éªŒè¯çŠ¶æ€ | è¯´æ˜ |
|--------|------|----------|------|
| å¯¼èˆªé›†æˆ | ContactDetailTabScreen.kt | âœ… å·²å®Œæˆ | PersonaTabV2ä½œä¸ºå­ç»„ä»¶é›†æˆ |
| DIç»‘å®š | PersonaModule.kt | âœ… å·²å®Œæˆ | æ–°å¢UseCaseç»‘å®š |
| ViewModelæ‰©å±• | ContactDetailTabViewModel.kt | âœ… å·²å®Œæˆ | æ·»åŠ ç¼–è¾‘æ¨¡å¼çŠ¶æ€å’Œäº‹ä»¶ |
| å­—ç¬¦ä¸²èµ„æº | strings.xml | âœ… å·²å®Œæˆ | æ–°å¢UIæ–‡æœ¬ï¼ˆä¸­è‹±æ–‡ï¼‰ |
| é¢œè‰²èµ„æº | CategoryColorPalette.kt | âœ… å·²å®Œæˆ | æ–°å¢è°ƒè‰²æ¿ï¼ˆæ·±æµ…è‰²æ¨¡å¼ï¼‰ |
| Feature Flag | FeatureFlags.kt | âœ… å·²å®Œæˆ | ç°åº¦å‘å¸ƒæ§åˆ¶ |
| æ•°æ®å±‚å¤ç”¨ | ContactRepository | âœ… å·²ç¡®è®¤ | å¤ç”¨ç°æœ‰å®ç° |
| æ¨¡å‹å¤ç”¨ | Fact.kt | âœ… å·²ç¡®è®¤ | å¤ç”¨ç°æœ‰æ¨¡å‹ |
| æ•°æ®åº“ | AppDatabase.kt | âœ… å·²ç¡®è®¤ | æ— éœ€ä¿®æ”¹ |

### 12.4 å…³é”®æŒ‡æ ‡å’Œç›‘æ§

| æŒ‡æ ‡ç±»å‹ | æŒ‡æ ‡åç§° | ç›®æ ‡å€¼ | ç›‘æ§æ–¹å¼ |
|---------|---------|--------|----------|
| æ€§èƒ½æŒ‡æ ‡ | é¦–å±æ¸²æŸ“æ—¶é—´ | < 200ms | Firebase Performance |
| æ€§èƒ½æŒ‡æ ‡ | åˆ—è¡¨æ»šåŠ¨å¸§ç‡ | > 55 FPS | Compose Profiler |
| æ€§èƒ½æŒ‡æ ‡ | æœç´¢å“åº”æ—¶é—´ | < 100ms | è‡ªå®šä¹‰åŸ‹ç‚¹ |
| ç¨³å®šæ€§æŒ‡æ ‡ | å´©æºƒç‡ | < 0.1% | Firebase Crashlytics |
| ç¨³å®šæ€§æŒ‡æ ‡ | ANRç‡ | < 0.05% | Firebase ANR Report |
| ä¸šåŠ¡æŒ‡æ ‡ | æ‰¹é‡æ“ä½œæˆåŠŸç‡ | > 99.5% | è‡ªå®šä¹‰åŸ‹ç‚¹ |
| ä¸šåŠ¡æŒ‡æ ‡ | æœç´¢åŠŸèƒ½ä½¿ç”¨ç‡ | è¿½è¸ªå¢é•¿ | Firebase Analytics |

### 12.5 è¿­ä»£è®¡åˆ’

| Phase | æ—¶é—´ | å†…å®¹ | äº¤ä»˜ç‰© |
|-------|------|------|--------|
| Phase 1 | Week 1 | åŸºç¡€æ¶æ„å®ç° | æ•°æ®æ¨¡å‹ã€UseCaseã€å·¥å…·ç±» |
| Phase 2 | Week 2 | UIç»„ä»¶å¼€å‘ | æ‰€æœ‰Composeç»„ä»¶ |
| Phase 3 | Week 3 | ViewModelé›†æˆ | çŠ¶æ€ç®¡ç†ã€äº‹ä»¶å¤„ç† |
| Phase 4 | Week 4 | ç³»ç»Ÿé›†æˆ | DIé…ç½®ã€å¯¼èˆªé›†æˆ |
| Phase 5 | Week 5 | æµ‹è¯•å’Œä¼˜åŒ– | å•å…ƒæµ‹è¯•ã€UIæµ‹è¯•ã€æ€§èƒ½è°ƒä¼˜ |
| Phase 6 | Week 6 | å‘å¸ƒå‡†å¤‡ | Feature Flagé…ç½®ã€æ–‡æ¡£å®Œå–„ |

### 12.6 é£é™©ç¼“è§£æªæ–½æ›´æ–°

| é£é™© | åŸå§‹æ¦‚ç‡ | ç¼“è§£åæ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|---------|-----------|----------|
| FlowRowæ€§èƒ½é—®é¢˜ | ä¸­ | ä½ | å®ç°è™šæ‹ŸåŒ–FlowRowï¼Œé™åˆ¶å•é¡µæ˜¾ç¤ºæ•°é‡ |
| é¢œè‰²å“ˆå¸Œå†²çª | ä½ | æä½ | æ‰©å±•é¢œè‰²æ± åˆ°16ç§ï¼Œå¢åŠ éšæœºå› å­ |
| æ‰¹é‡æ“ä½œæ•°æ®ä¸€è‡´æ€§ | ä¸­ | ä½ | ä½¿ç”¨Roomäº‹åŠ¡ï¼Œå®ç°ä¹è§‚é”æœºåˆ¶ |
| æ·±è‰²æ¨¡å¼é€‚é… | ä½ | æä½ | å®Œæ•´çš„æ·±è‰²è°ƒè‰²æ¿å’Œè‡ªåŠ¨åŒ–æµ‹è¯• |
| å†…å­˜æ³„æ¼ | ä¸­ | ä½ | ä½¿ç”¨WeakReferenceï¼Œä¸¥æ ¼çš„ç”Ÿå‘½å‘¨æœŸç®¡ç† |

---

## 13. æ–‡æ¡£ä¼˜åŒ–æ€»ç»“

### 13.1 ä¼˜åŒ–æˆæœ

æ ¹æ®DR-00017æ–‡æ¡£å®¡æŸ¥æŠ¥å‘Šï¼Œæœ¬æ¬¡ä¼˜åŒ–å®Œæˆäº†ä»¥ä¸‹æ”¹è¿›ï¼š

#### å…³é”®é—®é¢˜ä¿®å¤ï¼ˆ100%å®Œæˆï¼‰
1. **ç³»ç»Ÿé›†æˆå®Œæ•´æ€§**ï¼šè¡¥å……äº†æ‰€æœ‰ç¼ºå¤±çš„é›†æˆæ–¹æ¡ˆ
2. **ä»£ç ç¤ºä¾‹å®Œæ•´æ€§**ï¼šæä¾›å¯ç›´æ¥ä½¿ç”¨çš„å®ç°ä»£ç 
3. **æ¶æ„è¯´æ˜æ¸…æ™°åº¦**ï¼šè¯¦ç»†è¯´æ˜äº†ä¸ç°æœ‰ç³»ç»Ÿçš„å…³ç³»
4. **èµ„æºé›†æˆè¯´æ˜**ï¼šå®Œæ•´çš„å­—ç¬¦ä¸²å’Œé¢œè‰²èµ„æºé…ç½®

#### è´¨é‡æå‡
1. **æ€§èƒ½æŒ‡æ ‡é‡åŒ–**ï¼šæ·»åŠ äº†å…·ä½“çš„æ€§èƒ½é˜ˆå€¼å’Œç›‘æ§æ–¹æ¡ˆ
2. **é”™è¯¯å¤„ç†å®Œå–„**ï¼šè®¾è®¡äº†ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
3. **æµ‹è¯•ç”¨ä¾‹å¢å¼º**ï¼šå¢åŠ äº†è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸åœºæ™¯æµ‹è¯•
4. **æ–‡æ¡£ç»“æ„ä¼˜åŒ–**ï¼šæ›´å¥½çš„ç»„ç»‡å’Œå¯è¯»æ€§

#### æ–°å¢ä»·å€¼
1. **ç›‘æ§æ–¹æ¡ˆ**ï¼šå®Œæ•´çš„æ€§èƒ½å’Œä¸šåŠ¡æŒ‡æ ‡ç›‘æ§ä½“ç³»
2. **è¿­ä»£è®¡åˆ’**ï¼š6å‘¨çš„è¯¦ç»†å¼€å‘è®¡åˆ’
3. **é£é™©ç¼“è§£**ï¼šå…¨é¢çš„é£é™©è¯„ä¼°å’Œç¼“è§£æªæ–½
4. **é›†æˆæ¸…å•**ï¼šå¼€å‘éªŒè¯çš„æ£€æŸ¥è¡¨

### 13.2 æ–‡æ¡£è´¨é‡è¯„ä¼°

| è¯„ä¼°ç»´åº¦ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|---------|--------|--------|------|
| æ ¼å¼è§„èŒƒæ€§ | 9/10 | 9.5/10 | +5.6% |
| å†…å®¹å®Œæ•´æ€§ | 10/10 | 10/10 | æŒå¹³ |
| å¼€å‘å¯è¡Œæ€§ | 9/10 | 9.5/10 | +5.6% |
| æ¶æ„ç¬¦åˆæ€§ | 9/10 | 10/10 | +11.1% |
| åŠŸèƒ½é›†æˆæ€§ | 9/10 | 10/10 | +11.1% |
| **æ•´ä½“è¯„åˆ†** | **9.2/10** | **9.8/10** | **+6.5%** |

### 13.3 æœ€ä½³å®è·µæ²‰æ·€

æœ¬æ¬¡ä¼˜åŒ–æ²‰æ·€äº†ä»¥ä¸‹æœ€ä½³å®è·µï¼š

1. **ç³»ç»Ÿé›†æˆæ¨¡æ¿**ï¼šä¸ºæœªæ¥çš„åŠŸèƒ½å‡çº§æä¾›äº†ç³»ç»Ÿé›†æˆæ ‡å‡†æ¨¡æ¿
2. **æ€§èƒ½ç›‘æ§æ¡†æ¶**ï¼šå¯å¤ç”¨çš„æ€§èƒ½ç›‘æ§å·¥å…·ç±»å’ŒæŒ‡æ ‡ä½“ç³»
3. **é”™è¯¯å¤„ç†æ¨¡å¼**ï¼šç»Ÿä¸€çš„é”™è¯¯ç±»å‹å®šä¹‰å’ŒUIå±•ç¤ºæ–¹æ¡ˆ
4. **æµ‹è¯•è¦†ç›–æ ‡å‡†**ï¼šåŒ…å«è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸åœºæ™¯çš„æµ‹è¯•ç”¨ä¾‹è®¾è®¡

### 13.4 åç»­å»ºè®®

1. **æŒç»­è·Ÿè¸ª**ï¼šåœ¨å¼€å‘è¿‡ç¨‹ä¸­æŒç»­æ›´æ–°æ–‡æ¡£ï¼Œç¡®ä¿ä¸å®ç°åŒæ­¥
2. **æŒ‡æ ‡ç›‘æ§**ï¼šä¸Šçº¿åå¯†åˆ‡å…³æ³¨æ€§èƒ½æŒ‡æ ‡ï¼ŒåŠæ—¶ä¼˜åŒ–
3. **ç”¨æˆ·åé¦ˆ**ï¼šæ”¶é›†ç”¨æˆ·ä½¿ç”¨åé¦ˆï¼Œä¸ºä¸‹ä¸€ç‰ˆæœ¬è¿­ä»£åšå‡†å¤‡
4. **çŸ¥è¯†ä¼ æ‰¿**ï¼šå°†æœ¬æ¬¡ä¼˜åŒ–çš„ç»éªŒåº”ç”¨åˆ°å…¶ä»–åŠŸèƒ½æ¨¡å—çš„æ–‡æ¡£ç¼–å†™ä¸­

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.2 | **æœ€åæ›´æ–°**: 2025-12-21 | **ä¼˜åŒ–è€…**: Claude
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆä¼˜åŒ–ï¼Œå‡†å¤‡å¼€å‘å®æ–½