# TDD-00015: æç¤ºè¯è®¾ç½®ä¼˜åŒ–æŠ€æœ¯è®¾è®¡

## 1. æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç±»å‹ | TDD (Technical Design Document) |
| æ–‡æ¡£ç¼–å· | TDD-00015 |
| åŠŸèƒ½åç§° | æç¤ºè¯è®¾ç½®ä¼˜åŒ–æŠ€æœ¯è®¾è®¡ |
| ç‰ˆæœ¬ | 1.0 |
| åˆ›å»ºæ—¥æœŸ | 2025-12-22 |
| æœ€åæ›´æ–° | 2025-12-22 |
| ä½œè€… | Kiro |
| å®¡æ ¸äºº | å¾…å®¡æ ¸ |
| å®¡æ ¸çŠ¶æ€ | å¾…å®¡æ ¸ |
| å…³è”æ–‡æ¡£ | PRD-00015, FD-00015, TDD-00005, TDD-00006 |

### 1.1 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-22 | Kiro | åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«åœºæ™¯ç®€åŒ–ã€æ•°æ®è¿ç§»ã€UIä¼˜åŒ–çš„å®Œæ•´æŠ€æœ¯è®¾è®¡ |

### 1.2 æŠ€æœ¯æ ˆ

| æŠ€æœ¯é¢†åŸŸ | æŠ€æœ¯é€‰æ‹© | ç‰ˆæœ¬ | ç”¨é€” |
|---------|----------|------|------|
| UIæ¡†æ¶ | Jetpack Compose | BOM 2024.12.01 | å£°æ˜å¼UI |
| è®¾è®¡ç³»ç»Ÿ | Material 3 | 1.3.1 | UIç»„ä»¶å’Œä¸»é¢˜ |
| ä¾èµ–æ³¨å…¥ | Hilt | 2.52 | ä¾èµ–ç®¡ç† |
| JSONåºåˆ—åŒ– | Moshi | 1.15.1 | é…ç½®æ–‡ä»¶è§£æ |
| å¼‚æ­¥å¤„ç† | Kotlin Coroutines | 1.9.0 | å¼‚æ­¥æ“ä½œ |
| æ•°æ®åº“ | Room | 2.6.1 | æœ¬åœ°å­˜å‚¨ |

---

## 2. æ¶æ„æ¦‚è¿°

### 2.1 è®¾è®¡ç›®æ ‡

å°†å½“å‰6ä¸ªæç¤ºè¯åœºæ™¯ç®€åŒ–ä¸º4ä¸ªæ ¸å¿ƒåœºæ™¯ï¼Œä¼˜åŒ–è®¾ç½®ç•Œé¢å±•ç¤ºï¼Œç¡®ä¿æ•°æ®è¿ç§»å¹³æ»‘ã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
- ç®€åŒ–åœºæ™¯ï¼š6ä¸ª â†’ 4ä¸ªï¼ˆANALYZEã€POLISHã€REPLYã€SUMMARYï¼‰
- åºŸå¼ƒåœºæ™¯ï¼šCHECKï¼ˆåˆå¹¶åˆ°POLISHï¼‰ã€EXTRACTï¼ˆéšè—ä¸å±•ç¤ºï¼‰
- ä¼˜åŒ–UIï¼šè®¾ç½®ç•Œé¢åªæ˜¾ç¤º4ä¸ªæ ¸å¿ƒåœºæ™¯
- æ•°æ®è¿ç§»ï¼šå¹³æ»‘è¿ç§»ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯

### 2.2 è®¾è®¡åŸåˆ™

- **å‘åå…¼å®¹**ï¼šåºŸå¼ƒåœºæ™¯ä¿ç•™ä»£ç ï¼Œç¡®ä¿æ—§æ•°æ®ä¸ä¸¢å¤±
- **å¹³æ»‘è¿ç§»**ï¼šè‡ªåŠ¨åˆå¹¶CHECKè‡ªå®šä¹‰å†…å®¹åˆ°POLISH
- **æœ€å°æ”¹åŠ¨**ï¼šå¤ç”¨ç°æœ‰ç»„ä»¶ï¼Œå‡å°‘ä»£ç å˜æ›´
- **ç”¨æˆ·æ— æ„Ÿ**ï¼šè¿ç§»è¿‡ç¨‹å¯¹ç”¨æˆ·é€æ˜


---

## 3. æ•´ä½“æ¶æ„è®¾è®¡

### 3.1 åœºæ™¯å˜æ›´æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å˜æ›´å‰ï¼ˆ6ä¸ªåœºæ™¯ï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ ANALYZE  â”‚ â”‚  CHECK   â”‚ â”‚ EXTRACT  â”‚                    â”‚
â”‚  â”‚ èŠå¤©åˆ†æ â”‚ â”‚ å®‰å…¨æ£€æŸ¥ â”‚ â”‚ ä¿¡æ¯æå– â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ SUMMARY  â”‚ â”‚  POLISH  â”‚ â”‚  REPLY   â”‚                    â”‚
â”‚  â”‚ æ¯æ—¥æ€»ç»“ â”‚ â”‚ æ¶¦è‰²ä¼˜åŒ– â”‚ â”‚ ç”Ÿæˆå›å¤ â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ è¿ç§»
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å˜æ›´åï¼ˆ4ä¸ªåœºæ™¯ï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ ANALYZE  â”‚ â”‚  POLISH  â”‚ â”‚  REPLY   â”‚ â”‚ SUMMARY  â”‚       â”‚
â”‚  â”‚ èŠå¤©åˆ†æ â”‚ â”‚ æ¶¦è‰²ä¼˜åŒ– â”‚ â”‚ ç”Ÿæˆå›å¤ â”‚ â”‚ æ¯æ—¥æ€»ç»“ â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                             â”‚
â”‚  âŒ CHECKï¼ˆåºŸå¼ƒï¼ŒåŠŸèƒ½åˆå¹¶åˆ°POLISHï¼‰                          â”‚
â”‚  âŒ EXTRACTï¼ˆåºŸå¼ƒï¼Œä¸åœ¨è®¾ç½®ç•Œé¢å±•ç¤ºï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¨¡å—å½±å“èŒƒå›´

```
domain/
â”œâ”€â”€ model/
â”‚   â””â”€â”€ PromptScene.kt              # ğŸ”„ æ›´æ–°ï¼šæ·»åŠ åºŸå¼ƒæ ‡è®°å’Œè¿‡æ»¤æ–¹æ³•
â”œâ”€â”€ util/
â”‚   â”œâ”€â”€ SystemPrompts.kt            # ğŸ”„ æ›´æ–°ï¼šä¼˜åŒ–4ä¸ªæ ¸å¿ƒåœºæ™¯æç¤ºè¯
â”‚   â””â”€â”€ DefaultPrompts.kt           # ğŸ”„ æ›´æ–°ï¼šä¼˜åŒ–é»˜è®¤æç¤ºè¯æ¨¡æ¿

data/
â”œâ”€â”€ local/
â”‚   â”œâ”€â”€ PromptFileStorage.kt        # ğŸ”„ æ›´æ–°ï¼šæ·»åŠ è¿ç§»é€»è¾‘
â”‚   â””â”€â”€ GlobalPromptConfig.kt       # ğŸ”„ æ›´æ–°ï¼šæ·»åŠ ç‰ˆæœ¬å­—æ®µ

presentation/
â”œâ”€â”€ ui/screen/settings/
â”‚   â””â”€â”€ SettingsScreen.kt           # ğŸ”„ æ›´æ–°ï¼šåªæ˜¾ç¤º4ä¸ªæ ¸å¿ƒåœºæ™¯
â””â”€â”€ viewmodel/
    â””â”€â”€ SettingsViewModel.kt        # ğŸ”„ æ›´æ–°ï¼šè¿‡æ»¤åºŸå¼ƒåœºæ™¯
```

### 3.3 æ•°æ®æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Settings Screen                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              PromptSettingsSection                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ ANALYZE â”‚ â”‚ POLISH  â”‚ â”‚  REPLY  â”‚ â”‚ SUMMARY â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚           â”‚           â”‚           â”‚
           â†“           â†“           â†“           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SettingsViewModel                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  promptScenesOrdered: List<PromptScene>              â”‚   â”‚
â”‚  â”‚  = [ANALYZE, POLISH, REPLY, SUMMARY]                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PromptScene.getSettingsScenes()             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è¿‡æ»¤æ¡ä»¶: showInSettings == true                    â”‚   â”‚
â”‚  â”‚  è¿”å›: [ANALYZE, POLISH, REPLY, SUMMARY]             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. è¯¦ç»†è®¾è®¡

### 4.1 æ•°æ®æ¨¡å‹å˜æ›´

#### 4.1.1 PromptSceneæšä¸¾æ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/PromptScene.kt`

```kotlin
/**
 * æç¤ºè¯åœºæ™¯æšä¸¾
 *
 * å®šä¹‰åº”ç”¨ä¸­ä½¿ç”¨AIçš„å„ç§åœºæ™¯ï¼Œæ¯ä¸ªåœºæ™¯æœ‰ä¸åŒçš„å¯ç”¨å˜é‡
 *
 * @property displayName åœºæ™¯æ˜¾ç¤ºåç§°
 * @property description åœºæ™¯æè¿°
 * @property availableVariables è¯¥åœºæ™¯å¯ç”¨çš„å˜é‡åˆ—è¡¨
 * @property isDeprecated æ˜¯å¦å·²åºŸå¼ƒ
 * @property showInSettings æ˜¯å¦åœ¨è®¾ç½®ç•Œé¢æ˜¾ç¤º
 *
 * @see PRD-00015 æç¤ºè¯è®¾ç½®ä¼˜åŒ–éœ€æ±‚
 * @see FD-00015 æç¤ºè¯è®¾ç½®ä¼˜åŒ–åŠŸèƒ½è®¾è®¡
 */
enum class PromptScene(
    val displayName: String,
    val description: String,
    val availableVariables: List<String>,
    val isDeprecated: Boolean = false,
    val showInSettings: Boolean = true
) {
    /**
     * èŠå¤©åˆ†æåœºæ™¯ - åˆ†æèŠå¤©ä¸Šä¸‹æ–‡ï¼Œæä¾›æ²Ÿé€šå»ºè®®
     */
    ANALYZE(
        displayName = "èŠå¤©åˆ†æ",
        description = "åˆ†æèŠå¤©ä¸Šä¸‹æ–‡ï¼Œæä¾›æ²Ÿé€šå»ºè®®",
        availableVariables = listOf(
            "contact_name",
            "relationship_status",
            "risk_tags",
            "strategy_tags",
            "facts_count"
        ),
        isDeprecated = false,
        showInSettings = true
    ),

    /**
     * å®‰å…¨æ£€æŸ¥åœºæ™¯ - æ£€æŸ¥è‰ç¨¿å†…å®¹æ˜¯å¦è§¦å‘é£é™©è§„åˆ™
     *
     * @deprecated ä½¿ç”¨ POLISH æ›¿ä»£ï¼Œé£é™©æ£€æŸ¥å·²åˆå¹¶åˆ°æ¶¦è‰²åŠŸèƒ½
     */
    @Deprecated("ä½¿ç”¨ POLISH æ›¿ä»£ï¼Œé£é™©æ£€æŸ¥å·²åˆå¹¶åˆ°æ¶¦è‰²åŠŸèƒ½")
    CHECK(
        displayName = "å®‰å…¨æ£€æŸ¥",
        description = "æ£€æŸ¥è‰ç¨¿å†…å®¹æ˜¯å¦è§¦å‘é£é™©è§„åˆ™",
        availableVariables = listOf("contact_name", "risk_tags"),
        isDeprecated = true,
        showInSettings = false
    ),

    /**
     * ä¿¡æ¯æå–åœºæ™¯ - ä»æ–‡æœ¬ä¸­æå–å…³é”®ä¿¡æ¯
     *
     * @deprecated æš‚ä¸åœ¨è®¾ç½®ç•Œé¢å±•ç¤º
     */
    @Deprecated("æš‚ä¸åœ¨è®¾ç½®ç•Œé¢å±•ç¤º")
    EXTRACT(
        displayName = "ä¿¡æ¯æå–",
        description = "ä»æ–‡æœ¬ä¸­æå–å…³é”®ä¿¡æ¯",
        availableVariables = listOf("contact_name"),
        isDeprecated = true,
        showInSettings = false
    ),

    /**
     * æ¯æ—¥æ€»ç»“åœºæ™¯ - ç”Ÿæˆæ¯æ—¥å¯¹è¯æ€»ç»“
     */
    SUMMARY(
        displayName = "æ¯æ—¥æ€»ç»“",
        description = "ç”Ÿæˆæ¯æ—¥å¯¹è¯æ€»ç»“",
        availableVariables = listOf(
            "contact_name",
            "relationship_status",
            "facts_count",
            "today_date"
        ),
        isDeprecated = false,
        showInSettings = true
    ),

    /**
     * æ¶¦è‰²ä¼˜åŒ–åœºæ™¯ - ä¼˜åŒ–ç”¨æˆ·è‰ç¨¿ï¼Œä½¿è¡¨è¾¾æ›´å¾—ä½“
     *
     * æ›¿ä»£åŸæœ‰çš„ CHECK åœºæ™¯ï¼ŒåŒæ—¶åŒ…å«é£é™©æ£€æŸ¥åŠŸèƒ½
     */
    POLISH(
        displayName = "æ¶¦è‰²ä¼˜åŒ–",
        description = "ä¼˜åŒ–ç”¨æˆ·è‰ç¨¿ï¼Œä½¿è¡¨è¾¾æ›´å¾—ä½“",
        availableVariables = listOf(
            "contact_name",
            "relationship_status",
            "risk_tags"
        ),
        isDeprecated = false,
        showInSettings = true
    ),

    /**
     * ç”Ÿæˆå›å¤åœºæ™¯ - æ ¹æ®å¯¹æ–¹æ¶ˆæ¯ç”Ÿæˆåˆé€‚çš„å›å¤
     */
    REPLY(
        displayName = "ç”Ÿæˆå›å¤",
        description = "æ ¹æ®å¯¹æ–¹æ¶ˆæ¯ç”Ÿæˆåˆé€‚çš„å›å¤",
        availableVariables = listOf(
            "contact_name",
            "relationship_status",
            "risk_tags",
            "strategy_tags"
        ),
        isDeprecated = false,
        showInSettings = true
    );

    companion object {
        /**
         * è·å–åœ¨è®¾ç½®ç•Œé¢æ˜¾ç¤ºçš„åœºæ™¯åˆ—è¡¨
         * @return å¯åœ¨è®¾ç½®ç•Œé¢é…ç½®çš„åœºæ™¯åˆ—è¡¨
         */
        fun getSettingsScenes(): List<PromptScene> {
            return entries.filter { it.showInSettings }
        }

        /**
         * è·å–æ´»è·ƒï¼ˆéåºŸå¼ƒï¼‰çš„åœºæ™¯åˆ—è¡¨
         * @return æ´»è·ƒåœºæ™¯åˆ—è¡¨
         */
        fun getActiveScenes(): List<PromptScene> {
            return entries.filter { !it.isDeprecated }
        }

        /**
         * è®¾ç½®ç•Œé¢åœºæ™¯æ˜¾ç¤ºé¡ºåº
         */
        val SETTINGS_SCENE_ORDER = listOf(ANALYZE, POLISH, REPLY, SUMMARY)

        /**
         * ä» ActionType è·å–å¯¹åº”çš„ PromptScene
         *
         * @param actionType æ“ä½œç±»å‹
         * @return å¯¹åº”çš„æç¤ºè¯åœºæ™¯
         */
        fun fromActionType(actionType: ActionType): PromptScene = when (actionType) {
            ActionType.ANALYZE -> ANALYZE
            ActionType.POLISH -> POLISH
            ActionType.REPLY -> REPLY
            @Suppress("DEPRECATION")
            ActionType.CHECK -> POLISH  // CHECKæ˜ å°„åˆ°POLISH
        }
    }
}
```


#### 4.1.2 GlobalPromptConfigæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/GlobalPromptConfig.kt`

```kotlin
/**
 * å…¨å±€æç¤ºè¯é…ç½®
 *
 * @property version é…ç½®ç‰ˆæœ¬å·ï¼Œç”¨äºæ•°æ®è¿ç§»
 * @property prompts å„åœºæ™¯çš„æç¤ºè¯é…ç½®
 * @property lastModified æœ€åä¿®æ”¹æ—¶é—´
 */
data class GlobalPromptConfig(
    val version: Int = CURRENT_VERSION,
    val prompts: Map<PromptScene, ScenePromptConfig> = emptyMap(),
    val lastModified: Long = System.currentTimeMillis()
) {
    companion object {
        /**
         * å½“å‰é…ç½®ç‰ˆæœ¬
         * - v1: åˆå§‹ç‰ˆæœ¬ï¼Œ6ä¸ªåœºæ™¯
         * - v2: ç®€åŒ–ä¸º4ä¸ªåœºæ™¯ï¼ŒCHECKåˆå¹¶åˆ°POLISH
         */
        const val CURRENT_VERSION = 2

        /**
         * åˆ›å»ºé»˜è®¤é…ç½®
         */
        fun createDefault(): GlobalPromptConfig {
            val defaultPrompts = PromptScene.getActiveScenes().associateWith { scene ->
                ScenePromptConfig(
                    userPrompt = DefaultPrompts.getDefault(scene),
                    enabled = true
                )
            }
            return GlobalPromptConfig(
                version = CURRENT_VERSION,
                prompts = defaultPrompts
            )
        }
    }
}

/**
 * åœºæ™¯æç¤ºè¯é…ç½®
 *
 * @property userPrompt ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯
 * @property enabled æ˜¯å¦å¯ç”¨
 * @property history å†å²è®°å½•ï¼ˆæœ€å¤šä¿ç•™3æ¡ï¼‰
 */
data class ScenePromptConfig(
    val userPrompt: String = "",
    val enabled: Boolean = true,
    val history: List<PromptHistoryItem> = emptyList()
)
```

---

### 4.2 æ•°æ®è¿ç§»è®¾è®¡

#### 4.2.1 è¿ç§»ç­–ç•¥

| åœºæ™¯ | è¿ç§»ç­–ç•¥ | è¯´æ˜ |
|------|----------|------|
| CHECK | åˆå¹¶åˆ°POLISH | å¦‚æœç”¨æˆ·è‡ªå®šä¹‰äº†CHECKæç¤ºè¯ï¼Œè¿½åŠ åˆ°POLISH |
| EXTRACT | ä¿ç•™ä½†éšè— | æ•°æ®ä¿ç•™ï¼Œä½†ä¸åœ¨è®¾ç½®ç•Œé¢æ˜¾ç¤º |
| å…¶ä»–åœºæ™¯ | æ— å˜æ›´ | ä¿æŒåŸæœ‰æ•°æ® |

#### 4.2.2 PromptFileStorageè¿ç§»é€»è¾‘

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/PromptFileStorage.kt`

```kotlin
@Singleton
class PromptFileStorage @Inject constructor(
    @ApplicationContext private val context: Context,
    private val moshi: Moshi
) {
    companion object {
        private const val TAG = "PromptFileStorage"
        private const val PROMPTS_DIR = "prompts"
        private const val GLOBAL_PROMPTS_FILE = "global_prompts.json"
        private const val CURRENT_MIGRATION_VERSION = 2
    }

    private val promptsDir: File by lazy {
        File(context.filesDir, PROMPTS_DIR).also { it.mkdirs() }
    }

    private val globalPromptsFile: File by lazy {
        File(promptsDir, GLOBAL_PROMPTS_FILE)
    }

    private val adapter: JsonAdapter<GlobalPromptConfig> by lazy {
        moshi.adapter(GlobalPromptConfig::class.java)
    }

    /**
     * è¯»å–å…¨å±€é…ç½®ï¼ˆåŒ…å«è¿ç§»é€»è¾‘ï¼‰
     */
    suspend fun readGlobalConfig(): Result<GlobalPromptConfig> = withContext(Dispatchers.IO) {
        try {
            if (!globalPromptsFile.exists()) {
                val defaultConfig = GlobalPromptConfig.createDefault()
                writeGlobalConfig(defaultConfig)
                return@withContext Result.success(defaultConfig)
            }

            val json = globalPromptsFile.readText(Charsets.UTF_8)
            val config = adapter.fromJson(json)
                ?: return@withContext Result.failure(Exception("è§£æé…ç½®æ–‡ä»¶å¤±è´¥"))

            // æ‰§è¡Œè¿ç§»
            val migratedConfig = migrateIfNeeded(config)
            if (migratedConfig != config) {
                Log.i(TAG, "é…ç½®å·²è¿ç§»: v${config.version} -> v${migratedConfig.version}")
                writeGlobalConfig(migratedConfig)
            }

            Result.success(migratedConfig)
        } catch (e: Exception) {
            Log.e(TAG, "è¯»å–é…ç½®å¤±è´¥", e)
            Result.failure(e)
        }
    }

    /**
     * æ‰§è¡Œå¿…è¦çš„è¿ç§»
     */
    private fun migrateIfNeeded(config: GlobalPromptConfig): GlobalPromptConfig {
        if (config.version >= CURRENT_MIGRATION_VERSION) {
            return config
        }

        var migratedConfig = config

        // è¿ç§»ç‰ˆæœ¬1 -> 2ï¼šåˆå¹¶CHECKåˆ°POLISH
        if (config.version < 2) {
            migratedConfig = migrateCheckToPolish(migratedConfig)
            Log.i(TAG, "æ‰§è¡Œè¿ç§» v1 -> v2: CHECKåˆå¹¶åˆ°POLISH")
        }

        return migratedConfig.copy(version = CURRENT_MIGRATION_VERSION)
    }

    /**
     * å°†CHECKåœºæ™¯çš„è‡ªå®šä¹‰æç¤ºè¯åˆå¹¶åˆ°POLISH
     */
    @Suppress("DEPRECATION")
    private fun migrateCheckToPolish(config: GlobalPromptConfig): GlobalPromptConfig {
        val checkConfig = config.prompts[PromptScene.CHECK]
        val polishConfig = config.prompts[PromptScene.POLISH]

        // å¦‚æœCHECKæœ‰è‡ªå®šä¹‰å†…å®¹ä¸”ä¸æ˜¯é»˜è®¤å€¼
        if (checkConfig != null &&
            checkConfig.userPrompt.isNotBlank() &&
            checkConfig.userPrompt != DefaultPrompts.getDefault(PromptScene.CHECK)
        ) {
            // åˆå¹¶åˆ°POLISH
            val mergedPrompt = buildString {
                append(polishConfig?.userPrompt ?: DefaultPrompts.getDefault(PromptScene.POLISH))
                appendLine()
                appendLine()
                appendLine("ã€åŸå®‰å…¨æ£€æŸ¥æŒ‡ä»¤ï¼ˆå·²åˆå¹¶ï¼‰ã€‘")
                append(checkConfig.userPrompt)
            }

            val updatedPolishConfig = (polishConfig ?: ScenePromptConfig(
                userPrompt = DefaultPrompts.getDefault(PromptScene.POLISH),
                enabled = true
            )).copy(userPrompt = mergedPrompt)

            Log.i(TAG, "CHECKè‡ªå®šä¹‰å†…å®¹å·²åˆå¹¶åˆ°POLISH")
            return config.copy(
                prompts = config.prompts + (PromptScene.POLISH to updatedPolishConfig)
            )
        }

        return config
    }

    /**
     * å†™å…¥å…¨å±€é…ç½®
     */
    suspend fun writeGlobalConfig(config: GlobalPromptConfig): Result<Unit> = 
        withContext(Dispatchers.IO) {
            try {
                val json = adapter.toJson(config)
                globalPromptsFile.writeText(json, Charsets.UTF_8)
                Result.success(Unit)
            } catch (e: Exception) {
                Log.e(TAG, "å†™å…¥é…ç½®å¤±è´¥", e)
                Result.failure(e)
            }
        }
}
```


---

### 4.3 ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–

#### 4.3.1 SystemPromptsæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`domain/util/SystemPrompts.kt`

```kotlin
object SystemPrompts {

    /**
     * è·å–åœºæ™¯çš„ç³»ç»Ÿå¤´éƒ¨ï¼ˆè§’è‰²å®šä¹‰å’Œä»»åŠ¡è¯´æ˜ï¼‰
     */
    fun getHeader(scene: PromptScene): String = when (scene) {
        PromptScene.ANALYZE -> """
            |ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¤¾äº¤æ²Ÿé€šåˆ†æåŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯åˆ†æç”¨æˆ·æä¾›çš„èŠå¤©è®°å½•ï¼Œç†è§£å¯¹è¯åŒæ–¹çš„æƒ…ç»ªå’Œæ„å›¾ï¼Œ
            |å¹¶ç»™å‡ºå…·ä½“ã€å¯æ“ä½œçš„æ²Ÿé€šå»ºè®®ã€‚
            |
            |ã€è”ç³»äººä¿¡æ¯ã€‘
            |å§“åï¼š{{contact_name}}
            |å…³ç³»çŠ¶æ€ï¼š{{relationship_status}}
            |é›·åŒºæ ‡ç­¾ï¼š{{risk_tags}}
            |ç­–ç•¥æ ‡ç­¾ï¼š{{strategy_tags}}
            |å·²è®°å½•äº‹å®æ•°ï¼š{{facts_count}}
        """.trimMargin()

        PromptScene.POLISH -> """
            |ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡å­—æ¶¦è‰²å’Œé£é™©æ£€æµ‹åŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯ï¼š
            |1. ä¼˜åŒ–ç”¨æˆ·å‡†å¤‡å‘é€çš„æ¶ˆæ¯ï¼Œä½¿è¡¨è¾¾æ›´å¾—ä½“ã€æ›´æœ‰æ•ˆ
            |2. æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å¯èƒ½è§¦å‘å¯¹æ–¹çš„æ•æ„Ÿç‚¹æˆ–é›·åŒº
            |
            |ã€è”ç³»äººä¿¡æ¯ã€‘
            |å§“åï¼š{{contact_name}}
            |å…³ç³»çŠ¶æ€ï¼š{{relationship_status}}
            |é›·åŒºæ ‡ç­¾ï¼š{{risk_tags}}
        """.trimMargin()

        PromptScene.REPLY -> """
            |ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¤¾äº¤å›å¤ç”ŸæˆåŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®å¯¹æ–¹å‘é€çš„æ¶ˆæ¯ï¼Œç”Ÿæˆåˆé€‚çš„å›å¤å»ºè®®ã€‚
            |å›å¤åº”è¯¥è‡ªç„¶ã€çœŸè¯šï¼ŒåŒæ—¶é¿å…è§¦å‘å¯¹æ–¹çš„æ•æ„Ÿç‚¹ã€‚
            |
            |ã€è”ç³»äººä¿¡æ¯ã€‘
            |å§“åï¼š{{contact_name}}
            |å…³ç³»çŠ¶æ€ï¼š{{relationship_status}}
            |é›·åŒºæ ‡ç­¾ï¼š{{risk_tags}}
            |ç­–ç•¥æ ‡ç­¾ï¼š{{strategy_tags}}
        """.trimMargin()

        PromptScene.SUMMARY -> """
            |ä½ æ˜¯ä¸€ä¸ªå¯¹è¯æ€»ç»“åŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯åˆ†æä»Šæ—¥çš„å¯¹è¯è®°å½•ï¼Œç”Ÿæˆç®€æ´çš„æ€»ç»“æŠ¥å‘Šï¼Œ
            |æå–æ–°å‘ç°çš„äº‹å®ä¿¡æ¯ï¼Œå¹¶è¯„ä¼°å…³ç³»å˜åŒ–è¶‹åŠ¿ã€‚
            |
            |ã€è”ç³»äººä¿¡æ¯ã€‘
            |å§“åï¼š{{contact_name}}
            |å…³ç³»çŠ¶æ€ï¼š{{relationship_status}}
            |å·²è®°å½•äº‹å®æ•°ï¼š{{facts_count}}
            |ä»Šæ—¥æ—¥æœŸï¼š{{today_date}}
        """.trimMargin()

        // åºŸå¼ƒåœºæ™¯ä¿æŒåŸæœ‰å®ç°ä»¥ç¡®ä¿å…¼å®¹æ€§
        @Suppress("DEPRECATION")
        PromptScene.CHECK -> """
            |ä½ æ˜¯ä¸€ä¸ªæ•æ„Ÿè¯é¢˜æ£€æµ‹åŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯æ£€æŸ¥ç”¨æˆ·å‡†å¤‡å‘é€çš„æ¶ˆæ¯ï¼Œåˆ¤æ–­æ˜¯å¦å¯èƒ½è§¦å‘å¯¹æ–¹çš„æ•æ„Ÿç‚¹æˆ–é›·åŒºã€‚
        """.trimMargin()

        @Suppress("DEPRECATION")
        PromptScene.EXTRACT -> """
            |ä½ æ˜¯ä¸€ä¸ªä¿¡æ¯æå–åŠ©æ‰‹ã€‚
            |ä½ çš„ä»»åŠ¡æ˜¯ä»å¯¹è¯æ–‡æœ¬ä¸­æå–å…³é”®çš„ä¸ªäººä¿¡æ¯ã€åå¥½å’Œé‡è¦äº‹ä»¶ã€‚
        """.trimMargin()
    }

    /**
     * è·å–åœºæ™¯çš„ç³»ç»Ÿå°¾éƒ¨ï¼ˆè¾“å‡ºæ ¼å¼çº¦æŸï¼‰
     */
    fun getFooter(scene: PromptScene): String = when (scene) {
        PromptScene.ANALYZE -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦æ·»åŠ ä»»ä½•é¢å¤–å†…å®¹ï¼š
            |{
            |  "riskLevel": "SAFE|WARNING|DANGER",
            |  "emotionAnalysis": "å¯¹æ–¹æƒ…ç»ªåˆ†æ",
            |  "intentAnalysis": "å¯¹æ–¹æ„å›¾åˆ†æ",
            |  "strategyAnalysis": "æ²Ÿé€šç­–ç•¥å»ºè®®",
            |  "replySuggestion": "å…·ä½“å›å¤å»ºè®®æ–‡æœ¬",
            |  "riskPoints": ["é£é™©ç‚¹1", "é£é™©ç‚¹2"]
            |}
        """.trimMargin()

        PromptScene.POLISH -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
            |{
            |  "polishedText": "ä¼˜åŒ–åçš„æ–‡æœ¬",
            |  "isSafe": true|false,
            |  "riskLevel": "SAFE|WARNING|DANGER",
            |  "issues": ["é—®é¢˜1", "é—®é¢˜2"],
            |  "suggestion": "ä¿®æ”¹å»ºè®®"
            |}
        """.trimMargin()

        PromptScene.REPLY -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
            |{
            |  "replyText": "å»ºè®®å›å¤å†…å®¹",
            |  "strategy": "ç­–ç•¥è¯´æ˜",
            |  "alternatives": ["å¤‡é€‰å›å¤1", "å¤‡é€‰å›å¤2"]
            |}
        """.trimMargin()

        PromptScene.SUMMARY -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
            |{
            |  "summary": "ä»Šæ—¥æ€»ç»“",
            |  "highlights": ["äº®ç‚¹1", "äº®ç‚¹2"],
            |  "concerns": ["å…³æ³¨ç‚¹1"],
            |  "newFacts": [{"key": "åˆ†ç±»", "value": "ä¿¡æ¯"}],
            |  "relationshipTrend": "UP|STABLE|DOWN"
            |}
        """.trimMargin()

        // åºŸå¼ƒåœºæ™¯ä¿æŒåŸæœ‰å®ç°
        @Suppress("DEPRECATION")
        PromptScene.CHECK -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
            |{
            |  "isSafe": true|false,
            |  "riskLevel": "SAFE|WARNING|DANGER",
            |  "issues": ["é—®é¢˜1", "é—®é¢˜2"],
            |  "suggestion": "ä¿®æ”¹å»ºè®®"
            |}
        """.trimMargin()

        @Suppress("DEPRECATION")
        PromptScene.EXTRACT -> """
            |ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
            |è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
            |{
            |  "facts": [
            |    {"key": "åˆ†ç±»", "value": "å…·ä½“ä¿¡æ¯", "confidence": 0.9}
            |  ]
            |}
        """.trimMargin()
    }
}
```

#### 4.3.2 DefaultPromptsæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/DefaultPrompts.kt`

```kotlin
object DefaultPrompts {

    fun getDefault(scene: PromptScene): String = when (scene) {
        PromptScene.ANALYZE -> """
            |è¯·åŸºäºæä¾›çš„ä¿¡æ¯ï¼Œåˆ†æå½“å‰èŠå¤©æƒ…å†µï¼Œå¹¶ç»™å‡º:
            |1. å¯¹æ–¹å½“å‰çš„æƒ…ç»ªå’Œæ½œåœ¨æ„å›¾
            |2. å¯èƒ½å­˜åœ¨çš„é£é™©ç‚¹
            |3. å…·ä½“çš„å›å¤å»ºè®®ï¼ˆå¯ç›´æ¥å‘é€çš„æ–‡æœ¬ï¼‰
            |
            |æ³¨æ„äº‹é¡¹:
            |- ä¸¥æ ¼éµå®ˆé›·åŒºè­¦å‘Šï¼Œä¸è¦è§¦ç¢°æ•æ„Ÿè¯é¢˜
            |- ä¼˜å…ˆä½¿ç”¨ç­–ç•¥å»ºè®®ä¸­çš„æ–¹æ³•
            |- å›å¤è¦çœŸè¯šã€è‡ªç„¶ï¼Œä¸è¦å¤ªè¿‡åˆ»æ„
        """.trimMargin()

        PromptScene.POLISH -> """
            |è¯·ä¼˜åŒ–ç”¨æˆ·çš„è‰ç¨¿å†…å®¹ï¼ŒåŒæ—¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨é£é™©ï¼š
            |
            |ä¼˜åŒ–è¦æ±‚:
            |- ä¿æŒåŸæ„ï¼Œä½¿è¡¨è¾¾æ›´è‡ªç„¶ã€å¾—ä½“
            |- é¿å…è§¦åŠå¯¹æ–¹çš„é›·åŒºè¯é¢˜
            |- è¯­æ°”è¦ç¬¦åˆå½“å‰å…³ç³»çŠ¶æ€
            |
            |é£é™©æ£€æŸ¥:
            |- æ˜¯å¦è§¦åŠå¯¹æ–¹çš„é›·åŒºè¯é¢˜
            |- è¯­æ°”æ˜¯å¦å¯èƒ½å¼•èµ·è¯¯è§£
            |- æ˜¯å¦æœ‰æ•æ„Ÿè¯æ±‡éœ€è¦æ›¿æ¢
        """.trimMargin()

        PromptScene.REPLY -> """
            |è¯·æ ¹æ®å¯¹æ–¹çš„æ¶ˆæ¯ï¼Œç”Ÿæˆåˆé€‚çš„å›å¤å»ºè®®ï¼š
            |
            |å›å¤è¦æ±‚:
            |- å›å¤è¦è‡ªç„¶ã€çœŸè¯šï¼Œç¬¦åˆæ—¥å¸¸å¯¹è¯é£æ ¼
            |- è€ƒè™‘å¯¹æ–¹çš„æ€§æ ¼ç‰¹ç‚¹å’Œå½“å‰æƒ…ç»ª
            |- é¿å…è§¦åŠé›·åŒºè¯é¢˜
            |- é€‚å½“è¿ç”¨ç­–ç•¥æ ‡ç­¾ä¸­çš„å»ºè®®
            |
            |è¯·æä¾›ä¸€ä¸ªä¸»è¦å›å¤å’Œ2-3ä¸ªå¤‡é€‰æ–¹æ¡ˆ
        """.trimMargin()

        PromptScene.SUMMARY -> """
            |è¯·åˆ†æä»Šæ—¥çš„å¯¹è¯è®°å½•ï¼Œç”Ÿæˆç®€æ´çš„æ€»ç»“ï¼š
            |- æ–°å‘ç°çš„äº‹å®ä¿¡æ¯
            |- å…³ç³»å˜åŒ–è¶‹åŠ¿
            |- éœ€è¦å…³æ³¨çš„è¦ç‚¹
        """.trimMargin()

        // åºŸå¼ƒåœºæ™¯ä¿æŒåŸæœ‰å®ç°ä»¥ç¡®ä¿å…¼å®¹æ€§
        @Suppress("DEPRECATION")
        PromptScene.CHECK -> """
            |è¯·æ£€æŸ¥ç”¨æˆ·çš„è‰ç¨¿å†…å®¹ï¼Œåˆ¤æ–­æ˜¯å¦è§¦å‘äº†ä»»ä½•é£é™©è§„åˆ™ã€‚
        """.trimMargin()

        @Suppress("DEPRECATION")
        PromptScene.EXTRACT -> """
            |è¯·ä»æ–‡æœ¬ä¸­æå–å…³é”®ä¿¡æ¯ã€‚
        """.trimMargin()
    }
}
```


---

### 4.4 UIç•Œé¢å˜æ›´

#### 4.4.1 SettingsViewModelæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/viewmodel/SettingsViewModel.kt`

```kotlin
@HiltViewModel
class SettingsViewModel @Inject constructor(
    @ApplicationContext private val application: Application,
    private val settingsRepository: SettingsRepository,
    private val floatingWindowPreferences: FloatingWindowPreferences,
    private val privacyPreferences: PrivacyPreferences,
    private val aiProviderRepository: AiProviderRepository
) : AndroidViewModel(application) {

    private val _uiState = MutableStateFlow(SettingsUiState())
    val uiState: StateFlow<SettingsUiState> = _uiState.asStateFlow()

    /**
     * è·å–è®¾ç½®ç•Œé¢æ˜¾ç¤ºçš„åœºæ™¯åˆ—è¡¨ï¼ˆæŒ‰é¢„å®šä¹‰é¡ºåºï¼‰
     * åªè¿”å›4ä¸ªæ ¸å¿ƒåœºæ™¯ï¼šANALYZEã€POLISHã€REPLYã€SUMMARY
     */
    val promptScenesOrdered: List<PromptScene> = PromptScene.SETTINGS_SCENE_ORDER

    // ... å…¶ä»–ç°æœ‰ä»£ç ä¿æŒä¸å˜
}
```

#### 4.4.2 PromptSettingsSectionç»„ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/settings/component/PromptSettingsSection.kt`

```kotlin
/**
 * æç¤ºè¯è®¾ç½®åŒºåŸŸç»„ä»¶
 *
 * @param scenes è¦æ˜¾ç¤ºçš„åœºæ™¯åˆ—è¡¨
 * @param onSceneClick åœºæ™¯ç‚¹å‡»å›è°ƒ
 * @param modifier Modifier
 */
@Composable
fun PromptSettingsSection(
    scenes: List<PromptScene>,
    onSceneClick: (PromptScene) -> Unit,
    modifier: Modifier = Modifier
) {
    Column(modifier = modifier) {
        Text(
            text = "æç¤ºè¯è®¾ç½®",
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.SemiBold,
            modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)
        )

        scenes.forEach { scene ->
            PromptSettingItem(
                scene = scene,
                onClick = { onSceneClick(scene) }
            )
        }
    }
}

/**
 * å•ä¸ªæç¤ºè¯è®¾ç½®é¡¹
 */
@Composable
private fun PromptSettingItem(
    scene: PromptScene,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    ListItem(
        headlineContent = {
            Text(text = "${scene.displayName}æŒ‡ä»¤")
        },
        supportingContent = {
            Text(
                text = scene.description,
                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
            )
        },
        trailingContent = {
            Icon(
                imageVector = Icons.AutoMirrored.Filled.KeyboardArrowRight,
                contentDescription = null,
                tint = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.4f)
            )
        },
        modifier = modifier.clickable(onClick = onClick)
    )
}
```

#### 4.4.3 SettingsScreené›†æˆ

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/settings/SettingsScreen.kt`

```kotlin
@Composable
fun SettingsScreen(
    viewModel: SettingsViewModel = hiltViewModel(),
    onNavigateToPromptEditor: (PromptScene) -> Unit,
    onNavigateToAiConfig: () -> Unit
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()

    LazyColumn(
        modifier = Modifier.fillMaxSize()
    ) {
        // AIæœåŠ¡å•†é…ç½®åŒºåŸŸ
        item {
            AiProviderSection(
                currentProvider = uiState.currentProvider,
                onClick = onNavigateToAiConfig
            )
        }

        // æç¤ºè¯è®¾ç½®åŒºåŸŸï¼ˆåªæ˜¾ç¤º4ä¸ªæ ¸å¿ƒåœºæ™¯ï¼‰
        item {
            PromptSettingsSection(
                scenes = viewModel.promptScenesOrdered,
                onSceneClick = onNavigateToPromptEditor
            )
        }

        // éšç§è®¾ç½®åŒºåŸŸ
        item {
            PrivacySettingsSection(
                dataMaskingEnabled = uiState.dataMaskingEnabled,
                localFirstMode = uiState.localFirstMode,
                onToggleDataMasking = { 
                    viewModel.onEvent(SettingsUiEvent.ToggleDataMasking) 
                },
                onToggleLocalFirstMode = { 
                    viewModel.onEvent(SettingsUiEvent.ToggleLocalFirstMode) 
                }
            )
        }

        // å…¶ä»–è®¾ç½®åŒºåŸŸ...
    }
}
```

---

### 4.5 å¯¼èˆªé…ç½®

#### 4.5.1 NavRoutesæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/navigation/NavRoutes.kt`

```kotlin
object NavRoutes {
    const val SETTINGS = "settings"
    const val AI_CONFIG = "ai_config"
    const val PROMPT_EDITOR = "prompt_editor"

    /**
     * æ„å»ºå…¨å±€åœºæ™¯æç¤ºè¯ç¼–è¾‘å™¨è·¯ç”±
     */
    fun promptEditorGlobal(scene: PromptScene): String {
        return "$PROMPT_EDITOR?mode=global&scene=${scene.name}"
    }

    /**
     * æ„å»ºè”ç³»äººä¸“å±æç¤ºè¯ç¼–è¾‘å™¨è·¯ç”±
     */
    fun promptEditorContact(contactId: String, contactName: String): String {
        val encodedName = URLEncoder.encode(contactName, "UTF-8")
        return "$PROMPT_EDITOR?mode=contact&contactId=$contactId&contactName=$encodedName"
    }
}
```

---

## 5. å…¼å®¹æ€§å¤„ç†

### 5.1 åºŸå¼ƒåœºæ™¯çš„ä»£ç å¤„ç†

#### 5.1.1 ActionTypeå…¼å®¹æ€§

```kotlin
enum class ActionType {
    ANALYZE,
    POLISH,
    REPLY,

    @Deprecated("ä½¿ç”¨ POLISH æ›¿ä»£")
    CHECK;

    companion object {
        /**
         * è·å–æ´»è·ƒçš„æ“ä½œç±»å‹ï¼ˆæ’é™¤åºŸå¼ƒç±»å‹ï¼‰
         */
        fun getActiveTypes(): List<ActionType> = listOf(ANALYZE, POLISH, REPLY)
    }
}
```

#### 5.1.2 PromptScene.fromActionTypeå…¼å®¹æ€§

```kotlin
companion object {
    fun fromActionType(actionType: ActionType): PromptScene = when (actionType) {
        ActionType.ANALYZE -> ANALYZE
        ActionType.POLISH -> POLISH
        ActionType.REPLY -> REPLY
        @Suppress("DEPRECATION")
        ActionType.CHECK -> POLISH  // CHECKæ˜ å°„åˆ°POLISH
    }
}
```

### 5.2 æ—§ç‰ˆæœ¬æ•°æ®å…¼å®¹

```kotlin
/**
 * å¤„ç†æ—§ç‰ˆæœ¬JSONä¸­å¯èƒ½å­˜åœ¨çš„åºŸå¼ƒåœºæ™¯
 */
class PromptSceneAdapter : JsonAdapter<PromptScene>() {
    @FromJson
    override fun fromJson(reader: JsonReader): PromptScene? {
        val name = reader.nextString()
        return try {
            PromptScene.valueOf(name)
        } catch (e: IllegalArgumentException) {
            // æœªçŸ¥åœºæ™¯è¿”å›nullï¼Œç”±è°ƒç”¨æ–¹å¤„ç†
            Log.w("PromptSceneAdapter", "æœªçŸ¥åœºæ™¯: $name")
            null
        }
    }

    @ToJson
    override fun toJson(writer: JsonWriter, value: PromptScene?) {
        writer.value(value?.name)
    }
}
```

---

## 6. é”™è¯¯å¤„ç†æœºåˆ¶

### 6.1 é”™è¯¯ç±»å‹å®šä¹‰

```kotlin
/**
 * æç¤ºè¯è®¾ç½®ç›¸å…³é”™è¯¯
 */
sealed class PromptSettingsError {
    /** é…ç½®åŠ è½½å¤±è´¥ */
    object LoadFailed : PromptSettingsError()
    
    /** é…ç½®ä¿å­˜å¤±è´¥ */
    object SaveFailed : PromptSettingsError()
    
    /** æ•°æ®è¿ç§»å¤±è´¥ */
    object MigrationFailed : PromptSettingsError()
    
    /** å¤‡ä»½å¤±è´¥ */
    object BackupFailed : PromptSettingsError()
    
    /** éªŒè¯å¤±è´¥ */
    data class ValidationFailed(val message: String) : PromptSettingsError()
    
    /** æœªçŸ¥é”™è¯¯ */
    data class UnknownError(val cause: Throwable) : PromptSettingsError()
}
```

### 6.2 é”™è¯¯å¤„ç†ç­–ç•¥

| é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·æç¤º | é‡è¯•æ¬¡æ•° |
|----------|----------|----------|----------|
| é…ç½®åŠ è½½å¤±è´¥ | ä½¿ç”¨é»˜è®¤é…ç½® | "åŠ è½½é…ç½®å¤±è´¥ï¼Œå·²ä½¿ç”¨é»˜è®¤è®¾ç½®" | 0 |
| é…ç½®ä¿å­˜å¤±è´¥ | é‡è¯•åæç¤º | "ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" | 3 |
| è¿ç§»å¤±è´¥ | ä¿ç•™åŸé…ç½® | é™é»˜å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ· | 1 |
| å¤‡ä»½å¤±è´¥ | ç»§ç»­æ“ä½œ | é™é»˜å¤„ç†ï¼Œè®°å½•æ—¥å¿— | 0 |
| éªŒè¯å¤±è´¥ | é˜»æ­¢ä¿å­˜ | æ˜¾ç¤ºå…·ä½“éªŒè¯é”™è¯¯ | 0 |

### 6.3 é”™è¯¯æ¢å¤æµç¨‹

```
é…ç½®åŠ è½½
    â†“
[æˆåŠŸ] â†’ æ£€æŸ¥è¿ç§» â†’ [éœ€è¦è¿ç§»] â†’ æ‰§è¡Œè¿ç§» â†’ [æˆåŠŸ] â†’ è¿”å›é…ç½®
    â†“                                    â†“
[å¤±è´¥]                              [å¤±è´¥] â†’ ä¿ç•™åŸé…ç½®
    â†“
å°è¯•å¤‡ä»½æ¢å¤
    â†“
[æˆåŠŸ] â†’ è¿”å›é…ç½®
    â†“
[å¤±è´¥] â†’ ä½¿ç”¨é»˜è®¤é…ç½®
```


---

## 7. æ€§èƒ½å½±å“è¯„ä¼°

### 7.1 æ€§èƒ½å½±å“åˆ†æ

| æ“ä½œ | å½±å“èŒƒå›´ | é¢„ä¼°è€—æ—¶ | ä¼˜åŒ–å»ºè®® |
|------|----------|----------|----------|
| é…ç½®æ–‡ä»¶è¯»å– | åº”ç”¨å¯åŠ¨ | <50ms | ä½¿ç”¨å†…å­˜ç¼“å­˜ |
| é…ç½®æ–‡ä»¶å†™å…¥ | ä¿å­˜æ“ä½œ | <100ms | å¼‚æ­¥å†™å…¥ |
| æ•°æ®è¿ç§» | é¦–æ¬¡å‡çº§ | <200ms | åå°æ‰§è¡Œ |
| UIæ¸²æŸ“ | è®¾ç½®ç•Œé¢ | <16ms | ä½¿ç”¨LazyColumn |

### 7.2 å†…å­˜å½±å“

```kotlin
/**
 * å†…å­˜ä½¿ç”¨ä¼°ç®—
 *
 * GlobalPromptConfigå¯¹è±¡å¤§å°ï¼š
 * - åŸºç¡€å¯¹è±¡ï¼š~100 bytes
 * - 4ä¸ªåœºæ™¯é…ç½®ï¼š~4KBï¼ˆæ¯ä¸ªåœºæ™¯çº¦1KBï¼‰
 * - å†å²è®°å½•ï¼ˆæ¯åœºæ™¯3æ¡ï¼‰ï¼š~12KB
 * - æ€»è®¡ï¼š~16KB
 *
 * ç¼“å­˜ç­–ç•¥ï¼š
 * - ä½¿ç”¨å•ä¾‹ç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½
 * - é…ç½®å˜æ›´æ—¶æ›´æ–°ç¼“å­˜
 */
```

### 7.3 å¯åŠ¨æ—¶é—´å½±å“

```kotlin
/**
 * å¯åŠ¨æ—¶é—´ä¼˜åŒ–ç­–ç•¥
 */
class PromptConfigLoader @Inject constructor(
    private val promptFileStorage: PromptFileStorage,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) {
    // å»¶è¿ŸåŠ è½½ï¼Œä¸é˜»å¡åº”ç”¨å¯åŠ¨
    private val configDeferred = CoroutineScope(ioDispatcher).async(
        start = CoroutineStart.LAZY
    ) {
        promptFileStorage.readGlobalConfig().getOrElse {
            GlobalPromptConfig.createDefault()
        }
    }

    suspend fun getConfig(): GlobalPromptConfig = configDeferred.await()
}
```

---

## 8. ç›‘æ§ä¸æ—¥å¿—

### 8.1 æ—¥å¿—è®°å½•ç­–ç•¥

```kotlin
object PromptSettingsLogger {
    private const val TAG = "PromptSettings"

    /**
     * è®°å½•é…ç½®åŠ è½½
     */
    fun logConfigLoad(success: Boolean, duration: Long, source: String) {
        if (success) {
            Log.i(TAG, "é…ç½®åŠ è½½æˆåŠŸ [æ¥æº=$source, è€—æ—¶=${duration}ms]")
        } else {
            Log.e(TAG, "é…ç½®åŠ è½½å¤±è´¥ [æ¥æº=$source, è€—æ—¶=${duration}ms]")
        }
    }

    /**
     * è®°å½•é…ç½®ä¿å­˜
     */
    fun logConfigSave(success: Boolean, scene: PromptScene?, duration: Long) {
        val sceneInfo = scene?.let { "[åœºæ™¯=${it.name}]" } ?: ""
        if (success) {
            Log.i(TAG, "é…ç½®ä¿å­˜æˆåŠŸ $sceneInfo [è€—æ—¶=${duration}ms]")
        } else {
            Log.e(TAG, "é…ç½®ä¿å­˜å¤±è´¥ $sceneInfo [è€—æ—¶=${duration}ms]")
        }
    }

    /**
     * è®°å½•æ•°æ®è¿ç§»
     */
    fun logMigration(fromVersion: Int, toVersion: Int, success: Boolean, details: String) {
        val status = if (success) "æˆåŠŸ" else "å¤±è´¥"
        Log.i(TAG, "æ•°æ®è¿ç§»$status [v$fromVersion â†’ v$toVersion] $details")
    }
}
```

---

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 å•å…ƒæµ‹è¯•

#### 9.1.1 PromptSceneTest

```kotlin
class PromptSceneTest {

    @Test
    fun `getSettingsScenesåº”è¯¥è¿”å›4ä¸ªæ ¸å¿ƒåœºæ™¯`() {
        val scenes = PromptScene.getSettingsScenes()

        assertEquals(4, scenes.size)
        assertTrue(scenes.contains(PromptScene.ANALYZE))
        assertTrue(scenes.contains(PromptScene.POLISH))
        assertTrue(scenes.contains(PromptScene.REPLY))
        assertTrue(scenes.contains(PromptScene.SUMMARY))
    }

    @Test
    fun `getSettingsScenesä¸åº”è¯¥åŒ…å«åºŸå¼ƒåœºæ™¯`() {
        val scenes = PromptScene.getSettingsScenes()

        @Suppress("DEPRECATION")
        assertFalse(scenes.contains(PromptScene.CHECK))
        @Suppress("DEPRECATION")
        assertFalse(scenes.contains(PromptScene.EXTRACT))
    }

    @Test
    fun `fromActionTypeåº”è¯¥å°†CHECKæ˜ å°„åˆ°POLISH`() {
        @Suppress("DEPRECATION")
        val scene = PromptScene.fromActionType(ActionType.CHECK)

        assertEquals(PromptScene.POLISH, scene)
    }

    @Test
    fun `SETTINGS_SCENE_ORDERåº”è¯¥æŒ‰æ­£ç¡®é¡ºåºæ’åˆ—`() {
        val order = PromptScene.SETTINGS_SCENE_ORDER

        assertEquals(4, order.size)
        assertEquals(PromptScene.ANALYZE, order[0])
        assertEquals(PromptScene.POLISH, order[1])
        assertEquals(PromptScene.REPLY, order[2])
        assertEquals(PromptScene.SUMMARY, order[3])
    }

    @Test
    fun `getActiveScenesåº”è¯¥è¿”å›éåºŸå¼ƒåœºæ™¯`() {
        val activeScenes = PromptScene.getActiveScenes()

        assertEquals(4, activeScenes.size)
        activeScenes.forEach { scene ->
            assertFalse(scene.isDeprecated)
        }
    }
}
```

#### 9.1.2 PromptMigrationTest

```kotlin
class PromptMigrationTest {

    private lateinit var storage: PromptFileStorage

    @Before
    fun setup() {
        // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
    }

    @Test
    fun `è¿ç§»åº”è¯¥å°†CHECKè‡ªå®šä¹‰å†…å®¹åˆå¹¶åˆ°POLISH`() {
        // Given
        @Suppress("DEPRECATION")
        val oldConfig = GlobalPromptConfig(
            version = 1,
            prompts = mapOf(
                PromptScene.CHECK to ScenePromptConfig(
                    userPrompt = "è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥æŒ‡ä»¤",
                    enabled = true
                ),
                PromptScene.POLISH to ScenePromptConfig(
                    userPrompt = "è‡ªå®šä¹‰æ¶¦è‰²æŒ‡ä»¤",
                    enabled = true
                )
            )
        )

        // When
        val migratedConfig = storage.migrateIfNeeded(oldConfig)

        // Then
        val polishPrompt = migratedConfig.prompts[PromptScene.POLISH]?.userPrompt
        assertTrue(polishPrompt?.contains("è‡ªå®šä¹‰æ¶¦è‰²æŒ‡ä»¤") == true)
        assertTrue(polishPrompt?.contains("è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥æŒ‡ä»¤") == true)
        assertEquals(2, migratedConfig.version)
    }

    @Test
    fun `è¿ç§»ä¸åº”è¯¥å½±å“é»˜è®¤CHECKå†…å®¹`() {
        // Given
        @Suppress("DEPRECATION")
        val oldConfig = GlobalPromptConfig(
            version = 1,
            prompts = mapOf(
                PromptScene.CHECK to ScenePromptConfig(
                    userPrompt = DefaultPrompts.getDefault(PromptScene.CHECK),
                    enabled = true
                )
            )
        )

        // When
        val migratedConfig = storage.migrateIfNeeded(oldConfig)

        // Then
        val polishPrompt = migratedConfig.prompts[PromptScene.POLISH]?.userPrompt
        assertFalse(polishPrompt?.contains("åŸå®‰å…¨æ£€æŸ¥æŒ‡ä»¤") == true)
    }

    @Test
    fun `å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ä¸åº”è¯¥æ‰§è¡Œè¿ç§»`() {
        // Given
        val currentConfig = GlobalPromptConfig(
            version = 2,
            prompts = mapOf(
                PromptScene.ANALYZE to ScenePromptConfig(
                    userPrompt = "æµ‹è¯•",
                    enabled = true
                )
            )
        )

        // When
        val result = storage.migrateIfNeeded(currentConfig)

        // Then
        assertEquals(currentConfig, result)
    }
}
```

### 9.2 UIæµ‹è¯•

```kotlin
class PromptSettingsSectionTest {

    @get:Rule
    val composeTestRule = createComposeRule()

    @Test
    fun `è®¾ç½®ç•Œé¢åº”è¯¥æ˜¾ç¤º4ä¸ªæç¤ºè¯é€‰é¡¹`() {
        composeTestRule.setContent {
            PromptSettingsSection(
                scenes = PromptScene.getSettingsScenes(),
                onSceneClick = {}
            )
        }

        composeTestRule.onNodeWithText("èŠå¤©åˆ†ææŒ‡ä»¤").assertIsDisplayed()
        composeTestRule.onNodeWithText("æ¶¦è‰²ä¼˜åŒ–æŒ‡ä»¤").assertIsDisplayed()
        composeTestRule.onNodeWithText("ç”Ÿæˆå›å¤æŒ‡ä»¤").assertIsDisplayed()
        composeTestRule.onNodeWithText("æ¯æ—¥æ€»ç»“æŒ‡ä»¤").assertIsDisplayed()
    }

    @Test
    fun `è®¾ç½®ç•Œé¢ä¸åº”è¯¥æ˜¾ç¤ºåºŸå¼ƒåœºæ™¯`() {
        composeTestRule.setContent {
            PromptSettingsSection(
                scenes = PromptScene.getSettingsScenes(),
                onSceneClick = {}
            )
        }

        composeTestRule.onNodeWithText("å®‰å…¨æ£€æŸ¥æŒ‡ä»¤").assertDoesNotExist()
        composeTestRule.onNodeWithText("ä¿¡æ¯æå–æŒ‡ä»¤").assertDoesNotExist()
    }

    @Test
    fun `ç‚¹å‡»åœºæ™¯é¡¹åº”è¯¥è§¦å‘å›è°ƒ`() {
        var clickedScene: PromptScene? = null

        composeTestRule.setContent {
            PromptSettingsSection(
                scenes = PromptScene.getSettingsScenes(),
                onSceneClick = { clickedScene = it }
            )
        }

        composeTestRule.onNodeWithText("èŠå¤©åˆ†ææŒ‡ä»¤").performClick()

        assertEquals(PromptScene.ANALYZE, clickedScene)
    }
}
```

### 9.3 é›†æˆæµ‹è¯•

```kotlin
class PromptSettingsIntegrationTest {

    @Test
    fun `ä»æ—§ç‰ˆæœ¬å‡çº§ååº”è¯¥æ­£ç¡®è¿ç§»æ•°æ®`() = runTest {
        // Given: æ¨¡æ‹Ÿæ—§ç‰ˆæœ¬é…ç½®æ–‡ä»¶
        val oldConfigJson = """
            {
                "version": 1,
                "prompts": {
                    "CHECK": {"userPrompt": "è‡ªå®šä¹‰æ£€æŸ¥", "enabled": true}
                }
            }
        """.trimIndent()

        // When: è¯»å–é…ç½®
        val config = storage.readGlobalConfig().getOrThrow()

        // Then: éªŒè¯è¿ç§»ç»“æœ
        assertEquals(2, config.version)
        assertTrue(
            config.prompts[PromptScene.POLISH]?.userPrompt?.contains("è‡ªå®šä¹‰æ£€æŸ¥") == true
        )
    }
}
```


---

## 10. å®æ–½è®¡åˆ’

### 10.1 ä»»åŠ¡åˆ†è§£

#### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®å±‚ä¼˜åŒ–ï¼ˆé¢„ä¼°1å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | ä¼˜å…ˆçº§ | é¢„ä¼°æ—¶é—´ | ä¾èµ– |
|--------|----------|--------|----------|------|
| T1.1 | æ›´æ–°PromptSceneæšä¸¾ï¼Œæ·»åŠ isDeprecatedå’ŒshowInSettingså±æ€§ | P0 | 1å°æ—¶ | æ—  |
| T1.2 | æ·»åŠ getSettingsScenes()å’ŒgetActiveScenes()æ–¹æ³• | P0 | 0.5å°æ—¶ | T1.1 |
| T1.3 | æ·»åŠ SETTINGS_SCENE_ORDERå¸¸é‡ | P0 | 0.5å°æ—¶ | T1.1 |
| T1.4 | æ›´æ–°fromActionType()æ–¹æ³•ï¼ŒCHECKæ˜ å°„åˆ°POLISH | P0 | 0.5å°æ—¶ | T1.1 |
| T1.5 | æ›´æ–°GlobalPromptConfigï¼Œæ·»åŠ versionå­—æ®µ | P0 | 0.5å°æ—¶ | æ—  |
| T1.6 | å®ç°PromptFileStorageè¿ç§»é€»è¾‘ | P0 | 2å°æ—¶ | T1.5 |
| T1.7 | æ›´æ–°SystemPromptsï¼Œä¼˜åŒ–4ä¸ªæ ¸å¿ƒåœºæ™¯æç¤ºè¯ | P1 | 1å°æ—¶ | T1.1 |
| T1.8 | æ›´æ–°DefaultPromptsï¼Œä¼˜åŒ–é»˜è®¤æç¤ºè¯æ¨¡æ¿ | P1 | 1å°æ—¶ | T1.1 |
| T1.9 | ç¼–å†™PromptSceneTestå•å…ƒæµ‹è¯• | P0 | 1å°æ—¶ | T1.1-T1.4 |
| T1.10 | ç¼–å†™PromptMigrationTestå•å…ƒæµ‹è¯• | P0 | 1å°æ—¶ | T1.6 |

#### ç¬¬äºŒé˜¶æ®µï¼šUIç•Œé¢æ›´æ–°ï¼ˆé¢„ä¼°0.5å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | ä¼˜å…ˆçº§ | é¢„ä¼°æ—¶é—´ | ä¾èµ– |
|--------|----------|--------|----------|------|
| T2.1 | æ›´æ–°SettingsViewModelï¼Œæ·»åŠ promptScenesOrderedå±æ€§ | P0 | 0.5å°æ—¶ | T1.3 |
| T2.2 | åˆ›å»ºPromptSettingsSectionç»„ä»¶ | P0 | 1å°æ—¶ | T2.1 |
| T2.3 | æ›´æ–°SettingsScreenï¼Œé›†æˆPromptSettingsSection | P0 | 0.5å°æ—¶ | T2.2 |
| T2.4 | ç¼–å†™PromptSettingsSectionTest UIæµ‹è¯• | P1 | 1å°æ—¶ | T2.2 |

#### ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•å’ŒéªŒè¯ï¼ˆé¢„ä¼°0.5å¤©ï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | ä¼˜å…ˆçº§ | é¢„ä¼°æ—¶é—´ | ä¾èµ– |
|--------|----------|--------|----------|------|
| T3.1 | ç¼–å†™é›†æˆæµ‹è¯• | P0 | 1å°æ—¶ | T1.*, T2.* |
| T3.2 | å…¼å®¹æ€§éªŒè¯ï¼ˆæ—§ç‰ˆæœ¬æ•°æ®è¿ç§»ï¼‰ | P0 | 1å°æ—¶ | T1.6 |
| T3.3 | æ‰‹åŠ¨æµ‹è¯•éªŒè¯ | P0 | 1å°æ—¶ | T3.1, T3.2 |
| T3.4 | æ–‡æ¡£æ›´æ–° | P1 | 0.5å°æ—¶ | T3.3 |

### 10.2 é‡Œç¨‹ç¢‘

```
Day 1: æ•°æ®å±‚ä¼˜åŒ–å®Œæˆ
  â”œâ”€â”€ PromptSceneæšä¸¾æ›´æ–° âœ“
  â”œâ”€â”€ è¿ç§»é€»è¾‘å®ç° âœ“
  â”œâ”€â”€ æç¤ºè¯å†…å®¹ä¼˜åŒ– âœ“
  â””â”€â”€ å•å…ƒæµ‹è¯•é€šè¿‡ âœ“

Day 2: UIæ›´æ–°å’Œæµ‹è¯•å®Œæˆ
  â”œâ”€â”€ è®¾ç½®ç•Œé¢æ›´æ–° âœ“
  â”œâ”€â”€ UIæµ‹è¯•é€šè¿‡ âœ“
  â”œâ”€â”€ é›†æˆæµ‹è¯•é€šè¿‡ âœ“
  â””â”€â”€ æ–‡æ¡£æ›´æ–° âœ“
```

### 10.3 é£é™©è¯„ä¼°

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| æ•°æ®è¿ç§»å¯¼è‡´ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯ä¸¢å¤± | ä½ | é«˜ | è¿ç§»å‰è‡ªåŠ¨å¤‡ä»½ï¼Œåˆå¹¶è€Œéè¦†ç›– |
| åºŸå¼ƒåœºæ™¯çš„å¤„ç†å½±å“ç°æœ‰åŠŸèƒ½ | ä½ | ä¸­ | ä¿ç•™åºŸå¼ƒåœºæ™¯ä»£ç ï¼Œä»…éšè—UI |
| UIå˜æ›´å¯¼è‡´ç”¨æˆ·å›°æƒ‘ | ä½ | ä½ | åœºæ™¯æ•°é‡å‡å°‘ï¼Œç•Œé¢æ›´ç®€æ´ |

---

## 11. é™„å½•

### 11.1 åœºæ™¯å˜é‡å¯¹ç…§è¡¨

| åœºæ™¯ | å˜é‡ | è¯´æ˜ |
|------|------|------|
| ANALYZE | contact_name | è”ç³»äººå§“å |
| | relationship_status | å…³ç³»çŠ¶æ€ |
| | risk_tags | é›·åŒºæ ‡ç­¾åˆ—è¡¨ |
| | strategy_tags | ç­–ç•¥æ ‡ç­¾åˆ—è¡¨ |
| | facts_count | å·²è®°å½•äº‹å®æ•°é‡ |
| POLISH | contact_name | è”ç³»äººå§“å |
| | relationship_status | å…³ç³»çŠ¶æ€ |
| | risk_tags | é›·åŒºæ ‡ç­¾åˆ—è¡¨ |
| REPLY | contact_name | è”ç³»äººå§“å |
| | relationship_status | å…³ç³»çŠ¶æ€ |
| | risk_tags | é›·åŒºæ ‡ç­¾åˆ—è¡¨ |
| | strategy_tags | ç­–ç•¥æ ‡ç­¾åˆ—è¡¨ |
| SUMMARY | contact_name | è”ç³»äººå§“å |
| | relationship_status | å…³ç³»çŠ¶æ€ |
| | facts_count | å·²è®°å½•äº‹å®æ•°é‡ |
| | today_date | ä»Šæ—¥æ—¥æœŸ |

### 11.2 è¿ç§»ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | å˜æ›´å†…å®¹ |
|------|----------|
| v1 | åˆå§‹ç‰ˆæœ¬ï¼Œ6ä¸ªåœºæ™¯ |
| v2 | ç®€åŒ–ä¸º4ä¸ªåœºæ™¯ï¼ŒCHECKåˆå¹¶åˆ°POLISH |

### 11.3 æ–‡ä»¶å˜æ›´æ¸…å•

| æ–‡ä»¶è·¯å¾„ | å˜æ›´ç±»å‹ | è¯´æ˜ |
|----------|----------|------|
| `domain/model/PromptScene.kt` | ä¿®æ”¹ | æ·»åŠ åºŸå¼ƒæ ‡è®°å’Œè¿‡æ»¤æ–¹æ³• |
| `domain/model/GlobalPromptConfig.kt` | ä¿®æ”¹ | æ·»åŠ versionå­—æ®µ |
| `domain/util/SystemPrompts.kt` | ä¿®æ”¹ | ä¼˜åŒ–4ä¸ªæ ¸å¿ƒåœºæ™¯æç¤ºè¯ |
| `data/local/DefaultPrompts.kt` | ä¿®æ”¹ | ä¼˜åŒ–é»˜è®¤æç¤ºè¯æ¨¡æ¿ |
| `data/local/PromptFileStorage.kt` | ä¿®æ”¹ | æ·»åŠ è¿ç§»é€»è¾‘ |
| `presentation/viewmodel/SettingsViewModel.kt` | ä¿®æ”¹ | æ·»åŠ promptScenesOrdered |
| `presentation/ui/screen/settings/component/PromptSettingsSection.kt` | æ–°å¢ | æç¤ºè¯è®¾ç½®åŒºåŸŸç»„ä»¶ |
| `presentation/ui/screen/settings/SettingsScreen.kt` | ä¿®æ”¹ | é›†æˆPromptSettingsSection |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PRD-00015 æç¤ºè¯è®¾ç½®ä¼˜åŒ–éœ€æ±‚](../PRD/PRD-00015-æç¤ºè¯è®¾ç½®ä¼˜åŒ–éœ€æ±‚.md)
- [FD-00015 æç¤ºè¯è®¾ç½®ä¼˜åŒ–åŠŸèƒ½è®¾è®¡](../FD/FD-00015-æç¤ºè¯è®¾ç½®ä¼˜åŒ–åŠŸèƒ½è®¾è®¡.md)
- [TDD-00005 æç¤ºè¯ç®¡ç†ç³»ç»ŸæŠ€æœ¯è®¾è®¡](../TDD/TDD-00005-æç¤ºè¯ç®¡ç†ç³»ç»ŸæŠ€æœ¯è®¾è®¡.md)
- [TDD-00006 æç¤ºè¯ç¼–è¾‘ç•Œé¢æŠ€æœ¯è®¾è®¡](../TDD/TDD-00006-æç¤ºè¯ç¼–è¾‘ç•Œé¢æŠ€æœ¯è®¾è®¡.md)

---

**æ–‡æ¡£çŠ¶æ€**: å¾…å®¡æ ¸  
**åˆ›å»ºæ—¥æœŸ**: 2025-12-22  
**è´Ÿè´£äºº**: Kiro  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
