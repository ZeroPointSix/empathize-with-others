# TDD-00016: å¯¹è¯ä¸»é¢˜åŠŸèƒ½æŠ€æœ¯è®¾è®¡

## 1. æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç±»å‹ | TDD (Technical Design Document) |
| æ–‡æ¡£ç¼–å· | TDD-00016 |
| åŠŸèƒ½åç§° | å¯¹è¯ä¸»é¢˜åŠŸèƒ½æŠ€æœ¯è®¾è®¡ |
| ç‰ˆæœ¬ | 1.0 |
| åˆ›å»ºæ—¥æœŸ | 2025-12-22 |
| æœ€åæ›´æ–° | 2025-12-22 |
| ä½œè€… | Kiro |
| å®¡æ ¸äºº | å¾…å®¡æ ¸ |
| å®¡æ ¸çŠ¶æ€ | å¾…å®¡æ ¸ |
| å…³è”æ–‡æ¡£ | PRD-00016, FD-00016 |

### 1.1 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2025-12-22 | Kiro | åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«å¯¹è¯ä¸»é¢˜åŠŸèƒ½çš„å®Œæ•´æŠ€æœ¯è®¾è®¡ |

### 1.2 æŠ€æœ¯æ ˆ

| æŠ€æœ¯é¢†åŸŸ | æŠ€æœ¯é€‰æ‹© | ç‰ˆæœ¬ | ç”¨é€” |
|---------|----------|------|------|
| UIæ¡†æ¶ | Jetpack Compose | BOM 2024.12.01 | å£°æ˜å¼UI |
| è®¾è®¡ç³»ç»Ÿ | Material 3 | 1.3.1 | UIç»„ä»¶å’Œä¸»é¢˜ |
| ä¾èµ–æ³¨å…¥ | Hilt | 2.52 | ä¾èµ–ç®¡ç† |
| æ•°æ®åº“ | Room | 2.6.1 | æœ¬åœ°å­˜å‚¨ |
| å¼‚æ­¥å¤„ç† | Kotlin Coroutines | 1.9.0 | å¼‚æ­¥æ“ä½œ |
| å“åº”å¼ | Kotlin Flow | 1.9.0 | æ•°æ®æµ |

---

## 2. æ¶æ„æ¦‚è¿°

### 2.1 è®¾è®¡ç›®æ ‡

ä¸ºå…±æƒ…AIåŠ©æ‰‹å¢åŠ å¯¹è¯ä¸»é¢˜åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·ä¸ºæ¯ä¸ªè”ç³»äººè®¾ç½®ç‹¬ç«‹çš„å¯¹è¯ä¸»é¢˜ï¼Œä½œä¸ºç³»ç»Ÿæç¤ºè¯çš„ä¸€éƒ¨åˆ†ä¼ é€’ç»™AIã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
- æ”¯æŒç”¨æˆ·è‡ªç”±è¾“å…¥ä¸»é¢˜å†…å®¹ï¼ˆæœ€å¤š500å­—ç¬¦ï¼‰
- ä¸»é¢˜ä¸è”ç³»äººç»‘å®šï¼Œä¸åŒè”ç³»äººç‹¬ç«‹ç®¡ç†
- ä¸»é¢˜æŒä¹…åŒ–å­˜å‚¨ï¼Œåº”ç”¨é‡å¯åæ¢å¤
- ä¸»é¢˜è‡ªåŠ¨æ³¨å…¥AIç³»ç»Ÿæç¤ºè¯
- æä¾›ç®€æ´çš„ä¸»é¢˜è®¾ç½®å…¥å£

### 2.2 è®¾è®¡åŸåˆ™

- **å•ä¸€æ•°æ®æº**ï¼šä½¿ç”¨Roomæ•°æ®åº“ä½œä¸ºå”¯ä¸€æ•°æ®æºï¼Œé€šè¿‡Flowå®ç°å“åº”å¼æ›´æ–°
- **Clean Architecture**ï¼šä¸¥æ ¼éµå¾ªé¢†åŸŸå±‚ã€æ•°æ®å±‚ã€è¡¨ç°å±‚åˆ†ç¦»
- **æœ€å°ä¾µå…¥**ï¼šå¤ç”¨ç°æœ‰ç»„ä»¶ï¼Œå‡å°‘å¯¹ç°æœ‰ä»£ç çš„ä¿®æ”¹
- **å‘åå…¼å®¹**ï¼šæ–°åŠŸèƒ½ä¸å½±å“ç°æœ‰åŠŸèƒ½çš„æ­£å¸¸è¿è¡Œ

---

## 3. æ•´ä½“æ¶æ„è®¾è®¡

### 3.1 åŠŸèƒ½æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¯¹è¯ä¸»é¢˜åŠŸèƒ½æ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   Presentation Layer                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚TopicSetting â”‚  â”‚ TopicBadge  â”‚  â”‚ TopicViewModel  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚   Dialog    â”‚  â”‚   å¾½ç« ç»„ä»¶   â”‚  â”‚   çŠ¶æ€ç®¡ç†      â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                â”‚                  â”‚               â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                             â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     Domain Layer                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ConversationTopicâ”‚  â”‚      TopicRepository            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    é¢†åŸŸæ¨¡å‹      â”‚  â”‚        (Interface)              â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ SetTopicUseCase â”‚  â”‚GetTopicUse  â”‚  â”‚ClearTopicUseâ”‚   â”‚ â”‚
â”‚  â”‚  â”‚   è®¾ç½®ä¸»é¢˜       â”‚  â”‚   Case      â”‚  â”‚    Case     â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                             â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      Data Layer                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚TopicEntity      â”‚  â”‚    TopicRepositoryImpl          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  æ•°æ®åº“å®ä½“      â”‚  â”‚        ä»“åº“å®ç°                  â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚ â”‚
â”‚  â”‚  â”‚ConversationTopicâ”‚                                      â”‚ â”‚
â”‚  â”‚  â”‚      Dao        â”‚                                      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                             â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Database (Room)                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚              conversation_topics è¡¨                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  id | contact_id | content | created_at | is_active â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¨¡å—å½±å“èŒƒå›´

```
domain/
â”œâ”€â”€ model/
â”‚   â””â”€â”€ ConversationTopic.kt          # ğŸ†• æ–°å¢ï¼šå¯¹è¯ä¸»é¢˜é¢†åŸŸæ¨¡å‹
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ TopicRepository.kt            # ğŸ†• æ–°å¢ï¼šä¸»é¢˜ä»“åº“æ¥å£
â””â”€â”€ usecase/
    â”œâ”€â”€ SetTopicUseCase.kt            # ğŸ†• æ–°å¢ï¼šè®¾ç½®ä¸»é¢˜ç”¨ä¾‹
    â”œâ”€â”€ GetTopicUseCase.kt            # ğŸ†• æ–°å¢ï¼šè·å–ä¸»é¢˜ç”¨ä¾‹
    â””â”€â”€ ClearTopicUseCase.kt          # ğŸ†• æ–°å¢ï¼šæ¸…é™¤ä¸»é¢˜ç”¨ä¾‹

data/
â”œâ”€â”€ local/
â”‚   â”œâ”€â”€ AppDatabase.kt                # ğŸ”„ æ›´æ–°ï¼šæ·»åŠ æ–°è¡¨å’ŒDAO
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â””â”€â”€ ConversationTopicEntity.kt # ğŸ†• æ–°å¢ï¼šä¸»é¢˜æ•°æ®åº“å®ä½“
â”‚   â””â”€â”€ dao/
â”‚       â””â”€â”€ ConversationTopicDao.kt    # ğŸ†• æ–°å¢ï¼šä¸»é¢˜DAO
â””â”€â”€ repository/
    â””â”€â”€ TopicRepositoryImpl.kt         # ğŸ†• æ–°å¢ï¼šä¸»é¢˜ä»“åº“å®ç°

presentation/
â”œâ”€â”€ ui/component/topic/
â”‚   â”œâ”€â”€ TopicSettingDialog.kt          # ğŸ†• æ–°å¢ï¼šä¸»é¢˜è®¾ç½®å¯¹è¯æ¡†
â”‚   â”œâ”€â”€ TopicBadge.kt                  # ğŸ†• æ–°å¢ï¼šä¸»é¢˜çŠ¶æ€å¾½ç« 
â”‚   â”œâ”€â”€ TopicInputField.kt             # ğŸ†• æ–°å¢ï¼šä¸»é¢˜è¾“å…¥æ¡†
â”‚   â””â”€â”€ TopicHistorySection.kt         # ğŸ†• æ–°å¢ï¼šä¸»é¢˜å†å²åŒºåŸŸ
â”œâ”€â”€ viewmodel/
â”‚   â”œâ”€â”€ TopicViewModel.kt              # ğŸ†• æ–°å¢ï¼šä¸»é¢˜ViewModel
â”‚   â”œâ”€â”€ TopicUiState.kt                # ğŸ†• æ–°å¢ï¼šä¸»é¢˜UIçŠ¶æ€
â”‚   â””â”€â”€ TopicUiEvent.kt                # ğŸ†• æ–°å¢ï¼šä¸»é¢˜UIäº‹ä»¶
â”œâ”€â”€ ui/screen/contact/
â”‚   â””â”€â”€ ContactDetailScreen.kt         # ğŸ”„ æ›´æ–°ï¼šæ·»åŠ ä¸»é¢˜å…¥å£
â””â”€â”€ ui/floating/
    â””â”€â”€ FloatingViewV2.kt              # ğŸ”„ æ›´æ–°ï¼šæ·»åŠ ä¸»é¢˜æ˜¾ç¤º

di/
â”œâ”€â”€ TopicModule.kt                     # ğŸ†• æ–°å¢ï¼šä¸»é¢˜ä¾èµ–æ³¨å…¥æ¨¡å—
â””â”€â”€ DatabaseModule.kt                  # ğŸ”„ æ›´æ–°ï¼šæ·»åŠ DAOæä¾›æ–¹æ³•
```

---

## 4. è¯¦ç»†è®¾è®¡

### 4.1 æ•°æ®æ¨¡å‹è®¾è®¡

#### 4.1.1 é¢†åŸŸæ¨¡å‹ - ConversationTopic

**æ–‡ä»¶ä½ç½®**ï¼š`domain/model/ConversationTopic.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜é¢†åŸŸæ¨¡å‹
 *
 * è¡¨ç¤ºç”¨æˆ·ä¸ºç‰¹å®šè”ç³»äººè®¾ç½®çš„å¯¹è¯ä¸»é¢˜ï¼Œç”¨äºå¢å¼ºAIç†è§£å¯¹è¯èƒŒæ™¯
 *
 * @property id ä¸»é¢˜å”¯ä¸€æ ‡è¯†
 * @property contactId å…³è”çš„è”ç³»äººID
 * @property content ä¸»é¢˜å†…å®¹ï¼ˆæœ€å¤š500å­—ç¬¦ï¼‰
 * @property createdAt åˆ›å»ºæ—¶é—´
 * @property updatedAt æœ€åæ›´æ–°æ—¶é—´
 * @property isActive æ˜¯å¦ä¸ºå½“å‰æ´»è·ƒä¸»é¢˜
 */
data class ConversationTopic(
    val id: String = UUID.randomUUID().toString(),
    val contactId: String,
    val content: String,
    val createdAt: Long = System.currentTimeMillis(),
    val updatedAt: Long = System.currentTimeMillis(),
    val isActive: Boolean = true
) {
    companion object {
        /** ä¸»é¢˜å†…å®¹æœ€å¤§é•¿åº¦ */
        const val MAX_CONTENT_LENGTH = 500
        
        /** ä¸»é¢˜é¢„è§ˆæœ€å¤§é•¿åº¦ */
        const val PREVIEW_LENGTH = 50
    }
    
    /**
     * è·å–ä¸»é¢˜å†…å®¹é¢„è§ˆï¼ˆå‰50å­—ç¬¦ï¼‰
     */
    fun getPreview(): String {
        return if (content.length > PREVIEW_LENGTH) {
            content.take(PREVIEW_LENGTH) + "..."
        } else {
            content
        }
    }
    
    /**
     * éªŒè¯ä¸»é¢˜å†…å®¹æ˜¯å¦æœ‰æ•ˆ
     */
    fun isValid(): Boolean {
        return content.isNotBlank() && content.length <= MAX_CONTENT_LENGTH
    }
}
```

#### 4.1.2 æ•°æ®åº“å®ä½“ - ConversationTopicEntity

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/entity/ConversationTopicEntity.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜æ•°æ®åº“å®ä½“
 */
@Entity(
    tableName = "conversation_topics",
    foreignKeys = [
        ForeignKey(
            entity = ContactProfileEntity::class,
            parentColumns = ["id"],
            childColumns = ["contact_id"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [
        Index(value = ["contact_id"]),
        Index(value = ["contact_id", "is_active"])
    ]
)
data class ConversationTopicEntity(
    @PrimaryKey
    @ColumnInfo(name = "id")
    val id: String,
    
    @ColumnInfo(name = "contact_id")
    val contactId: String,
    
    @ColumnInfo(name = "content")
    val content: String,
    
    @ColumnInfo(name = "created_at")
    val createdAt: Long,
    
    @ColumnInfo(name = "updated_at")
    val updatedAt: Long,
    
    @ColumnInfo(name = "is_active")
    val isActive: Boolean
) {
    /**
     * è½¬æ¢ä¸ºé¢†åŸŸæ¨¡å‹
     */
    fun toDomain(): ConversationTopic = ConversationTopic(
        id = id,
        contactId = contactId,
        content = content,
        createdAt = createdAt,
        updatedAt = updatedAt,
        isActive = isActive
    )
    
    companion object {
        /**
         * ä»é¢†åŸŸæ¨¡å‹åˆ›å»ºå®ä½“
         */
        fun fromDomain(topic: ConversationTopic): ConversationTopicEntity =
            ConversationTopicEntity(
                id = topic.id,
                contactId = topic.contactId,
                content = topic.content,
                createdAt = topic.createdAt,
                updatedAt = topic.updatedAt,
                isActive = topic.isActive
            )
    }
}
```

### 4.2 é¢†åŸŸå±‚è®¾è®¡

#### 4.2.1 ä»“åº“æ¥å£ - TopicRepository

**æ–‡ä»¶ä½ç½®**ï¼š`domain/repository/TopicRepository.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜ä»“åº“æ¥å£
 *
 * å®šä¹‰ä¸»é¢˜æ•°æ®çš„è®¿é—®å’Œç®¡ç†æ“ä½œ
 */
interface TopicRepository {
    
    /**
     * è·å–è”ç³»äººå½“å‰æ´»è·ƒçš„ä¸»é¢˜
     */
    suspend fun getActiveTopic(contactId: String): ConversationTopic?
    
    /**
     * è·å–è”ç³»äººå½“å‰æ´»è·ƒä¸»é¢˜çš„Flowï¼ˆå“åº”å¼ï¼‰
     */
    fun observeActiveTopic(contactId: String): Flow<ConversationTopic?>
    
    /**
     * è®¾ç½®è”ç³»äººçš„å¯¹è¯ä¸»é¢˜
     */
    suspend fun setTopic(topic: ConversationTopic): Result<Unit>
    
    /**
     * æ›´æ–°ç°æœ‰ä¸»é¢˜å†…å®¹
     */
    suspend fun updateTopicContent(topicId: String, content: String): Result<Unit>
    
    /**
     * æ¸…é™¤è”ç³»äººçš„å½“å‰ä¸»é¢˜
     */
    suspend fun clearTopic(contactId: String): Result<Unit>
    
    /**
     * è·å–è”ç³»äººçš„ä¸»é¢˜å†å²è®°å½•
     */
    suspend fun getTopicHistory(contactId: String, limit: Int = 10): List<ConversationTopic>
    
    /**
     * åˆ é™¤æŒ‡å®šä¸»é¢˜
     */
    suspend fun deleteTopic(topicId: String): Result<Unit>
}
```

#### 4.2.2 è®¾ç½®ä¸»é¢˜ç”¨ä¾‹ - SetTopicUseCase

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/SetTopicUseCase.kt`

```kotlin
/**
 * è®¾ç½®å¯¹è¯ä¸»é¢˜ç”¨ä¾‹
 *
 * è´Ÿè´£éªŒè¯å’Œä¿å­˜ç”¨æˆ·è®¾ç½®çš„å¯¹è¯ä¸»é¢˜
 */
class SetTopicUseCase @Inject constructor(
    private val topicRepository: TopicRepository
) {
    /**
     * è®¾ç½®å¯¹è¯ä¸»é¢˜
     *
     * @param contactId è”ç³»äººID
     * @param content ä¸»é¢˜å†…å®¹
     * @return æ“ä½œç»“æœï¼ŒæˆåŠŸè¿”å›åˆ›å»ºçš„ä¸»é¢˜
     */
    suspend operator fun invoke(
        contactId: String,
        content: String
    ): Result<ConversationTopic> {
        // 1. éªŒè¯è¾“å…¥
        if (contactId.isBlank()) {
            return Result.failure(IllegalArgumentException("è”ç³»äººIDä¸èƒ½ä¸ºç©º"))
        }
        
        if (content.isBlank()) {
            return Result.failure(IllegalArgumentException("ä¸»é¢˜å†…å®¹ä¸èƒ½ä¸ºç©º"))
        }
        
        if (content.length > ConversationTopic.MAX_CONTENT_LENGTH) {
            return Result.failure(
                IllegalArgumentException("ä¸»é¢˜å†…å®¹ä¸èƒ½è¶…è¿‡${ConversationTopic.MAX_CONTENT_LENGTH}å­—ç¬¦")
            )
        }
        
        // 2. æ¸…é™¤æ—§çš„æ´»è·ƒä¸»é¢˜
        topicRepository.clearTopic(contactId)
        
        // 3. åˆ›å»ºæ–°ä¸»é¢˜
        val topic = ConversationTopic(
            contactId = contactId,
            content = content.trim(),
            isActive = true
        )
        
        // 4. ä¿å­˜ä¸»é¢˜
        return topicRepository.setTopic(topic).map { topic }
    }
}
```

#### 4.2.3 è·å–ä¸»é¢˜ç”¨ä¾‹ - GetTopicUseCase

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/GetTopicUseCase.kt`

```kotlin
/**
 * è·å–å¯¹è¯ä¸»é¢˜ç”¨ä¾‹
 */
class GetTopicUseCase @Inject constructor(
    private val topicRepository: TopicRepository
) {
    /**
     * è·å–è”ç³»äººå½“å‰æ´»è·ƒä¸»é¢˜
     */
    suspend operator fun invoke(contactId: String): ConversationTopic? {
        if (contactId.isBlank()) return null
        return topicRepository.getActiveTopic(contactId)
    }
    
    /**
     * è§‚å¯Ÿè”ç³»äººä¸»é¢˜å˜åŒ–ï¼ˆå“åº”å¼ï¼‰
     */
    fun observe(contactId: String): Flow<ConversationTopic?> {
        if (contactId.isBlank()) return flowOf(null)
        return topicRepository.observeActiveTopic(contactId)
    }
}
```

#### 4.2.4 æ¸…é™¤ä¸»é¢˜ç”¨ä¾‹ - ClearTopicUseCase

**æ–‡ä»¶ä½ç½®**ï¼š`domain/usecase/ClearTopicUseCase.kt`

```kotlin
/**
 * æ¸…é™¤å¯¹è¯ä¸»é¢˜ç”¨ä¾‹
 */
class ClearTopicUseCase @Inject constructor(
    private val topicRepository: TopicRepository
) {
    /**
     * æ¸…é™¤è”ç³»äººå½“å‰ä¸»é¢˜
     */
    suspend operator fun invoke(contactId: String): Result<Unit> {
        if (contactId.isBlank()) {
            return Result.failure(IllegalArgumentException("è”ç³»äººIDä¸èƒ½ä¸ºç©º"))
        }
        return topicRepository.clearTopic(contactId)
    }
}
```

### 4.3 æ•°æ®å±‚è®¾è®¡

#### 4.3.1 æ•°æ®è®¿é—®å¯¹è±¡ - ConversationTopicDao

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/dao/ConversationTopicDao.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜æ•°æ®è®¿é—®å¯¹è±¡
 */
@Dao
interface ConversationTopicDao {
    
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insert(topic: ConversationTopicEntity)
    
    @Update
    suspend fun update(topic: ConversationTopicEntity)
    
    @Query("DELETE FROM conversation_topics WHERE id = :topicId")
    suspend fun deleteById(topicId: String)
    
    @Query("""
        SELECT * FROM conversation_topics 
        WHERE contact_id = :contactId AND is_active = 1 
        LIMIT 1
    """)
    suspend fun getActiveTopic(contactId: String): ConversationTopicEntity?
    
    @Query("""
        SELECT * FROM conversation_topics 
        WHERE contact_id = :contactId AND is_active = 1 
        LIMIT 1
    """)
    fun observeActiveTopic(contactId: String): Flow<ConversationTopicEntity?>
    
    @Query("""
        UPDATE conversation_topics 
        SET is_active = 0, updated_at = :timestamp 
        WHERE contact_id = :contactId AND is_active = 1
    """)
    suspend fun deactivateAllTopics(contactId: String, timestamp: Long = System.currentTimeMillis())
    
    @Query("""
        SELECT * FROM conversation_topics 
        WHERE contact_id = :contactId 
        ORDER BY updated_at DESC 
        LIMIT :limit
    """)
    suspend fun getTopicHistory(contactId: String, limit: Int): List<ConversationTopicEntity>
    
    @Query("SELECT * FROM conversation_topics WHERE id = :topicId")
    suspend fun getById(topicId: String): ConversationTopicEntity?
    
    @Query("""
        UPDATE conversation_topics 
        SET content = :content, updated_at = :timestamp 
        WHERE id = :topicId
    """)
    suspend fun updateContent(topicId: String, content: String, timestamp: Long = System.currentTimeMillis())
}
```

#### 4.3.2 ä»“åº“å®ç° - TopicRepositoryImpl

**æ–‡ä»¶ä½ç½®**ï¼š`data/repository/TopicRepositoryImpl.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜ä»“åº“å®ç°
 */
class TopicRepositoryImpl @Inject constructor(
    private val topicDao: ConversationTopicDao,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) : TopicRepository {
    
    override suspend fun getActiveTopic(contactId: String): ConversationTopic? =
        withContext(ioDispatcher) {
            topicDao.getActiveTopic(contactId)?.toDomain()
        }
    
    override fun observeActiveTopic(contactId: String): Flow<ConversationTopic?> =
        topicDao.observeActiveTopic(contactId)
            .map { it?.toDomain() }
            .flowOn(ioDispatcher)
    
    override suspend fun setTopic(topic: ConversationTopic): Result<Unit> =
        withContext(ioDispatcher) {
            try {
                topicDao.deactivateAllTopics(topic.contactId)
                topicDao.insert(ConversationTopicEntity.fromDomain(topic))
                Result.success(Unit)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    
    override suspend fun updateTopicContent(topicId: String, content: String): Result<Unit> =
        withContext(ioDispatcher) {
            try {
                topicDao.updateContent(topicId, content)
                Result.success(Unit)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    
    override suspend fun clearTopic(contactId: String): Result<Unit> =
        withContext(ioDispatcher) {
            try {
                topicDao.deactivateAllTopics(contactId)
                Result.success(Unit)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    
    override suspend fun getTopicHistory(contactId: String, limit: Int): List<ConversationTopic> =
        withContext(ioDispatcher) {
            topicDao.getTopicHistory(contactId, limit).map { it.toDomain() }
        }
    
    override suspend fun deleteTopic(topicId: String): Result<Unit> =
        withContext(ioDispatcher) {
            try {
                topicDao.deleteById(topicId)
                Result.success(Unit)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
}
```

### 4.4 è¡¨ç°å±‚è®¾è®¡

#### 4.4.1 UIçŠ¶æ€å®šä¹‰ - TopicUiState

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/viewmodel/TopicUiState.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜UIçŠ¶æ€
 */
data class TopicUiState(
    val currentTopic: ConversationTopic? = null,
    val isLoading: Boolean = false,
    val showSettingDialog: Boolean = false,
    val inputContent: String = "",
    val errorMessage: String? = null,
    val saveSuccess: Boolean = false,
    val topicHistory: List<ConversationTopic> = emptyList()
) {
    val hasActiveTopic: Boolean get() = currentTopic != null
    val topicPreview: String get() = currentTopic?.getPreview() ?: ""
    val inputCharCount: Int get() = inputContent.length
    val isOverLimit: Boolean get() = inputCharCount > ConversationTopic.MAX_CONTENT_LENGTH
    val canSave: Boolean get() = inputContent.isNotBlank() && !isOverLimit && !isLoading
}
```

#### 4.4.2 UIäº‹ä»¶å®šä¹‰ - TopicUiEvent

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/viewmodel/TopicUiEvent.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜UIäº‹ä»¶
 */
sealed class TopicUiEvent {
    object ShowSettingDialog : TopicUiEvent()
    object HideSettingDialog : TopicUiEvent()
    data class UpdateInput(val content: String) : TopicUiEvent()
    object SaveTopic : TopicUiEvent()
    object ClearTopic : TopicUiEvent()
    data class SelectFromHistory(val topic: ConversationTopic) : TopicUiEvent()
    object ClearError : TopicUiEvent()
    object ClearSaveSuccess : TopicUiEvent()
}
```

#### 4.4.3 ViewModelå®ç° - TopicViewModel

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/viewmodel/TopicViewModel.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜ViewModel
 */
@HiltViewModel
class TopicViewModel @Inject constructor(
    private val setTopicUseCase: SetTopicUseCase,
    private val getTopicUseCase: GetTopicUseCase,
    private val clearTopicUseCase: ClearTopicUseCase,
    private val topicRepository: TopicRepository,
    savedStateHandle: SavedStateHandle
) : ViewModel() {
    
    private val contactId: String = savedStateHandle.get<String>("contactId") ?: ""
    
    private val _uiState = MutableStateFlow(TopicUiState())
    val uiState: StateFlow<TopicUiState> = _uiState.asStateFlow()
    
    init {
        observeTopic()
        loadTopicHistory()
    }
    
    private fun observeTopic() {
        viewModelScope.launch {
            getTopicUseCase.observe(contactId)
                .distinctUntilChanged()
                .collect { topic ->
                    _uiState.update { it.copy(currentTopic = topic) }
                }
        }
    }
    
    private fun loadTopicHistory() {
        viewModelScope.launch {
            val history = topicRepository.getTopicHistory(contactId, 10)
            _uiState.update { it.copy(topicHistory = history) }
        }
    }
    
    fun onEvent(event: TopicUiEvent) {
        when (event) {
            is TopicUiEvent.ShowSettingDialog -> showSettingDialog()
            is TopicUiEvent.HideSettingDialog -> hideSettingDialog()
            is TopicUiEvent.UpdateInput -> updateInput(event.content)
            is TopicUiEvent.SaveTopic -> saveTopic()
            is TopicUiEvent.ClearTopic -> clearTopic()
            is TopicUiEvent.SelectFromHistory -> selectFromHistory(event.topic)
            is TopicUiEvent.ClearError -> _uiState.update { it.copy(errorMessage = null) }
            is TopicUiEvent.ClearSaveSuccess -> _uiState.update { it.copy(saveSuccess = false) }
        }
    }
    
    private fun showSettingDialog() {
        val currentContent = _uiState.value.currentTopic?.content ?: ""
        _uiState.update { it.copy(showSettingDialog = true, inputContent = currentContent) }
    }
    
    private fun hideSettingDialog() {
        _uiState.update { it.copy(showSettingDialog = false, inputContent = "", errorMessage = null) }
    }
    
    private fun updateInput(content: String) {
        _uiState.update { it.copy(inputContent = content) }
    }
    
    private fun saveTopic() {
        val content = _uiState.value.inputContent.trim()
        if (content.isBlank()) {
            _uiState.update { it.copy(errorMessage = "ä¸»é¢˜å†…å®¹ä¸èƒ½ä¸ºç©º") }
            return
        }
        
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            
            setTopicUseCase(contactId, content)
                .onSuccess {
                    _uiState.update { 
                        it.copy(isLoading = false, showSettingDialog = false, inputContent = "", saveSuccess = true)
                    }
                    loadTopicHistory()
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, errorMessage = error.message ?: "ä¿å­˜å¤±è´¥") }
                }
        }
    }
    
    private fun clearTopic() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            
            clearTopicUseCase(contactId)
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, showSettingDialog = false, inputContent = "") }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, errorMessage = error.message ?: "æ¸…é™¤å¤±è´¥") }
                }
        }
    }
    
    private fun selectFromHistory(topic: ConversationTopic) {
        _uiState.update { it.copy(inputContent = topic.content) }
    }
}
```

---

## 5. ç³»ç»Ÿé›†æˆè®¾è®¡

### 5.1 æ•°æ®åº“é›†æˆ

#### 5.1.1 AppDatabaseæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`data/local/AppDatabase.kt`

```kotlin
@Database(
    entities = [
        ContactProfileEntity::class,
        BrainTagEntity::class,
        AiProviderEntity::class,
        ConversationLogEntity::class,
        DailySummaryEntity::class,
        FailedSummaryTaskEntity::class,
        ConversationTopicEntity::class  // ğŸ†• æ–°å¢å®ä½“
    ],
    version = 11,  // ğŸ”„ ç‰ˆæœ¬å‡çº§ 10 â†’ 11
    exportSchema = true
)
@TypeConverters(RoomTypeConverters::class, FactListConverter::class)
abstract class AppDatabase : RoomDatabase() {
    
    // ç°æœ‰DAO...
    abstract fun contactDao(): ContactDao
    abstract fun brainTagDao(): BrainTagDao
    abstract fun aiProviderDao(): AiProviderDao
    abstract fun conversationLogDao(): ConversationLogDao
    abstract fun dailySummaryDao(): DailySummaryDao
    abstract fun failedSummaryTaskDao(): FailedSummaryTaskDao
    
    // ğŸ†• æ–°å¢DAO
    abstract fun conversationTopicDao(): ConversationTopicDao
}
```

#### 5.1.2 æ•°æ®åº“è¿ç§»è„šæœ¬

```kotlin
/**
 * æ•°æ®åº“è¿ç§»ï¼šv10 â†’ v11ï¼Œæ·»åŠ conversation_topicsè¡¨
 */
val MIGRATION_10_11 = object : Migration(10, 11) {
    override fun migrate(database: SupportSQLiteDatabase) {
        // åˆ›å»ºconversation_topicsè¡¨
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS conversation_topics (
                id TEXT PRIMARY KEY NOT NULL,
                contact_id TEXT NOT NULL,
                content TEXT NOT NULL,
                created_at INTEGER NOT NULL,
                updated_at INTEGER NOT NULL,
                is_active INTEGER NOT NULL DEFAULT 1,
                FOREIGN KEY (contact_id) REFERENCES contact_profiles(id) ON DELETE CASCADE
            )
        """)
        
        // åˆ›å»ºç´¢å¼•
        database.execSQL("""
            CREATE INDEX IF NOT EXISTS index_conversation_topics_contact_id 
            ON conversation_topics(contact_id)
        """)
        
        database.execSQL("""
            CREATE INDEX IF NOT EXISTS index_conversation_topics_contact_id_is_active 
            ON conversation_topics(contact_id, is_active)
        """)
    }
}
```

### 5.2 ä¾èµ–æ³¨å…¥é›†æˆ

#### 5.2.1 TopicModule

**æ–‡ä»¶ä½ç½®**ï¼š`di/TopicModule.kt`

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜ä¾èµ–æ³¨å…¥æ¨¡å—
 */
@Module
@InstallIn(SingletonComponent::class)
object TopicModule {
    
    @Provides
    @Singleton
    fun provideTopicRepository(
        topicDao: ConversationTopicDao,
        @IoDispatcher ioDispatcher: CoroutineDispatcher
    ): TopicRepository {
        return TopicRepositoryImpl(topicDao, ioDispatcher)
    }
    
    @Provides
    fun provideSetTopicUseCase(topicRepository: TopicRepository): SetTopicUseCase {
        return SetTopicUseCase(topicRepository)
    }
    
    @Provides
    fun provideGetTopicUseCase(topicRepository: TopicRepository): GetTopicUseCase {
        return GetTopicUseCase(topicRepository)
    }
    
    @Provides
    fun provideClearTopicUseCase(topicRepository: TopicRepository): ClearTopicUseCase {
        return ClearTopicUseCase(topicRepository)
    }
}
```

#### 5.2.2 DatabaseModuleæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`di/DatabaseModule.kt`

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object DatabaseModule {
    
    @Provides
    @Singleton
    fun provideAppDatabase(@ApplicationContext context: Context): AppDatabase {
        return Room.databaseBuilder(
            context,
            AppDatabase::class.java,
            "empathy_database"
        )
            .addMigrations(
                // ç°æœ‰è¿ç§»...
                MIGRATION_9_10,
                MIGRATION_10_11  // ğŸ†• æ·»åŠ æ–°è¿ç§»
            )
            .build()
    }
    
    // ğŸ†• æ–°å¢DAOæä¾›æ–¹æ³•
    @Provides
    fun provideConversationTopicDao(database: AppDatabase): ConversationTopicDao {
        return database.conversationTopicDao()
    }
}
```

### 5.3 ç°æœ‰UseCaseæ›´æ–°

#### 5.3.1 PromptBuilderæ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`domain/util/PromptBuilder.kt`

```kotlin
/**
 * æ„å»ºåŒ…å«ä¸»é¢˜çš„ç³»ç»Ÿæç¤ºè¯
 */
suspend fun buildWithTopic(
    scene: PromptScene,
    context: PromptContext,
    topic: ConversationTopic?
): String {
    val basePrompt = build(scene, context)
    
    if (topic == null || topic.content.isBlank()) {
        return basePrompt
    }
    
    val topicSection = """
        |ã€å½“å‰å¯¹è¯ä¸»é¢˜ã€‘
        |ç”¨æˆ·è®¾ç½®äº†ä»¥ä¸‹å¯¹è¯ä¸»é¢˜ï¼Œè¯·åœ¨å›å¤æ—¶å……åˆ†è€ƒè™‘è¿™ä¸ªèƒŒæ™¯ï¼š
        |
        |${topic.content}
        |
        |è¯·ç¡®ä¿ä½ çš„å›å¤ä¸ä¸Šè¿°ä¸»é¢˜ä¿æŒä¸€è‡´å’Œç›¸å…³ã€‚
    """.trimMargin()
    
    return "$basePrompt\n\n$topicSection"
}
```

#### 5.3.2 AnalyzeChatUseCaseæ›´æ–°

```kotlin
class AnalyzeChatUseCase @Inject constructor(
    private val aiRepository: AiRepository,
    private val promptBuilder: PromptBuilder,
    private val topicRepository: TopicRepository  // ğŸ†• æ–°å¢ä¾èµ–
) {
    suspend operator fun invoke(
        contactId: String,
        messages: List<ChatMessage>,
        context: PromptContext
    ): Result<AnalysisResult> {
        val topic = topicRepository.getActiveTopic(contactId)
        val systemPrompt = promptBuilder.buildWithTopic(PromptScene.ANALYZE, context, topic)
        return aiRepository.analyze(systemPrompt, messages)
    }
}
```

#### 5.3.3 PolishDraftUseCaseæ›´æ–°

```kotlin
class PolishDraftUseCase @Inject constructor(
    private val aiRepository: AiRepository,
    private val promptBuilder: PromptBuilder,
    private val sessionContextService: SessionContextService,
    private val topicRepository: TopicRepository  // ğŸ†• æ–°å¢ä¾èµ–
) {
    suspend operator fun invoke(
        contactId: String,
        draft: String,
        context: PromptContext
    ): Result<PolishResult> {
        val topic = topicRepository.getActiveTopic(contactId)
        val systemPrompt = promptBuilder.buildWithTopic(PromptScene.POLISH, context, topic)
        return aiRepository.polish(systemPrompt, draft)
    }
}
```

#### 5.3.4 GenerateReplyUseCaseæ›´æ–°

```kotlin
class GenerateReplyUseCase @Inject constructor(
    private val aiRepository: AiRepository,
    private val promptBuilder: PromptBuilder,
    private val sessionContextService: SessionContextService,
    private val topicRepository: TopicRepository  // ğŸ†• æ–°å¢ä¾èµ–
) {
    suspend operator fun invoke(
        contactId: String,
        receivedMessage: String,
        context: PromptContext
    ): Result<ReplyResult> {
        val topic = topicRepository.getActiveTopic(contactId)
        val systemPrompt = promptBuilder.buildWithTopic(PromptScene.REPLY, context, topic)
        return aiRepository.generateReply(systemPrompt, receivedMessage)
    }
}
```

---

## 6. ç”¨æˆ·å…¥å£ç‚¹è®¾è®¡

### 6.1 è”ç³»äººè¯¦æƒ…é¡µå…¥å£

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/screen/contact/ContactDetailScreen.kt`

```kotlin
@Composable
fun ContactDetailScreen(
    contactId: String,
    viewModel: ContactDetailViewModel = hiltViewModel(),
    topicViewModel: TopicViewModel = hiltViewModel(),  // ğŸ†• æ³¨å…¥TopicViewModel
    onNavigateBack: () -> Unit
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    val topicUiState by topicViewModel.uiState.collectAsStateWithLifecycle()
    
    Scaffold(
        topBar = {
            ContactDetailTopBar(
                contactName = uiState.contact?.name ?: "",
                currentTopic = topicUiState.currentTopic,
                onBackClick = onNavigateBack,
                onTopicClick = { topicViewModel.onEvent(TopicUiEvent.ShowSettingDialog) }
            )
        }
    ) { paddingValues ->
        // é¡µé¢å†…å®¹...
        
        // ğŸ†• ä¸»é¢˜è®¾ç½®å¯¹è¯æ¡†
        TopicSettingDialog(
            uiState = topicUiState,
            onEvent = topicViewModel::onEvent
        )
    }
}

@Composable
private fun ContactDetailTopBar(
    contactName: String,
    currentTopic: ConversationTopic?,
    onBackClick: () -> Unit,
    onTopicClick: () -> Unit
) {
    TopAppBar(
        title = { Text(contactName) },
        navigationIcon = {
            IconButton(onClick = onBackClick) {
                Icon(Icons.Default.ArrowBack, contentDescription = "è¿”å›")
            }
        },
        actions = {
            IconButton(onClick = onTopicClick) {
                Icon(
                    imageVector = if (currentTopic != null) Icons.Filled.Topic else Icons.Outlined.Topic,
                    contentDescription = "è®¾ç½®å¯¹è¯ä¸»é¢˜",
                    tint = if (currentTopic != null) MaterialTheme.colorScheme.primary 
                           else MaterialTheme.colorScheme.onSurface
                )
            }
        }
    )
}
```

### 6.2 æ‚¬æµ®çª—å…¥å£

**æ–‡ä»¶ä½ç½®**ï¼š`presentation/ui/floating/FloatingViewV2.kt`

åœ¨æ‚¬æµ®çª—é¡¶éƒ¨æ·»åŠ ä¸»é¢˜å¾½ç« ï¼Œç‚¹å‡»å¯æ‰“å¼€ä¸»é¢˜è®¾ç½®å¯¹è¯æ¡†ã€‚

### 6.3 å®Œæ•´è°ƒç”¨é“¾

```
ç”¨æˆ·æ“ä½œ â†’ UIç»„ä»¶ â†’ ViewModel â†’ UseCase â†’ Repository â†’ DAO â†’ Database
    â†“
ä¸»é¢˜è®¾ç½® â†’ TopicSettingDialog â†’ TopicViewModel â†’ SetTopicUseCase â†’ TopicRepository â†’ ConversationTopicDao
    â†“
AIè°ƒç”¨ â†’ FloatingWindowService â†’ AnalyzeChatUseCase â†’ TopicRepository.getActiveTopic() â†’ PromptBuilder.buildWithTopic()
```

---

## 7. é”™è¯¯å¤„ç†è®¾è®¡

### 7.1 é”™è¯¯ç±»å‹å®šä¹‰

```kotlin
/**
 * å¯¹è¯ä¸»é¢˜ç›¸å…³é”™è¯¯
 */
sealed class TopicError : Exception() {
    /** ä¸»é¢˜å†…å®¹ä¸ºç©º */
    object EmptyContent : TopicError() {
        override val message: String = "ä¸»é¢˜å†…å®¹ä¸èƒ½ä¸ºç©º"
    }
    
    /** ä¸»é¢˜å†…å®¹è¶…å‡ºé•¿åº¦é™åˆ¶ */
    data class ContentTooLong(val maxLength: Int) : TopicError() {
        override val message: String = "ä¸»é¢˜å†…å®¹ä¸èƒ½è¶…è¿‡${maxLength}å­—ç¬¦"
    }
    
    /** è”ç³»äººIDæ— æ•ˆ */
    object InvalidContactId : TopicError() {
        override val message: String = "æ— æ•ˆçš„è”ç³»äººID"
    }
    
    /** æ•°æ®åº“æ“ä½œå¤±è´¥ */
    data class DatabaseError(override val cause: Throwable?) : TopicError() {
        override val message: String = "æ•°æ®åº“æ“ä½œå¤±è´¥: ${cause?.message}"
    }
    
    /** æœªçŸ¥é”™è¯¯ */
    data class Unknown(override val cause: Throwable?) : TopicError() {
        override val message: String = cause?.message ?: "æœªçŸ¥é”™è¯¯"
    }
}
```

### 7.2 é”™è¯¯å¤„ç†ç­–ç•¥

| é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·æç¤º | é‡è¯•æ¬¡æ•° |
|----------|----------|----------|----------|
| å†…å®¹ä¸ºç©º | é˜»æ­¢ä¿å­˜ | "ä¸»é¢˜å†…å®¹ä¸èƒ½ä¸ºç©º" | 0 |
| å†…å®¹è¿‡é•¿ | é˜»æ­¢ä¿å­˜ | "ä¸»é¢˜å†…å®¹ä¸èƒ½è¶…è¿‡500å­—ç¬¦" | 0 |
| è”ç³»äººIDæ— æ•ˆ | é˜»æ­¢æ“ä½œ | "æ— æ³•è¯†åˆ«å½“å‰è”ç³»äºº" | 0 |
| æ•°æ®åº“é”™è¯¯ | é‡è¯•åæç¤º | "ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" | 3 |
| æœªçŸ¥é”™è¯¯ | è®°å½•æ—¥å¿— | "æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" | 1 |

### 7.3 é”™è¯¯æ¢å¤æµç¨‹

```kotlin
/**
 * å¸¦é‡è¯•çš„ä¸»é¢˜ä¿å­˜æ“ä½œ
 */
private suspend fun saveTopicWithRetry(
    topic: ConversationTopic,
    maxRetries: Int = 3
): Result<Unit> {
    var lastError: Throwable? = null
    
    repeat(maxRetries) { attempt ->
        topicRepository.setTopic(topic)
            .onSuccess { return Result.success(Unit) }
            .onFailure { error ->
                lastError = error
                if (error is TopicError.EmptyContent || 
                    error is TopicError.ContentTooLong ||
                    error is TopicError.InvalidContactId) {
                    return Result.failure(error)
                }
                delay(100L * (attempt + 1))
            }
    }
    
    return Result.failure(lastError ?: TopicError.Unknown(null))
}
```

---

## 8. æµ‹è¯•è®¾è®¡

### 8.1 å•å…ƒæµ‹è¯•

#### 8.1.1 SetTopicUseCaseTest

```kotlin
class SetTopicUseCaseTest {
    
    private lateinit var setTopicUseCase: SetTopicUseCase
    private lateinit var topicRepository: TopicRepository
    
    @Before
    fun setup() {
        topicRepository = mockk()
        setTopicUseCase = SetTopicUseCase(topicRepository)
    }
    
    @Test
    fun `è®¾ç½®ä¸»é¢˜_å†…å®¹æœ‰æ•ˆ_è¿”å›æˆåŠŸ`() = runTest {
        // Given
        val contactId = "contact-1"
        val content = "è®¨è®ºé¡¹ç›®è¿›åº¦"
        coEvery { topicRepository.clearTopic(contactId) } returns Result.success(Unit)
        coEvery { topicRepository.setTopic(any()) } returns Result.success(Unit)
        
        // When
        val result = setTopicUseCase(contactId, content)
        
        // Then
        assertTrue(result.isSuccess)
        assertEquals(content, result.getOrNull()?.content)
    }
    
    @Test
    fun `è®¾ç½®ä¸»é¢˜_å†…å®¹ä¸ºç©º_è¿”å›å¤±è´¥`() = runTest {
        // Given
        val contactId = "contact-1"
        val content = ""
        
        // When
        val result = setTopicUseCase(contactId, content)
        
        // Then
        assertTrue(result.isFailure)
        assertTrue(result.exceptionOrNull() is IllegalArgumentException)
    }
    
    @Test
    fun `è®¾ç½®ä¸»é¢˜_å†…å®¹è¶…é•¿_è¿”å›å¤±è´¥`() = runTest {
        // Given
        val contactId = "contact-1"
        val content = "a".repeat(501)
        
        // When
        val result = setTopicUseCase(contactId, content)
        
        // Then
        assertTrue(result.isFailure)
    }
    
    @Test
    fun `è®¾ç½®ä¸»é¢˜_è”ç³»äººIDä¸ºç©º_è¿”å›å¤±è´¥`() = runTest {
        // Given
        val contactId = ""
        val content = "æµ‹è¯•ä¸»é¢˜"
        
        // When
        val result = setTopicUseCase(contactId, content)
        
        // Then
        assertTrue(result.isFailure)
    }
}
```

#### 8.1.2 GetTopicUseCaseTest

```kotlin
class GetTopicUseCaseTest {
    
    private lateinit var getTopicUseCase: GetTopicUseCase
    private lateinit var topicRepository: TopicRepository
    
    @Before
    fun setup() {
        topicRepository = mockk()
        getTopicUseCase = GetTopicUseCase(topicRepository)
    }
    
    @Test
    fun `è·å–ä¸»é¢˜_å­˜åœ¨æ´»è·ƒä¸»é¢˜_è¿”å›ä¸»é¢˜`() = runTest {
        // Given
        val contactId = "contact-1"
        val topic = ConversationTopic(contactId = contactId, content = "æµ‹è¯•ä¸»é¢˜")
        coEvery { topicRepository.getActiveTopic(contactId) } returns topic
        
        // When
        val result = getTopicUseCase(contactId)
        
        // Then
        assertNotNull(result)
        assertEquals("æµ‹è¯•ä¸»é¢˜", result?.content)
    }
    
    @Test
    fun `è·å–ä¸»é¢˜_ä¸å­˜åœ¨æ´»è·ƒä¸»é¢˜_è¿”å›null`() = runTest {
        // Given
        val contactId = "contact-1"
        coEvery { topicRepository.getActiveTopic(contactId) } returns null
        
        // When
        val result = getTopicUseCase(contactId)
        
        // Then
        assertNull(result)
    }
    
    @Test
    fun `è·å–ä¸»é¢˜_è”ç³»äººIDä¸ºç©º_è¿”å›null`() = runTest {
        // Given
        val contactId = ""
        
        // When
        val result = getTopicUseCase(contactId)
        
        // Then
        assertNull(result)
    }
}
```

#### 8.1.3 ClearTopicUseCaseTest

```kotlin
class ClearTopicUseCaseTest {
    
    private lateinit var clearTopicUseCase: ClearTopicUseCase
    private lateinit var topicRepository: TopicRepository
    
    @Before
    fun setup() {
        topicRepository = mockk()
        clearTopicUseCase = ClearTopicUseCase(topicRepository)
    }
    
    @Test
    fun `æ¸…é™¤ä¸»é¢˜_æˆåŠŸ_è¿”å›æˆåŠŸ`() = runTest {
        // Given
        val contactId = "contact-1"
        coEvery { topicRepository.clearTopic(contactId) } returns Result.success(Unit)
        
        // When
        val result = clearTopicUseCase(contactId)
        
        // Then
        assertTrue(result.isSuccess)
    }
    
    @Test
    fun `æ¸…é™¤ä¸»é¢˜_è”ç³»äººIDä¸ºç©º_è¿”å›å¤±è´¥`() = runTest {
        // Given
        val contactId = ""
        
        // When
        val result = clearTopicUseCase(contactId)
        
        // Then
        assertTrue(result.isFailure)
    }
}
```

#### 8.1.4 TopicRepositoryImplTest

```kotlin
class TopicRepositoryImplTest {
    
    private lateinit var repository: TopicRepositoryImpl
    private lateinit var topicDao: ConversationTopicDao
    private val testDispatcher = StandardTestDispatcher()
    
    @Before
    fun setup() {
        topicDao = mockk()
        repository = TopicRepositoryImpl(topicDao, testDispatcher)
    }
    
    @Test
    fun `ä¿å­˜ä¸»é¢˜åå¯ä»¥è·å–`() = runTest {
        // Given
        val topic = ConversationTopic(contactId = "contact-1", content = "æµ‹è¯•ä¸»é¢˜")
        coEvery { topicDao.deactivateAllTopics(any()) } just Runs
        coEvery { topicDao.insert(any()) } just Runs
        coEvery { topicDao.getActiveTopic("contact-1") } returns 
            ConversationTopicEntity.fromDomain(topic)
        
        // When
        repository.setTopic(topic)
        val result = repository.getActiveTopic("contact-1")
        
        // Then
        assertNotNull(result)
        assertEquals("æµ‹è¯•ä¸»é¢˜", result?.content)
    }
    
    @Test
    fun `æ¸…é™¤ä¸»é¢˜åè·å–è¿”å›null`() = runTest {
        // Given
        val contactId = "contact-1"
        coEvery { topicDao.deactivateAllTopics(contactId, any()) } just Runs
        coEvery { topicDao.getActiveTopic(contactId) } returns null
        
        // When
        repository.clearTopic(contactId)
        val result = repository.getActiveTopic(contactId)
        
        // Then
        assertNull(result)
    }
    
    @Test
    fun `è·å–ä¸»é¢˜å†å²_è¿”å›æ­£ç¡®æ•°é‡`() = runTest {
        // Given
        val contactId = "contact-1"
        val entities = listOf(
            ConversationTopicEntity("1", contactId, "ä¸»é¢˜1", 0, 0, false),
            ConversationTopicEntity("2", contactId, "ä¸»é¢˜2", 0, 0, false)
        )
        coEvery { topicDao.getTopicHistory(contactId, 10) } returns entities
        
        // When
        val result = repository.getTopicHistory(contactId, 10)
        
        // Then
        assertEquals(2, result.size)
    }
}
```

#### 8.1.5 ConversationTopicTest

```kotlin
class ConversationTopicTest {
    
    @Test
    fun `getPreview_å†…å®¹çŸ­äº50å­—ç¬¦_è¿”å›å®Œæ•´å†…å®¹`() {
        // Given
        val topic = ConversationTopic(contactId = "1", content = "çŸ­å†…å®¹")
        
        // When
        val preview = topic.getPreview()
        
        // Then
        assertEquals("çŸ­å†…å®¹", preview)
    }
    
    @Test
    fun `getPreview_å†…å®¹é•¿äº50å­—ç¬¦_è¿”å›æˆªæ–­å†…å®¹åŠ çœç•¥å·`() {
        // Given
        val longContent = "a".repeat(60)
        val topic = ConversationTopic(contactId = "1", content = longContent)
        
        // When
        val preview = topic.getPreview()
        
        // Then
        assertEquals(53, preview.length) // 50 + "..."
        assertTrue(preview.endsWith("..."))
    }
    
    @Test
    fun `isValid_å†…å®¹æœ‰æ•ˆ_è¿”å›true`() {
        // Given
        val topic = ConversationTopic(contactId = "1", content = "æœ‰æ•ˆå†…å®¹")
        
        // When & Then
        assertTrue(topic.isValid())
    }
    
    @Test
    fun `isValid_å†…å®¹ä¸ºç©º_è¿”å›false`() {
        // Given
        val topic = ConversationTopic(contactId = "1", content = "")
        
        // When & Then
        assertFalse(topic.isValid())
    }
    
    @Test
    fun `isValid_å†…å®¹è¶…é•¿_è¿”å›false`() {
        // Given
        val topic = ConversationTopic(contactId = "1", content = "a".repeat(501))
        
        // When & Then
        assertFalse(topic.isValid())
    }
}
```

### 8.2 é›†æˆæµ‹è¯•

#### 8.2.1 æ•°æ®åº“è¿ç§»æµ‹è¯•

```kotlin
@RunWith(AndroidJUnit4::class)
class MigrationTest {
    
    private val TEST_DB = "migration-test"
    
    @get:Rule
    val helper: MigrationTestHelper = MigrationTestHelper(
        InstrumentationRegistry.getInstrumentation(),
        AppDatabase::class.java.canonicalName,
        FrameworkSQLiteOpenHelperFactory()
    )
    
    @Test
    fun migrate10To11() {
        // åˆ›å»ºv10æ•°æ®åº“
        helper.createDatabase(TEST_DB, 10).apply {
            close()
        }
        
        // æ‰§è¡Œè¿ç§»åˆ°v11
        val db = helper.runMigrationsAndValidate(TEST_DB, 11, true, MIGRATION_10_11)
        
        // éªŒè¯conversation_topicsè¡¨å­˜åœ¨
        val cursor = db.query("SELECT * FROM conversation_topics")
        assertEquals(6, cursor.columnCount) // id, contact_id, content, created_at, updated_at, is_active
        cursor.close()
    }
}
```

### 8.3 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | æµ‹è¯•æ–‡ä»¶ |
|------|-----------|----------|
| ConversationTopic | 100% | ConversationTopicTest.kt |
| SetTopicUseCase | 100% | SetTopicUseCaseTest.kt |
| GetTopicUseCase | 100% | GetTopicUseCaseTest.kt |
| ClearTopicUseCase | 100% | ClearTopicUseCaseTest.kt |
| TopicRepositoryImpl | 90% | TopicRepositoryImplTest.kt |
| TopicViewModel | 85% | TopicViewModelTest.kt |
| æ•°æ®åº“è¿ç§» | 100% | MigrationTest.kt |

---

## 9. å®æ–½è®¡åˆ’

### 9.1 é˜¶æ®µåˆ’åˆ†

| é˜¶æ®µ | å†…å®¹ | é¢„ä¼°å·¥æ—¶ | ä¾èµ– |
|------|------|----------|------|
| é˜¶æ®µ1 | æ•°æ®å±‚å®ç° | 4h | æ—  |
| é˜¶æ®µ2 | é¢†åŸŸå±‚å®ç° | 3h | é˜¶æ®µ1 |
| é˜¶æ®µ3 | è¡¨ç°å±‚å®ç° | 5h | é˜¶æ®µ2 |
| é˜¶æ®µ4 | ç³»ç»Ÿé›†æˆ | 3h | é˜¶æ®µ3 |
| é˜¶æ®µ5 | æµ‹è¯•å®Œå–„ | 4h | é˜¶æ®µ4 |
| **æ€»è®¡** | | **19h** | |

### 9.2 è¯¦ç»†ä»»åŠ¡æ¸…å•

#### é˜¶æ®µ1ï¼šæ•°æ®å±‚å®ç°ï¼ˆ4hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼°æ—¶é—´ | çŠ¶æ€ |
|--------|----------|----------|------|
| T1.1 | åˆ›å»ºConversationTopicEntityå®ä½“ç±» | 30min | â¬œ å¾…å¼€å§‹ |
| T1.2 | åˆ›å»ºConversationTopicDaoæ¥å£ | 45min | â¬œ å¾…å¼€å§‹ |
| T1.3 | æ›´æ–°AppDatabaseæ·»åŠ æ–°å®ä½“å’ŒDAO | 30min | â¬œ å¾…å¼€å§‹ |
| T1.4 | ç¼–å†™MIGRATION_10_11è¿ç§»è„šæœ¬ | 30min | â¬œ å¾…å¼€å§‹ |
| T1.5 | åˆ›å»ºTopicRepositoryImplå®ç°ç±» | 45min | â¬œ å¾…å¼€å§‹ |
| T1.6 | æ›´æ–°DatabaseModuleæ·»åŠ DAOæä¾›æ–¹æ³• | 15min | â¬œ å¾…å¼€å§‹ |
| T1.7 | ç¼–å†™æ•°æ®åº“è¿ç§»æµ‹è¯• | 45min | â¬œ å¾…å¼€å§‹ |

#### é˜¶æ®µ2ï¼šé¢†åŸŸå±‚å®ç°ï¼ˆ3hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼°æ—¶é—´ | çŠ¶æ€ |
|--------|----------|----------|------|
| T2.1 | åˆ›å»ºConversationTopicé¢†åŸŸæ¨¡å‹ | 30min | â¬œ å¾…å¼€å§‹ |
| T2.2 | åˆ›å»ºTopicRepositoryæ¥å£ | 20min | â¬œ å¾…å¼€å§‹ |
| T2.3 | åˆ›å»ºSetTopicUseCase | 30min | â¬œ å¾…å¼€å§‹ |
| T2.4 | åˆ›å»ºGetTopicUseCase | 20min | â¬œ å¾…å¼€å§‹ |
| T2.5 | åˆ›å»ºClearTopicUseCase | 20min | â¬œ å¾…å¼€å§‹ |
| T2.6 | åˆ›å»ºTopicModuleä¾èµ–æ³¨å…¥æ¨¡å— | 30min | â¬œ å¾…å¼€å§‹ |
| T2.7 | ç¼–å†™UseCaseå•å…ƒæµ‹è¯• | 50min | â¬œ å¾…å¼€å§‹ |

#### é˜¶æ®µ3ï¼šè¡¨ç°å±‚å®ç°ï¼ˆ5hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼°æ—¶é—´ | çŠ¶æ€ |
|--------|----------|----------|------|
| T3.1 | åˆ›å»ºTopicUiStateå’ŒTopicUiEvent | 30min | â¬œ å¾…å¼€å§‹ |
| T3.2 | åˆ›å»ºTopicViewModel | 60min | â¬œ å¾…å¼€å§‹ |
| T3.3 | åˆ›å»ºTopicSettingDialogç»„ä»¶ | 60min | â¬œ å¾…å¼€å§‹ |
| T3.4 | åˆ›å»ºTopicInputFieldç»„ä»¶ | 30min | â¬œ å¾…å¼€å§‹ |
| T3.5 | åˆ›å»ºTopicBadgeç»„ä»¶ | 30min | â¬œ å¾…å¼€å§‹ |
| T3.6 | åˆ›å»ºTopicHistorySectionç»„ä»¶ | 30min | â¬œ å¾…å¼€å§‹ |
| T3.7 | ç¼–å†™ViewModelå•å…ƒæµ‹è¯• | 40min | â¬œ å¾…å¼€å§‹ |

#### é˜¶æ®µ4ï¼šç³»ç»Ÿé›†æˆï¼ˆ3hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼°æ—¶é—´ | çŠ¶æ€ |
|--------|----------|----------|------|
| T4.1 | æ›´æ–°PromptBuilderæ·»åŠ buildWithTopicæ–¹æ³• | 30min | â¬œ å¾…å¼€å§‹ |
| T4.2 | æ›´æ–°AnalyzeChatUseCaseé›†æˆä¸»é¢˜ | 20min | â¬œ å¾…å¼€å§‹ |
| T4.3 | æ›´æ–°PolishDraftUseCaseé›†æˆä¸»é¢˜ | 20min | â¬œ å¾…å¼€å§‹ |
| T4.4 | æ›´æ–°GenerateReplyUseCaseé›†æˆä¸»é¢˜ | 20min | â¬œ å¾…å¼€å§‹ |
| T4.5 | æ›´æ–°ContactDetailScreenæ·»åŠ ä¸»é¢˜å…¥å£ | 30min | â¬œ å¾…å¼€å§‹ |
| T4.6 | æ›´æ–°FloatingViewV2æ·»åŠ ä¸»é¢˜æ˜¾ç¤º | 40min | â¬œ å¾…å¼€å§‹ |
| T4.7 | æ›´æ–°FloatingWindowModuleä¾èµ–æ³¨å…¥ | 20min | â¬œ å¾…å¼€å§‹ |

#### é˜¶æ®µ5ï¼šæµ‹è¯•å®Œå–„ï¼ˆ4hï¼‰

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„ä¼°æ—¶é—´ | çŠ¶æ€ |
|--------|----------|----------|------|
| T5.1 | ç¼–å†™TopicRepositoryImplTest | 45min | â¬œ å¾…å¼€å§‹ |
| T5.2 | ç¼–å†™ConversationTopicTest | 30min | â¬œ å¾…å¼€å§‹ |
| T5.3 | ç¼–å†™TopicViewModelTest | 45min | â¬œ å¾…å¼€å§‹ |
| T5.4 | ç¼–å†™é›†æˆæµ‹è¯• | 60min | â¬œ å¾…å¼€å§‹ |
| T5.5 | æ‰§è¡Œå…¨é‡æµ‹è¯•å¹¶ä¿®å¤é—®é¢˜ | 60min | â¬œ å¾…å¼€å§‹ |

---

## 10. é£é™©è¯„ä¼°

### 10.1 æŠ€æœ¯é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| æ•°æ®åº“è¿ç§»å¤±è´¥ | ä½ | é«˜ | ç¼–å†™å®Œæ•´è¿ç§»æµ‹è¯•ï¼Œå¯¼å‡ºSchemaéªŒè¯ |
| ä¸»é¢˜æ³¨å…¥å½±å“AIå“åº”è´¨é‡ | ä¸­ | ä¸­ | ä¼˜åŒ–æç¤ºè¯æ¨¡æ¿ï¼Œè¿›è¡ŒA/Bæµ‹è¯• |
| æ‚¬æµ®çª—é›†æˆå¤æ‚åº¦é«˜ | ä¸­ | ä¸­ | å¤ç”¨ç°æœ‰ç»„ä»¶ï¼Œæœ€å°åŒ–æ”¹åŠ¨ |
| æ€§èƒ½å½±å“ | ä½ | ä½ | ä½¿ç”¨Flowå“åº”å¼æ›´æ–°ï¼Œé¿å…é‡å¤æŸ¥è¯¢ |

### 10.2 ä¾èµ–é£é™©

| ä¾èµ–é¡¹ | é£é™©æè¿° | ç¼“è§£æªæ–½ |
|--------|----------|----------|
| Room 2.6.1 | è¿ç§»APIå˜æ›´ | é”å®šç‰ˆæœ¬ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ |
| Hilt 2.52 | æ³¨å…¥é…ç½®å¤æ‚ | éµå¾ªç°æœ‰æ¨¡å—æ¨¡å¼ |
| ç°æœ‰UseCase | æ¥å£å˜æ›´å½±å“ | ä½¿ç”¨å¯é€‰å‚æ•°ï¼Œä¿æŒå‘åå…¼å®¹ |

### 10.3 é£é™©åº”å¯¹è®¡åˆ’

1. **æ•°æ®åº“è¿ç§»å¤±è´¥**
   - é¢„é˜²ï¼šç¼–å†™å®Œæ•´çš„è¿ç§»æµ‹è¯•ç”¨ä¾‹
   - åº”å¯¹ï¼šä¿ç•™å›æ»šè„šæœ¬ï¼Œæ”¯æŒé™çº§è¿ç§»

2. **AIå“åº”è´¨é‡ä¸‹é™**
   - é¢„é˜²ï¼šä¼˜åŒ–ä¸»é¢˜æ³¨å…¥çš„æç¤ºè¯æ¨¡æ¿
   - åº”å¯¹ï¼šæä¾›ä¸»é¢˜å¼€å…³ï¼Œå…è®¸ç”¨æˆ·ç¦ç”¨

3. **æ€§èƒ½é—®é¢˜**
   - é¢„é˜²ï¼šä½¿ç”¨Flowå“åº”å¼æ›´æ–°ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
   - åº”å¯¹ï¼šæ·»åŠ æ€§èƒ½ç›‘æ§ï¼Œå¿…è¦æ—¶å¼•å…¥ç¼“å­˜

---

## 11. é™„å½•

### 11.1 ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| PRD-00016 | å¯¹è¯ä¸»é¢˜åŠŸèƒ½éœ€æ±‚æ–‡æ¡£ |
| FD-00016 | å¯¹è¯ä¸»é¢˜åŠŸèƒ½è®¾è®¡æ–‡æ¡£ |
| DR-00016 | FD-00016æ–‡æ¡£å®¡æŸ¥æŠ¥å‘Š |

### 11.2 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| ConversationTopic | å¯¹è¯ä¸»é¢˜ï¼Œç”¨æˆ·ä¸ºè”ç³»äººè®¾ç½®çš„å¯¹è¯èƒŒæ™¯ä¿¡æ¯ |
| ActiveTopic | æ´»è·ƒä¸»é¢˜ï¼Œå½“å‰ç”Ÿæ•ˆçš„å¯¹è¯ä¸»é¢˜ |
| TopicHistory | ä¸»é¢˜å†å²ï¼Œè”ç³»äººçš„å†å²ä¸»é¢˜è®°å½• |

### 11.3 å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| 2025-12-22 | 1.0 | åˆå§‹ç‰ˆæœ¬ | Kiro |

---

**æ–‡æ¡£çŠ¶æ€**: å¾…å®¡æ ¸  
**ä¸‹ä¸€æ­¥**: æäº¤æŠ€æœ¯è¯„å®¡
