# TDD-00019: UI视觉美观化改造技术设计

> **文档类型**: 技术设计文档 (TDD)
> **版本**: 1.4
> **创建日期**: 2025-12-24
> **更新日期**: 2025-12-24
> **负责人**: Kiro
> **状态**: ✅ 已完成
> **优先级**: 🔴 高
> **关联PRD**: PRD-00019
> **关联FD**: FD-00019
> **关联调研**: RESEARCH-00042, RESEARCH-00043
> **关联审查**: DR-00035, DR-00036, DR-00037, DR-00038

---

## 📋 文档概述

### 设计目标
基于PRD-00019和FD-00019的需求，提供UI视觉美观化改造的详细技术实现方案，包括iOS系统色常量、头像淡色系、iOS风格组件库、底部导航栏、联系人列表改造、设置页面改造、提示词编辑器改造的技术架构和实现细节。

### 技术原则
- **增量式改造** - 新增iOS系统色常量，不修改现有ColorScheme，避免全局影响
- **导航状态自动同步** - 使用currentBackStackEntryAsState()替代手动传递currentRoute
- **iOS组件完整实现** - 添加spring动画和按压反馈，提升用户体验
- **深色模式暂不改造** - 避免增加复杂度，后续单独处理

### 关联文档
- [PRD-00019-UI视觉美观化改造](../PRD/PRD-00019-UI视觉美观化改造.md)
- [FD-00019-UI视觉美观化改造功能设计](../FD/FD-00019-UI视觉美观化改造功能设计.md)
- [RESEARCH-00042-FD00019功能设计深度技术调研报告](../RE/RESEARCH-00042-FD00019功能设计深度技术调研报告.md)
- [RESEARCH-00043-TDD00019技术实现深度调研报告](../RE/RESEARCH-00043-TDD00019技术实现深度调研报告.md)
- [DR-00035-TDD00019文档审查报告](../DR/DR-00035-TDD00019文档审查报告.md)
- [DR-00036-TDD00019文档审查报告](../DR/DR-00036-TDD00019文档审查报告.md)
- [DR-00037-TDD00019文档审查报告](../DR/DR-00037-TDD00019文档审查报告.md)
- [DR-00038-TDD00019文档审查报告](../DR/DR-00038-TDD00019文档审查报告.md)

### 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| 1.0 | 2025-12-24 | 初始版本（仅概述） | Kiro |
| 1.1 | 2025-12-24 | 根据DR-00035审查报告补充完整技术设计 | Kiro |
| 1.2 | 2025-12-24 | 根据DR-00036审查报告补充测试策略、风险评估、完整代码示例 | Kiro |
| 1.3 | 2025-12-24 | 根据DR-00037审查报告和RESEARCH-00043调研结果完善测试用例 | Kiro |
| 1.4 | 2025-12-24 | 根据DR-00038审查报告清理重复章节、统一章节编号 | Kiro |

---

## 🏗️ 技术架构设计

### 1.1 模块架构图

## 📦 模块3：iOS风格组件库技术实现

### 3.1 设计目标
创建iOS风格组件库，包括IOSSwitch、IOSSettingsItem、IOSSettingsSection，提供完整的交互反馈和动画效果。

### 3.2 IOSSwitch组件

**文件路径**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/IOSSwitch.kt`

**技术要点**:
- 使用spring动画提供自然的物理反馈
- 添加按压缩放效果增强交互感
- 支持disabled状态，提高可访问性

```kotlin
package com.empathy.ai.presentation.ui.component.ios

import androidx.compose.animation.core.Spring
import androidx.compose.animation.core.animateColorAsState
import androidx.compose.animation.core.animateDpAsState
import androidx.compose.animation.core.animateFloatAsState
import androidx.compose.animation.core.spring
import androidx.compose.animation.core.tween
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.interaction.collectIsPressedAsState
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.offset
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.remember
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.scale
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.unit.dp
import com.empathy.ai.presentation.theme.iOSGreen

/**
 * iOS风格开关组件
 * 
 * 完整实现iOS开关的视觉效果和交互反馈
 * 
 * @param checked 是否选中
 * @param onCheckedChange 状态变化回调
 * @param modifier 修饰符
 * @param enabled 是否启用
 * 
 * 使用示例:
 * ```kotlin
 * var checked by remember { mutableStateOf(false) }
 * IOSSwitch(
 *     checked = checked,
 *     onCheckedChange = { checked = it }
 * )
 * ```
 */
@Composable
fun IOSSwitch(
    checked: Boolean,
    onCheckedChange: (Boolean) -> Unit,
    modifier: Modifier = Modifier,
    enabled: Boolean = true
) {
    val interactionSource = remember { MutableInteractionSource() }
    val isPressed by interactionSource.collectIsPressedAsState()
    
    // 轨道颜色动画
    val trackColor by animateColorAsState(
        targetValue = when {
            !enabled -> Color(0xFFE5E5EA).copy(alpha = 0.5f)
            checked -> iOSGreen
            else -> Color(0xFFE5E5EA)
        },
        animationSpec = tween(200),
        label = "trackColor"
    )
    
    // 滑块位置动画（使用spring动画）
    val thumbOffset by animateDpAsState(
        targetValue = if (checked) 22.dp else 2.dp,
        animationSpec = spring(
            dampingRatio = Spring.DampingRatioMediumBouncy,
            stiffness = Spring.StiffnessLow
        ),
        label = "thumbOffset"
    )
    
    // 滑块缩放（按压反馈）
    val thumbScale by animateFloatAsState(
        targetValue = if (isPressed) 1.1f else 1f,
        animationSpec = tween(100),
        label = "thumbScale"
    )
    
    Box(
        modifier = modifier
            .width(51.dp)
            .height(31.dp)
            .clip(RoundedCornerShape(15.5.dp))
            .background(trackColor)
            .clickable(
                interactionSource = interactionSource,
                indication = null,
                enabled = enabled
            ) { onCheckedChange(!checked) }
    ) {
        Box(
            modifier = Modifier
                .offset(x = thumbOffset, y = 2.dp)
                .size(27.dp)
                .scale(thumbScale)
                .shadow(2.dp, CircleShape)
                .background(Color.White, CircleShape)
        )
    }
}
```

### 3.3 IOSSettingsItem组件

**文件路径**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/IOSSettingsItem.kt`

**技术要点**:
- 使用drawBehind绘制分隔线，避免额外组件开销
- 支持多种trailing内容（箭头、开关、自定义）
- 图标容器使用彩色背景+白色图标

```kotlin
package com.empathy.ai.presentation.ui.component.ios

import androidx.compose.foundation.clickable
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ChevronRight
import androidx.compose.material3.Icon
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.drawBehind
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.empathy.ai.presentation.theme.*

/**
 * iOS风格设置项组件
 * 
 * @param icon 图标
 * @param iconBackgroundColor 图标背景色
 * @param title 标题
 * @param onClick 点击回调
 * @param modifier 修饰符
 * @param subtitle 副标题（可选）
 * @param value 右侧值文字（可选）
 * @param showArrow 是否显示箭头
 * @param showDivider 是否显示分隔线
 * @param trailing 自定义右侧内容（如开关）
 */
@Composable
fun IOSSettingsItem(
    icon: ImageVector,
    iconBackgroundColor: Color,
    title: String,
    onClick: () -> Unit,
    modifier: Modifier = Modifier,
    subtitle: String? = null,
    value: String? = null,
    showArrow: Boolean = true,
    showDivider: Boolean = true,
    trailing: @Composable (() -> Unit)? = null
) {
    Row(
        modifier = modifier
            .fillMaxWidth()
            .height(44.dp)
            .clickable(onClick = onClick)
            .padding(start = 16.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        // 图标容器
        Box(
            modifier = Modifier
                .size(28.dp)
                .background(iconBackgroundColor, RoundedCornerShape(6.dp)),
            contentAlignment = Alignment.Center
        ) {
            Icon(
                imageVector = icon,
                contentDescription = null,
                tint = Color.White,
                modifier = Modifier.size(18.dp)
            )
        }
        
        Spacer(modifier = Modifier.width(12.dp))
        
        // 内容区域（带分隔线）
        Row(
            modifier = Modifier
                .weight(1f)
                .fillMaxHeight()
                .then(
                    if (showDivider) Modifier.drawBehind {
                        drawLine(
                            color = iOSSeparator,
                            start = Offset(0f, size.height),
                            end = Offset(size.width, size.height),
                            strokeWidth = 0.5.dp.toPx()
                        )
                    } else Modifier
                )
                .padding(end = 16.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Column {
                Text(
                    text = title,
                    fontSize = 17.sp,
                    color = iOSTextPrimary
                )
                if (subtitle != null) {
                    Text(
                        text = subtitle,
                        fontSize = 12.sp,
                        color = iOSTextSecondary
                    )
                }
            }
            
            Row(
                horizontalArrangement = Arrangement.spacedBy(4.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                if (trailing != null) {
                    trailing()
                } else if (value != null) {
                    Text(
                        text = value,
                        fontSize = 17.sp,
                        color = iOSTextSecondary
                    )
                }
                if (showArrow) {
                    Icon(
                        imageVector = Icons.Default.ChevronRight,
                        contentDescription = null,
                        tint = iOSTextTertiary,
                        modifier = Modifier.size(20.dp)
                    )
                }
            }
        }
    }
}
```

### 3.4 IOSSettingsSection组件

**文件路径**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/IOSSettingsSection.kt`

```kotlin
package com.empathy.ai.presentation.ui.component.ios

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.empathy.ai.presentation.theme.iOSCardBackground
import com.empathy.ai.presentation.theme.iOSTextSecondary

/**
 * iOS风格设置分组组件
 * 
 * @param title 分组标题（可选，大写显示）
 * @param modifier 修饰符
 * @param content 分组内容
 */
@Composable
fun IOSSettingsSection(
    title: String? = null,
    modifier: Modifier = Modifier,
    content: @Composable ColumnScope.() -> Unit
) {
    Column(modifier = modifier.fillMaxWidth()) {
        // 分组标题
        if (title != null) {
            Text(
                text = title.uppercase(),
                fontSize = 13.sp,
                color = iOSTextSecondary,
                modifier = Modifier.padding(start = 16.dp, bottom = 8.dp, top = 24.dp)
            )
        }
        
        // 分组内容（白色圆角卡片）
        Card(
            modifier = Modifier.fillMaxWidth(),
            shape = RoundedCornerShape(12.dp),
            colors = CardDefaults.cardColors(containerColor = iOSCardBackground),
            elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)
        ) {
            Column {
                content()
            }
        }
    }
}
```

### 3.5 组件样式规范

| 组件 | 属性 | 规格 |
|------|------|------|
| IOSSwitch | 尺寸 | 51dp × 31dp |
| IOSSwitch | 滑块 | 27dp, 白色, 2dp阴影 |
| IOSSwitch | 激活色 | `iOSGreen` (#34C759) |
| IOSSwitch | 未激活色 | #E5E5EA |
| IOSSettingsItem | 高度 | 44dp |
| IOSSettingsItem | 图标容器 | 28dp × 28dp, 6dp圆角 |
| IOSSettingsItem | 图标 | 18dp, 白色 |
| IOSSettingsItem | 标题 | 17sp, 黑色 |
| IOSSettingsItem | 值 | 17sp, 灰色 |
| IOSSettingsItem | 箭头 | 20dp, #C7C7CC |
| IOSSettingsSection | 标题 | 13sp, 大写, 灰色 |
| IOSSettingsSection | 卡片 | 12dp圆角, 白色背景 |

---

```
┌─────────────────────────────────────────────────────────────────┐
│                        :presentation 模块                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      theme/                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│  │  │  Color.kt   │  │AvatarColors │  │   Theme.kt      │  │   │
│  │  │ (iOS系统色) │  │   .kt       │  │  (不修改)       │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   ui/component/ios/                      │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│  │  │ IOSSwitch   │  │IOSSettings  │  │IOSSettings      │  │   │
│  │  │    .kt      │  │  Item.kt    │  │  Section.kt     │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                ui/component/navigation/                  │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │         EmpathyBottomNavigation.kt              │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                     ui/screen/                           │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│  │  │ContactList  │  │ Settings    │  │PromptEditor     │  │   │
│  │  │ Screen.kt   │  │ Screen.kt   │  │  Screen.kt      │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    navigation/                           │   │
│  │  ┌─────────────┐  ┌─────────────────────────────────┐   │   │
│  │  │NavRoutes.kt │  │        NavGraph.kt              │   │   │
│  │  └─────────────┘  └─────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 组件依赖关系

```
Color.kt (iOS系统色)
    ↓
AvatarColors.kt ←────────────────────────────────────┐
    ↓                                                │
IOSSwitch.kt ←── IOSSettingsItem.kt ←── IOSSettingsSection.kt
    ↓                    ↓                           │
    └────────────────────┴───────────────────────────┤
                                                     ↓
EmpathyBottomNavigation.kt ←─────────────────────────┤
    ↓                                                │
ContactListScreen.kt ←── SettingsScreen.kt ←── PromptEditorScreen.kt
    ↓                           ↓                    ↓
    └───────────────────────────┴────────────────────┘
                                ↓
                          NavGraph.kt
```

### 1.3 数据流设计

```
用户操作 → Screen → ViewModel → UseCase → Repository
    ↑                   ↓
    └─── UiState ←──────┘

导航流程:
Tab点击 → EmpathyBottomNavigation.onNavigate() 
       → NavController.navigate() 
       → NavGraph路由匹配 
       → Screen渲染
       → currentBackStackEntryAsState()更新
       → Tab高亮状态同步
```

---

## 🎨 主题系统技术方案

### 2.1 iOS系统色常量

**修改文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/theme/Color.kt`

**技术要点**:
- 采用增量式添加，不修改现有ColorScheme
- 使用语义化命名，便于理解和维护
- 所有色值来自iOS Human Interface Guidelines

```kotlin
// ========== iOS系统色常量 ==========

/** 微信背景色 - 用于联系人列表 */
val WeChatBackground = Color(0xFFF7F7F7)

/** iOS背景色 - 用于设置、编辑器 */
val iOSBackground = Color(0xFFF2F2F7)

/** 微信绿 - 导航激活态 */
val WeChatGreen = Color(0xFF07C160)

/** iOS蓝 - 链接、按钮 */
val iOSBlue = Color(0xFF007AFF)

/** iOS绿 - 开关激活态 */
val iOSGreen = Color(0xFF34C759)

/** iOS红 - 删除、警告 */
val iOSRed = Color(0xFFFF3B30)

/** 添加按钮红 */
val AddButtonRed = Color(0xFFFA5151)

/** iOS紫 - 提示词设置图标 */
val iOSPurple = Color(0xFF5856D6)

// ========== iOS文字色 ==========

/** 主要文字 */
val iOSTextPrimary = Color(0xFF000000)

/** 次要文字 */
val iOSTextSecondary = Color(0xFF8E8E93)

/** 第三级文字 */
val iOSTextTertiary = Color(0xFFC7C7CC)

// ========== iOS分隔线和卡片 ==========

/** iOS分隔线 */
val iOSDivider = Color(0xFFE5E5EA)

/** iOS卡片背景 */
val iOSCardBackground = Color(0xFFFFFFFF)

/** iOS按下态 */
val iOSPressed = Color(0xFFE5E5EA)
```

### 2.2 AvatarColors头像淡色系

**新增文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/theme/AvatarColors.kt`

**技术要点**:
- 提供6种淡色背景+深色文字的配色方案
- 使用hashCode取模实现稳定的颜色分配
- 同一联系人始终显示相同颜色

```kotlin
package com.empathy.ai.presentation.theme

import androidx.compose.ui.graphics.Color
import kotlin.math.absoluteValue

/**
 * 头像淡色系配色方案
 * 提供6种淡色背景+深色文字的配色，用于联系人头像
 */
object AvatarColors {
    // 淡靛蓝
    val IndigoLight = Color(0xFFE8EAF6)
    val IndigoText = Color(0xFF3F51B5)
    
    // 淡蓝色
    val BlueLight = Color(0xFFE3F2FD)
    val BlueText = Color(0xFF2196F3)
    
    // 淡玫瑰
    val RoseLight = Color(0xFFFCE4EC)
    val RoseText = Color(0xFFE91E63)
    
    // 淡绿色
    val EmeraldLight = Color(0xFFE8F5E9)
    val EmeraldText = Color(0xFF4CAF50)
    
    // 淡紫色
    val VioletLight = Color(0xFFEDE7F6)
    val VioletText = Color(0xFF9C27B0)
    
    // 淡青色
    val CyanLight = Color(0xFFE0F7FA)
    val CyanText = Color(0xFF00BCD4)
    
    private val colorPairs = listOf(
        IndigoLight to IndigoText,
        BlueLight to BlueText,
        RoseLight to RoseText,
        EmeraldLight to EmeraldText,
        VioletLight to VioletText,
        CyanLight to CyanText
    )
    
    /**
     * 根据名字获取颜色对
     * @param name 联系人名字
     * @return Pair<背景色, 文字色>
     */
    fun getColorPair(name: String): Pair<Color, Color> {
        val index = name.hashCode().absoluteValue % colorPairs.size
        return colorPairs[index]
    }
}
```

---

## 📦 iOS组件库技术方案

### 3.1 IOSSwitch组件

**新增文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/IOSSwitch.kt`

**技术要点**:
- 使用animateColorAsState实现轨道颜色动画
- 使用animateDpAsState实现滑块位置动画
- 支持enabled状态控制
- 动画时长200ms，符合iOS规范

```kotlin
@Composable
fun IOSSwitch(
    checked: Boolean,
    onCheckedChange: (Boolean) -> Unit,
    modifier: Modifier = Modifier,
    enabled: Boolean = true
) {
    val interactionSource = remember { MutableInteractionSource() }
    
    // 轨道颜色动画
    val trackColor by animateColorAsState(
        targetValue = when {
            !enabled -> Color(0xFFE5E5EA).copy(alpha = 0.5f)
            checked -> iOSGreen
            else -> Color(0xFFE5E5EA)
        },
        animationSpec = tween(200),
        label = "trackColor"
    )
    
    // 滑块位置动画
    val thumbOffset by animateDpAsState(
        targetValue = if (checked) 22.dp else 2.dp,
        animationSpec = tween(200),
        label = "thumbOffset"
    )
    
    Box(
        modifier = modifier
            .width(51.dp)
            .height(31.dp)
            .clip(RoundedCornerShape(15.5.dp))
            .background(trackColor)
            .clickable(
                interactionSource = interactionSource,
                indication = null,
                enabled = enabled
            ) { onCheckedChange(!checked) }
    ) {
        Box(
            modifier = Modifier
                .offset(x = thumbOffset, y = 2.dp)
                .size(27.dp)
                .shadow(2.dp, CircleShape)
                .background(Color.White, CircleShape)
        )
    }
}
```

**组件规格**:
| 属性 | 值 | 说明 |
|------|-----|------|
| 宽度 | 51dp | iOS标准开关宽度 |
| 高度 | 31dp | iOS标准开关高度 |
| 圆角 | 15.5dp | 完全圆角 |
| 滑块直径 | 27dp | 滑块大小 |
| 激活色 | #34C759 | iOS绿 |
| 未激活色 | #E5E5EA | iOS灰 |
| 动画时长 | 200ms | 平滑过渡 |

### 3.2 IOSSettingsItem组件

**新增文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/IOSSettingsItem.kt`

**技术要点**:
- 支持图标、标题、副标题、值、箭头、自定义trailing
- 使用drawBehind绘制分隔线，避免额外组件
- 高度固定44dp，符合iOS规范

## 📦 模块4：底部导航栏技术实现

### 4.1 设计目标
创建统一的底部导航栏组件，4Tab布局，中间红色加号上浮，实现导航状态自动同步。

### 4.2 技术方案

**核心原理**: 使用NavController的currentBackStackEntryAsState()获取实时路由状态，避免手动传递currentRoute的错误。

**文件路径**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/navigation/EmpathyBottomNavigation.kt`

### 4.3 实现代码

```kotlin
package com.empathy.ai.presentation.ui.component.navigation

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.Contacts
import androidx.compose.material.icons.filled.Settings
import androidx.compose.material.icons.filled.SmartToy
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.empathy.ai.presentation.navigation.NavRoutes
import com.empathy.ai.presentation.theme.*

/**
 * 共情AI底部导航栏组件
 * 
 * 4Tab布局，中间红色加号上浮
 * 
 * @param currentRoute 当前路由
 * @param onNavigate 导航回调
 * @param onAddClick 添加按钮点击回调
 * @param modifier 修饰符
 */
@Composable
fun EmpathyBottomNavigation(
    currentRoute: String,
    onNavigate: (String) -> Unit,
    onAddClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Box(
        modifier = modifier
            .fillMaxWidth()
            .height(84.dp)
            .background(WeChatBackground)
    ) {
        // 顶部分隔线
        Divider(
            modifier = Modifier.align(Alignment.TopCenter),
            color = iOSSeparator,
            thickness = 0.5.dp
        )
        
        // 导航栏主体
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .height(50.dp)
                .align(Alignment.TopCenter)
                .padding(top = 0.5.dp),
            horizontalArrangement = Arrangement.SpaceAround,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // 联系人Tab
            NavItem(
                icon = Icons.Default.Contacts,
                label = "联系人",
                isSelected = currentRoute == NavRoutes.CONTACT_LIST,
                onClick = { onNavigate(NavRoutes.CONTACT_LIST) }
            )
            
            // 占位（给中间按钮留空间）
            Spacer(modifier = Modifier.width(48.dp))
            
            // AI军师Tab
            NavItem(
                icon = Icons.Default.SmartToy,
                label = "AI军师",
                isSelected = currentRoute == NavRoutes.AI_ADVISOR,
                onClick = { onNavigate(NavRoutes.AI_ADVISOR) }
            )
            
            // 设置Tab
            NavItem(
                icon = Icons.Default.Settings,
                label = "设置",
                isSelected = currentRoute == NavRoutes.SETTINGS,
                onClick = { onNavigate(NavRoutes.SETTINGS) }
            )
        }
        
        // 中间红色加号按钮（上浮）
        FloatingActionButton(
            onClick = onAddClick,
            modifier = Modifier
                .align(Alignment.TopCenter)
                .offset(y = (-12).dp)
                .size(48.dp),
            containerColor = AddButtonRed,
            contentColor = Color.White,
            shape = CircleShape,
            elevation = FloatingActionButtonDefaults.elevation(
                defaultElevation = 4.dp,
                pressedElevation = 8.dp
            )
        ) {
            Icon(
                imageVector = Icons.Default.Add,
                contentDescription = "添加",
                modifier = Modifier.size(26.dp)
            )
        }
        
        // iOS Home Indicator
        Box(
            modifier = Modifier
                .align(Alignment.BottomCenter)
                .padding(bottom = 8.dp)
                .width(134.dp)
                .height(5.dp)
                .background(Color.Black, RoundedCornerShape(2.5.dp))
        )
    }
}

/**
 * 导航项组件
 */
@Composable
private fun NavItem(
    icon: ImageVector,
    label: String,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    Column(
        modifier = Modifier
            .clickable(onClick = onClick)
            .padding(vertical = 4.dp, horizontal = 16.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Icon(
            imageVector = icon,
            contentDescription = label,
            tint = if (isSelected) WeChatGreen else iOSTextSecondary,
            modifier = Modifier.size(24.dp)
        )
        Spacer(modifier = Modifier.height(2.dp))
        Text(
            text = label,
            fontSize = 10.sp,
            color = if (isSelected) WeChatGreen else iOSTextSecondary
        )
    }
}
```

### 4.4 导航状态自动同步方案

**在MainScreen中实现导航状态自动同步**:

```kotlin
@Composable
fun MainScreen(navController: NavHostController = rememberNavController()) {
    // 自动获取当前路由
    val navBackStackEntry by navController.currentBackStackEntryAsState()
    val currentRoute = navBackStackEntry?.destination?.route ?: NavRoutes.CONTACT_LIST
    
    Scaffold(
        bottomBar = {
            // 只在底部导航页面显示
            if (currentRoute in NavRoutes.BOTTOM_NAV_ROUTES) {
                EmpathyBottomNavigation(
                    currentRoute = currentRoute,
                    onNavigate = { route ->
                        navController.navigate(route) {
                            popUpTo(NavRoutes.CONTACT_LIST) { saveState = true }
                            launchSingleTop = true
                            restoreState = true
                        }
                    },
                    onAddClick = { /* 处理添加 */ }
                )
            }
        }
    ) { paddingValues ->
        NavHost(
            navController = navController,
            startDestination = NavRoutes.CONTACT_LIST,
            modifier = Modifier.padding(paddingValues)
        ) {
            // 路由注册
        }
    }
}
```

### 4.5 样式规范

| 元素 | 规格 |
|------|------|
| 导航栏高度 | 50dp（不含安全区） |
| 总高度 | 84dp（含34dp安全区） |
| 背景色 | `WeChatBackground` (#F7F7F7) |
| 激活态颜色 | `WeChatGreen` (#07C160) |
| 未激活颜色 | `iOSTextSecondary` (#8E8E93) |
| 图标尺寸 | 24dp |
| 标签字号 | 10sp |
| 加号按钮 | 48dp, 红色 (#FA5151) |
| Home Indicator | 134dp × 5dp, 黑色 |

---

## 📦 模块5：联系人列表改造技术实现

### 5.1 设计目标
改造联系人列表界面，采用微信风格，使用淡色头像和简洁布局。

### 5.2 ContactListItem改造

**文件路径**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactListScreen.kt`

```kotlin
@Composable
fun ContactListItem(
    contact: ContactProfile,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    val (bgColor, textColor) = AvatarColors.getColorPair(contact.name)
    
    Row(
        modifier = modifier
            .fillMaxWidth()
            .clickable(onClick = onClick)
            .padding(horizontal = 16.dp, vertical = 12.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        // 淡色头像
        Box(
            modifier = Modifier
                .size(48.dp)
                .background(bgColor, RoundedCornerShape(4.dp)),
            contentAlignment = Alignment.Center
        ) {
            Text(
                text = contact.name.take(1),
                color = textColor,
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold
            )
        }
        
        Spacer(modifier = Modifier.width(12.dp))
        
        Column(modifier = Modifier.weight(1f)) {
            Row(verticalAlignment = Alignment.CenterVertically) {
                Text(
                    text = contact.name,
                    style = MaterialTheme.typography.bodyLarge,
                    fontWeight = FontWeight.Medium
                )
                Spacer(modifier = Modifier.width(8.dp))
                // 关系标签（灰色文字）
                Text(
                    text = contact.relationshipLevel.displayName,
                    style = MaterialTheme.typography.labelSmall,
                    color = iOSTextSecondary
                )
            }
            Spacer(modifier = Modifier.height(4.dp))
            Text(
                text = "目标：${contact.goal}",
                style = MaterialTheme.typography.bodySmall,
                color = iOSTextSecondary,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
        }
        
        // 时间
        Text(
            text = formatRelativeTime(contact.updatedAt),
            style = MaterialTheme.typography.labelSmall,
            color = iOSTextSecondary
        )
    }
}

/**
 * 格式化相对时间
 */
private fun formatRelativeTime(timestamp: Long): String {
    val now = System.currentTimeMillis()
    val diff = now - timestamp
    
    return when {
        diff < 60_000 -> "刚刚"
        diff < 3600_000 -> "${diff / 60_000}分钟前"
        diff < 86400_000 -> "${diff / 3600_000}小时前"
        diff < 604800_000 -> "${diff / 86400_000}天前"
        else -> SimpleDateFormat("MM-dd", Locale.getDefault()).format(Date(timestamp))
    }
}
```

### 5.3 ContactListScreen改造

```kotlin
@Composable
fun ContactListScreen(
    onNavigateToContactDetail: (String) -> Unit,
    onNavigate: (String) -> Unit,
    onAddClick: () -> Unit,
    viewModel: ContactListViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    Scaffold(
        containerColor = WeChatBackground,  // 微信灰背景
        topBar = {
            // 简洁标题栏
            TopAppBar(
                title = { Text("联系人") },
                actions = {
                    IconButton(onClick = { /* 搜索 */ }) {
                        Icon(Icons.Default.Search, contentDescription = "搜索")
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = WeChatBackground
                )
            )
        },
        bottomBar = {
            EmpathyBottomNavigation(
                currentRoute = NavRoutes.CONTACT_LIST,
                onNavigate = onNavigate,
                onAddClick = onAddClick
            )
        }
    ) { paddingValues ->
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues),
            contentPadding = PaddingValues(vertical = 8.dp)
        ) {
            items(uiState.contacts, key = { it.id }) { contact ->
                ContactListItem(
                    contact = contact,
                    onClick = { onNavigateToContactDetail(contact.id) }
                )
                Divider(
                    modifier = Modifier.padding(start = 76.dp),
                    color = iOSSeparator,
                    thickness = 0.5.dp
                )
            }
        }
    }
}
```

### 5.4 样式规范

| 元素 | 规格 |
|------|------|
| 背景色 | `WeChatBackground` (#F7F7F7) |
| 头像尺寸 | 48dp × 48dp |
| 头像圆角 | 4dp |
| 名字字号 | 16sp, Medium |
| 关系标签 | 12sp, 灰色 |
| 目标描述 | 13sp, 灰色 |
| 时间 | 11sp, 灰色 |
| 分隔线 | 0.5dp, 左边距76dp |

---

```kotlin
@Composable
fun IOSSettingsItem(
    icon: ImageVector,
    iconBackgroundColor: Color,
    title: String,
    onClick: () -> Unit,
    modifier: Modifier = Modifier,
    subtitle: String? = null,
    value: String? = null,
    showArrow: Boolean = true,
    showDivider: Boolean = true,
    trailing: @Composable (() -> Unit)? = null
) {
    Row(
        modifier = modifier
            .fillMaxWidth()
            .height(44.dp)
            .clickable(onClick = onClick)
            .padding(start = 16.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        // 图标容器 (28dp × 28dp, 6dp圆角)
        Box(
            modifier = Modifier
                .size(28.dp)
                .background(iconBackgroundColor, RoundedCornerShape(6.dp)),
            contentAlignment = Alignment.Center
        ) {
            Icon(
                imageVector = icon,
                contentDescription = null,
                tint = Color.White,
                modifier = Modifier.size(18.dp)
            )
        }
        
        Spacer(modifier = Modifier.width(12.dp))
        
        // 内容区域（带分隔线）
        Row(
            modifier = Modifier
                .weight(1f)
                .fillMaxHeight()
                .then(
                    if (showDivider) Modifier.drawBehind {
                        drawLine(
                            color = iOSDivider,
                            start = Offset(0f, size.height),
                            end = Offset(size.width, size.height),
                            strokeWidth = 0.5.dp.toPx()
                        )
                    } else Modifier
                )
                .padding(end = 16.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Column {
                Text(text = title, fontSize = 17.sp, color = iOSTextPrimary)
                if (subtitle != null) {
                    Text(text = subtitle, fontSize = 12.sp, color = iOSTextSecondary)
                }
            }
            
            Row(
                horizontalArrangement = Arrangement.spacedBy(4.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                when {
                    trailing != null -> trailing()
                    value != null -> Text(text = value, fontSize = 17.sp, color = iOSTextSecondary)
                }
                if (showArrow) {
                    Icon(
                        imageVector = Icons.Default.ChevronRight,
                        contentDescription = null,
                        tint = iOSTextTertiary,
                        modifier = Modifier.size(20.dp)
                    )
                }
            }
        }
    }
}
```

### 3.3 IOSSettingsSection组件

**新增文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/IOSSettingsSection.kt`

**技术要点**:
- 支持可选的分组标题（大写显示）
- 白色圆角卡片容器
- 无阴影，符合iOS扁平化设计

```kotlin
@Composable
fun IOSSettingsSection(
    title: String? = null,
    modifier: Modifier = Modifier,
    content: @Composable ColumnScope.() -> Unit
) {
    Column(modifier = modifier.fillMaxWidth()) {
        // 分组标题（大写）
        if (title != null) {
            Text(
                text = title.uppercase(),
                fontSize = 13.sp,
                color = iOSTextSecondary,
                modifier = Modifier.padding(start = 16.dp, bottom = 8.dp, top = 24.dp)
            )
        }
        
        // 分组内容（白色圆角卡片）
        Card(
            modifier = Modifier.fillMaxWidth(),
            shape = RoundedCornerShape(12.dp),
            colors = CardDefaults.cardColors(containerColor = iOSCardBackground),
            elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)
        ) {
            Column { content() }
        }
    }
}
```

### 3.4 EmpathyBottomNavigation组件

**新增文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/navigation/EmpathyBottomNavigation.kt`

**技术要点**:
- 4Tab布局，中间红色加号上浮
- 使用Box布局实现加号按钮上浮效果
- 包含iOS Home Indicator
- 总高度84dp（50dp导航栏 + 34dp安全区）

```kotlin
@Composable
fun EmpathyBottomNavigation(
    currentRoute: String,
    onNavigate: (String) -> Unit,
    onAddClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Box(
        modifier = modifier
            .fillMaxWidth()
            .height(84.dp)
            .background(WeChatBackground)
    ) {
        // 顶部分隔线
        Divider(
            modifier = Modifier.align(Alignment.TopCenter),
            color = iOSDivider,
            thickness = 0.5.dp
        )
        
        // 导航栏主体
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .height(50.dp)
                .align(Alignment.TopCenter)
                .padding(top = 0.5.dp),
            horizontalArrangement = Arrangement.SpaceAround,
            verticalAlignment = Alignment.CenterVertically
        ) {
            NavItem(
                icon = Icons.Default.Contacts,
                label = "联系人",
                isSelected = currentRoute == NavRoutes.CONTACT_LIST,
                onClick = { onNavigate(NavRoutes.CONTACT_LIST) }
            )
            
            Spacer(modifier = Modifier.width(48.dp)) // 给中间按钮留空间
            
            NavItem(
                icon = Icons.Default.SmartToy,
                label = "AI军师",
                isSelected = currentRoute == NavRoutes.AI_ADVISOR,
                onClick = { onNavigate(NavRoutes.AI_ADVISOR) }
            )
            
            NavItem(
                icon = Icons.Default.Settings,
                label = "设置",
                isSelected = currentRoute == NavRoutes.SETTINGS,
                onClick = { onNavigate(NavRoutes.SETTINGS) }
            )
        }
        
        // 中间红色加号按钮（上浮）
        FloatingActionButton(
            onClick = onAddClick,
            modifier = Modifier
                .align(Alignment.TopCenter)
                .offset(y = (-12).dp)
                .size(48.dp),
            containerColor = AddButtonRed,
            contentColor = Color.White,
            shape = CircleShape,
            elevation = FloatingActionButtonDefaults.elevation(
                defaultElevation = 4.dp,
                pressedElevation = 8.dp
            )
        ) {
            Icon(
                imageVector = Icons.Default.Add,
                contentDescription = "添加",
                modifier = Modifier.size(26.dp)
            )
        }
        
        // iOS Home Indicator
        Box(
            modifier = Modifier
                .align(Alignment.BottomCenter)
                .padding(bottom = 8.dp)
                .width(134.dp)
                .height(5.dp)
                .background(Color.Black, RoundedCornerShape(2.5.dp))
        )
    }
}

@Composable
private fun NavItem(
    icon: ImageVector,
    label: String,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    Column(
        modifier = Modifier
            .clickable(onClick = onClick)
            .padding(vertical = 4.dp, horizontal = 16.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Icon(
            imageVector = icon,
            contentDescription = label,
            tint = if (isSelected) WeChatGreen else iOSTextSecondary,
            modifier = Modifier.size(24.dp)
        )
        Spacer(modifier = Modifier.height(2.dp))
        Text(
            text = label,
            fontSize = 10.sp,
            color = if (isSelected) WeChatGreen else iOSTextSecondary
        )
    }
}
```

---

## 🧭 导航系统集成方案

### 4.1 NavRoutes.kt修改

**修改文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NavRoutes.kt`

```kotlin
object NavRoutes {
    // 现有路由（保持不变）
    const val CONTACT_DETAIL = "contact_detail"
    const val AI_CONFIG = "ai_config"
    // ...
    
    // 🆕 新增路由常量
    const val CONTACT_LIST = "contact_list"
    const val SETTINGS = "settings"
    const val PROMPT_EDITOR = "prompt_editor"
    const val AI_ADVISOR = "ai_advisor"
    
    // 🆕 底部导航Tab路由列表
    val BOTTOM_NAV_ROUTES = listOf(
        CONTACT_LIST,
        AI_ADVISOR,
        SETTINGS
    )
}
```

### 4.2 NavGraph.kt修改

**修改文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NavGraph.kt`

**技术要点**:
- 使用currentBackStackEntryAsState()自动同步导航状态
- 使用popUpTo和launchSingleTop避免重复入栈
- 使用restoreState保持页面状态

```kotlin
@Composable
fun NavGraph(
    navController: NavHostController,
    modifier: Modifier = Modifier
) {
    // 🆕 自动获取当前路由状态
    val navBackStackEntry by navController.currentBackStackEntryAsState()
    val currentRoute = navBackStackEntry?.destination?.route ?: NavRoutes.CONTACT_LIST
    
    NavHost(
        navController = navController,
        startDestination = NavRoutes.CONTACT_LIST,  // 🆕 修改起始页
        modifier = modifier
    ) {
        // 🆕 联系人列表页（带底部导航）
        composable(NavRoutes.CONTACT_LIST) {
            ContactListScreen(
                currentRoute = currentRoute,
                onNavigateToContactDetail = { contactId ->
                    navController.navigate("${NavRoutes.CONTACT_DETAIL}/$contactId")
                },
                onNavigate = { route ->
                    navController.navigate(route) {
                        popUpTo(NavRoutes.CONTACT_LIST) { saveState = true }
                        launchSingleTop = true
                        restoreState = true
                    }
                },
                onAddClick = { /* 处理添加联系人 */ }
            )
        }
        
        // 🆕 设置页（带底部导航）
        composable(NavRoutes.SETTINGS) {
            SettingsScreen(
                currentRoute = currentRoute,
                onNavigateToAiConfig = { navController.navigate(NavRoutes.AI_CONFIG) },
                onNavigateToPromptEditor = { navController.navigate(NavRoutes.PROMPT_EDITOR) },
                onNavigate = { route ->
                    navController.navigate(route) {
                        popUpTo(NavRoutes.CONTACT_LIST) { saveState = true }
                        launchSingleTop = true
                        restoreState = true
                    }
                }
            )
        }
        
        // 🆕 提示词编辑器页
        composable(NavRoutes.PROMPT_EDITOR) {
            PromptEditorScreen(onNavigateBack = { navController.popBackStack() })
        }
        
        // 🆕 AI军师页（带底部导航）
        composable(NavRoutes.AI_ADVISOR) {
            AiAdvisorScreen(
                currentRoute = currentRoute,
                onNavigate = { route ->
                    navController.navigate(route) {
                        popUpTo(NavRoutes.CONTACT_LIST) { saveState = true }
                        launchSingleTop = true
                        restoreState = true
                    }
                }
            )
        }
        
        // 现有路由（保持不变）
        // ...
    }
}
```

### 4.3 导航状态同步机制

```
┌─────────────────────────────────────────────────────────────┐
│                    NavController                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           currentBackStackEntryAsState()            │   │
│  │                        ↓                            │   │
│  │              navBackStackEntry                      │   │
│  │                        ↓                            │   │
│  │         destination?.route ?: CONTACT_LIST          │   │
│  │                        ↓                            │   │
│  │                  currentRoute                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           EmpathyBottomNavigation                   │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐            │   │
│  │  │联系人   │  │ AI军师  │  │  设置   │            │   │
│  │  │isSelected│  │isSelected│  │isSelected│            │   │
│  │  │= route  │  │= route  │  │= route  │            │   │
│  │  │matches  │  │matches  │  │matches  │            │   │
│  │  └─────────┘  └─────────┘  └─────────┘            │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 📱 页面改造技术方案

### 5.1 ContactListScreen改造

**修改文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactListScreen.kt`

**改造要点**:
- 背景色改为WeChatBackground (#F7F7F7)
- 集成EmpathyBottomNavigation
- 使用淡色头像（AvatarColors）
- 添加关系标签和目标描述

```kotlin
@Composable
fun ContactListScreen(
    currentRoute: String,
    onNavigateToContactDetail: (String) -> Unit,
    onNavigate: (String) -> Unit,
    onAddClick: () -> Unit,
    viewModel: ContactListViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    Scaffold(
        containerColor = WeChatBackground,  // 🆕 微信背景色
        bottomBar = {
            EmpathyBottomNavigation(  // 🆕 底部导航栏
                currentRoute = currentRoute,
                onNavigate = onNavigate,
                onAddClick = onAddClick
            )
        }
    ) { paddingValues ->
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
        ) {
            items(uiState.contacts) { contact ->
                ContactListItem(
                    contact = contact,
                    onClick = { onNavigateToContactDetail(contact.id) }
                )
            }
        }
    }
}

@Composable
fun ContactListItem(
    contact: ContactProfile,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    val (bgColor, textColor) = AvatarColors.getColorPair(contact.name)
    
    Row(
        modifier = modifier
            .fillMaxWidth()
            .clickable(onClick = onClick)
            .padding(horizontal = 16.dp, vertical = 12.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        // 🆕 淡色头像
        Box(
            modifier = Modifier
                .size(48.dp)
                .background(bgColor, RoundedCornerShape(4.dp)),
            contentAlignment = Alignment.Center
        ) {
            Text(
                text = contact.name.take(1),
                color = textColor,
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold
            )
        }
        
        Spacer(modifier = Modifier.width(12.dp))
        
        Column(modifier = Modifier.weight(1f)) {
            Row(verticalAlignment = Alignment.CenterVertically) {
                Text(
                    text = contact.name,
                    style = MaterialTheme.typography.bodyLarge,
                    fontWeight = FontWeight.Medium
                )
                Spacer(modifier = Modifier.width(8.dp))
                // 🆕 关系标签
                Text(
                    text = contact.relationshipLevel.displayName,
                    style = MaterialTheme.typography.labelSmall,
                    color = iOSTextSecondary
                )
            }
            Spacer(modifier = Modifier.height(4.dp))
            // 🆕 目标描述
            Text(
                text = "目标：${contact.goal}",
                style = MaterialTheme.typography.bodySmall,
                color = iOSTextSecondary,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
        }
        
        // 时间
        Text(
            text = formatRelativeTime(contact.updatedAt),
            style = MaterialTheme.typography.labelSmall,
            color = iOSTextSecondary
        )
    }
}
```

### 5.2 SettingsScreen改造

**修改文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsScreen.kt`

**改造要点**:
- 背景色改为iOSBackground (#F2F2F7)
- 使用iOS大标题（34sp, Bold）
- 使用IOSSettingsSection分组
- 使用IOSSettingsItem设置项
- 使用IOSSwitch替换Material开关

```kotlin
@Composable
fun SettingsScreen(
    currentRoute: String,
    onNavigateToAiConfig: () -> Unit,
    onNavigateToPromptEditor: () -> Unit,
    onNavigate: (String) -> Unit,
    viewModel: SettingsViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    Scaffold(
        containerColor = iOSBackground,  // 🆕 iOS背景色
        bottomBar = {
            EmpathyBottomNavigation(
                currentRoute = currentRoute,
                onNavigate = onNavigate,
                onAddClick = { /* 处理添加 */ }
            )
        }
    ) { paddingValues ->
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
        ) {
            // 🆕 iOS大标题
            item {
                Text(
                    text = "设置",
                    fontSize = 34.sp,
                    fontWeight = FontWeight.Bold,
                    modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)
                )
            }
            
            // 用户信息卡片
            item {
                IOSSettingsSection {
                    IOSSettingsItem(
                        icon = Icons.Default.Person,
                        iconBackgroundColor = iOSBlue,
                        title = "共情AI",
                        subtitle = "隐私优先 · 本地存储",
                        onClick = { },
                        showDivider = false
                    )
                }
            }

            // AI配置分组
            item {
                IOSSettingsSection(title = "AI 配置") {
                    IOSSettingsItem(
                        icon = Icons.Default.SmartToy,
                        iconBackgroundColor = iOSGreen,
                        title = "AI 服务商",
                        value = uiState.currentProvider?.name ?: "未配置",
                        onClick = onNavigateToAiConfig
                    )
                    IOSSettingsItem(
                        icon = Icons.Default.EditNote,
                        iconBackgroundColor = iOSPurple,
                        title = "提示词设置",
                        onClick = onNavigateToPromptEditor,
                        showDivider = false
                    )
                }
            }
            
            // 悬浮窗分组
            item {
                IOSSettingsSection(title = "悬浮窗") {
                    IOSSettingsItem(
                        icon = Icons.Default.Layers,
                        iconBackgroundColor = iOSBlue,
                        title = "启用悬浮窗",
                        onClick = { viewModel.onEvent(SettingsUiEvent.ToggleFloatingWindow) },
                        showArrow = false,
                        trailing = {
                            IOSSwitch(
                                checked = uiState.floatingWindowEnabled,
                                onCheckedChange = { viewModel.onEvent(SettingsUiEvent.ToggleFloatingWindow) }
                            )
                        }
                    )
                    IOSSettingsItem(
                        icon = Icons.Default.Settings,
                        iconBackgroundColor = iOSTextSecondary,
                        title = "默认模式",
                        value = uiState.defaultMode.displayName,
                        onClick = { /* 选择默认模式 */ },
                        showDivider = false
                    )
                }
            }

            // 隐私保护分组
            item {
                IOSSettingsSection(title = "隐私保护") {
                    IOSSettingsItem(
                        icon = Icons.Default.Shield,
                        iconBackgroundColor = iOSGreen,
                        title = "数据掩码",
                        onClick = { viewModel.onEvent(SettingsUiEvent.ToggleDataMasking) },
                        showArrow = false,
                        trailing = {
                            IOSSwitch(
                                checked = uiState.dataMaskingEnabled,
                                onCheckedChange = { viewModel.onEvent(SettingsUiEvent.ToggleDataMasking) }
                            )
                        }
                    )
                    IOSSettingsItem(
                        icon = Icons.Default.Storage,
                        iconBackgroundColor = iOSBlue,
                        title = "本地优先模式",
                        onClick = { viewModel.onEvent(SettingsUiEvent.ToggleLocalFirstMode) },
                        showArrow = false,
                        showDivider = false,
                        trailing = {
                            IOSSwitch(
                                checked = uiState.localFirstMode,
                                onCheckedChange = { viewModel.onEvent(SettingsUiEvent.ToggleLocalFirstMode) }
                            )
                        }
                    )
                }
            }
            
            // 关于分组
            item {
                IOSSettingsSection(title = "关于") {
                    IOSSettingsItem(
                        icon = Icons.Default.Info,
                        iconBackgroundColor = iOSTextSecondary,
                        title = "版本",
                        value = uiState.appVersion,
                        onClick = { },
                        showArrow = false,
                        showDivider = false
                    )
                }
            }
        }
    }
}
```


### 5.3 PromptEditorScreen改造

**修改文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/prompt/PromptEditorScreen.kt`

**改造要点**:
- iOS风格导航栏（取消/标题/完成）
- 场景切换Tab（圆角胶囊样式）
- 删除变量区域，简化界面
- iOS风格底部按钮（恢复默认/保存）

```kotlin
@Composable
fun PromptEditorScreen(
    onNavigateBack: () -> Unit,
    viewModel: PromptEditorViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    Scaffold(
        containerColor = iOSBackground,
        topBar = {
            // iOS风格导航栏
            Surface(
                modifier = Modifier.fillMaxWidth(),
                color = Color.White.copy(alpha = 0.95f)
            ) {
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .statusBarsPadding()
                        .height(44.dp)
                        .padding(horizontal = 16.dp),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    TextButton(onClick = onNavigateBack) {
                        Text("取消", color = iOSBlue, fontSize = 17.sp)
                    }
                    Text(
                        text = "编辑提示词",
                        fontSize = 17.sp,
                        fontWeight = FontWeight.SemiBold
                    )
                    TextButton(
                        onClick = { viewModel.onEvent(PromptEditorUiEvent.SavePrompt) },
                        enabled = uiState.canSave
                    ) {
                        Text(
                            text = "完成",
                            color = if (uiState.canSave) iOSBlue else iOSTextSecondary,
                            fontSize = 17.sp,
                            fontWeight = FontWeight.SemiBold
                        )
                    }
                }
            }
        }

    ) { paddingValues ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
        ) {
            // 场景切换Tab
            Surface(color = iOSCardBackground) {
                PromptSceneTab(
                    scenes = PromptScene.SETTINGS_SCENE_ORDER,
                    selectedScene = uiState.currentScene,
                    onSceneSelected = { viewModel.onEvent(PromptEditorUiEvent.SwitchScene(it)) }
                )
            }
            
            Divider(color = iOSDivider, thickness = 0.5.dp)
            
            // 主编辑区域
            Column(
                modifier = Modifier
                    .weight(1f)
                    .padding(16.dp)
            ) {
                // 编辑器卡片
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    shape = RoundedCornerShape(12.dp),
                    colors = CardDefaults.cardColors(containerColor = iOSCardBackground)
                ) {
                    Column(modifier = Modifier.padding(16.dp)) {
                        BasicTextField(
                            value = uiState.promptText,
                            onValueChange = { viewModel.onEvent(PromptEditorUiEvent.UpdatePromptText(it)) },
                            modifier = Modifier
                                .fillMaxWidth()
                                .heightIn(min = 200.dp),
                            textStyle = TextStyle(fontSize = 16.sp, color = iOSTextPrimary),
                            decorationBox = { innerTextField ->
                                Box {
                                    if (uiState.promptText.isEmpty()) {
                                        Text(
                                            text = "输入你的自定义提示词...",
                                            color = iOSTextTertiary,
                                            fontSize = 16.sp
                                        )
                                    }
                                    innerTextField()
                                }
                            }
                        )

                        Spacer(modifier = Modifier.height(12.dp))
                        Divider(color = iOSDivider, thickness = 0.5.dp)
                        Spacer(modifier = Modifier.height(12.dp))
                        
                        // 底部工具栏
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            horizontalArrangement = Arrangement.SpaceBetween,
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            TextButton(onClick = { viewModel.onEvent(PromptEditorUiEvent.OptimizeWithAi) }) {
                                Icon(
                                    imageVector = Icons.Default.AutoAwesome,
                                    contentDescription = null,
                                    tint = iOSBlue,
                                    modifier = Modifier.size(16.dp)
                                )
                                Spacer(modifier = Modifier.width(4.dp))
                                Text("AI优化", color = iOSBlue, fontSize = 14.sp)
                            }
                            Text(
                                text = "${uiState.promptText.length} / 2000",
                                color = iOSTextSecondary,
                                fontSize = 13.sp
                            )
                        }
                    }
                }
                
                Spacer(modifier = Modifier.height(12.dp))
                
                // 提示文字
                Text(
                    text = "提示词将帮助 AI 更好地理解你的需求，生成更符合预期的回复。",
                    color = iOSTextSecondary,
                    fontSize = 13.sp,
                    modifier = Modifier.padding(horizontal = 4.dp)
                )
            }

            // 底部按钮
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 16.dp, vertical = 16.dp),
                horizontalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                // 恢复默认按钮
                OutlinedButton(
                    onClick = { viewModel.onEvent(PromptEditorUiEvent.ResetToDefault) },
                    modifier = Modifier
                        .weight(1f)
                        .height(50.dp),
                    shape = RoundedCornerShape(12.dp),
                    border = BorderStroke(1.dp, iOSDivider)
                ) {
                    Icon(
                        imageVector = Icons.Default.RestartAlt,
                        contentDescription = null,
                        tint = iOSTextSecondary,
                        modifier = Modifier.size(20.dp)
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("恢复默认", color = iOSTextSecondary)
                }
                
                // 保存按钮
                Button(
                    onClick = { viewModel.onEvent(PromptEditorUiEvent.SavePrompt) },
                    modifier = Modifier
                        .weight(1f)
                        .height(50.dp),
                    shape = RoundedCornerShape(12.dp),
                    colors = ButtonDefaults.buttonColors(containerColor = iOSBlue),
                    enabled = uiState.canSave
                ) {
                    Icon(
                        imageVector = Icons.Default.Save,
                        contentDescription = null,
                        modifier = Modifier.size(20.dp)
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("保存")
                }
            }
        }
    }
}
```


### 5.4 PromptSceneTab组件

**新增文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/prompt/component/PromptSceneTab.kt`

```kotlin
@Composable
fun PromptSceneTab(
    scenes: List<PromptScene>,
    selectedScene: PromptScene,
    onSceneSelected: (PromptScene) -> Unit,
    modifier: Modifier = Modifier
) {
    Row(
        modifier = modifier
            .fillMaxWidth()
            .horizontalScroll(rememberScrollState())
            .padding(horizontal = 16.dp, vertical = 12.dp),
        horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        scenes.forEach { scene ->
            val isSelected = scene == selectedScene
            val backgroundColor = if (isSelected) iOSBlue else Color(0xFFE5E5EA)
            val textColor = if (isSelected) Color.White else iOSTextSecondary
            
            Surface(
                modifier = Modifier
                    .clip(RoundedCornerShape(50))
                    .clickable { onSceneSelected(scene) },
                color = backgroundColor
            ) {
                Row(
                    modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp),
                    horizontalArrangement = Arrangement.spacedBy(6.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        imageVector = scene.icon,
                        contentDescription = null,
                        tint = textColor,
                        modifier = Modifier.size(16.dp)
                    )
                    Text(
                        text = scene.displayName,
                        fontSize = 14.sp,
                        fontWeight = FontWeight.Medium,
                        color = textColor
                    )
                }
            }
        }
    }
}

            // AI配置分组
            item {
                IOSSettingsSection(title = "AI 配置") {
                    IOSSettingsItem(
                        icon = Icons.Default.SmartToy,
                        iconBackgroundColor = iOSGreen,
                        title = "AI 服务商",
                        value = uiState.currentProvider?.name ?: "未配置",
                        onClick = onNavigateToAiConfig
                    )
                    IOSSettingsItem(
                        icon = Icons.Default.EditNote,
                        iconBackgroundColor = iOSPurple,
                        title = "提示词设置",
                        onClick = onNavigateToPromptEditor,
                        showDivider = false
                    )
                }
            }
            
            // 悬浮窗设置分组
            item {
                IOSSettingsSection(title = "悬浮窗") {
                    IOSSettingsItem(
                        icon = Icons.Default.Layers,
                        iconBackgroundColor = iOSBlue,
                        title = "启用悬浮窗",
                        onClick = { viewModel.onEvent(SettingsUiEvent.ToggleFloatingWindow) },
                        showArrow = false,
                        trailing = {
                            IOSSwitch(
                                checked = uiState.floatingWindowEnabled,
                                onCheckedChange = { viewModel.onEvent(SettingsUiEvent.ToggleFloatingWindow) }
                            )
                        }
                    )
                    IOSSettingsItem(
                        icon = Icons.Default.Tune,
                        iconBackgroundColor = Color(0xFF5AC8FA),
                        title = "默认模式",
                        value = uiState.defaultMode.displayName,
                        onClick = { /* 显示模式选择 */ },
                        showDivider = false
                    )
                }
            }
            
            // 隐私保护分组
            item {
                IOSSettingsSection(title = "隐私保护") {
                    IOSSettingsItem(
                        icon = Icons.Default.Shield,
                        iconBackgroundColor = iOSGreen,
                        title = "数据掩码",
                        onClick = { viewModel.onEvent(SettingsUiEvent.ToggleDataMasking) },
                        showArrow = false,
                        trailing = {
                            IOSSwitch(
                                checked = uiState.dataMaskingEnabled,
                                onCheckedChange = { viewModel.onEvent(SettingsUiEvent.ToggleDataMasking) }
                            )
                        }
                    )
                    IOSSettingsItem(
                        icon = Icons.Default.Storage,
                        iconBackgroundColor = iOSBlue,
                        title = "本地优先模式",
                        onClick = { viewModel.onEvent(SettingsUiEvent.ToggleLocalFirstMode) },
                        showArrow = false,
                        showDivider = false,
                        trailing = {
                            IOSSwitch(
                                checked = uiState.localFirstMode,
                                onCheckedChange = { viewModel.onEvent(SettingsUiEvent.ToggleLocalFirstMode) }
                            )
                        }
                    )
                }
            }
            
            // 数据管理分组
            item {
                IOSSettingsSection(title = "数据管理") {
                    IOSSettingsItem(
                        icon = Icons.Default.History,
                        iconBackgroundColor = Color(0xFFFF9500),
                        title = "历史对话",
                        value = "${uiState.conversationCount}条",
                        onClick = { /* 查看历史对话 */ }
                    )
                    IOSSettingsItem(
                        icon = Icons.Default.DeleteForever,
                        iconBackgroundColor = iOSRed,
                        title = "清除所有数据",
                        onClick = { viewModel.onEvent(SettingsUiEvent.ShowClearDataDialog) },
                        showDivider = false
                    )
                }
            }
            
            // 关于分组
            item {
                IOSSettingsSection(title = "关于") {
                    IOSSettingsItem(
                        icon = Icons.Default.Info,
                        iconBackgroundColor = Color(0xFF8E8E93),
                        title = "版本",
                        value = uiState.appVersion,
                        onClick = { },
                        showArrow = false,
                        showDivider = false
                    )
                }
            }
        }
    }
}
```

---

## 🧪 测试策略

### 7.1 单元测试

#### AvatarColors测试

**测试文件**: `presentation/src/test/kotlin/com/empathy/ai/presentation/theme/AvatarColorsTest.kt`

```kotlin
package com.empathy.ai.presentation.theme

import androidx.compose.ui.graphics.Color
import org.junit.Assert.assertEquals
import org.junit.Assert.assertNotNull
import org.junit.Assert.assertTrue
import org.junit.Test

class AvatarColorsTest {
    
    @Test
    fun `getColorPair returns valid color pair for any name`() {
        val names = listOf("张三", "李四", "王五", "赵六", "A", "测试")
        names.forEach { name ->
            val (bgColor, textColor) = AvatarColors.getColorPair(name)
            assertNotNull("背景色不应为null", bgColor)
            assertNotNull("文字色不应为null", textColor)
        }
    }
    
    @Test
    fun `getColorPair returns consistent color for same name`() {
        val name = "张三"
        val pair1 = AvatarColors.getColorPair(name)
        val pair2 = AvatarColors.getColorPair(name)
        
        assertEquals("相同名字应返回相同背景色", pair1.first, pair2.first)
        assertEquals("相同名字应返回相同文字色", pair1.second, pair2.second)
    }
    
    @Test
    fun `getColorPair distributes colors across 6 options`() {
        val colors = mutableSetOf<Pair<Color, Color>>()
        (1..100).forEach { i ->
            colors.add(AvatarColors.getColorPair("Name$i"))
        }
        assertTrue("应至少使用4种不同颜色", colors.size >= 4)
    }
    
    @Test
    fun `getColorPair handles empty string`() {
        val (bgColor, textColor) = AvatarColors.getColorPair("")
        assertNotNull("空字符串应返回有效背景色", bgColor)
        assertNotNull("空字符串应返回有效文字色", textColor)
    }
    
    @Test
    fun `getColorPair handles special characters`() {
        val specialNames = listOf("@#$%", "123", "   ", "中文English混合")
        specialNames.forEach { name ->
            val (bgColor, textColor) = AvatarColors.getColorPair(name)
            assertNotNull("特殊字符应返回有效背景色: $name", bgColor)
            assertNotNull("特殊字符应返回有效文字色: $name", textColor)
        }
    }
}
```

#### IOSSwitch测试

**测试文件**: `presentation/src/test/kotlin/com/empathy/ai/presentation/ui/component/ios/IOSSwitchTest.kt`

```kotlin
package com.empathy.ai.presentation.ui.component.ios

import androidx.compose.ui.test.assertIsDisplayed
import androidx.compose.ui.test.assertIsEnabled
import androidx.compose.ui.test.assertIsNotEnabled
import androidx.compose.ui.test.junit4.createComposeRule
import androidx.compose.ui.test.onRoot
import androidx.compose.ui.test.performClick
import org.junit.Assert.assertFalse
import org.junit.Assert.assertTrue
import org.junit.Rule
import org.junit.Test

class IOSSwitchTest {
    
    @get:Rule
    val composeTestRule = createComposeRule()
    
    @Test
    fun `IOSSwitch displays correctly when checked`() {
        composeTestRule.setContent {
            IOSSwitch(checked = true, onCheckedChange = {})
        }
        
        // 验证开关存在且可见
        composeTestRule.onRoot().assertIsDisplayed()
        composeTestRule.onRoot().assertIsEnabled()
    }
    
    @Test
    fun `IOSSwitch displays correctly when unchecked`() {
        composeTestRule.setContent {
            IOSSwitch(checked = false, onCheckedChange = {})
        }
        
        // 验证开关存在且可见
        composeTestRule.onRoot().assertIsDisplayed()
        composeTestRule.onRoot().assertIsEnabled()
    }
    
    @Test
    fun `IOSSwitch toggles state on click`() {
        var checked = false
        
        composeTestRule.setContent {
            IOSSwitch(
                checked = checked,
                onCheckedChange = { checked = it }
            )
        }
        
        composeTestRule.onRoot().performClick()
        assertTrue("点击后状态应变为true", checked)
    }
    
    @Test
    fun `IOSSwitch respects enabled state`() {
        var clicked = false
        
        composeTestRule.setContent {
            IOSSwitch(
                checked = false,
                onCheckedChange = { clicked = true },
                enabled = false
            )
        }
        
        composeTestRule.onRoot().performClick()
        assertFalse("禁用状态下点击不应触发回调", clicked)
    }
    
    @Test
    fun `IOSSwitch shows disabled appearance when disabled`() {
        composeTestRule.setContent {
            IOSSwitch(
                checked = false,
                onCheckedChange = {},
                enabled = false
            )
        }
        
        // 验证开关显示为禁用状态
        composeTestRule.onRoot().assertIsDisplayed()
    }
}
```

#### EmpathyBottomNavigation测试

**测试文件**: `presentation/src/test/kotlin/com/empathy/ai/presentation/ui/component/navigation/EmpathyBottomNavigationTest.kt`

```kotlin
package com.empathy.ai.presentation.ui.component.navigation

import androidx.compose.ui.test.assertIsDisplayed
import androidx.compose.ui.test.junit4.createComposeRule
import androidx.compose.ui.test.onNodeWithContentDescription
import androidx.compose.ui.test.onNodeWithText
import androidx.compose.ui.test.performClick
import com.empathy.ai.presentation.navigation.NavRoutes
import org.junit.Assert.assertEquals
import org.junit.Assert.assertTrue
import org.junit.Rule
import org.junit.Test

class EmpathyBottomNavigationTest {
    
    @get:Rule
    val composeTestRule = createComposeRule()
    
    @Test
    fun `displays all navigation items`() {
        composeTestRule.setContent {
            EmpathyBottomNavigation(
                currentRoute = NavRoutes.CONTACT_LIST,
                onNavigate = {},
                onAddClick = {}
            )
        }
        
        composeTestRule.onNodeWithText("联系人").assertIsDisplayed()
        composeTestRule.onNodeWithText("AI军师").assertIsDisplayed()
        composeTestRule.onNodeWithText("设置").assertIsDisplayed()
    }
    
    @Test
    fun `displays add button`() {
        composeTestRule.setContent {
            EmpathyBottomNavigation(
                currentRoute = NavRoutes.CONTACT_LIST,
                onNavigate = {},
                onAddClick = {}
            )
        }
        
        composeTestRule.onNodeWithContentDescription("添加").assertIsDisplayed()
    }
    
    @Test
    fun `correct tab is highlighted based on currentRoute`() {
        composeTestRule.setContent {
            EmpathyBottomNavigation(
                currentRoute = NavRoutes.SETTINGS,
                onNavigate = {},
                onAddClick = {}
            )
        }
        
        // 设置Tab应该存在并显示
        composeTestRule.onNodeWithText("设置").assertIsDisplayed()
    }
    
    @Test
    fun `onNavigate is called when tab is clicked`() {
        var navigatedRoute = ""
        
        composeTestRule.setContent {
            EmpathyBottomNavigation(
                currentRoute = NavRoutes.CONTACT_LIST,
                onNavigate = { navigatedRoute = it },
                onAddClick = {}
            )
        }
        
        composeTestRule.onNodeWithText("设置").performClick()
        assertEquals("点击设置Tab应导航到设置页面", NavRoutes.SETTINGS, navigatedRoute)
    }
    
    @Test
    fun `onNavigate is called for AI advisor tab`() {
        var navigatedRoute = ""
        
        composeTestRule.setContent {
            EmpathyBottomNavigation(
                currentRoute = NavRoutes.CONTACT_LIST,
                onNavigate = { navigatedRoute = it },
                onAddClick = {}
            )
        }
        
        composeTestRule.onNodeWithText("AI军师").performClick()
        assertEquals("点击AI军师Tab应导航到AI军师页面", NavRoutes.AI_ADVISOR, navigatedRoute)
    }
    
    @Test
    fun `onAddClick is called when add button is clicked`() {
        var addClicked = false
        
        composeTestRule.setContent {
            EmpathyBottomNavigation(
                currentRoute = NavRoutes.CONTACT_LIST,
                onNavigate = {},
                onAddClick = { addClicked = true }
            )
        }
        
        composeTestRule.onNodeWithContentDescription("添加").performClick()
        assertTrue("点击添加按钮应触发回调", addClicked)
    }
}
```

### 7.2 UI测试

#### ContactListScreen测试

**测试文件**: `presentation/src/androidTest/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactListScreenTest.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.contact

import androidx.activity.ComponentActivity
import androidx.compose.ui.test.assertIsDisplayed
import androidx.compose.ui.test.junit4.createAndroidComposeRule
import androidx.compose.ui.test.onNodeWithText
import androidx.compose.ui.test.performClick
import com.empathy.ai.presentation.navigation.NavRoutes
import dagger.hilt.android.testing.HiltAndroidRule
import dagger.hilt.android.testing.HiltAndroidTest
import org.junit.Assert.assertEquals
import org.junit.Rule
import org.junit.Test

@HiltAndroidTest
class ContactListScreenTest {
    
    @get:Rule(order = 0)
    val hiltRule = HiltAndroidRule(this)
    
    @get:Rule(order = 1)
    val composeTestRule = createAndroidComposeRule<ComponentActivity>()
    
    @Test
    fun `contact list screen displays correctly`() {
        composeTestRule.setContent {
            ContactListScreen(
                currentRoute = NavRoutes.CONTACT_LIST,
                onNavigateToContactDetail = {},
                onNavigate = {},
                onAddClick = {}
            )
        }
        
        // 验证页面基本元素存在
        composeTestRule.waitForIdle()
    }
    
    @Test
    fun `bottom navigation is displayed`() {
        composeTestRule.setContent {
            ContactListScreen(
                currentRoute = NavRoutes.CONTACT_LIST,
                onNavigateToContactDetail = {},
                onNavigate = {},
                onAddClick = {}
            )
        }
        
        composeTestRule.onNodeWithText("联系人").assertIsDisplayed()
        composeTestRule.onNodeWithText("AI军师").assertIsDisplayed()
        composeTestRule.onNodeWithText("设置").assertIsDisplayed()
    }
    
    @Test
    fun `navigation to settings works`() {
        var navigatedRoute = ""
        
        composeTestRule.setContent {
            ContactListScreen(
                currentRoute = NavRoutes.CONTACT_LIST,
                onNavigateToContactDetail = {},
                onNavigate = { navigatedRoute = it },
                onAddClick = {}
            )
        }
        
        composeTestRule.onNodeWithText("设置").performClick()
        assertEquals(NavRoutes.SETTINGS, navigatedRoute)
    }
}
```

#### SettingsScreen测试

**测试文件**: `presentation/src/androidTest/kotlin/com/empathy/ai/presentation/ui/screen/settings/SettingsScreenTest.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.settings

import androidx.activity.ComponentActivity
import androidx.compose.ui.test.assertIsDisplayed
import androidx.compose.ui.test.junit4.createAndroidComposeRule
import androidx.compose.ui.test.onNodeWithText
import androidx.compose.ui.test.performClick
import com.empathy.ai.presentation.navigation.NavRoutes
import dagger.hilt.android.testing.HiltAndroidRule
import dagger.hilt.android.testing.HiltAndroidTest
import org.junit.Rule
import org.junit.Test

@HiltAndroidTest
class SettingsScreenTest {
    
    @get:Rule(order = 0)
    val hiltRule = HiltAndroidRule(this)
    
    @get:Rule(order = 1)
    val composeTestRule = createAndroidComposeRule<ComponentActivity>()
    
    @Test
    fun `settings screen displays iOS style title`() {
        composeTestRule.setContent {
            SettingsScreen(
                currentRoute = NavRoutes.SETTINGS,
                onNavigateToAiConfig = {},
                onNavigateToPromptEditor = {},
                onNavigate = {}
            )
        }
        
        // 验证大标题显示
        composeTestRule.onNodeWithText("设置").assertIsDisplayed()
    }
    
    @Test
    fun `settings sections are displayed`() {
        composeTestRule.setContent {
            SettingsScreen(
                currentRoute = NavRoutes.SETTINGS,
                onNavigateToAiConfig = {},
                onNavigateToPromptEditor = {},
                onNavigate = {}
            )
        }
        
        // 验证分组标题显示
        composeTestRule.onNodeWithText("AI 配置").assertIsDisplayed()
        composeTestRule.onNodeWithText("悬浮窗").assertIsDisplayed()
        composeTestRule.onNodeWithText("隐私保护").assertIsDisplayed()
    }
    
    @Test
    fun `AI config section items are displayed`() {
        composeTestRule.setContent {
            SettingsScreen(
                currentRoute = NavRoutes.SETTINGS,
                onNavigateToAiConfig = {},
                onNavigateToPromptEditor = {},
                onNavigate = {}
            )
        }
        
        // 验证AI配置项显示
        composeTestRule.onNodeWithText("AI 服务商").assertIsDisplayed()
        composeTestRule.onNodeWithText("提示词设置").assertIsDisplayed()
    }
    
    @Test
    fun `privacy section items are displayed`() {
        composeTestRule.setContent {
            SettingsScreen(
                currentRoute = NavRoutes.SETTINGS,
                onNavigateToAiConfig = {},
                onNavigateToPromptEditor = {},
                onNavigate = {}
            )
        }
        
        // 验证隐私保护项显示
        composeTestRule.onNodeWithText("数据掩码").assertIsDisplayed()
        composeTestRule.onNodeWithText("本地优先模式").assertIsDisplayed()
    }
    
    @Test
    fun `navigation to AI config works`() {
        var navigatedToAiConfig = false
        
        composeTestRule.setContent {
            SettingsScreen(
                currentRoute = NavRoutes.SETTINGS,
                onNavigateToAiConfig = { navigatedToAiConfig = true },
                onNavigateToPromptEditor = {},
                onNavigate = {}
            )
        }
        
        composeTestRule.onNodeWithText("AI 服务商").performClick()
        assert(navigatedToAiConfig) { "点击AI服务商应触发导航" }
    }
    
    @Test
    fun `navigation to prompt editor works`() {
        var navigatedToPromptEditor = false
        
        composeTestRule.setContent {
            SettingsScreen(
                currentRoute = NavRoutes.SETTINGS,
                onNavigateToAiConfig = {},
                onNavigateToPromptEditor = { navigatedToPromptEditor = true },
                onNavigate = {}
            )
        }
        
        composeTestRule.onNodeWithText("提示词设置").performClick()
        assert(navigatedToPromptEditor) { "点击提示词设置应触发导航" }
    }
    
    @Test
    fun `bottom navigation is displayed in settings`() {
        composeTestRule.setContent {
            SettingsScreen(
                currentRoute = NavRoutes.SETTINGS,
                onNavigateToAiConfig = {},
                onNavigateToPromptEditor = {},
                onNavigate = {}
            )
        }
        
        // 验证底部导航显示
        composeTestRule.onNodeWithText("联系人").assertIsDisplayed()
        composeTestRule.onNodeWithText("AI军师").assertIsDisplayed()
    }
}
```

### 7.3 视觉回归测试

**测试文件**: `presentation/src/androidTest/kotlin/com/empathy/ai/presentation/ui/VisualRegressionTest.kt`

```kotlin
package com.empathy.ai.presentation.ui

import androidx.activity.ComponentActivity
import androidx.compose.ui.test.junit4.createAndroidComposeRule
import dagger.hilt.android.testing.HiltAndroidRule
import dagger.hilt.android.testing.HiltAndroidTest
import org.junit.Rule
import org.junit.Test

@HiltAndroidTest
class VisualRegressionTest {
    
    @get:Rule(order = 0)
    val hiltRule = HiltAndroidRule(this)
    
    @get:Rule(order = 1)
    val composeTestRule = createAndroidComposeRule<ComponentActivity>()
    
    @Test
    fun `contact list matches HTML prototype`() {
        // 对照 HTML/empathy-contact-list-v4.html 验证
        // 验证点:
        // - 背景色 #F7F7F7 (WeChatBackground)
        // - 头像淡色系 (AvatarColors)
        // - 分隔线样式 (0.5dp, 左边距76dp)
        // - 头像尺寸 48dp × 48dp
        // - 头像圆角 4dp
    }
    
    @Test
    fun `settings screen matches HTML prototype`() {
        // 对照 HTML/empathy-settings-v3.html 验证
        // 验证点:
        // - 背景色 #F2F2F7 (iOSBackground)
        // - iOS大标题 34sp, Bold
        // - 分组卡片样式 (12dp圆角, 白色背景)
        // - iOS开关样式 (51dp × 31dp)
        // - 设置项高度 44dp
    }
    
    @Test
    fun `prompt editor matches HTML prototype`() {
        // 对照 HTML/empathy-prompt-editor-v2.html 验证
        // 验证点:
        // - iOS导航栏 (取消/标题/完成)
        // - 场景Tab (圆角胶囊样式)
        // - 底部按钮 (恢复默认/保存)
    }
    
    @Test
    fun `bottom navigation matches design spec`() {
        // 验证点:
        // - 总高度 84dp (50dp导航栏 + 34dp安全区)
        // - 背景色 #F7F7F7 (WeChatBackground)
        // - 激活态颜色 #07C160 (WeChatGreen)
        // - 加号按钮 48dp, 红色 (#FA5151)
        // - Home Indicator 134dp × 5dp
    }
}
```

---

## ⚠️ 风险评估与缓解

### 9.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 主题改造影响全局 | 中 | 高 | 采用增量式方案，新增iOS色彩常量，不修改现有ColorScheme |
| 导航状态不同步 | 中 | 中 | 使用currentBackStackEntryAsState()自动同步 |
| iOS组件体验不佳 | 低 | 中 | 添加spring动画和按压反馈，参考iOS HIG |
| 动画性能问题 | 低 | 中 | 使用animateXxxAsState，避免重组开销 |

### 9.2 兼容性风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 深色模式不兼容 | 中 | 低 | 本次不改造深色模式，后续单独处理 |
| 不同屏幕尺寸适配 | 低 | 中 | 使用dp单位，测试多种屏幕尺寸 |
| 系统字体缩放 | 低 | 低 | 关键文字使用固定sp，测试字体缩放 |

### 9.3 进度风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 组件开发超时 | 中 | 中 | 优先实现核心组件，次要功能后续迭代 |
| 集成测试发现问题 | 中 | 中 | 每个模块完成后立即集成测试 |

---

## 🔌 接口设计

### 6.1 组件API规范

#### 6.1.1 IOSSwitch API

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `checked` | `Boolean` | ✅ | - | 开关状态 |
| `onCheckedChange` | `(Boolean) -> Unit` | ✅ | - | 状态变化回调 |
| `modifier` | `Modifier` | ❌ | `Modifier` | 修饰符 |
| `enabled` | `Boolean` | ❌ | `true` | 是否启用 |

#### 6.1.2 IOSSettingsItem API

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `icon` | `ImageVector` | ✅ | - | 图标 |
| `iconBackgroundColor` | `Color` | ✅ | - | 图标背景色 |
| `title` | `String` | ✅ | - | 标题 |
| `onClick` | `() -> Unit` | ✅ | - | 点击回调 |
| `modifier` | `Modifier` | ❌ | `Modifier` | 修饰符 |
| `subtitle` | `String?` | ❌ | `null` | 副标题 |
| `value` | `String?` | ❌ | `null` | 右侧值文字 |
| `showArrow` | `Boolean` | ❌ | `true` | 是否显示箭头 |
| `showDivider` | `Boolean` | ❌ | `true` | 是否显示分隔线 |
| `trailing` | `@Composable (() -> Unit)?` | ❌ | `null` | 自定义右侧内容 |


#### 6.1.3 IOSSettingsSection API

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `title` | `String?` | ❌ | `null` | 分组标题（大写显示） |
| `modifier` | `Modifier` | ❌ | `Modifier` | 修饰符 |
| `content` | `@Composable ColumnScope.() -> Unit` | ✅ | - | 分组内容 |

#### 6.1.4 EmpathyBottomNavigation API

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `currentRoute` | `String` | ✅ | - | 当前路由 |
| `onNavigate` | `(String) -> Unit` | ✅ | - | 导航回调 |
| `onAddClick` | `() -> Unit` | ✅ | - | 添加按钮点击回调 |
| `modifier` | `Modifier` | ❌ | `Modifier` | 修饰符 |

#### 6.1.5 PromptSceneTab API

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `scenes` | `List<PromptScene>` | ✅ | - | 场景列表 |
| `selectedScene` | `PromptScene` | ✅ | - | 当前选中场景 |
| `onSceneSelected` | `(PromptScene) -> Unit` | ✅ | - | 场景选择回调 |
| `modifier` | `Modifier` | ❌ | `Modifier` | 修饰符 |

#### 6.1.6 AvatarColors API

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `getColorPair` | `name: String` | `Pair<Color, Color>` | 根据名字获取颜色对（背景色, 文字色） |

---

## ⚡ 性能优化方案

### 7.1 动画性能优化

#### 7.1.1 使用spring动画替代tween


```kotlin
// ✅ 推荐：使用spring动画，更自然的物理反馈
val thumbOffset by animateDpAsState(
    targetValue = if (checked) 22.dp else 2.dp,
    animationSpec = spring(
        dampingRatio = Spring.DampingRatioMediumBouncy,
        stiffness = Spring.StiffnessLow
    ),
    label = "thumbOffset"
)

// ❌ 避免：简单的线性动画
val thumbOffset by animateDpAsState(
    targetValue = if (checked) 22.dp else 2.dp,
    animationSpec = tween(200),
    label = "thumbOffset"
)
```

#### 7.1.2 动画性能指标

| 动画类型 | 目标帧率 | 最大延迟 |
|----------|----------|----------|
| 开关切换 | 60fps | 16ms |
| Tab切换 | 60fps | 16ms |
| 页面转场 | 60fps | 16ms |
| 滚动 | 60fps | 16ms |

### 7.2 重组优化

#### 7.2.1 使用remember缓存计算结果

```kotlin
// ✅ 推荐：缓存颜色计算结果
@Composable
fun ContactListItem(contact: ContactProfile, ...) {
    val colorPair = remember(contact.name) {
        AvatarColors.getColorPair(contact.name)
    }
    val (bgColor, textColor) = colorPair
    // ...
}

// ❌ 避免：每次重组都计算
@Composable
fun ContactListItem(contact: ContactProfile, ...) {
    val (bgColor, textColor) = AvatarColors.getColorPair(contact.name)
    // ...
}
```


#### 7.2.2 使用derivedStateOf减少重组

```kotlin
// ✅ 推荐：使用derivedStateOf
val isSelected by remember(currentRoute) {
    derivedStateOf { currentRoute == NavRoutes.CONTACT_LIST }
}

// ❌ 避免：直接在Composable中计算
val isSelected = currentRoute == NavRoutes.CONTACT_LIST
```

### 7.3 内存优化

#### 7.3.1 LazyColumn优化

```kotlin
LazyColumn(
    modifier = Modifier.fillMaxSize(),
    contentPadding = PaddingValues(vertical = 8.dp)
) {
    items(
        items = contacts,
        key = { it.id }  // ✅ 使用稳定的key
    ) { contact ->
        ContactListItem(contact = contact, onClick = { ... })
    }
}
```

#### 7.3.2 图片加载优化

```kotlin
// 使用Coil的内存缓存
AsyncImage(
    model = ImageRequest.Builder(LocalContext.current)
        .data(imageUrl)
        .memoryCachePolicy(CachePolicy.ENABLED)
        .diskCachePolicy(CachePolicy.ENABLED)
        .build(),
    contentDescription = null
)
```

### 7.4 性能监控

| 监控指标 | 阈值 | 监控方法 |
|----------|------|----------|
| 帧率 | ≥60fps | Android Profiler |
| 重组次数 | 最小化 | Layout Inspector |
| 内存占用 | 无泄漏 | Memory Profiler |
| 启动时间 | ≤500ms | App Startup |



---

## 📅 实施计划

### 10.1 阶段划分

| 阶段 | 名称 | 时间 | 任务数 | 依赖 |
|------|------|------|--------|------|
| Phase 0 | 架构准备 | 0.5天 | 3 | 无 |
| Phase 1 | 主题系统 | 0.5天 | 3 | Phase 0 |
| Phase 2 | iOS组件库 | 1天 | 4 | Phase 1 |
| Phase 3 | 联系人列表 | 1天 | 4 | Phase 1, Phase 2 |
| Phase 4 | 设置页面 | 1天 | 4 | Phase 2 |
| Phase 5 | 提示词编辑器 | 1天 | 3 | Phase 2 |
| Phase 6 | 测试验证 | 0.5天 | 3 | Phase 3-5 |

**总计**: 5.5天，24个任务


### 10.2 详细任务分解

#### Phase 0: 架构准备（0.5天）

| 任务ID | 任务名称 | 预估时间 | 说明 |
|--------|----------|----------|------|
| T0-01 | 创建MainScreen容器 | 2h | 底部导航容器，管理导航状态 |
| T0-02 | 修改NavRoutes.kt | 0.5h | 添加新路由常量 |
| T0-03 | 修改NavGraph.kt | 1.5h | 注册新页面路由 |

#### Phase 1: 主题系统（0.5天）

| 任务ID | 任务名称 | 预估时间 | 说明 |
|--------|----------|----------|------|
| T1-01 | 添加iOS系统色常量 | 1h | 在Color.kt中添加 |
| T1-02 | 创建AvatarColors.kt | 1.5h | 头像淡色系配色 |
| T1-03 | 添加iOSCardBackground常量 | 0.5h | 卡片背景色 |

#### Phase 2: iOS组件库（1天）

| 任务ID | 任务名称 | 预估时间 | 说明 |
|--------|----------|----------|------|
| T2-01 | 创建IOSSwitch.kt | 2h | iOS风格开关组件 |
| T2-02 | 创建IOSSettingsItem.kt | 2h | iOS风格设置项组件 |
| T2-03 | 创建IOSSettingsSection.kt | 1.5h | iOS风格设置分组组件 |
| T2-04 | 创建EmpathyBottomNavigation.kt | 2.5h | 底部导航栏组件 |

#### Phase 3: 联系人列表（1天）

| 任务ID | 任务名称 | 预估时间 | 说明 |
|--------|----------|----------|------|
| T3-01 | 改造ContactListItem.kt | 2h | 淡色头像、关系标签 |
| T3-02 | 改造ContactListScreen.kt | 2h | 微信背景、搜索框 |
| T3-03 | 集成底部导航栏 | 1.5h | 在ContactListScreen中集成 |
| T3-04 | 添加formatRelativeTime工具 | 0.5h | 时间格式化工具函数 |

#### Phase 4: 设置页面（1天）

| 任务ID | 任务名称 | 预估时间 | 说明 |
|--------|----------|----------|------|
| T4-01 | 改造SettingsScreen.kt | 3h | iOS大标题、分组布局 |
| T4-02 | 集成IOSSettingsSection | 1.5h | 使用新分组组件 |
| T4-03 | 集成IOSSwitch | 1h | 替换Material开关 |
| T4-04 | 集成底部导航栏 | 0.5h | 在SettingsScreen中集成 |

#### Phase 5: 提示词编辑器（1天）

| 任务ID | 任务名称 | 预估时间 | 说明 |
|--------|----------|----------|------|
| T5-01 | 创建PromptSceneTab.kt | 2h | 场景切换Tab组件 |
| T5-02 | 改造PromptEditorScreen.kt | 3h | iOS导航栏、底部按钮 |
| T5-03 | 删除变量区域 | 1h | 移除可用变量展示 |

#### Phase 6: 测试验证（0.5天）

| 任务ID | 任务名称 | 预估时间 | 说明 |
|--------|----------|----------|------|
| T6-01 | 编写单元测试 | 2h | AvatarColors、IOSSwitch测试 |
| T6-02 | 编写UI测试 | 1.5h | 页面集成测试 |
| T6-03 | 视觉回归验证 | 0.5h | 对比HTML原型 |


### 10.3 里程碑

| 里程碑 | 日期 | 交付物 |
|--------|------|--------|
| M1 | Day 1 | 主题系统 + iOS组件库完成 |
| M2 | Day 3 | 联系人列表 + 设置页面完成 |
| M3 | Day 4 | 提示词编辑器完成 |
| M4 | Day 5 | 测试验证完成，可发布 |

### 10.4 任务依赖图

```
┌─────────────────────────────────────────────────────────┐
│                    Phase 0: 架构准备                    │
│         MainScreen, NavRoutes, NavGraph                 │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│                    Phase 1: 主题系统                    │
│         Color.kt, AvatarColors.kt                       │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│                   Phase 2: iOS组件库                    │
│   IOSSwitch, IOSSettingsItem, EmpathyBottomNavigation   │
└───────┬─────────────┼─────────────┬─────────────────────┘
        │             │             │
        ▼             ▼             ▼
┌───────────────┐ ┌───────────┐ ┌───────────────────────┐
│ Phase 3:      │ │ Phase 4:  │ │ Phase 5:              │
│ 联系人列表    │ │ 设置页面  │ │ 提示词编辑器         │
└───────┬───────┘ └─────┬─────┘ └───────────┬───────────┘
        │               │                   │
        └───────────────┼───────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│                   Phase 6: 测试验证                     │
└─────────────────────────────────────────────────────────┘
```

---

## ✅ 验收标准

### 11.1 功能验收标准

| 验收项 | 验收标准 | 验证方法 |
|--------|----------|----------|
| 联系人列表 | 显示淡色头像、关系标签、目标描述 | 视觉检查 |
| 底部导航 | 4Tab布局，中间红色加号上浮 | 视觉检查 |
| 导航切换 | Tab点击正确切换页面 | 功能测试 |
| 设置页面 | iOS大标题、分组设置项 | 视觉检查 |
| iOS开关 | 点击切换状态，动画流畅 | 功能测试 |
| 提示词编辑器 | 场景Tab切换、保存功能正常 | 功能测试 |

### 11.2 视觉验收标准

| 验收项 | 参考原型 | 验证点 |
|--------|----------|--------|
| 联系人列表 | `HTML/empathy-contact-list-v4.html` | 背景色、头像颜色、布局间距 |
| 设置页面 | `HTML/empathy-settings-v3.html` | 大标题、分组样式、开关样式 |
| 提示词编辑器 | `HTML/empathy-prompt-editor-v2.html` | 导航栏、场景Tab、底部按钮 |
| 底部导航栏 | 共用组件 | Tab布局、加号按钮位置、颜色 |

### 11.3 性能验收标准

| 验收项 | 标准 | 验证方法 |
|--------|------|----------|
| 帧率 | ≥60fps | Android Profiler |
| 启动时间 | ≤500ms | App Startup |
| 内存占用 | 无泄漏 | Memory Profiler |
| 动画流畅度 | 无卡顿 | 人工测试 |

---

## 📝 附录

### A. 关键文件清单

| 文件类型 | 文件路径 | 操作 |
|----------|----------|------|
| 色彩常量 | `presentation/.../theme/Color.kt` | 修改 |
| 头像淡色系 | `presentation/.../theme/AvatarColors.kt` | 新增 |
| iOS开关 | `presentation/.../component/ios/IOSSwitch.kt` | 新增 |
| iOS设置项 | `presentation/.../component/ios/IOSSettingsItem.kt` | 新增 |
| iOS设置分组 | `presentation/.../component/ios/IOSSettingsSection.kt` | 新增 |
| 底部导航 | `presentation/.../component/navigation/EmpathyBottomNavigation.kt` | 新增 |
| 路由常量 | `presentation/.../navigation/NavRoutes.kt` | 修改 |
| 导航图 | `presentation/.../navigation/NavGraph.kt` | 修改 |
| 联系人列表 | `presentation/.../screen/contact/ContactListScreen.kt` | 修改 |
| 设置页面 | `presentation/.../screen/settings/SettingsScreen.kt` | 修改 |

### B. PromptScene扩展属性

**文件路径**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/prompt/PromptSceneExtensions.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.prompt

import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Chat
import androidx.compose.material.icons.filled.Description
import androidx.compose.material.icons.filled.EditNote
import androidx.compose.material.icons.filled.Search
import androidx.compose.material.icons.filled.Summarize
import androidx.compose.ui.graphics.vector.ImageVector
import com.empathy.ai.domain.model.PromptScene

/** PromptScene图标扩展属性 */
val PromptScene.icon: ImageVector
    get() = when (this) {
        PromptScene.ANALYZE -> Icons.Default.Search
        PromptScene.POLISH -> Icons.Default.EditNote
        PromptScene.REPLY -> Icons.Default.Chat
        PromptScene.SUMMARY -> Icons.Default.Summarize
        else -> Icons.Default.Description
    }

/** PromptScene显示名称扩展属性 */
val PromptScene.displayName: String
    get() = when (this) {
        PromptScene.ANALYZE -> "分析"
        PromptScene.POLISH -> "润色"
        PromptScene.REPLY -> "回复"
        PromptScene.SUMMARY -> "总结"
        else -> "其他"
    }
```

### C. 参考资料

- [iOS Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/)
- [Jetpack Compose Theming](https://developer.android.com/jetpack/compose/designsystems/material3)
- [Navigation Compose](https://developer.android.com/jetpack/compose/navigation)
- [PRD-00019 UI视觉美观化改造](../PRD/PRD-00019-UI视觉美观化改造.md)
- [FD-00019 UI视觉美观化改造功能设计](../FD/FD-00019-UI视觉美观化改造功能设计.md)
- [RESEARCH-00042 FD00019功能设计深度技术调研报告](../RE/RESEARCH-00042-FD00019功能设计深度技术调研报告.md)
- [RESEARCH-00043 TDD00019技术实现深度调研报告](../RE/RESEARCH-00043-TDD00019技术实现深度调研报告.md)

### D. 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| 1.0 | 2025-12-24 | 初始版本（仅概述） | Kiro |
| 1.1 | 2025-12-24 | 根据DR-00035审查报告补充完整技术设计 | Kiro |
| 1.2 | 2025-12-24 | 根据DR-00036审查报告补充测试策略、风险评估、完整代码示例 | Kiro |
| 1.3 | 2025-12-24 | 根据DR-00037审查报告和RESEARCH-00043调研结果完善测试用例 | Kiro |
| 1.4 | 2025-12-24 | 根据DR-00038审查报告清理重复章节、统一章节编号、修复文档结构 | Kiro |

---

**文档版本**: 1.4
**最后更新**: 2025-12-24
