# TDD-00025: AIé…ç½®åŠŸèƒ½å®Œå–„æŠ€æœ¯è®¾è®¡

> **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯è®¾è®¡æ–‡æ¡£ (TDD)
> **ç‰ˆæœ¬**: 1.1
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-01
> **æ›´æ–°æ—¥æœŸ**: 2026-01-01
> **è´Ÿè´£äºº**: Kiro
> **å…³è”PRD**: PRD-00025
> **å…³è”FD**: FD-00025
> **å…³è”å®¡æŸ¥**: DR-00025-TDD00025AIé…ç½®åŠŸèƒ½å®Œå–„æŠ€æœ¯è®¾è®¡å®¡æŸ¥æŠ¥å‘Š
> **çŠ¶æ€**: âœ… å®¡æŸ¥é€šè¿‡

---

## 0. æ–‡æ¡£èƒŒæ™¯

### 0.1 èƒŒæ™¯è¯´æ˜

æœ¬æ–‡æ¡£æ˜¯AIé…ç½®åŠŸèƒ½å®Œå–„çš„æŠ€æœ¯è®¾è®¡æ–‡æ¡£ï¼ŒåŸºäºFD-00025åŠŸèƒ½è®¾è®¡æ–‡æ¡£ç¼–å†™ã€‚æ–‡æ¡£è¯¦ç»†æè¿°äº†å„åŠŸèƒ½æ¨¡å—çš„æŠ€æœ¯å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ•°æ®å±‚ã€é¢†åŸŸå±‚ã€ç½‘ç»œå±‚å’Œè¡¨ç°å±‚çš„å…·ä½“å®ç°ç»†èŠ‚ã€‚

### 0.2 æ–‡æ¡£ç›®çš„

- ä¸ºå¼€å‘å›¢é˜Ÿæä¾›è¯¦ç»†çš„æŠ€æœ¯å®ç°æŒ‡å¯¼
- æ˜ç¡®å„æ¨¡å—çš„ä»£ç ç»“æ„å’Œå®ç°æ–¹å¼
- å®šä¹‰APIæ¥å£è§„èŒƒå’Œæ•°æ®æ ¼å¼
- æä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

### 0.3 è¯»è€…å¯¹è±¡

- åç«¯å¼€å‘å·¥ç¨‹å¸ˆ
- å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ
- æµ‹è¯•å·¥ç¨‹å¸ˆ
- ä»£ç å®¡æŸ¥äººå‘˜

---

## 1. æŠ€æœ¯æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

åŸºäºFD-00025åŠŸèƒ½è®¾è®¡ï¼Œå®ç°AIé…ç½®åŠŸèƒ½çš„å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š
- é«˜çº§é€‰é¡¹è®¾ç½®ï¼ˆTemperatureã€æœ€å¤§Tokenæ•°ï¼‰çš„æ•°æ®å±‚å’ŒUIå±‚å®ç°
- æ¨¡å‹åˆ—è¡¨æ‹–æ‹½æ’åºçš„æŠ€æœ¯å®ç°
- ç½‘ç»œä»£ç†è®¾ç½®çš„å®Œæ•´æŠ€æœ¯æ ˆ
- ç”¨é‡ç»Ÿè®¡åŠŸèƒ½çš„æ•°æ®å­˜å‚¨å’Œå±•ç¤º

### 1.2 æŠ€æœ¯åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| Clean Architecture | ä¸¥æ ¼éµå¾ªå¤šæ¨¡å—æ¶æ„ï¼Œdomainå±‚æ— Androidä¾èµ– |
| å•ä¸€èŒè´£ | æ¯ä¸ªç±»/ç»„ä»¶åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½ |
| ä¾èµ–å€’ç½® | é€šè¿‡æ¥å£è§£è€¦ï¼Œä¾¿äºæµ‹è¯•å’Œæ›¿æ¢ |
| æ€§èƒ½ä¼˜å…ˆ | ä½¿ç”¨Composeæœ€ä½³å®è·µï¼Œé¿å…ä¸å¿…è¦çš„é‡ç»„ |
| æ•°æ®å®‰å…¨ | æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨ï¼Œä»£ç†å¯†ç ä½¿ç”¨EncryptedSharedPreferences |
| å›½é™…åŒ–æ”¯æŒ | UIæ–‡æœ¬æ”¯æŒå¤šè¯­è¨€ï¼Œé”™è¯¯æ¶ˆæ¯å¯æœ¬åœ°åŒ– |

### 1.3 æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Kotlin | 2.0.21 | ä¸»è¦å¼€å‘è¯­è¨€ |
| Room | 2.6.1 | æœ¬åœ°æ•°æ®åº“ |
| Hilt | 2.52 | ä¾èµ–æ³¨å…¥ |
| Compose | BOM 2024.12.01 | UIæ¡†æ¶ |
| Coroutines | 1.9.0 | å¼‚æ­¥å¤„ç† |
| OkHttp | 4.12.0 | ç½‘ç»œè¯·æ±‚ |

### 1.4 æ€§èƒ½åŸºå‡†

| æ“ä½œ | æ€§èƒ½è¦æ±‚ | è¯´æ˜ |
|------|----------|------|
| æ‹–æ‹½æ’åºå¸§ç‡ | â‰¥ 30fps | åœ¨ä½ç«¯è®¾å¤‡ä¸Šä¹Ÿéœ€ä¿æŒæµç•… |
| ç”¨é‡ç»Ÿè®¡æŸ¥è¯¢ | < 200ms | ç»Ÿè®¡é¡µé¢åŠ è½½æ—¶é—´ |
| ä»£ç†æµ‹è¯•å“åº” | < 10s | è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶è§†ä¸ºå¤±è´¥ |
| é¡µé¢åŠ è½½ | < 500ms | å„é…ç½®é¡µé¢é¦–æ¬¡åŠ è½½æ—¶é—´ |
| æ•°æ®åº“è¿ç§» | < 5s | v11â†’v12è¿ç§»æ—¶é—´ |


---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ¨¡å—æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           :app æ¨¡å—                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  di/                                                                     â”‚
â”‚  â”œâ”€â”€ ApiUsageModule.kt (æ–°å»º)      # ç”¨é‡ç»Ÿè®¡DIæ¨¡å—                      â”‚
â”‚  â””â”€â”€ ProxyModule.kt (æ–°å»º)         # ä»£ç†é…ç½®DIæ¨¡å—                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚               â”‚
                    â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      :data æ¨¡å—       â”‚  â”‚   :domain æ¨¡å—    â”‚  â”‚    :presentation æ¨¡å—     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ local/               â”‚  â”‚ model/           â”‚  â”‚ ui/screen/aiconfig/      â”‚
â”‚ â”œâ”€â”€ entity/          â”‚  â”‚ â”œâ”€â”€ ApiUsage     â”‚  â”‚ â”œâ”€â”€ AiConfigScreen.kt    â”‚
â”‚ â”‚   â””â”€â”€ ApiUsage     â”‚  â”‚ â”‚   Record.kt    â”‚  â”‚ â”œâ”€â”€ AddProviderScreen.kt â”‚
â”‚ â”‚       Entity.kt    â”‚  â”‚ â”œâ”€â”€ ApiUsage     â”‚  â”‚ â”œâ”€â”€ UsageStatsScreen.kt  â”‚
â”‚ â”œâ”€â”€ dao/             â”‚  â”‚ â”‚   Stats.kt     â”‚  â”‚ â””â”€â”€ ProxySettingsDialog  â”‚
â”‚ â”‚   â””â”€â”€ ApiUsageDao  â”‚  â”‚ â””â”€â”€ ProxyConfig  â”‚  â”‚                          â”‚
â”‚ â”œâ”€â”€ ProxyPreferences â”‚  â”‚     .kt          â”‚  â”‚ ui/component/ios/        â”‚
â”‚ â””â”€â”€ converter/       â”‚  â”‚                  â”‚  â”‚ â”œâ”€â”€ TemperatureSlider.kt â”‚
â”‚                      â”‚  â”‚ repository/      â”‚  â”‚ â”œâ”€â”€ TokenLimitInput.kt   â”‚
â”‚ repository/          â”‚  â”‚ â”œâ”€â”€ ApiUsage     â”‚  â”‚ â”œâ”€â”€ DraggableModelList   â”‚
â”‚ â””â”€â”€ ApiUsage         â”‚  â”‚ â”‚   Repository   â”‚  â”‚ â””â”€â”€ UsageOverviewCard    â”‚
â”‚     RepositoryImpl   â”‚  â”‚ â””â”€â”€ (æ‰©å±•)       â”‚  â”‚                          â”‚
â”‚                      â”‚  â”‚                  â”‚  â”‚ viewmodel/               â”‚
â”‚ di/                  â”‚  â”‚ usecase/         â”‚  â”‚ â””â”€â”€ UsageStatsViewModel  â”‚
â”‚ â””â”€â”€ DatabaseModule   â”‚  â”‚ â”œâ”€â”€ RecordApi    â”‚  â”‚                          â”‚
â”‚     (æ‰©å±•)           â”‚  â”‚ â”‚   UsageUseCase â”‚  â”‚ navigation/              â”‚
â”‚                      â”‚  â”‚ â”œâ”€â”€ GetApiUsage  â”‚  â”‚ â””â”€â”€ NavGraph.kt (æ‰©å±•)   â”‚
â”‚                      â”‚  â”‚ â”‚   StatsUseCase â”‚  â”‚                          â”‚
â”‚                      â”‚  â”‚ â””â”€â”€ CleanupApi   â”‚  â”‚                          â”‚
â”‚                      â”‚  â”‚     UsageUseCase â”‚  â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ç”¨é‡ç»Ÿè®¡æ•°æ®æµ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  AI APIè°ƒç”¨                                                              â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  AiRepositoryImpl â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚      â”‚                                                              â”‚   â”‚
â”‚      â”‚ è°ƒç”¨AI API                                                   â”‚   â”‚
â”‚      â–¼                                                              â”‚   â”‚
â”‚  OpenAiApi.chat()                                                   â”‚   â”‚
â”‚      â”‚                                                              â”‚   â”‚
â”‚      â”‚ è¿”å›å“åº”ï¼ˆåŒ…å«usageä¿¡æ¯ï¼‰                                     â”‚   â”‚
â”‚      â–¼                                                              â”‚   â”‚
â”‚  RecordApiUsageUseCase â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”‚ è®°å½•ç”¨é‡                                                         â”‚
â”‚      â–¼                                                                  â”‚
â”‚  ApiUsageRepository                                                     â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  ApiUsageDao â”€â”€â–º Room Database (api_usage_recordsè¡¨)                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ä»£ç†é…ç½®æ•°æ®æµ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ç”¨æˆ·é…ç½®ä»£ç†                                                            â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  ProxySettingsDialog                                                    â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”‚ UpdateProxyConfigäº‹ä»¶                                            â”‚
â”‚      â–¼                                                                  â”‚
â”‚  AiConfigViewModel                                                      â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”‚ ä¿å­˜é…ç½®                                                         â”‚
â”‚      â–¼                                                                  â”‚
â”‚  AiProviderRepository.saveProxyConfig()                                 â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  ProxyPreferences â”€â”€â–º EncryptedSharedPreferences                        â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”‚ é…ç½®å˜æ›´é€šçŸ¥                                                     â”‚
â”‚      â–¼                                                                  â”‚
â”‚  NetworkModule.provideOkHttpClient()                                    â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”‚ é‡å»ºOkHttpClientï¼ˆåº”ç”¨ä»£ç†é…ç½®ï¼‰                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  OkHttpClient with Proxy                                                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 3. æ•°æ®å±‚æŠ€æœ¯å®ç°

### 3.1 æ•°æ®åº“è¿ç§»è®¾è®¡

#### 3.1.1 è¿ç§»ç‰ˆæœ¬è§„åˆ’

| ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | è¿ç§»ç­–ç•¥ |
|------|----------|----------|
| v11 â†’ v12 | 1. ai_providersè¡¨æ·»åŠ temperatureã€max_tokenså­—æ®µ<br>2. æ–°å»ºapi_usage_recordsè¡¨ | å¢é‡è¿ç§»ï¼Œä¿ç•™ç°æœ‰æ•°æ® |

#### 3.1.2 è¿ç§»è„šæœ¬å®ç°

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/local/migration/Migration_11_12.kt`

```kotlin
package com.empathy.ai.data.local.migration

import androidx.room.migration.Migration
import androidx.sqlite.db.SupportSQLiteDatabase

/**
 * æ•°æ®åº“è¿ç§» v11 â†’ v12
 * 
 * å˜æ›´å†…å®¹ï¼š
 * 1. ai_providersè¡¨æ·»åŠ temperatureå’Œmax_tokenså­—æ®µ
 * 2. æ–°å»ºapi_usage_recordsè¡¨ç”¨äºç”¨é‡ç»Ÿè®¡
 * 
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
val MIGRATION_11_12 = object : Migration(11, 12) {
    override fun migrate(database: SupportSQLiteDatabase) {
        // 1. ä¸º ai_providers è¡¨æ·»åŠ æ–°å­—æ®µ
        database.execSQL(
            """
            ALTER TABLE ai_providers 
            ADD COLUMN temperature REAL NOT NULL DEFAULT 0.7
            """.trimIndent()
        )
        database.execSQL(
            """
            ALTER TABLE ai_providers 
            ADD COLUMN max_tokens INTEGER NOT NULL DEFAULT 4096
            """.trimIndent()
        )
        
        // 2. åˆ›å»º api_usage_records è¡¨
        database.execSQL(
            """
            CREATE TABLE IF NOT EXISTS api_usage_records (
                id TEXT PRIMARY KEY NOT NULL,
                provider_id TEXT NOT NULL,
                provider_name TEXT NOT NULL,
                model_id TEXT NOT NULL,
                model_name TEXT NOT NULL,
                prompt_tokens INTEGER NOT NULL,
                completion_tokens INTEGER NOT NULL,
                total_tokens INTEGER NOT NULL,
                request_time_ms INTEGER NOT NULL,
                is_success INTEGER NOT NULL,
                error_message TEXT,
                created_at INTEGER NOT NULL
            )
            """.trimIndent()
        )
        
        // 3. åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
        database.execSQL(
            """
            CREATE INDEX IF NOT EXISTS index_api_usage_records_provider_id 
            ON api_usage_records(provider_id)
            """.trimIndent()
        )
        database.execSQL(
            """
            CREATE INDEX IF NOT EXISTS index_api_usage_records_model_id 
            ON api_usage_records(model_id)
            """.trimIndent()
        )
        database.execSQL(
            """
            CREATE INDEX IF NOT EXISTS index_api_usage_records_created_at 
            ON api_usage_records(created_at)
            """.trimIndent()
        )
    }
}
```

#### 3.1.3 AppDatabaseæ›´æ–°

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/local/AppDatabase.kt`

```kotlin
@Database(
    entities = [
        // ç°æœ‰å®ä½“...
        ContactProfileEntity::class,
        BrainTagEntity::class,
        AiProviderEntity::class,
        ConversationLogEntity::class,
        DailySummaryEntity::class,
        FailedSummaryTaskEntity::class,
        ConversationTopicEntity::class,
        // ğŸ†• æ–°å¢å®ä½“
        ApiUsageEntity::class
    ],
    version = 12,  // ğŸ†• ç‰ˆæœ¬å‡çº§
    exportSchema = true
)
@TypeConverters(RoomTypeConverters::class, FactListConverter::class)
abstract class AppDatabase : RoomDatabase() {
    // ç°æœ‰DAO...
    abstract fun aiProviderDao(): AiProviderDao
    
    // ğŸ†• æ–°å¢DAO
    abstract fun apiUsageDao(): ApiUsageDao
}
```

### 3.2 Entityå®ç°

#### 3.2.1 AiProviderEntityæ‰©å±•

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/local/entity/AiProviderEntity.kt`

```kotlin
@Entity(
    tableName = "ai_providers",
    indices = [Index(value = ["is_default"])]
)
data class AiProviderEntity(
    @PrimaryKey
    @ColumnInfo(name = "id")
    val id: String,

    @ColumnInfo(name = "name")
    val name: String,

    @ColumnInfo(name = "base_url")
    val baseUrl: String,

    @ColumnInfo(name = "api_key_ref")
    val apiKeyRef: String,

    @ColumnInfo(name = "models_json")
    val modelsJson: String,

    @ColumnInfo(name = "default_model_id")
    val defaultModelId: String,

    @ColumnInfo(name = "is_default")
    val isDefault: Boolean = false,

    @ColumnInfo(name = "timeout_ms")
    val timeoutMs: Long = 30000L,

    @ColumnInfo(name = "created_at")
    val createdAt: Long,
    
    // ğŸ†• æ–°å¢å­—æ®µ
    @ColumnInfo(name = "temperature")
    val temperature: Float = 0.7f,
    
    @ColumnInfo(name = "max_tokens")
    val maxTokens: Int = 4096
)
```

#### 3.2.2 ApiUsageEntityå®ç°

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/local/entity/ApiUsageEntity.kt`

```kotlin
package com.empathy.ai.data.local.entity

import androidx.room.ColumnInfo
import androidx.room.Entity
import androidx.room.Index
import androidx.room.PrimaryKey

/**
 * API ç”¨é‡è®°å½•å®ä½“ - å¯¹åº”æ•°æ®åº“ api_usage_records è¡¨
 *
 * è¡¨ç»“æ„è§„èŒƒ:
 * - è¡¨å: api_usage_records (å¤æ•°å½¢å¼, snake_case)
 * - ä¸»é”®: id (String ç±»å‹, UUID)
 * - åˆ—å: snake_case é£æ ¼
 *
 * ç´¢å¼•ä¼˜åŒ–:
 * - provider_id: æŒ‰æœåŠ¡å•†æŸ¥è¯¢ç»Ÿè®¡
 * - model_id: æŒ‰æ¨¡å‹æŸ¥è¯¢ç»Ÿè®¡
 * - created_at: æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
 *
 * @property id è®°å½•å”¯ä¸€æ ‡è¯† (UUID)
 * @property providerId æœåŠ¡å•†ID
 * @property providerName æœåŠ¡å•†åç§°ï¼ˆå†—ä½™å­˜å‚¨ï¼Œä¾¿äºç»Ÿè®¡å±•ç¤ºï¼‰
 * @property modelId æ¨¡å‹ID
 * @property modelName æ¨¡å‹åç§°ï¼ˆå†—ä½™å­˜å‚¨ï¼‰
 * @property promptTokens è¾“å…¥Tokenæ•°
 * @property completionTokens è¾“å‡ºTokenæ•°
 * @property totalTokens æ€»Tokenæ•°
 * @property requestTimeMs è¯·æ±‚è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
 * @property isSuccess æ˜¯å¦æˆåŠŸ
 * @property errorMessage é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶ï¼‰
 * @property createdAt åˆ›å»ºæ—¶é—´æˆ³
 *
 * @see com.empathy.ai.domain.model.ApiUsageRecord
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
@Entity(
    tableName = "api_usage_records",
    indices = [
        Index(value = ["provider_id"]),
        Index(value = ["model_id"]),
        Index(value = ["created_at"])
    ]
)
data class ApiUsageEntity(
    @PrimaryKey
    @ColumnInfo(name = "id")
    val id: String,
    
    @ColumnInfo(name = "provider_id")
    val providerId: String,
    
    @ColumnInfo(name = "provider_name")
    val providerName: String,
    
    @ColumnInfo(name = "model_id")
    val modelId: String,
    
    @ColumnInfo(name = "model_name")
    val modelName: String,
    
    @ColumnInfo(name = "prompt_tokens")
    val promptTokens: Int,
    
    @ColumnInfo(name = "completion_tokens")
    val completionTokens: Int,
    
    @ColumnInfo(name = "total_tokens")
    val totalTokens: Int,
    
    @ColumnInfo(name = "request_time_ms")
    val requestTimeMs: Long,
    
    @ColumnInfo(name = "is_success")
    val isSuccess: Boolean,
    
    @ColumnInfo(name = "error_message")
    val errorMessage: String?,
    
    @ColumnInfo(name = "created_at")
    val createdAt: Long
)
```


### 3.3 DAOå®ç°

#### 3.3.1 ApiUsageDao

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/local/dao/ApiUsageDao.kt`

```kotlin
package com.empathy.ai.data.local.dao

import androidx.room.Dao
import androidx.room.Insert
import androidx.room.OnConflictStrategy
import androidx.room.Query
import com.empathy.ai.data.local.entity.ApiUsageEntity
import kotlinx.coroutines.flow.Flow

/**
 * API ç”¨é‡è®°å½• DAO
 *
 * æä¾›ç”¨é‡è®°å½•çš„CRUDæ“ä½œå’Œç»Ÿè®¡æŸ¥è¯¢
 *
 * æŸ¥è¯¢ä¼˜åŒ–:
 * - ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŒ‰provider_idã€model_idã€created_atçš„æŸ¥è¯¢
 * - ç»Ÿè®¡æŸ¥è¯¢ä½¿ç”¨èšåˆå‡½æ•°ï¼Œé¿å…å…¨è¡¨æ‰«æ
 *
 * @see ApiUsageEntity
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
@Dao
interface ApiUsageDao {
    
    /**
     * æ’å…¥ç”¨é‡è®°å½•
     */
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insert(entity: ApiUsageEntity)
    
    /**
     * æ‰¹é‡æ’å…¥ç”¨é‡è®°å½•
     */
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertAll(entities: List<ApiUsageEntity>)
    
    /**
     * è·å–æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„ç”¨é‡è®°å½•
     *
     * @param startTime å¼€å§‹æ—¶é—´æˆ³
     * @param endTime ç»“æŸæ—¶é—´æˆ³
     */
    @Query("""
        SELECT * FROM api_usage_records 
        WHERE created_at >= :startTime AND created_at <= :endTime
        ORDER BY created_at DESC
    """)
    suspend fun getRecordsByTimeRange(startTime: Long, endTime: Long): List<ApiUsageEntity>
    
    /**
     * è·å–æœ€è¿‘çš„ç”¨é‡è®°å½•
     *
     * @param limit è¿”å›æ•°é‡é™åˆ¶
     */
    @Query("""
        SELECT * FROM api_usage_records 
        ORDER BY created_at DESC 
        LIMIT :limit
    """)
    suspend fun getRecentRecords(limit: Int): List<ApiUsageEntity>
    
    /**
     * è·å–æ€»è¯·æ±‚æ•°
     */
    @Query("SELECT COUNT(*) FROM api_usage_records")
    suspend fun getTotalRequestCount(): Int
    
    /**
     * è·å–æˆåŠŸè¯·æ±‚æ•°
     */
    @Query("SELECT COUNT(*) FROM api_usage_records WHERE is_success = 1")
    suspend fun getSuccessRequestCount(): Int
    
    /**
     * è·å–æ€»Tokenæ¶ˆè€—
     */
    @Query("SELECT COALESCE(SUM(total_tokens), 0) FROM api_usage_records")
    suspend fun getTotalTokens(): Long
    
    /**
     * è·å–æ€»è¾“å…¥Token
     */
    @Query("SELECT COALESCE(SUM(prompt_tokens), 0) FROM api_usage_records")
    suspend fun getTotalPromptTokens(): Long
    
    /**
     * è·å–æ€»è¾“å‡ºToken
     */
    @Query("SELECT COALESCE(SUM(completion_tokens), 0) FROM api_usage_records")
    suspend fun getTotalCompletionTokens(): Long
    
    /**
     * è·å–å¹³å‡è¯·æ±‚è€—æ—¶
     */
    @Query("SELECT COALESCE(AVG(request_time_ms), 0) FROM api_usage_records WHERE is_success = 1")
    suspend fun getAvgRequestTimeMs(): Long
    
    /**
     * æŒ‰æœåŠ¡å•†ç»Ÿè®¡è¯·æ±‚æ•°
     */
    @Query("""
        SELECT provider_id, provider_name, 
               COUNT(*) as total_requests,
               SUM(total_tokens) as total_tokens,
               SUM(CASE WHEN is_success = 1 THEN 1 ELSE 0 END) * 1.0 / COUNT(*) as success_rate
        FROM api_usage_records
        GROUP BY provider_id
        ORDER BY total_requests DESC
    """)
    suspend fun getStatsByProvider(): List<ProviderUsageStatsRaw>
    
    /**
     * æŒ‰æ¨¡å‹ç»Ÿè®¡è¯·æ±‚æ•°
     */
    @Query("""
        SELECT model_id, model_name, provider_id,
               COUNT(*) as total_requests,
               SUM(total_tokens) as total_tokens,
               AVG(request_time_ms) as avg_request_time_ms
        FROM api_usage_records
        WHERE is_success = 1
        GROUP BY model_id
        ORDER BY total_requests DESC
    """)
    suspend fun getStatsByModel(): List<ModelUsageStatsRaw>
    
    /**
     * è·å–æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„ç»Ÿè®¡
     */
    @Query("""
        SELECT COUNT(*) as total_requests,
               SUM(CASE WHEN is_success = 1 THEN 1 ELSE 0 END) as success_requests,
               SUM(CASE WHEN is_success = 0 THEN 1 ELSE 0 END) as failed_requests,
               COALESCE(SUM(total_tokens), 0) as total_tokens,
               COALESCE(SUM(prompt_tokens), 0) as total_prompt_tokens,
               COALESCE(SUM(completion_tokens), 0) as total_completion_tokens,
               COALESCE(AVG(CASE WHEN is_success = 1 THEN request_time_ms END), 0) as avg_request_time_ms
        FROM api_usage_records
        WHERE created_at >= :startTime AND created_at <= :endTime
    """)
    suspend fun getStatsInTimeRange(startTime: Long, endTime: Long): UsageStatsRaw
    
    /**
     * åˆ é™¤æŒ‡å®šæ—¶é—´ä¹‹å‰çš„è®°å½•
     *
     * @param beforeTime æ—¶é—´æˆ³
     * @return åˆ é™¤çš„è®°å½•æ•°
     */
    @Query("DELETE FROM api_usage_records WHERE created_at < :beforeTime")
    suspend fun deleteRecordsBefore(beforeTime: Long): Int
    
    /**
     * åˆ é™¤æ‰€æœ‰è®°å½•
     */
    @Query("DELETE FROM api_usage_records")
    suspend fun deleteAll(): Int
    
    /**
     * è·å–è®°å½•æ€»æ•°
     */
    @Query("SELECT COUNT(*) FROM api_usage_records")
    suspend fun getRecordCount(): Int
    
    /**
     * è§‚å¯Ÿè®°å½•æ€»æ•°å˜åŒ–
     */
    @Query("SELECT COUNT(*) FROM api_usage_records")
    fun observeRecordCount(): Flow<Int>
}

/**
 * æŒ‰æœåŠ¡å•†ç»Ÿè®¡çš„åŸå§‹æ•°æ®
 */
data class ProviderUsageStatsRaw(
    val provider_id: String,
    val provider_name: String,
    val total_requests: Int,
    val total_tokens: Long,
    val success_rate: Float
)

/**
 * æŒ‰æ¨¡å‹ç»Ÿè®¡çš„åŸå§‹æ•°æ®
 */
data class ModelUsageStatsRaw(
    val model_id: String,
    val model_name: String,
    val provider_id: String,
    val total_requests: Int,
    val total_tokens: Long,
    val avg_request_time_ms: Long
)

/**
 * ç”¨é‡ç»Ÿè®¡åŸå§‹æ•°æ®
 */
data class UsageStatsRaw(
    val total_requests: Int,
    val success_requests: Int,
    val failed_requests: Int,
    val total_tokens: Long,
    val total_prompt_tokens: Long,
    val total_completion_tokens: Long,
    val avg_request_time_ms: Long
)
```

### 3.4 ProxyPreferenceså®ç°

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/local/ProxyPreferences.kt`

```kotlin
package com.empathy.ai.data.local

import android.content.Context
import androidx.security.crypto.EncryptedSharedPreferences
import androidx.security.crypto.MasterKey
import com.empathy.ai.domain.model.ProxyConfig
import com.empathy.ai.domain.model.ProxyType
import dagger.hilt.android.qualifiers.ApplicationContext
import javax.inject.Inject
import javax.inject.Singleton

/**
 * ä»£ç†é…ç½®å­˜å‚¨
 *
 * ä½¿ç”¨ EncryptedSharedPreferences å®‰å…¨å­˜å‚¨ä»£ç†é…ç½®
 * å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ä½¿ç”¨åŠ å¯†å­˜å‚¨
 *
 * @see ProxyConfig
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
@Singleton
class ProxyPreferences @Inject constructor(
    @ApplicationContext private val context: Context
) {
    private val masterKey = MasterKey.Builder(context)
        .setKeyScheme(MasterKey.KeyScheme.AES256_GCM)
        .build()
    
    private val prefs = EncryptedSharedPreferences.create(
        context,
        PREFS_NAME,
        masterKey,
        EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
        EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
    )
    
    companion object {
        private const val PREFS_NAME = "proxy_settings"
        private const val KEY_ENABLED = "proxy_enabled"
        private const val KEY_TYPE = "proxy_type"
        private const val KEY_HOST = "proxy_host"
        private const val KEY_PORT = "proxy_port"
        private const val KEY_USERNAME = "proxy_username"
        private const val KEY_PASSWORD = "proxy_password"
    }
    
    /**
     * è·å–ä»£ç†é…ç½®
     */
    fun getProxyConfig(): ProxyConfig {
        return ProxyConfig(
            enabled = prefs.getBoolean(KEY_ENABLED, false),
            type = ProxyType.valueOf(
                prefs.getString(KEY_TYPE, ProxyType.HTTP.name) ?: ProxyType.HTTP.name
            ),
            host = prefs.getString(KEY_HOST, "") ?: "",
            port = prefs.getInt(KEY_PORT, 0),
            username = prefs.getString(KEY_USERNAME, null),
            password = prefs.getString(KEY_PASSWORD, null)
        )
    }
    
    /**
     * ä¿å­˜ä»£ç†é…ç½®
     */
    fun saveProxyConfig(config: ProxyConfig) {
        prefs.edit().apply {
            putBoolean(KEY_ENABLED, config.enabled)
            putString(KEY_TYPE, config.type.name)
            putString(KEY_HOST, config.host)
            putInt(KEY_PORT, config.port)
            if (config.username != null) {
                putString(KEY_USERNAME, config.username)
            } else {
                remove(KEY_USERNAME)
            }
            if (config.password != null) {
                putString(KEY_PASSWORD, config.password)
            } else {
                remove(KEY_PASSWORD)
            }
            apply()
        }
    }
    
    /**
     * æ¸…é™¤ä»£ç†é…ç½®
     */
    fun clearProxyConfig() {
        prefs.edit().clear().apply()
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦å¯ç”¨ä»£ç†
     */
    fun isProxyEnabled(): Boolean {
        return prefs.getBoolean(KEY_ENABLED, false)
    }
}
```


### 3.5 Repositoryå®ç°

#### 3.5.1 ApiUsageRepositoryImpl

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/repository/ApiUsageRepositoryImpl.kt`

```kotlin
package com.empathy.ai.data.repository

import com.empathy.ai.data.local.dao.ApiUsageDao
import com.empathy.ai.data.local.entity.ApiUsageEntity
import com.empathy.ai.domain.model.ApiUsageRecord
import com.empathy.ai.domain.model.ApiUsageStats
import com.empathy.ai.domain.model.ModelUsageStats
import com.empathy.ai.domain.model.ProviderUsageStats
import com.empathy.ai.domain.repository.ApiUsageRepository
import com.squareup.moshi.Moshi
import com.squareup.moshi.Types
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import javax.inject.Inject
import javax.inject.Singleton

/**
 * API ç”¨é‡ç»Ÿè®¡ä»“åº“å®ç°
 *
 * è´Ÿè´£ç”¨é‡è®°å½•çš„å­˜å‚¨ã€æŸ¥è¯¢å’Œç»Ÿè®¡
 *
 * @see ApiUsageRepository
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
@Singleton
class ApiUsageRepositoryImpl @Inject constructor(
    private val dao: ApiUsageDao,
    private val moshi: Moshi
) : ApiUsageRepository {
    
    companion object {
        private const val MAX_RECORDS = 10000  // æœ€å¤§è®°å½•æ•°é™åˆ¶
        private const val CLEANUP_THRESHOLD = 9000  // è§¦å‘æ¸…ç†çš„é˜ˆå€¼
    }
    
    override suspend fun recordUsage(record: ApiUsageRecord): Result<Unit> {
        return withContext(Dispatchers.IO) {
            try {
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç†æ—§è®°å½•
                val currentCount = dao.getRecordCount()
                if (currentCount >= MAX_RECORDS) {
                    // åˆ é™¤æœ€æ—©çš„è®°å½•ï¼Œä¿ç•™CLEANUP_THRESHOLDæ¡
                    val recordsToDelete = currentCount - CLEANUP_THRESHOLD
                    // è·å–æœ€æ—©çš„è®°å½•æ—¶é—´æˆ³
                    val oldestRecords = dao.getRecentRecords(currentCount)
                    if (oldestRecords.size > CLEANUP_THRESHOLD) {
                        val cutoffTime = oldestRecords[CLEANUP_THRESHOLD].createdAt
                        dao.deleteRecordsBefore(cutoffTime)
                    }
                }
                
                dao.insert(record.toEntity())
                Result.success(Unit)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    }
    
    override suspend fun getUsageStats(startTime: Long, endTime: Long): Result<ApiUsageStats> {
        return withContext(Dispatchers.IO) {
            try {
                val statsRaw = dao.getStatsInTimeRange(startTime, endTime)
                val byProvider = dao.getStatsByProvider().map { it.toDomain() }
                val byModel = dao.getStatsByModel().map { it.toDomain() }
                
                val stats = ApiUsageStats(
                    totalRequests = statsRaw.total_requests,
                    successRequests = statsRaw.success_requests,
                    failedRequests = statsRaw.failed_requests,
                    totalTokens = statsRaw.total_tokens,
                    totalPromptTokens = statsRaw.total_prompt_tokens,
                    totalCompletionTokens = statsRaw.total_completion_tokens,
                    avgRequestTimeMs = statsRaw.avg_request_time_ms,
                    byProvider = byProvider,
                    byModel = byModel,
                    periodStart = startTime,
                    periodEnd = endTime
                )
                Result.success(stats)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    }
    
    override suspend fun getRecentRecords(limit: Int): Result<List<ApiUsageRecord>> {
        return withContext(Dispatchers.IO) {
            try {
                val entities = dao.getRecentRecords(limit)
                Result.success(entities.map { it.toDomain() })
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    }
    
    override suspend fun clearRecordsBefore(beforeTime: Long): Result<Int> {
        return withContext(Dispatchers.IO) {
            try {
                val deletedCount = dao.deleteRecordsBefore(beforeTime)
                Result.success(deletedCount)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    }
    
    override suspend fun getTotalUsage(): Result<ApiUsageStats> {
        return withContext(Dispatchers.IO) {
            try {
                val totalRequests = dao.getTotalRequestCount()
                val successRequests = dao.getSuccessRequestCount()
                val totalTokens = dao.getTotalTokens()
                val totalPromptTokens = dao.getTotalPromptTokens()
                val totalCompletionTokens = dao.getTotalCompletionTokens()
                val avgRequestTimeMs = dao.getAvgRequestTimeMs()
                val byProvider = dao.getStatsByProvider().map { it.toDomain() }
                val byModel = dao.getStatsByModel().map { it.toDomain() }
                
                val stats = ApiUsageStats(
                    totalRequests = totalRequests,
                    successRequests = successRequests,
                    failedRequests = totalRequests - successRequests,
                    totalTokens = totalTokens,
                    totalPromptTokens = totalPromptTokens,
                    totalCompletionTokens = totalCompletionTokens,
                    avgRequestTimeMs = avgRequestTimeMs,
                    byProvider = byProvider,
                    byModel = byModel,
                    periodStart = 0L,
                    periodEnd = System.currentTimeMillis()
                )
                Result.success(stats)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    }
    
    override suspend fun exportUsageData(startTime: Long, endTime: Long): Result<String> {
        return withContext(Dispatchers.IO) {
            try {
                val records = dao.getRecordsByTimeRange(startTime, endTime)
                val stats = getUsageStats(startTime, endTime).getOrThrow()
                
                val exportData = UsageExportData(
                    exportTime = System.currentTimeMillis(),
                    periodStart = startTime,
                    periodEnd = endTime,
                    overview = stats,
                    records = records.map { it.toDomain() }
                )
                
                val type = Types.newParameterizedType(
                    UsageExportData::class.java
                )
                val adapter = moshi.adapter<UsageExportData>(type)
                val json = adapter.toJson(exportData)
                
                Result.success(json)
            } catch (e: Exception) {
                Result.failure(e)
            }
        }
    }
    
    // Entity <-> Domain è½¬æ¢
    private fun ApiUsageRecord.toEntity(): ApiUsageEntity {
        return ApiUsageEntity(
            id = id,
            providerId = providerId,
            providerName = providerName,
            modelId = modelId,
            modelName = modelName,
            promptTokens = promptTokens,
            completionTokens = completionTokens,
            totalTokens = totalTokens,
            requestTimeMs = requestTimeMs,
            isSuccess = isSuccess,
            errorMessage = errorMessage,
            createdAt = createdAt
        )
    }
    
    private fun ApiUsageEntity.toDomain(): ApiUsageRecord {
        return ApiUsageRecord(
            id = id,
            providerId = providerId,
            providerName = providerName,
            modelId = modelId,
            modelName = modelName,
            promptTokens = promptTokens,
            completionTokens = completionTokens,
            totalTokens = totalTokens,
            requestTimeMs = requestTimeMs,
            isSuccess = isSuccess,
            errorMessage = errorMessage,
            createdAt = createdAt
        )
    }
    
    private fun ProviderUsageStatsRaw.toDomain(): ProviderUsageStats {
        return ProviderUsageStats(
            providerId = provider_id,
            providerName = provider_name,
            totalRequests = total_requests,
            totalTokens = total_tokens,
            successRate = success_rate
        )
    }
    
    private fun ModelUsageStatsRaw.toDomain(): ModelUsageStats {
        return ModelUsageStats(
            modelId = model_id,
            modelName = model_name,
            providerId = provider_id,
            totalRequests = total_requests,
            totalTokens = total_tokens,
            avgRequestTimeMs = avg_request_time_ms
        )
    }
}

/**
 * ç”¨é‡å¯¼å‡ºæ•°æ®ç»“æ„
 */
data class UsageExportData(
    val exportTime: Long,
    val periodStart: Long,
    val periodEnd: Long,
    val overview: ApiUsageStats,
    val records: List<ApiUsageRecord>
)
```


---

## 4. é¢†åŸŸå±‚æŠ€æœ¯å®ç°

### 4.1 Modelå®ç°

#### 4.1.1 AiProvideræ‰©å±•

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/model/AiProvider.kt`

```kotlin
data class AiProvider(
    val id: String,
    val name: String,
    val baseUrl: String,
    val apiKey: String,
    val models: List<AiModel>,
    val defaultModelId: String,
    val isDefault: Boolean = false,
    val timeoutMs: Long = 30000L,
    val createdAt: Long = System.currentTimeMillis(),
    
    // ğŸ†• æ–°å¢å­—æ®µ
    val temperature: Float = 0.7f,        // Temperatureè®¾ç½®ï¼ŒèŒƒå›´0-2
    val maxTokens: Int = 4096             // æœ€å¤§Tokenæ•°
) {
    companion object {
        // è¾¹ç•Œå€¼å¸¸é‡
        const val TEMPERATURE_MIN = 0f
        const val TEMPERATURE_MAX = 2f
        const val TEMPERATURE_DEFAULT = 0.7f
        
        const val MAX_TOKENS_MIN = 1
        const val MAX_TOKENS_MAX = 128000
        const val MAX_TOKENS_DEFAULT = 4096
    }
    
    /**
     * è·å–é»˜è®¤æ¨¡å‹
     */
    fun getDefaultModel(): AiModel? {
        return models.find { it.id == defaultModelId }
    }

    /**
     * éªŒè¯é…ç½®æ˜¯å¦æœ‰æ•ˆ
     */
    fun isValid(): Boolean {
        return name.isNotBlank() &&
                baseUrl.isNotBlank() &&
                apiKey.isNotBlank() &&
                models.isNotEmpty() &&
                models.any { it.id == defaultModelId } &&
                isTemperatureValid() &&
                isMaxTokensValid()
    }
    
    /**
     * ğŸ†• éªŒè¯TemperatureèŒƒå›´
     * 
     * @return trueå¦‚æœtemperatureåœ¨æœ‰æ•ˆèŒƒå›´å†…[0, 2]
     */
    fun isTemperatureValid(): Boolean = temperature in TEMPERATURE_MIN..TEMPERATURE_MAX
    
    /**
     * ğŸ†• éªŒè¯MaxTokensèŒƒå›´
     * 
     * @return trueå¦‚æœmaxTokensåœ¨æœ‰æ•ˆèŒƒå›´å†…[1, 128000]
     */
    fun isMaxTokensValid(): Boolean = maxTokens in MAX_TOKENS_MIN..MAX_TOKENS_MAX
    
    /**
     * ğŸ†• è·å–å®‰å…¨çš„Temperatureå€¼ï¼ˆè¾¹ç•Œä¿æŠ¤ï¼‰
     * 
     * @return åœ¨æœ‰æ•ˆèŒƒå›´å†…çš„temperatureå€¼
     */
    fun getSafeTemperature(): Float = temperature.coerceIn(TEMPERATURE_MIN, TEMPERATURE_MAX)
    
    /**
     * ğŸ†• è·å–å®‰å…¨çš„MaxTokenså€¼ï¼ˆè¾¹ç•Œä¿æŠ¤ï¼‰
     * 
     * @return åœ¨æœ‰æ•ˆèŒƒå›´å†…çš„maxTokenså€¼
     */
    fun getSafeMaxTokens(): Int = maxTokens.coerceIn(MAX_TOKENS_MIN, MAX_TOKENS_MAX)
}
```

#### 4.1.2 ApiUsageRecord

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/model/ApiUsageRecord.kt`

```kotlin
package com.empathy.ai.domain.model

/**
 * API ç”¨é‡è®°å½•
 *
 * è®°å½•æ¯æ¬¡ API è°ƒç”¨çš„ç”¨é‡ä¿¡æ¯
 *
 * @property id è®°å½•IDï¼ˆUUIDï¼‰
 * @property providerId æœåŠ¡å•†ID
 * @property providerName æœåŠ¡å•†åç§°ï¼ˆå†—ä½™å­˜å‚¨ï¼Œä¾¿äºç»Ÿè®¡ï¼‰
 * @property modelId æ¨¡å‹ID
 * @property modelName æ¨¡å‹åç§°ï¼ˆå†—ä½™å­˜å‚¨ï¼‰
 * @property promptTokens è¾“å…¥Tokenæ•°
 * @property completionTokens è¾“å‡ºTokenæ•°
 * @property totalTokens æ€»Tokenæ•°
 * @property requestTimeMs è¯·æ±‚è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
 * @property isSuccess æ˜¯å¦æˆåŠŸ
 * @property errorMessage é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶ï¼‰
 * @property createdAt åˆ›å»ºæ—¶é—´æˆ³
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
data class ApiUsageRecord(
    val id: String,
    val providerId: String,
    val providerName: String,
    val modelId: String,
    val modelName: String,
    val promptTokens: Int,
    val completionTokens: Int,
    val totalTokens: Int,
    val requestTimeMs: Long,
    val isSuccess: Boolean,
    val errorMessage: String? = null,
    val createdAt: Long = System.currentTimeMillis()
)
```

#### 4.1.3 ApiUsageStats

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/model/ApiUsageStats.kt`

```kotlin
package com.empathy.ai.domain.model

/**
 * API ç”¨é‡ç»Ÿè®¡
 *
 * èšåˆç»Ÿè®¡ç»“æœ
 *
 * @property totalRequests æ€»è¯·æ±‚æ•°
 * @property successRequests æˆåŠŸè¯·æ±‚æ•°
 * @property failedRequests å¤±è´¥è¯·æ±‚æ•°
 * @property totalTokens æ€»Tokenæ¶ˆè€—
 * @property totalPromptTokens æ€»è¾“å…¥Token
 * @property totalCompletionTokens æ€»è¾“å‡ºToken
 * @property avgRequestTimeMs å¹³å‡è¯·æ±‚è€—æ—¶
 * @property byProvider æŒ‰æœåŠ¡å•†ç»Ÿè®¡
 * @property byModel æŒ‰æ¨¡å‹ç»Ÿè®¡
 * @property periodStart ç»Ÿè®¡å‘¨æœŸå¼€å§‹
 * @property periodEnd ç»Ÿè®¡å‘¨æœŸç»“æŸ
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
data class ApiUsageStats(
    val totalRequests: Int,
    val successRequests: Int,
    val failedRequests: Int,
    val totalTokens: Long,
    val totalPromptTokens: Long,
    val totalCompletionTokens: Long,
    val avgRequestTimeMs: Long,
    val byProvider: List<ProviderUsageStats>,
    val byModel: List<ModelUsageStats>,
    val periodStart: Long,
    val periodEnd: Long
) {
    /**
     * è®¡ç®—æˆåŠŸç‡
     */
    val successRate: Float
        get() = if (totalRequests > 0) {
            successRequests.toFloat() / totalRequests
        } else {
            0f
        }
    
    /**
     * æ ¼å¼åŒ–æˆåŠŸç‡ä¸ºç™¾åˆ†æ¯”å­—ç¬¦ä¸²
     */
    fun formatSuccessRate(): String {
        return "%.1f%%".format(successRate * 100)
    }
    
    /**
     * æ ¼å¼åŒ–Tokenæ•°ä¸ºå¯è¯»å­—ç¬¦ä¸²
     */
    fun formatTotalTokens(): String {
        return when {
            totalTokens >= 1_000_000 -> "%.1fM".format(totalTokens / 1_000_000.0)
            totalTokens >= 1_000 -> "%.1fK".format(totalTokens / 1_000.0)
            else -> totalTokens.toString()
        }
    }
}

/**
 * æŒ‰æœåŠ¡å•†ç»Ÿè®¡
 *
 * @property providerId æœåŠ¡å•†ID
 * @property providerName æœåŠ¡å•†åç§°
 * @property totalRequests æ€»è¯·æ±‚æ•°
 * @property totalTokens æ€»Tokenæ¶ˆè€—
 * @property successRate æˆåŠŸç‡ 0-1
 */
data class ProviderUsageStats(
    val providerId: String,
    val providerName: String,
    val totalRequests: Int,
    val totalTokens: Long,
    val successRate: Float
)

/**
 * æŒ‰æ¨¡å‹ç»Ÿè®¡
 *
 * @property modelId æ¨¡å‹ID
 * @property modelName æ¨¡å‹åç§°
 * @property providerId æ‰€å±æœåŠ¡å•†ID
 * @property totalRequests æ€»è¯·æ±‚æ•°
 * @property totalTokens æ€»Tokenæ¶ˆè€—
 * @property avgRequestTimeMs å¹³å‡è¯·æ±‚è€—æ—¶
 */
data class ModelUsageStats(
    val modelId: String,
    val modelName: String,
    val providerId: String,
    val totalRequests: Int,
    val totalTokens: Long,
    val avgRequestTimeMs: Long
)
```

#### 4.1.4 ProxyConfig

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/model/ProxyConfig.kt`

```kotlin
package com.empathy.ai.domain.model

/**
 * ç½‘ç»œä»£ç†é…ç½®
 *
 * @property enabled æ˜¯å¦å¯ç”¨ä»£ç†
 * @property type ä»£ç†ç±»å‹
 * @property host ä»£ç†æœåŠ¡å™¨åœ°å€
 * @property port ä»£ç†ç«¯å£
 * @property username ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰
 * @property password å¯†ç ï¼ˆå¯é€‰ï¼‰
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
data class ProxyConfig(
    val enabled: Boolean = false,
    val type: ProxyType = ProxyType.HTTP,
    val host: String = "",
    val port: Int = 0,
    val username: String? = null,
    val password: String? = null
) {
    /**
     * éªŒè¯é…ç½®æ˜¯å¦æœ‰æ•ˆ
     */
    fun isValid(): Boolean {
        if (!enabled) return true
        return host.isNotBlank() && port in 1..65535
    }
    
    /**
     * æ˜¯å¦éœ€è¦è®¤è¯
     */
    fun requiresAuth(): Boolean {
        return !username.isNullOrBlank()
    }
    
    /**
     * è·å–ä»£ç†åœ°å€å­—ç¬¦ä¸²
     */
    fun getProxyAddress(): String {
        return if (enabled && isValid()) {
            "${type.name.lowercase()}://$host:$port"
        } else {
            ""
        }
    }
}

/**
 * ä»£ç†ç±»å‹
 */
enum class ProxyType {
    HTTP,
    HTTPS,
    SOCKS4,
    SOCKS5
}
```


### 4.2 Repositoryæ¥å£

#### 4.2.1 ApiUsageRepository

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/repository/ApiUsageRepository.kt`

```kotlin
package com.empathy.ai.domain.repository

import com.empathy.ai.domain.model.ApiUsageRecord
import com.empathy.ai.domain.model.ApiUsageStats

/**
 * API ç”¨é‡ç»Ÿè®¡ä»“åº“æ¥å£
 *
 * å®šä¹‰ç”¨é‡è®°å½•çš„å­˜å‚¨å’ŒæŸ¥è¯¢æ“ä½œ
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
interface ApiUsageRepository {
    /**
     * è®°å½• API è°ƒç”¨
     *
     * @param record ç”¨é‡è®°å½•
     */
    suspend fun recordUsage(record: ApiUsageRecord): Result<Unit>
    
    /**
     * è·å–ç”¨é‡ç»Ÿè®¡
     *
     * @param startTime å¼€å§‹æ—¶é—´æˆ³
     * @param endTime ç»“æŸæ—¶é—´æˆ³
     */
    suspend fun getUsageStats(startTime: Long, endTime: Long): Result<ApiUsageStats>
    
    /**
     * è·å–æœ€è¿‘çš„ç”¨é‡è®°å½•
     *
     * @param limit è¿”å›æ•°é‡é™åˆ¶
     */
    suspend fun getRecentRecords(limit: Int = 100): Result<List<ApiUsageRecord>>
    
    /**
     * æ¸…é™¤æŒ‡å®šæ—¶é—´ä¹‹å‰çš„è®°å½•
     *
     * @param beforeTime æ—¶é—´æˆ³
     * @return åˆ é™¤çš„è®°å½•æ•°
     */
    suspend fun clearRecordsBefore(beforeTime: Long): Result<Int>
    
    /**
     * è·å–æ€»ç”¨é‡æ¦‚è§ˆ
     */
    suspend fun getTotalUsage(): Result<ApiUsageStats>
    
    /**
     * å¯¼å‡ºç”¨é‡æ•°æ®ä¸ºJSONæ ¼å¼
     *
     * @param startTime å¼€å§‹æ—¶é—´æˆ³
     * @param endTime ç»“æŸæ—¶é—´æˆ³
     * @return JSONæ ¼å¼çš„ç”¨é‡æ•°æ®
     */
    suspend fun exportUsageData(startTime: Long, endTime: Long): Result<String>
}
```

#### 4.2.2 AiProviderRepositoryæ‰©å±•

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/repository/AiProviderRepository.kt`

åœ¨ç°æœ‰æ¥å£ä¸­æ·»åŠ ä»£ç†é…ç½®ç›¸å…³æ–¹æ³•ï¼š

```kotlin
interface AiProviderRepository {
    // ç°æœ‰æ–¹æ³•...
    
    // ğŸ†• æ–°å¢æ–¹æ³•
    /**
     * è·å–ä»£ç†é…ç½®
     */
    suspend fun getProxyConfig(): Result<ProxyConfig>
    
    /**
     * ä¿å­˜ä»£ç†é…ç½®
     */
    suspend fun saveProxyConfig(config: ProxyConfig): Result<Unit>
    
    /**
     * æµ‹è¯•ä»£ç†è¿æ¥
     *
     * @param config ä»£ç†é…ç½®
     * @return æµ‹è¯•ç»“æœï¼ŒæˆåŠŸè¿”å›å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     */
    suspend fun testProxyConnection(config: ProxyConfig): Result<Long>
}
```

### 4.3 UseCaseå®ç°

#### 4.3.1 RecordApiUsageUseCase

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/usecase/RecordApiUsageUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.model.ApiUsageRecord
import com.empathy.ai.domain.repository.ApiUsageRepository
import java.util.UUID
import javax.inject.Inject

/**
 * è®°å½• API ç”¨é‡ç”¨ä¾‹
 *
 * åœ¨æ¯æ¬¡ AI API è°ƒç”¨åè®°å½•ç”¨é‡ä¿¡æ¯
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
class RecordApiUsageUseCase @Inject constructor(
    private val repository: ApiUsageRepository
) {
    /**
     * è®°å½•APIè°ƒç”¨ç”¨é‡
     *
     * @param providerId æœåŠ¡å•†ID
     * @param providerName æœåŠ¡å•†åç§°
     * @param modelId æ¨¡å‹ID
     * @param modelName æ¨¡å‹åç§°
     * @param promptTokens è¾“å…¥Tokenæ•°
     * @param completionTokens è¾“å‡ºTokenæ•°
     * @param requestTimeMs è¯·æ±‚è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
     * @param isSuccess æ˜¯å¦æˆåŠŸ
     * @param errorMessage é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶ï¼‰
     */
    suspend operator fun invoke(
        providerId: String,
        providerName: String,
        modelId: String,
        modelName: String,
        promptTokens: Int,
        completionTokens: Int,
        requestTimeMs: Long,
        isSuccess: Boolean,
        errorMessage: String? = null
    ): Result<Unit> {
        val record = ApiUsageRecord(
            id = UUID.randomUUID().toString(),
            providerId = providerId,
            providerName = providerName,
            modelId = modelId,
            modelName = modelName,
            promptTokens = promptTokens,
            completionTokens = completionTokens,
            totalTokens = promptTokens + completionTokens,
            requestTimeMs = requestTimeMs,
            isSuccess = isSuccess,
            errorMessage = errorMessage
        )
        return repository.recordUsage(record)
    }
}
```

#### 4.3.2 GetApiUsageStatsUseCase

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/usecase/GetApiUsageStatsUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.model.ApiUsageStats
import com.empathy.ai.domain.repository.ApiUsageRepository
import java.util.Calendar
import javax.inject.Inject

/**
 * è·å– API ç”¨é‡ç»Ÿè®¡ç”¨ä¾‹
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
class GetApiUsageStatsUseCase @Inject constructor(
    private val repository: ApiUsageRepository
) {
    /**
     * è·å–æŒ‡å®šæ—¶é—´èŒƒå›´çš„ç»Ÿè®¡
     *
     * @param startTime å¼€å§‹æ—¶é—´æˆ³ï¼ˆå¯é€‰ï¼‰
     * @param endTime ç»“æŸæ—¶é—´æˆ³ï¼ˆå¯é€‰ï¼‰
     */
    suspend operator fun invoke(
        startTime: Long? = null,
        endTime: Long? = null
    ): Result<ApiUsageStats> {
        return if (startTime != null && endTime != null) {
            repository.getUsageStats(startTime, endTime)
        } else {
            repository.getTotalUsage()
        }
    }
    
    /**
     * è·å–ä»Šæ—¥ç»Ÿè®¡
     */
    suspend fun getToday(): Result<ApiUsageStats> {
        val calendar = Calendar.getInstance()
        calendar.set(Calendar.HOUR_OF_DAY, 0)
        calendar.set(Calendar.MINUTE, 0)
        calendar.set(Calendar.SECOND, 0)
        calendar.set(Calendar.MILLISECOND, 0)
        val startOfDay = calendar.timeInMillis
        val now = System.currentTimeMillis()
        return repository.getUsageStats(startOfDay, now)
    }
    
    /**
     * è·å–æœ¬å‘¨ç»Ÿè®¡
     */
    suspend fun getThisWeek(): Result<ApiUsageStats> {
        val calendar = Calendar.getInstance()
        calendar.set(Calendar.DAY_OF_WEEK, calendar.firstDayOfWeek)
        calendar.set(Calendar.HOUR_OF_DAY, 0)
        calendar.set(Calendar.MINUTE, 0)
        calendar.set(Calendar.SECOND, 0)
        calendar.set(Calendar.MILLISECOND, 0)
        val startOfWeek = calendar.timeInMillis
        val now = System.currentTimeMillis()
        return repository.getUsageStats(startOfWeek, now)
    }
    
    /**
     * è·å–æœ¬æœˆç»Ÿè®¡
     */
    suspend fun getThisMonth(): Result<ApiUsageStats> {
        val calendar = Calendar.getInstance()
        calendar.set(Calendar.DAY_OF_MONTH, 1)
        calendar.set(Calendar.HOUR_OF_DAY, 0)
        calendar.set(Calendar.MINUTE, 0)
        calendar.set(Calendar.SECOND, 0)
        calendar.set(Calendar.MILLISECOND, 0)
        val startOfMonth = calendar.timeInMillis
        val now = System.currentTimeMillis()
        return repository.getUsageStats(startOfMonth, now)
    }
}
```

#### 4.3.3 CleanupApiUsageUseCase

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/usecase/CleanupApiUsageUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.repository.ApiUsageRepository
import javax.inject.Inject

/**
 * æ¸…ç† API ç”¨é‡è®°å½•ç”¨ä¾‹
 *
 * è‡ªåŠ¨æ¸…ç†90å¤©å‰çš„å†å²æ•°æ®
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
class CleanupApiUsageUseCase @Inject constructor(
    private val repository: ApiUsageRepository
) {
    companion object {
        private const val RETENTION_DAYS = 90L
        private const val MS_PER_DAY = 24L * 60 * 60 * 1000
    }
    
    /**
     * æ¸…ç†90å¤©å‰çš„è®°å½•
     *
     * @return åˆ é™¤çš„è®°å½•æ•°
     */
    suspend operator fun invoke(): Result<Int> {
        val cutoffTime = System.currentTimeMillis() - (RETENTION_DAYS * MS_PER_DAY)
        return repository.clearRecordsBefore(cutoffTime)
    }
    
    /**
     * æ¸…ç†æŒ‡å®šå¤©æ•°å‰çš„è®°å½•
     *
     * @param days ä¿ç•™å¤©æ•°
     * @return åˆ é™¤çš„è®°å½•æ•°
     */
    suspend fun cleanupOlderThan(days: Int): Result<Int> {
        val cutoffTime = System.currentTimeMillis() - (days.toLong() * MS_PER_DAY)
        return repository.clearRecordsBefore(cutoffTime)
    }
    
    /**
     * æ¸…é™¤æ‰€æœ‰è®°å½•
     *
     * @return åˆ é™¤çš„è®°å½•æ•°
     */
    suspend fun clearAll(): Result<Int> {
        return repository.clearRecordsBefore(System.currentTimeMillis() + 1)
    }
}
```

#### 4.3.4 ExportApiUsageUseCase

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/usecase/ExportApiUsageUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.repository.ApiUsageRepository
import javax.inject.Inject

/**
 * å¯¼å‡º API ç”¨é‡æ•°æ®ç”¨ä¾‹
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
class ExportApiUsageUseCase @Inject constructor(
    private val repository: ApiUsageRepository
) {
    /**
     * å¯¼å‡ºæŒ‡å®šæ—¶é—´èŒƒå›´çš„ç”¨é‡æ•°æ®
     *
     * @param startTime å¼€å§‹æ—¶é—´æˆ³
     * @param endTime ç»“æŸæ—¶é—´æˆ³
     * @return JSONæ ¼å¼çš„ç”¨é‡æ•°æ®
     */
    suspend operator fun invoke(startTime: Long, endTime: Long): Result<String> {
        return repository.exportUsageData(startTime, endTime)
    }
    
    /**
     * å¯¼å‡ºæ‰€æœ‰ç”¨é‡æ•°æ®
     *
     * @return JSONæ ¼å¼çš„ç”¨é‡æ•°æ®
     */
    suspend fun exportAll(): Result<String> {
        return repository.exportUsageData(0L, System.currentTimeMillis())
    }
}
```


---

## 5. ç½‘ç»œå±‚æŠ€æœ¯å®ç°

### 5.1 ä»£ç†é…ç½®é›†æˆ

#### 5.1.1 NetworkModuleæ‰©å±•

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/di/NetworkModule.kt`

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object NetworkModule {
    
    /**
     * æä¾›æ”¯æŒä»£ç†çš„OkHttpClient
     *
     * ä»£ç†é…ç½®å˜æ›´æ—¶éœ€è¦é‡å»ºOkHttpClient
     * ä½¿ç”¨Provideræ¨¡å¼æ”¯æŒåŠ¨æ€æ›´æ–°
     */
    @Provides
    @Singleton
    fun provideOkHttpClient(
        proxyPreferences: ProxyPreferences,
        loggingInterceptor: HttpLoggingInterceptor
    ): OkHttpClient {
        val builder = OkHttpClient.Builder()
            .connectTimeout(30, TimeUnit.SECONDS)
            .readTimeout(60, TimeUnit.SECONDS)
            .writeTimeout(60, TimeUnit.SECONDS)
            .addInterceptor(loggingInterceptor)
        
        // åº”ç”¨ä»£ç†é…ç½®
        applyProxyConfig(builder, proxyPreferences.getProxyConfig())
        
        return builder.build()
    }
    
    /**
     * åº”ç”¨ä»£ç†é…ç½®åˆ°OkHttpClient.Builder
     */
    private fun applyProxyConfig(
        builder: OkHttpClient.Builder,
        proxyConfig: ProxyConfig
    ) {
        if (!proxyConfig.enabled || !proxyConfig.isValid()) {
            return
        }
        
        // è®¾ç½®ä»£ç†ç±»å‹
        val proxyType = when (proxyConfig.type) {
            ProxyType.HTTP, ProxyType.HTTPS -> Proxy.Type.HTTP
            ProxyType.SOCKS4, ProxyType.SOCKS5 -> Proxy.Type.SOCKS
        }
        
        // åˆ›å»ºä»£ç†
        val proxy = Proxy(
            proxyType,
            InetSocketAddress(proxyConfig.host, proxyConfig.port)
        )
        builder.proxy(proxy)
        
        // è®¾ç½®ä»£ç†è®¤è¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (proxyConfig.requiresAuth()) {
            builder.proxyAuthenticator { _, response ->
                val credential = Credentials.basic(
                    proxyConfig.username ?: "",
                    proxyConfig.password ?: ""
                )
                response.request.newBuilder()
                    .header("Proxy-Authorization", credential)
                    .build()
            }
        }
    }
    
    /**
     * æä¾›å¯é‡å»ºçš„OkHttpClientå·¥å‚
     *
     * ç”¨äºä»£ç†é…ç½®å˜æ›´æ—¶é‡å»ºå®¢æˆ·ç«¯
     */
    @Provides
    @Singleton
    fun provideOkHttpClientFactory(
        proxyPreferences: ProxyPreferences,
        loggingInterceptor: HttpLoggingInterceptor
    ): OkHttpClientFactory {
        return OkHttpClientFactory(proxyPreferences, loggingInterceptor)
    }
}

/**
 * OkHttpClientå·¥å‚
 *
 * æ”¯æŒä»£ç†é…ç½®å˜æ›´æ—¶é‡å»ºå®¢æˆ·ç«¯
 */
class OkHttpClientFactory @Inject constructor(
    private val proxyPreferences: ProxyPreferences,
    private val loggingInterceptor: HttpLoggingInterceptor
) {
    @Volatile
    private var currentClient: OkHttpClient? = null
    private var currentProxyConfig: ProxyConfig? = null
    
    /**
     * è·å–OkHttpClient
     *
     * å¦‚æœä»£ç†é…ç½®å˜æ›´ï¼Œè‡ªåŠ¨é‡å»ºå®¢æˆ·ç«¯
     */
    fun getClient(): OkHttpClient {
        val proxyConfig = proxyPreferences.getProxyConfig()
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å»º
        if (currentClient == null || currentProxyConfig != proxyConfig) {
            synchronized(this) {
                if (currentClient == null || currentProxyConfig != proxyConfig) {
                    currentClient = buildClient(proxyConfig)
                    currentProxyConfig = proxyConfig
                }
            }
        }
        
        return currentClient!!
    }
    
    /**
     * å¼ºåˆ¶é‡å»ºå®¢æˆ·ç«¯
     */
    fun rebuild(): OkHttpClient {
        synchronized(this) {
            val proxyConfig = proxyPreferences.getProxyConfig()
            currentClient = buildClient(proxyConfig)
            currentProxyConfig = proxyConfig
            return currentClient!!
        }
    }
    
    private fun buildClient(proxyConfig: ProxyConfig): OkHttpClient {
        val builder = OkHttpClient.Builder()
            .connectTimeout(30, TimeUnit.SECONDS)
            .readTimeout(60, TimeUnit.SECONDS)
            .writeTimeout(60, TimeUnit.SECONDS)
            .addInterceptor(loggingInterceptor)
        
        if (proxyConfig.enabled && proxyConfig.isValid()) {
            val proxyType = when (proxyConfig.type) {
                ProxyType.HTTP, ProxyType.HTTPS -> Proxy.Type.HTTP
                ProxyType.SOCKS4, ProxyType.SOCKS5 -> Proxy.Type.SOCKS
            }
            
            val proxy = Proxy(
                proxyType,
                InetSocketAddress(proxyConfig.host, proxyConfig.port)
            )
            builder.proxy(proxy)
            
            if (proxyConfig.requiresAuth()) {
                builder.proxyAuthenticator { _, response ->
                    val credential = Credentials.basic(
                        proxyConfig.username ?: "",
                        proxyConfig.password ?: ""
                    )
                    response.request.newBuilder()
                        .header("Proxy-Authorization", credential)
                        .build()
                }
            }
        }
        
        return builder.build()
    }
}
```

### 5.2 ç”¨é‡è®°å½•é›†æˆ

#### 5.2.1 AiRepositoryImplæ‰©å±•

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/repository/AiRepositoryImpl.kt`

åœ¨AIè°ƒç”¨æ–¹æ³•ä¸­é›†æˆç”¨é‡è®°å½•ï¼š

```kotlin
class AiRepositoryImpl @Inject constructor(
    private val api: OpenAiApi,
    private val recordApiUsageUseCase: RecordApiUsageUseCase,  // ğŸ†• æ³¨å…¥
    // å…¶ä»–ä¾èµ–...
) : AiRepository {
    
    override suspend fun chat(
        provider: AiProvider,
        messages: List<ChatMessage>,
        systemPrompt: String?
    ): Result<AiResult> {
        val startTime = System.currentTimeMillis()
        val model = provider.getDefaultModel()
        
        return try {
            // æ„å»ºè¯·æ±‚
            val request = ChatRequestDto(
                model = provider.defaultModelId,
                messages = buildMessages(messages, systemPrompt),
                temperature = provider.temperature,  // ğŸ†• ä½¿ç”¨providerçš„temperature
                maxTokens = provider.maxTokens       // ğŸ†• ä½¿ç”¨providerçš„maxTokens
            )
            
            // å‘é€è¯·æ±‚
            val response = api.chat(
                baseUrl = provider.baseUrl,
                apiKey = "Bearer ${provider.apiKey}",
                request = request
            )
            
            val endTime = System.currentTimeMillis()
            
            // ğŸ†• è®°å½•ç”¨é‡ï¼ˆæˆåŠŸï¼‰
            recordApiUsageUseCase(
                providerId = provider.id,
                providerName = provider.name,
                modelId = provider.defaultModelId,
                modelName = model?.name ?: provider.defaultModelId,
                promptTokens = response.usage?.promptTokens ?: 0,
                completionTokens = response.usage?.completionTokens ?: 0,
                requestTimeMs = endTime - startTime,
                isSuccess = true
            )
            
            // è§£æå“åº”
            val content = response.choices.firstOrNull()?.message?.content ?: ""
            Result.success(AiResult(content = content))
            
        } catch (e: Exception) {
            val endTime = System.currentTimeMillis()
            
            // ğŸ†• è®°å½•ç”¨é‡ï¼ˆå¤±è´¥ï¼‰
            recordApiUsageUseCase(
                providerId = provider.id,
                providerName = provider.name,
                modelId = provider.defaultModelId,
                modelName = model?.name ?: provider.defaultModelId,
                promptTokens = 0,
                completionTokens = 0,
                requestTimeMs = endTime - startTime,
                isSuccess = false,
                errorMessage = e.message
            )
            
            Result.failure(e)
        }
    }
}
```

### 5.3 é”™è¯¯å¤„ç†åœºæ™¯è¯´æ˜

#### 5.3.1 ç½‘ç»œå±‚é”™è¯¯å¤„ç†

åœ¨AI APIè°ƒç”¨å’Œä»£ç†è¿æ¥è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å¤„ç†ä»¥ä¸‹é”™è¯¯åœºæ™¯ï¼š

| é”™è¯¯åœºæ™¯ | é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·æç¤º |
|----------|----------|----------|----------|
| ç½‘ç»œä¸å¯ç”¨ | `UnknownHostException` | æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæç¤ºç”¨æˆ· | "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®" |
| è¿æ¥è¶…æ—¶ | `SocketTimeoutException` | é‡è¯•ä¸€æ¬¡ï¼Œè¶…æ—¶æ—¶é—´åŠ å€ | "è¿æ¥è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•" |
| è®¤è¯å¤±è´¥ | HTTP 401/403 | æç¤ºæ£€æŸ¥APIå¯†é’¥ | "è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®" |
| æœåŠ¡ä¸å¯ç”¨ | HTTP 503 | æç¤ºæœåŠ¡å•†çŠ¶æ€ | "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•" |
| ä»£ç†è¿æ¥å¤±è´¥ | `ProxyConnectException` | æç¤ºæ£€æŸ¥ä»£ç†é…ç½® | "ä»£ç†è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç†è®¾ç½®" |
| ä»£ç†è®¤è¯å¤±è´¥ | HTTP 407 | æç¤ºæ£€æŸ¥ä»£ç†è®¤è¯ä¿¡æ¯ | "ä»£ç†è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç " |
| è¯·æ±‚é¢‘ç‡é™åˆ¶ | HTTP 429 | æŒ‡æ•°é€€é¿é‡è¯• | "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•" |
| æœåŠ¡å™¨é”™è¯¯ | HTTP 5xx | è®°å½•æ—¥å¿—ï¼Œæç¤ºç”¨æˆ· | "æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•" |

#### 5.3.2 é”™è¯¯å¤„ç†ä»£ç ç¤ºä¾‹

```kotlin
/**
 * ç»Ÿä¸€é”™è¯¯å¤„ç†å™¨
 */
object ApiErrorHandler {
    
    /**
     * å¤„ç†APIè°ƒç”¨å¼‚å¸¸
     *
     * @param exception å¼‚å¸¸å¯¹è±¡
     * @return ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
     */
    fun handleException(exception: Throwable): String {
        return when (exception) {
            is UnknownHostException -> "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®"
            is SocketTimeoutException -> "è¿æ¥è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•"
            is HttpException -> handleHttpException(exception)
            is SSLException -> "å®‰å…¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œç¯å¢ƒ"
            is IOException -> "ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š${exception.message}"
            else -> "æœªçŸ¥é”™è¯¯ï¼š${exception.message}"
        }
    }
    
    private fun handleHttpException(exception: HttpException): String {
        return when (exception.code()) {
            401, 403 -> "è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®"
            407 -> "ä»£ç†è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç "
            429 -> "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•"
            503 -> "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"
            in 500..599 -> "æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•"
            else -> "è¯·æ±‚å¤±è´¥ï¼šHTTP ${exception.code()}"
        }
    }
}
```

### 5.4 OpenAiApiæ¥å£è¯¦ç»†è¯´æ˜

#### 5.4.1 æ¥å£å®šä¹‰

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/remote/api/OpenAiApi.kt`

```kotlin
/**
 * OpenAIå…¼å®¹APIæ¥å£
 *
 * æ”¯æŒOpenAIã€DeepSeekç­‰å…¼å®¹OpenAI APIæ ¼å¼çš„æœåŠ¡å•†
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
interface OpenAiApi {
    
    /**
     * å‘é€èŠå¤©è¯·æ±‚
     *
     * @param baseUrl æœåŠ¡å•†åŸºç¡€URLï¼ˆåŠ¨æ€é…ç½®ï¼‰
     * @param apiKey APIå¯†é’¥ï¼ˆBeareræ ¼å¼ï¼‰
     * @param request èŠå¤©è¯·æ±‚ä½“
     * @return èŠå¤©å“åº”
     *
     * @throws HttpException HTTPé”™è¯¯ï¼ˆ401è®¤è¯å¤±è´¥ã€429é¢‘ç‡é™åˆ¶ã€5xxæœåŠ¡å™¨é”™è¯¯ï¼‰
     * @throws IOException ç½‘ç»œé”™è¯¯
     * @throws SocketTimeoutException è¿æ¥è¶…æ—¶
     */
    @POST
    suspend fun chat(
        @Url baseUrl: String,
        @Header("Authorization") apiKey: String,
        @Body request: ChatRequestDto
    ): ChatResponseDto
    
    /**
     * è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
     *
     * @param baseUrl æœåŠ¡å•†åŸºç¡€URL
     * @param apiKey APIå¯†é’¥
     * @return æ¨¡å‹åˆ—è¡¨å“åº”
     */
    @GET
    suspend fun getModels(
        @Url baseUrl: String,
        @Header("Authorization") apiKey: String
    ): ModelsResponseDto
}
```

#### 5.4.2 è¯·æ±‚å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | å–å€¼èŒƒå›´ |
|------|------|------|------|----------|
| `model` | String | æ˜¯ | æ¨¡å‹ID | æœåŠ¡å•†æ”¯æŒçš„æ¨¡å‹ID |
| `messages` | List | æ˜¯ | æ¶ˆæ¯åˆ—è¡¨ | è‡³å°‘åŒ…å«ä¸€æ¡æ¶ˆæ¯ |
| `temperature` | Float | å¦ | éšæœºæ€§æ§åˆ¶ | 0.0 - 2.0ï¼Œé»˜è®¤0.7 |
| `max_tokens` | Int | å¦ | æœ€å¤§è¾“å‡ºTokenæ•° | 1 - 128000ï¼Œé»˜è®¤4096 |
| `stream` | Boolean | å¦ | æ˜¯å¦æµå¼è¾“å‡º | true/falseï¼Œé»˜è®¤false |

#### 5.4.3 å“åº”æ ¼å¼è¯´æ˜

```kotlin
/**
 * èŠå¤©å“åº”DTO
 */
data class ChatResponseDto(
    val id: String,                    // å“åº”ID
    val `object`: String,              // å¯¹è±¡ç±»å‹ï¼Œå›ºå®šä¸º"chat.completion"
    val created: Long,                 // åˆ›å»ºæ—¶é—´æˆ³
    val model: String,                 // ä½¿ç”¨çš„æ¨¡å‹ID
    val choices: List<ChoiceDto>,      // å“åº”é€‰é¡¹åˆ—è¡¨
    val usage: UsageDto?               // Tokenç”¨é‡ä¿¡æ¯
)

/**
 * Tokenç”¨é‡ä¿¡æ¯
 */
data class UsageDto(
    @Json(name = "prompt_tokens")
    val promptTokens: Int,             // è¾“å…¥Tokenæ•°
    @Json(name = "completion_tokens")
    val completionTokens: Int,         // è¾“å‡ºTokenæ•°
    @Json(name = "total_tokens")
    val totalTokens: Int               // æ€»Tokenæ•°
)
```

#### 5.4.4 æœåŠ¡å•†å…¼å®¹æ€§

| æœåŠ¡å•† | åŸºç¡€URL | temperatureæ”¯æŒ | max_tokensæ”¯æŒ | å¤‡æ³¨ |
|--------|---------|-----------------|----------------|------|
| OpenAI | `https://api.openai.com/v1/chat/completions` | âœ… 0-2 | âœ… 1-128000 | å®˜æ–¹API |
| DeepSeek | `https://api.deepseek.com/v1/chat/completions` | âœ… 0-2 | âœ… 1-32768 | å…¼å®¹OpenAIæ ¼å¼ |
| Azure OpenAI | `https://{resource}.openai.azure.com/...` | âœ… 0-2 | âœ… 1-128000 | éœ€è¦é¢å¤–é…ç½® |
| è‡ªå®šä¹‰ | ç”¨æˆ·é…ç½® | å–å†³äºæœåŠ¡å•† | å–å†³äºæœåŠ¡å•† | éœ€è¦æµ‹è¯•éªŒè¯ |

### 5.5 ä»£ç†æµ‹è¯•å®ç°

#### 5.3.1 TestProxyConnectionUseCase

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/usecase/TestProxyConnectionUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.model.ProxyConfig
import com.empathy.ai.domain.repository.AiProviderRepository
import javax.inject.Inject

/**
 * æµ‹è¯•ä»£ç†è¿æ¥ç”¨ä¾‹
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
class TestProxyConnectionUseCase @Inject constructor(
    private val repository: AiProviderRepository
) {
    /**
     * æµ‹è¯•ä»£ç†è¿æ¥
     *
     * @param config ä»£ç†é…ç½®
     * @return æˆåŠŸè¿”å›å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œå¤±è´¥è¿”å›é”™è¯¯
     */
    suspend operator fun invoke(config: ProxyConfig): Result<Long> {
        // éªŒè¯é…ç½®
        if (!config.isValid()) {
            return Result.failure(IllegalArgumentException("ä»£ç†é…ç½®æ— æ•ˆï¼šè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œç«¯å£"))
        }
        
        return repository.testProxyConnection(config)
    }
}
```

#### 5.3.2 AiProviderRepositoryImplä»£ç†æµ‹è¯•å®ç°

```kotlin
// åœ¨AiProviderRepositoryImplä¸­æ·»åŠ 
override suspend fun testProxyConnection(config: ProxyConfig): Result<Long> {
    return withContext(Dispatchers.IO) {
        try {
            val startTime = System.currentTimeMillis()
            
            // åˆ›å»ºä¸´æ—¶OkHttpClientç”¨äºæµ‹è¯•
            val proxyType = when (config.type) {
                ProxyType.HTTP, ProxyType.HTTPS -> Proxy.Type.HTTP
                ProxyType.SOCKS4, ProxyType.SOCKS5 -> Proxy.Type.SOCKS
            }
            
            val proxy = Proxy(
                proxyType,
                InetSocketAddress(config.host, config.port)
            )
            
            val testClient = OkHttpClient.Builder()
                .proxy(proxy)
                .connectTimeout(10, TimeUnit.SECONDS)
                .readTimeout(10, TimeUnit.SECONDS)
                .apply {
                    if (config.requiresAuth()) {
                        proxyAuthenticator { _, response ->
                            val credential = Credentials.basic(
                                config.username ?: "",
                                config.password ?: ""
                            )
                            response.request.newBuilder()
                                .header("Proxy-Authorization", credential)
                                .build()
                        }
                    }
                }
                .build()
            
            // æµ‹è¯•è¿æ¥ï¼ˆè®¿é—®ä¸€ä¸ªå¯é çš„æµ‹è¯•ç«¯ç‚¹ï¼‰
            val request = Request.Builder()
                .url("https://www.google.com/generate_204")
                .head()
                .build()
            
            testClient.newCall(request).execute().use { response ->
                val endTime = System.currentTimeMillis()
                val latency = endTime - startTime
                
                if (response.isSuccessful || response.code == 204) {
                    Result.success(latency)
                } else {
                    Result.failure(Exception("ä»£ç†è¿æ¥å¤±è´¥ï¼šHTTP ${response.code}"))
                }
            }
        } catch (e: Exception) {
            Result.failure(Exception("ä»£ç†è¿æ¥å¤±è´¥ï¼š${e.message}"))
        }
    }
}
```


---

## 6. è¡¨ç°å±‚æŠ€æœ¯å®ç°

### 6.1 UIç»„ä»¶æŠ€æœ¯è§„æ ¼

#### 6.1.1 TemperatureSlider

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/TemperatureSlider.kt`

```kotlin
package com.empathy.ai.presentation.ui.component.ios

import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import com.empathy.ai.presentation.theme.iOSBlue
import com.empathy.ai.presentation.theme.iOSTextSecondary
import kotlin.math.roundToInt

/**
 * iOSé£æ ¼Temperatureæ»‘å—
 *
 * è®¾è®¡è§„æ ¼:
 * - æ»‘å—èŒƒå›´: 0.0 - 2.0
 * - æ­¥è¿›å€¼: 0.1
 * - å®æ—¶æ˜¾ç¤ºå½“å‰å€¼
 * - iOSé£æ ¼æ»‘å—æ ·å¼
 * - è¾¹ç•Œä¿æŠ¤ï¼šè‡ªåŠ¨é™åˆ¶åœ¨æœ‰æ•ˆèŒƒå›´å†…
 *
 * @param value å½“å‰å€¼
 * @param onValueChange å€¼å˜æ›´å›è°ƒ
 * @param modifier Modifier
 * @param minValue æœ€å°å€¼ï¼Œé»˜è®¤0.0
 * @param maxValue æœ€å¤§å€¼ï¼Œé»˜è®¤2.0
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
@Composable
fun TemperatureSlider(
    value: Float,
    onValueChange: (Float) -> Unit,
    modifier: Modifier = Modifier,
    minValue: Float = 0f,
    maxValue: Float = 2f
) {
    // è¾¹ç•Œä¿æŠ¤ï¼šç¡®ä¿valueåœ¨æœ‰æ•ˆèŒƒå›´å†…
    val safeValue = value.coerceIn(minValue, maxValue)
    
    Column(modifier = modifier.fillMaxWidth()) {
        // æ ‡ç­¾å’Œå½“å‰å€¼
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = "Temperature",
                style = MaterialTheme.typography.bodyLarge
            )
            Text(
                text = "%.1f".format(safeValue),
                style = MaterialTheme.typography.bodyLarge,
                color = iOSBlue
            )
        }
        
        Spacer(modifier = Modifier.height(8.dp))
        
        // æ»‘å—
        Slider(
            value = safeValue,
            onValueChange = { newValue ->
                // å››èˆäº”å…¥åˆ°0.1ï¼Œå¹¶ç¡®ä¿åœ¨è¾¹ç•Œå†…
                val rounded = (newValue * 10).roundToInt() / 10f
                val bounded = rounded.coerceIn(minValue, maxValue)
                onValueChange(bounded)
            },
            valueRange = minValue..maxValue,
            steps = ((maxValue - minValue) * 10).toInt() - 1,  // åŠ¨æ€è®¡ç®—æ­¥æ•°
            colors = SliderDefaults.colors(
                thumbColor = iOSBlue,
                activeTrackColor = iOSBlue,
                inactiveTrackColor = iOSBlue.copy(alpha = 0.3f)
            ),
            modifier = Modifier.fillMaxWidth()
        )
        
        // èŒƒå›´æ ‡ç­¾
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween
        ) {
            Text(
                text = "ç²¾ç¡®",
                style = MaterialTheme.typography.bodySmall,
                color = iOSTextSecondary
            )
            Text(
                text = "åˆ›æ„",
                style = MaterialTheme.typography.bodySmall,
                color = iOSTextSecondary
            )
        }
        
        // è¯´æ˜æ–‡å­—
        Spacer(modifier = Modifier.height(4.dp))
        Text(
            text = "è¾ƒä½çš„å€¼ä½¿è¾“å‡ºæ›´ç¡®å®šï¼Œè¾ƒé«˜çš„å€¼ä½¿è¾“å‡ºæ›´éšæœº",
            style = MaterialTheme.typography.bodySmall,
            color = iOSTextSecondary
        )
    }
}
```

#### 6.1.2 TokenLimitInput

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/TokenLimitInput.kt`

```kotlin
package com.empathy.ai.presentation.ui.component.ios

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.BasicTextField
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.empathy.ai.presentation.theme.*

/**
 * iOSé£æ ¼Tokené™åˆ¶è¾“å…¥
 *
 * è®¾è®¡è§„æ ¼:
 * - æ•°å­—è¾“å…¥æ¡†
 * - æ”¯æŒå¿«æ·é€‰é¡¹: 1024, 2048, 4096, 8192, 16384
 * - è¾“å…¥éªŒè¯: æ­£æ•´æ•°
 *
 * @param value å½“å‰å€¼
 * @param onValueChange å€¼å˜æ›´å›è°ƒ
 * @param quickOptions å¿«æ·é€‰é¡¹åˆ—è¡¨
 * @param modifier Modifier
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
@Composable
fun TokenLimitInput(
    value: Int,
    onValueChange: (Int) -> Unit,
    quickOptions: List<Int> = listOf(1024, 2048, 4096, 8192, 16384),
    modifier: Modifier = Modifier
) {
    var textValue by remember(value) { mutableStateOf(value.toString()) }
    
    Column(modifier = modifier.fillMaxWidth()) {
        // æ ‡ç­¾å’Œè¾“å…¥æ¡†
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = "æœ€å¤§Tokenæ•°",
                style = MaterialTheme.typography.bodyLarge
            )
            
            // è¾“å…¥æ¡†
            BasicTextField(
                value = textValue,
                onValueChange = { newText ->
                    // åªå…è®¸æ•°å­—
                    val filtered = newText.filter { it.isDigit() }
                    textValue = filtered
                    filtered.toIntOrNull()?.let { intValue ->
                        if (intValue > 0) {
                            onValueChange(intValue)
                        }
                    }
                },
                keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),
                textStyle = MaterialTheme.typography.bodyLarge.copy(
                    textAlign = TextAlign.End,
                    color = iOSBlue
                ),
                modifier = Modifier.width(100.dp),
                singleLine = true
            )
        }
        
        Spacer(modifier = Modifier.height(12.dp))
        
        // å¿«æ·é€‰é¡¹
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            quickOptions.forEach { option ->
                QuickOptionChip(
                    text = formatTokenCount(option),
                    isSelected = value == option,
                    onClick = {
                        textValue = option.toString()
                        onValueChange(option)
                    },
                    modifier = Modifier.weight(1f)
                )
            }
        }
        
        // è¯´æ˜æ–‡å­—
        Spacer(modifier = Modifier.height(8.dp))
        Text(
            text = "é™åˆ¶AIå“åº”çš„æœ€å¤§é•¿åº¦ï¼Œè¾ƒå¤§çš„å€¼å…è®¸æ›´é•¿çš„å›å¤",
            style = MaterialTheme.typography.bodySmall,
            color = iOSTextSecondary
        )
    }
}

@Composable
private fun QuickOptionChip(
    text: String,
    isSelected: Boolean,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Box(
        modifier = modifier
            .background(
                color = if (isSelected) iOSBlue else iOSBlue.copy(alpha = 0.1f),
                shape = RoundedCornerShape(8.dp)
            )
            .clickable(onClick = onClick)
            .padding(vertical = 8.dp),
        contentAlignment = Alignment.Center
    ) {
        Text(
            text = text,
            style = MaterialTheme.typography.bodySmall,
            color = if (isSelected) Color.White else iOSBlue
        )
    }
}

private fun formatTokenCount(count: Int): String {
    return when {
        count >= 1000 -> "${count / 1000}K"
        else -> count.toString()
    }
}
```

#### 6.1.3 DraggableModelList

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/ios/DraggableModelList.kt`

```kotlin
package com.empathy.ai.presentation.ui.component.ios

import androidx.compose.animation.core.*
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.gestures.detectDragGesturesAfterLongPress
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.foundation.lazy.rememberLazyListState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.DragHandle
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.scale
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.graphicsLayer
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.unit.dp
import androidx.compose.ui.zIndex
import com.empathy.ai.presentation.theme.*
import com.empathy.ai.presentation.ui.screen.aiconfig.FormModel

/**
 * å¯æ‹–æ‹½æ¨¡å‹åˆ—è¡¨
 *
 * è®¾è®¡è§„æ ¼:
 * - é•¿æŒ‰è§¦å‘æ‹–æ‹½
 * - æ‹–æ‹½é¡¹æ”¾å¤§1.05å€
 * - å…¶ä»–é¡¹è‡ªåŠ¨è…¾å‡ºç©ºé—´
 * - ä¸‰ä¸ªè“è‰²æ¨ªæ æ‹–æ‹½æ‰‹æŸ„
 * - æ‹–æ‹½èŒƒå›´é™åˆ¶åœ¨åˆ—è¡¨å†…
 *
 * @param models æ¨¡å‹åˆ—è¡¨
 * @param defaultModelId é»˜è®¤æ¨¡å‹ID
 * @param onReorder é‡æ’åºå›è°ƒ
 * @param onSetDefault è®¾ç½®é»˜è®¤æ¨¡å‹å›è°ƒ
 * @param onDelete åˆ é™¤æ¨¡å‹å›è°ƒ
 * @param modifier Modifier
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
@OptIn(ExperimentalFoundationApi::class)
@Composable
fun DraggableModelList(
    models: List<FormModel>,
    defaultModelId: String,
    onReorder: (fromIndex: Int, toIndex: Int) -> Unit,
    onSetDefault: (modelId: String) -> Unit,
    onDelete: (modelId: String) -> Unit,
    modifier: Modifier = Modifier
) {
    var draggedIndex by remember { mutableStateOf<Int?>(null) }
    var dragOffset by remember { mutableStateOf(0f) }
    val listState = rememberLazyListState()
    
    LazyColumn(
        state = listState,
        modifier = modifier,
        verticalArrangement = Arrangement.spacedBy(0.dp)
    ) {
        itemsIndexed(
            items = models,
            key = { _, model -> model.id }
        ) { index, model ->
            val isDragging = draggedIndex == index
            val scale by animateFloatAsState(
                targetValue = if (isDragging) 1.05f else 1f,
                animationSpec = spring(stiffness = Spring.StiffnessHigh),
                label = "scale"
            )
            
            DraggableModelItem(
                model = model,
                isDefault = model.id == defaultModelId,
                isDragging = isDragging,
                scale = scale,
                dragOffset = if (isDragging) dragOffset else 0f,
                onDragStart = { draggedIndex = index },
                onDrag = { offset ->
                    dragOffset = offset
                    // è®¡ç®—ç›®æ ‡ä½ç½®
                    val itemHeight = 56.dp.value  // å‡è®¾æ¯é¡¹é«˜åº¦56dp
                    val targetIndex = (index + (offset / itemHeight).toInt())
                        .coerceIn(0, models.lastIndex)
                    if (targetIndex != index) {
                        onReorder(index, targetIndex)
                        draggedIndex = targetIndex
                        dragOffset = 0f
                    }
                },
                onDragEnd = {
                    draggedIndex = null
                    dragOffset = 0f
                },
                onClick = { onSetDefault(model.id) },
                onDelete = { onDelete(model.id) },
                showDivider = index < models.lastIndex,
                modifier = Modifier
                    .zIndex(if (isDragging) 1f else 0f)
                    .animateItemPlacement()
            )
        }
    }
}

@Composable
private fun DraggableModelItem(
    model: FormModel,
    isDefault: Boolean,
    isDragging: Boolean,
    scale: Float,
    dragOffset: Float,
    onDragStart: () -> Unit,
    onDrag: (Float) -> Unit,
    onDragEnd: () -> Unit,
    onClick: () -> Unit,
    onDelete: () -> Unit,
    showDivider: Boolean,
    modifier: Modifier = Modifier
) {
    Box(
        modifier = modifier
            .fillMaxWidth()
            .graphicsLayer {
                scaleX = scale
                scaleY = scale
                translationY = dragOffset
            }
            .then(
                if (isDragging) {
                    Modifier.shadow(8.dp, RoundedCornerShape(8.dp))
                } else {
                    Modifier
                }
            )
            .background(iOSCardBackground)
            .pointerInput(Unit) {
                detectDragGesturesAfterLongPress(
                    onDragStart = { onDragStart() },
                    onDrag = { change, dragAmount ->
                        change.consume()
                        onDrag(dragAmount.y)
                    },
                    onDragEnd = { onDragEnd() },
                    onDragCancel = { onDragEnd() }
                )
            }
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .height(56.dp)
                .padding(horizontal = 16.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            // æ¨¡å‹åç§°
            Column(modifier = Modifier.weight(1f)) {
                Text(
                    text = model.displayName.ifBlank { model.id },
                    style = MaterialTheme.typography.bodyLarge
                )
                if (isDefault) {
                    Text(
                        text = "é»˜è®¤",
                        style = MaterialTheme.typography.bodySmall,
                        color = iOSBlue
                    )
                }
            }
            
            // æ‹–æ‹½æ‰‹æŸ„
            Icon(
                imageVector = Icons.Default.DragHandle,
                contentDescription = "æ‹–æ‹½æ’åº",
                tint = iOSBlue,
                modifier = Modifier.size(24.dp)
            )
        }
        
        // åˆ†éš”çº¿
        if (showDivider && !isDragging) {
            Divider(
                modifier = Modifier
                    .align(Alignment.BottomCenter)
                    .padding(start = 16.dp),
                color = iOSDivider
            )
        }
    }
}
```


### 6.2 é¡µé¢å®ç°

#### 6.2.1 ProxySettingsDialog

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/aiconfig/ProxySettingsDialog.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.aiconfig

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.compose.ui.window.Dialog
import androidx.compose.ui.window.DialogProperties
import com.empathy.ai.domain.model.ProxyConfig
import com.empathy.ai.domain.model.ProxyType
import com.empathy.ai.presentation.theme.*
import com.empathy.ai.presentation.ui.component.ios.*

/**
 * ä»£ç†è®¾ç½®å¯¹è¯æ¡†
 *
 * å…¨å±iOSé£æ ¼å¯¹è¯æ¡†ï¼Œæ”¯æŒä»£ç†é…ç½®å’Œæµ‹è¯•
 *
 * @param config å½“å‰ä»£ç†é…ç½®
 * @param onConfigChange é…ç½®å˜æ›´å›è°ƒ
 * @param onDismiss å…³é—­å›è°ƒ
 * @param onSave ä¿å­˜å›è°ƒ
 * @param isTestingProxy æ˜¯å¦æ­£åœ¨æµ‹è¯•ä»£ç†
 * @param proxyTestResult ä»£ç†æµ‹è¯•ç»“æœ
 * @param onTestProxy æµ‹è¯•ä»£ç†å›è°ƒ
 * @param modifier Modifier
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
@Composable
fun ProxySettingsDialog(
    config: ProxyConfig,
    onConfigChange: (ProxyConfig) -> Unit,
    onDismiss: () -> Unit,
    onSave: () -> Unit,
    isTestingProxy: Boolean = false,
    proxyTestResult: ProxyTestResult? = null,
    onTestProxy: () -> Unit = {},
    modifier: Modifier = Modifier
) {
    Dialog(
        onDismissRequest = onDismiss,
        properties = DialogProperties(
            usePlatformDefaultWidth = false,
            dismissOnBackPress = true,
            dismissOnClickOutside = false
        )
    ) {
        Column(
            modifier = modifier
                .fillMaxSize()
                .background(iOSBackground)
        ) {
            // å¯¼èˆªæ 
            IOSNavigationBar(
                title = "ç½‘ç»œä»£ç†",
                onCancel = onDismiss,
                onDone = onSave,
                isDoneEnabled = !config.enabled || config.isValid()
            )
            
            // å†…å®¹åŒºåŸŸ
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .verticalScroll(rememberScrollState())
                    .padding(16.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // ä»£ç†è®¾ç½®åˆ†ç»„
                IOSSettingsSection(title = "ä»£ç†è®¾ç½®") {
                    // å¯ç”¨ä»£ç†å¼€å…³
                    IOSSettingsItem(
                        title = "å¯ç”¨ä»£ç†",
                        trailing = {
                            IOSSwitch(
                                checked = config.enabled,
                                onCheckedChange = { enabled ->
                                    onConfigChange(config.copy(enabled = enabled))
                                }
                            )
                        }
                    )
                    
                    if (config.enabled) {
                        // ä»£ç†ç±»å‹é€‰æ‹©
                        IOSSettingsItem(
                            title = "ä»£ç†ç±»å‹",
                            trailing = {
                                ProxyTypePicker(
                                    selectedType = config.type,
                                    onTypeSelected = { type ->
                                        onConfigChange(config.copy(type = type))
                                    }
                                )
                            }
                        )
                        
                        // æœåŠ¡å™¨åœ°å€
                        IOSFormField(
                            label = "æœåŠ¡å™¨",
                            value = config.host,
                            onValueChange = { host ->
                                onConfigChange(config.copy(host = host))
                            },
                            placeholder = "ä¾‹å¦‚: 192.0.2.1"
                        )
                        
                        // ç«¯å£
                        IOSFormField(
                            label = "ç«¯å£",
                            value = if (config.port > 0) config.port.toString() else "",
                            onValueChange = { portStr ->
                                val port = portStr.toIntOrNull() ?: 0
                                onConfigChange(config.copy(port = port))
                            },
                            placeholder = "ä¾‹å¦‚: 7890",
                            keyboardType = KeyboardType.Number
                        )
                    }
                }
                
                // è®¤è¯ä¿¡æ¯åˆ†ç»„ï¼ˆä»…åœ¨å¯ç”¨ä»£ç†æ—¶æ˜¾ç¤ºï¼‰
                if (config.enabled) {
                    IOSSettingsSection(
                        title = "è®¤è¯ä¿¡æ¯",
                        footer = "è®¤è¯ä¿¡æ¯ä¸ºå¯é€‰é¡¹ï¼Œä»…åœ¨ä»£ç†æœåŠ¡å™¨éœ€è¦è®¤è¯æ—¶å¡«å†™"
                    ) {
                        // ç”¨æˆ·å
                        IOSFormField(
                            label = "ç”¨æˆ·å",
                            value = config.username ?: "",
                            onValueChange = { username ->
                                onConfigChange(config.copy(
                                    username = username.ifBlank { null }
                                ))
                            },
                            placeholder = "å¯é€‰"
                        )
                        
                        // å¯†ç 
                        IOSFormField(
                            label = "å¯†ç ",
                            value = config.password ?: "",
                            onValueChange = { password ->
                                onConfigChange(config.copy(
                                    password = password.ifBlank { null }
                                ))
                            },
                            placeholder = "å¯é€‰",
                            isPassword = true
                        )
                    }
                    
                    // æµ‹è¯•è¿æ¥åˆ†ç»„
                    IOSSettingsSection {
                        TestProxyButton(
                            isLoading = isTestingProxy,
                            testResult = proxyTestResult,
                            onClick = onTestProxy,
                            enabled = config.isValid()
                        )
                    }
                }
            }
        }
    }
}

@Composable
private fun ProxyTypePicker(
    selectedType: ProxyType,
    onTypeSelected: (ProxyType) -> Unit
) {
    var expanded by remember { mutableStateOf(false) }
    
    Box {
        TextButton(onClick = { expanded = true }) {
            Text(
                text = selectedType.name,
                color = iOSBlue
            )
            Icon(
                imageVector = Icons.Default.ArrowDropDown,
                contentDescription = null,
                tint = iOSBlue
            )
        }
        
        DropdownMenu(
            expanded = expanded,
            onDismissRequest = { expanded = false }
        ) {
            ProxyType.values().forEach { type ->
                DropdownMenuItem(
                    text = { Text(type.name) },
                    onClick = {
                        onTypeSelected(type)
                        expanded = false
                    },
                    leadingIcon = if (type == selectedType) {
                        { Icon(Icons.Default.Check, contentDescription = null) }
                    } else null
                )
            }
        }
    }
}

@Composable
private fun TestProxyButton(
    isLoading: Boolean,
    testResult: ProxyTestResult?,
    onClick: () -> Unit,
    enabled: Boolean
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .height(44.dp)
            .clickable(enabled = enabled && !isLoading, onClick = onClick)
            .padding(horizontal = 16.dp),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.Center
    ) {
        when {
            isLoading -> {
                CircularProgressIndicator(
                    modifier = Modifier.size(20.dp),
                    color = iOSBlue,
                    strokeWidth = 2.dp
                )
                Spacer(modifier = Modifier.width(8.dp))
                Text(
                    text = "æµ‹è¯•ä¸­...",
                    color = iOSBlue
                )
            }
            testResult is ProxyTestResult.Success -> {
                Icon(
                    imageVector = Icons.Default.CheckCircle,
                    contentDescription = null,
                    tint = iOSGreen
                )
                Spacer(modifier = Modifier.width(8.dp))
                Text(
                    text = "è¿æ¥æˆåŠŸ (${testResult.latencyMs}ms)",
                    color = iOSGreen
                )
            }
            testResult is ProxyTestResult.Failure -> {
                Icon(
                    imageVector = Icons.Default.Error,
                    contentDescription = null,
                    tint = iOSRed
                )
                Spacer(modifier = Modifier.width(8.dp))
                Text(
                    text = testResult.message,
                    color = iOSRed
                )
            }
            else -> {
                Icon(
                    imageVector = Icons.Default.WifiTethering,
                    contentDescription = null,
                    tint = if (enabled) iOSBlue else iOSTextTertiary
                )
                Spacer(modifier = Modifier.width(8.dp))
                Text(
                    text = "æµ‹è¯•ä»£ç†è¿æ¥",
                    color = if (enabled) iOSBlue else iOSTextTertiary
                )
            }
        }
    }
}

/**
 * ä»£ç†æµ‹è¯•ç»“æœ
 */
sealed class ProxyTestResult {
    data class Success(val latencyMs: Long) : ProxyTestResult()
    data class Failure(val message: String) : ProxyTestResult()
}
```

#### 6.2.2 UsageStatsScreen

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/aiconfig/UsageStatsScreen.kt`

```kotlin
package com.empathy.ai.presentation.ui.screen.aiconfig

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import com.empathy.ai.domain.model.ApiUsageStats
import com.empathy.ai.domain.model.ModelUsageStats
import com.empathy.ai.domain.model.ProviderUsageStats
import com.empathy.ai.presentation.theme.*
import com.empathy.ai.presentation.ui.component.ios.*
import com.empathy.ai.presentation.viewmodel.UsageStatsViewModel

/**
 * ç”¨é‡ç»Ÿè®¡é¡µé¢
 *
 * @param onNavigateBack è¿”å›å›è°ƒ
 * @param viewModel ViewModel
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
@Composable
fun UsageStatsScreen(
    onNavigateBack: () -> Unit,
    viewModel: UsageStatsViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(iOSBackground)
    ) {
        // å¤§æ ‡é¢˜å¯¼èˆªæ 
        IOSLargeTitleBar(
            title = "ç”¨é‡ç»Ÿè®¡",
            onBackClick = onNavigateBack,
            onAddClick = null  // å¯¼å‡ºåŠŸèƒ½é€šè¿‡èœå•å®ç°
        )
        
        LazyColumn(
            modifier = Modifier.fillMaxSize(),
            contentPadding = PaddingValues(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // ç”¨é‡æ¦‚è§ˆå¡ç‰‡
            item {
                uiState.stats?.let { stats ->
                    UsageOverviewCard(stats = stats)
                }
            }
            
            // Tabåˆ‡æ¢å™¨
            item {
                IOSTabSwitcher(
                    tabs = listOf("æŒ‰æœåŠ¡å•†", "æŒ‰æ¨¡å‹"),
                    selectedIndex = uiState.selectedTabIndex,
                    onTabSelected = { index ->
                        viewModel.onEvent(UsageStatsUiEvent.SwitchTab(index))
                    }
                )
            }
            
            // ç»Ÿè®¡åˆ—è¡¨
            when (uiState.selectedTabIndex) {
                0 -> {
                    // æŒ‰æœåŠ¡å•†ç»Ÿè®¡
                    items(uiState.stats?.byProvider ?: emptyList()) { providerStats ->
                        ProviderUsageItem(stats = providerStats)
                    }
                }
                1 -> {
                    // æŒ‰æ¨¡å‹ç»Ÿè®¡
                    items(uiState.stats?.byModel ?: emptyList()) { modelStats ->
                        ModelUsageItem(stats = modelStats)
                    }
                }
            }
            
            // æ•°æ®ç®¡ç†åˆ†ç»„
            item {
                IOSSettingsSection(title = "æ•°æ®ç®¡ç†") {
                    // å¯¼å‡ºæ•°æ®
                    IOSSettingsItem(
                        icon = Icons.Default.FileDownload,
                        iconBackgroundColor = iOSBlue,
                        title = "å¯¼å‡ºæ•°æ®",
                        onClick = { viewModel.onEvent(UsageStatsUiEvent.ExportData) }
                    )
                    
                    // æ¸…é™¤å†å²æ•°æ®
                    IOSSettingsItem(
                        icon = Icons.Default.DeleteForever,
                        iconBackgroundColor = iOSRed,
                        title = "æ¸…é™¤å†å²æ•°æ®",
                        onClick = { viewModel.onEvent(UsageStatsUiEvent.ShowClearConfirmDialog) }
                    )
                }
            }
        }
    }
    
    // æ¸…é™¤ç¡®è®¤å¯¹è¯æ¡†
    if (uiState.showClearConfirmDialog) {
        AlertDialog(
            onDismissRequest = { viewModel.onEvent(UsageStatsUiEvent.DismissClearConfirmDialog) },
            title = { Text("æ¸…é™¤å†å²æ•°æ®") },
            text = { Text("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç”¨é‡ç»Ÿè®¡æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚") },
            confirmButton = {
                TextButton(
                    onClick = { viewModel.onEvent(UsageStatsUiEvent.ConfirmClearHistory) }
                ) {
                    Text("æ¸…é™¤", color = iOSRed)
                }
            },
            dismissButton = {
                TextButton(
                    onClick = { viewModel.onEvent(UsageStatsUiEvent.DismissClearConfirmDialog) }
                ) {
                    Text("å–æ¶ˆ")
                }
            }
        )
    }
}

/**
 * ç”¨é‡æ¦‚è§ˆå¡ç‰‡
 */
@Composable
fun UsageOverviewCard(
    stats: ApiUsageStats,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.fillMaxWidth(),
        shape = RoundedCornerShape(12.dp),
        colors = CardDefaults.cardColors(containerColor = iOSCardBackground)
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalArrangement = Arrangement.SpaceEvenly
        ) {
            // è¯·æ±‚æ•°
            StatItem(
                value = stats.totalRequests.toString(),
                label = "æ€»è¯·æ±‚"
            )
            
            // Tokenæ•°
            StatItem(
                value = stats.formatTotalTokens(),
                label = "æ€»Token"
            )
            
            // æˆåŠŸç‡
            StatItem(
                value = stats.formatSuccessRate(),
                label = "æˆåŠŸç‡"
            )
        }
    }
}

@Composable
private fun StatItem(
    value: String,
    label: String
) {
    Column(horizontalAlignment = Alignment.CenterHorizontally) {
        Text(
            text = value,
            style = MaterialTheme.typography.headlineMedium.copy(
                fontSize = 28.sp,
                fontWeight = FontWeight.Bold
            ),
            color = iOSBlue
        )
        Text(
            text = label,
            style = MaterialTheme.typography.bodySmall,
            color = iOSTextSecondary
        )
    }
}

@Composable
private fun ProviderUsageItem(stats: ProviderUsageStats) {
    IOSSettingsItem(
        title = stats.providerName,
        subtitle = "${stats.totalRequests}æ¬¡è¯·æ±‚ Â· ${formatTokens(stats.totalTokens)} Token",
        trailing = {
            Text(
                text = "%.0f%%".format(stats.successRate * 100),
                color = if (stats.successRate >= 0.9f) iOSGreen else iOSOrange
            )
        }
    )
}

@Composable
private fun ModelUsageItem(stats: ModelUsageStats) {
    IOSSettingsItem(
        title = stats.modelName,
        subtitle = "${stats.totalRequests}æ¬¡è¯·æ±‚ Â· å¹³å‡${stats.avgRequestTimeMs}ms",
        trailing = {
            Text(
                text = formatTokens(stats.totalTokens),
                color = iOSTextSecondary
            )
        }
    )
}

private fun formatTokens(tokens: Long): String {
    return when {
        tokens >= 1_000_000 -> "%.1fM".format(tokens / 1_000_000.0)
        tokens >= 1_000 -> "%.1fK".format(tokens / 1_000.0)
        else -> tokens.toString()
    }
}
```


### 6.3 ViewModelå®ç°

#### 6.3.1 AiConfigUiStateæ‰©å±•

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/aiconfig/AiConfigUiState.kt`

```kotlin
// åœ¨ç°æœ‰AiConfigUiStateä¸­æ·»åŠ ä»¥ä¸‹å­—æ®µ

data class AiConfigUiState(
    // ç°æœ‰å­—æ®µ...
    
    // ğŸ†• é«˜çº§é€‰é¡¹
    val formTemperature: Float = 0.7f,
    val formMaxTokens: Int = 4096,
    
    // ğŸ†• ä»£ç†è®¾ç½®
    val proxyConfig: ProxyConfig = ProxyConfig(),
    val showProxyDialog: Boolean = false,
    val isTestingProxy: Boolean = false,
    val proxyTestResult: ProxyTestResult? = null,
    
    // ğŸ†• ç”¨é‡ç»Ÿè®¡å¯¼èˆª
    val shouldNavigateToUsageStats: Boolean = false
)
```

#### 6.3.2 AiConfigUiEventæ‰©å±•

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/aiconfig/AiConfigUiEvent.kt`

```kotlin
// åœ¨ç°æœ‰AiConfigUiEventä¸­æ·»åŠ ä»¥ä¸‹äº‹ä»¶

sealed interface AiConfigUiEvent {
    // ç°æœ‰äº‹ä»¶...
    
    // ğŸ†• é«˜çº§é€‰é¡¹äº‹ä»¶
    data class UpdateFormTemperature(val temperature: Float) : AiConfigUiEvent
    data class UpdateFormMaxTokens(val maxTokens: Int) : AiConfigUiEvent
    
    // ğŸ†• ä»£ç†è®¾ç½®äº‹ä»¶
    data object ShowProxyDialog : AiConfigUiEvent
    data object DismissProxyDialog : AiConfigUiEvent
    data class UpdateProxyConfig(val config: ProxyConfig) : AiConfigUiEvent
    data object SaveProxyConfig : AiConfigUiEvent
    data object TestProxy : AiConfigUiEvent
    data object ClearProxyTestResult : AiConfigUiEvent
    
    // ğŸ†• ç”¨é‡ç»Ÿè®¡äº‹ä»¶
    data object NavigateToUsageStats : AiConfigUiEvent
    data object ClearNavigateToUsageStats : AiConfigUiEvent
}
```

#### 6.3.3 UsageStatsViewModel

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/UsageStatsViewModel.kt`

```kotlin
package com.empathy.ai.presentation.viewmodel

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.empathy.ai.domain.model.ApiUsageStats
import com.empathy.ai.domain.usecase.CleanupApiUsageUseCase
import com.empathy.ai.domain.usecase.ExportApiUsageUseCase
import com.empathy.ai.domain.usecase.GetApiUsageStatsUseCase
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import javax.inject.Inject

/**
 * ç”¨é‡ç»Ÿè®¡ViewModel
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
@HiltViewModel
class UsageStatsViewModel @Inject constructor(
    private val getApiUsageStatsUseCase: GetApiUsageStatsUseCase,
    private val cleanupApiUsageUseCase: CleanupApiUsageUseCase,
    private val exportApiUsageUseCase: ExportApiUsageUseCase
) : ViewModel() {
    
    private val _uiState = MutableStateFlow(UsageStatsUiState())
    val uiState: StateFlow<UsageStatsUiState> = _uiState.asStateFlow()
    
    init {
        loadStats()
    }
    
    fun onEvent(event: UsageStatsUiEvent) {
        when (event) {
            is UsageStatsUiEvent.SwitchTab -> switchTab(event.tabIndex)
            is UsageStatsUiEvent.Refresh -> loadStats()
            is UsageStatsUiEvent.ShowClearConfirmDialog -> showClearConfirmDialog()
            is UsageStatsUiEvent.DismissClearConfirmDialog -> dismissClearConfirmDialog()
            is UsageStatsUiEvent.ConfirmClearHistory -> clearHistory()
            is UsageStatsUiEvent.ExportData -> exportData()
            is UsageStatsUiEvent.ClearError -> clearError()
        }
    }
    
    private fun loadStats() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            
            getApiUsageStatsUseCase()
                .onSuccess { stats ->
                    _uiState.update { it.copy(
                        stats = stats,
                        isLoading = false,
                        error = null
                    ) }
                }
                .onFailure { e ->
                    _uiState.update { it.copy(
                        isLoading = false,
                        error = e.message ?: "åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥"
                    ) }
                }
        }
    }
    
    private fun switchTab(tabIndex: Int) {
        _uiState.update { it.copy(selectedTabIndex = tabIndex) }
    }
    
    private fun showClearConfirmDialog() {
        _uiState.update { it.copy(showClearConfirmDialog = true) }
    }
    
    private fun dismissClearConfirmDialog() {
        _uiState.update { it.copy(showClearConfirmDialog = false) }
    }
    
    private fun clearHistory() {
        viewModelScope.launch {
            _uiState.update { it.copy(
                showClearConfirmDialog = false,
                isLoading = true
            ) }
            
            cleanupApiUsageUseCase.clearAll()
                .onSuccess { deletedCount ->
                    loadStats()  // é‡æ–°åŠ è½½ç»Ÿè®¡
                }
                .onFailure { e ->
                    _uiState.update { it.copy(
                        isLoading = false,
                        error = e.message ?: "æ¸…é™¤æ•°æ®å¤±è´¥"
                    ) }
                }
        }
    }
    
    private fun exportData() {
        viewModelScope.launch {
            _uiState.update { it.copy(isExporting = true) }
            
            exportApiUsageUseCase.exportAll()
                .onSuccess { json ->
                    _uiState.update { it.copy(
                        isExporting = false,
                        exportedData = json
                    ) }
                }
                .onFailure { e ->
                    _uiState.update { it.copy(
                        isExporting = false,
                        error = e.message ?: "å¯¼å‡ºæ•°æ®å¤±è´¥"
                    ) }
                }
        }
    }
    
    private fun clearError() {
        _uiState.update { it.copy(error = null) }
    }
}

/**
 * ç”¨é‡ç»Ÿè®¡UIçŠ¶æ€
 */
data class UsageStatsUiState(
    val isLoading: Boolean = false,
    val error: String? = null,
    val stats: ApiUsageStats? = null,
    val selectedTabIndex: Int = 0,
    val showClearConfirmDialog: Boolean = false,
    val isExporting: Boolean = false,
    val exportedData: String? = null
)

/**
 * ç”¨é‡ç»Ÿè®¡UIäº‹ä»¶
 */
sealed interface UsageStatsUiEvent {
    data class SwitchTab(val tabIndex: Int) : UsageStatsUiEvent
    data object Refresh : UsageStatsUiEvent
    data object ShowClearConfirmDialog : UsageStatsUiEvent
    data object DismissClearConfirmDialog : UsageStatsUiEvent
    data object ConfirmClearHistory : UsageStatsUiEvent
    data object ExportData : UsageStatsUiEvent
    data object ClearError : UsageStatsUiEvent
}
```

---

## 7. ä¾èµ–æ³¨å…¥é…ç½®

### 7.1 ApiUsageModule

**æ–‡ä»¶ä½ç½®**: `app/src/main/kotlin/com/empathy/ai/di/ApiUsageModule.kt`

```kotlin
package com.empathy.ai.di

import com.empathy.ai.data.local.dao.ApiUsageDao
import com.empathy.ai.data.repository.ApiUsageRepositoryImpl
import com.empathy.ai.domain.repository.ApiUsageRepository
import com.squareup.moshi.Moshi
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

/**
 * APIç”¨é‡ç»Ÿè®¡DIæ¨¡å—
 *
 * @see FD-00025 AIé…ç½®åŠŸèƒ½å®Œå–„åŠŸèƒ½è®¾è®¡
 */
@Module
@InstallIn(SingletonComponent::class)
object ApiUsageModule {
    
    @Provides
    @Singleton
    fun provideApiUsageRepository(
        dao: ApiUsageDao,
        moshi: Moshi
    ): ApiUsageRepository {
        return ApiUsageRepositoryImpl(dao, moshi)
    }
}
```

### 7.2 DatabaseModuleæ‰©å±•

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/di/DatabaseModule.kt`

```kotlin
// åœ¨ç°æœ‰DatabaseModuleä¸­æ·»åŠ 

@Provides
@Singleton
fun provideApiUsageDao(database: AppDatabase): ApiUsageDao {
    return database.apiUsageDao()
}
```

---

## 8. å¯¼èˆªé…ç½®

### 8.1 NavRoutesæ‰©å±•

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NavRoutes.kt`

```kotlin
object NavRoutes {
    // ç°æœ‰è·¯ç”±...
    
    // ğŸ†• æ–°å¢
    const val USAGE_STATS = "usage_stats"
}
```

### 8.2 NavGraphæ‰©å±•

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/NavGraph.kt`

```kotlin
// åœ¨NavGraphä¸­æ·»åŠ 

composable(NavRoutes.USAGE_STATS) {
    UsageStatsScreen(
        onNavigateBack = { navController.popBackStack() }
    )
}
```

---

## 9. æµ‹è¯•è®¾è®¡

### 9.1 å•å…ƒæµ‹è¯•

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•å†…å®¹ | ä¼˜å…ˆçº§ |
|----------|----------|--------|
| `ApiUsageRecordTest.kt` | æ¨¡å‹åˆ›å»ºã€å­—æ®µéªŒè¯ | P0 |
| `ApiUsageStatsTest.kt` | ç»Ÿè®¡è®¡ç®—ã€æ ¼å¼åŒ–æ–¹æ³• | P0 |
| `ProxyConfigTest.kt` | é…ç½®éªŒè¯ã€ç±»å‹è½¬æ¢ | P0 |
| `ApiUsageDaoTest.kt` | CRUDæ“ä½œã€ç»Ÿè®¡æŸ¥è¯¢ | P0 |
| `ApiUsageRepositoryImplTest.kt` | ä»“åº“å®ç°ã€æ•°æ®è½¬æ¢ | P0 |
| `RecordApiUsageUseCaseTest.kt` | è®°å½•åˆ›å»ºã€é”™è¯¯å¤„ç† | P0 |
| `GetApiUsageStatsUseCaseTest.kt` | ç»Ÿè®¡è®¡ç®—ã€æ—¶é—´èŒƒå›´ | P0 |
| `CleanupApiUsageUseCaseTest.kt` | æ¸…ç†é€»è¾‘ã€ä¿ç•™å¤©æ•° | P1 |
| `UsageStatsViewModelTest.kt` | çŠ¶æ€ç®¡ç†ã€äº‹ä»¶å¤„ç† | P0 |

### 9.2 UIæµ‹è¯•

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•åœºæ™¯ | ä¼˜å…ˆçº§ |
|----------|----------|--------|
| `TemperatureSliderTest.kt` | æ»‘åŠ¨ã€è¾¹ç•Œå€¼ã€æ˜¾ç¤º | P1 |
| `TokenLimitInputTest.kt` | è¾“å…¥ã€å¿«æ·é€‰é¡¹ã€éªŒè¯ | P1 |
| `DraggableModelListTest.kt` | æ‹–æ‹½ã€æ’åºã€åŠ¨ç”» | P1 |
| `ProxySettingsDialogTest.kt` | è¡¨å•å¡«å†™ã€éªŒè¯ã€æµ‹è¯• | P1 |
| `UsageStatsScreenTest.kt` | æ•°æ®æ˜¾ç¤ºã€Tabåˆ‡æ¢ã€æ¸…é™¤ | P1 |

### 9.3 æ•°æ®åº“è¿ç§»æµ‹è¯•

**æ–‡ä»¶ä½ç½®**: `data/src/androidTest/kotlin/com/empathy/ai/data/local/migration/Migration_11_12_Test.kt`

```kotlin
@RunWith(AndroidJUnit4::class)
class Migration_11_12_Test {
    
    @get:Rule
    val helper = MigrationTestHelper(
        InstrumentationRegistry.getInstrumentation(),
        AppDatabase::class.java
    )
    
    @Test
    fun migrate11To12() {
        // åˆ›å»ºv11æ•°æ®åº“
        helper.createDatabase(TEST_DB, 11).apply {
            // æ’å…¥æµ‹è¯•æ•°æ®
            execSQL("""
                INSERT INTO ai_providers (id, name, base_url, api_key_ref, models_json, 
                    default_model_id, is_default, timeout_ms, created_at)
                VALUES ('test-id', 'Test Provider', 'https://api.test.com', 'key-ref', 
                    '[]', 'model-1', 1, 30000, ${System.currentTimeMillis()})
            """)
            close()
        }
        
        // æ‰§è¡Œè¿ç§»
        val db = helper.runMigrationsAndValidate(TEST_DB, 12, true, MIGRATION_11_12)
        
        // éªŒè¯æ–°å­—æ®µå­˜åœ¨ä¸”æœ‰é»˜è®¤å€¼
        db.query("SELECT temperature, max_tokens FROM ai_providers WHERE id = 'test-id'").use { cursor ->
            assertTrue(cursor.moveToFirst())
            assertEquals(0.7f, cursor.getFloat(0), 0.01f)
            assertEquals(4096, cursor.getInt(1))
        }
        
        // éªŒè¯æ–°è¡¨å­˜åœ¨
        db.query("SELECT * FROM api_usage_records").use { cursor ->
            assertNotNull(cursor)
        }
    }
    
    companion object {
        private const val TEST_DB = "migration-test"
    }
}
```


---

## 10. æ€§èƒ½ä¼˜åŒ–

### 10.1 æ•°æ®åº“ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | å®ç°æ–¹å¼ | é¢„æœŸæ•ˆæœ |
|--------|----------|----------|
| ç´¢å¼•ä¼˜åŒ– | ä¸ºprovider_idã€model_idã€created_atæ·»åŠ ç´¢å¼• | æŸ¥è¯¢æ€§èƒ½æå‡50%+ |
| åˆ†é¡µæŸ¥è¯¢ | ä½¿ç”¨LIMITé™åˆ¶è¿”å›æ•°é‡ | å‡å°‘å†…å­˜å ç”¨ |
| æ‰¹é‡æ’å…¥ | ä½¿ç”¨insertAllæ‰¹é‡æ’å…¥ | å‡å°‘æ•°æ®åº“äº‹åŠ¡å¼€é”€ |
| è‡ªåŠ¨æ¸…ç† | é™åˆ¶æœ€å¤§è®°å½•æ•°10000æ¡ | æ§åˆ¶æ•°æ®åº“å¤§å° |

### 10.2 UIä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | å®ç°æ–¹å¼ | é¢„æœŸæ•ˆæœ |
|--------|----------|----------|
| åˆ—è¡¨å¤ç”¨ | LazyColumn + key | å‡å°‘é‡ç»„æ¬¡æ•° |
| åŠ¨ç”»ä¼˜åŒ– | graphicsLayer + GPUåŠ é€Ÿ | æ‹–æ‹½æµç•…åº¦æå‡ |
| çŠ¶æ€æ´¾ç”Ÿ | derivedStateOf | é¿å…ä¸å¿…è¦çš„é‡ç»„ |
| é˜²æŠ–å¤„ç† | debounceæœç´¢è¾“å…¥ | å‡å°‘æŸ¥è¯¢æ¬¡æ•° |

### 10.3 ç½‘ç»œä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | å®ç°æ–¹å¼ | é¢„æœŸæ•ˆæœ |
|--------|----------|----------|
| ä»£ç†å¤ç”¨ | OkHttpClientå•ä¾‹ | å‡å°‘è¿æ¥å»ºç«‹å¼€é”€ |
| è¿æ¥æ±  | OkHttpé»˜è®¤è¿æ¥æ±  | å¤ç”¨TCPè¿æ¥ |
| è¶…æ—¶é…ç½® | åˆç†çš„è¶…æ—¶æ—¶é—´ | é¿å…é•¿æ—¶é—´ç­‰å¾… |

---

## 11. æ–‡ä»¶æ¸…å•

### 11.1 æ–°å»ºæ–‡ä»¶

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|----------|------|
| :domain | `model/ApiUsageRecord.kt` | ç”¨é‡è®°å½•æ¨¡å‹ |
| :domain | `model/ApiUsageStats.kt` | ç”¨é‡ç»Ÿè®¡æ¨¡å‹ |
| :domain | `model/ProxyConfig.kt` | ä»£ç†é…ç½®æ¨¡å‹ |
| :domain | `repository/ApiUsageRepository.kt` | ç”¨é‡ä»“åº“æ¥å£ |
| :domain | `usecase/RecordApiUsageUseCase.kt` | è®°å½•ç”¨é‡ç”¨ä¾‹ |
| :domain | `usecase/GetApiUsageStatsUseCase.kt` | è·å–ç»Ÿè®¡ç”¨ä¾‹ |
| :domain | `usecase/CleanupApiUsageUseCase.kt` | æ¸…ç†ç”¨é‡ç”¨ä¾‹ |
| :domain | `usecase/ExportApiUsageUseCase.kt` | å¯¼å‡ºç”¨é‡ç”¨ä¾‹ |
| :domain | `usecase/TestProxyConnectionUseCase.kt` | æµ‹è¯•ä»£ç†ç”¨ä¾‹ |
| :data | `local/entity/ApiUsageEntity.kt` | ç”¨é‡æ•°æ®åº“å®ä½“ |
| :data | `local/dao/ApiUsageDao.kt` | ç”¨é‡DAO |
| :data | `local/ProxyPreferences.kt` | ä»£ç†é…ç½®å­˜å‚¨ |
| :data | `local/migration/Migration_11_12.kt` | æ•°æ®åº“è¿ç§» |
| :data | `repository/ApiUsageRepositoryImpl.kt` | ç”¨é‡ä»“åº“å®ç° |
| :presentation | `ui/component/ios/TemperatureSlider.kt` | Temperatureæ»‘å— |
| :presentation | `ui/component/ios/TokenLimitInput.kt` | Tokené™åˆ¶è¾“å…¥ |
| :presentation | `ui/component/ios/DraggableModelList.kt` | å¯æ‹–æ‹½æ¨¡å‹åˆ—è¡¨ |
| :presentation | `ui/screen/aiconfig/ProxySettingsDialog.kt` | ä»£ç†è®¾ç½®å¯¹è¯æ¡† |
| :presentation | `ui/screen/aiconfig/UsageStatsScreen.kt` | ç”¨é‡ç»Ÿè®¡é¡µé¢ |
| :presentation | `viewmodel/UsageStatsViewModel.kt` | ç”¨é‡ç»Ÿè®¡ViewModel |
| :app | `di/ApiUsageModule.kt` | ç”¨é‡ç»Ÿè®¡DIæ¨¡å— |

### 11.2 ä¿®æ”¹æ–‡ä»¶

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|------|----------|----------|
| :domain | `model/AiProvider.kt` | æ·»åŠ temperatureã€maxTokenså­—æ®µ |
| :domain | `repository/AiProviderRepository.kt` | æ·»åŠ ä»£ç†é…ç½®æ–¹æ³• |
| :data | `local/entity/AiProviderEntity.kt` | æ·»åŠ temperatureã€max_tokenså­—æ®µ |
| :data | `local/AppDatabase.kt` | æ·»åŠ ApiUsageEntityã€ç‰ˆæœ¬å‡çº§åˆ°12 |
| :data | `di/DatabaseModule.kt` | æ·»åŠ ApiUsageDaoæä¾› |
| :data | `di/NetworkModule.kt` | æ·»åŠ ä»£ç†é…ç½®æ”¯æŒ |
| :data | `repository/AiRepositoryImpl.kt` | é›†æˆç”¨é‡è®°å½• |
| :data | `repository/AiProviderRepositoryImpl.kt` | æ·»åŠ ä»£ç†æµ‹è¯•å®ç° |
| :presentation | `ui/screen/aiconfig/AiConfigUiState.kt` | æ·»åŠ é«˜çº§é€‰é¡¹å’Œä»£ç†çŠ¶æ€ |
| :presentation | `ui/screen/aiconfig/AiConfigUiEvent.kt` | æ·»åŠ é«˜çº§é€‰é¡¹å’Œä»£ç†äº‹ä»¶ |
| :presentation | `navigation/NavRoutes.kt` | æ·»åŠ USAGE_STATSè·¯ç”± |
| :presentation | `navigation/NavGraph.kt` | æ·»åŠ ç”¨é‡ç»Ÿè®¡é¡µé¢è·¯ç”± |

---

## 12. é£é™©ä¸ç¼“è§£

### 12.1 æŠ€æœ¯é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| æ•°æ®åº“è¿ç§»å¤±è´¥ | ä½ | é«˜ | å®Œæ•´çš„è¿ç§»æµ‹è¯•ï¼Œå¤‡ä»½æœºåˆ¶ |
| ä»£ç†é…ç½®å¯¼è‡´ç½‘ç»œä¸å¯ç”¨ | ä¸­ | é«˜ | ä»£ç†æµ‹è¯•åŠŸèƒ½ï¼Œé…ç½®é”™è¯¯æ—¶è‡ªåŠ¨ç¦ç”¨ |
| æ‹–æ‹½æ’åºæ€§èƒ½é—®é¢˜ | ä¸­ | ä¸­ | ä½¿ç”¨LazyColumnä¼˜åŒ–ï¼Œé™åˆ¶åŠ¨ç”»å¤æ‚åº¦ |
| ç”¨é‡æ•°æ®è¿‡å¤§ | ä½ | ä¸­ | è‡ªåŠ¨æ¸…ç†ç­–ç•¥ï¼Œé™åˆ¶æœ€å¤§è®°å½•æ•° |

### 12.2 ç¼“è§£ç­–ç•¥

1. **æ•°æ®åº“è¿ç§»**
   - ç¼–å†™å®Œæ•´çš„è¿ç§»æµ‹è¯•
   - ä½¿ç”¨try-catchåŒ…è£…è¿ç§»é€»è¾‘
   - è¿ç§»å¤±è´¥æ—¶è®°å½•æ—¥å¿—å¹¶æç¤ºç”¨æˆ·

2. **ä»£ç†é…ç½®**
   - æä¾›æµ‹è¯•åŠŸèƒ½éªŒè¯é…ç½®
   - é…ç½®é”™è¯¯æ—¶æ˜¾ç¤ºæ˜ç¡®é”™è¯¯ä¿¡æ¯
   - æ”¯æŒä¸€é”®ç¦ç”¨ä»£ç†

3. **æ€§èƒ½ä¼˜åŒ–**
   - ä½¿ç”¨Composeæœ€ä½³å®è·µ
   - ç›‘æ§å…³é”®æ“ä½œè€—æ—¶
   - ä½ç«¯è®¾å¤‡æµ‹è¯•éªŒè¯

---

## 13. å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | å˜æ›´äºº |
|------|------|----------|--------|
| v1.0 | 2026-01-01 | åˆå§‹ç‰ˆæœ¬ | Kiro |
| v1.1 | 2026-01-01 | æ ¹æ®DR-00025å®¡æŸ¥æŠ¥å‘Šä¿®æ”¹ï¼š<br>1. æ·»åŠ ç¬¬0èŠ‚"æ–‡æ¡£èƒŒæ™¯"<br>2. æ·»åŠ 1.4èŠ‚"æ€§èƒ½åŸºå‡†"<br>3. åœ¨æŠ€æœ¯åŸåˆ™ä¸­æ·»åŠ "å›½é™…åŒ–æ”¯æŒ"<br>4. æ·»åŠ 5.3èŠ‚"é”™è¯¯å¤„ç†åœºæ™¯è¯´æ˜"<br>5. æ·»åŠ 5.4èŠ‚"OpenAiApiæ¥å£è¯¦ç»†è¯´æ˜"<br>6. å¢å¼ºAiProviderè¾¹ç•Œæ¡ä»¶å¤„ç† | Kiro |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.1
**æœ€åæ›´æ–°**: 2026-01-01
**æ–‡æ¡£çŠ¶æ€**: âœ… å®¡æŸ¥é€šè¿‡
