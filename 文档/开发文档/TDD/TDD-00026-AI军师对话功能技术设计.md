# TDD-00026: AIå†›å¸ˆå¯¹è¯åŠŸèƒ½æŠ€æœ¯è®¾è®¡

## 1. æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç±»å‹ | TDD (Technical Design Document) |
| æ–‡æ¡£ç¼–å· | TDD-00026 |
| åŠŸèƒ½åç§° | AIå†›å¸ˆå¯¹è¯åŠŸèƒ½æŠ€æœ¯è®¾è®¡ |
| ç‰ˆæœ¬ | 1.1 |
| åˆ›å»ºæ—¥æœŸ | 2026-01-01 |
| æœ€åæ›´æ–° | 2026-01-01 |
| ä½œè€… | Kiro |
| å®¡æ ¸äºº | Roo |
| å®¡æ ¸çŠ¶æ€ | âœ… å·²å®¡æ ¸é€šè¿‡ |
| å…³è”æ–‡æ¡£ | PRD-00026, FD-00026, DR-00026 |

### 1.1 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 1.0 | 2026-01-01 | Kiro | åˆå§‹ç‰ˆæœ¬ |
| 1.1 | 2026-01-01 | Kiro | æ ¹æ®DR-00026å®¡æŸ¥æŠ¥å‘Šä¿®æ”¹ï¼šæ–°å¢èµ„æºä¸æƒé™é…ç½®ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€å®‰å…¨ä¸éšç§ã€å›½é™…åŒ–æ”¯æŒç« èŠ‚ |

### 1.2 å‚è€ƒæ ‡å‡†

| æ ‡å‡†æ–‡æ¡£ | ç‰ˆæœ¬ | è¯´æ˜ |
|---------|------|------|
| Clean Architecture | - | æ¶æ„æ¨¡å¼æ ‡å‡† |
| MVVM Pattern | - | UIæ¶æ„æ¨¡å¼ |
| Kotlin Coding Conventions | 2.0.21 | ä»£ç è§„èŒƒ |
| Material Design 3 | 1.3.1 | UIè®¾è®¡è§„èŒƒ |
| Room Database | 2.6.1 | æ•°æ®åº“è§„èŒƒ |

### 1.3 æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

| å€ºåŠ¡ID | æè¿° | å½±å“ | ä¼˜å…ˆçº§ | è®¡åˆ’è§£å†³æ—¶é—´ |
|--------|------|------|--------|-------------|
| TD-026-01 | å†å²å¯¹è¯è®°å½•é™åˆ¶ä¸º20æ¡ | ä¸­ | ğŸŸ¡ ä¸­ | v1.1å¼•å…¥RAG |
| TD-026-02 | ä¼šè¯ä¸Šä¸‹æ–‡é™åˆ¶ä¸º10æ¡ | ä½ | ğŸŸ¢ ä½ | v1.1ä¼˜åŒ– |
| TD-026-03 | ç¼ºå°‘ç¦»çº¿æ”¯æŒ | ä½ | ğŸŸ¢ ä½ | v2.0 |

---

## 2. æ¶æ„æ¦‚è¿°

### 2.1 æ¶æ„ç›®æ ‡

AIå†›å¸ˆå¯¹è¯åŠŸèƒ½é‡‡ç”¨ Clean Architecture åˆ†å±‚æ¶æ„ï¼Œå®ç°ç‹¬ç«‹çš„æ·±åº¦åˆ†æå¯¹è¯ç³»ç»Ÿã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
- æ„å»ºç‹¬ç«‹çš„AIå†›å¸ˆå¯¹è¯ç•Œé¢ï¼ŒåŒºåˆ«äºæ‚¬æµ®çª—çš„å³æ—¶ååº”å¼åŠŸèƒ½
- å®ç°åŸºäºå®Œæ•´å¯¹è¯å†å²çš„æ·±åº¦åˆ†æèƒ½åŠ›
- æ”¯æŒå¤šä¼šè¯ç®¡ç†ï¼Œæ¯ä¸ªè”ç³»äººå¯æœ‰å¤šä¸ªç‹¬ç«‹ä¼šè¯
- é›†æˆè”ç³»äººç”»åƒä¿¡æ¯ï¼Œæä¾›ä¸ªæ€§åŒ–åˆ†æå»ºè®®

### 2.2 æŠ€æœ¯æ ˆ

| æŠ€æœ¯é¢†åŸŸ | æŠ€æœ¯é€‰æ‹© | ç‰ˆæœ¬ | ç”¨é€” |
|---------|----------|------|------|
| UIæ¡†æ¶ | Jetpack Compose | BOM 2024.12.01 | å£°æ˜å¼UI |
| ç»„ä»¶åº“ | Material 3 | 1.3.1 | UIç»„ä»¶ |
| æ•°æ®åº“ | Room | 2.6.1 | æœ¬åœ°å­˜å‚¨ |
| å¼‚æ­¥å¤„ç† | Kotlin Coroutines | 1.9.0 | å¼‚æ­¥AIè°ƒç”¨ |
| ä¾èµ–æ³¨å…¥ | Hilt | 2.52 | ä¾èµ–ç®¡ç† |
| JSONè§£æ | Moshi | 1.15.1 | AIå“åº”è§£æ |
| å¯¼èˆª | Navigation Compose | 2.8.5 | é¡µé¢å¯¼èˆª |

### 2.3 è®¾è®¡åŸåˆ™

- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªUseCaseåªè´Ÿè´£ä¸€ç§åŠŸèƒ½
- **å¼€é—­åŸåˆ™**ï¼šé€šè¿‡æ‰©å±•æ”¯æŒæ–°åŠŸèƒ½ï¼Œä¸ä¿®æ”¹ç°æœ‰ä»£ç 
- **ä¾èµ–å€’ç½®**ï¼šUseCaseä¾èµ–Repositoryæ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
- **çŠ¶æ€ä¸å¯å˜**ï¼šUiStateä½¿ç”¨data classï¼Œé€šè¿‡copyæ›´æ–°çŠ¶æ€
- **å“åº”å¼æ•°æ®æµ**ï¼šä½¿ç”¨Flowå®ç°æ•°æ®çš„å“åº”å¼æ›´æ–°

---

## 3. æ•´ä½“æ¶æ„è®¾è®¡

### 3.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   :presentation æ¨¡å—                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚AiAdvisorScreen â”‚ â”‚AiAdvisorChatScreen         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  (ä¸»ç•Œé¢)      â”‚ â”‚  (å¯¹è¯ç•Œé¢)                â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚AiAdvisorViewModelâ”‚ â”‚AiAdvisorChatViewModel    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚AdvisorMessage  â”‚ â”‚SessionSelector             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Bubble        â”‚ â”‚ContactSelectorDialog       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    :domain æ¨¡å—                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚AiAdvisor     â”‚ â”‚AiAdvisor     â”‚ â”‚MessageType   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Session     â”‚ â”‚  Conversationâ”‚ â”‚  (æšä¸¾)      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚CreateAdvisor â”‚ â”‚SendAdvisor   â”‚ â”‚GetAdvisor    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚SessionUseCaseâ”‚ â”‚MessageUseCaseâ”‚ â”‚SessionsUseCaseâ”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚
â”‚  â”‚  â”‚AiAdvisor     â”‚ â”‚SystemPrompts â”‚                   â”‚  â”‚
â”‚  â”‚  â”‚  Repository  â”‚ â”‚  (æ‰©å±•)      â”‚                   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Data Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     :data æ¨¡å—                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚AiAdvisorDao  â”‚ â”‚AiAdvisor     â”‚ â”‚AiAdvisor     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚              â”‚ â”‚SessionEntity â”‚ â”‚Conversation  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚              â”‚ â”‚              â”‚ â”‚  Entity      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚
â”‚  â”‚  â”‚AiAdvisorRepositoryImpl                           â”‚â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        App Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      :app æ¨¡å—                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚
â”‚  â”‚  â”‚AiAdvisorModule (DIæ¨¡å—)                          â”‚â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·æ“ä½œæµç¨‹                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ AiAdvisorChatâ”‚ â† å¯¹è¯ç•Œé¢
  â”‚   ViewModel  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ SendAdvisor  â”‚ â† å‘é€æ¶ˆæ¯ç”¨ä¾‹
  â”‚ MessageUseCaseâ”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ä¿å­˜ç”¨æˆ·â”‚ â”‚è·å–è”ç³»â”‚
â”‚æ¶ˆæ¯    â”‚ â”‚äººç”»åƒ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚è·å–å¯¹è¯å†å²  â”‚ â† conversation_logsè¡¨
  â”‚(æœ€è¿‘20æ¡)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚æ„å»ºAIå†›å¸ˆ    â”‚ â† SystemPrompts.AI_ADVISOR
  â”‚ç³»ç»Ÿæç¤ºè¯    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ AiRepository â”‚ â† è°ƒç”¨AIæ¥å£
  â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ä¿å­˜AIå›å¤    â”‚ â† ai_advisor_conversationsè¡¨
  â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ UIæ›´æ–°æ˜¾ç¤º   â”‚ â† Flowå“åº”å¼æ›´æ–°
  â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ¨¡å—åˆ’åˆ†

```
:domain/src/main/kotlin/com/empathy/ai/domain/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ AiAdvisorSession.kt           # ä¼šè¯æ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ AiAdvisorConversation.kt      # å¯¹è¯è®°å½•æ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ MessageType.kt                # æ¶ˆæ¯ç±»å‹æšä¸¾ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ AiAdvisorRepository.kt        # ä»“åº“æ¥å£ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ usecase/
â”‚   â”œâ”€â”€ CreateAdvisorSessionUseCase.kt    # åˆ›å»ºä¼šè¯ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ SendAdvisorMessageUseCase.kt      # å‘é€æ¶ˆæ¯ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ GetAdvisorSessionsUseCase.kt      # è·å–ä¼šè¯åˆ—è¡¨ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ GetAdvisorConversationsUseCase.kt # è·å–å¯¹è¯è®°å½•ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ DeleteAdvisorConversationUseCase.kt # åˆ é™¤å¯¹è¯ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ util/
    â””â”€â”€ SystemPrompts.kt              # ç³»ç»Ÿæç¤ºè¯ï¼ˆæ‰©å±•ï¼‰

:data/src/main/kotlin/com/empathy/ai/data/
â”œâ”€â”€ local/
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ AiAdvisorSessionEntity.kt     # ä¼šè¯å®ä½“ï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â””â”€â”€ AiAdvisorConversationEntity.kt # å¯¹è¯å®ä½“ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ dao/
â”‚   â”‚   â””â”€â”€ AiAdvisorDao.kt               # DAOï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ AppDatabase.kt                    # æ•°æ®åº“ï¼ˆä¿®æ”¹ï¼Œv12â†’v13ï¼‰
â””â”€â”€ repository/
    â””â”€â”€ AiAdvisorRepositoryImpl.kt        # ä»“åº“å®ç°ï¼ˆæ–°å¢ï¼‰

:presentation/src/main/kotlin/com/empathy/ai/presentation/
â”œâ”€â”€ ui/screen/advisor/
â”‚   â”œâ”€â”€ AiAdvisorScreen.kt                # ä¸»ç•Œé¢ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ AiAdvisorChatScreen.kt            # å¯¹è¯ç•Œé¢ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ component/
â”‚       â”œâ”€â”€ AdvisorMessageBubble.kt       # æ¶ˆæ¯æ°”æ³¡ï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ SessionSelector.kt            # ä¼šè¯é€‰æ‹©å™¨ï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ ContactSelectorDialog.kt      # è”ç³»äººé€‰æ‹©ï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ AiAdvisorInputBar.kt          # è¾“å…¥æ ï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ ErrorStateView.kt             # é”™è¯¯çŠ¶æ€ï¼ˆæ–°å¢ï¼‰
â”‚       â””â”€â”€ FailedMessageBubble.kt        # å¤±è´¥æ¶ˆæ¯ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ viewmodel/
â”‚   â”œâ”€â”€ AiAdvisorViewModel.kt             # ä¸»ç•Œé¢VMï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ AiAdvisorChatViewModel.kt         # å¯¹è¯ç•Œé¢VMï¼ˆæ–°å¢ï¼‰
â””â”€â”€ navigation/
    â”œâ”€â”€ NavGraph.kt                       # å¯¼èˆªå›¾ï¼ˆä¿®æ”¹ï¼‰
    â””â”€â”€ NavRoutes.kt                      # è·¯ç”±ï¼ˆä¿®æ”¹ï¼‰

:app/src/main/java/com/empathy/ai/
â””â”€â”€ di/
    â””â”€â”€ AiAdvisorModule.kt                # DIæ¨¡å—ï¼ˆæ–°å¢ï¼‰
```

---

## 4. è¯¦ç»†æŠ€æœ¯è®¾è®¡

### 4.1 æ•°æ®æ¨¡å‹è®¾è®¡

#### 4.1.1 AiAdvisorSessionï¼ˆä¼šè¯æ¨¡å‹ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`:domain/model/AiAdvisorSession.kt`

```kotlin
/**
 * AIå†›å¸ˆä¼šè¯
 *
 * æ¯ä¸ªè”ç³»äººå¯ä»¥æœ‰å¤šä¸ªä¼šè¯ï¼Œæ¯ä¸ªä¼šè¯åŒ…å«å¤šæ¡å¯¹è¯è®°å½•
 */
data class AiAdvisorSession(
    /** ä¼šè¯IDï¼ˆUUIDï¼‰ */
    val id: String,
    
    /** è”ç³»äººID */
    val contactId: String,
    
    /** ä¼šè¯æ ‡é¢˜ */
    val title: String,
    
    /** åˆ›å»ºæ—¶é—´ */
    val createdAt: Long,
    
    /** æœ€åæ›´æ–°æ—¶é—´ */
    val updatedAt: Long,
    
    /** æ¶ˆæ¯æ•°é‡ */
    val messageCount: Int = 0,
    
    /** æ˜¯å¦ä¸ºæ´»è·ƒä¼šè¯ */
    val isActive: Boolean = true
) {
    companion object {
        /**
         * åˆ›å»ºæ–°ä¼šè¯
         */
        fun create(contactId: String, title: String = "æ–°å¯¹è¯"): AiAdvisorSession {
            val now = System.currentTimeMillis()
            return AiAdvisorSession(
                id = java.util.UUID.randomUUID().toString(),
                contactId = contactId,
                title = title,
                createdAt = now,
                updatedAt = now
            )
        }
    }
}
```

#### 4.1.2 AiAdvisorConversationï¼ˆå¯¹è¯è®°å½•æ¨¡å‹ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`:domain/model/AiAdvisorConversation.kt`

```kotlin
/**
 * AIå†›å¸ˆå¯¹è¯è®°å½•
 *
 * å­˜å‚¨ç”¨æˆ·ä¸AIå†›å¸ˆçš„å¯¹è¯å†…å®¹
 */
data class AiAdvisorConversation(
    /** å¯¹è¯IDï¼ˆUUIDï¼‰ */
    val id: String,
    
    /** è”ç³»äººID */
    val contactId: String,
    
    /** ä¼šè¯ID */
    val sessionId: String,
    
    /** æ¶ˆæ¯ç±»å‹ï¼šUSERæˆ–AI */
    val messageType: MessageType,
    
    /** æ¶ˆæ¯å†…å®¹ */
    val content: String,
    
    /** æ—¶é—´æˆ³ */
    val timestamp: Long,
    
    /** åˆ›å»ºæ—¶é—´ */
    val createdAt: Long = System.currentTimeMillis(),
    
    /** å‘é€çŠ¶æ€ï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰ */
    val sendStatus: SendStatus = SendStatus.SUCCESS
) {
    companion object {
        /**
         * åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
         */
        fun createUserMessage(
            sessionId: String,
            contactId: String,
            content: String
        ): AiAdvisorConversation {
            val now = System.currentTimeMillis()
            return AiAdvisorConversation(
                id = java.util.UUID.randomUUID().toString(),
                contactId = contactId,
                sessionId = sessionId,
                messageType = MessageType.USER,
                content = content,
                timestamp = now,
                createdAt = now
            )
        }
        
        /**
         * åˆ›å»ºAIæ¶ˆæ¯
         */
        fun createAiMessage(
            sessionId: String,
            contactId: String,
            content: String
        ): AiAdvisorConversation {
            val now = System.currentTimeMillis()
            return AiAdvisorConversation(
                id = java.util.UUID.randomUUID().toString(),
                contactId = contactId,
                sessionId = sessionId,
                messageType = MessageType.AI,
                content = content,
                timestamp = now,
                createdAt = now
            )
        }
    }
}

/**
 * æ¶ˆæ¯ç±»å‹æšä¸¾
 */
enum class MessageType {
    USER,   // ç”¨æˆ·æ¶ˆæ¯
    AI      // AIå›å¤
}

/**
 * å‘é€çŠ¶æ€æšä¸¾
 */
enum class SendStatus {
    PENDING,    // å‘é€ä¸­
    SUCCESS,    // å‘é€æˆåŠŸ
    FAILED      // å‘é€å¤±è´¥
}
```

#### 4.1.3 AiAdvisorErrorï¼ˆé”™è¯¯ç±»å‹ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`:domain/model/AiAdvisorError.kt`

```kotlin
/**
 * AIå†›å¸ˆé”™è¯¯ç±»å‹
 *
 * ç”¨äºç»Ÿä¸€é”™è¯¯å¤„ç†å’ŒUIå±•ç¤º
 */
sealed class AiAdvisorError(val message: String, val isRetryable: Boolean) {
    
    /** ç½‘ç»œé”™è¯¯ */
    class NetworkError(
        message: String = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"
    ) : AiAdvisorError(message, isRetryable = true)
    
    /** APIé”™è¯¯ */
    class ApiError(
        message: String = "AIæš‚æ—¶æ— æ³•å›å¤ï¼Œè¯·ç¨åé‡è¯•"
    ) : AiAdvisorError(message, isRetryable = true)
    
    /** é…ç½®é”™è¯¯ */
    class ConfigError(
        message: String = "è¯·å…ˆé…ç½®AIæœåŠ¡å•†"
    ) : AiAdvisorError(message, isRetryable = false)
    
    /** è¶…æ—¶é”™è¯¯ */
    class TimeoutError(
        message: String = "AIå“åº”è¶…æ—¶ï¼Œè¯·é‡è¯•"
    ) : AiAdvisorError(message, isRetryable = true)
    
    /** æ•°æ®åº“é”™è¯¯ */
    class DatabaseError(
        message: String = "æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•"
    ) : AiAdvisorError(message, isRetryable = true)
    
    /** è”ç³»äººä¸å­˜åœ¨ */
    class ContactNotFoundError(
        message: String = "è”ç³»äººä¸å­˜åœ¨"
    ) : AiAdvisorError(message, isRetryable = false)
    
    /** æœªçŸ¥é”™è¯¯ */
    class UnknownError(
        message: String = "å‘ç”ŸæœªçŸ¥é”™è¯¯"
    ) : AiAdvisorError(message, isRetryable = true)
    
    companion object {
        /**
         * ä»å¼‚å¸¸åˆ›å»ºé”™è¯¯ç±»å‹
         */
        fun fromException(e: Throwable): AiAdvisorError {
            return when {
                e is java.net.UnknownHostException -> NetworkError()
                e is java.net.SocketTimeoutException -> TimeoutError()
                e.message?.contains("API") == true -> ApiError(e.message ?: "APIé”™è¯¯")
                e.message?.contains("é…ç½®") == true -> ConfigError()
                else -> UnknownError(e.message ?: "æœªçŸ¥é”™è¯¯")
            }
        }
    }
}
```

### 4.2 æ•°æ®åº“è®¾è®¡

#### 4.2.1 AiAdvisorSessionEntity

**æ–‡ä»¶ä½ç½®**ï¼š`:data/local/entity/AiAdvisorSessionEntity.kt`

```kotlin
@Entity(
    tableName = "ai_advisor_sessions",
    foreignKeys = [
        ForeignKey(
            entity = ContactProfileEntity::class,
            parentColumns = ["id"],
            childColumns = ["contact_id"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [
        Index(value = ["contact_id"]),
        Index(value = ["created_at"]),
        Index(value = ["updated_at"])
    ]
)
data class AiAdvisorSessionEntity(
    @PrimaryKey
    @ColumnInfo(name = "id")
    val id: String,
    
    @ColumnInfo(name = "contact_id")
    val contactId: String,
    
    @ColumnInfo(name = "title")
    val title: String,
    
    @ColumnInfo(name = "created_at")
    val createdAt: Long,
    
    @ColumnInfo(name = "updated_at")
    val updatedAt: Long,
    
    @ColumnInfo(name = "message_count", defaultValue = "0")
    val messageCount: Int = 0,
    
    @ColumnInfo(name = "is_active", defaultValue = "1")
    val isActive: Boolean = true
) {
    /**
     * è½¬æ¢ä¸ºé¢†åŸŸæ¨¡å‹
     */
    fun toDomain(): AiAdvisorSession = AiAdvisorSession(
        id = id,
        contactId = contactId,
        title = title,
        createdAt = createdAt,
        updatedAt = updatedAt,
        messageCount = messageCount,
        isActive = isActive
    )
    
    companion object {
        /**
         * ä»é¢†åŸŸæ¨¡å‹åˆ›å»º
         */
        fun fromDomain(session: AiAdvisorSession): AiAdvisorSessionEntity =
            AiAdvisorSessionEntity(
                id = session.id,
                contactId = session.contactId,
                title = session.title,
                createdAt = session.createdAt,
                updatedAt = session.updatedAt,
                messageCount = session.messageCount,
                isActive = session.isActive
            )
    }
}
```

#### 4.2.2 AiAdvisorConversationEntity

**æ–‡ä»¶ä½ç½®**ï¼š`:data/local/entity/AiAdvisorConversationEntity.kt`

```kotlin
@Entity(
    tableName = "ai_advisor_conversations",
    foreignKeys = [
        ForeignKey(
            entity = ContactProfileEntity::class,
            parentColumns = ["id"],
            childColumns = ["contact_id"],
            onDelete = ForeignKey.CASCADE
        ),
        ForeignKey(
            entity = AiAdvisorSessionEntity::class,
            parentColumns = ["id"],
            childColumns = ["session_id"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [
        Index(value = ["contact_id"]),
        Index(value = ["session_id"]),
        Index(value = ["timestamp"])
    ]
)
data class AiAdvisorConversationEntity(
    @PrimaryKey
    @ColumnInfo(name = "id")
    val id: String,
    
    @ColumnInfo(name = "contact_id")
    val contactId: String,
    
    @ColumnInfo(name = "session_id")
    val sessionId: String,
    
    @ColumnInfo(name = "message_type")
    val messageType: String,  // "USER" æˆ– "AI"
    
    @ColumnInfo(name = "content")
    val content: String,
    
    @ColumnInfo(name = "timestamp")
    val timestamp: Long,
    
    @ColumnInfo(name = "created_at")
    val createdAt: Long
) {
    /**
     * è½¬æ¢ä¸ºé¢†åŸŸæ¨¡å‹
     */
    fun toDomain(): AiAdvisorConversation = AiAdvisorConversation(
        id = id,
        contactId = contactId,
        sessionId = sessionId,
        messageType = MessageType.valueOf(messageType),
        content = content,
        timestamp = timestamp,
        createdAt = createdAt
    )
    
    companion object {
        /**
         * ä»é¢†åŸŸæ¨¡å‹åˆ›å»º
         */
        fun fromDomain(conversation: AiAdvisorConversation): AiAdvisorConversationEntity =
            AiAdvisorConversationEntity(
                id = conversation.id,
                contactId = conversation.contactId,
                sessionId = conversation.sessionId,
                messageType = conversation.messageType.name,
                content = conversation.content,
                timestamp = conversation.timestamp,
                createdAt = conversation.createdAt
            )
    }
}
```

#### 4.2.3 æ•°æ®åº“è¿ç§»ï¼ˆv12 â†’ v13ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`:data/local/DatabaseMigrations.kt`

```kotlin
/**
 * æ•°æ®åº“è¿ç§»ï¼šv12 â†’ v13
 *
 * æ–°å¢AIå†›å¸ˆå¯¹è¯åŠŸèƒ½ç›¸å…³è¡¨ï¼š
 * - ai_advisor_sessions: ä¼šè¯è¡¨
 * - ai_advisor_conversations: å¯¹è¯è®°å½•è¡¨
 */
val MIGRATION_12_13 = object : Migration(12, 13) {
    override fun migrate(database: SupportSQLiteDatabase) {
        // 1. åˆ›å»ºai_advisor_sessionsè¡¨
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS ai_advisor_sessions (
                id TEXT PRIMARY KEY NOT NULL,
                contact_id TEXT NOT NULL,
                title TEXT NOT NULL,
                created_at INTEGER NOT NULL,
                updated_at INTEGER NOT NULL,
                message_count INTEGER NOT NULL DEFAULT 0,
                is_active INTEGER NOT NULL DEFAULT 1,
                FOREIGN KEY(contact_id) REFERENCES contact_profiles(id) ON DELETE CASCADE
            )
        """)
        
        // 2. åˆ›å»ºai_advisor_conversationsè¡¨
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS ai_advisor_conversations (
                id TEXT PRIMARY KEY NOT NULL,
                contact_id TEXT NOT NULL,
                session_id TEXT NOT NULL,
                message_type TEXT NOT NULL,
                content TEXT NOT NULL,
                timestamp INTEGER NOT NULL,
                created_at INTEGER NOT NULL,
                FOREIGN KEY(contact_id) REFERENCES contact_profiles(id) ON DELETE CASCADE,
                FOREIGN KEY(session_id) REFERENCES ai_advisor_sessions(id) ON DELETE CASCADE
            )
        """)
        
        // 3. åˆ›å»ºç´¢å¼•
        database.execSQL(
            "CREATE INDEX IF NOT EXISTS index_ai_advisor_sessions_contact_id " +
            "ON ai_advisor_sessions(contact_id)"
        )
        database.execSQL(
            "CREATE INDEX IF NOT EXISTS index_ai_advisor_sessions_created_at " +
            "ON ai_advisor_sessions(created_at)"
        )
        database.execSQL(
            "CREATE INDEX IF NOT EXISTS index_ai_advisor_sessions_updated_at " +
            "ON ai_advisor_sessions(updated_at)"
        )
        database.execSQL(
            "CREATE INDEX IF NOT EXISTS index_ai_advisor_conversations_contact_id " +
            "ON ai_advisor_conversations(contact_id)"
        )
        database.execSQL(
            "CREATE INDEX IF NOT EXISTS index_ai_advisor_conversations_session_id " +
            "ON ai_advisor_conversations(session_id)"
        )
        database.execSQL(
            "CREATE INDEX IF NOT EXISTS index_ai_advisor_conversations_timestamp " +
            "ON ai_advisor_conversations(timestamp)"
        )
    }
}
```


### 4.3 DAOè®¾è®¡

#### 4.3.1 AiAdvisorDao

**æ–‡ä»¶ä½ç½®**ï¼š`:data/local/dao/AiAdvisorDao.kt`

```kotlin
@Dao
interface AiAdvisorDao {
    
    // ============================================================================
    // ä¼šè¯æ“ä½œ
    // ============================================================================
    
    /**
     * æ’å…¥ä¼šè¯
     */
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertSession(session: AiAdvisorSessionEntity)
    
    /**
     * è·å–è”ç³»äººçš„æ‰€æœ‰ä¼šè¯ï¼ˆæŒ‰æ›´æ–°æ—¶é—´å€’åºï¼‰
     */
    @Query("""
        SELECT * FROM ai_advisor_sessions 
        WHERE contact_id = :contactId 
        ORDER BY updated_at DESC
    """)
    suspend fun getSessionsByContact(contactId: String): List<AiAdvisorSessionEntity>
    
    /**
     * è·å–è”ç³»äººçš„æ´»è·ƒä¼šè¯
     */
    @Query("""
        SELECT * FROM ai_advisor_sessions 
        WHERE contact_id = :contactId AND is_active = 1 
        LIMIT 1
    """)
    suspend fun getActiveSession(contactId: String): AiAdvisorSessionEntity?
    
    /**
     * æ ¹æ®IDè·å–ä¼šè¯
     */
    @Query("SELECT * FROM ai_advisor_sessions WHERE id = :sessionId")
    suspend fun getSessionById(sessionId: String): AiAdvisorSessionEntity?
    
    /**
     * æ›´æ–°ä¼šè¯æ ‡é¢˜
     */
    @Query("""
        UPDATE ai_advisor_sessions 
        SET title = :title, updated_at = :updatedAt 
        WHERE id = :sessionId
    """)
    suspend fun updateSessionTitle(sessionId: String, title: String, updatedAt: Long)
    
    /**
     * å¢åŠ æ¶ˆæ¯è®¡æ•°å¹¶æ›´æ–°æ—¶é—´
     */
    @Query("""
        UPDATE ai_advisor_sessions 
        SET message_count = message_count + 1, updated_at = :updatedAt 
        WHERE id = :sessionId
    """)
    suspend fun incrementMessageCount(sessionId: String, updatedAt: Long)
    
    /**
     * åˆ é™¤ä¼šè¯
     */
    @Query("DELETE FROM ai_advisor_sessions WHERE id = :sessionId")
    suspend fun deleteSession(sessionId: String)
    
    /**
     * åˆ é™¤è”ç³»äººçš„æ‰€æœ‰ä¼šè¯
     */
    @Query("DELETE FROM ai_advisor_sessions WHERE contact_id = :contactId")
    suspend fun deleteSessionsByContact(contactId: String)
    
    // ============================================================================
    // å¯¹è¯æ“ä½œ
    // ============================================================================
    
    /**
     * æ’å…¥å¯¹è¯è®°å½•
     */
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertConversation(conversation: AiAdvisorConversationEntity)
    
    /**
     * è·å–ä¼šè¯çš„æ‰€æœ‰å¯¹è¯è®°å½•ï¼ˆæŒ‰æ—¶é—´æ­£åºï¼‰
     */
    @Query("""
        SELECT * FROM ai_advisor_conversations 
        WHERE session_id = :sessionId 
        ORDER BY timestamp ASC
    """)
    suspend fun getConversationsBySession(sessionId: String): List<AiAdvisorConversationEntity>
    
    /**
     * è·å–ä¼šè¯çš„å¯¹è¯è®°å½•æµï¼ˆå“åº”å¼ï¼‰
     */
    @Query("""
        SELECT * FROM ai_advisor_conversations 
        WHERE session_id = :sessionId 
        ORDER BY timestamp ASC
    """)
    fun getConversationsBySessionFlow(sessionId: String): Flow<List<AiAdvisorConversationEntity>>
    
    /**
     * è·å–ä¼šè¯çš„æœ€è¿‘Næ¡å¯¹è¯
     */
    @Query("""
        SELECT * FROM ai_advisor_conversations 
        WHERE session_id = :sessionId 
        ORDER BY timestamp DESC 
        LIMIT :limit
    """)
    suspend fun getRecentConversations(sessionId: String, limit: Int): List<AiAdvisorConversationEntity>
    
    /**
     * åˆ é™¤å•æ¡å¯¹è¯è®°å½•
     */
    @Query("DELETE FROM ai_advisor_conversations WHERE id = :conversationId")
    suspend fun deleteConversation(conversationId: String)
    
    /**
     * æ¸…ç©ºä¼šè¯çš„æ‰€æœ‰å¯¹è¯
     */
    @Query("DELETE FROM ai_advisor_conversations WHERE session_id = :sessionId")
    suspend fun clearSessionConversations(sessionId: String)
    
    /**
     * è·å–ä¼šè¯çš„å¯¹è¯æ•°é‡
     */
    @Query("SELECT COUNT(*) FROM ai_advisor_conversations WHERE session_id = :sessionId")
    suspend fun getConversationCount(sessionId: String): Int
}
```

### 4.4 Repositoryè®¾è®¡

#### 4.4.1 AiAdvisorRepositoryæ¥å£

**æ–‡ä»¶ä½ç½®**ï¼š`:domain/repository/AiAdvisorRepository.kt`

```kotlin
/**
 * AIå†›å¸ˆä»“åº“æ¥å£
 *
 * å®šä¹‰AIå†›å¸ˆå¯¹è¯å’Œä¼šè¯çš„æ•°æ®è®¿é—®æ¥å£
 */
interface AiAdvisorRepository {
    
    // ============================================================================
    // ä¼šè¯ç®¡ç†
    // ============================================================================
    
    /**
     * åˆ›å»ºæ–°ä¼šè¯
     *
     * @param contactId è”ç³»äººID
     * @param title ä¼šè¯æ ‡é¢˜
     * @return æ–°åˆ›å»ºçš„ä¼šè¯
     */
    suspend fun createSession(contactId: String, title: String = "æ–°å¯¹è¯"): Result<AiAdvisorSession>
    
    /**
     * è·å–è”ç³»äººçš„æ‰€æœ‰ä¼šè¯
     *
     * @param contactId è”ç³»äººID
     * @return ä¼šè¯åˆ—è¡¨ï¼ŒæŒ‰æ›´æ–°æ—¶é—´å€’åº
     */
    suspend fun getSessions(contactId: String): Result<List<AiAdvisorSession>>
    
    /**
     * è·å–è”ç³»äººçš„æ´»è·ƒä¼šè¯
     *
     * @param contactId è”ç³»äººID
     * @return æ´»è·ƒä¼šè¯ï¼Œä¸å­˜åœ¨åˆ™è¿”å›null
     */
    suspend fun getActiveSession(contactId: String): Result<AiAdvisorSession?>
    
    /**
     * è·å–æˆ–åˆ›å»ºæ´»è·ƒä¼šè¯
     *
     * @param contactId è”ç³»äººID
     * @return æ´»è·ƒä¼šè¯ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ä¼šè¯ï¼‰
     */
    suspend fun getOrCreateActiveSession(contactId: String): Result<AiAdvisorSession>
    
    /**
     * æ›´æ–°ä¼šè¯æ ‡é¢˜
     *
     * @param sessionId ä¼šè¯ID
     * @param title æ–°æ ‡é¢˜
     */
    suspend fun updateSessionTitle(sessionId: String, title: String): Result<Unit>
    
    /**
     * åˆ é™¤ä¼šè¯ï¼ˆçº§è”åˆ é™¤å¯¹è¯è®°å½•ï¼‰
     *
     * @param sessionId ä¼šè¯ID
     */
    suspend fun deleteSession(sessionId: String): Result<Unit>
    
    // ============================================================================
    // å¯¹è¯ç®¡ç†
    // ============================================================================
    
    /**
     * ä¿å­˜æ¶ˆæ¯
     *
     * @param conversation å¯¹è¯è®°å½•
     * @return ä¿å­˜åçš„å¯¹è¯è®°å½•
     */
    suspend fun saveMessage(conversation: AiAdvisorConversation): Result<AiAdvisorConversation>
    
    /**
     * è·å–ä¼šè¯çš„æ‰€æœ‰å¯¹è¯è®°å½•
     *
     * @param sessionId ä¼šè¯ID
     * @return å¯¹è¯è®°å½•åˆ—è¡¨ï¼ŒæŒ‰æ—¶é—´æ­£åº
     */
    suspend fun getConversations(sessionId: String): Result<List<AiAdvisorConversation>>
    
    /**
     * è·å–ä¼šè¯çš„å¯¹è¯è®°å½•æµ
     *
     * @param sessionId ä¼šè¯ID
     * @return å¯¹è¯è®°å½•æµ
     */
    fun getConversationsFlow(sessionId: String): Flow<List<AiAdvisorConversation>>
    
    /**
     * åˆ é™¤å•æ¡å¯¹è¯è®°å½•
     *
     * @param conversationId å¯¹è¯ID
     */
    suspend fun deleteConversation(conversationId: String): Result<Unit>
    
    /**
     * æ¸…ç©ºä¼šè¯çš„æ‰€æœ‰å¯¹è¯
     *
     * @param sessionId ä¼šè¯ID
     */
    suspend fun clearSession(sessionId: String): Result<Unit>
}
```

#### 4.4.2 AiAdvisorRepositoryImplå®ç°

**æ–‡ä»¶ä½ç½®**ï¼š`:data/repository/AiAdvisorRepositoryImpl.kt`

```kotlin
class AiAdvisorRepositoryImpl @Inject constructor(
    private val dao: AiAdvisorDao,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) : AiAdvisorRepository {
    
    // ============================================================================
    // ä¼šè¯ç®¡ç†
    // ============================================================================
    
    override suspend fun createSession(
        contactId: String,
        title: String
    ): Result<AiAdvisorSession> = withContext(ioDispatcher) {
        try {
            val session = AiAdvisorSession.create(contactId, title)
            dao.insertSession(AiAdvisorSessionEntity.fromDomain(session))
            Result.success(session)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun getSessions(
        contactId: String
    ): Result<List<AiAdvisorSession>> = withContext(ioDispatcher) {
        try {
            val entities = dao.getSessionsByContact(contactId)
            Result.success(entities.map { it.toDomain() })
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun getActiveSession(
        contactId: String
    ): Result<AiAdvisorSession?> = withContext(ioDispatcher) {
        try {
            val entity = dao.getActiveSession(contactId)
            Result.success(entity?.toDomain())
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun getOrCreateActiveSession(
        contactId: String
    ): Result<AiAdvisorSession> = withContext(ioDispatcher) {
        try {
            val existing = dao.getActiveSession(contactId)
            if (existing != null) {
                Result.success(existing.toDomain())
            } else {
                createSession(contactId)
            }
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun updateSessionTitle(
        sessionId: String,
        title: String
    ): Result<Unit> = withContext(ioDispatcher) {
        try {
            dao.updateSessionTitle(sessionId, title, System.currentTimeMillis())
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun deleteSession(
        sessionId: String
    ): Result<Unit> = withContext(ioDispatcher) {
        try {
            dao.deleteSession(sessionId)
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    // ============================================================================
    // å¯¹è¯ç®¡ç†
    // ============================================================================
    
    override suspend fun saveMessage(
        conversation: AiAdvisorConversation
    ): Result<AiAdvisorConversation> = withContext(ioDispatcher) {
        try {
            dao.insertConversation(AiAdvisorConversationEntity.fromDomain(conversation))
            dao.incrementMessageCount(conversation.sessionId, System.currentTimeMillis())
            Result.success(conversation)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun getConversations(
        sessionId: String
    ): Result<List<AiAdvisorConversation>> = withContext(ioDispatcher) {
        try {
            val entities = dao.getConversationsBySession(sessionId)
            Result.success(entities.map { it.toDomain() })
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override fun getConversationsFlow(
        sessionId: String
    ): Flow<List<AiAdvisorConversation>> {
        return dao.getConversationsBySessionFlow(sessionId)
            .map { entities -> entities.map { it.toDomain() } }
            .flowOn(ioDispatcher)
    }
    
    override suspend fun deleteConversation(
        conversationId: String
    ): Result<Unit> = withContext(ioDispatcher) {
        try {
            dao.deleteConversation(conversationId)
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    override suspend fun clearSession(
        sessionId: String
    ): Result<Unit> = withContext(ioDispatcher) {
        try {
            dao.clearSessionConversations(sessionId)
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

### 4.5 UseCaseè®¾è®¡

#### 4.5.1 SendAdvisorMessageUseCaseï¼ˆæ ¸å¿ƒç”¨ä¾‹ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`:domain/usecase/SendAdvisorMessageUseCase.kt`

```kotlin
/**
 * å‘é€AIå†›å¸ˆæ¶ˆæ¯ç”¨ä¾‹
 *
 * æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼š
 * 1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
 * 2. è·å–è”ç³»äººç”»åƒå’Œå¯¹è¯å†å²
 * 3. æ„å»ºAIå†›å¸ˆæç¤ºè¯
 * 4. è°ƒç”¨AIæœåŠ¡
 * 5. ä¿å­˜AIå›å¤
 *
 * ã€å·²çŸ¥é™åˆ¶ã€‘
 * - å†å²å¯¹è¯è®°å½•é™åˆ¶ä¸ºæœ€è¿‘20æ¡ï¼ˆå—AIæ¨¡å‹Context Windowé™åˆ¶ï¼‰
 * - ä¼šè¯ä¸Šä¸‹æ–‡é™åˆ¶ä¸ºæœ€è¿‘10æ¡
 */
class SendAdvisorMessageUseCase @Inject constructor(
    private val aiAdvisorRepository: AiAdvisorRepository,
    private val aiRepository: AiRepository,
    private val contactRepository: ContactRepository,
    private val conversationRepository: ConversationRepository,
    private val aiProviderRepository: AiProviderRepository
) {
    companion object {
        /** å†å²å¯¹è¯è®°å½•æ¡æ•°é™åˆ¶ï¼ˆå—AIæ¨¡å‹Context Windowé™åˆ¶ï¼‰ */
        private const val HISTORY_LIMIT = 20
        
        /** ä¼šè¯ä¸Šä¸‹æ–‡æ¡æ•°é™åˆ¶ */
        private const val SESSION_CONTEXT_LIMIT = 10
    }
    
    suspend operator fun invoke(
        sessionId: String,
        contactId: String,
        message: String
    ): Result<AiAdvisorConversation> {
        // 1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
        val userMessage = AiAdvisorConversation.createUserMessage(
            sessionId = sessionId,
            contactId = contactId,
            content = message
        )
        
        val saveResult = aiAdvisorRepository.saveMessage(userMessage)
        if (saveResult.isFailure) {
            return Result.failure(saveResult.exceptionOrNull()!!)
        }
        
        // 2. è·å–è”ç³»äººç”»åƒ
        val profile = contactRepository.getContactById(contactId).getOrNull()
        
        // 3. è·å–è¯¥è”ç³»äººçš„å¯¹è¯å†å²ï¼ˆç”¨äºAIåˆ†æï¼‰
        val conversationHistory = conversationRepository
            .getConversationsByContact(contactId)
            .getOrDefault(emptyList())
        
        // 4. è·å–å½“å‰ä¼šè¯çš„å¯¹è¯è®°å½•ï¼ˆä½œä¸ºå¯¹è¯ä¸Šä¸‹æ–‡ï¼‰
        val sessionHistory = aiAdvisorRepository
            .getConversations(sessionId)
            .getOrDefault(emptyList())
        
        // 5. æ„å»ºAIå†›å¸ˆæç¤ºè¯
        val systemPrompt = buildAdvisorSystemPrompt(profile, conversationHistory)
        val userPrompt = buildUserPrompt(sessionHistory, message)
        
        // 6. è·å–é»˜è®¤AIæœåŠ¡å•†
        val provider = aiProviderRepository.getDefaultProvider().getOrNull()
            ?: return Result.failure(IllegalStateException("æœªé…ç½®AIæœåŠ¡å•†"))
        
        // 7. è°ƒç”¨AIæœåŠ¡
        val aiResponse = aiRepository.chat(
            provider = provider,
            systemPrompt = systemPrompt,
            userPrompt = userPrompt
        )
        
        if (aiResponse.isFailure) {
            return Result.failure(aiResponse.exceptionOrNull()!!)
        }
        
        val aiContent = aiResponse.getOrNull()?.content ?: "æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›å¤"
        
        // 8. ä¿å­˜AIå›å¤
        val aiMessage = AiAdvisorConversation.createAiMessage(
            sessionId = sessionId,
            contactId = contactId,
            content = aiContent
        )
        
        val aiSaveResult = aiAdvisorRepository.saveMessage(aiMessage)
        if (aiSaveResult.isFailure) {
            return Result.failure(aiSaveResult.exceptionOrNull()!!)
        }
        
        // 9. è¿”å›AIå›å¤
        return Result.success(aiMessage)
    }
    
    /**
     * æ„å»ºAIå†›å¸ˆç³»ç»Ÿæç¤ºè¯
     *
     * ã€å·²çŸ¥é™åˆ¶ã€‘
     * ç”±äºAIæ¨¡å‹çš„Context Windowé™åˆ¶ï¼Œå†å²å¯¹è¯è®°å½•é™åˆ¶ä¸ºæœ€è¿‘20æ¡ã€‚
     * åç»­ä¼˜åŒ–æ–¹å‘ï¼š
     * 1. å¼•å…¥RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æœºåˆ¶ï¼ŒæŒ‰ç›¸å…³æ€§æ£€ç´¢å†å²
     * 2. ä½¿ç”¨AIç”Ÿæˆå†å²å¯¹è¯æ‘˜è¦ï¼Œå‹ç¼©ä¸Šä¸‹æ–‡
     * 3. æ ¹æ®ç”¨æˆ·é—®é¢˜åŠ¨æ€é€‰æ‹©ç›¸å…³å†å²ç‰‡æ®µ
     */
    private fun buildAdvisorSystemPrompt(
        profile: ContactProfile?,
        conversationHistory: List<ConversationLog>
    ): String {
        return buildString {
            // ç³»ç»Ÿè§’è‰²å®šä¹‰
            append(SystemPrompts.AI_ADVISOR_HEADER)
            appendLine()
            appendLine()
            
            // è”ç³»äººç”»åƒä¿¡æ¯
            if (profile != null) {
                append("ã€è”ç³»äººç”»åƒã€‘")
                appendLine()
                append("å§“åï¼š${profile.name}")
                appendLine()
                if (profile.relationshipStage.isNotEmpty()) {
                    append("å…³ç³»é˜¶æ®µï¼š${profile.relationshipStage}")
                    appendLine()
                }
                // æ·»åŠ factsä¿¡æ¯
                if (profile.facts.isNotEmpty()) {
                    append("å·²çŸ¥ä¿¡æ¯ï¼š")
                    appendLine()
                    profile.facts.forEach { fact ->
                        append("- ${fact.key}: ${fact.value}")
                        appendLine()
                    }
                }
                appendLine()
            }
            
            // å¯¹è¯å†å²æ‘˜è¦ï¼ˆå—Context Windowé™åˆ¶ï¼Œå–æœ€è¿‘20æ¡ï¼‰
            if (conversationHistory.isNotEmpty()) {
                val limitedHistory = conversationHistory.takeLast(HISTORY_LIMIT)
                append("ã€å†å²å¯¹è¯æ‘˜è¦ã€‘ï¼ˆæœ€è¿‘${limitedHistory.size}æ¡ï¼‰")
                appendLine()
                limitedHistory.forEach { log ->
                    append("[${formatTimestamp(log.timestamp)}] ${log.userInput}")
                    appendLine()
                }
                appendLine()
            }
            
            // è¾“å‡ºæ ¼å¼çº¦æŸ
            append(SystemPrompts.AI_ADVISOR_FOOTER)
        }
    }
    
    /**
     * æ„å»ºç”¨æˆ·æç¤ºè¯ï¼ˆåŒ…å«ä¼šè¯ä¸Šä¸‹æ–‡ï¼‰
     *
     * ä¼šè¯ä¸Šä¸‹æ–‡é™åˆ¶ä¸ºæœ€è¿‘10æ¡ï¼Œç¡®ä¿AIèƒ½ç†è§£å½“å‰å¯¹è¯çš„è¿ç»­æ€§
     */
    private fun buildUserPrompt(
        sessionHistory: List<AiAdvisorConversation>,
        currentMessage: String
    ): String {
        return buildString {
            // ä¼šè¯ä¸Šä¸‹æ–‡ï¼ˆæœ€è¿‘10æ¡ï¼‰
            if (sessionHistory.isNotEmpty()) {
                val limitedContext = sessionHistory.takeLast(SESSION_CONTEXT_LIMIT)
                append("ã€å¯¹è¯ä¸Šä¸‹æ–‡ã€‘")
                appendLine()
                limitedContext.forEach { conv ->
                    val role = if (conv.messageType == MessageType.USER) "ç”¨æˆ·" else "AIå†›å¸ˆ"
                    append("$role: ${conv.content}")
                    appendLine()
                }
                appendLine()
            }
            
            // å½“å‰æ¶ˆæ¯
            append("ã€å½“å‰é—®é¢˜ã€‘")
            appendLine()
            append(currentMessage)
        }
    }
    
    private fun formatTimestamp(timestamp: Long): String {
        val sdf = java.text.SimpleDateFormat("MM-dd HH:mm", java.util.Locale.getDefault())
        return sdf.format(java.util.Date(timestamp))
    }
}
```

#### 4.5.2 å…¶ä»–UseCase

**CreateAdvisorSessionUseCase**ï¼š`:domain/usecase/CreateAdvisorSessionUseCase.kt`

```kotlin
/**
 * åˆ›å»ºAIå†›å¸ˆä¼šè¯ç”¨ä¾‹
 */
class CreateAdvisorSessionUseCase @Inject constructor(
    private val aiAdvisorRepository: AiAdvisorRepository
) {
    suspend operator fun invoke(
        contactId: String,
        title: String = "æ–°å¯¹è¯"
    ): Result<AiAdvisorSession> {
        return aiAdvisorRepository.createSession(contactId, title)
    }
}
```

**GetAdvisorSessionsUseCase**ï¼š`:domain/usecase/GetAdvisorSessionsUseCase.kt`

```kotlin
/**
 * è·å–AIå†›å¸ˆä¼šè¯åˆ—è¡¨ç”¨ä¾‹
 */
class GetAdvisorSessionsUseCase @Inject constructor(
    private val aiAdvisorRepository: AiAdvisorRepository
) {
    suspend operator fun invoke(contactId: String): Result<List<AiAdvisorSession>> {
        return aiAdvisorRepository.getSessions(contactId)
    }
}
```

**GetAdvisorConversationsUseCase**ï¼š`:domain/usecase/GetAdvisorConversationsUseCase.kt`

```kotlin
/**
 * è·å–AIå†›å¸ˆå¯¹è¯è®°å½•ç”¨ä¾‹
 */
class GetAdvisorConversationsUseCase @Inject constructor(
    private val aiAdvisorRepository: AiAdvisorRepository
) {
    operator fun invoke(sessionId: String): Flow<List<AiAdvisorConversation>> {
        return aiAdvisorRepository.getConversationsFlow(sessionId)
    }
}
```

**DeleteAdvisorConversationUseCase**ï¼š`:domain/usecase/DeleteAdvisorConversationUseCase.kt`

```kotlin
/**
 * åˆ é™¤AIå†›å¸ˆå¯¹è¯è®°å½•ç”¨ä¾‹
 */
class DeleteAdvisorConversationUseCase @Inject constructor(
    private val aiAdvisorRepository: AiAdvisorRepository
) {
    suspend operator fun invoke(conversationId: String): Result<Unit> {
        return aiAdvisorRepository.deleteConversation(conversationId)
    }
}
```


### 4.6 æç¤ºè¯ç³»ç»Ÿè®¾è®¡

#### 4.6.1 SystemPromptsæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`:domain/util/SystemPrompts.kt`

```kotlin
object SystemPrompts {
    // ... ç°æœ‰æç¤ºè¯ ...
    
    // ========== AIå†›å¸ˆåœºæ™¯ï¼ˆPRD-00026æ–°å¢ï¼‰ ==========
    
    const val AI_ADVISOR_HEADER = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç¤¾äº¤å…³ç³»åˆ†æé¡¾é—®ï¼ˆAIå†›å¸ˆï¼‰ï¼Œå…·å¤‡å¿ƒç†å­¦ã€ç¤¾ä¼šå­¦ã€äººç±»å­¦çš„ä¸“ä¸šèƒŒæ™¯ã€‚

ã€æ ¸å¿ƒèŒè´£ã€‘
1. åŸºäºæä¾›çš„å¯¹è¯å†å²å’Œè”ç³»äººä¿¡æ¯ï¼Œè¿›è¡Œå®¢è§‚ã€ç†æ€§çš„åˆ†æ
2. ä»å¿ƒç†å­¦è§’åº¦åˆ†æåŒæ–¹çš„è¡Œä¸ºæ¨¡å¼å’Œæƒ…æ„Ÿå˜åŒ–
3. ä»ç¤¾ä¼šå­¦è§’åº¦è¯„ä¼°å…³ç³»å‘å±•é˜¶æ®µå’ŒåŠ¨æ€
4. ä»äººç±»å­¦è§’åº¦ç†è§£æ–‡åŒ–èƒŒæ™¯å¯¹æ²Ÿé€šçš„å½±å“
5. æä¾›å…·ä½“ã€å¯è¡Œçš„å»ºè®®ï¼Œå¸®åŠ©ç”¨æˆ·æ”¹å–„æ²Ÿé€šè´¨é‡

ã€åˆ†æåŸåˆ™ã€‘
- ä¿æŒç»å¯¹å®¢è§‚ä¸­ç«‹ï¼Œä¸åšé“å¾·è¯„åˆ¤
- åŸºäºç»å…¸ç†è®ºå’Œå…¬è®¤æ ‡å‡†è¿›è¡Œåˆ†æ
- å…³æ³¨è¡Œä¸ºæ¨¡å¼è€Œéå•æ¬¡äº‹ä»¶
- æä¾›å»ºè®¾æ€§æ„è§è€Œéæ‰¹è¯„æŒ‡è´£
- å°Šé‡ä¸ªä½“å·®å¼‚å’Œæ–‡åŒ–èƒŒæ™¯

ã€åˆ†æç»´åº¦ã€‘
1. æƒ…æ„Ÿåˆ†æï¼šè¯†åˆ«å¯¹è¯ä¸­çš„æƒ…ç»ªå˜åŒ–å’Œæƒ…æ„Ÿéœ€æ±‚
2. æ„å›¾è§£è¯»ï¼šåˆ†æå¯¹æ–¹çš„çœŸå®æ„å›¾å’Œæ½œåœ¨è¯‰æ±‚
3. å…³ç³»è¯„ä¼°ï¼šè¯„ä¼°å½“å‰å…³ç³»çŠ¶æ€å’Œå‘å±•è¶‹åŠ¿
4. é£é™©è¯†åˆ«ï¼šå‘ç°æ½œåœ¨çš„æ²Ÿé€šé£é™©å’Œé›·åŒº
5. ç­–ç•¥å»ºè®®ï¼šæä¾›é’ˆå¯¹æ€§çš„æ²Ÿé€šç­–ç•¥å’Œè¯æœ¯

ã€ä½ çš„äººè®¾ã€‘
- è¯´è¯é£æ ¼ï¼šä¸“ä¸šä½†ä¸æ™¦æ¶©ï¼Œåƒä¸€ä¸ªé˜…å†ä¸°å¯Œçš„æœ‹å‹
- åˆ†ææ·±åº¦ï¼šä¸€é’ˆè§è¡€ï¼Œç›´æŒ‡é—®é¢˜æ ¸å¿ƒ
- å»ºè®®é£æ ¼ï¼šå…·ä½“å¯è¡Œï¼Œé¿å…ç©ºæ³›çš„å¤§é“ç†
- æ€åº¦ï¼šæ¸©å’Œä½†ç›´æ¥ï¼Œä¸ç»•å¼¯å­"""

    const val AI_ADVISOR_FOOTER = """ã€è¾“å‡ºè¦æ±‚ã€‘
- åˆ†æè¦æœ‰ç†æœ‰æ®ï¼Œå¯ä»¥å¼•ç”¨ç›¸å…³å¿ƒç†å­¦/ç¤¾ä¼šå­¦ç†è®º
- å»ºè®®è¦å…·ä½“å¯è¡Œï¼Œé¿å…ç©ºæ³›æè¿°
- è¯­è¨€è¦ä¸“ä¸šä½†ä¸æ™¦æ¶©ï¼Œæ˜“äºç†è§£
- ç»“æ„è¦æ¸…æ™°ï¼Œä¾¿äºç”¨æˆ·ç†è§£å’Œæ‰§è¡Œ
- ç›´æ¥è¯´äººè¯ï¼Œä¸è¦åˆ—ä¸€å¤§å †å¹²æ¡æ¡

ã€ç¦æ­¢äº‹é¡¹ã€‘
- ç¦æ­¢ä½¿ç”¨"ç»¼ä¸Šæ‰€è¿°"ã€"æ ¹æ®åˆ†æ"ç­‰AIè…”
- ç¦æ­¢åšé“å¾·è¯„åˆ¤æˆ–ç«™é˜Ÿ
- ç¦æ­¢ç»™å‡ºä¸åˆ‡å®é™…çš„å»ºè®®
- ç¦æ­¢å¿½è§†ç”¨æˆ·çš„å®é™…æƒ…å†µå’Œç›®æ ‡"""
}
```


---

## 5. ViewModelè®¾è®¡

### 5.1 AiAdvisorViewModelï¼ˆä¸»ç•Œé¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`:presentation/viewmodel/AiAdvisorViewModel.kt`

```kotlin
@HiltViewModel
class AiAdvisorViewModel @Inject constructor(
    private val getContactsUseCase: GetContactsUseCase,
    private val getAdvisorSessionsUseCase: GetAdvisorSessionsUseCase
) : ViewModel() {
    
    private val _uiState = MutableStateFlow(AiAdvisorUiState())
    val uiState: StateFlow<AiAdvisorUiState> = _uiState.asStateFlow()
    
    init {
        loadContacts()
    }
    
    private fun loadContacts() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            
            val contactsResult = getContactsUseCase()
            if (contactsResult.isSuccess) {
                val contacts = contactsResult.getOrDefault(emptyList())
                
                // è·å–æ¯ä¸ªè”ç³»äººçš„æœ€è¿‘ä¼šè¯
                val sessionsMap = mutableMapOf<String, AiAdvisorSession?>()
                contacts.forEach { contact ->
                    val sessions = getAdvisorSessionsUseCase(contact.id)
                        .getOrDefault(emptyList())
                    sessionsMap[contact.id] = sessions.firstOrNull()
                }
                
                _uiState.update {
                    it.copy(
                        isLoading = false,
                        contacts = contacts,
                        recentSessions = sessionsMap
                    )
                }
            } else {
                _uiState.update {
                    it.copy(
                        isLoading = false,
                        error = AiAdvisorError.fromException(
                            contactsResult.exceptionOrNull() ?: Exception("æœªçŸ¥é”™è¯¯")
                        )
                    )
                }
            }
        }
    }
    
    fun refresh() {
        loadContacts()
    }
    
    fun clearError() {
        _uiState.update { it.copy(error = null) }
    }
}

/**
 * AIå†›å¸ˆä¸»ç•Œé¢UIçŠ¶æ€
 */
data class AiAdvisorUiState(
    val isLoading: Boolean = false,
    val contacts: List<ContactProfile> = emptyList(),
    val recentSessions: Map<String, AiAdvisorSession?> = emptyMap(),
    val error: AiAdvisorError? = null
) {
    val hasContacts: Boolean get() = contacts.isNotEmpty()
}
```


### 5.2 AiAdvisorChatViewModelï¼ˆå¯¹è¯ç•Œé¢ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`:presentation/viewmodel/AiAdvisorChatViewModel.kt`

```kotlin
@HiltViewModel
class AiAdvisorChatViewModel @Inject constructor(
    private val getContactByIdUseCase: GetContactByIdUseCase,
    private val getContactsUseCase: GetContactsUseCase,
    private val createAdvisorSessionUseCase: CreateAdvisorSessionUseCase,
    private val getAdvisorSessionsUseCase: GetAdvisorSessionsUseCase,
    private val getAdvisorConversationsUseCase: GetAdvisorConversationsUseCase,
    private val sendAdvisorMessageUseCase: SendAdvisorMessageUseCase,
    private val deleteAdvisorConversationUseCase: DeleteAdvisorConversationUseCase
) : ViewModel() {
    
    private val _uiState = MutableStateFlow(AiAdvisorChatUiState())
    val uiState: StateFlow<AiAdvisorChatUiState> = _uiState.asStateFlow()
    
    private var currentContactId: String = ""
    private var currentSessionId: String = ""
    private var conversationsJob: Job? = null
    
    /**
     * åŠ è½½è”ç³»äººä¿¡æ¯
     */
    fun loadContact(contactId: String) {
        currentContactId = contactId
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            
            // è·å–è”ç³»äººä¿¡æ¯
            val contactResult = getContactByIdUseCase(contactId)
            if (contactResult.isSuccess) {
                val contact = contactResult.getOrNull()
                _uiState.update { it.copy(contactName = contact?.name ?: "æœªçŸ¥è”ç³»äºº") }
            }
            
            // è·å–æˆ–åˆ›å»ºä¼šè¯
            val sessionsResult = getAdvisorSessionsUseCase(contactId)
            val sessions = sessionsResult.getOrDefault(emptyList())
            
            if (sessions.isEmpty()) {
                // åˆ›å»ºæ–°ä¼šè¯
                val newSessionResult = createAdvisorSessionUseCase(contactId)
                if (newSessionResult.isSuccess) {
                    val newSession = newSessionResult.getOrNull()!!
                    currentSessionId = newSession.id
                    _uiState.update {
                        it.copy(
                            isLoading = false,
                            currentSessionId = currentSessionId,
                            sessions = listOf(newSession)
                        )
                    }
                }
            } else {
                // ä½¿ç”¨æœ€è¿‘çš„ä¼šè¯
                currentSessionId = sessions.first().id
                _uiState.update {
                    it.copy(
                        isLoading = false,
                        currentSessionId = currentSessionId,
                        sessions = sessions
                    )
                }
                
                // åŠ è½½å¯¹è¯è®°å½•
                loadConversations()
            }
            
            // åŠ è½½æ‰€æœ‰è”ç³»äººï¼ˆç”¨äºåˆ‡æ¢ï¼‰
            val allContactsResult = getContactsUseCase()
            _uiState.update {
                it.copy(allContacts = allContactsResult.getOrDefault(emptyList()))
            }
        }
    }
    
    /**
     * åŠ è½½å¯¹è¯è®°å½•ï¼ˆå“åº”å¼ï¼‰
     */
    private fun loadConversations() {
        conversationsJob?.cancel()
        conversationsJob = viewModelScope.launch {
            getAdvisorConversationsUseCase(currentSessionId)
                .collect { conversations ->
                    _uiState.update { it.copy(conversations = conversations) }
                }
        }
    }
    
    /**
     * æ›´æ–°è¾“å…¥å†…å®¹
     */
    fun updateInput(text: String) {
        _uiState.update { it.copy(inputText = text) }
    }
    
    /**
     * å‘é€æ¶ˆæ¯
     */
    fun sendMessage() {
        val message = _uiState.value.inputText.trim()
        if (message.isEmpty()) return
        
        viewModelScope.launch {
            _uiState.update { it.copy(inputText = "", isSending = true) }
            
            val result = sendAdvisorMessageUseCase(
                sessionId = currentSessionId,
                contactId = currentContactId,
                message = message
            )
            
            _uiState.update { it.copy(isSending = false) }
            
            if (result.isFailure) {
                _uiState.update {
                    it.copy(error = AiAdvisorError.fromException(
                        result.exceptionOrNull() ?: Exception("å‘é€å¤±è´¥")
                    ))
                }
            }
        }
    }
    
    /**
     * é‡è¯•å‘é€å¤±è´¥çš„æ¶ˆæ¯
     */
    fun retryMessage(content: String) {
        _uiState.update { it.copy(inputText = content) }
        sendMessage()
    }
    
    /**
     * åˆ‡æ¢ä¼šè¯
     */
    fun switchSession(sessionId: String) {
        currentSessionId = sessionId
        _uiState.update { it.copy(currentSessionId = sessionId) }
        loadConversations()
    }
    
    /**
     * åˆ›å»ºæ–°ä¼šè¯
     */
    fun createNewSession() {
        viewModelScope.launch {
            val result = createAdvisorSessionUseCase(currentContactId)
            if (result.isSuccess) {
                val newSession = result.getOrNull()!!
                currentSessionId = newSession.id
                _uiState.update {
                    it.copy(
                        currentSessionId = currentSessionId,
                        conversations = emptyList()
                    )
                }
                // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨
                val sessionsResult = getAdvisorSessionsUseCase(currentContactId)
                _uiState.update {
                    it.copy(sessions = sessionsResult.getOrDefault(emptyList()))
                }
            }
        }
    }
    
    // è”ç³»äººé€‰æ‹©ç›¸å…³æ–¹æ³•
    fun showContactSelector() {
        _uiState.update { it.copy(showContactSelector = true) }
    }
    
    fun hideContactSelector() {
        _uiState.update { it.copy(showContactSelector = false) }
    }
    
    fun switchContact(newContactId: String) {
        if (newContactId == currentContactId) {
            hideContactSelector()
            return
        }
        _uiState.update {
            it.copy(
                showContactSelector = false,
                showSwitchConfirmDialog = true,
                pendingContactId = newContactId
            )
        }
    }
    
    fun confirmSwitch() {
        val newContactId = _uiState.value.pendingContactId ?: return
        _uiState.update {
            it.copy(showSwitchConfirmDialog = false, pendingContactId = null)
        }
        loadContact(newContactId)
    }
    
    fun cancelSwitch() {
        _uiState.update {
            it.copy(showSwitchConfirmDialog = false, pendingContactId = null)
        }
    }
    
    fun deleteMessage(conversationId: String) {
        viewModelScope.launch {
            deleteAdvisorConversationUseCase(conversationId)
        }
    }
    
    fun clearError() {
        _uiState.update { it.copy(error = null) }
    }
    
    override fun onCleared() {
        super.onCleared()
        conversationsJob?.cancel()
    }
}
```


### 5.3 AiAdvisorChatUiState

```kotlin
/**
 * AIå†›å¸ˆå¯¹è¯ç•Œé¢UIçŠ¶æ€
 */
data class AiAdvisorChatUiState(
    val isLoading: Boolean = false,
    val isSending: Boolean = false,
    val contactName: String = "",
    val inputText: String = "",
    val currentSessionId: String = "",
    val sessions: List<AiAdvisorSession> = emptyList(),
    val conversations: List<AiAdvisorConversation> = emptyList(),
    val allContacts: List<ContactProfile> = emptyList(),
    val showContactSelector: Boolean = false,
    val showSwitchConfirmDialog: Boolean = false,
    val pendingContactId: String? = null,
    val error: AiAdvisorError? = null
) {
    /** æ˜¯å¦å¯ä»¥å‘é€æ¶ˆæ¯ */
    val canSend: Boolean get() = inputText.isNotBlank() && !isSending
    
    /** æ˜¯å¦æœ‰å¤šä¸ªä¼šè¯ */
    val hasMultipleSessions: Boolean get() = sessions.size > 1
    
    /** æ˜¯å¦æœ‰é”™è¯¯ */
    val hasError: Boolean get() = error != null
    
    /** é”™è¯¯æ˜¯å¦å¯é‡è¯• */
    val isErrorRetryable: Boolean get() = error?.isRetryable == true
}
```

---

## 6. UIç»„ä»¶è®¾è®¡

### 6.1 å¯¼èˆªé…ç½®

#### 6.1.1 NavRoutesæ‰©å±•

**æ–‡ä»¶ä½ç½®**ï¼š`:presentation/navigation/NavRoutes.kt`

```kotlin
object NavRoutes {
    // ç°æœ‰è·¯ç”±...
    
    /** AIå†›å¸ˆä¸»ç•Œé¢ */
    const val AI_ADVISOR = "ai_advisor"
    
    /** AIå†›å¸ˆå¯¹è¯ç•Œé¢ */
    const val AI_ADVISOR_CHAT = "ai_advisor_chat/{contactId}"
    
    /** æ„å»ºAIå†›å¸ˆå¯¹è¯è·¯ç”± */
    fun aiAdvisorChat(contactId: String) = "ai_advisor_chat/$contactId"
}
```

#### 6.1.2 åº•éƒ¨å¯¼èˆªé¡¹

**æ–‡ä»¶ä½ç½®**ï¼š`:presentation/navigation/BottomNavItem.kt`

```kotlin
sealed class BottomNavItem(
    val route: String,
    val icon: ImageVector,
    val selectedIcon: ImageVector,
    val label: String
) {
    // ç°æœ‰å¯¼èˆªé¡¹...
    
    object AIAdvisor : BottomNavItem(
        route = NavRoutes.AI_ADVISOR,
        icon = Icons.Outlined.Psychology,
        selectedIcon = Icons.Filled.Psychology,
        label = "AIå†›å¸ˆ"
    )
}
```

### 6.2 ä¸»ç•Œé¢ç»„ä»¶

#### 6.2.1 AiAdvisorScreen

**æ–‡ä»¶ä½ç½®**ï¼š`:presentation/ui/screen/advisor/AiAdvisorScreen.kt`

```kotlin
@Composable
fun AiAdvisorScreen(
    viewModel: AiAdvisorViewModel = hiltViewModel(),
    onNavigateToChat: (String) -> Unit
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("AIå†›å¸ˆ") },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = MaterialTheme.colorScheme.surface
                )
            )
        }
    ) { paddingValues ->
        when {
            uiState.isLoading -> {
                LoadingView(modifier = Modifier.padding(paddingValues))
            }
            uiState.error != null -> {
                ErrorStateView(
                    error = uiState.error!!,
                    onRetry = { viewModel.refresh() },
                    onNavigateToSettings = { /* å¯¼èˆªåˆ°è®¾ç½® */ },
                    modifier = Modifier.padding(paddingValues)
                )
            }
            !uiState.hasContacts -> {
                EmptyStateView(
                    message = "è¿˜æ²¡æœ‰è”ç³»äºº\nå…ˆæ·»åŠ è”ç³»äººå†æ¥æ‰¾AIå†›å¸ˆèŠèŠ",
                    modifier = Modifier.padding(paddingValues)
                )
            }
            else -> {
                ContactListWithSessions(
                    contacts = uiState.contacts,
                    sessions = uiState.recentSessions,
                    onContactClick = onNavigateToChat,
                    modifier = Modifier.padding(paddingValues)
                )
            }
        }
    }
}
```


### 6.3 å¯¹è¯ç•Œé¢ç»„ä»¶

#### 6.3.1 AiAdvisorChatScreen

**æ–‡ä»¶ä½ç½®**ï¼š`:presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`

```kotlin
@Composable
fun AiAdvisorChatScreen(
    contactId: String,
    viewModel: AiAdvisorChatViewModel = hiltViewModel(),
    onNavigateBack: () -> Unit
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    // åˆå§‹åŒ–åŠ è½½
    LaunchedEffect(contactId) {
        viewModel.loadContact(contactId)
    }
    
    Scaffold(
        topBar = {
            AiAdvisorTopBar(
                contactName = uiState.contactName,
                onNavigateBack = onNavigateBack,
                onContactSelect = { viewModel.showContactSelector() }
            )
        },
        bottomBar = {
            AiAdvisorInputBar(
                inputText = uiState.inputText,
                onInputChange = { viewModel.updateInput(it) },
                onSend = { viewModel.sendMessage() },
                isLoading = uiState.isSending,
                canSend = uiState.canSend
            )
        }
    ) { paddingValues ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
        ) {
            // ä¼šè¯é€‰æ‹©å™¨ï¼ˆå¤šä¼šè¯æ—¶æ˜¾ç¤ºï¼‰
            if (uiState.hasMultipleSessions) {
                SessionSelector(
                    sessions = uiState.sessions,
                    currentSessionId = uiState.currentSessionId,
                    onSessionSelect = { viewModel.switchSession(it) },
                    onNewSession = { viewModel.createNewSession() }
                )
            }
            
            // å¯¹è¯åˆ—è¡¨
            LazyColumn(
                modifier = Modifier.weight(1f),
                reverseLayout = true,
                contentPadding = PaddingValues(16.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                items(
                    items = uiState.conversations.reversed(),
                    key = { it.id }
                ) { conversation ->
                    AdvisorMessageBubble(
                        conversation = conversation,
                        onRetry = { viewModel.retryMessage(it) },
                        onDelete = { viewModel.deleteMessage(it) }
                    )
                }
            }
            
            // é”™è¯¯æç¤º
            if (uiState.hasError) {
                ErrorSnackbar(
                    error = uiState.error!!,
                    onDismiss = { viewModel.clearError() },
                    onRetry = if (uiState.isErrorRetryable) {
                        { viewModel.sendMessage() }
                    } else null
                )
            }
        }
    }
    
    // è”ç³»äººé€‰æ‹©å¯¹è¯æ¡†
    if (uiState.showContactSelector) {
        ContactSelectorDialog(
            contacts = uiState.allContacts,
            currentContactId = contactId,
            onSelect = { viewModel.switchContact(it) },
            onDismiss = { viewModel.hideContactSelector() }
        )
    }
    
    // åˆ‡æ¢ç¡®è®¤å¯¹è¯æ¡†
    if (uiState.showSwitchConfirmDialog) {
        SwitchConfirmDialog(
            onConfirm = { viewModel.confirmSwitch() },
            onDismiss = { viewModel.cancelSwitch() }
        )
    }
}
```

#### 6.3.2 AdvisorMessageBubble

**æ–‡ä»¶ä½ç½®**ï¼š`:presentation/ui/screen/advisor/component/AdvisorMessageBubble.kt`

```kotlin
@Composable
fun AdvisorMessageBubble(
    conversation: AiAdvisorConversation,
    onRetry: (String) -> Unit,
    onDelete: (String) -> Unit
) {
    val isAi = conversation.messageType == MessageType.AI
    val isFailed = conversation.sendStatus == SendStatus.FAILED
    
    // å¤±è´¥æ¶ˆæ¯ä½¿ç”¨ç‰¹æ®Šæ ·å¼
    if (isFailed) {
        FailedMessageBubble(
            content = conversation.content,
            onRetry = { onRetry(conversation.content) },
            onDelete = { onDelete(conversation.id) }
        )
        return
    }
    
    val alignment = if (isAi) Alignment.Start else Alignment.End
    val backgroundColor = if (isAi) {
        MaterialTheme.colorScheme.surfaceVariant
    } else {
        MaterialTheme.colorScheme.primaryContainer
    }
    val bubbleShape = if (isAi) {
        RoundedCornerShape(4.dp, 16.dp, 16.dp, 16.dp)
    } else {
        RoundedCornerShape(16.dp, 4.dp, 16.dp, 16.dp)
    }
    
    Column(
        modifier = Modifier.fillMaxWidth(),
        horizontalAlignment = alignment
    ) {
        // è§’è‰²æ ‡ç­¾
        Row(
            verticalAlignment = Alignment.CenterVertically,
            modifier = Modifier.padding(bottom = 4.dp)
        ) {
            if (isAi) {
                Icon(
                    imageVector = Icons.Default.Psychology,
                    contentDescription = null,
                    modifier = Modifier.size(16.dp),
                    tint = MaterialTheme.colorScheme.primary
                )
                Spacer(modifier = Modifier.width(4.dp))
            }
            Text(
                text = if (isAi) "AIå†›å¸ˆ" else "æˆ‘",
                style = MaterialTheme.typography.labelSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Text(
                text = " Â· ${formatTime(conversation.timestamp)}",
                style = MaterialTheme.typography.labelSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
        
        // æ¶ˆæ¯æ°”æ³¡
        Surface(
            shape = bubbleShape,
            color = backgroundColor,
            modifier = Modifier.widthIn(max = 300.dp)
        ) {
            SelectionContainer {
                Text(
                    text = conversation.content,
                    style = MaterialTheme.typography.bodyMedium,
                    modifier = Modifier.padding(12.dp)
                )
            }
        }
    }
}

private fun formatTime(timestamp: Long): String {
    val sdf = java.text.SimpleDateFormat("HH:mm", java.util.Locale.getDefault())
    return sdf.format(java.util.Date(timestamp))
}
```


#### 6.3.3 ErrorStateView

**æ–‡ä»¶ä½ç½®**ï¼š`:presentation/ui/screen/advisor/component/ErrorStateView.kt`

```kotlin
@Composable
fun ErrorStateView(
    error: AiAdvisorError,
    onRetry: () -> Unit,
    onNavigateToSettings: () -> Unit,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxWidth()
            .padding(16.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        // é”™è¯¯å›¾æ ‡
        Icon(
            imageVector = when (error) {
                is AiAdvisorError.NetworkError -> Icons.Default.WifiOff
                is AiAdvisorError.ApiError -> Icons.Default.Error
                is AiAdvisorError.ConfigError -> Icons.Default.Settings
                is AiAdvisorError.TimeoutError -> Icons.Default.Timer
                else -> Icons.Default.Warning
            },
            contentDescription = null,
            modifier = Modifier.size(48.dp),
            tint = MaterialTheme.colorScheme.error
        )
        
        Spacer(modifier = Modifier.height(16.dp))
        
        // é”™è¯¯æ¶ˆæ¯
        Text(
            text = error.message,
            style = MaterialTheme.typography.bodyLarge,
            textAlign = TextAlign.Center,
            color = MaterialTheme.colorScheme.onSurface
        )
        
        Spacer(modifier = Modifier.height(24.dp))
        
        // æ“ä½œæŒ‰é’®
        when (error) {
            is AiAdvisorError.ConfigError -> {
                Button(onClick = onNavigateToSettings) {
                    Icon(Icons.Default.Settings, contentDescription = null)
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("å»é…ç½®")
                }
            }
            else -> {
                if (error.isRetryable) {
                    Button(onClick = onRetry) {
                        Icon(Icons.Default.Refresh, contentDescription = null)
                        Spacer(modifier = Modifier.width(8.dp))
                        Text("é‡è¯•")
                    }
                }
            }
        }
    }
}
```

#### 6.3.4 FailedMessageBubble

**æ–‡ä»¶ä½ç½®**ï¼š`:presentation/ui/screen/advisor/component/FailedMessageBubble.kt`

```kotlin
@Composable
fun FailedMessageBubble(
    content: String,
    onRetry: () -> Unit,
    onDelete: () -> Unit,
    modifier: Modifier = Modifier
) {
    Row(
        modifier = modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.End,
        verticalAlignment = Alignment.CenterVertically
    ) {
        // é‡è¯•æŒ‰é’®
        IconButton(onClick = onRetry) {
            Icon(
                imageVector = Icons.Default.Refresh,
                contentDescription = "é‡è¯•",
                tint = MaterialTheme.colorScheme.error
            )
        }
        
        // æ¶ˆæ¯æ°”æ³¡ï¼ˆå¸¦é”™è¯¯è¾¹æ¡†ï¼‰
        Surface(
            shape = RoundedCornerShape(16.dp, 4.dp, 16.dp, 16.dp),
            color = MaterialTheme.colorScheme.errorContainer,
            border = BorderStroke(1.dp, MaterialTheme.colorScheme.error),
            modifier = Modifier.widthIn(max = 280.dp)
        ) {
            Column(modifier = Modifier.padding(12.dp)) {
                Text(
                    text = content,
                    style = MaterialTheme.typography.bodyMedium
                )
                Spacer(modifier = Modifier.height(4.dp))
                Text(
                    text = "å‘é€å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•",
                    style = MaterialTheme.typography.labelSmall,
                    color = MaterialTheme.colorScheme.error
                )
            }
        }
    }
}
```

---

## 7. ä¾èµ–æ³¨å…¥é…ç½®

### 7.1 AiAdvisorModule

**æ–‡ä»¶ä½ç½®**ï¼š`:app/di/AiAdvisorModule.kt`

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object AiAdvisorModule {
    
    @Provides
    @Singleton
    fun provideAiAdvisorDao(database: AppDatabase): AiAdvisorDao {
        return database.aiAdvisorDao()
    }
    
    @Provides
    @Singleton
    fun provideAiAdvisorRepository(
        dao: AiAdvisorDao,
        @IoDispatcher dispatcher: CoroutineDispatcher
    ): AiAdvisorRepository {
        return AiAdvisorRepositoryImpl(dao, dispatcher)
    }
    
    @Provides
    fun provideCreateAdvisorSessionUseCase(
        repository: AiAdvisorRepository
    ): CreateAdvisorSessionUseCase {
        return CreateAdvisorSessionUseCase(repository)
    }
    
    @Provides
    fun provideSendAdvisorMessageUseCase(
        aiAdvisorRepository: AiAdvisorRepository,
        aiRepository: AiRepository,
        contactRepository: ContactRepository,
        conversationRepository: ConversationRepository,
        aiProviderRepository: AiProviderRepository
    ): SendAdvisorMessageUseCase {
        return SendAdvisorMessageUseCase(
            aiAdvisorRepository,
            aiRepository,
            contactRepository,
            conversationRepository,
            aiProviderRepository
        )
    }
    
    @Provides
    fun provideGetAdvisorSessionsUseCase(
        repository: AiAdvisorRepository
    ): GetAdvisorSessionsUseCase {
        return GetAdvisorSessionsUseCase(repository)
    }
    
    @Provides
    fun provideGetAdvisorConversationsUseCase(
        repository: AiAdvisorRepository
    ): GetAdvisorConversationsUseCase {
        return GetAdvisorConversationsUseCase(repository)
    }
    
    @Provides
    fun provideDeleteAdvisorConversationUseCase(
        repository: AiAdvisorRepository
    ): DeleteAdvisorConversationUseCase {
        return DeleteAdvisorConversationUseCase(repository)
    }
}
```


---

## 8. æµ‹è¯•è®¾è®¡

### 8.1 å•å…ƒæµ‹è¯•

| æµ‹è¯•ç±» | æµ‹è¯•å†…å®¹ | ä¼˜å…ˆçº§ |
|-------|---------|-------|
| `AiAdvisorSessionTest` | ä¼šè¯æ¨¡å‹åˆ›å»ºã€å±æ€§éªŒè¯ | P0 |
| `AiAdvisorConversationTest` | å¯¹è¯è®°å½•æ¨¡å‹åˆ›å»ºã€çŠ¶æ€è½¬æ¢ | P0 |
| `AiAdvisorErrorTest` | é”™è¯¯ç±»å‹åˆ›å»ºã€å¼‚å¸¸è½¬æ¢ | P1 |
| `CreateAdvisorSessionUseCaseTest` | åˆ›å»ºä¼šè¯æˆåŠŸ/å¤±è´¥åœºæ™¯ | P0 |
| `SendAdvisorMessageUseCaseTest` | å‘é€æ¶ˆæ¯å®Œæ•´æµç¨‹ã€AIè°ƒç”¨å¤±è´¥å¤„ç† | P0 |
| `GetAdvisorSessionsUseCaseTest` | è·å–ä¼šè¯åˆ—è¡¨ã€ç©ºåˆ—è¡¨å¤„ç† | P1 |
| `GetAdvisorConversationsUseCaseTest` | è·å–å¯¹è¯è®°å½•ã€Flowå“åº” | P1 |
| `AiAdvisorRepositoryImplTest` | æ•°æ®åº“CRUDæ“ä½œ | P0 |
| `AiAdvisorViewModelTest` | UIçŠ¶æ€ç®¡ç†ã€è”ç³»äººåŠ è½½ | P1 |
| `AiAdvisorChatViewModelTest` | å¯¹è¯æµç¨‹ã€ä¼šè¯åˆ‡æ¢ã€è”ç³»äººåˆ‡æ¢ | P0 |

### 8.2 æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

#### 8.2.1 SendAdvisorMessageUseCaseTest

```kotlin
@ExperimentalCoroutinesApi
class SendAdvisorMessageUseCaseTest {
    
    @get:Rule
    val mainDispatcherRule = MainDispatcherRule()
    
    private lateinit var useCase: SendAdvisorMessageUseCase
    private lateinit var aiAdvisorRepository: AiAdvisorRepository
    private lateinit var aiRepository: AiRepository
    private lateinit var contactRepository: ContactRepository
    private lateinit var conversationRepository: ConversationRepository
    private lateinit var aiProviderRepository: AiProviderRepository
    
    @Before
    fun setup() {
        aiAdvisorRepository = mockk()
        aiRepository = mockk()
        contactRepository = mockk()
        conversationRepository = mockk()
        aiProviderRepository = mockk()
        
        useCase = SendAdvisorMessageUseCase(
            aiAdvisorRepository,
            aiRepository,
            contactRepository,
            conversationRepository,
            aiProviderRepository
        )
    }
    
    @Test
    fun `å‘é€æ¶ˆæ¯æˆåŠŸæ—¶è¿”å›AIå›å¤`() = runTest {
        // Given
        val sessionId = "session-1"
        val contactId = "contact-1"
        val message = "å¸®æˆ‘åˆ†æä¸€ä¸‹"
        val aiResponse = "æ ¹æ®åˆ†æ..."
        
        coEvery { aiAdvisorRepository.saveMessage(any()) } returns Result.success(mockk())
        coEvery { contactRepository.getContactById(contactId) } returns Result.success(mockk())
        coEvery { conversationRepository.getConversationsByContact(contactId) } returns Result.success(emptyList())
        coEvery { aiAdvisorRepository.getConversations(sessionId) } returns Result.success(emptyList())
        coEvery { aiProviderRepository.getDefaultProvider() } returns Result.success(mockk())
        coEvery { aiRepository.chat(any(), any(), any()) } returns Result.success(mockk {
            every { content } returns aiResponse
        })
        
        // When
        val result = useCase(sessionId, contactId, message)
        
        // Then
        assertTrue(result.isSuccess)
        assertEquals(aiResponse, result.getOrNull()?.content)
    }
    
    @Test
    fun `æœªé…ç½®AIæœåŠ¡å•†æ—¶è¿”å›é”™è¯¯`() = runTest {
        // Given
        val sessionId = "session-1"
        val contactId = "contact-1"
        val message = "å¸®æˆ‘åˆ†æä¸€ä¸‹"
        
        coEvery { aiAdvisorRepository.saveMessage(any()) } returns Result.success(mockk())
        coEvery { aiProviderRepository.getDefaultProvider() } returns Result.success(null)
        
        // When
        val result = useCase(sessionId, contactId, message)
        
        // Then
        assertTrue(result.isFailure)
        assertTrue(result.exceptionOrNull()?.message?.contains("æœªé…ç½®") == true)
    }
    
    @Test
    fun `AIè°ƒç”¨å¤±è´¥æ—¶è¿”å›é”™è¯¯`() = runTest {
        // Given
        val sessionId = "session-1"
        val contactId = "contact-1"
        val message = "å¸®æˆ‘åˆ†æä¸€ä¸‹"
        
        coEvery { aiAdvisorRepository.saveMessage(any()) } returns Result.success(mockk())
        coEvery { contactRepository.getContactById(contactId) } returns Result.success(mockk())
        coEvery { conversationRepository.getConversationsByContact(contactId) } returns Result.success(emptyList())
        coEvery { aiAdvisorRepository.getConversations(sessionId) } returns Result.success(emptyList())
        coEvery { aiProviderRepository.getDefaultProvider() } returns Result.success(mockk())
        coEvery { aiRepository.chat(any(), any(), any()) } returns Result.failure(Exception("APIé”™è¯¯"))
        
        // When
        val result = useCase(sessionId, contactId, message)
        
        // Then
        assertTrue(result.isFailure)
    }
}
```

### 8.3 é›†æˆæµ‹è¯•

| æµ‹è¯•åœºæ™¯ | éªŒè¯ç‚¹ | ä¼˜å…ˆçº§ |
|---------|-------|-------|
| å®Œæ•´å¯¹è¯æµç¨‹ | åˆ›å»ºä¼šè¯ â†’ å‘é€æ¶ˆæ¯ â†’ AIå›å¤ â†’ æ˜¾ç¤ºå¯¹è¯ | P0 |
| è”ç³»äººåˆ‡æ¢ | åˆ‡æ¢ç¡®è®¤ â†’ ä¿å­˜å½“å‰å¯¹è¯ â†’ åŠ è½½æ–°è”ç³»äººå¯¹è¯ | P1 |
| ä¼šè¯ç®¡ç† | åˆ›å»ºæ–°ä¼šè¯ â†’ åˆ‡æ¢ä¼šè¯ â†’ åˆ é™¤ä¼šè¯ | P1 |
| æ•°æ®æŒä¹…åŒ– | é€€å‡ºåº”ç”¨ â†’ é‡æ–°è¿›å…¥ â†’ å¯¹è¯å†å²æ¢å¤ | P0 |
| é”™è¯¯æ¢å¤ | ç½‘ç»œé”™è¯¯ â†’ æ˜¾ç¤ºé”™è¯¯ â†’ é‡è¯•æˆåŠŸ | P1 |

### 8.4 æ•°æ®åº“è¿ç§»æµ‹è¯•

```kotlin
@RunWith(AndroidJUnit4::class)
class Migration12To13Test {
    
    @get:Rule
    val helper = MigrationTestHelper(
        InstrumentationRegistry.getInstrumentation(),
        AppDatabase::class.java
    )
    
    @Test
    fun migrate12To13() {
        // åˆ›å»ºv12æ•°æ®åº“
        helper.createDatabase(TEST_DB, 12).apply {
            close()
        }
        
        // æ‰§è¡Œè¿ç§»
        helper.runMigrationsAndValidate(TEST_DB, 13, true, MIGRATION_12_13)
        
        // éªŒè¯è¡¨ç»“æ„
        val db = helper.openDatabase(TEST_DB, 13)
        
        // éªŒè¯ai_advisor_sessionsè¡¨
        val sessionsCursor = db.query("SELECT * FROM ai_advisor_sessions")
        assertTrue(sessionsCursor.columnNames.contains("id"))
        assertTrue(sessionsCursor.columnNames.contains("contact_id"))
        assertTrue(sessionsCursor.columnNames.contains("title"))
        sessionsCursor.close()
        
        // éªŒè¯ai_advisor_conversationsè¡¨
        val convCursor = db.query("SELECT * FROM ai_advisor_conversations")
        assertTrue(convCursor.columnNames.contains("id"))
        assertTrue(convCursor.columnNames.contains("session_id"))
        assertTrue(convCursor.columnNames.contains("message_type"))
        convCursor.close()
        
        db.close()
    }
    
    companion object {
        private const val TEST_DB = "migration-test"
    }
}
```


---

## 9. æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|-------|---------|
| å¯¹è¯åŠ è½½æ—¶é—´ | < 200ms | ä»ç‚¹å‡»è”ç³»äººåˆ°æ˜¾ç¤ºå¯¹è¯åˆ—è¡¨ |
| æ¶ˆæ¯å‘é€å“åº”æ—¶é—´ | < 500ms | ä»ç‚¹å‡»å‘é€åˆ°æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ |
| AIå›å¤æ—¶é—´ | < 5s | ä»å‘é€åˆ°æ˜¾ç¤ºAIå›å¤ï¼ˆå–å†³äºAIæœåŠ¡ï¼‰ |
| è”ç³»äººåˆ‡æ¢æ—¶é—´ | < 300ms | ä»ç¡®è®¤åˆ‡æ¢åˆ°æ˜¾ç¤ºæ–°è”ç³»äººå¯¹è¯ |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | < 100ms | å•æ¬¡æŸ¥è¯¢æ“ä½œ |
| å†…å­˜å ç”¨ | < 50MB | AIå†›å¸ˆåŠŸèƒ½è¿è¡Œæ—¶å¢é‡å†…å­˜ |
| åˆ—è¡¨æ»šåŠ¨å¸§ç‡ | â‰¥ 60fps | å¯¹è¯åˆ—è¡¨æ»šåŠ¨æµç•…åº¦ |

---

## 10. æ–‡ä»¶æ¸…å•

### 10.1 æ–°å¢æ–‡ä»¶

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|---------|------|
| :domain | `model/AiAdvisorSession.kt` | ä¼šè¯é¢†åŸŸæ¨¡å‹ |
| :domain | `model/AiAdvisorConversation.kt` | å¯¹è¯è®°å½•é¢†åŸŸæ¨¡å‹ |
| :domain | `model/MessageType.kt` | æ¶ˆæ¯ç±»å‹æšä¸¾ |
| :domain | `model/SendStatus.kt` | å‘é€çŠ¶æ€æšä¸¾ |
| :domain | `model/AiAdvisorError.kt` | é”™è¯¯ç±»å‹å¯†å°ç±» |
| :domain | `repository/AiAdvisorRepository.kt` | ä»“åº“æ¥å£ |
| :domain | `usecase/CreateAdvisorSessionUseCase.kt` | åˆ›å»ºä¼šè¯ç”¨ä¾‹ |
| :domain | `usecase/SendAdvisorMessageUseCase.kt` | å‘é€æ¶ˆæ¯ç”¨ä¾‹ |
| :domain | `usecase/GetAdvisorSessionsUseCase.kt` | è·å–ä¼šè¯åˆ—è¡¨ç”¨ä¾‹ |
| :domain | `usecase/GetAdvisorConversationsUseCase.kt` | è·å–å¯¹è¯è®°å½•ç”¨ä¾‹ |
| :domain | `usecase/DeleteAdvisorConversationUseCase.kt` | åˆ é™¤å¯¹è¯ç”¨ä¾‹ |
| :data | `local/entity/AiAdvisorSessionEntity.kt` | ä¼šè¯æ•°æ®åº“å®ä½“ |
| :data | `local/entity/AiAdvisorConversationEntity.kt` | å¯¹è¯æ•°æ®åº“å®ä½“ |
| :data | `local/dao/AiAdvisorDao.kt` | æ•°æ®è®¿é—®å¯¹è±¡ |
| :data | `repository/AiAdvisorRepositoryImpl.kt` | ä»“åº“å®ç° |
| :presentation | `ui/screen/advisor/AiAdvisorScreen.kt` | ä¸»ç•Œé¢ |
| :presentation | `ui/screen/advisor/AiAdvisorChatScreen.kt` | å¯¹è¯ç•Œé¢ |
| :presentation | `ui/screen/advisor/component/AdvisorMessageBubble.kt` | æ¶ˆæ¯æ°”æ³¡ç»„ä»¶ |
| :presentation | `ui/screen/advisor/component/SessionSelector.kt` | ä¼šè¯é€‰æ‹©å™¨ç»„ä»¶ |
| :presentation | `ui/screen/advisor/component/ContactSelectorDialog.kt` | è”ç³»äººé€‰æ‹©å¯¹è¯æ¡† |
| :presentation | `ui/screen/advisor/component/AiAdvisorInputBar.kt` | è¾“å…¥æ ç»„ä»¶ |
| :presentation | `ui/screen/advisor/component/ErrorStateView.kt` | é”™è¯¯çŠ¶æ€ç»„ä»¶ |
| :presentation | `ui/screen/advisor/component/FailedMessageBubble.kt` | å¤±è´¥æ¶ˆæ¯ç»„ä»¶ |
| :presentation | `viewmodel/AiAdvisorViewModel.kt` | ä¸»ç•Œé¢ViewModel |
| :presentation | `viewmodel/AiAdvisorChatViewModel.kt` | å¯¹è¯ç•Œé¢ViewModel |
| :app | `di/AiAdvisorModule.kt` | ä¾èµ–æ³¨å…¥æ¨¡å— |

### 10.2 ä¿®æ”¹æ–‡ä»¶

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|------|---------|---------|
| :domain | `util/SystemPrompts.kt` | æ–°å¢AI_ADVISOR_HEADERå’ŒAI_ADVISOR_FOOTERå¸¸é‡ |
| :data | `local/AppDatabase.kt` | æ–°å¢AiAdvisorDaoã€Entityï¼Œç‰ˆæœ¬å‡çº§åˆ°v13 |
| :data | `local/DatabaseMigrations.kt` | æ–°å¢MIGRATION_12_13 |
| :presentation | `navigation/NavGraph.kt` | æ–°å¢AIå†›å¸ˆå¯¼èˆªè·¯ç”± |
| :presentation | `navigation/NavRoutes.kt` | æ–°å¢AI_ADVISORè·¯ç”±å¸¸é‡ |
| :presentation | `ui/component/BottomNavBar.kt` | æ–°å¢AIå†›å¸ˆå¯¼èˆªé¡¹ |
| :app | `src/main/res/values/strings.xml` | æ–°å¢AIå†›å¸ˆåŠŸèƒ½ç›¸å…³å­—ç¬¦ä¸²èµ„æº |
| :app | `src/main/AndroidManifest.xml` | ç¡®è®¤ç½‘ç»œæƒé™å£°æ˜ |

### 10.3 æ–°å¢èµ„æºæ–‡ä»¶

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|---------|------|
| :presentation | `util/PermissionChecker.kt` | æƒé™æ£€æŸ¥å·¥å…·ç±» |
| :presentation | `util/AiAdvisorPerformanceMonitor.kt` | æ€§èƒ½ç›‘æ§å·¥å…· |
| :domain | `util/ConversationSecurityHandler.kt` | å¯¹è¯å®‰å…¨å¤„ç†å·¥å…· |
| :domain | `util/LocalizedSystemPrompts.kt` | å›½é™…åŒ–æç¤ºè¯æ”¯æŒ |

---

## 11. å·²çŸ¥é™åˆ¶ä¸åç»­ä¼˜åŒ–

### 11.1 å½“å‰ç‰ˆæœ¬é™åˆ¶

| é™åˆ¶é¡¹ | å½“å‰å®ç° | åŸå›  | å½±å“ |
|-------|---------|------|------|
| å†å²å¯¹è¯è®°å½•æ¡æ•° | æœ€è¿‘20æ¡ | AIæ¨¡å‹Context Windowé™åˆ¶ | æ— æ³•åˆ†æå®Œæ•´å¯¹è¯å†å² |
| ä¼šè¯ä¸Šä¸‹æ–‡æ¡æ•° | æœ€è¿‘10æ¡ | æ§åˆ¶Tokenæ¶ˆè€— | é•¿å¯¹è¯å¯èƒ½ä¸¢å¤±æ—©æœŸä¸Šä¸‹æ–‡ |
| å•æ¬¡åˆ†ææ·±åº¦ | åŸºäºæ–‡æœ¬æ‘˜è¦ | æ— RAGæ”¯æŒ | æ— æ³•è¿›è¡Œè¯­ä¹‰ç›¸å…³æ€§æ£€ç´¢ |
| ç¦»çº¿æ”¯æŒ | æ—  | ä¾èµ–äº‘ç«¯AI | ç½‘ç»œä¸å¯ç”¨æ—¶æ— æ³•ä½¿ç”¨ |

### 11.2 åç»­ä¼˜åŒ–æ–¹å‘

#### 11.2.1 çŸ­æœŸä¼˜åŒ–ï¼ˆv1.1ï¼‰

| ä¼˜åŒ–é¡¹ | æè¿° | é¢„æœŸæ”¶ç›Š |
|-------|------|---------|
| æ™ºèƒ½å†å²é€‰æ‹© | æ ¹æ®ç”¨æˆ·é—®é¢˜å…³é”®è¯ï¼ŒåŠ¨æ€é€‰æ‹©ç›¸å…³å†å²è®°å½• | æé«˜åˆ†æç›¸å…³æ€§ |
| å†å²æ‘˜è¦ç”Ÿæˆ | ä½¿ç”¨AIç”Ÿæˆå†å²å¯¹è¯æ‘˜è¦ï¼Œå‹ç¼©ä¸Šä¸‹æ–‡ | åœ¨æœ‰é™Tokenå†…åŒ…å«æ›´å¤šä¿¡æ¯ |
| åˆ†é¡µåŠ è½½ä¼˜åŒ– | å¯¹è¯åˆ—è¡¨åˆ†é¡µåŠ è½½ï¼Œå‡å°‘å†…å­˜å ç”¨ | æå‡å¤§é‡å¯¹è¯æ—¶çš„æ€§èƒ½ |
| ç¼“å­˜æœºåˆ¶ | è”ç³»äººç”»åƒç¼“å­˜ï¼Œå‡å°‘é‡å¤æŸ¥è¯¢ | æå‡å“åº”é€Ÿåº¦ |

#### 11.2.2 ä¸­æœŸä¼˜åŒ–ï¼ˆv2.0ï¼‰

| ä¼˜åŒ–é¡¹ | æè¿° | é¢„æœŸæ”¶ç›Š |
|-------|------|---------|
| RAGé›†æˆ | å¼•å…¥æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ŒæŒ‰è¯­ä¹‰ç›¸å…³æ€§æ£€ç´¢å†å² | çªç ´Context Windowé™åˆ¶ |
| å‘é‡æ•°æ®åº“ | ä½¿ç”¨æœ¬åœ°å‘é‡æ•°æ®åº“å­˜å‚¨å¯¹è¯åµŒå…¥ | æ”¯æŒè¯­ä¹‰æœç´¢ |
| å¤šè½®å¯¹è¯ä¼˜åŒ– | ä¼˜åŒ–é•¿å¯¹è¯çš„ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥ | æå‡é•¿å¯¹è¯ä½“éªŒ |
| ç¦»çº¿æ¨¡å¼ | æ”¯æŒç¦»çº¿æŸ¥çœ‹å†å²å¯¹è¯ | æå‡å¯ç”¨æ€§ |

#### 11.2.3 é•¿æœŸä¼˜åŒ–ï¼ˆv3.0ï¼‰

| ä¼˜åŒ–é¡¹ | æè¿° | é¢„æœŸæ”¶ç›Š |
|-------|------|---------|
| æœ¬åœ°æ¨¡å‹æ”¯æŒ | æ”¯æŒæœ¬åœ°è¿è¡Œçš„å°å‹LLM | ç¦»çº¿ä½¿ç”¨ã€éšç§å¢å¼º |
| å¤šæ¨¡æ€åˆ†æ | æ”¯æŒå›¾ç‰‡ã€è¯­éŸ³ç­‰å¤šæ¨¡æ€è¾“å…¥ | æ›´ä¸°å¯Œçš„åˆ†æèƒ½åŠ› |
| å…³ç³»å›¾è°± | æ„å»ºè”ç³»äººå…³ç³»çŸ¥è¯†å›¾è°± | æ›´æ·±åº¦çš„å…³ç³»æ´å¯Ÿ |

### 11.3 æŠ€æœ¯å€ºåŠ¡è®°å½•

| å€ºåŠ¡é¡¹ | æè¿° | ä¼˜å…ˆçº§ | è®¡åˆ’è§£å†³ç‰ˆæœ¬ |
|-------|------|-------|-------------|
| ç¡¬ç¼–ç é™åˆ¶å¸¸é‡ | HISTORY_LIMITç­‰å¸¸é‡åº”å¯é…ç½® | P2 | v1.1 |
| ç¼ºå°‘ç¼“å­˜æœºåˆ¶ | è”ç³»äººç”»åƒæ¯æ¬¡éƒ½é‡æ–°æŸ¥è¯¢ | P2 | v1.1 |
| æ— ç¦»çº¿æ”¯æŒ | ç½‘ç»œä¸å¯ç”¨æ—¶æ— æ³•ä½¿ç”¨ | P3 | v2.0 |
| æ— æ¶ˆæ¯æ’¤å› | ç”¨æˆ·æ— æ³•æ’¤å›å·²å‘é€çš„æ¶ˆæ¯ | P3 | v1.2 |

---

## 12. å®ç°è®¡åˆ’

### é˜¶æ®µ1ï¼šæ•°æ®å±‚å®ç°ï¼ˆé¢„è®¡1å¤©ï¼‰

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| åˆ›å»ºé¢†åŸŸæ¨¡å‹ï¼ˆAiAdvisorSessionã€AiAdvisorConversationã€MessageTypeç­‰ï¼‰ | 1h | P0 |
| åˆ›å»ºæ•°æ®åº“å®ä½“å’ŒDAO | 2h | P0 |
| å®ç°æ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆv12â†’v13ï¼‰ | 1h | P0 |
| åˆ›å»ºRepositoryæ¥å£å’Œå®ç° | 2h | P0 |
| ç¼–å†™æ•°æ®å±‚å•å…ƒæµ‹è¯• | 2h | P1 |

### é˜¶æ®µ2ï¼šé¢†åŸŸå±‚å®ç°ï¼ˆé¢„è®¡1å¤©ï¼‰

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| å®ç°CreateAdvisorSessionUseCase | 0.5h | P0 |
| å®ç°SendAdvisorMessageUseCaseï¼ˆæ ¸å¿ƒï¼‰ | 3h | P0 |
| å®ç°GetAdvisorSessionsUseCase | 0.5h | P0 |
| å®ç°GetAdvisorConversationsUseCase | 0.5h | P0 |
| å®ç°DeleteAdvisorConversationUseCase | 0.5h | P1 |
| æ‰©å±•SystemPromptsæ·»åŠ AIå†›å¸ˆæç¤ºè¯ | 1h | P0 |
| ç¼–å†™é¢†åŸŸå±‚å•å…ƒæµ‹è¯• | 2h | P1 |

### é˜¶æ®µ3ï¼šç•Œé¢å±‚å®ç°ï¼ˆé¢„è®¡1.5å¤©ï¼‰

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| å®ç°AiAdvisorScreenä¸»ç•Œé¢ | 2h | P0 |
| å®ç°AiAdvisorChatScreenå¯¹è¯ç•Œé¢ | 3h | P0 |
| å®ç°æ¶ˆæ¯æ°”æ³¡ç»„ä»¶ï¼ˆå«å¤±è´¥çŠ¶æ€ï¼‰ | 1.5h | P0 |
| å®ç°ä¼šè¯é€‰æ‹©å™¨ç»„ä»¶ | 1h | P1 |
| å®ç°è”ç³»äººé€‰æ‹©å¯¹è¯æ¡† | 1h | P0 |
| å®ç°è¾“å…¥æ ç»„ä»¶ | 1h | P0 |
| å®ç°é”™è¯¯çŠ¶æ€ç»„ä»¶ | 0.5h | P0 |
| é›†æˆåˆ°åº•éƒ¨å¯¼èˆªæ  | 1h | P0 |
| ç¼–å†™ViewModel | 2h | P0 |

### é˜¶æ®µ4ï¼šé›†æˆæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆé¢„è®¡0.5å¤©ï¼‰

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯• | 2h | P0 |
| æ•°æ®åº“è¿ç§»æµ‹è¯• | 1h | P0 |
| æ€§èƒ½ä¼˜åŒ– | 1h | P1 |
| é”™è¯¯å¤„ç†å®Œå–„ | 1h | P0 |
| ç”¨æˆ·ä½“éªŒä¼˜åŒ– | 1h | P1 |

**æ€»é¢„è®¡å·¥ä½œé‡**ï¼š4å¤©

---

## 13. èµ„æºä¸æƒé™é…ç½®

### 13.1 å­—ç¬¦ä¸²èµ„æºå®šä¹‰

**æ–‡ä»¶ä½ç½®**ï¼š`app/src/main/res/values/strings.xml`

```xml
<!-- ============================================================ -->
<!-- AIå†›å¸ˆåŠŸèƒ½ç›¸å…³å­—ç¬¦ä¸²èµ„æº (TDD-00026)                          -->
<!-- ============================================================ -->

<!-- å¯¼èˆªå’Œæ ‡é¢˜ -->
<string name="ai_advisor_title">AIå†›å¸ˆ</string>
<string name="ai_advisor_subtitle">æ·±åº¦åˆ†æä¸ç­–ç•¥å»ºè®®</string>

<!-- ä¼šè¯ç®¡ç† -->
<string name="ai_advisor_new_session">æ–°å¯¹è¯</string>
<string name="ai_advisor_session_title_default">æ–°å¯¹è¯</string>
<string name="ai_advisor_session_empty">è¿˜æ²¡æœ‰å¯¹è¯è®°å½•</string>
<string name="ai_advisor_session_delete_confirm">ç¡®å®šåˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ</string>

<!-- è”ç³»äººé€‰æ‹© -->
<string name="ai_advisor_contact_selector">é€‰æ‹©è”ç³»äºº</string>
<string name="ai_advisor_contact_switch">åˆ‡æ¢è”ç³»äºº</string>
<string name="ai_advisor_contact_switch_confirm">åˆ‡æ¢è”ç³»äººå°†å¼€å§‹æ–°çš„å¯¹è¯ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ</string>
<string name="ai_advisor_no_contacts">è¿˜æ²¡æœ‰è”ç³»äºº\nå…ˆæ·»åŠ è”ç³»äººå†æ¥æ‰¾AIå†›å¸ˆèŠèŠ</string>

<!-- æ¶ˆæ¯è¾“å…¥ -->
<string name="ai_advisor_input_hint">è¾“å…¥ä½ çš„é—®é¢˜...</string>
<string name="ai_advisor_send">å‘é€</string>
<string name="ai_advisor_sending">å‘é€ä¸­...</string>

<!-- æ¶ˆæ¯çŠ¶æ€ -->
<string name="ai_advisor_message_failed">å‘é€å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•</string>
<string name="ai_advisor_retry">é‡è¯•</string>
<string name="ai_advisor_copy">å¤åˆ¶</string>
<string name="ai_advisor_delete">åˆ é™¤</string>
<string name="ai_advisor_copied">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</string>

<!-- è§’è‰²æ ‡ç­¾ -->
<string name="ai_advisor_role_user">æˆ‘</string>
<string name="ai_advisor_role_ai">AIå†›å¸ˆ</string>

<!-- é”™è¯¯æç¤º -->
<string name="ai_advisor_error_network">ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</string>
<string name="ai_advisor_error_api">AIæš‚æ—¶æ— æ³•å›å¤ï¼Œè¯·ç¨åé‡è¯•</string>
<string name="ai_advisor_error_config">è¯·å…ˆé…ç½®AIæœåŠ¡å•†</string>
<string name="ai_advisor_error_timeout">AIå“åº”è¶…æ—¶ï¼Œè¯·é‡è¯•</string>
<string name="ai_advisor_error_database">æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•</string>
<string name="ai_advisor_error_contact_not_found">è”ç³»äººä¸å­˜åœ¨</string>
<string name="ai_advisor_error_unknown">å‘ç”ŸæœªçŸ¥é”™è¯¯</string>

<!-- æŒ‰é’®æ–‡æœ¬ -->
<string name="ai_advisor_go_settings">å»é…ç½®</string>
<string name="ai_advisor_confirm">ç¡®å®š</string>
<string name="ai_advisor_cancel">å–æ¶ˆ</string>

<!-- åŠ è½½çŠ¶æ€ -->
<string name="ai_advisor_loading">åŠ è½½ä¸­...</string>
<string name="ai_advisor_ai_thinking">AIå†›å¸ˆæ­£åœ¨æ€è€ƒ...</string>
```

### 13.2 æƒé™å£°æ˜

**æ–‡ä»¶ä½ç½®**ï¼š`app/src/main/AndroidManifest.xml`

```xml
<!-- ============================================================ -->
<!-- AIå†›å¸ˆåŠŸèƒ½æ‰€éœ€æƒé™ (TDD-00026)                                -->
<!-- ============================================================ -->

<!-- ç½‘ç»œæƒé™ï¼šè°ƒç”¨AIæœåŠ¡å¿…éœ€ -->
<uses-permission android:name="android.permission.INTERNET" />

<!-- ç½‘ç»œçŠ¶æ€æ£€æµ‹ï¼šç”¨äºæ˜¾ç¤ºç½‘ç»œé”™è¯¯æç¤º -->
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

<!-- æ³¨æ„ï¼šä»¥ä¸‹æƒé™ä¸ºå¯é€‰ï¼Œæ ¹æ®å®é™…éœ€æ±‚å¯ç”¨ -->
<!-- 
<uses-permission android:name="android.permission.READ_CONTACTS" />
è¯´æ˜ï¼šå¦‚æœéœ€è¦ä»ç³»ç»Ÿè”ç³»äººå¯¼å…¥ä¿¡æ¯ï¼Œéœ€è¦æ­¤æƒé™
å½“å‰ç‰ˆæœ¬ä¸éœ€è¦ï¼Œè”ç³»äººæ•°æ®å®Œå…¨ç”±åº”ç”¨å†…ç®¡ç†
-->
```

### 13.3 æƒé™æ£€æŸ¥å·¥å…·ç±»

**æ–‡ä»¶ä½ç½®**ï¼š`:presentation/util/PermissionChecker.kt`

```kotlin
/**
 * AIå†›å¸ˆåŠŸèƒ½æƒé™æ£€æŸ¥å·¥å…·
 *
 * ç”¨äºæ£€æŸ¥å’Œè¯·æ±‚AIå†›å¸ˆåŠŸèƒ½æ‰€éœ€çš„æƒé™
 */
object AiAdvisorPermissionChecker {
    
    /**
     * æ£€æŸ¥ç½‘ç»œæ˜¯å¦å¯ç”¨
     *
     * @param context ä¸Šä¸‹æ–‡
     * @return ç½‘ç»œæ˜¯å¦å¯ç”¨
     */
    fun isNetworkAvailable(context: Context): Boolean {
        val connectivityManager = context.getSystemService(
            Context.CONNECTIVITY_SERVICE
        ) as ConnectivityManager
        
        val network = connectivityManager.activeNetwork ?: return false
        val capabilities = connectivityManager.getNetworkCapabilities(network) ?: return false
        
        return capabilities.hasCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET)
    }
    
    /**
     * æ£€æŸ¥AIæœåŠ¡æ˜¯å¦å¯ç”¨
     *
     * @param context ä¸Šä¸‹æ–‡
     * @return æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥ç»“æœ
     */
    suspend fun checkAiServiceAvailability(context: Context): ServiceAvailability {
        // 1. æ£€æŸ¥ç½‘ç»œ
        if (!isNetworkAvailable(context)) {
            return ServiceAvailability.NetworkUnavailable
        }
        
        // 2. æ£€æŸ¥AIæœåŠ¡å•†é…ç½®ï¼ˆç”±ViewModelå¤„ç†ï¼‰
        return ServiceAvailability.Available
    }
}

/**
 * æœåŠ¡å¯ç”¨æ€§çŠ¶æ€
 */
sealed class ServiceAvailability {
    object Available : ServiceAvailability()
    object NetworkUnavailable : ServiceAvailability()
    object ConfigMissing : ServiceAvailability()
    data class Error(val message: String) : ServiceAvailability()
}
```

---

## 14. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 14.1 å¤§æ•°æ®é‡ä¼˜åŒ–

#### 14.1.1 å¯¹è¯åˆ—è¡¨åˆ†é¡µåŠ è½½

```kotlin
/**
 * åˆ†é¡µåŠ è½½å¯¹è¯è®°å½•
 *
 * å½“å¯¹è¯æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œä½¿ç”¨åˆ†é¡µåŠ è½½å‡å°‘å†…å­˜å ç”¨
 */
@Query("""
    SELECT * FROM ai_advisor_conversations 
    WHERE session_id = :sessionId 
    ORDER BY timestamp DESC 
    LIMIT :pageSize OFFSET :offset
""")
suspend fun getConversationsPaged(
    sessionId: String,
    pageSize: Int = 20,
    offset: Int = 0
): List<AiAdvisorConversationEntity>

/**
 * ä½¿ç”¨Paging 3å®ç°æ— é™æ»šåŠ¨
 */
@Query("""
    SELECT * FROM ai_advisor_conversations 
    WHERE session_id = :sessionId 
    ORDER BY timestamp DESC
""")
fun getConversationsPagingSource(sessionId: String): PagingSource<Int, AiAdvisorConversationEntity>
```

#### 14.1.2 è”ç³»äººç”»åƒç¼“å­˜

```kotlin
/**
 * è”ç³»äººç”»åƒç¼“å­˜ç®¡ç†
 *
 * ä½¿ç”¨LRUç¼“å­˜å‡å°‘é‡å¤æ•°æ®åº“æŸ¥è¯¢
 */
class ContactProfileCache @Inject constructor() {
    
    private val cache = LruCache<String, ContactProfile>(maxSize = 10)
    
    /**
     * è·å–è”ç³»äººç”»åƒï¼ˆä¼˜å…ˆä»ç¼“å­˜ï¼‰
     */
    suspend fun getProfile(
        contactId: String,
        loader: suspend () -> ContactProfile?
    ): ContactProfile? {
        // 1. å°è¯•ä»ç¼“å­˜è·å–
        cache.get(contactId)?.let { return it }
        
        // 2. ä»æ•°æ®åº“åŠ è½½
        val profile = loader() ?: return null
        
        // 3. å­˜å…¥ç¼“å­˜
        cache.put(contactId, profile)
        
        return profile
    }
    
    /**
     * æ¸…é™¤æŒ‡å®šè”ç³»äººçš„ç¼“å­˜
     */
    fun invalidate(contactId: String) {
        cache.remove(contactId)
    }
    
    /**
     * æ¸…é™¤æ‰€æœ‰ç¼“å­˜
     */
    fun clear() {
        cache.evictAll()
    }
}
```

### 14.2 UIæ€§èƒ½ä¼˜åŒ–

#### 14.2.1 LazyColumnä¼˜åŒ–

```kotlin
/**
 * å¯¹è¯åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–é…ç½®
 */
@Composable
fun OptimizedConversationList(
    conversations: List<AiAdvisorConversation>,
    modifier: Modifier = Modifier
) {
    LazyColumn(
        modifier = modifier,
        // ä½¿ç”¨ç¨³å®šçš„keyæå‡é‡ç»„æ€§èƒ½
        state = rememberLazyListState(),
        // é¢„åŠ è½½é¡¹æ•°
        contentPadding = PaddingValues(16.dp),
        verticalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        items(
            items = conversations,
            // ä½¿ç”¨å”¯ä¸€IDä½œä¸ºkeyï¼Œé¿å…ä¸å¿…è¦çš„é‡ç»„
            key = { it.id }
        ) { conversation ->
            // ä½¿ç”¨rememberç¼“å­˜è®¡ç®—ç»“æœ
            val formattedTime = remember(conversation.timestamp) {
                formatTime(conversation.timestamp)
            }
            
            AdvisorMessageBubble(
                conversation = conversation,
                formattedTime = formattedTime
            )
        }
    }
}
```

#### 14.2.2 çŠ¶æ€æå‡ä¼˜åŒ–

```kotlin
/**
 * ä½¿ç”¨derivedStateOfå‡å°‘ä¸å¿…è¦çš„é‡ç»„
 */
@Composable
fun AiAdvisorChatScreen(
    viewModel: AiAdvisorChatViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    // ä½¿ç”¨derivedStateOfä¼˜åŒ–æ´¾ç”ŸçŠ¶æ€
    val canSend by remember {
        derivedStateOf { uiState.inputText.isNotBlank() && !uiState.isSending }
    }
    
    val hasMultipleSessions by remember {
        derivedStateOf { uiState.sessions.size > 1 }
    }
    
    // ... UIå®ç°
}
```

### 14.3 æ€§èƒ½ç›‘æ§

```kotlin
/**
 * AIå†›å¸ˆåŠŸèƒ½æ€§èƒ½ç›‘æ§
 */
object AiAdvisorPerformanceMonitor {
    
    private const val TAG = "AiAdvisorPerf"
    
    /**
     * è®°å½•å¯¹è¯åŠ è½½æ—¶é—´
     */
    fun trackConversationLoadTime(sessionId: String, durationMs: Long) {
        Log.d(TAG, "Conversation load time for $sessionId: ${durationMs}ms")
        
        // è¶…è¿‡é˜ˆå€¼æ—¶è®°å½•è­¦å‘Š
        if (durationMs > 200) {
            Log.w(TAG, "Slow conversation load detected: ${durationMs}ms")
        }
    }
    
    /**
     * è®°å½•AIå“åº”æ—¶é—´
     */
    fun trackAiResponseTime(durationMs: Long) {
        Log.d(TAG, "AI response time: ${durationMs}ms")
        
        // è¶…è¿‡é˜ˆå€¼æ—¶è®°å½•è­¦å‘Š
        if (durationMs > 5000) {
            Log.w(TAG, "Slow AI response detected: ${durationMs}ms")
        }
    }
    
    /**
     * è®°å½•å†…å­˜ä½¿ç”¨æƒ…å†µ
     */
    fun trackMemoryUsage() {
        val runtime = Runtime.getRuntime()
        val usedMemory = (runtime.totalMemory() - runtime.freeMemory()) / 1024 / 1024
        Log.d(TAG, "Memory usage: ${usedMemory}MB")
    }
}
```

---

## 15. å®‰å…¨ä¸éšç§

### 15.1 æ•æ„Ÿæ•°æ®å¤„ç†

```kotlin
/**
 * å¯¹è¯å†…å®¹å®‰å…¨å¤„ç†
 *
 * ç¡®ä¿æ•æ„Ÿå¯¹è¯æ•°æ®çš„å®‰å…¨å­˜å‚¨å’Œä¼ è¾“
 */
object ConversationSecurityHandler {
    
    /**
     * åœ¨å‘é€åˆ°AIæœåŠ¡å‰è¿›è¡Œæ•°æ®è„±æ•
     *
     * å¤ç”¨é¡¹ç›®ç°æœ‰çš„PrivacyEngine
     */
    suspend fun sanitizeForAi(
        content: String,
        privacyRepository: PrivacyRepository
    ): String {
        val mappings = privacyRepository.getPrivacyMapping().getOrElse { emptyMap() }
        return PrivacyEngine.mask(content, mappings)
    }
    
    /**
     * æ—¥å¿—è®°å½•æ—¶è„±æ•å¤„ç†
     */
    fun sanitizeForLog(content: String): String {
        // æˆªæ–­è¿‡é•¿å†…å®¹
        val truncated = if (content.length > 100) {
            content.take(100) + "..."
        } else {
            content
        }
        
        // ç§»é™¤å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯
        return truncated
            .replace(Regex("\\d{11}"), "[PHONE]")
            .replace(Regex("[\\w.-]+@[\\w.-]+"), "[EMAIL]")
    }
}
```

### 15.2 æ•°æ®åŠ å¯†å­˜å‚¨ï¼ˆåç»­ç‰ˆæœ¬ï¼‰

```kotlin
/**
 * å¯¹è¯æ•°æ®åŠ å¯†å­˜å‚¨æ–¹æ¡ˆï¼ˆé¢„ç•™æ¥å£ï¼‰
 *
 * å½“å‰ç‰ˆæœ¬ä½¿ç”¨Roomé»˜è®¤å­˜å‚¨ï¼Œåç»­ç‰ˆæœ¬å¯å¯ç”¨åŠ å¯†
 */
interface ConversationEncryption {
    
    /**
     * åŠ å¯†å¯¹è¯å†…å®¹
     */
    fun encrypt(plainText: String): String
    
    /**
     * è§£å¯†å¯¹è¯å†…å®¹
     */
    fun decrypt(cipherText: String): String
}

/**
 * åŸºäºAndroidKeyStoreçš„åŠ å¯†å®ç°ï¼ˆåç»­ç‰ˆæœ¬å®ç°ï¼‰
 */
// class KeyStoreConversationEncryption : ConversationEncryption { ... }
```

---

## 16. å›½é™…åŒ–æ”¯æŒ

### 16.1 æç¤ºè¯å›½é™…åŒ–é¢„ç•™

```kotlin
/**
 * AIå†›å¸ˆæç¤ºè¯å›½é™…åŒ–æ”¯æŒ
 *
 * å½“å‰ç‰ˆæœ¬ä»…æ”¯æŒä¸­æ–‡ï¼Œé¢„ç•™å¤šè¯­è¨€æ‰©å±•æ¥å£
 */
object LocalizedSystemPrompts {
    
    /**
     * è·å–æœ¬åœ°åŒ–çš„AIå†›å¸ˆæç¤ºè¯
     *
     * @param locale è¯­è¨€åŒºåŸŸ
     * @return å¯¹åº”è¯­è¨€çš„æç¤ºè¯
     */
    fun getAdvisorHeader(locale: Locale = Locale.getDefault()): String {
        return when (locale.language) {
            "zh" -> SystemPrompts.AI_ADVISOR_HEADER
            // åç»­ç‰ˆæœ¬æ·»åŠ å…¶ä»–è¯­è¨€æ”¯æŒ
            // "en" -> SystemPrompts.AI_ADVISOR_HEADER_EN
            else -> SystemPrompts.AI_ADVISOR_HEADER // é»˜è®¤ä¸­æ–‡
        }
    }
    
    fun getAdvisorFooter(locale: Locale = Locale.getDefault()): String {
        return when (locale.language) {
            "zh" -> SystemPrompts.AI_ADVISOR_FOOTER
            else -> SystemPrompts.AI_ADVISOR_FOOTER
        }
    }
}
```

### 16.2 UIæ–‡æœ¬å›½é™…åŒ–

æ‰€æœ‰UIæ–‡æœ¬å·²é€šè¿‡strings.xmlç®¡ç†ï¼ˆè§13.1èŠ‚ï¼‰ï¼Œæ”¯æŒåç»­æ·»åŠ å¤šè¯­è¨€èµ„æºæ–‡ä»¶ï¼š
- `values/strings.xml` - é»˜è®¤ï¼ˆä¸­æ–‡ï¼‰
- `values-en/strings.xml` - è‹±æ–‡ï¼ˆåç»­ç‰ˆæœ¬ï¼‰

---

## 17. ç›¸å…³æ–‡æ¡£

- [PRD-00026-AIå†›å¸ˆå¯¹è¯åŠŸèƒ½éœ€æ±‚](../PRD/PRD-00026-AIå†›å¸ˆå¯¹è¯åŠŸèƒ½éœ€æ±‚.md)
- [FD-00026-AIå†›å¸ˆå¯¹è¯åŠŸèƒ½è®¾è®¡](../FD/FD-00026-AIå†›å¸ˆå¯¹è¯åŠŸèƒ½è®¾è®¡.md)
- [DR-00026-FD00026AIå†›å¸ˆå¯¹è¯åŠŸèƒ½è®¾è®¡å®¡æŸ¥æŠ¥å‘Š](../DR/DR-00026-FD00026AIå†›å¸ˆå¯¹è¯åŠŸèƒ½è®¾è®¡å®¡æŸ¥æŠ¥å‘Š.md)
- [DR-00026-TDD00026AIå†›å¸ˆå¯¹è¯åŠŸèƒ½æŠ€æœ¯è®¾è®¡å®¡æŸ¥æŠ¥å‘Š](../DR/DR-00026-TDD00026AIå†›å¸ˆå¯¹è¯åŠŸèƒ½æŠ€æœ¯è®¾è®¡å®¡æŸ¥æŠ¥å‘Š.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.1
**æœ€åæ›´æ–°**: 2026-01-01
**ä½œè€…**: Kiro
**æ›´æ–°å†…å®¹**:
- æ ¹æ®DR-00026å®¡æŸ¥æŠ¥å‘Šï¼Œæ–°å¢ç¬¬13ç« "èµ„æºä¸æƒé™é…ç½®"
- æ–°å¢ç¬¬14ç« "æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"
- æ–°å¢ç¬¬15ç« "å®‰å…¨ä¸éšç§"
- æ–°å¢ç¬¬16ç« "å›½é™…åŒ–æ”¯æŒ"
- æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬ä¸º1.1
