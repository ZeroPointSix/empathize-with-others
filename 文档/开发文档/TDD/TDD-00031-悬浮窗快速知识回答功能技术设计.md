# TDD-00031: æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½æŠ€æœ¯è®¾è®¡

> **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯è®¾è®¡æ–‡æ¡£ (TDD)
> **ç‰ˆæœ¬**: 1.1
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-07
> **æ›´æ–°æ—¥æœŸ**: 2026-01-07
> **è´Ÿè´£äºº**: Kiro
> **å…³è”PRD**: PRD-00031
> **å…³è”FD**: å¾…åˆ›å»º
> **çŠ¶æ€**: âœ… å®¡æŸ¥ä¿®è®¢å®Œæˆ
> **å®¡æŸ¥æŠ¥å‘Š**: REVIEW-TDD-00031

---

## 0. æ–‡æ¡£èƒŒæ™¯

### 0.1 èƒŒæ™¯è¯´æ˜

æœ¬æ–‡æ¡£æ˜¯æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½çš„æŠ€æœ¯è®¾è®¡æ–‡æ¡£ï¼ŒåŸºäºPRD-00031äº§å“éœ€æ±‚æ–‡æ¡£ç¼–å†™ã€‚è¯¥åŠŸèƒ½æ—¨åœ¨ä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªå¿«é€Ÿã€å‡†ç¡®çš„çŸ¥è¯†è·å–å…¥å£ï¼Œå¸®åŠ©ç”¨æˆ·åœ¨å¯¹è¯è¿‡ç¨‹ä¸­å³æ—¶ç†è§£é™Œç”Ÿæ¦‚å¿µã€æœ¯è¯­æˆ–è¯é¢˜ã€‚

### 0.2 æ–‡æ¡£ç›®çš„

- ä¸ºå¼€å‘å›¢é˜Ÿæä¾›è¯¦ç»†çš„æŠ€æœ¯å®ç°æŒ‡å¯¼
- æ˜ç¡®å„æ¨¡å—çš„ä»£ç ç»“æ„å’Œå®ç°æ–¹å¼
- å®šä¹‰APIæ¥å£è§„èŒƒå’Œæ•°æ®æ ¼å¼
- æä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

### 0.3 è¯»è€…å¯¹è±¡

- Androidå¼€å‘å·¥ç¨‹å¸ˆ
- æµ‹è¯•å·¥ç¨‹å¸ˆ
- ä»£ç å®¡æŸ¥äººå‘˜

### 0.4 å‚è€ƒæ–‡æ¡£

| æ–‡æ¡£ç¼–å· | æ–‡æ¡£åç§° | è¯´æ˜ |
|----------|----------|------|
| PRD-00031 | æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½éœ€æ±‚ | äº§å“éœ€æ±‚æ–‡æ¡£ |
| TDD-00009 | æ‚¬æµ®çª—åŠŸèƒ½é‡æ„æŠ€æœ¯è®¾è®¡ | æ‚¬æµ®çª—åŸºç¡€æ¶æ„ |
| TDD-00025 | AIé…ç½®åŠŸèƒ½å®Œå–„æŠ€æœ¯è®¾è®¡ | AIè°ƒç”¨ç›¸å…³æŠ€æœ¯ |

---

## 1. æŠ€æœ¯æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

åŸºäºPRD-00031éœ€æ±‚ï¼Œå®ç°æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½çš„å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š
- åœ¨æ‚¬æµ®çª—ä¸­æ–°å¢ç¬¬4ä¸ªTabä½œä¸º"å¿«é€Ÿé—®ç­”"å…¥å£
- å®ç°å†…å®¹è¾“å…¥å’Œè§¦å‘æœºåˆ¶
- å®ç°è”ç½‘ä¼˜å…ˆã€AIå…œåº•çš„çŸ¥è¯†è·å–ç­–ç•¥
- å®ç°Markdownæ ¼å¼çš„è§£é‡Šå±•ç¤º
- å®ç°ç›¸å…³æ¨èåŠŸèƒ½

### 1.2 æŠ€æœ¯åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| Clean Architecture | ä¸¥æ ¼éµå¾ªå¤šæ¨¡å—æ¶æ„ï¼Œdomainå±‚æ— Androidä¾èµ– |
| å•ä¸€èŒè´£ | æ¯ä¸ªç±»/ç»„ä»¶åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½ |
| ä¾èµ–å€’ç½® | é€šè¿‡æ¥å£è§£è€¦ï¼Œä¾¿äºæµ‹è¯•å’Œæ›¿æ¢ |
| æ€§èƒ½ä¼˜å…ˆ | å“åº”æ—¶é—´â‰¤3ç§’ï¼ˆè”ç½‘ï¼‰ï¼Œâ‰¤2ç§’ï¼ˆæœ¬åœ°ï¼‰ |
| æ•°æ®å®‰å…¨ | æŸ¥è¯¢å†…å®¹ä¸æ¶‰åŠæ•æ„Ÿä¿¡æ¯ï¼Œæ— éœ€åŠ å¯† |
| å‘åå…¼å®¹ | å¤ç”¨ç°æœ‰æ‚¬æµ®çª—æ¶æ„ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ |

### 1.3 æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Kotlin | 2.0.21 | ä¸»è¦å¼€å‘è¯­è¨€ |
| Hilt | 2.52 | ä¾èµ–æ³¨å…¥ |
| Coroutines | 1.9.0 | å¼‚æ­¥å¤„ç† |
| OkHttp | 4.12.0 | ç½‘ç»œè¯·æ±‚ |
| Moshi | 1.15.1 | JSONè§£æ |
| Markwon | 4.6.2 | Markdownæ¸²æŸ“ï¼ˆView-basedï¼‰ |
| Android Views | - | æ‚¬æµ®çª—UIç»„ä»¶ |

### 1.4 UIæ¡†æ¶é€‰å‹è¯´æ˜

**é‡è¦è¯´æ˜**ï¼šæœ¬åŠŸèƒ½çš„UIå±‚ä½¿ç”¨ä¼ ç»ŸAndroid Viewsè€ŒéJetpack Composeï¼ŒåŸå› å¦‚ä¸‹ï¼š

| è€ƒé‡å› ç´  | è¯´æ˜ |
|---------|------|
| **ç³»ç»Ÿé™åˆ¶** | æ‚¬æµ®çª—è¿è¡Œåœ¨Serviceç¯å¢ƒä¸­ï¼Œä½¿ç”¨`WindowManager`æ·»åŠ Viewï¼ŒComposeåœ¨æ­¤åœºæ™¯ä¸‹å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ |
| **æ¶æ„ä¸€è‡´æ€§** | ç°æœ‰æ‚¬æµ®çª—æ¨¡å—ï¼ˆTDD-00009ï¼‰å·²é‡‡ç”¨Viewså®ç°ï¼Œä¿æŒä¸€è‡´æ€§é™ä½ç»´æŠ¤æˆæœ¬ |
| **Markdownæ¸²æŸ“** | Markwonæ˜¯æˆç†Ÿçš„View-based Markdownåº“ï¼Œä¸Viewsæ¶æ„å¤©ç„¶å…¼å®¹ |
| **æ€§èƒ½è€ƒé‡** | æ‚¬æµ®çª—UIç›¸å¯¹ç®€å•ï¼ŒViewsè¶³å¤Ÿæ»¡è¶³éœ€æ±‚ï¼Œæ— éœ€å¼•å…¥Composeçš„é¢å¤–å¤æ‚åº¦ |

**å¤ç”¨ç­–ç•¥**ï¼š
- å¤ç”¨TDD-00009ä¸­çš„`FloatingView`ã€`TabSwitcher`ç­‰ç»„ä»¶
- æ–°å¢`KnowledgeTab`å’Œ`KnowledgeResultCard`éµå¾ªç›¸åŒçš„Viewsæ¶æ„
- å¸ƒå±€æ–‡ä»¶ä½¿ç”¨XMLå®šä¹‰ï¼Œä¸ç°æœ‰æ‚¬æµ®çª—å¸ƒå±€ä¿æŒä¸€è‡´

### 1.5 æ€§èƒ½åŸºå‡†

| æ“ä½œ | æ€§èƒ½è¦æ±‚ | è¯´æ˜ |
|------|----------|------|
| è”ç½‘æŸ¥è¯¢å“åº” | â‰¤ 3s | åŒ…å«ç½‘ç»œè¯·æ±‚å’ŒAIå¤„ç†æ—¶é—´ |
| æœ¬åœ°AIå“åº” | â‰¤ 2s | çº¯AIç”Ÿæˆæ—¶é—´ |
| Tabåˆ‡æ¢ | < 50ms | ç”¨æˆ·æ„ŸçŸ¥æ— å»¶è¿Ÿ |
| Markdownæ¸²æŸ“ | < 100ms | å†…å®¹å±•ç¤ºæµç•… |
| å†…å­˜å ç”¨å¢é‡ | < 3MB | æ–°åŠŸèƒ½å¸¦æ¥çš„é¢å¤–å†…å­˜ |

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ¨¡å—æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           :app æ¨¡å—                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  di/                                                                     â”‚
â”‚  â””â”€â”€ KnowledgeModule.kt (æ–°å»º)      # çŸ¥è¯†é—®ç­”DIæ¨¡å—                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚               â”‚
                    â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      :data æ¨¡å—       â”‚  â”‚   :domain æ¨¡å—    â”‚  â”‚    :presentation æ¨¡å—     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ repository/          â”‚  â”‚ model/           â”‚  â”‚ ui/floating/             â”‚
â”‚ â””â”€â”€ AiRepository     â”‚  â”‚ â”œâ”€â”€ Knowledge    â”‚  â”‚ â”œâ”€â”€ FloatingView.kt      â”‚
â”‚     Impl (æ‰©å±•)      â”‚  â”‚ â”‚   Query.kt     â”‚  â”‚ â”‚   (æ‰©å±•Tab)             â”‚
â”‚                      â”‚  â”‚ â”œâ”€â”€ Knowledge    â”‚  â”‚ â”œâ”€â”€ KnowledgeTab.kt      â”‚
â”‚                      â”‚  â”‚ â”‚   Response.kt  â”‚  â”‚ â”‚   (æ–°å»º)                â”‚
â”‚                      â”‚  â”‚ â””â”€â”€ Recommend    â”‚  â”‚ â””â”€â”€ KnowledgeResult      â”‚
â”‚                      â”‚  â”‚     ation.kt     â”‚  â”‚     Card.kt (æ–°å»º)       â”‚
â”‚                      â”‚  â”‚                  â”‚  â”‚                          â”‚
â”‚                      â”‚  â”‚ repository/      â”‚  â”‚ viewmodel/               â”‚
â”‚                      â”‚  â”‚ â””â”€â”€ AiRepository â”‚  â”‚ â””â”€â”€ (å¤ç”¨Floating        â”‚
â”‚                      â”‚  â”‚     (æ‰©å±•)       â”‚  â”‚     WindowService)       â”‚
â”‚                      â”‚  â”‚                  â”‚  â”‚                          â”‚
â”‚                      â”‚  â”‚ usecase/         â”‚  â”‚                          â”‚
â”‚                      â”‚  â”‚ â””â”€â”€ QueryKnowl   â”‚  â”‚                          â”‚
â”‚                      â”‚  â”‚     edgeUseCase  â”‚  â”‚                          â”‚
â”‚                      â”‚  â”‚     (æ–°å»º)       â”‚  â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        çŸ¥è¯†æŸ¥è¯¢æ•°æ®æµ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ç”¨æˆ·è¾“å…¥æŸ¥è¯¢å†…å®¹                                                         â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  KnowledgeTab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚      â”‚                                                              â”‚   â”‚
â”‚      â”‚ ç‚¹å‡»"è·å–çŸ¥è¯†"æŒ‰é’®                                            â”‚   â”‚
â”‚      â–¼                                                              â”‚   â”‚
â”‚  FloatingWindowService                                              â”‚   â”‚
â”‚      â”‚                                                              â”‚   â”‚
â”‚      â”‚ è°ƒç”¨UseCase                                                  â”‚   â”‚
â”‚      â–¼                                                              â”‚   â”‚
â”‚  QueryKnowledgeUseCase â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”‚ æ£€æŸ¥æ¨¡å‹èƒ½åŠ›                                                     â”‚
â”‚      â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ æ¨¡å‹æ”¯æŒè”ç½‘ï¼Ÿ                                                â”‚       â”‚
â”‚  â”‚  â”œâ”€ æ˜¯ â†’ AiRepository.queryKnowledgeWithNetwork()           â”‚       â”‚
â”‚  â”‚  â””â”€ å¦ â†’ AiRepository.queryKnowledgeLocal()                 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  OpenAiApi.chat() â”€â”€â–º AIæœåŠ¡å•†API                                       â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”‚ è¿”å›å“åº”ï¼ˆJSONæ ¼å¼ï¼‰                                             â”‚
â”‚      â–¼                                                                  â”‚
â”‚  è§£æKnowledgeResponse                                                  â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  KnowledgeResultCard â”€â”€â–º å±•ç¤ºç»“æœï¼ˆMarkdownæ¸²æŸ“ï¼‰                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ¨¡å—åˆ’åˆ†

```
domain/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ KnowledgeQuery.kt          # çŸ¥è¯†æŸ¥è¯¢è¯·æ±‚æ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ KnowledgeResponse.kt       # çŸ¥è¯†æŸ¥è¯¢å“åº”æ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ Recommendation.kt          # æ¨èé¡¹æ¨¡å‹ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ ActionType.kt              # æ“ä½œç±»å‹æšä¸¾ï¼ˆæ‰©å±•ï¼‰
â”œâ”€â”€ usecase/
â”‚   â””â”€â”€ QueryKnowledgeUseCase.kt   # çŸ¥è¯†æŸ¥è¯¢ç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ AiRepository.kt            # AIä»“åº“æ¥å£ï¼ˆæ‰©å±•ï¼‰

data/
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ AiRepositoryImpl.kt        # AIä»“åº“å®ç°ï¼ˆæ‰©å±•ï¼‰

presentation/
â”œâ”€â”€ ui/floating/
â”‚   â”œâ”€â”€ FloatingView.kt            # ä¸»è§†å›¾ï¼ˆæ‰©å±•Tabï¼‰
â”‚   â”œâ”€â”€ KnowledgeTab.kt            # çŸ¥è¯†é—®ç­”Tabï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ KnowledgeResultCard.kt     # ç»“æœå¡ç‰‡ï¼ˆæ–°å¢ï¼‰

app/
â”œâ”€â”€ di/
â”‚   â””â”€â”€ KnowledgeModule.kt         # ä¾èµ–æ³¨å…¥æ¨¡å—ï¼ˆæ–°å¢ï¼‰
```

---

## 3. è¯¦ç»†æŠ€æœ¯è®¾è®¡

### 3.1 æ•°æ®æ¨¡å‹è®¾è®¡

#### 3.1.1 ActionTypeæ‰©å±•

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/model/ActionType.kt`

```kotlin
enum class ActionType(
    val displayName: String,
    val icon: String,
    val identityPrefix: String
) {
    ANALYZE(
        displayName = "å¸®æˆ‘åˆ†æ",
        icon = "ğŸ”",
        identityPrefix = "ã€å¯¹æ–¹è¯´ã€‘"
    ),
    POLISH(
        displayName = "å¸®æˆ‘æ¶¦è‰²",
        icon = "âœï¸",
        identityPrefix = "ã€æˆ‘æ­£åœ¨å›å¤ã€‘"
    ),
    REPLY(
        displayName = "å¸®æˆ‘å›å¤",
        icon = "ğŸ’¬",
        identityPrefix = "ã€å¯¹æ–¹è¯´ã€‘"
    ),
    // ğŸ†• æ–°å¢ï¼šå¿«é€Ÿé—®ç­”
    KNOWLEDGE(
        displayName = "å¿«é€Ÿé—®ç­”",
        icon = "ğŸ’¡",
        identityPrefix = ""  // çŸ¥è¯†æŸ¥è¯¢ä¸éœ€è¦èº«ä»½å‰ç¼€
    ),
    
    @Deprecated("ä½¿ç”¨POLISHæ›¿ä»£")
    CHECK(
        displayName = "å¸®æˆ‘æ£€æŸ¥",
        icon = "âš ï¸",
        identityPrefix = "ã€æˆ‘æ­£åœ¨å›å¤ã€‘"
    );
    
    companion object {
        fun default(): ActionType = ANALYZE
        
        /**
         * è·å–æœ‰æ•ˆçš„æ“ä½œç±»å‹ï¼ˆæ’é™¤åºŸå¼ƒçš„CHECKï¼‰
         */
        fun validTypes(): List<ActionType> = listOf(ANALYZE, POLISH, REPLY, KNOWLEDGE)
    }
}
```


#### 3.1.2 KnowledgeQueryï¼ˆçŸ¥è¯†æŸ¥è¯¢è¯·æ±‚æ¨¡å‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/model/KnowledgeQuery.kt`

```kotlin
package com.empathy.ai.domain.model

/**
 * çŸ¥è¯†æŸ¥è¯¢è¯·æ±‚æ¨¡å‹
 *
 * @property content ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢å†…å®¹
 * @property maxLength æœ€å¤§é•¿åº¦é™åˆ¶ï¼ˆé»˜è®¤500å­—ç¬¦ï¼‰
 * @property enableNetwork æ˜¯å¦å¯ç”¨è”ç½‘æŸ¥è¯¢ï¼ˆå–å†³äºæ¨¡å‹èƒ½åŠ›ï¼‰
 * @property timestamp æŸ¥è¯¢æ—¶é—´æˆ³
 *
 * @see PRD-00031 æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½éœ€æ±‚
 */
data class KnowledgeQuery(
    val content: String,
    val maxLength: Int = 500,
    val enableNetwork: Boolean = true,
    val timestamp: Long = System.currentTimeMillis()
) {
    /**
     * éªŒè¯æŸ¥è¯¢å†…å®¹æ˜¯å¦æœ‰æ•ˆ
     */
    fun isValid(): Boolean {
        return content.isNotBlank() && content.length <= maxLength
    }
    
    /**
     * è·å–æ¸…ç†åçš„æŸ¥è¯¢å†…å®¹
     */
    fun getCleanedContent(): String {
        return content.trim().take(maxLength)
    }
}
```

#### 3.1.3 KnowledgeResponseï¼ˆçŸ¥è¯†æŸ¥è¯¢å“åº”æ¨¡å‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/model/KnowledgeResponse.kt`

```kotlin
package com.empathy.ai.domain.model

import com.squareup.moshi.JsonClass

/**
 * çŸ¥è¯†æŸ¥è¯¢å“åº”æ¨¡å‹
 *
 * @property title è§£é‡Šæ ‡é¢˜ï¼ˆå¯é€‰ï¼ŒAIè‡ªåŠ¨æå–æˆ–ç”Ÿæˆï¼‰
 * @property content è§£é‡Šå†…å®¹ï¼ˆMarkdownæ ¼å¼ï¼‰
 * @property source ä¿¡æ¯æ¥æºï¼ˆè”ç½‘è·å–æ—¶æ˜¾ç¤ºï¼‰
 * @property sourceTime ä¿¡æ¯æ—¶é—´ï¼ˆè”ç½‘è·å–æ—¶æ˜¾ç¤ºï¼‰
 * @property isFromNetwork æ˜¯å¦æ¥è‡ªè”ç½‘æŸ¥è¯¢
 * @property recommendations ç›¸å…³æ¨èåˆ—è¡¨
 *
 * @see PRD-00031 æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½éœ€æ±‚
 */
@JsonClass(generateAdapter = true)
data class KnowledgeResponse(
    val title: String?,
    val content: String,
    val source: String?,
    val sourceTime: String?,
    val isFromNetwork: Boolean,
    val recommendations: List<Recommendation> = emptyList()
) {
    /**
     * è·å–ç”¨äºæ˜¾ç¤ºçš„å®Œæ•´å†…å®¹
     */
    fun getDisplayContent(): String = buildString {
        if (!title.isNullOrBlank()) {
            appendLine("# $title")
            appendLine()
        }
        append(content)
        if (isFromNetwork && !source.isNullOrBlank()) {
            appendLine()
            appendLine()
            append("ğŸ“… æ¥æºï¼š$source")
            if (!sourceTime.isNullOrBlank()) {
                append(" â€¢ $sourceTime")
            }
        }
    }
    
    /**
     * æ˜¯å¦æœ‰æ¨èå†…å®¹
     */
    fun hasRecommendations(): Boolean = recommendations.isNotEmpty()
    
    /**
     * è·å–é™çº§æç¤ºï¼ˆè”ç½‘å¤±è´¥æ—¶ï¼‰
     */
    fun getDegradationHint(): String? {
        return if (!isFromNetwork) {
            "âš ï¸ è”ç½‘è·å–å¤±è´¥ï¼Œå·²ä½¿ç”¨AIçŸ¥è¯†å›ç­”"
        } else null
    }
}
```

#### 3.1.4 Recommendationï¼ˆæ¨èé¡¹æ¨¡å‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/model/Recommendation.kt`

```kotlin
package com.empathy.ai.domain.model

import com.squareup.moshi.JsonClass

/**
 * æ¨èé¡¹æ¨¡å‹
 *
 * @property id æ¨èé¡¹å”¯ä¸€æ ‡è¯†
 * @property title æ¨èæ ‡é¢˜
 * @property description æ¨èæè¿°ï¼ˆå¯é€‰ï¼‰
 * @property query ç”¨äºé‡æ–°æŸ¥è¯¢çš„å…³é”®è¯
 *
 * @see PRD-00031 æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½éœ€æ±‚
 */
@JsonClass(generateAdapter = true)
data class Recommendation(
    val id: String,
    val title: String,
    val description: String?,
    val query: String
) {
    /**
     * è·å–æ˜¾ç¤ºæ–‡æœ¬
     */
    fun getDisplayText(): String = buildString {
        append(title)
        if (!description.isNullOrBlank()) {
            append(" - $description")
        }
    }
}
```

### 3.2 UseCaseè®¾è®¡

#### 3.2.1 KnowledgeQueryErrorï¼ˆé”™è¯¯ç±»å‹å®šä¹‰ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/model/KnowledgeQueryError.kt`

```kotlin
package com.empathy.ai.domain.model

/**
 * çŸ¥è¯†æŸ¥è¯¢é”™è¯¯ç±»å‹
 * 
 * å®šä¹‰çŸ¥è¯†æŸ¥è¯¢è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿçš„æ‰€æœ‰é”™è¯¯ç±»å‹ï¼Œ
 * ç”¨äºç²¾ç¡®çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†ã€‚
 *
 * @see QueryKnowledgeUseCase
 * @see PRD-00031 æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½éœ€æ±‚
 */
sealed class KnowledgeQueryError : Exception() {
    
    /** æŸ¥è¯¢å†…å®¹æ— æ•ˆï¼ˆä¸ºç©ºæˆ–è¶…å‡ºé•¿åº¦é™åˆ¶ï¼‰ */
    data class InvalidContent(override val message: String) : KnowledgeQueryError()
    
    /** æœªé…ç½®AIæœåŠ¡å•† */
    data object NoProviderConfigured : KnowledgeQueryError() {
        private fun readResolve(): Any = NoProviderConfigured
        override val message = "è¯·å…ˆé…ç½®AIæœåŠ¡å•†"
    }
    
    /** è”ç½‘æŸ¥è¯¢å¤±è´¥ */
    data class NetworkQueryFailed(val cause: Throwable) : KnowledgeQueryError() {
        override val message = "è”ç½‘æŸ¥è¯¢å¤±è´¥ï¼š${cause.message}"
    }
    
    /** æœ¬åœ°AIæŸ¥è¯¢å¤±è´¥ */
    data class LocalQueryFailed(val cause: Throwable) : KnowledgeQueryError() {
        override val message = "AIæŸ¥è¯¢å¤±è´¥ï¼š${cause.message}"
    }
    
    /** å“åº”è§£æå¤±è´¥ */
    data class ParseError(val cause: Throwable) : KnowledgeQueryError() {
        override val message = "å“åº”è§£æå¤±è´¥ï¼š${cause.message}"
    }
    
    /** è¶…æ—¶ */
    data object Timeout : KnowledgeQueryError() {
        private fun readResolve(): Any = Timeout
        override val message = "æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·é‡è¯•"
    }
}
```

#### 3.2.2 QueryKnowledgeUseCaseï¼ˆçŸ¥è¯†æŸ¥è¯¢ç”¨ä¾‹ - æ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/usecase/QueryKnowledgeUseCase.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.model.AiProvider
import com.empathy.ai.domain.model.KnowledgeQuery
import com.empathy.ai.domain.model.KnowledgeQueryError
import com.empathy.ai.domain.model.KnowledgeResponse
import com.empathy.ai.domain.repository.AiProviderRepository
import com.empathy.ai.domain.repository.AiRepository
import javax.inject.Inject
import javax.inject.Singleton

/**
 * çŸ¥è¯†æŸ¥è¯¢ç”¨ä¾‹
 *
 * æ ¸å¿ƒé€»è¾‘ï¼š
 * 1. æ£€æŸ¥æ¨¡å‹æ˜¯å¦æ”¯æŒè”ç½‘åŠŸèƒ½
 * 2. æ”¯æŒè”ç½‘ï¼šä¼˜å…ˆä½¿ç”¨è”ç½‘æŸ¥è¯¢
 * 3. ä¸æ”¯æŒæˆ–è”ç½‘å¤±è´¥ï¼šé™çº§åˆ°AIæœ¬åœ°çŸ¥è¯†
 *
 * é”™è¯¯å¤„ç†ï¼š
 * - æ‰€æœ‰é”™è¯¯ç»Ÿä¸€è½¬æ¢ä¸ºKnowledgeQueryErrorç±»å‹
 * - è”ç½‘å¤±è´¥è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°AI
 *
 * @see PRD-00031 æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½éœ€æ±‚
 * @see KnowledgeQueryError
 */
@Singleton
class QueryKnowledgeUseCase @Inject constructor(
    private val aiRepository: AiRepository,
    private val aiProviderRepository: AiProviderRepository
) {
    suspend operator fun invoke(query: KnowledgeQuery): Result<KnowledgeResponse> {
        return try {
            // 1. å‰ç½®æ£€æŸ¥ - æŸ¥è¯¢å†…å®¹éªŒè¯
            if (!query.isValid()) {
                return Result.failure(
                    KnowledgeQueryError.InvalidContent("æŸ¥è¯¢å†…å®¹æ— æ•ˆï¼šå†…å®¹ä¸ºç©ºæˆ–è¶…å‡º${query.maxLength}å­—ç¬¦é™åˆ¶")
                )
            }
            
            // 2. å‰ç½®æ£€æŸ¥ - AIæœåŠ¡å•†é…ç½®
            val defaultProvider = aiProviderRepository.getDefaultProvider().getOrNull()
                ?: return Result.failure(KnowledgeQueryError.NoProviderConfigured)
            
            // 3. æ£€æŸ¥æ¨¡å‹æ˜¯å¦æ”¯æŒè”ç½‘
            val supportsNetwork = checkNetworkSupport(defaultProvider)
            
            // 4. æ ¹æ®æ¨¡å‹èƒ½åŠ›é€‰æ‹©æŸ¥è¯¢ç­–ç•¥
            if (supportsNetwork && query.enableNetwork) {
                // å°è¯•è”ç½‘æŸ¥è¯¢
                queryWithNetwork(query, defaultProvider)
            } else {
                // ä½¿ç”¨æœ¬åœ°AIçŸ¥è¯†
                queryWithLocalAI(query, defaultProvider)
            }
        } catch (e: KnowledgeQueryError) {
            // å·²ç»æ˜¯KnowledgeQueryErrorï¼Œç›´æ¥è¿”å›
            Result.failure(e)
        } catch (e: Exception) {
            // è½¬æ¢ä¸ºKnowledgeQueryError
            Result.failure(KnowledgeQueryError.LocalQueryFailed(e))
        }
    }
    
    /**
     * æ£€æŸ¥æ¨¡å‹æ˜¯å¦æ”¯æŒè”ç½‘åŠŸèƒ½
     */
    private fun checkNetworkSupport(provider: AiProvider): Boolean {
        // æ£€æŸ¥æ¨¡å‹åç§°æˆ–é…ç½®ä¸­æ˜¯å¦æ ‡æ³¨æ”¯æŒè”ç½‘
        // ä¾‹å¦‚ï¼šDeepSeekçš„æŸäº›æ¨¡å‹æ”¯æŒè”ç½‘
        return provider.defaultModel.name.contains("search", ignoreCase = true) ||
               provider.defaultModel.name.contains("web", ignoreCase = true)
    }
    
    /**
     * è”ç½‘æŸ¥è¯¢ï¼ˆä¼˜å…ˆç­–ç•¥ï¼‰
     * å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°AI
     */
    private suspend fun queryWithNetwork(
        query: KnowledgeQuery,
        provider: AiProvider
    ): Result<KnowledgeResponse> {
        return try {
            val result = aiRepository.queryKnowledgeWithNetwork(
                provider = provider,
                content = query.getCleanedContent()
            )
            
            // æ£€æŸ¥ç»“æœ
            result.fold(
                onSuccess = { Result.success(it) },
                onFailure = { error ->
                    // è”ç½‘å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°AI
                    queryWithLocalAI(query, provider)
                }
            )
        } catch (e: Exception) {
            // è”ç½‘å¼‚å¸¸ï¼Œé™çº§åˆ°æœ¬åœ°AI
            queryWithLocalAI(query, provider)
        }
    }
    
    /**
     * æœ¬åœ°AIæŸ¥è¯¢ï¼ˆå…œåº•ç­–ç•¥ï¼‰
     */
    private suspend fun queryWithLocalAI(
        query: KnowledgeQuery,
        provider: AiProvider
    ): Result<KnowledgeResponse> {
        return try {
            aiRepository.queryKnowledgeLocal(
                provider = provider,
                content = query.getCleanedContent()
            ).fold(
                onSuccess = { Result.success(it) },
                onFailure = { error ->
                    Result.failure(KnowledgeQueryError.LocalQueryFailed(error))
                }
            )
        } catch (e: Exception) {
            Result.failure(KnowledgeQueryError.LocalQueryFailed(e))
        }
    }
}
```


### 3.3 Repositoryæ‰©å±•

#### 3.3.1 AiRepositoryæ¥å£æ‰©å±•

**æ–‡ä»¶ä½ç½®**: `domain/src/main/kotlin/com/empathy/ai/domain/repository/AiRepository.kt`

```kotlin
interface AiRepository {
    // ==================== å·²æœ‰æ–¹æ³• ====================
    
    suspend fun analyzeChat(
        provider: AiProvider,
        promptContext: String,
        systemInstruction: String
    ): Result<AnalysisResult>
    
    suspend fun polishDraft(
        provider: AiProvider,
        draft: String,
        systemInstruction: String
    ): Result<PolishResult>
    
    suspend fun generateReply(
        provider: AiProvider,
        message: String,
        systemInstruction: String
    ): Result<ReplyResult>
    
    // ==================== æ–°å¢æ–¹æ³• ====================
    
    /**
     * è”ç½‘æŸ¥è¯¢çŸ¥è¯†ï¼ˆä¼˜å…ˆç­–ç•¥ï¼‰
     * 
     * é€‚ç”¨äºæ”¯æŒè”ç½‘åŠŸèƒ½çš„AIæ¨¡å‹ï¼Œé€šè¿‡è”ç½‘æœç´¢è·å–æœ€æ–°ã€æœ€å‡†ç¡®çš„ä¿¡æ¯ã€‚
     * 
     * @param provider AIæœåŠ¡å•†é…ç½®ï¼ŒåŒ…å«APIå¯†é’¥ã€æ¨¡å‹é…ç½®ç­‰
     * @param content æŸ¥è¯¢å†…å®¹ï¼Œå·²æ¸…ç†å’ŒéªŒè¯çš„ç”¨æˆ·è¾“å…¥
     * @return Result<KnowledgeResponse> æˆåŠŸè¿”å›çŸ¥è¯†å“åº”ï¼Œå¤±è´¥è¿”å›å¼‚å¸¸
     * 
     * @throws KnowledgeQueryError.NetworkQueryFailed å½“ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶ï¼ˆè¶…æ—¶ã€è¿æ¥é”™è¯¯ç­‰ï¼‰
     * @throws KnowledgeQueryError.ParseError å½“AIå“åº”è§£æå¤±è´¥æ—¶
     * @throws KnowledgeQueryError.Timeout å½“è¯·æ±‚è¶…è¿‡3ç§’è¶…æ—¶æ—¶
     * 
     * @see KnowledgeResponse
     * @see KnowledgeQueryError
     */
    suspend fun queryKnowledgeWithNetwork(
        provider: AiProvider,
        content: String
    ): Result<KnowledgeResponse>
    
    /**
     * æœ¬åœ°AIæŸ¥è¯¢çŸ¥è¯†ï¼ˆå…œåº•ç­–ç•¥ï¼‰
     * 
     * ä½¿ç”¨AIæ¨¡å‹çš„é¢„è®­ç»ƒçŸ¥è¯†ç”Ÿæˆå›ç­”ï¼Œé€‚ç”¨äºï¼š
     * 1. æ¨¡å‹ä¸æ”¯æŒè”ç½‘åŠŸèƒ½
     * 2. è”ç½‘æŸ¥è¯¢å¤±è´¥åçš„é™çº§å¤„ç†
     * 
     * @param provider AIæœåŠ¡å•†é…ç½®ï¼ŒåŒ…å«APIå¯†é’¥ã€æ¨¡å‹é…ç½®ç­‰
     * @param content æŸ¥è¯¢å†…å®¹ï¼Œå·²æ¸…ç†å’ŒéªŒè¯çš„ç”¨æˆ·è¾“å…¥
     * @return Result<KnowledgeResponse> æˆåŠŸè¿”å›çŸ¥è¯†å“åº”ï¼Œå¤±è´¥è¿”å›å¼‚å¸¸
     * 
     * @throws KnowledgeQueryError.LocalQueryFailed å½“AIè°ƒç”¨å¤±è´¥æ—¶
     * @throws KnowledgeQueryError.ParseError å½“AIå“åº”è§£æå¤±è´¥æ—¶
     * @throws KnowledgeQueryError.Timeout å½“è¯·æ±‚è¶…è¿‡2ç§’è¶…æ—¶æ—¶
     * 
     * @see KnowledgeResponse
     * @see KnowledgeQueryError
     */
    suspend fun queryKnowledgeLocal(
        provider: AiProvider,
        content: String
    ): Result<KnowledgeResponse>
}
```

#### 3.3.2 AiRepositoryImplå®ç°æ‰©å±•

**æ–‡ä»¶ä½ç½®**: `data/src/main/kotlin/com/empathy/ai/data/repository/AiRepositoryImpl.kt`

```kotlin
class AiRepositoryImpl @Inject constructor(
    private val openAiApi: OpenAiApi,
    private val moshi: Moshi,
    @IoDispatcher private val ioDispatcher: CoroutineDispatcher
) : AiRepository {
    
    // ==================== è¶…æ—¶é…ç½®å¸¸é‡ ====================
    
    companion object {
        /** è”ç½‘æŸ¥è¯¢è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ - åŒ…å«ç½‘ç»œè¯·æ±‚å’ŒAIå¤„ç† */
        private const val NETWORK_QUERY_TIMEOUT_MS = 3000L
        
        /** æœ¬åœ°AIæŸ¥è¯¢è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ - çº¯AIç”Ÿæˆ */
        private const val LOCAL_QUERY_TIMEOUT_MS = 2000L
    }
    
    // ... å·²æœ‰å®ç° ...
    
    override suspend fun queryKnowledgeWithNetwork(
        provider: AiProvider,
        content: String
    ): Result<KnowledgeResponse> = withContext(ioDispatcher) {
        try {
            withTimeout(NETWORK_QUERY_TIMEOUT_MS) {
                val systemInstruction = buildKnowledgeSystemPrompt(enableNetwork = true)
                val response = callAi(provider, systemInstruction, content)
                val result = parseKnowledgeResponse(response, isFromNetwork = true)
                Result.success(result)
            }
        } catch (e: TimeoutCancellationException) {
            Result.failure(KnowledgeQueryError.Timeout)
        } catch (e: Exception) {
            Result.failure(KnowledgeQueryError.NetworkQueryFailed(e))
        }
    }
    
    override suspend fun queryKnowledgeLocal(
        provider: AiProvider,
        content: String
    ): Result<KnowledgeResponse> = withContext(ioDispatcher) {
        try {
            withTimeout(LOCAL_QUERY_TIMEOUT_MS) {
                val systemInstruction = buildKnowledgeSystemPrompt(enableNetwork = false)
                val response = callAi(provider, systemInstruction, content)
                val result = parseKnowledgeResponse(response, isFromNetwork = false)
                Result.success(result)
            }
        } catch (e: TimeoutCancellationException) {
            Result.failure(KnowledgeQueryError.Timeout)
        } catch (e: Exception) {
            Result.failure(KnowledgeQueryError.LocalQueryFailed(e))
        }
    }
    
    /**
     * æ„å»ºçŸ¥è¯†æŸ¥è¯¢çš„ç³»ç»Ÿæç¤ºè¯
     */
    private fun buildKnowledgeSystemPrompt(enableNetwork: Boolean): String {
        return if (enableNetwork) {
            """
            ä½ æ˜¯ä¸€ä¸ªçŸ¥è¯†åŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿç†è§£é™Œç”Ÿçš„æ¦‚å¿µã€æœ¯è¯­æˆ–è¯é¢˜ã€‚
            
            ã€ä½ çš„èƒ½åŠ›ã€‘
            - å¯ä»¥è”ç½‘æœç´¢è·å–æœ€æ–°ã€æœ€å‡†ç¡®çš„ä¿¡æ¯
            - ä¼˜å…ˆä½¿ç”¨æƒå¨æ¥æºï¼ˆå¦‚Wikipediaã€å®˜æ–¹æ–‡æ¡£ç­‰ï¼‰
            
            ã€ä½ çš„ä»»åŠ¡ã€‘
            1. ç†è§£ç”¨æˆ·æƒ³è¦äº†è§£çš„å†…å®¹
            2. è”ç½‘æœç´¢ç›¸å…³ä¿¡æ¯
            3. æ•´ç†æˆç®€æ´æ˜“æ‡‚çš„è§£é‡Š
            4. æ¨è3-5ä¸ªç›¸å…³è¯é¢˜ä¾›ç”¨æˆ·å»¶ä¼¸é˜…è¯»
            
            ã€è¾“å‡ºè¦æ±‚ã€‘
            è¯·ä»¥JSONæ ¼å¼è¿”å›ç»“æœï¼š
            {
              "title": "æ¦‚å¿µæ ‡é¢˜ï¼ˆå¯é€‰ï¼‰",
              "content": "è¯¦ç»†è§£é‡Šï¼ˆæ”¯æŒMarkdownæ ¼å¼ï¼‰",
              "source": "ä¿¡æ¯æ¥æº",
              "sourceTime": "ä¿¡æ¯æ—¶é—´",
              "isFromNetwork": true,
              "recommendations": [
                {
                  "id": "rec_1",
                  "title": "æ¨èè¯é¢˜1",
                  "description": "ç®€çŸ­æè¿°",
                  "query": "ç”¨äºæŸ¥è¯¢çš„å…³é”®è¯"
                }
              ]
            }
            
            ã€ç¦æ­¢äº‹é¡¹ã€‘
            - ç¦æ­¢è¿”å›Markdownæ ¼å¼çš„ä»£ç å—
            - ç¦æ­¢åœ¨JSONå‰åæ·»åŠ ä»»ä½•æ–‡å­—
            - å¦‚æœæ‰¾ä¸åˆ°ä¿¡æ¯ï¼Œcontentå­—æ®µè¯´æ˜"æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯"
            """.trimIndent()
        } else {
            """
            ä½ æ˜¯ä¸€ä¸ªçŸ¥è¯†åŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿç†è§£é™Œç”Ÿçš„æ¦‚å¿µã€æœ¯è¯­æˆ–è¯é¢˜ã€‚
            
            ã€ä½ çš„èƒ½åŠ›ã€‘
            - ä½¿ç”¨ä½ çš„é¢„è®­ç»ƒçŸ¥è¯†å›ç­”é—®é¢˜
            - æä¾›å‡†ç¡®ã€ç®€æ´çš„è§£é‡Š
            
            ã€é‡è¦æç¤ºã€‘
            ä½ å½“å‰æ— æ³•è”ç½‘ï¼Œåªèƒ½ä½¿ç”¨é¢„è®­ç»ƒçŸ¥è¯†ã€‚å¦‚æœé‡åˆ°ä½ ä¸ç¡®å®šçš„å†…å®¹ï¼Œè¯·æ˜ç¡®è¯´æ˜ã€‚
            
            ã€ä½ çš„ä»»åŠ¡ã€‘
            1. ç†è§£ç”¨æˆ·æƒ³è¦äº†è§£çš„å†…å®¹
            2. åŸºäºä½ çš„çŸ¥è¯†ç»™å‡ºè§£é‡Š
            3. æ¨è3-5ä¸ªç›¸å…³è¯é¢˜ä¾›ç”¨æˆ·å»¶ä¼¸é˜…è¯»
            
            ã€è¾“å‡ºè¦æ±‚ã€‘
            è¯·ä»¥JSONæ ¼å¼è¿”å›ç»“æœï¼š
            {
              "title": "æ¦‚å¿µæ ‡é¢˜ï¼ˆå¯é€‰ï¼‰",
              "content": "è¯¦ç»†è§£é‡Šï¼ˆæ”¯æŒMarkdownæ ¼å¼ï¼‰\n\nâš ï¸ æ³¨æ„ï¼šæ­¤å›ç­”åŸºäºAIé¢„è®­ç»ƒçŸ¥è¯†ï¼Œå¯èƒ½å­˜åœ¨åå·®æˆ–è¿‡æ—¶ä¿¡æ¯ã€‚",
              "source": null,
              "sourceTime": null,
              "isFromNetwork": false,
              "recommendations": [
                {
                  "id": "rec_1",
                  "title": "æ¨èè¯é¢˜1",
                  "description": "ç®€çŸ­æè¿°",
                  "query": "ç”¨äºæŸ¥è¯¢çš„å…³é”®è¯"
                }
              ]
            }
            
            ã€ç¦æ­¢äº‹é¡¹ã€‘
            - ç¦æ­¢è¿”å›Markdownæ ¼å¼çš„ä»£ç å—
            - ç¦æ­¢åœ¨JSONå‰åæ·»åŠ ä»»ä½•æ–‡å­—
            - å¦‚æœä¸ç¡®å®šï¼Œè¯·åœ¨contentä¸­æ˜ç¡®è¯´æ˜
            """.trimIndent()
        }
    }
    
    /**
     * è§£æçŸ¥è¯†æŸ¥è¯¢å“åº”
     */
    private fun parseKnowledgeResponse(
        response: String,
        isFromNetwork: Boolean
    ): KnowledgeResponse {
        val cleanedJson = AiResponseCleaner.clean(response)
        val adapter = moshi.adapter(KnowledgeResponse::class.java)
        val parsed = adapter.fromJson(cleanedJson)
            ?: throw IllegalStateException("è§£æçŸ¥è¯†æŸ¥è¯¢å“åº”å¤±è´¥")
        
        // ç¡®ä¿isFromNetworkå­—æ®µæ­£ç¡®
        return parsed.copy(isFromNetwork = isFromNetwork)
    }
}
```

### 3.4 UIå±‚è®¾è®¡

#### 3.4.1 FloatingViewæ‰©å±•ï¼ˆæ·»åŠ ç¬¬4ä¸ªTabï¼‰

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/floating/FloatingView.kt`

**ä¿®æ”¹å†…å®¹**ï¼š
1. åœ¨TabSwitcherä¸­æ·»åŠ KNOWLEDGEç±»å‹çš„Tab
2. æ·»åŠ KnowledgeTabçš„å®¹å™¨å¸ƒå±€
3. å¤„ç†Tabåˆ‡æ¢é€»è¾‘

```kotlin
class FloatingView(context: Context) : FrameLayout(context) {
    
    // ... å·²æœ‰ä»£ç  ...
    
    private fun setupTabSwitcher() {
        val tabSwitcher = findViewById<TabSwitcher>(R.id.tab_switcher)
        
        // ğŸ†• æ·»åŠ ç¬¬4ä¸ªTab
        tabSwitcher.setTabs(
            listOf(
                ActionType.ANALYZE,
                ActionType.POLISH,
                ActionType.REPLY,
                ActionType.KNOWLEDGE  // æ–°å¢
            )
        )
        
        tabSwitcher.onTabSelected = { actionType ->
            handleTabSwitch(actionType)
        }
    }
    
    private fun handleTabSwitch(actionType: ActionType) {
        // éšè—æ‰€æœ‰Tabå†…å®¹
        findViewById<View>(R.id.analyze_tab).visibility = View.GONE
        findViewById<View>(R.id.polish_tab).visibility = View.GONE
        findViewById<View>(R.id.reply_tab).visibility = View.GONE
        findViewById<View>(R.id.knowledge_tab).visibility = View.GONE  // ğŸ†•
        
        // æ˜¾ç¤ºé€‰ä¸­çš„Tab
        when (actionType) {
            ActionType.ANALYZE -> findViewById<View>(R.id.analyze_tab).visibility = View.VISIBLE
            ActionType.POLISH -> findViewById<View>(R.id.polish_tab).visibility = View.VISIBLE
            ActionType.REPLY -> findViewById<View>(R.id.reply_tab).visibility = View.VISIBLE
            ActionType.KNOWLEDGE -> findViewById<View>(R.id.knowledge_tab).visibility = View.VISIBLE  // ğŸ†•
            else -> {}
        }
        
        // ä¿å­˜é€‰ä¸­çš„Tab
        preferences.saveSelectedTab(actionType)
    }
}
```

#### 3.4.2 KnowledgeTabå®ç°ï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/floating/KnowledgeTab.kt`

```kotlin
package com.empathy.ai.presentation.ui.floating

import android.content.Context
import android.text.Editable
import android.text.TextWatcher
import android.util.AttributeSet
import android.view.LayoutInflater
import android.widget.EditText
import android.widget.FrameLayout
import android.widget.TextView
import com.empathy.ai.R
import com.google.android.material.button.MaterialButton

/**
 * çŸ¥è¯†é—®ç­”Tab
 * 
 * åŠŸèƒ½ï¼š
 * 1. å¤šè¡Œæ–‡æœ¬è¾“å…¥æ¡†ï¼ˆæœ€å¤§500å­—ç¬¦ï¼‰
 * 2. å­—ç¬¦è®¡æ•°æ˜¾ç¤º
 * 3. "è·å–çŸ¥è¯†"æŒ‰é’®ï¼ˆè¾“å…¥ä¸ºç©ºæ—¶ç¦ç”¨ï¼‰
 * 4. ç»“æœå±•ç¤ºåŒºåŸŸ
 * 
 * @see PRD-00031 æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½éœ€æ±‚
 */
class KnowledgeTab @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : FrameLayout(context, attrs, defStyleAttr) {
    
    private val inputField: EditText
    private val charCountText: TextView
    private val queryButton: MaterialButton
    private val resultContainer: FrameLayout
    
    var onQueryClick: ((String) -> Unit)? = null
    
    companion object {
        private const val MAX_LENGTH = 500
    }
    
    init {
        LayoutInflater.from(context).inflate(R.layout.floating_knowledge_tab, this, true)
        
        inputField = findViewById(R.id.input_field)
        charCountText = findViewById(R.id.char_count)
        queryButton = findViewById(R.id.query_button)
        resultContainer = findViewById(R.id.result_container)
        
        setupInputField()
        setupQueryButton()
    }
    
    private fun setupInputField() {
        inputField.addTextChangedListener(object : TextWatcher {
            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
            
            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {
                updateCharCount(s?.length ?: 0)
                updateQueryButtonState()
            }
            
            override fun afterTextChanged(s: Editable?) {}
        })
    }
    
    private fun setupQueryButton() {
        queryButton.setOnClickListener {
            val content = inputField.text.toString().trim()
            if (content.isNotBlank()) {
                onQueryClick?.invoke(content)
            }
        }
    }
    
    private fun updateCharCount(length: Int) {
        charCountText.text = "$length/$MAX_LENGTH"
        
        // è¶…å‡ºé™åˆ¶æ—¶æ˜¾ç¤ºçº¢è‰²
        if (length > MAX_LENGTH) {
            charCountText.setTextColor(context.getColor(android.R.color.holo_red_dark))
        } else {
            charCountText.setTextColor(context.getColor(android.R.color.darker_gray))
        }
    }
    
    private fun updateQueryButtonState() {
        val content = inputField.text.toString().trim()
        val isValid = content.isNotBlank() && content.length <= MAX_LENGTH
        queryButton.isEnabled = isValid
    }
    
    /**
     * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     */
    fun showLoading() {
        queryButton.isEnabled = false
        queryButton.text = "æŸ¥è¯¢ä¸­..."
    }
    
    /**
     * æ˜¾ç¤ºç»“æœ
     */
    fun showResult(response: KnowledgeResponse) {
        queryButton.isEnabled = true
        queryButton.text = "è·å–çŸ¥è¯†"
        
        // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
        resultContainer.removeAllViews()
        
        // æ·»åŠ ç»“æœå¡ç‰‡
        val resultCard = KnowledgeResultCard(context)
        resultCard.setContent(response)
        resultContainer.addView(resultCard)
    }
    
    /**
     * æ˜¾ç¤ºé”™è¯¯
     */
    fun showError(message: String) {
        queryButton.isEnabled = true
        queryButton.text = "è·å–çŸ¥è¯†"
        
        // TODO: æ˜¾ç¤ºé”™è¯¯æç¤º
    }
    
    /**
     * æ¸…ç©ºè¾“å…¥
     */
    fun clearInput() {
        inputField.text.clear()
    }
    
    /**
     * è·å–è¾“å…¥å†…å®¹
     */
    fun getInputContent(): String {
        return inputField.text.toString().trim()
    }
}
```


#### 3.4.3 KnowledgeResultCardå®ç°ï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/floating/KnowledgeResultCard.kt`

```kotlin
package com.empathy.ai.presentation.ui.floating

import android.content.Context
import android.util.AttributeSet
import android.view.LayoutInflater
import android.widget.LinearLayout
import android.widget.TextView
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.empathy.ai.R
import com.empathy.ai.domain.model.KnowledgeResponse
import com.empathy.ai.domain.model.Recommendation
import io.noties.markwon.Markwon

/**
 * çŸ¥è¯†æŸ¥è¯¢ç»“æœå¡ç‰‡
 * 
 * åŠŸèƒ½ï¼š
 * 1. Markdownæ ¼å¼å†…å®¹æ¸²æŸ“
 * 2. æ¥æºå’Œæ—¶é—´æ˜¾ç¤º
 * 3. é™çº§æç¤ºï¼ˆè”ç½‘å¤±è´¥æ—¶ï¼‰
 * 4. ç›¸å…³æ¨èåˆ—è¡¨
 * 
 * @see PRD-00031 æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½éœ€æ±‚
 */
class KnowledgeResultCard @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : LinearLayout(context, attrs, defStyleAttr) {
    
    private val contentText: TextView
    private val sourceText: TextView
    private val degradationHint: TextView
    private val recommendationList: RecyclerView
    
    private val markwon: Markwon by lazy {
        Markwon.create(context)
    }
    
    var onRecommendationClick: ((Recommendation) -> Unit)? = null
    
    init {
        orientation = VERTICAL
        LayoutInflater.from(context).inflate(R.layout.floating_knowledge_result, this, true)
        
        contentText = findViewById(R.id.content_text)
        sourceText = findViewById(R.id.source_text)
        degradationHint = findViewById(R.id.degradation_hint)
        recommendationList = findViewById(R.id.recommendation_list)
        
        setupRecommendationList()
    }
    
    private fun setupRecommendationList() {
        recommendationList.layoutManager = LinearLayoutManager(context)
    }
    
    /**
     * è®¾ç½®å†…å®¹
     */
    fun setContent(response: KnowledgeResponse) {
        // æ¸²æŸ“Markdownå†…å®¹
        markwon.setMarkdown(contentText, response.getDisplayContent())
        
        // æ˜¾ç¤ºæ¥æºä¿¡æ¯
        if (response.isFromNetwork && !response.source.isNullOrBlank()) {
            sourceText.visibility = VISIBLE
            sourceText.text = buildString {
                append("ğŸ“… æ¥æºï¼š${response.source}")
                if (!response.sourceTime.isNullOrBlank()) {
                    append(" â€¢ ${response.sourceTime}")
                }
            }
        } else {
            sourceText.visibility = GONE
        }
        
        // æ˜¾ç¤ºé™çº§æç¤º
        val hint = response.getDegradationHint()
        if (hint != null) {
            degradationHint.visibility = VISIBLE
            degradationHint.text = hint
        } else {
            degradationHint.visibility = GONE
        }
        
        // æ˜¾ç¤ºæ¨èåˆ—è¡¨
        if (response.hasRecommendations()) {
            recommendationList.visibility = VISIBLE
            val adapter = RecommendationAdapter(response.recommendations) { recommendation ->
                onRecommendationClick?.invoke(recommendation)
            }
            recommendationList.adapter = adapter
        } else {
            recommendationList.visibility = GONE
        }
    }
    
    /**
     * æ¨èåˆ—è¡¨é€‚é…å™¨
     */
    private class RecommendationAdapter(
        private val items: List<Recommendation>,
        private val onItemClick: (Recommendation) -> Unit
    ) : RecyclerView.Adapter<RecommendationViewHolder>() {
        
        override fun onCreateViewHolder(parent: android.view.ViewGroup, viewType: Int): RecommendationViewHolder {
            val view = LayoutInflater.from(parent.context)
                .inflate(R.layout.item_recommendation, parent, false)
            return RecommendationViewHolder(view)
        }
        
        override fun onBindViewHolder(holder: RecommendationViewHolder, position: Int) {
            holder.bind(items[position], onItemClick)
        }
        
        override fun getItemCount(): Int = items.size
    }
    
    /**
     * æ¨èé¡¹ViewHolder
     */
    private class RecommendationViewHolder(itemView: android.view.View) : RecyclerView.ViewHolder(itemView) {
        private val titleText: TextView = itemView.findViewById(R.id.title_text)
        private val descriptionText: TextView = itemView.findViewById(R.id.description_text)
        
        fun bind(item: Recommendation, onItemClick: (Recommendation) -> Unit) {
            titleText.text = item.title
            
            if (!item.description.isNullOrBlank()) {
                descriptionText.visibility = VISIBLE
                descriptionText.text = item.description
            } else {
                descriptionText.visibility = GONE
            }
            
            itemView.setOnClickListener {
                onItemClick(item)
            }
        }
    }
}
```

### 3.5 å¸ƒå±€æ–‡ä»¶è®¾è®¡

#### 3.5.1 floating_knowledge_tab.xml

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/res/layout/floating_knowledge_tab.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <!-- è¾“å…¥åŒºåŸŸ -->
    <com.google.android.material.card.MaterialCardView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        app:cardCornerRadius="12dp"
        app:cardElevation="2dp">

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            android:padding="12dp">

            <!-- å¤šè¡Œè¾“å…¥æ¡† -->
            <EditText
                android:id="@+id/input_field"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:minHeight="80dp"
                android:gravity="top|start"
                android:hint="ç²˜è´´æˆ–è¾“å…¥æƒ³è¦äº†è§£çš„å†…å®¹..."
                android:inputType="textMultiLine"
                android:maxLength="500"
                android:background="@null"
                android:textSize="14sp" />

            <!-- å­—ç¬¦è®¡æ•° -->
            <TextView
                android:id="@+id/char_count"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_gravity="end"
                android:layout_marginTop="4dp"
                android:text="0/500"
                android:textColor="@android:color/darker_gray"
                android:textSize="12sp" />
        </LinearLayout>
    </com.google.android.material.card.MaterialCardView>

    <!-- æŸ¥è¯¢æŒ‰é’® -->
    <com.google.android.material.button.MaterialButton
        android:id="@+id/query_button"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="12dp"
        android:text="ğŸ“¥ è·å–çŸ¥è¯†"
        android:textSize="16sp"
        app:cornerRadius="8dp" />

    <!-- ç»“æœå®¹å™¨ -->
    <FrameLayout
        android:id="@+id/result_container"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:layout_marginTop="16dp" />

</LinearLayout>
```

#### 3.5.2 floating_knowledge_result.xml

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/res/layout/floating_knowledge_result.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="vertical">

    <!-- å†…å®¹å¡ç‰‡ -->
    <com.google.android.material.card.MaterialCardView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        app:cardCornerRadius="12dp"
        app:cardElevation="2dp">

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            android:padding="16dp">

            <!-- Markdownå†…å®¹ -->
            <TextView
                android:id="@+id/content_text"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:textSize="14sp"
                android:lineSpacingMultiplier="1.2" />

            <!-- æ¥æºä¿¡æ¯ -->
            <TextView
                android:id="@+id/source_text"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_marginTop="12dp"
                android:textSize="12sp"
                android:textColor="@android:color/darker_gray"
                android:visibility="gone" />

            <!-- é™çº§æç¤º -->
            <TextView
                android:id="@+id/degradation_hint"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_marginTop="8dp"
                android:padding="8dp"
                android:background="@drawable/bg_warning"
                android:textSize="12sp"
                android:textColor="@android:color/holo_orange_dark"
                android:visibility="gone" />
        </LinearLayout>
    </com.google.android.material.card.MaterialCardView>

    <!-- ç›¸å…³æ¨èæ ‡é¢˜ -->
    <TextView
        android:id="@+id/recommendation_title"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="16dp"
        android:text="ğŸ’¡ ç›¸å…³æ¨è"
        android:textSize="14sp"
        android:textStyle="bold" />

    <!-- æ¨èåˆ—è¡¨ -->
    <androidx.recyclerview.widget.RecyclerView
        android:id="@+id/recommendation_list"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:visibility="gone" />

</LinearLayout>
```

#### 3.5.3 item_recommendation.xml

**æ–‡ä»¶ä½ç½®**: `presentation/src/main/res/layout/item_recommendation.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<com.google.android.material.card.MaterialCardView xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:layout_marginBottom="8dp"
    app:cardCornerRadius="8dp"
    app:cardElevation="1dp"
    android:clickable="true"
    android:focusable="true"
    android:foreground="?attr/selectableItemBackground">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical"
        android:padding="12dp">

        <!-- æ ‡é¢˜ -->
        <TextView
            android:id="@+id/title_text"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:textSize="14sp"
            android:textStyle="bold"
            android:textColor="@android:color/black" />

        <!-- æè¿° -->
        <TextView
            android:id="@+id/description_text"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginTop="4dp"
            android:textSize="12sp"
            android:textColor="@android:color/darker_gray"
            android:visibility="gone" />
    </LinearLayout>

</com.google.android.material.card.MaterialCardView>
```


### 3.6 Serviceå±‚é›†æˆ

#### 3.6.1 FloatingWindowServiceæ‰©å±•

**æ–‡ä»¶ä½ç½®**: `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt`

```kotlin
class FloatingWindowService : Service() {
    
    @Inject lateinit var queryKnowledgeUseCase: QueryKnowledgeUseCase
    
    // ... å·²æœ‰ä»£ç  ...
    
    private fun setupKnowledgeTab() {
        val knowledgeTab = floatingView.findViewById<KnowledgeTab>(R.id.knowledge_tab)
        
        knowledgeTab.onQueryClick = { content ->
            handleKnowledgeQuery(content)
        }
        
        // è®¾ç½®æ¨èç‚¹å‡»äº‹ä»¶
        knowledgeTab.onRecommendationClick = { recommendation ->
            // ä½¿ç”¨æ¨èçš„queryé‡æ–°æŸ¥è¯¢
            handleKnowledgeQuery(recommendation.query)
        }
    }
    
    private fun handleKnowledgeQuery(content: String) {
        val knowledgeTab = floatingView.findViewById<KnowledgeTab>(R.id.knowledge_tab)
        
        serviceScope.launch {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                knowledgeTab.showLoading()
                
                // åˆ›å»ºæŸ¥è¯¢è¯·æ±‚
                val query = KnowledgeQuery(
                    content = content,
                    enableNetwork = true
                )
                
                // è°ƒç”¨UseCase
                val result = queryKnowledgeUseCase(query)
                
                // å¤„ç†ç»“æœ
                result.onSuccess { response ->
                    knowledgeTab.showResult(response)
                }.onFailure { error ->
                    knowledgeTab.showError(error.message ?: "æŸ¥è¯¢å¤±è´¥")
                }
            } catch (e: Exception) {
                knowledgeTab.showError("æŸ¥è¯¢å¼‚å¸¸ï¼š${e.message}")
            }
        }
    }
}
```

### 3.7 ä¾èµ–æ³¨å…¥é…ç½®

#### 3.7.1 KnowledgeModuleï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶ä½ç½®**: `app/src/main/java/com/empathy/ai/di/KnowledgeModule.kt`

```kotlin
package com.empathy.ai.di

import com.empathy.ai.domain.repository.AiRepository
import com.empathy.ai.domain.repository.AiProviderRepository
import com.empathy.ai.domain.usecase.QueryKnowledgeUseCase
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

/**
 * çŸ¥è¯†é—®ç­”åŠŸèƒ½ä¾èµ–æ³¨å…¥æ¨¡å—
 * 
 * @see PRD-00031 æ‚¬æµ®çª—å¿«é€ŸçŸ¥è¯†å›ç­”åŠŸèƒ½éœ€æ±‚
 */
@Module
@InstallIn(SingletonComponent::class)
object KnowledgeModule {
    
    @Provides
    @Singleton
    fun provideQueryKnowledgeUseCase(
        aiRepository: AiRepository,
        aiProviderRepository: AiProviderRepository
    ): QueryKnowledgeUseCase {
        return QueryKnowledgeUseCase(
            aiRepository = aiRepository,
            aiProviderRepository = aiProviderRepository
        )
    }
}
```

### 3.8 æ•°æ®åº“è®¾è®¡

**æœ¬åŠŸèƒ½ä¸æ¶‰åŠæ•°æ®åº“å˜æ›´**ã€‚çŸ¥è¯†æŸ¥è¯¢åŠŸèƒ½æ˜¯çº¯AIé©±åŠ¨çš„å®æ—¶æŸ¥è¯¢ï¼Œä¸éœ€è¦æŒä¹…åŒ–å­˜å‚¨ã€‚

| å­˜å‚¨ç±»å‹ | ä½¿ç”¨æ–¹å¼ | è¯´æ˜ |
|---------|---------|------|
| Roomæ•°æ®åº“ | æ— æ–°å¢ | åŠŸèƒ½çº¯AIé©±åŠ¨ï¼Œä¸æŒä¹…åŒ–æŸ¥è¯¢æ•°æ® |
| SharedPreferences | æ— æ–°å¢ | æ— éœ€ä¿å­˜ç”¨æˆ·åå¥½è®¾ç½® |
| æ–‡ä»¶å­˜å‚¨ | æ— æ–°å¢ | æ— éœ€ç¼“å­˜æŸ¥è¯¢ç»“æœ |

**åç»­ç‰ˆæœ¬è§„åˆ’**ï¼š
- v1.1ç‰ˆæœ¬å¯èƒ½æ–°å¢å†å²æŸ¥è¯¢è®°å½•è¡¨ï¼ˆ`knowledge_query_history`ï¼‰
- v1.2ç‰ˆæœ¬å¯èƒ½æ–°å¢æ”¶è—åŠŸèƒ½è¡¨ï¼ˆ`knowledge_favorites`ï¼‰

**å½“å‰ç‰ˆæœ¬æ•°æ®åº“ç‰ˆæœ¬**ï¼šä¿æŒRoom v12ä¸å˜ï¼Œæ— éœ€Migrationã€‚

---

## 4. é”™è¯¯å¤„ç†è®¾è®¡

### 4.1 é”™è¯¯ç±»å‹å®šä¹‰

> **æ³¨æ„**ï¼š`KnowledgeQueryError`å¯†å°ç±»å·²åœ¨[3.2.1èŠ‚](#321-knowledgequeryerroré”™è¯¯ç±»å‹å®šä¹‰---æ–°å¢)å®Œæ•´å®šä¹‰ï¼Œæ­¤å¤„ä»…ä½œå¼•ç”¨è¯´æ˜ã€‚

é”™è¯¯ç±»å‹åŒ…æ‹¬ï¼š
- `InvalidContent` - æŸ¥è¯¢å†…å®¹æ— æ•ˆ
- `NoProviderConfigured` - æœªé…ç½®AIæœåŠ¡å•†
- `NetworkQueryFailed` - è”ç½‘æŸ¥è¯¢å¤±è´¥
- `LocalQueryFailed` - æœ¬åœ°AIæŸ¥è¯¢å¤±è´¥
- `ParseError` - å“åº”è§£æå¤±è´¥
- `Timeout` - æŸ¥è¯¢è¶…æ—¶

### 4.2 é”™è¯¯å¤„ç†ç­–ç•¥

| é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·æç¤º |
|---------|---------|---------|
| InvalidContent | å‰ç«¯éªŒè¯æ‹¦æˆª | "è¯·è¾“å…¥æœ‰æ•ˆçš„æŸ¥è¯¢å†…å®¹" |
| NoProviderConfigured | å¼•å¯¼é…ç½® | "è¯·å…ˆé…ç½®AIæœåŠ¡å•†" + è·³è½¬æŒ‰é’® |
| NetworkQueryFailed | è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°AI | "è”ç½‘è·å–å¤±è´¥ï¼Œå·²ä½¿ç”¨AIçŸ¥è¯†å›ç­”" |
| LocalQueryFailed | æ˜¾ç¤ºé”™è¯¯ï¼Œæä¾›é‡è¯• | "æŸ¥è¯¢å¤±è´¥ï¼Œè¯·é‡è¯•" + é‡è¯•æŒ‰é’® |
| ParseError | æ˜¾ç¤ºé”™è¯¯ï¼Œæä¾›é‡è¯• | "å†…å®¹è§£æå¼‚å¸¸ï¼Œè¯·é‡è¯•" |
| Timeout | æ˜¾ç¤ºé”™è¯¯ï¼Œæä¾›é‡è¯• | "æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·é‡è¯•" |

### 4.3 é™çº§ç­–ç•¥å®ç°

```kotlin
/**
 * è”ç½‘æŸ¥è¯¢ï¼ˆä¼˜å…ˆç­–ç•¥ï¼‰
 * å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°AI
 */
private suspend fun queryWithNetwork(
    query: KnowledgeQuery,
    provider: AiProvider
): Result<KnowledgeResponse> {
    return try {
        aiRepository.queryKnowledgeWithNetwork(
            provider = provider,
            content = query.getCleanedContent()
        )
    } catch (e: Exception) {
        // è”ç½‘å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°AI
        Log.w("QueryKnowledgeUseCase", "è”ç½‘æŸ¥è¯¢å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°AI", e)
        queryWithLocalAI(query, provider)
    }
}
```

---

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| è”ç½‘æŸ¥è¯¢å“åº” | â‰¤ 3s | åŒ…å«ç½‘ç»œè¯·æ±‚å’ŒAIå¤„ç†æ—¶é—´ |
| æœ¬åœ°AIå“åº” | â‰¤ 2s | çº¯AIç”Ÿæˆæ—¶é—´ |
| Tabåˆ‡æ¢ | < 50ms | ç”¨æˆ·æ„ŸçŸ¥æ— å»¶è¿Ÿ |
| Markdownæ¸²æŸ“ | < 100ms | å†…å®¹å±•ç¤ºæµç•… |
| å†…å­˜å ç”¨å¢é‡ | < 3MB | æ–°åŠŸèƒ½å¸¦æ¥çš„é¢å¤–å†…å­˜ |

### 5.2 ä¼˜åŒ–ç­–ç•¥

#### 5.2.1 Markdownæ¸²æŸ“ä¼˜åŒ–

```kotlin
// ä½¿ç”¨Markwonåº“çš„ç¼“å­˜æœºåˆ¶
private val markwon: Markwon by lazy {
    Markwon.builder(context)
        .usePlugin(ImagesPlugin.create())
        .usePlugin(TablePlugin.create(context))
        .build()
}

// å¼‚æ­¥æ¸²æŸ“é•¿æ–‡æœ¬
fun setContent(response: KnowledgeResponse) {
    lifecycleScope.launch {
        val markdown = withContext(Dispatchers.Default) {
            markwon.toMarkdown(response.getDisplayContent())
        }
        withContext(Dispatchers.Main) {
            markwon.setParsedMarkdown(contentText, markdown)
        }
    }
}
```

#### 5.2.2 ç½‘ç»œè¯·æ±‚ä¼˜åŒ–

```kotlin
// ä½¿ç”¨åç¨‹è¶…æ—¶æ§åˆ¶
suspend fun queryKnowledgeWithNetwork(...): Result<KnowledgeResponse> = 
    withContext(ioDispatcher) {
        try {
            withTimeout(3000L) {  // 3ç§’è¶…æ—¶
                val response = callAi(provider, systemInstruction, content)
                val result = parseKnowledgeResponse(response, isFromNetwork = true)
                Result.success(result)
            }
        } catch (e: TimeoutCancellationException) {
            Result.failure(KnowledgeQueryError.Timeout)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
```

#### 5.2.3 å†…å­˜ç®¡ç†

```kotlin
// é™åˆ¶æ¨èåˆ—è¡¨æ•°é‡
fun parseKnowledgeResponse(...): KnowledgeResponse {
    val parsed = adapter.fromJson(cleanedJson) ?: throw ParseError()
    
    // é™åˆ¶æ¨èæ•°é‡ä¸º5ä¸ª
    return parsed.copy(
        recommendations = parsed.recommendations.take(5)
    )
}

// æ¸…ç†æ—§ç»“æœ
fun showResult(response: KnowledgeResponse) {
    // æ¸…ç©ºä¹‹å‰çš„ç»“æœï¼Œé‡Šæ”¾å†…å­˜
    resultContainer.removeAllViews()
    
    // æ·»åŠ æ–°ç»“æœ
    val resultCard = KnowledgeResultCard(context)
    resultCard.setContent(response)
    resultContainer.addView(resultCard)
}
```

---

## 6. æµ‹è¯•ç­–ç•¥

### 6.1 å•å…ƒæµ‹è¯•

#### 6.1.1 QueryKnowledgeUseCaseTest

**æ–‡ä»¶ä½ç½®**: `domain/src/test/kotlin/com/empathy/ai/domain/usecase/QueryKnowledgeUseCaseTest.kt`

```kotlin
@OptIn(ExperimentalCoroutinesApi::class)
class QueryKnowledgeUseCaseTest {
    
    @MockK private lateinit var aiRepository: AiRepository
    @MockK private lateinit var aiProviderRepository: AiProviderRepository
    
    private lateinit var useCase: QueryKnowledgeUseCase
    
    @Before
    fun setup() {
        MockKAnnotations.init(this)
        useCase = QueryKnowledgeUseCase(aiRepository, aiProviderRepository)
    }
    
    @Test
    fun `æŸ¥è¯¢å†…å®¹æ— æ•ˆæ—¶è¿”å›é”™è¯¯`() = runTest {
        // Given
        val query = KnowledgeQuery(content = "")
        
        // When
        val result = useCase(query)
        
        // Then
        assertTrue(result.isFailure)
        assertTrue(result.exceptionOrNull() is IllegalArgumentException)
    }
    
    @Test
    fun `æœªé…ç½®AIæœåŠ¡å•†æ—¶è¿”å›é”™è¯¯`() = runTest {
        // Given
        val query = KnowledgeQuery(content = "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½")
        coEvery { aiProviderRepository.getDefaultProvider() } returns 
            Result.failure(Exception("æœªé…ç½®"))
        
        // When
        val result = useCase(query)
        
        // Then
        assertTrue(result.isFailure)
    }
    
    @Test
    fun `æ¨¡å‹æ”¯æŒè”ç½‘æ—¶ä¼˜å…ˆä½¿ç”¨è”ç½‘æŸ¥è¯¢`() = runTest {
        // Given
        val query = KnowledgeQuery(content = "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½")
        val provider = mockProvider(modelName = "deepseek-search")
        
        coEvery { aiProviderRepository.getDefaultProvider() } returns 
            Result.success(provider)
        coEvery { aiRepository.queryKnowledgeWithNetwork(any(), any()) } returns 
            Result.success(mockNetworkResponse)
        
        // When
        val result = useCase(query)
        
        // Then
        coVerify { aiRepository.queryKnowledgeWithNetwork(any(), any()) }
        coVerify(exactly = 0) { aiRepository.queryKnowledgeLocal(any(), any()) }
        assertTrue(result.isSuccess)
        assertTrue(result.getOrNull()?.isFromNetwork == true)
    }
    
    @Test
    fun `è”ç½‘æŸ¥è¯¢å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°AI`() = runTest {
        // Given
        val query = KnowledgeQuery(content = "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½")
        val provider = mockProvider(modelName = "deepseek-search")
        
        coEvery { aiProviderRepository.getDefaultProvider() } returns 
            Result.success(provider)
        coEvery { aiRepository.queryKnowledgeWithNetwork(any(), any()) } throws 
            Exception("ç½‘ç»œé”™è¯¯")
        coEvery { aiRepository.queryKnowledgeLocal(any(), any()) } returns 
            Result.success(mockLocalResponse)
        
        // When
        val result = useCase(query)
        
        // Then
        coVerify { aiRepository.queryKnowledgeWithNetwork(any(), any()) }
        coVerify { aiRepository.queryKnowledgeLocal(any(), any()) }
        assertTrue(result.isSuccess)
        assertFalse(result.getOrNull()?.isFromNetwork == true)
    }
    
    @Test
    fun `æ¨¡å‹ä¸æ”¯æŒè”ç½‘æ—¶ç›´æ¥ä½¿ç”¨æœ¬åœ°AI`() = runTest {
        // Given
        val query = KnowledgeQuery(content = "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½")
        val provider = mockProvider(modelName = "gpt-4")
        
        coEvery { aiProviderRepository.getDefaultProvider() } returns 
            Result.success(provider)
        coEvery { aiRepository.queryKnowledgeLocal(any(), any()) } returns 
            Result.success(mockLocalResponse)
        
        // When
        val result = useCase(query)
        
        // Then
        coVerify(exactly = 0) { aiRepository.queryKnowledgeWithNetwork(any(), any()) }
        coVerify { aiRepository.queryKnowledgeLocal(any(), any()) }
        assertTrue(result.isSuccess)
    }
}
```


### 6.2 é›†æˆæµ‹è¯•

#### 6.2.1 KnowledgeTabIntegrationTest

**æ–‡ä»¶ä½ç½®**: `app/src/androidTest/kotlin/com/empathy/ai/ui/floating/KnowledgeTabIntegrationTest.kt`

```kotlin
@HiltAndroidTest
class KnowledgeTabIntegrationTest {
    
    @get:Rule
    val hiltRule = HiltAndroidRule(this)
    
    @Inject lateinit var queryKnowledgeUseCase: QueryKnowledgeUseCase
    
    private lateinit var knowledgeTab: KnowledgeTab
    
    @Before
    fun setup() {
        hiltRule.inject()
        knowledgeTab = KnowledgeTab(ApplicationProvider.getApplicationContext())
    }
    
    @Test
    fun `è¾“å…¥å†…å®¹åæŸ¥è¯¢æŒ‰é’®å¯ç”¨`() {
        // Given
        val inputField = knowledgeTab.findViewById<EditText>(R.id.input_field)
        val queryButton = knowledgeTab.findViewById<MaterialButton>(R.id.query_button)
        
        // When
        inputField.setText("ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½")
        
        // Then
        assertTrue(queryButton.isEnabled)
    }
    
    @Test
    fun `è¾“å…¥ä¸ºç©ºæ—¶æŸ¥è¯¢æŒ‰é’®ç¦ç”¨`() {
        // Given
        val inputField = knowledgeTab.findViewById<EditText>(R.id.input_field)
        val queryButton = knowledgeTab.findViewById<MaterialButton>(R.id.query_button)
        
        // When
        inputField.setText("")
        
        // Then
        assertFalse(queryButton.isEnabled)
    }
    
    @Test
    fun `è¶…å‡ºå­—ç¬¦é™åˆ¶æ—¶æ˜¾ç¤ºçº¢è‰²æç¤º`() {
        // Given
        val inputField = knowledgeTab.findViewById<EditText>(R.id.input_field)
        val charCount = knowledgeTab.findViewById<TextView>(R.id.char_count)
        
        // When
        inputField.setText("a".repeat(501))
        
        // Then
        assertEquals(Color.RED, charCount.currentTextColor)
    }
    
    @Test
    fun `å®Œæ•´æŸ¥è¯¢æµç¨‹æµ‹è¯•`() = runTest {
        // Given
        var queryResult: KnowledgeResponse? = null
        knowledgeTab.onQueryClick = { content ->
            runBlocking {
                val query = KnowledgeQuery(content = content)
                val result = queryKnowledgeUseCase(query)
                queryResult = result.getOrNull()
            }
        }
        
        // When
        val inputField = knowledgeTab.findViewById<EditText>(R.id.input_field)
        inputField.setText("ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½")
        knowledgeTab.findViewById<MaterialButton>(R.id.query_button).performClick()
        
        // Then
        assertNotNull(queryResult)
        assertTrue(queryResult!!.content.isNotBlank())
    }
}
```

### 6.3 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | é‡ç‚¹æµ‹è¯•é¡¹ |
|------|-----------|-----------|
| QueryKnowledgeUseCase | â‰¥90% | è”ç½‘/æœ¬åœ°åˆ†æ”¯ã€é™çº§é€»è¾‘ã€é”™è¯¯å¤„ç† |
| KnowledgeTab | â‰¥85% | è¾“å…¥éªŒè¯ã€æŒ‰é’®çŠ¶æ€ã€ç»“æœå±•ç¤º |
| KnowledgeResultCard | â‰¥80% | Markdownæ¸²æŸ“ã€æ¨èåˆ—è¡¨ã€ç‚¹å‡»äº‹ä»¶ |
| AiRepositoryImpl | â‰¥90% | è”ç½‘æŸ¥è¯¢ã€æœ¬åœ°æŸ¥è¯¢ã€å“åº”è§£æ |

---

## 7. æ–‡ä»¶å˜æ›´æ¸…å•

### 7.1 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ç±»å‹ | è¯´æ˜ |
|---------|------|------|
| `domain/model/KnowledgeQuery.kt` | Model | çŸ¥è¯†æŸ¥è¯¢è¯·æ±‚æ¨¡å‹ |
| `domain/model/KnowledgeResponse.kt` | Model | çŸ¥è¯†æŸ¥è¯¢å“åº”æ¨¡å‹ |
| `domain/model/Recommendation.kt` | Model | æ¨èé¡¹æ¨¡å‹ |
| `domain/usecase/QueryKnowledgeUseCase.kt` | UseCase | çŸ¥è¯†æŸ¥è¯¢ç”¨ä¾‹ |
| `presentation/ui/floating/KnowledgeTab.kt` | UI | çŸ¥è¯†é—®ç­”Tab |
| `presentation/ui/floating/KnowledgeResultCard.kt` | UI | ç»“æœå¡ç‰‡ |
| `app/di/KnowledgeModule.kt` | DI | ä¾èµ–æ³¨å…¥æ¨¡å— |
| `res/layout/floating_knowledge_tab.xml` | Layout | Tabå¸ƒå±€ |
| `res/layout/floating_knowledge_result.xml` | Layout | ç»“æœå¡ç‰‡å¸ƒå±€ |
| `res/layout/item_recommendation.xml` | Layout | æ¨èé¡¹å¸ƒå±€ |

### 7.2 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|---------|----------|
| `domain/model/ActionType.kt` | æ·»åŠ KNOWLEDGEç±»å‹ |
| `domain/repository/AiRepository.kt` | æ·»åŠ queryKnowledgeWithNetworkã€queryKnowledgeLocalæ–¹æ³• |
| `data/repository/AiRepositoryImpl.kt` | å®ç°æ–°å¢çš„æ¥å£æ–¹æ³• |
| `presentation/ui/floating/FloatingView.kt` | æ·»åŠ ç¬¬4ä¸ªTab |
| `app/service/FloatingWindowService.kt` | é›†æˆçŸ¥è¯†æŸ¥è¯¢åŠŸèƒ½ |
| `gradle/libs.versions.toml` | æ·»åŠ Markwonä¾èµ– |

### 7.3 æµ‹è¯•æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `test/domain/usecase/QueryKnowledgeUseCaseTest.kt` | çŸ¥è¯†æŸ¥è¯¢ç”¨ä¾‹å•å…ƒæµ‹è¯• |
| `test/domain/model/KnowledgeQueryTest.kt` | æŸ¥è¯¢æ¨¡å‹æµ‹è¯• |
| `test/domain/model/KnowledgeResponseTest.kt` | å“åº”æ¨¡å‹æµ‹è¯• |
| `androidTest/ui/floating/KnowledgeTabIntegrationTest.kt` | Tabé›†æˆæµ‹è¯• |
| `androidTest/ui/floating/KnowledgeResultCardTest.kt` | ç»“æœå¡ç‰‡UIæµ‹è¯• |

---

## 8. ä¾èµ–ç®¡ç†

### 8.1 æ–°å¢ä¾èµ–

**æ–‡ä»¶ä½ç½®**: `gradle/libs.versions.toml`

```toml
[versions]
markwon = "4.6.2"

[libraries]
# Markdownæ¸²æŸ“
markwon-core = { module = "io.noties.markwon:core", version.ref = "markwon" }
markwon-image = { module = "io.noties.markwon:image", version.ref = "markwon" }
markwon-tables = { module = "io.noties.markwon:ext-tables", version.ref = "markwon" }
```

**æ–‡ä»¶ä½ç½®**: `presentation/build.gradle.kts`

```kotlin
dependencies {
    // ... å·²æœ‰ä¾èµ– ...
    
    // ğŸ†• Markdownæ¸²æŸ“
    implementation(libs.markwon.core)
    implementation(libs.markwon.image)
    implementation(libs.markwon.tables)
}
```

---

## 9. éƒ¨ç½²ä¸å‘å¸ƒ

### 9.1 ç‰ˆæœ¬è§„åˆ’

| ç‰ˆæœ¬ | åŠŸèƒ½èŒƒå›´ | å‘å¸ƒæ—¶é—´ |
|------|----------|----------|
| v1.0 (MVP) | åŸºç¡€çŸ¥è¯†æŸ¥è¯¢ã€è”ç½‘ä¼˜å…ˆã€AIå…œåº• | ç¬¬1å‘¨ |
| v1.1 | æ¨èåŠŸèƒ½ä¼˜åŒ–ã€å†å²è®°å½• | ç¬¬2å‘¨ |
| v1.2 | è¯­éŸ³è¾“å…¥ã€åˆ†äº«åŠŸèƒ½ | ç¬¬3å‘¨ |

### 9.2 å‘å¸ƒæ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] UIæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
- [ ] å†…å­˜æ³„æ¼æ£€æŸ¥
- [ ] ä»£ç å®¡æŸ¥å®Œæˆ
- [ ] æ–‡æ¡£æ›´æ–°å®Œæˆ
- [ ] ç”¨æˆ·æ‰‹å†Œæ›´æ–°

---

## 10. é£é™©ä¸ç¼“è§£

### 10.1 é£é™©è¯†åˆ«

| é£é™© | å½±å“ | å¯èƒ½æ€§ | ä¼˜å…ˆçº§ |
|------|------|--------|--------|
| AIæ¨¡å‹ä¸æ”¯æŒè”ç½‘ | åŠŸèƒ½é™çº§ | ä¸­ | ğŸŸ¡ ä¸­ |
| Markdownæ¸²æŸ“æ€§èƒ½é—®é¢˜ | ç”¨æˆ·ä½“éªŒä¸‹é™ | ä½ | ğŸŸ¢ ä½ |
| ç½‘ç»œè¶…æ—¶é¢‘ç¹ | ç”¨æˆ·æµå¤± | ä¸­ | ğŸŸ¡ ä¸­ |
| æ¨èå†…å®¹ä¸å‡†ç¡® | ç”¨æˆ·ä½“éªŒä¸‹é™ | ä½ | ğŸŸ¢ ä½ |

### 10.2 ç¼“è§£æªæ–½

| é£é™© | ç¼“è§£æªæ–½ |
|------|----------|
| AIæ¨¡å‹ä¸æ”¯æŒè”ç½‘ | å®Œå–„çš„é™çº§ç­–ç•¥ï¼Œæœ¬åœ°AIå…œåº• |
| Markdownæ¸²æŸ“æ€§èƒ½é—®é¢˜ | å¼‚æ­¥æ¸²æŸ“ã€ç¼“å­˜æœºåˆ¶ã€é™åˆ¶å†…å®¹é•¿åº¦ |
| ç½‘ç»œè¶…æ—¶é¢‘ç¹ | è¶…æ—¶é‡è¯•æœºåˆ¶ã€ç”¨æˆ·å¯é…ç½®è¶…æ—¶æ—¶é—´ |
| æ¨èå†…å®¹ä¸å‡†ç¡® | æç¤ºè¯ä¼˜åŒ–ã€ç”¨æˆ·åé¦ˆæœºåˆ¶ |

---

## 11. åç»­ä¼˜åŒ–æ–¹å‘

### 11.1 åŠŸèƒ½å¢å¼º

1. **å†å²æŸ¥è¯¢è®°å½•**
   - ä¿å­˜æœ€è¿‘çš„æŸ¥è¯¢å†å²
   - æ”¯æŒå¿«é€Ÿé‡æ–°æŸ¥è¯¢
   - æ”¯æŒå†å²è®°å½•æ¸…é™¤

2. **è¯­éŸ³è¾“å…¥æ”¯æŒ**
   - é›†æˆè¯­éŸ³è¯†åˆ«
   - æ”¯æŒè¯­éŸ³æŸ¥è¯¢
   - æå‡è¾“å…¥æ•ˆç‡

3. **æ”¶è—åŠŸèƒ½**
   - æ”¶è—æœ‰ç”¨çš„çŸ¥è¯†è§£é‡Š
   - æ”¯æŒæ ‡ç­¾åˆ†ç±»
   - æ”¯æŒå¯¼å‡ºåˆ†äº«

4. **å¤šè¯­è¨€æ”¯æŒ**
   - æ”¯æŒè‹±æ–‡æŸ¥è¯¢
   - æ”¯æŒå…¶ä»–è¯­è¨€
   - è‡ªåŠ¨è¯­è¨€æ£€æµ‹

### 11.2 æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜æœºåˆ¶**
   - ç¼“å­˜å¸¸è§æŸ¥è¯¢ç»“æœ
   - å‡å°‘é‡å¤AIè°ƒç”¨
   - æå‡å“åº”é€Ÿåº¦

2. **é¢„åŠ è½½ä¼˜åŒ–**
   - é¢„æµ‹ç”¨æˆ·å¯èƒ½çš„æŸ¥è¯¢
   - æå‰åŠ è½½æ¨èå†…å®¹
   - å‡å°‘ç­‰å¾…æ—¶é—´

3. **æµå¼è¾“å‡º**
   - æ”¯æŒAIæµå¼è¿”å›
   - å®æ—¶æ˜¾ç¤ºç”Ÿæˆå†…å®¹
   - æå‡ç”¨æˆ·ä½“éªŒ

---

## 12. é™„å½•

### 12.1 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| è”ç½‘æŸ¥è¯¢ | è°ƒç”¨æ”¯æŒè”ç½‘åŠŸèƒ½çš„AIæ¨¡å‹è·å–å®æ—¶ä¿¡æ¯ |
| æœ¬åœ°AI | ä½¿ç”¨AIæ¨¡å‹çš„é¢„è®­ç»ƒçŸ¥è¯†ç”Ÿæˆå›ç­” |
| é™çº§ç­–ç•¥ | è”ç½‘å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°AIçš„æœºåˆ¶ |
| Markdown | è½»é‡çº§æ ‡è®°è¯­è¨€ï¼Œç”¨äºæ ¼å¼åŒ–æ–‡æœ¬ |
| Markwon | Androidå¹³å°çš„Markdownæ¸²æŸ“åº“ |

### 12.2 å‚è€ƒèµ„æ–™

- [Markwonå®˜æ–¹æ–‡æ¡£](https://noties.io/Markwon/)
- [Material Design 3æŒ‡å—](https://m3.material.io/)
- [Kotlin Coroutinesæ–‡æ¡£](https://kotlinlang.org/docs/coroutines-overview.html)
- [Hiltä¾èµ–æ³¨å…¥æŒ‡å—](https://developer.android.com/training/dependency-injection/hilt-android)

---

## 13. è¯„å®¡è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯„å®¡äºº | å˜æ›´è¯´æ˜ |
|------|------|--------|----------|
| 1.0 | 2026-01-07 | Kiro | åˆå§‹ç‰ˆæœ¬ |
| 1.1 | 2026-01-07 | Kiro | æ ¹æ®REVIEW-TDD-00031å®¡æŸ¥æŠ¥å‘Šä¿®è®¢ï¼š<br>- æ·»åŠ 1.4èŠ‚UIæ¡†æ¶é€‰å‹è¯´æ˜ï¼ˆP0ï¼‰<br>- å®Œå–„Repositoryæ¥å£KDocæ³¨é‡Šå’Œå¼‚å¸¸è¯´æ˜ï¼ˆP1ï¼‰<br>- æ·»åŠ KnowledgeQueryErrorå¯†å°ç±»å¹¶é›†æˆåˆ°UseCaseï¼ˆP1ï¼‰<br>- æ·»åŠ 3.8èŠ‚æ•°æ®åº“è®¾è®¡è¯´æ˜ï¼ˆP2ï¼‰<br>- æ·»åŠ AiRepositoryImplè¶…æ—¶é…ç½®å¸¸é‡ï¼ˆP2ï¼‰<br>- ç§»é™¤ç¬¬4ç« é‡å¤çš„é”™è¯¯ç±»å‹å®šä¹‰ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.1
**æœ€åæ›´æ–°**: 2026-01-07
**ç»´æŠ¤å›¢é˜Ÿ**: å¼€å‘å›¢é˜Ÿ
**å®¡æ ¸çŠ¶æ€**: âœ… å®¡æŸ¥ä¿®è®¢å®Œæˆ

