# TDD-00034：界面切换性能优化 - 页面缓存方案技术设计

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档类型 | TDD (Technical Design Document) |
| 文档编号 | TDD-00034 |
| 功能名称 | 界面切换性能优化 - 页面缓存方案 |
| 版本 | 1.2 |
| 创建日期 | 2026-01-10 |
| 最后更新 | 2026-01-10 |
| 作者 | Codex |
| 审核人 | - |
| 审核状态 | 待审核 |
| 关联文档 | PRD-00034, BUG-00060, DR-00034 |

---

## 2. 背景与目标

### 2.1 背景

当前应用在底部导航切换和复杂页面进入时出现黑屏闪动、卡顿。现有导航与动画配置导致页面重建与淡入淡出背景暴露，影响体验。

### 2.2 目标

- 消除底部Tab切换黑屏闪动
- 切换延迟降低到 < 100ms
- 保持页面状态（滚动位置、筛选状态等）
- 兼容现有导航与模块结构

### 2.3 非目标

- 不在本次范围内实现 Nav3 迁移
- 不调整现有业务功能逻辑
- 不扩展底部Tab数量（保持当前3个Tab）

---

## 3. 现状分析

### 3.1 关键现状

- 导航转场使用 `AnimationSpec` 的 `fadeIn/fadeOut`，可能露出黑色背景。
- 底部导航栏目前由 `ContactListScreen` 与 `SettingsScreen` 内部 `Scaffold` 自行渲染，导致切换依赖导航重建。
- `NavRoutes.BOTTOM_NAV_ROUTES` 仅包含 `CONTACT_LIST / AI_ADVISOR / SETTINGS`，与PRD修订后的范围一致。
- 依赖版本中 `navigation-compose` 为 2.8.5，需以现有版本行为验证转场覆盖与重建细节。

### 3.2 影响

- 页面切换存在可感知卡顿
- 页面状态未能稳定保留
- 黑屏闪动在弱机型上更明显

---

## 4. 总体方案

### 4.1 Phase 1（P0）

- 调整 `AnimationSpec` 移除 `fadeIn/fadeOut`
- 缩短页面切换时长

### 4.2 Phase 2（P0）

- 引入底部Tab页面缓存容器 `BottomNavScaffold`
- Tab内容仅首次加载时创建，后续保持在内存中
- 底部导航统一放在 `BottomNavScaffold`，Tab页面移除自身底部导航

### 4.3 Phase 3（P2，可选）

- 为复杂页面增加骨架屏

---

## 5. 详细设计

### 5.1 动画规范调整

**文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/theme/AnimationSpec.kt`

- 移除页面转场中的 `fadeIn/fadeOut`
- 调整时长：进入 200ms，退出 150ms
- 保持滑动方向与原交互一致

示例:

```kotlin
const val DurationPageEnter = 200
const val DurationPageExit = 150

val PageEnterTransition = slideInHorizontally(
    initialOffsetX = { fullWidth -> fullWidth },
    animationSpec = tween(DurationPageEnter, easing = FastOutSlowInEasing)
)

val PageExitTransition = slideOutHorizontally(
    targetOffsetX = { fullWidth -> -fullWidth / 4 },
    animationSpec = tween(DurationPageExit, easing = FastOutSlowInEasing)
)
```

### 5.2 底部Tab缓存架构

**新增文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/navigation/BottomNavScaffold.kt`

核心原则:

- 只切换可见性，不销毁已访问页面
- 未访问页面不创建（懒加载）
- 切换无淡入淡出，避免黑屏

**Tab定义**:

- 联系人（CONTACT_LIST）
- AI军师（AI_ADVISOR）
- 设置（SETTINGS）

#### 5.2.1 依赖引用

- `SaveableStateHolder` 来源：`androidx.compose.runtime.saveable`

示例引用:

```kotlin
import androidx.compose.runtime.saveable.SaveableStateHolder
import androidx.compose.runtime.saveable.rememberSaveableStateHolder
```

#### 5.2.2 BottomNavTab 枚举

**新增文件**: `presentation/src/main/kotlin/com/empathy/ai/presentation/navigation/BottomNavTab.kt`

```kotlin
package com.empathy.ai.presentation.navigation

/**
 * 底部导航Tab枚举
 * 与 NavRoutes.BOTTOM_NAV_ROUTES 保持一致
 */
enum class BottomNavTab(val route: String) {
    CONTACTS(NavRoutes.CONTACT_LIST),
    AI_ADVISOR(NavRoutes.AI_ADVISOR),
    SETTINGS(NavRoutes.SETTINGS);

    companion object {
        fun fromRoute(route: String?): BottomNavTab? {
            return entries.find { it.route == route }
        }
    }
}
```

#### 5.2.3 懒加载数据结构

- `visitedTabs` 统一使用 `List<String>`
- 原因：`rememberSaveable` 原生支持 `List`，避免 `Set` 需要自定义 Saver

#### 5.2.4 触摸拦截策略

不可见Tab需要拦截触摸事件，避免透传到隐藏页面：

- 使用 `pointerInput` 消费事件
- 使用 `alpha` 或 `graphicsLayer` 控制可见性

示例:

```kotlin
Box(
    modifier = Modifier
        .fillMaxSize()
        .alpha(if (visible) 1f else 0f)
        .pointerInput(visible) {
            if (!visible) {
                awaitPointerEventScope {
                    while (true) {
                        val event = awaitPointerEvent()
                        event.changes.forEach { it.consume() }
                    }
                }
            }
        }
) {
    content()
}
```

#### 5.2.5 资源清理策略

- 当前Tab数量固定为3个，不做自动淘汰
- 在退出登录或清理缓存时调用 `stateHolder.removeState(route)` 或整体重建 `BottomNavScaffold`
- 如后续Tab扩展，可考虑 LRU 淘汰最久未访问页面

### 5.3 MainActivity 与导航调整

**文件**: `app/src/main/java/com/empathy/ai/ui/MainActivity.kt`

- 引入 `BottomNavScaffold` 作为主Tab容器
- `NavGraph` 仍用于非Tab页面
- Tab切换只更新 `currentTab`，非Tab导航通过 `navController.navigate`

判断逻辑:

- `currentRoute == null` 或 `currentRoute in NavRoutes.BOTTOM_NAV_ROUTES` -> 显示 `BottomNavScaffold`
- 其他路由 -> 显示 `NavGraph`

#### 5.3.1 状态迁移方案

从 NavHost 迁移到 `BottomNavScaffold` 时，需确保状态保持一致:

1. `currentTab` 初始值由 `currentRoute` 映射
2. Tab切换不再走 `NavController.navigate`
3. 仅非Tab页面仍走导航栈，避免混用造成状态丢失
4. 配置变更后，`currentTab` 与 `visitedTabs` 通过 `rememberSaveable` 恢复

### 5.4 Tab页面去底部导航

当前 `ContactListScreen` 与 `SettingsScreen` 内部自带底部导航，需要拆分:

- 增加参数 `showBottomBar: Boolean = true`
- 当在 `BottomNavScaffold` 中使用时传入 `false`
- 仅保留主容器中的 `EmpathyBottomNavigation`

### 5.5 资源与导航回调统一

- `EmpathyBottomNavigation` 只负责回调 `onNavigate(route)`
- Tab页内部通过 `onTabSelected` 切换
- 非Tab跳转统一由 `navController.navigate` 完成

---

## 6. 兼容性与影响

- ViewModel 作用域：Tab页从 NavHost 迁移到主容器后，默认作用域变为 Activity。需确认是否存在依赖 `SavedStateHandle` 的场景。
- 若需要保持每Tab独立 ViewModel，可为每Tab提供独立 `ViewModelStoreOwner`。

---

## 7. 测试计划

### 7.1 功能测试

- TC-001: Tab切换无黑屏
- TC-002: 页面状态保持
- TC-004: 非Tab页面导航正常
- TC-005: 配置变更后状态恢复

### 7.2 性能测试

- 切换延迟 < 100ms
- 内存增加 < 20MB

---

## 8. 风险评估

| 风险 | 等级 | 说明 | 缓解措施 |
|------|------|------|----------|
| 内存占用增加 | 中 | 多Tab常驻内存 | 懒加载+按需保留 |
| ViewModel作用域变化 | 中 | 生命周期变长 | 评估依赖并必要时改为独立Store |

---

## 9. 任务分解

### Phase 1

- T34-01 更新 `AnimationSpec` 去除淡入淡出
- T34-02 调整动画时长

### Phase 2

- T34-03 新增 `BottomNavScaffold`
- T34-04 增加 `BottomNavTab` 定义
- T34-05 MainActivity 接入缓存方案
- T34-06 ContactListScreen/SettingsScreen 去底部导航
- T34-07 Tab导航回调调整

### Phase 3（可选）

- T34-08 添加骨架屏组件与集成

---

## 10. 验收标准

- Tab切换无黑屏闪烁
- 切换延迟 < 100ms
- 页面状态保持
- 非Tab页面导航正常
- 配置变更后Tab状态正确恢复

---

**文档版本**: 1.2
**最后更新**: 2026-01-10
**更新内容**: 补充依赖来源、枚举位置、触摸拦截、资源清理与状态迁移方案，统一懒加载数据结构
