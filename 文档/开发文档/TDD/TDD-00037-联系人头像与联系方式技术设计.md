# TDD-00037: è”ç³»äººå¤´åƒä¸è”ç³»æ–¹å¼æŠ€æœ¯è®¾è®¡

> **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯è®¾è®¡æ–‡æ¡£ (TDD)  
> **ç‰ˆæœ¬**: 1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-20  
> **æ›´æ–°æ—¥æœŸ**: 2026-01-20  
> **è´Ÿè´£äºº**: Codex  
> **å…³è”PRD**: PRD-00037  
> **å…³è”FD**: FD-00037  
> **çŠ¶æ€**: ğŸ“ è‰ç¨¿  

---

## 0. æ–‡æ¡£èƒŒæ™¯

### 0.1 èƒŒæ™¯è¯´æ˜

æœ¬æŠ€æœ¯è®¾è®¡æ–‡æ¡£åŸºäº PRD-00037 ä¸ FD-00037ï¼Œç›®æ ‡æ˜¯åœ¨è”ç³»äººåˆ›å»º/ç¼–è¾‘ä¸è¯¦æƒ…å±•ç¤ºä¸­è¡¥é½â€œå¤´åƒä¸Šä¼ æ›´æ¢â€ä¸â€œè”ç³»æ–¹å¼å±•ç¤ºâ€èƒ½åŠ›ã€‚

### 0.2 æ–‡æ¡£ç›®çš„

- æ˜ç¡®æ•°æ®æ¨¡å‹ä¸æ•°æ®åº“è¿ç§»æ–¹æ¡ˆ  
- ç»™å‡ºå¤´åƒä¸Šä¼ /è£å‰ªçš„æŠ€æœ¯é“¾è·¯  
- ç»Ÿä¸€è”ç³»äººè¯¦æƒ…ä¸åˆ›å»ºæµç¨‹ä¸­çš„æ•°æ®æµä¸çŠ¶æ€ç®¡ç†  

### 0.3 è¯»è€…å¯¹è±¡

- Android å¼€å‘å·¥ç¨‹å¸ˆ  
- æµ‹è¯•å·¥ç¨‹å¸ˆ  
- ä»£ç å®¡æŸ¥äººå‘˜  

### 0.4 å‚è€ƒæ–‡æ¡£

| æ–‡æ¡£ç¼–å· | æ–‡æ¡£åç§° | è¯´æ˜ |
|----------|----------|------|
| PRD-00037 | è”ç³»äººå¤´åƒä¸è”ç³»æ–¹å¼éœ€æ±‚ | éœ€æ±‚æ–‡æ¡£ |
| FD-00037 | è”ç³»äººå¤´åƒä¸è”ç³»æ–¹å¼åŠŸèƒ½è®¾è®¡ | åŠŸèƒ½è®¾è®¡ |
| TDD-00020 | è”ç³»äººè¯¦æƒ…é¡µUIä¼˜åŒ–æŠ€æœ¯è®¾è®¡ | è¯¦æƒ…é¡µæ¶æ„å‚è€ƒ |

---

## 1. æŠ€æœ¯æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

1. è”ç³»æ–¹å¼å¯è¾“å…¥ã€å¯ç¼–è¾‘ã€è¯¦æƒ…é¡µåŸºç¡€ä¿¡æ¯åŒºå±•ç¤º  
2. å¤´åƒæ”¯æŒç›¸å†Œ/æ‹ç…§ä¸Šä¼ ä¸è£å‰ªï¼Œæ”¯æŒå¤šæ¬¡æ›´æ¢  
3. é»˜è®¤å¤´åƒä½¿ç”¨å§“åé¦–å­— + éšæœºèƒŒæ™¯è‰²  
4. æ•°æ®ä»…æœ¬åœ°ä¿å­˜ï¼Œæ— äº‘åŒæ­¥  

### 1.2 çº¦æŸä¸åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| Clean Architecture | domain æ—  Android ä¾èµ– |
| æœ¬åœ°ä¼˜å…ˆ | ä»…æœ¬åœ°å­˜å‚¨ï¼Œä¸å¼•å…¥äº‘åŒæ­¥ |
| ä½ä¾µå…¥ | å°½é‡å¤ç”¨ç°æœ‰ UI ç»„ä»¶ä¸ç”¨ä¾‹ |
| å¤±è´¥å¯æ¢å¤ | ä¸Šä¼ /è£å‰ªå¤±è´¥ä¸å½±å“è”ç³»äººä¿å­˜ |

### 1.3 æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Kotlin | 2.0.21 | ä¸»è¦å¼€å‘è¯­è¨€ |
| Jetpack Compose | BOM 2024.12.01 | UI |
| Room | 2.6.1 | æœ¬åœ°æ•°æ®åº“ |
| Hilt | 2.52 | ä¾èµ–æ³¨å…¥ |
| Coil | 2.x | å¤´åƒå›¾ç‰‡åŠ è½½ |
| ActivityResult API | AndroidX | ç›¸å†Œ/æ‹ç…§/è£å‰ª |

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ¨¡å—åˆ’åˆ†

```
domain/
  model/ContactProfile.kt               (æ–°å¢è”ç³»æ–¹å¼/é¢œè‰²å­—æ®µ)
  repository/ContactRepository.kt       (æ–°å¢æ›´æ–°æ¥å£)
  usecase/EditContactInfoUseCase.kt     (æ‰©å±•è”ç³»æ–¹å¼ç¼–è¾‘)

data/
  local/entity/ContactProfileEntity.kt  (æ–°å¢å­—æ®µ)
  local/dao/ContactDao.kt               (æ–°å¢æ›´æ–°æ–¹æ³•)
  local/AppDatabase.kt                  (ç‰ˆæœ¬å‡çº§ v17)
  di/DatabaseModule.kt                  (MIGRATION_16_17)
  repository/ContactRepositoryImpl.kt   (æ˜ å°„ä¸æ›´æ–°)

presentation/
  ui/component/contact/ContactFormCard.kt     (å ä½æ–‡æ¡ˆè°ƒæ•´)
  ui/component/contact/AvatarPicker.kt        (æ¥å…¥æ‹ç…§/ç›¸å†Œ)
  ui/component/overview/IdentityCard.kt       (å±•ç¤ºè”ç³»æ–¹å¼/é»˜è®¤å¤´åƒè‰²)
  ui/screen/contact/CreateContactScreen.kt    (å¤´åƒé€‰æ‹©/è”ç³»æ–¹å¼ä¿å­˜)
  ui/screen/contact/ContactDetailTabScreen.kt (ç¼–è¾‘å…¥å£)
  ui/component/dialog/EditContactInfoDialog.kt (æ‰©å±•è”ç³»æ–¹å¼/å¤´åƒç¼–è¾‘)
  viewmodel/ContactDetailViewModel.kt         (äº‹ä»¶ä¸ä¿å­˜é€»è¾‘)
```

### 2.2 å…³é”®æ•°æ®æµ

```
æ–°å»ºè”ç³»äºº
  -> CreateContactScreen è¡¨å•è¾“å…¥ï¼ˆè”ç³»æ–¹å¼ã€å¤´åƒï¼‰
  -> SaveProfileUseCase ä¿å­˜ ContactProfileï¼ˆcontactInfo/avatarUrl/avatarColorSeedï¼‰
  -> è”ç³»äººè¯¦æƒ…é¡µå±•ç¤ºè”ç³»æ–¹å¼ + å¤´åƒ

ç¼–è¾‘è”ç³»äºº
  -> è¯¦æƒ…é¡µâ€œç¼–è¾‘â€è¿›å…¥ç¼–è¾‘å¯¹è¯æ¡†
  -> æ›´æ–°è”ç³»æ–¹å¼/å¤´åƒ
  -> EditContactInfoUseCase + ContactRepository.updateContactInfo/updateAvatar
  -> è¯¦æƒ…é¡µåˆ·æ–°
```

---

## 3. è¯¦ç»†æŠ€æœ¯è®¾è®¡

### 3.1 æ•°æ®æ¨¡å‹è®¾è®¡

**ContactProfile æ–°å¢å­—æ®µ**:
- `contactInfo: String?`ï¼ˆè”ç³»æ–¹å¼ï¼‰
- `avatarColorSeed: Int`ï¼ˆé»˜è®¤å¤´åƒé¢œè‰²ç´¢å¼•ï¼‰

```kotlin
data class ContactProfile(
    ...,
    val avatarUrl: String? = null,
    val contactInfo: String? = null,
    val avatarColorSeed: Int = 0,
    ...
)
```

### 3.2 æ•°æ®åº“è®¾è®¡ä¸è¿ç§»

**ContactProfileEntity æ–°å¢å­—æ®µ**:
- `contact_info` TEXT  
- `avatar_color_seed` INTEGER NOT NULL DEFAULT 0  

**è¿ç§»ç‰ˆæœ¬**: v16 â†’ v17

```sql
ALTER TABLE profiles ADD COLUMN contact_info TEXT;
ALTER TABLE profiles ADD COLUMN avatar_color_seed INTEGER NOT NULL DEFAULT 0;
```

**å˜æ›´ç‚¹**:
- `AppDatabase` ç‰ˆæœ¬å‡è‡³ 17  
- `DatabaseModule` å¢åŠ  `MIGRATION_16_17`  

### 3.3 Repository/DAO æ‰©å±•

**ContactDao**:
- `updateContactInfo(contactId, contactInfo)`  
- `updateAvatar(contactId, avatarUrl, avatarColorSeed)`  

**ContactRepository**:
- å¢åŠ å¯¹åº”æ›´æ–°æ–¹æ³•  
- `ContactRepositoryImpl` ç»´æŠ¤ entity/domain æ˜ å°„  

### 3.4 çŠ¶æ€ç®¡ç†ä¸äº‹ä»¶

**ContactDetailUiState æ–°å¢**:
- `contactInfo: String`  
- `avatarUri: String?`  
- `avatarColorSeed: Int`  

**ContactDetailUiEvent æ–°å¢/æ‰©å±•**:
- `UpdateContactInfo(val contactInfo: String)`  
- `UpdateAvatar(val avatarUri: String?, val avatarColorSeed: Int)`  
- `ConfirmEditContactInfo` æ‰©å±•æºå¸¦è”ç³»æ–¹å¼/å¤´åƒ  

**ContactDetailViewModel**:
- `StartEditContactInfo` æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†  
- `ConfirmEditContactInfo`ï¼š  
  - name/goal ç»§ç»­èµ° `EditContactInfoUseCase`  
  - contactInfo èµ° `ContactRepository.updateContactInfo`  
  - avatar æ›´æ–°èµ° `ContactRepository.updateAvatar`  

### 3.5 å¤´åƒä¸Šä¼ ä¸è£å‰ª

**å…¥å£**:
- æ–°å»ºè”ç³»äººé¡µå¤´åƒåŒºåŸŸ  
- è¯¦æƒ…é¡µâ€œç¼–è¾‘â€å¯¹è¯æ¡†å¤´åƒåŒºåŸŸ  

**ä¸Šä¼ æ–¹å¼**:
- ç›¸å†Œï¼š`ActivityResultContracts.PickVisualMedia`  
- æ‹ç…§ï¼š`ActivityResultContracts.TakePicture` + `FileProvider`  

**è£å‰ªæ–¹æ¡ˆ**ï¼ˆå»ºè®®ï¼‰:
- æ–¹æ¡ˆAï¼šå¼•å…¥ `uCrop`ï¼ˆç¨³å®šã€å¯é…ç½® 1:1ï¼‰  
- æ–¹æ¡ˆBï¼šç³»ç»Ÿè£å‰ª Intentï¼ˆå…¼å®¹æ€§è¾ƒå¼±ï¼Œä»…ä½œé™çº§ï¼‰  

**è¾“å‡º**:
- è£å‰ªç»“æœå†™å…¥æœ¬åœ°ç¼“å­˜ç›®å½•ï¼Œä¿å­˜ Uri å­—ç¬¦ä¸²  

### 3.6 é»˜è®¤å¤´åƒæ¸²æŸ“

- è‹¥ `avatarUrl` ä¸ºç©ºï¼Œå±•ç¤ºé»˜è®¤å¤´åƒ  
- é»˜è®¤å¤´åƒå†…å®¹ï¼šå§“åé¦–å­—  
- é¢œè‰²ï¼š`avatarColorSeed` æ˜ å°„åˆ°å›ºå®šè°ƒè‰²æ¿  

### 3.7 UI ç»†èŠ‚

**è”ç³»æ–¹å¼å±•ç¤º**:
- åœ¨ `IdentityCard` åŸºç¡€ä¿¡æ¯åŒºå¢åŠ  â€œè”ç³»æ–¹å¼â€ è¡Œ  
- ä¸ºç©ºæ—¶æ˜¾ç¤ºå ä½æ–‡æœ¬ï¼ˆæ–‡æ¡ˆå¾…å®šï¼‰  

**è¾“å…¥å ä½**:
- `ContactFormCard` è”ç³»æ–¹å¼å ä½æ–‡æ¡ˆè°ƒæ•´ä¸ºé€šç”¨æè¿°  

**ç¼–è¾‘å¯¹è¯æ¡†**:
- `EditContactInfoDialog` æ–°å¢è”ç³»æ–¹å¼è¾“å…¥æ¡†  
- å¢åŠ å¤´åƒç¼–è¾‘å…¥å£ï¼ˆä¸ CreateContactScreen ç»Ÿä¸€äº¤äº’ï¼‰  

---

## 4. é”™è¯¯å¤„ç†

| åœºæ™¯ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·æç¤º |
|------|----------|----------|
| æƒé™æ‹’ç» | ä¿æŒåŸå¤´åƒ | æç¤ºæ‹’ç»åŸå›  |
| æ‹ç…§å¤±è´¥ | ä¿æŒåŸå¤´åƒ | â€œæ‹ç…§å¤±è´¥ï¼Œè¯·é‡è¯•â€ |
| ç›¸å†Œå–æ¶ˆ | æ— æ“ä½œ | ä¸æç¤º |
| è£å‰ªå¤±è´¥ | ä¿æŒåŸå¤´åƒ | â€œå›¾ç‰‡å¤„ç†å¤±è´¥â€ |

---

## 5. æµ‹è¯•ç­–ç•¥

### 5.1 å•å…ƒæµ‹è¯•

- `data/src/androidTest/.../DatabaseMigration16To17Test.kt`  
  - éªŒè¯ `contact_info` ä¸ `avatar_color_seed` å­—æ®µè¿ç§»  
- `data/src/test/.../ContactRepositoryImplTest.kt`  
  - `updateContactInfo` / `updateAvatar` æ›´æ–°æˆåŠŸ  

### 5.2 UI/é›†æˆæµ‹è¯•ï¼ˆæ‰‹åŠ¨ï¼‰

- æ–°å»ºè”ç³»äººï¼šè”ç³»æ–¹å¼ä¿å­˜/å±•ç¤º  
- ç¼–è¾‘è”ç³»äººï¼šè”ç³»æ–¹å¼ä¿®æ”¹/å¤´åƒæ›¿æ¢  
- æƒé™æ‹’ç»/è£å‰ªå¤±è´¥æç¤º  

---

## 6. æ–‡ä»¶å˜æ›´æ¸…å•

### ä¿®æ”¹

- `domain/src/main/kotlin/com/empathy/ai/domain/model/ContactProfile.kt`  
- `domain/src/main/kotlin/com/empathy/ai/domain/repository/ContactRepository.kt`  
- `domain/src/main/kotlin/com/empathy/ai/domain/usecase/EditContactInfoUseCase.kt`  
- `data/src/main/kotlin/com/empathy/ai/data/local/entity/ContactProfileEntity.kt`  
- `data/src/main/kotlin/com/empathy/ai/data/local/dao/ContactDao.kt`  
- `data/src/main/kotlin/com/empathy/ai/data/repository/ContactRepositoryImpl.kt`  
- `data/src/main/kotlin/com/empathy/ai/data/local/AppDatabase.kt`  
- `data/src/main/kotlin/com/empathy/ai/data/di/DatabaseModule.kt`  
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/contact/ContactFormCard.kt`  
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/contact/AvatarPicker.kt`  
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/overview/IdentityCard.kt`  
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/dialog/EditContactInfoDialog.kt`  
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/CreateContactScreen.kt`  
- `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactDetailTabScreen.kt`  
- `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/ContactDetailViewModel.kt`  

### æ–°å¢

- `data/src/androidTest/.../DatabaseMigration16To17Test.kt`  

---

## 7. é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£ |
|------|------|------|
| è£å‰ªåº“å…¼å®¹æ€§å·® | å¤´åƒè®¾ç½®å¤±è´¥ | æä¾›ç³»ç»Ÿè£å‰ªæˆ–ç›´æ¥ä½¿ç”¨åŸå›¾é™çº§ |
| æƒé™ç­–ç•¥å·®å¼‚ | æ‹ç…§æµç¨‹ä¸­æ–­ | ä½¿ç”¨ Photo Picker ä¼˜å…ˆï¼Œæƒé™æ‹’ç»ç»™å‡ºæç¤º |
| å¤´åƒè¿‡å¤§å¯¼è‡´å†…å­˜å‹åŠ› | UIå¡é¡¿ | ä½¿ç”¨ Coil é‡‡æ ·ç¼©æ”¾ |

---

## 8. å¾…ç¡®è®¤

- è”ç³»æ–¹å¼ä¸ºç©ºæ—¶çš„å ä½æ–‡æ¡ˆ  
- å¤´åƒè£å‰ªæ–¹æ¡ˆæœ€ç»ˆé€‰å‹ï¼ˆuCrop æˆ–ç³»ç»Ÿè£å‰ªï¼‰  

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2026-01-20  
**ç»´æŠ¤å›¢é˜Ÿ**: å¼€å‘å›¢é˜Ÿ
