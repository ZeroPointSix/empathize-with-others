# TDD-00047: AIå†›å¸ˆæµå¼å¯¹è¯V4é—®é¢˜ä¿®å¤æŠ€æœ¯è®¾è®¡

**åˆ›å»ºæ—¥æœŸ**: 2026-01-05
**å…³è”BUG**: BUG-00047
**å…³è”æ–‡æ¡£**: BUG-00044, BUG-00045, BUG-00046, FD-00028
**çŠ¶æ€**: ğŸ“ è®¾è®¡ä¸­
**æœ€åæ›´æ–°**: 2026-01-05

---

## 1. è®¾è®¡ç›®æ ‡

ä¿®å¤AIå†›å¸ˆæµå¼å¯¹è¯åŠŸèƒ½åœ¨ç¬¬å››æ¬¡äººå·¥æµ‹è¯•ä¸­å‘ç°çš„é—®é¢˜ï¼Œç¡®ä¿ï¼š
1. æµå¼å“åº”å®Œæˆåï¼Œæ¶ˆæ¯å†…å®¹æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
2. UIèƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºå®Œæˆçš„AIå›å¤
3. åœæ­¢ç”Ÿæˆå’Œé‡æ–°ç”ŸæˆåŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## 2. é—®é¢˜æ ¹å› åˆ†æ

### 2.1 æ ¸å¿ƒé—®é¢˜ï¼šæ¶ˆæ¯å†…å®¹æœªä¿å­˜åˆ°æ•°æ®åº“

**é—®é¢˜ä»£ç ä½ç½®ï¼š** `SendAdvisorMessageStreamingUseCase.kt` ç¬¬150-165è¡Œ

```kotlin
is AiStreamChunk.Complete -> {
    val finalContent = chunk.fullText.ifEmpty { contentBuilder.toString() }
    
    // âŒ é—®é¢˜ï¼šåªæ›´æ–°äº†Blockçš„content
    aiAdvisorRepository.updateBlockContent(
        blockId = mainTextBlock.id,
        content = finalContent,
        status = MessageBlockStatus.SUCCESS
    )
    
    // âŒ é—®é¢˜ï¼šåªæ›´æ–°äº†Messageçš„statusï¼Œæ²¡æœ‰æ›´æ–°content
    aiAdvisorRepository.updateMessageStatus(aiMessageId, SendStatus.SUCCESS)
    
    emit(StreamingState.Completed(finalContent, chunk.usage))
}
```

**é—®é¢˜åˆ†æï¼š**

1. `AiAdvisorConversation`åœ¨åˆ›å»ºæ—¶`content`ä¸ºç©ºå­—ç¬¦ä¸²
2. æµå¼å®Œæˆååªæ›´æ–°äº†`Block`çš„å†…å®¹
3. `Message`çš„`content`å­—æ®µä»æœªè¢«æ›´æ–°
4. `getConversationsFlow()`è¿”å›çš„æ˜¯`Message`åˆ—è¡¨
5. UIæ¸²æŸ“æ—¶ä½¿ç”¨`conversation.content`ï¼Œå§‹ç»ˆä¸ºç©º

### 2.2 æ•°æ®æ¨¡å‹å…³ç³»

```
AiAdvisorConversation (Message)
â”œâ”€ id: String
â”œâ”€ content: String          â† éœ€è¦æ›´æ–°ï¼
â”œâ”€ messageType: MessageType
â”œâ”€ sendStatus: SendStatus   â† å·²æ›´æ–°
â””â”€ ...

AiAdvisorMessageBlock (Block)
â”œâ”€ id: String
â”œâ”€ messageId: String        â† å…³è”Message
â”œâ”€ content: String          â† å·²æ›´æ–°
â”œâ”€ status: MessageBlockStatus â† å·²æ›´æ–°
â””â”€ ...
```

**è®¾è®¡é—®é¢˜ï¼š**
- Blockæ¶æ„æ˜¯ä¸ºäº†æ”¯æŒå¤šç§å†…å®¹ç±»å‹ï¼ˆæ–‡æœ¬ã€æ€è€ƒã€é”™è¯¯ï¼‰
- ä½†UIå±‚ç›´æ¥ä½¿ç”¨`Message.content`æ¸²æŸ“
- ä¸¤è€…ä¹‹é—´ç¼ºå°‘åŒæ­¥æœºåˆ¶

---

## 3. æŠ€æœ¯æ–¹æ¡ˆ

### 3.1 æ–¹æ¡ˆAï¼šåœ¨UseCaseå±‚åŒæ­¥æ›´æ–°Message.contentï¼ˆæ¨èï¼‰

**ä¿®æ”¹æ–‡ä»¶ï¼š** `domain/src/main/kotlin/com/empathy/ai/domain/usecase/SendAdvisorMessageStreamingUseCase.kt`

**ä¿®æ”¹å†…å®¹ï¼š**

```kotlin
is AiStreamChunk.Complete -> {
    val finalContent = chunk.fullText.ifEmpty { contentBuilder.toString() }
    
    // 1. æ›´æ–°Blockå†…å®¹ï¼ˆä¿æŒç°æœ‰é€»è¾‘ï¼‰
    aiAdvisorRepository.updateBlockContent(
        blockId = mainTextBlock.id,
        content = finalContent,
        status = MessageBlockStatus.SUCCESS
    )
    
    // 2. ã€å…³é”®ä¿®å¤ã€‘æ›´æ–°Messageçš„contentå’Œstatus
    aiAdvisorRepository.updateMessageContentAndStatus(
        messageId = aiMessageId,
        content = finalContent,
        status = SendStatus.SUCCESS
    )
    
    emit(StreamingState.Completed(finalContent, chunk.usage))
}
```

**ä¼˜ç‚¹ï¼š**
- ä¿®æ”¹èŒƒå›´å°ï¼Œåªæ”¹ä¸€å¤„
- ä¿æŒBlockæ¶æ„çš„å®Œæ•´æ€§
- åŒæ—¶æ›´æ–°Messageå’ŒBlockï¼Œæ•°æ®ä¸€è‡´

**ç¼ºç‚¹ï¼š**
- æ•°æ®å†—ä½™ï¼ˆcontentå­˜å‚¨ä¸¤ä»½ï¼‰

### 3.2 æ–¹æ¡ˆBï¼šä¿®æ”¹DAOæŸ¥è¯¢ï¼Œä»Blockè·å–content

**ä¿®æ”¹æ–‡ä»¶ï¼š** `data/src/main/kotlin/com/empathy/ai/data/local/dao/AiAdvisorDao.kt`

**ä¿®æ”¹å†…å®¹ï¼š**

```kotlin
@Query("""
    SELECT c.*, b.content as block_content
    FROM ai_advisor_conversations c
    LEFT JOIN ai_advisor_message_blocks b ON c.id = b.message_id AND b.type = 'MAIN_TEXT'
    WHERE c.session_id = :sessionId
    ORDER BY c.timestamp ASC
""")
fun getConversationsWithBlockContent(sessionId: String): Flow<List<ConversationWithBlock>>
```

**ä¼˜ç‚¹ï¼š**
- æ¶ˆé™¤æ•°æ®å†—ä½™
- ç¬¦åˆBlockæ¶æ„è®¾è®¡æ„å›¾

**ç¼ºç‚¹ï¼š**
- ä¿®æ”¹èŒƒå›´å¤§
- éœ€è¦æ–°å¢æ•°æ®æ¨¡å‹
- å½±å“ç°æœ‰ä»£ç è¾ƒå¤š

### 3.3 æ–¹æ¡ˆé€‰æ‹©ï¼šé‡‡ç”¨æ–¹æ¡ˆA

ç†ç”±ï¼š
1. ä¿®æ”¹èŒƒå›´æœ€å°
2. é£é™©æœ€ä½
3. èƒ½å¿«é€Ÿè§£å†³é—®é¢˜
4. åç»­å¯ä»¥ä¼˜åŒ–ä¸ºæ–¹æ¡ˆB

---

## 4. è¯¦ç»†è®¾è®¡

### 4.1 ä¿®æ”¹1ï¼šSendAdvisorMessageStreamingUseCase

**æ–‡ä»¶è·¯å¾„ï¼š** `domain/src/main/kotlin/com/empathy/ai/domain/usecase/SendAdvisorMessageStreamingUseCase.kt`

**ä¿®æ”¹ä½ç½®ï¼š** `AiStreamChunk.Complete`å¤„ç†å—

**ä¿®æ”¹å‰ï¼š**
```kotlin
is AiStreamChunk.Complete -> {
    val finalContent = chunk.fullText.ifEmpty { contentBuilder.toString() }
    aiAdvisorRepository.updateBlockContent(
        blockId = mainTextBlock.id,
        content = finalContent,
        status = MessageBlockStatus.SUCCESS
    )
    aiAdvisorRepository.updateMessageStatus(aiMessageId, SendStatus.SUCCESS)
    emit(StreamingState.Completed(finalContent, chunk.usage))
}
```

**ä¿®æ”¹åï¼š**
```kotlin
is AiStreamChunk.Complete -> {
    val finalContent = chunk.fullText.ifEmpty { contentBuilder.toString() }
    
    // æ›´æ–°Blockå†…å®¹
    aiAdvisorRepository.updateBlockContent(
        blockId = mainTextBlock.id,
        content = finalContent,
        status = MessageBlockStatus.SUCCESS
    )
    
    // ã€BUG-047ä¿®å¤ã€‘æ›´æ–°Messageçš„contentå’Œstatus
    // åŸå› ï¼šgetConversationsFlow()è¿”å›çš„æ˜¯Messageï¼ŒUIä½¿ç”¨Message.contentæ¸²æŸ“
    // å¿…é¡»åŒæ­¥æ›´æ–°Message.contentï¼Œå¦åˆ™UIæ˜¾ç¤ºç©ºç™½
    aiAdvisorRepository.updateMessageContentAndStatus(
        messageId = aiMessageId,
        content = finalContent,
        status = SendStatus.SUCCESS
    )
    
    emit(StreamingState.Completed(finalContent, chunk.usage))
}
```

### 4.2 ä¿®æ”¹2ï¼šå¢å¼ºé”™è¯¯å¤„ç†

**æ–‡ä»¶è·¯å¾„ï¼š** `domain/src/main/kotlin/com/empathy/ai/domain/usecase/SendAdvisorMessageStreamingUseCase.kt`

**ä¿®æ”¹ä½ç½®ï¼š** `AiStreamChunk.Error`å¤„ç†å—

**ä¿®æ”¹å‰ï¼š**
```kotlin
is AiStreamChunk.Error -> {
    aiAdvisorRepository.updateMessageStatus(aiMessageId, SendStatus.FAILED)
    emit(StreamingState.Error(chunk.error))
}
```

**ä¿®æ”¹åï¼š**
```kotlin
is AiStreamChunk.Error -> {
    // ã€BUG-047ä¿®å¤ã€‘é”™è¯¯æ—¶ä¹Ÿæ›´æ–°contentï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    val errorContent = "[AIå“åº”å¤±è´¥: ${chunk.error.message}]"
    aiAdvisorRepository.updateMessageContentAndStatus(
        messageId = aiMessageId,
        content = errorContent,
        status = SendStatus.FAILED
    )
    emit(StreamingState.Error(chunk.error))
}
```

### 4.3 ä¿®æ”¹3ï¼šä¼˜åŒ–ViewModelå»¶è¿Ÿæ¸…ç©ºé€»è¾‘

**æ–‡ä»¶è·¯å¾„ï¼š** `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`

**ä¿®æ”¹ä½ç½®ï¼š** `StreamingState.Completed`å¤„ç†å—ä¸­çš„å»¶è¿Ÿæ¸…ç©ºé€»è¾‘

**ä¿®æ”¹å‰ï¼š**
```kotlin
viewModelScope.launch {
    kotlinx.coroutines.delay(800)
    val currentState = _uiState.value
    if (currentState.currentSessionId == completedSessionId &&
        currentState.currentStreamingMessageId == completedMessageId) {
        _uiState.update {
            it.copy(
                streamingContent = "",
                currentStreamingMessageId = null
            )
        }
    }
}
```

**ä¿®æ”¹åï¼š**
```kotlin
viewModelScope.launch {
    // ã€BUG-047ä¼˜åŒ–ã€‘å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿DBæ›´æ–°å’ŒFlowé€šçŸ¥å®Œæˆ
    kotlinx.coroutines.delay(1200)
    
    val currentState = _uiState.value
    
    // éªŒè¯æ¶ˆæ¯æ˜¯å¦å·²åœ¨conversationsåˆ—è¡¨ä¸­ä¸”æœ‰å†…å®¹
    val messageInList = currentState.conversations.any { 
        it.id == completedMessageId && it.content.isNotEmpty() 
    }
    
    if (currentState.currentSessionId == completedSessionId &&
        currentState.currentStreamingMessageId == completedMessageId) {
        
        if (messageInList) {
            // æ¶ˆæ¯å·²æ­£ç¡®æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­ï¼Œå¯ä»¥å®‰å…¨æ¸…ç©ºstreamingContent
            _uiState.update {
                it.copy(
                    streamingContent = "",
                    currentStreamingMessageId = null
                )
            }
        } else {
            // æ¶ˆæ¯æœªåœ¨åˆ—è¡¨ä¸­æˆ–å†…å®¹ä¸ºç©ºï¼Œä¿æŒstreamingContentä½œä¸ºå¤‡ä»½æ˜¾ç¤º
            // è¿™æ˜¯ä¸€ä¸ªé˜²å¾¡æ€§æªæ–½ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¸åº”è¯¥è§¦å‘
            android.util.Log.w(TAG, "Message not found in conversations or content empty, keeping streamingContent")
        }
    }
}
```

---

## 5. æ•°æ®æµè®¾è®¡

### 5.1 ä¿®å¤åçš„æ­£å¸¸æµç¨‹

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
sendMessageStreaming() å¯åŠ¨
    â”œâ”€ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ (content=userMessage, status=SUCCESS)
    â”œâ”€ åˆ›å»ºAIæ¶ˆæ¯å ä½ (content="", status=PENDING)
    â””â”€ å¯åŠ¨æµå¼å“åº”
        â†“
StreamingState.TextUpdate (å¤šæ¬¡)
    â””â”€ æ›´æ–° streamingContent
        â†“
StreamingState.Completed
    â”œâ”€ æ›´æ–°Block (content=finalContent, status=SUCCESS)
    â”œâ”€ ã€æ–°å¢ã€‘æ›´æ–°Message (content=finalContent, status=SUCCESS)
    â””â”€ emit Completed
        â†“
ViewModelå¤„ç†Completed
    â”œâ”€ æ›´æ–° streamingContent = fullText
    â”œâ”€ æ›´æ–° isStreaming = false
    â””â”€ å¯åŠ¨å»¶è¿Ÿæ¸…ç©ºä»»åŠ¡ (1200ms)
        â†“
conversations Flow æ›´æ–°
    â””â”€ ä»DBè¯»å–æ¶ˆæ¯åˆ—è¡¨ï¼ŒMessage.contentæœ‰å€¼
        â†“
UIæ¸²æŸ“
    â”œâ”€ conversationsåˆ—è¡¨æ˜¾ç¤ºå®Œæ•´æ¶ˆæ¯
    â””â”€ streamingContentè¢«æ¸…ç©ºï¼ˆå› ä¸ºæ¶ˆæ¯å·²åœ¨åˆ—è¡¨ä¸­ï¼‰
```

### 5.2 é”™è¯¯å¤„ç†æµç¨‹

```
æµå¼å“åº”å‡ºé”™
    â†“
AiStreamChunk.Error
    â”œâ”€ ã€æ–°å¢ã€‘æ›´æ–°Message (content=errorMessage, status=FAILED)
    â””â”€ emit Error
        â†“
ViewModelå¤„ç†Error
    â”œâ”€ æ›´æ–° error = errorMessage
    â””â”€ æ¸…ç©º streamingContent
        â†“
UIæ¸²æŸ“
    â”œâ”€ æ˜¾ç¤ºé”™è¯¯æç¤º
    â””â”€ conversationsåˆ—è¡¨æ˜¾ç¤ºå¤±è´¥æ¶ˆæ¯ï¼ˆå¸¦é”™è¯¯ä¿¡æ¯ï¼‰
```

---

## 6. æ¥å£å˜æ›´

### 6.1 æ— æ–°å¢æ¥å£

æœ¬æ¬¡ä¿®å¤ä¸éœ€è¦æ–°å¢æ¥å£ï¼Œåªéœ€è¦æ­£ç¡®ä½¿ç”¨ç°æœ‰çš„`updateMessageContentAndStatus()`æ–¹æ³•ã€‚

### 6.2 ç°æœ‰æ¥å£ç¡®è®¤

```kotlin
// AiAdvisorRepository.kt
interface AiAdvisorRepository {
    // å·²å­˜åœ¨ï¼Œæœ¬æ¬¡ä¿®å¤éœ€è¦ä½¿ç”¨
    suspend fun updateMessageContentAndStatus(
        messageId: String,
        content: String,
        status: SendStatus
    ): Result<Unit>
}
```

---

## 7. æµ‹è¯•ç”¨ä¾‹è®¾è®¡

### 7.1 å•å…ƒæµ‹è¯•

```kotlin
class SendAdvisorMessageStreamingUseCaseTest {
    
    @Test
    fun `æµå¼å®ŒæˆåMessageçš„contentåº”è¢«æ›´æ–°`() {
        // Given
        val useCase = createUseCase()
        val mockRepository = mockk<AiAdvisorRepository>()
        
        // When
        useCase.invoke(contactId, sessionId, "æµ‹è¯•æ¶ˆæ¯")
            .collect { state ->
                if (state is StreamingState.Completed) {
                    // Then
                    verify {
                        mockRepository.updateMessageContentAndStatus(
                            any(),
                            state.fullText,
                            SendStatus.SUCCESS
                        )
                    }
                }
            }
    }
    
    @Test
    fun `æµå¼é”™è¯¯åMessageçš„contentåº”åŒ…å«é”™è¯¯ä¿¡æ¯`() {
        // Given
        val useCase = createUseCase()
        val mockRepository = mockk<AiAdvisorRepository>()
        
        // When
        // æ¨¡æ‹Ÿé”™è¯¯å“åº”
        
        // Then
        verify {
            mockRepository.updateMessageContentAndStatus(
                any(),
                match { it.contains("AIå“åº”å¤±è´¥") },
                SendStatus.FAILED
            )
        }
    }
}
```

### 7.2 é›†æˆæµ‹è¯•

```kotlin
class AiAdvisorChatIntegrationTest {
    
    @Test
    fun `å®Œæ•´å¯¹è¯æµç¨‹_æ¶ˆæ¯å†…å®¹æ­£ç¡®ä¿å­˜å’Œæ˜¾ç¤º`() {
        // 1. å‘é€æ¶ˆæ¯
        // 2. ç­‰å¾…æµå¼å“åº”å®Œæˆ
        // 3. éªŒè¯æ•°æ®åº“ä¸­Message.contentæœ‰å€¼
        // 4. éªŒè¯UIæ˜¾ç¤ºæ­£ç¡®å†…å®¹
    }
    
    @Test
    fun `åœæ­¢ç”Ÿæˆåé‡æ–°ç”Ÿæˆ_æ¶ˆæ¯ç±»å‹æ­£ç¡®`() {
        // 1. å‘é€æ¶ˆæ¯
        // 2. åœ¨æµå¼å“åº”ä¸­åœæ­¢
        // 3. ç‚¹å‡»é‡æ–°ç”Ÿæˆ
        // 4. éªŒè¯æ¶ˆæ¯ç±»å‹æ­£ç¡®
    }
}
```

---

## 8. å®ç°è®¡åˆ’

### 8.1 ä»»åŠ¡åˆ†è§£

| ä»»åŠ¡ID | ä»»åŠ¡æè¿° | é¢„è®¡å·¥æ—¶ | ä¾èµ– |
|--------|----------|----------|------|
| T1 | ä¿®æ”¹SendAdvisorMessageStreamingUseCase | 0.5h | æ—  |
| T2 | ä¼˜åŒ–ViewModelå»¶è¿Ÿæ¸…ç©ºé€»è¾‘ | 0.5h | T1 |
| T3 | æ·»åŠ æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯ | 0.25h | T1 |
| T4 | ç¼–å†™å•å…ƒæµ‹è¯• | 0.5h | T1 |
| T5 | é›†æˆæµ‹è¯•éªŒè¯ | 0.25h | T1-T4 |

### 8.2 å®ç°é¡ºåº

1. T1 (æ ¸å¿ƒä¿®å¤)
2. T2 (ä¼˜åŒ–)
3. T3 (è°ƒè¯•æ”¯æŒ)
4. T4 â†’ T5 (æµ‹è¯•éªŒè¯)

---

## 9. é£é™©è¯„ä¼°

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| æ•°æ®å†—ä½™å¯¼è‡´ä¸ä¸€è‡´ | ä½ | ä¸­ | åœ¨åŒä¸€äº‹åŠ¡ä¸­æ›´æ–°Blockå’ŒMessage |
| å»¶è¿Ÿæ—¶é—´ä¸å¤Ÿ | ä½ | ä½ | å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œæ·»åŠ éªŒè¯é€»è¾‘ |
| ç°æœ‰åŠŸèƒ½å›å½’ | ä½ | é«˜ | å®Œæ•´å›å½’æµ‹è¯• |

---

## 10. ç›¸å…³æ–‡æ¡£

- [BUG-00047-AIå†›å¸ˆæµå¼å¯¹è¯V4é—®é¢˜ç³»ç»Ÿæ€§åˆ†æ](../BUG/BUG-00047-AIå†›å¸ˆæµå¼å¯¹è¯V4é—®é¢˜ç³»ç»Ÿæ€§åˆ†æ.md)
- [FD-00028-AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§åŠŸèƒ½è®¾è®¡](../FD/FD-00028-AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§åŠŸèƒ½è®¾è®¡.md)
- [TDD-00028-AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§æŠ€æœ¯è®¾è®¡](./TDD-00028-AIå†›å¸ˆæµå¼å¯¹è¯å‡çº§æŠ€æœ¯è®¾è®¡.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-01-05
**æœ€åæ›´æ–°**: 2026-01-05
