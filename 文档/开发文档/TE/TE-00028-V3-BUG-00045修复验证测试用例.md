# TE-00028-V3: BUG-00045 修复验证测试用例

**测试日期**: 2026-01-05
**关联BUG**: BUG-00045
**测试人员**: 待定
**版本**: v1.0
**修复状态**: ✅ 代码修复完成，待人工验证

---

## 0. 修复摘要

### 已完成的代码修复

| 问题编号 | 问题描述 | 修复状态 |
|----------|----------|----------|
| P0-NEW-001 | AI正式回复完成后内容直接消失 | ✅ 已修复 |
| P0-NEW-002 | 重新生成时会重新发送用户消息 | ✅ 已修复 |
| P0-NEW-003 | 每次对话自动弹出"..."占位消息 | ✅ 已修复 |
| P0-NEW-004 | 未实际接入AI服务 | ⚠️ 待验证 |

### 修改的文件

1. `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatViewModel.kt`
   - 修改 `StreamingState.Completed` 处理逻辑，延迟清空内容
   - 新增 `regenerateStreaming()` 方法，支持不创建用户消息的重新生成

2. `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/advisor/AiAdvisorChatScreen.kt`
   - 修改流式消息渲染条件，支持完成后继续显示
   - 修改 `ChatBubble` 组件，不渲染空内容的PENDING状态AI消息

3. `domain/src/main/kotlin/com/empathy/ai/domain/usecase/SendAdvisorMessageStreamingUseCase.kt`
   - 添加 `skipUserMessage` 参数，支持跳过用户消息保存

4. `data/src/main/kotlin/com/empathy/ai/data/local/entity/AiAdvisorSessionEntity.kt`
   - 修复多余的注释结束符导致的编译错误

### 构建状态

✅ `.\gradlew assembleDebug` 构建成功

---

## 1. 测试概述

### 1.1 测试目的
验证BUG-00045中列出的所有问题已修复，确保AI军师流式对话功能正常运行。

### 1.2 测试范围

| 测试项 | 关联问题 | 优先级 |
|--------|----------|--------|
| 流式响应完成后内容保持 | P0-NEW-001 | P0 |
| 重新生成不重复用户消息 | P0-NEW-002 | P0 |
| 不显示"..."占位消息 | P0-NEW-003 | P0 |
| AI服务正常接入 | P0-NEW-004 | P0 |

### 1.3 测试环境
- **设备**: Android手机/MuMu模拟器(127.0.0.1:7555)
- **系统版本**: Android 8.0+
- **应用版本**: BUG-00045修复后的Debug版本
- **网络环境**: 稳定的互联网连接
- **AI服务商**: 已配置有效的API密钥（推荐DeepSeek）

---

## 2. 前置条件

### 2.1 环境准备
1. 安装BUG-00045修复后的Debug APK
2. 配置至少一个AI服务商（推荐DeepSeek）
3. 确保API密钥有效
4. 创建至少一个联系人用于AI军师对话
5. 确保网络连接稳定

### 2.2 测试数据准备
- 联系人：至少1个有基本画像信息的联系人
- AI服务商：配置有效的API密钥
- 测试问题：准备多个不同复杂度的问题用于测试

---

## 3. P0级问题验证测试

### TC-P0-NEW-001: 流式响应完成后内容保持验证

| 项目 | 内容 |
|------|------|
| **关联BUG** | BUG-045-P0-NEW-001 |
| **测试目的** | 验证AI回复完成后正确显示完整内容，不会消失 |
| **前置条件** | 进入AI军师对话界面，AI服务商配置正确 |
| **操作步骤** | 1. 输入"请介绍一下自己"<br>2. 点击发送<br>3. 等待AI流式回复完成<br>4. 观察AI消息显示<br>5. 等待5秒后再次观察 |
| **预期结果** | ✅ 流式过程中内容逐字显示<br>✅ 完成后显示完整AI回复内容<br>✅ 内容不会消失<br>✅ 消息保留在对话列表中<br>✅ 5秒后内容仍然存在 |
| **测试结果** | |
| **备注** | 重点验证完成后内容不消失 |

### TC-P0-NEW-001-B: 多轮对话内容保持验证

| 项目 | 内容 |
|------|------|
| **关联BUG** | BUG-045-P0-NEW-001 |
| **测试目的** | 验证多轮对话中每条AI回复都正确保持 |
| **前置条件** | 进入AI军师对话界面 |
| **操作步骤** | 1. 发送第一个问题，等待回复完成<br>2. 发送第二个问题，等待回复完成<br>3. 发送第三个问题，等待回复完成<br>4. 向上滚动查看所有消息 |
| **预期结果** | ✅ 所有三条AI回复都完整显示<br>✅ 没有任何消息消失<br>✅ 对话历史完整 |
| **测试结果** | |
| **备注** | |

---

### TC-P0-NEW-002: 重新生成不重复用户消息验证

| 项目 | 内容 |
|------|------|
| **关联BUG** | BUG-045-P0-NEW-002 |
| **测试目的** | 验证重新生成时不会创建重复的用户消息 |
| **前置条件** | 完成一次AI对话 |
| **操作步骤** | 1. 发送问题"你好"<br>2. 等待AI回复完成<br>3. 记录当前消息列表中的消息数量<br>4. 点击AI消息下方的"重新生成"按钮<br>5. 等待新的AI回复完成<br>6. 检查消息列表 |
| **预期结果** | ✅ 点击重新生成后立即响应<br>✅ 原AI回复被删除<br>✅ 用户消息"你好"只有一条，没有重复<br>✅ 新的AI回复正常显示<br>✅ 消息总数 = 原数量（用户消息不变） |
| **测试结果** | |
| **备注** | 重点验证用户消息不重复 |

### TC-P0-NEW-002-B: 连续重新生成验证

| 项目 | 内容 |
|------|------|
| **关联BUG** | BUG-045-P0-NEW-002 |
| **测试目的** | 验证连续多次重新生成不会累积重复消息 |
| **前置条件** | 完成一次AI对话 |
| **操作步骤** | 1. 发送问题"测试"<br>2. 等待AI回复完成<br>3. 点击"重新生成"，等待完成<br>4. 再次点击"重新生成"，等待完成<br>5. 第三次点击"重新生成"，等待完成<br>6. 检查消息列表 |
| **预期结果** | ✅ 用户消息"测试"始终只有一条<br>✅ AI回复只有最新的一条<br>✅ 没有累积的重复消息 |
| **测试结果** | |
| **备注** | |

---

### TC-P0-NEW-003: 不显示"..."占位消息验证

| 项目 | 内容 |
|------|------|
| **关联BUG** | BUG-045-P0-NEW-003 |
| **测试目的** | 验证对话过程中不会出现"..."占位消息 |
| **前置条件** | 进入AI军师对话界面 |
| **操作步骤** | 1. 发送任意问题<br>2. 仔细观察整个流式响应过程<br>3. 等待AI回复完成<br>4. 检查对话列表中的所有消息 |
| **预期结果** | ✅ 流式过程中显示"正在生成"或实际内容<br>✅ 不出现单独的"..."消息<br>✅ 完成后只有用户消息和AI回复<br>✅ 没有多余的占位消息 |
| **测试结果** | |
| **备注** | 重点观察是否有"..."出现 |

### TC-P0-NEW-003-B: 输入时不弹出占位消息验证

| 项目 | 内容 |
|------|------|
| **关联BUG** | BUG-045-P0-NEW-003 |
| **测试目的** | 验证输入文字时不会弹出占位消息 |
| **前置条件** | 进入AI军师对话界面 |
| **操作步骤** | 1. 在输入框中输入文字<br>2. 观察对话列表<br>3. 删除输入内容<br>4. 再次输入<br>5. 观察对话列表 |
| **预期结果** | ✅ 输入时对话列表不变<br>✅ 不出现任何新消息<br>✅ 只有点击发送后才显示新消息 |
| **测试结果** | |
| **备注** | |

---

### TC-P0-NEW-004: AI服务正常接入验证

| 项目 | 内容 |
|------|------|
| **关联BUG** | BUG-045-P0-NEW-004 |
| **测试目的** | 验证AI服务正常接入，返回真实回复 |
| **前置条件** | 配置有效的AI服务商和API密钥 |
| **操作步骤** | 1. 进入设置，确认AI服务商配置正确<br>2. 进入AI军师对话界面<br>3. 发送问题"1+1等于几？"<br>4. 观察AI回复内容 |
| **预期结果** | ✅ AI回复包含"2"或相关数学解答<br>✅ 不是默认错误消息<br>✅ 回复内容有意义且相关 |
| **测试结果** | |
| **备注** | 如果返回错误，检查API密钥和网络 |

### TC-P0-NEW-004-B: 复杂问题AI回复验证

| 项目 | 内容 |
|------|------|
| **关联BUG** | BUG-045-P0-NEW-004 |
| **测试目的** | 验证AI能正确处理复杂问题 |
| **前置条件** | AI服务商配置正确 |
| **操作步骤** | 1. 发送问题"请分析一下如何与内向的朋友更好地沟通"<br>2. 等待AI回复完成<br>3. 检查回复内容 |
| **预期结果** | ✅ AI回复包含具体的沟通建议<br>✅ 回复内容与问题相关<br>✅ 回复长度合理（不是一两个字） |
| **测试结果** | |
| **备注** | |

---

## 4. 回归测试

### TC-REG-001: 基本流式响应

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证基本流式响应功能正常 |
| **操作步骤** | 1. 发送简单问题<br>2. 观察流式响应过程 |
| **预期结果** | ✅ 用户消息立即显示<br>✅ AI回复逐字显示<br>✅ 完成后消息完整保留 |
| **测试结果** | |

### TC-REG-002: 停止生成功能

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证停止生成功能正常 |
| **操作步骤** | 1. 发送问题<br>2. 在流式响应中点击停止按钮 |
| **预期结果** | ✅ 响应立即停止<br>✅ 已生成的内容保留<br>✅ 不显示空的"..."消息<br>✅ 可继续发送新消息 |
| **测试结果** | |

### TC-REG-003: 会话切换功能

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证会话切换功能正常 |
| **操作步骤** | 1. 在会话A中发送消息<br>2. 切换到会话B<br>3. 在会话B中发送消息<br>4. 切换回会话A |
| **预期结果** | ✅ 会话切换正常<br>✅ 各会话消息独立<br>✅ 切换时流式响应被取消 |
| **测试结果** | |

### TC-REG-004: 错误处理

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证错误处理正常 |
| **操作步骤** | 1. 断开网络<br>2. 发送消息<br>3. 观察错误提示 |
| **预期结果** | ✅ 显示友好的错误提示<br>✅ 不卡在"思考中"状态<br>✅ 可以重试 |
| **测试结果** | |

---

## 5. 测试结果汇总

| 测试分类 | 用例数 | 通过 | 未通过 | 通过率 |
|----------|--------|------|--------|--------|
| P0级问题验证 | 8 | | | |
| 回归测试 | 4 | | | |
| **总计** | **12** | | | |

---

## 6. 问题记录

| 编号 | 测试用例 | 问题描述 | 严重程度 | 状态 |
|------|----------|----------|----------|------|
| | | | | |

---

## 7. 测试总结

### 7.1 测试执行情况
- **测试开始时间**: 
- **测试结束时间**: 
- **总测试时间**: 
- **执行人员**: 

### 7.2 测试结论
☐ 所有BUG已修复，功能验收通过
☐ 部分BUG已修复，需要继续修复后重新测试
☐ 存在新问题，需要分析处理

---

## 8. 附录

### 8.1 调试命令

```bash
# 安装APK到MuMu模拟器
adb -s 127.0.0.1:7555 install -r app\build\outputs\apk\debug\app-debug.apk

# 启动应用
adb -s 127.0.0.1:7555 shell am start -n com.empathy.ai/.presentation.ui.MainActivity

# 查看流式相关日志
adb -s 127.0.0.1:7555 logcat | findstr "Streaming\|SSE\|AiAdvisor\|SendAdvisor"

# AI调试日志
scripts\ai-debug.bat -d 127.0.0.1:7555
```

### 8.2 相关文档
- [BUG-00045问题分析文档](../BUG/BUG-00045-AI军师流式对话二次测试问题分析.md)
- [BUG-00044问题分析文档](../BUG/BUG-00044-AI军师流式对话多问题系统性分析.md)

---

**测试人员签名**: ________________

**日期**: ________________
