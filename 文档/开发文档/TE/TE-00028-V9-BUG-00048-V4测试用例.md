# TE-00028-V9-BUG-00048-V4æµ‹è¯•ç”¨ä¾‹

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç¼–å· | TE-00028-V9 |
| åˆ›å»ºæ—¥æœŸ | 2026-01-06 |
| å…³è”BUG | BUG-00048 V4 |
| å…³è”ä»»åŠ¡ | TD-00028 AIå†›å¸ˆæµå¼å¯¹è¯åŠŸèƒ½ |
| æµ‹è¯•ç±»å‹ | å•å…ƒæµ‹è¯• + äººå·¥æµ‹è¯• |

---

## 1. æµ‹è¯•ç›®æ ‡

éªŒè¯BUG-00048 V4ä¿®å¤åï¼š
1. **P1é—®é¢˜**ï¼šAIå›å¤å®Œæˆæ—¶ä¸å‡ºç°åŒæ°”æ³¡é—ªçƒ
2. **P2é—®é¢˜**ï¼šåœæ­¢ç”Ÿæˆåæ¶ˆæ¯ä¸æ¶ˆå¤±ï¼Œæ­£ç¡®æ˜¾ç¤ºCANCELLEDçŠ¶æ€

---

## 2. å•å…ƒæµ‹è¯•ç”¨ä¾‹

### 2.1 StopGenerationTest.kt

```kotlin
package com.empathy.ai.presentation.viewmodel

import com.empathy.ai.domain.model.AiAdvisorConversation
import com.empathy.ai.domain.model.MessageType
import com.empathy.ai.domain.model.SendStatus
import org.junit.Assert.*
import org.junit.Test

/**
 * BUG-00048 V4 åœæ­¢ç”ŸæˆåŠŸèƒ½æµ‹è¯•
 * 
 * æµ‹è¯•åœºæ™¯ï¼šåœæ­¢AIç”Ÿæˆåçš„çŠ¶æ€ç®¡ç†
 */
class StopGenerationTest {

    /**
     * TC-SG-001: åœæ­¢ç”Ÿæˆæ—¶messageIdä¸ä¸ºnull
     * 
     * åœºæ™¯ï¼šæ­£å¸¸æµå¼è¿‡ç¨‹ä¸­åœæ­¢
     * é¢„æœŸï¼šæ¶ˆæ¯å†…å®¹è¢«ä¿å­˜ï¼ŒçŠ¶æ€æ›´æ–°ä¸ºCANCELLED
     */
    @Test
    fun `stopGeneration should preserve content when messageId is not null`() {
        // Given: æµå¼è¿›è¡Œä¸­ï¼Œæœ‰messageIdå’Œå†…å®¹
        val messageId = "ai-msg-001"
        val streamingContent = "è¿™æ˜¯AIæ­£åœ¨ç”Ÿæˆçš„å†…å®¹"
        
        // When: åœæ­¢ç”Ÿæˆ
        val finalContent = if (streamingContent.isNotEmpty()) {
            streamingContent + "\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
        } else {
            "[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
        }
        
        // Then: æœ€ç»ˆå†…å®¹åº”è¯¥åŒ…å«åŸå†…å®¹å’Œåœæ­¢æ ‡è®°
        assertTrue(finalContent.contains(streamingContent))
        assertTrue(finalContent.contains("[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"))
    }

    /**
     * TC-SG-002: åœæ­¢ç”Ÿæˆæ—¶messageIdä¸ºnull
     * 
     * åœºæ™¯ï¼šæµå¼è¿˜æ²¡å¼€å§‹å°±åœæ­¢
     * é¢„æœŸï¼šç›´æ¥æ¸…ç©ºçŠ¶æ€ï¼Œä¸ä¿å­˜æ¶ˆæ¯
     */
    @Test
    fun `stopGeneration should clear state when messageId is null`() {
        // Given: æµå¼è¿˜æ²¡å¼€å§‹ï¼ŒmessageIdä¸ºnull
        val messageId: String? = null
        
        // When: æ£€æŸ¥æ˜¯å¦åº”è¯¥ä¿å­˜æ¶ˆæ¯
        val shouldSaveMessage = messageId != null
        
        // Then: ä¸åº”è¯¥ä¿å­˜æ¶ˆæ¯
        assertFalse(shouldSaveMessage)
    }

    /**
     * TC-SG-003: åœæ­¢ç”Ÿæˆæ—¶å†…å®¹ä¸ºç©º
     * 
     * åœºæ™¯ï¼šæµå¼åˆšå¼€å§‹ï¼Œè¿˜æ²¡æœ‰å†…å®¹
     * é¢„æœŸï¼šåªæ˜¾ç¤º"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
     */
    @Test
    fun `stopGeneration should show only stop message when content is empty`() {
        // Given: æµå¼åˆšå¼€å§‹ï¼Œå†…å®¹ä¸ºç©º
        val streamingContent = ""
        
        // When: ç”Ÿæˆæœ€ç»ˆå†…å®¹
        val finalContent = if (streamingContent.isNotEmpty()) {
            streamingContent + "\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
        } else {
            "[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
        }
        
        // Then: åªæ˜¾ç¤ºåœæ­¢æ ‡è®°
        assertEquals("[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]", finalContent)
    }
}
```

### 2.2 DoubleBubblePreventionTest.kt

```kotlin
package com.empathy.ai.presentation.viewmodel

import com.empathy.ai.domain.model.AiAdvisorConversation
import com.empathy.ai.domain.model.MessageType
import com.empathy.ai.domain.model.SendStatus
import org.junit.Assert.*
import org.junit.Test

/**
 * BUG-00048 V4 åŒæ°”æ³¡é¢„é˜²æµ‹è¯•
 * 
 * æµ‹è¯•åœºæ™¯ï¼šéªŒè¯shouldShowStreamingBubbleçš„é€»è¾‘
 */
class DoubleBubblePreventionTest {

    /**
     * TC-DB-001: æ¶ˆæ¯å·²åœ¨åˆ—è¡¨ä¸­ä¸”æœ‰å†…å®¹
     * 
     * åœºæ™¯ï¼šæµå¼å®Œæˆåï¼Œæ¶ˆæ¯å·²è¿›å…¥conversationsåˆ—è¡¨
     * é¢„æœŸï¼šä¸æ˜¾ç¤ºæµå¼æ°”æ³¡
     */
    @Test
    fun `shouldShowStreamingBubble should be false when message is in list with content`() {
        // Given: æ¶ˆæ¯å·²åœ¨åˆ—è¡¨ä¸­ä¸”æœ‰å†…å®¹
        val currentStreamingMessageId = "ai-msg-001"
        val conversations = listOf(
            createAiMessage("ai-msg-001", "å®Œæ•´çš„AIå›å¤å†…å®¹", SendStatus.SUCCESS)
        )
        val streamingContent = "å®Œæ•´çš„AIå›å¤å†…å®¹"
        val isStreaming = false
        
        // When: æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²åœ¨åˆ—è¡¨ä¸­
        val messageAlreadyInList = conversations.any { 
            it.id == currentStreamingMessageId && it.content.isNotEmpty() 
        }
        
        val shouldShowStreamingBubble = !messageAlreadyInList && (
            isStreaming || 
            (streamingContent.isNotEmpty() && currentStreamingMessageId != null)
        )
        
        // Then: ä¸åº”è¯¥æ˜¾ç¤ºæµå¼æ°”æ³¡
        assertTrue(messageAlreadyInList)
        assertFalse(shouldShowStreamingBubble)
    }

    /**
     * TC-DB-002: æ¶ˆæ¯ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œæµå¼è¿›è¡Œä¸­
     * 
     * åœºæ™¯ï¼šæµå¼æ­£åœ¨è¿›è¡Œ
     * é¢„æœŸï¼šæ˜¾ç¤ºæµå¼æ°”æ³¡
     */
    @Test
    fun `shouldShowStreamingBubble should be true when streaming and message not in list`() {
        // Given: æµå¼è¿›è¡Œä¸­ï¼Œæ¶ˆæ¯ä¸åœ¨åˆ—è¡¨ä¸­
        val currentStreamingMessageId = "ai-msg-001"
        val conversations = emptyList<AiAdvisorConversation>()
        val streamingContent = "æ­£åœ¨ç”Ÿæˆçš„å†…å®¹"
        val isStreaming = true
        
        // When: æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºæµå¼æ°”æ³¡
        val messageAlreadyInList = conversations.any { 
            it.id == currentStreamingMessageId && it.content.isNotEmpty() 
        }
        
        val shouldShowStreamingBubble = !messageAlreadyInList && (
            isStreaming || 
            (streamingContent.isNotEmpty() && currentStreamingMessageId != null)
        )
        
        // Then: åº”è¯¥æ˜¾ç¤ºæµå¼æ°”æ³¡
        assertFalse(messageAlreadyInList)
        assertTrue(shouldShowStreamingBubble)
    }

    /**
     * TC-DB-003: æ¶ˆæ¯åœ¨åˆ—è¡¨ä¸­ä½†çŠ¶æ€ä¸ºPENDINGä¸”å†…å®¹ä¸ºç©º
     * 
     * åœºæ™¯ï¼šæ¶ˆæ¯åˆšåˆ›å»ºï¼Œè¿˜æ²¡æœ‰å†…å®¹
     * é¢„æœŸï¼šæ˜¾ç¤ºæµå¼æ°”æ³¡ï¼ˆå› ä¸ºåˆ—è¡¨ä¸­çš„æ¶ˆæ¯æ²¡æœ‰å†…å®¹ï¼‰
     */
    @Test
    fun `shouldShowStreamingBubble should be true when message in list but empty`() {
        // Given: æ¶ˆæ¯åœ¨åˆ—è¡¨ä¸­ä½†å†…å®¹ä¸ºç©º
        val currentStreamingMessageId = "ai-msg-001"
        val conversations = listOf(
            createAiMessage("ai-msg-001", "", SendStatus.PENDING)
        )
        val streamingContent = "æ­£åœ¨ç”Ÿæˆçš„å†…å®¹"
        val isStreaming = true
        
        // When: æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºæµå¼æ°”æ³¡
        val messageAlreadyInList = conversations.any { 
            it.id == currentStreamingMessageId && it.content.isNotEmpty() 
        }
        
        val shouldShowStreamingBubble = !messageAlreadyInList && (
            isStreaming || 
            (streamingContent.isNotEmpty() && currentStreamingMessageId != null)
        )
        
        // Then: åº”è¯¥æ˜¾ç¤ºæµå¼æ°”æ³¡
        assertFalse(messageAlreadyInList) // å› ä¸ºcontentä¸ºç©º
        assertTrue(shouldShowStreamingBubble)
    }

    /**
     * TC-DB-004: æµå¼å®Œæˆä½†streamingContentè¿˜æ²¡æ¸…ç©º
     * 
     * åœºæ™¯ï¼šCompletedè§¦å‘åï¼Œç­‰å¾…æ¸…ç©ºstreamingContentæœŸé—´
     * é¢„æœŸï¼šå¦‚æœæ¶ˆæ¯å·²åœ¨åˆ—è¡¨ä¸­ï¼Œä¸æ˜¾ç¤ºæµå¼æ°”æ³¡
     */
    @Test
    fun `shouldShowStreamingBubble should be false when completed and message in list`() {
        // Given: æµå¼å®Œæˆï¼Œæ¶ˆæ¯å·²åœ¨åˆ—è¡¨ä¸­ï¼Œä½†streamingContentè¿˜æ²¡æ¸…ç©º
        val currentStreamingMessageId = "ai-msg-001"
        val conversations = listOf(
            createAiMessage("ai-msg-001", "å®Œæ•´çš„AIå›å¤å†…å®¹", SendStatus.SUCCESS)
        )
        val streamingContent = "å®Œæ•´çš„AIå›å¤å†…å®¹" // è¿˜æ²¡æ¸…ç©º
        val isStreaming = false // å·²å®Œæˆ
        
        // When: æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºæµå¼æ°”æ³¡
        val messageAlreadyInList = conversations.any { 
            it.id == currentStreamingMessageId && it.content.isNotEmpty() 
        }
        
        val shouldShowStreamingBubble = !messageAlreadyInList && (
            isStreaming || 
            (streamingContent.isNotEmpty() && currentStreamingMessageId != null)
        )
        
        // Then: ä¸åº”è¯¥æ˜¾ç¤ºæµå¼æ°”æ³¡ï¼ˆå…³é”®ï¼šé¿å…åŒæ°”æ³¡ï¼‰
        assertTrue(messageAlreadyInList)
        assertFalse(shouldShowStreamingBubble)
    }

    // è¾…åŠ©æ–¹æ³•
    private fun createAiMessage(
        id: String, 
        content: String, 
        status: SendStatus,
        timestamp: Long = System.currentTimeMillis()
    ): AiAdvisorConversation {
        return AiAdvisorConversation(
            id = id,
            sessionId = "session-001",
            messageType = MessageType.AI,
            content = content,
            sendStatus = status,
            timestamp = timestamp
        )
    }
}
```

---

## 3. äººå·¥æµ‹è¯•ç”¨ä¾‹

### 3.1 P1é—®é¢˜æµ‹è¯•ï¼šåŒæ°”æ³¡

| æµ‹è¯•ID | æµ‹è¯•åœºæ™¯ | æ“ä½œæ­¥éª¤ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|--------|----------|----------|----------|--------|
| MT-P1-001 | æ­£å¸¸AIå›å¤å®Œæˆ | 1. å‘é€æ¶ˆæ¯<br>2. ç­‰å¾…AIå®Œæ•´å›å¤<br>3. è§‚å¯Ÿæ°”æ³¡å˜åŒ– | å§‹ç»ˆåªæ˜¾ç¤ºä¸€ä¸ªæ°”æ³¡ï¼Œæ— é—ªçƒ | ğŸ”´ |
| MT-P1-002 | å¿«é€Ÿå‘é€å¤šæ¡æ¶ˆæ¯ | 1. å¿«é€Ÿå‘é€3æ¡æ¶ˆæ¯<br>2. è§‚å¯Ÿæ¯æ¡æ¶ˆæ¯çš„AIå›å¤ | æ¯æ¡æ¶ˆæ¯åªæ˜¾ç¤ºä¸€ä¸ªæ°”æ³¡ | ğŸŸ¡ |
| MT-P1-003 | AIå›å¤å®Œæˆç¬é—´ | 1. å‘é€æ¶ˆæ¯<br>2. ä»”ç»†è§‚å¯ŸAIå›å¤å®Œæˆç¬é—´ | ä¸å‡ºç°åŒæ°”æ³¡é—ªçƒ | ğŸ”´ |

### 3.2 P2é—®é¢˜æµ‹è¯•ï¼šåœæ­¢ç”Ÿæˆ

| æµ‹è¯•ID | æµ‹è¯•åœºæ™¯ | æ“ä½œæ­¥éª¤ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|--------|----------|----------|----------|--------|
| MT-P2-001 | æµå¼å¼€å§‹åç«‹å³åœæ­¢ | 1. å‘é€æ¶ˆæ¯<br>2. AIå¼€å§‹å›å¤åç«‹å³ç‚¹å‡»åœæ­¢ | æ˜¾ç¤º"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"ï¼Œçº¢è‰²æ°”æ³¡ | ğŸ”´ |
| MT-P2-002 | æµå¼è¿›è¡Œä¸­åœæ­¢ | 1. å‘é€æ¶ˆæ¯<br>2. AIå›å¤ä¸€åŠæ—¶ç‚¹å‡»åœæ­¢ | æ˜¾ç¤º"éƒ¨åˆ†å†…å®¹\n\n[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"ï¼Œçº¢è‰²æ°”æ³¡ | ğŸ”´ |
| MT-P2-003 | åœæ­¢åæ£€æŸ¥æŒ‰é’® | 1. æ‰§è¡ŒMT-P2-001æˆ–MT-P2-002<br>2. æ£€æŸ¥æ¶ˆæ¯ä¸‹æ–¹æŒ‰é’® | æ˜¾ç¤º"é‡è¯•"å’Œ"åˆ é™¤"æŒ‰é’® | ğŸ”´ |
| MT-P2-004 | åœæ­¢åç‚¹å‡»é‡è¯• | 1. æ‰§è¡ŒMT-P2-001<br>2. ç‚¹å‡»"é‡è¯•"æŒ‰é’® | ä½¿ç”¨åŸå§‹ç”¨æˆ·è¾“å…¥é‡æ–°ç”ŸæˆAIå›å¤ | ğŸŸ¡ |
| MT-P2-005 | åœæ­¢åç‚¹å‡»åˆ é™¤ | 1. æ‰§è¡ŒMT-P2-001<br>2. ç‚¹å‡»"åˆ é™¤"æŒ‰é’® | æ¶ˆæ¯è¢«åˆ é™¤ | ğŸŸ¡ |
| MT-P2-006 | å¿«é€Ÿåœæ­¢ï¼ˆæµå¼åˆšå¼€å§‹ï¼‰ | 1. å‘é€æ¶ˆæ¯<br>2. åœ¨AIå›å¤å‡ºç°å‰ç«‹å³ç‚¹å‡»åœæ­¢ | æ¶ˆæ¯ä¸æ¶ˆå¤±ï¼Œæ˜¾ç¤ºåœæ­¢çŠ¶æ€ | ğŸ”´ |
| MT-P2-007 | è¿ç»­åœæ­¢å’Œé‡æ–°ç”Ÿæˆ | 1. å‘é€æ¶ˆæ¯<br>2. åœæ­¢<br>3. é‡è¯•<br>4. å†åœæ­¢ | æ¯æ¬¡åœæ­¢éƒ½æ­£ç¡®ä¿å­˜çŠ¶æ€ | ğŸŸ¡ |

### 3.3 ç»¼åˆæµ‹è¯•

| æµ‹è¯•ID | æµ‹è¯•åœºæ™¯ | æ“ä½œæ­¥éª¤ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|--------|----------|----------|----------|--------|
| MT-C-001 | å¤šè½®å¯¹è¯ååœæ­¢ | 1. è¿›è¡Œ3è½®å¯¹è¯<br>2. ç¬¬4è½®åœæ­¢ç”Ÿæˆ<br>3. æ£€æŸ¥æ‰€æœ‰æ¶ˆæ¯ | å‰3è½®æ­£å¸¸ï¼Œç¬¬4è½®æ˜¾ç¤ºåœæ­¢çŠ¶æ€ | ğŸŸ¡ |
| MT-C-002 | åˆ‡æ¢ä¼šè¯ååœæ­¢ | 1. å‘é€æ¶ˆæ¯<br>2. åˆ‡æ¢åˆ°æ–°ä¼šè¯<br>3. å‘é€æ¶ˆæ¯<br>4. åœæ­¢ç”Ÿæˆ | åœæ­¢æ­£å¸¸å·¥ä½œï¼Œä¸å½±å“å…¶ä»–ä¼šè¯ | ğŸŸ¢ |
| MT-C-003 | åº”ç”¨é‡å¯åé‡è¯• | 1. å‘é€æ¶ˆæ¯<br>2. åœæ­¢ç”Ÿæˆ<br>3. é‡å¯åº”ç”¨<br>4. ç‚¹å‡»é‡è¯• | é‡è¯•ä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·è¾“å…¥ | ğŸŸ¡ |

---

## 4. æµ‹è¯•æ‰§è¡Œè®°å½•æ¨¡æ¿

### 4.1 æ‰§è¡Œè®°å½•

| æµ‹è¯•ID | æ‰§è¡Œæ—¥æœŸ | æ‰§è¡Œäºº | ç»“æœ | å¤‡æ³¨ |
|--------|----------|--------|------|------|
| MT-P1-001 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-P1-002 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-P1-003 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-P2-001 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-P2-002 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-P2-003 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-P2-004 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-P2-005 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-P2-006 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-P2-007 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-C-001 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-C-002 | | | â¬œ å¾…æ‰§è¡Œ | |
| MT-C-003 | | | â¬œ å¾…æ‰§è¡Œ | |

### 4.2 ç»“æœç»Ÿè®¡

| ç±»åˆ« | æ€»æ•° | é€šè¿‡ | å¤±è´¥ | å¾…æ‰§è¡Œ |
|------|------|------|------|--------|
| P1æµ‹è¯• | 3 | 0 | 0 | 3 |
| P2æµ‹è¯• | 7 | 0 | 0 | 7 |
| ç»¼åˆæµ‹è¯• | 3 | 0 | 0 | 3 |
| **æ€»è®¡** | **13** | **0** | **0** | **13** |

---

## 5. éªŒè¯æ¸…å•

### 5.1 P1éªŒè¯

- [ ] AIå›å¤å®Œæˆæ—¶ä¸å‡ºç°åŒæ°”æ³¡
- [ ] å¿«é€Ÿå‘é€å¤šæ¡æ¶ˆæ¯æ—¶ä¸å‡ºç°åŒæ°”æ³¡
- [ ] æµå¼å®Œæˆç¬é—´æ— é—ªçƒ

### 5.2 P2éªŒè¯

- [ ] åœæ­¢ç”Ÿæˆåæ¶ˆæ¯ä¸æ¶ˆå¤±
- [ ] åœæ­¢åæ˜¾ç¤º"[ç”¨æˆ·å·²åœæ­¢ç”Ÿæˆ]"
- [ ] åœæ­¢åæ¶ˆæ¯ä¸ºçº¢è‰²æ°”æ³¡ï¼ˆCANCELLEDçŠ¶æ€ï¼‰
- [ ] åœæ­¢åæ˜¾ç¤º"é‡è¯•"å’Œ"åˆ é™¤"æŒ‰é’®
- [ ] ç‚¹å‡»é‡è¯•èƒ½æ­£ç¡®é‡æ–°ç”Ÿæˆ
- [ ] ç‚¹å‡»åˆ é™¤èƒ½æ­£ç¡®åˆ é™¤æ¶ˆæ¯
- [ ] å¿«é€Ÿåœæ­¢ï¼ˆæµå¼åˆšå¼€å§‹ï¼‰æ¶ˆæ¯ä¸æ¶ˆå¤±

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-06
**æµ‹è¯•çŠ¶æ€**: â¬œ å¾…æ‰§è¡Œ

