# 截图预览功能测试用例

## 测试目标

验证截图预览功能的正确性、稳定性和用户体验。

## 单元测试

### 测试文件
`presentation/src/test/kotlin/com/empathy/ai/presentation/ui/floating/FloatingViewV2ScreenshotPreviewTest.kt`

### 测试用例

#### TC-01: 点击缩略图触发预览回调
```kotlin
@Test
fun `点击缩略图应该触发预览回调`() {
    // Arrange
    val attachment = ScreenshotAttachment(
        id = "test-id",
        localPath = "/data/local/tmp/test.jpg",
        width = 800,
        height = 600,
        sizeBytes = 50000,
        createdAt = System.currentTimeMillis()
    )
    var previewTriggered = false
    var triggeredPath: String? = null

    // Act
    floatingViewV2.setOnScreenshotPreviewListener { path ->
        previewTriggered = true
        triggeredPath = path
    }
    // 模拟点击缩略图
    // trigger click on thumbnail

    // Assert
    assertTrue(previewTriggered)
    assertEquals(attachment.localPath, triggeredPath)
}
```

#### TC-02: 点击删除按钮不触发预览回调
```kotlin
@Test
fun `点击删除按钮不应该触发预览回调`() {
    // Arrange
    var previewTriggered = false

    // Act
    floatingViewV2.setOnScreenshotPreviewListener {
        previewTriggered = true
    }
    // 模拟点击删除按钮

    // Assert
    assertFalse(previewTriggered)
}
```

## UI测试

### 测试文件
`app/src/androidTest/kotlin/com/empathy/ai/ui/ImagePreviewViewTest.kt`

> 说明：ImagePreviewView 运行在悬浮窗环境，需要 Overlay 权限；测试中通过
> `Settings.canDrawOverlays` 判断，权限不足时自动跳过。

### 测试用例

#### TC-UI-01: 预览视图正确显示
```kotlin
@Test
fun 预览视图应该正确显示完整图片() {
    // Arrange
    val imagePath = "/data/local/tmp/test.jpg"

    // Act
    val previewView = ImagePreviewView(context, windowManager, imagePath)
    previewView.show()

    // Assert
    assertTrue(previewView.isShowing())
    // 验证ImageView已显示
    // 验证图片已加载
}
```

#### TC-UI-02: 点击外部关闭预览
```kotlin
@Test
fun 点击预览外部应该关闭() {
    // Arrange
    val previewView = ImagePreviewView(context, windowManager, imagePath)
    previewView.show()

    // Act
    // 模拟点击背景

    // Assert
    assertFalse(previewView.isShowing())
}
```

#### TC-UI-03: 返回键关闭预览
```kotlin
@Test
fun 按返回键应该关闭预览() {
    // Arrange
    val previewView = ImagePreviewView(context, windowManager, imagePath)
    previewView.show()

    // Act
    // 按下返回键

    // Assert
    assertFalse(previewView.isShowing())
}
```

#### TC-UI-04: 图片加载失败处理
```kotlin
@Test
fun 图片加载失败应该显示错误提示() {
    // Arrange
    val invalidPath = "/invalid/path/test.jpg"

    // Act
    val dialog = ImagePreviewDialog(context, invalidPath)
    dialog.show()

    // Assert
    // 验证显示错误提示
    // 验证对话框不会崩溃
}
```

## 集成测试

### 测试文件
`app/src/androidTest/kotlin/com/empathy/ai/ui/ScreenshotPreviewIntegrationTest.kt`

### 测试用例

#### TC-INT-01: 完整预览流程
```kotlin
@Test
fun完整的截图预览流程应该正常工作() {
    // Arrange: 准备截图附件
    val attachments = createTestAttachments(count = 3)

    // Act:
    // 1. 启动悬浮窗
    // 2. 设置截图附件
    // 3. 点击第一个缩略图
    // 4. 关闭预览
    // 5. 点击第二个缩略图
    // 6. 关闭预览

    // Assert: 验证每一步都正常工作
}
```

#### TC-INT-02: 预览不影响删除功能
```kotlin
@Test
fun预览功能不应该影响删除功能() {
    // Arrange: 有2张截图附件

    // Act:
    // 1. 点击第一张预览
    // 2. 关闭预览
    // 3. 删除第一张
    // 4. 点击第二张预览

    // Assert: 验证删除功能正常,预览功能正常
}
```

#### TC-INT-03: 预览不影响发送功能
```kotlin
@Test
fun预览功能不应该影响AI发送功能() {
    // Arrange: 有截图附件

    // Act:
    // 1. 点击截图预览
    // 2. 关闭预览
    // 3. 点击AI分析按钮

    // Assert: 验证附件正确发送
}
```

## 手动测试场景

### 场景1: 单张截图预览
1. 在悬浮窗中进行1次截图
2. 点击缩略图
3. **验证**: 预览对话框显示完整截图
4. 点击对话框外部
5. **验证**: 预览对话框关闭

### 场景2: 多张截图预览
1. 在悬浮窗中进行3次截图
2. 依次点击每张缩略图
3. **验证**: 每张截图都能正确预览
4. **验证**: 预览对话框显示正确的图片

### 场景3: 预览与删除
1. 有3张截图附件
2. 点击第2张预览
3. 关闭预览
4. 删除第2张
5. **验证**: 第2张被删除,第1、3张仍可预览

### 场景4: 预览与发送
1. 有2张截图附件
2. 点击第1张预览
3. 关闭预览
4. 点击AI分析按钮
5. **验证**: 2张截图都发送到AI

### 场景5: 边界情况
1. 最大5张截图全部添加
2. 依次预览每张
3. **验证**: 所有截图都能正常预览
4. 删除中间几张
5. **验证**: 剩余截图仍可预览

## 性能测试

### PT-01: 图片加载时间
- **目标**: 图片加载时间 < 500ms
- **测试**: 测量从点击缩略图到预览对话框显示的时间

### PT-02: 内存占用
- **目标**: 预览不导致内存泄漏
- **测试**: 使用LeakCanary检测内存泄漏

## 兼容性测试

### CT-01: 不同屏幕尺寸
- 测试在小屏幕设备上的显示
- 测试在大屏幕设备上的显示

### CT-02: 不同图片尺寸
- 测试预览小尺寸截图 (800x600)
- 测试预览大尺寸截图 (1280x720)

## 回归测试

确保预览功能不影响现有功能:
1. 截图功能正常
2. 删除功能正常
3. AI发送功能正常
4. 悬浮窗其他交互正常

## 测试数据准备

### 测试图片
- 小图: 800x600, JPG, ~50KB
- 中图: 1280x720, JPG, ~100KB
- 大图: 1920x1080, JPG, ~200KB
- 横图: 1920x1080, JPG
- 竖图: 1080x1920, JPG

---

**创建时间**: 2026-01-17 12:20:00
**创建者**: Claude
**状态**: 待实施
