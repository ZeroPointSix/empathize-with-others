# TE-00063：联系人搜索功能测试用例

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档编号** | TE-00063 |
| **关联BUG** | BUG-00063 |
| **测试类型** | 功能测试 + 单元测试 |
| **编写者** | Kiro |
| **编写日期** | 2026-01-10 |

---

## 一、测试范围

### 1.1 测试目标

验证联系人搜索功能的完整性和正确性，确保：
1. 搜索图标点击后搜索框正确展开
2. 搜索功能按预期过滤联系人
3. 搜索状态管理正确
4. UI交互流畅

### 1.2 测试模块

| 模块 | 文件 | 测试类型 |
|------|------|----------|
| ViewModel | `ContactListViewModel.kt` | 单元测试 |
| UI | `ContactListScreen.kt` | UI测试 |

---

## 二、单元测试用例

### 2.1 ViewModel 测试

**测试文件**：`presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/BUG00063ContactSearchTest.kt`

#### TC-001：点击搜索图标展开搜索框

```kotlin
@Test
fun `StartSearch事件应该设置isSearching为true`() {
    // Given
    val viewModel = ContactListViewModel(getAllContactsUseCase, deleteContactUseCase)
    
    // When
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    
    // Then
    val state = viewModel.uiState.value
    assertTrue(state.isSearching)
}
```

#### TC-002：输入搜索词过滤联系人

```kotlin
@Test
fun `UpdateSearchQuery事件应该过滤联系人列表`() {
    // Given
    val contacts = listOf(
        ContactProfile(id = "1", name = "张三", targetGoal = "合作"),
        ContactProfile(id = "2", name = "李四", targetGoal = "朋友"),
        ContactProfile(id = "3", name = "王五", targetGoal = "合作")
    )
    val viewModel = createViewModelWithContacts(contacts)
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    
    // When
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery("张"))
    
    // Then
    val state = viewModel.uiState.value
    assertEquals(1, state.searchResults.size)
    assertEquals("张三", state.searchResults[0].name)
}
```

#### TC-003：按目标搜索

```kotlin
@Test
fun `搜索应该匹配targetGoal字段`() {
    // Given
    val contacts = listOf(
        ContactProfile(id = "1", name = "张三", targetGoal = "建立合作关系"),
        ContactProfile(id = "2", name = "李四", targetGoal = "成为好朋友")
    )
    val viewModel = createViewModelWithContacts(contacts)
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    
    // When
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery("合作"))
    
    // Then
    val state = viewModel.uiState.value
    assertEquals(1, state.searchResults.size)
    assertEquals("张三", state.searchResults[0].name)
}
```

#### TC-004：按事实搜索

```kotlin
@Test
fun `搜索应该匹配facts字段`() {
    // Given
    val contacts = listOf(
        ContactProfile(
            id = "1", 
            name = "张三", 
            targetGoal = "合作",
            facts = listOf(Fact(key = "职业", value = "产品经理", timestamp = 0L, source = FactSource.MANUAL))
        ),
        ContactProfile(
            id = "2", 
            name = "李四", 
            targetGoal = "朋友",
            facts = listOf(Fact(key = "职业", value = "设计师", timestamp = 0L, source = FactSource.MANUAL))
        )
    )
    val viewModel = createViewModelWithContacts(contacts)
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    
    // When
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery("产品经理"))
    
    // Then
    val state = viewModel.uiState.value
    assertEquals(1, state.searchResults.size)
    assertEquals("张三", state.searchResults[0].name)
}
```

#### TC-005：清空搜索词

```kotlin
@Test
fun `清空搜索词应该清除搜索结果`() {
    // Given
    val viewModel = createViewModelWithContacts(sampleContacts)
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery("张"))
    
    // When
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery(""))
    
    // Then
    val state = viewModel.uiState.value
    assertTrue(state.searchResults.isEmpty())
    assertFalse(state.isShowingSearchResults)
}
```

#### TC-006：取消搜索

```kotlin
@Test
fun `CancelSearch事件应该退出搜索模式`() {
    // Given
    val viewModel = createViewModelWithContacts(sampleContacts)
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery("张"))
    
    // When
    viewModel.onEvent(ContactListUiEvent.CancelSearch)
    
    // Then
    val state = viewModel.uiState.value
    assertFalse(state.isSearching)
    assertEquals("", state.searchQuery)
    assertTrue(state.searchResults.isEmpty())
}
```

#### TC-007：搜索无结果

```kotlin
@Test
fun `搜索无匹配时searchResults应该为空`() {
    // Given
    val contacts = listOf(
        ContactProfile(id = "1", name = "张三", targetGoal = "合作"),
        ContactProfile(id = "2", name = "李四", targetGoal = "朋友")
    )
    val viewModel = createViewModelWithContacts(contacts)
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    
    // When
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery("王五"))
    
    // Then
    val state = viewModel.uiState.value
    assertTrue(state.searchResults.isEmpty())
    assertTrue(state.isSearching)
}
```

#### TC-008：搜索不区分大小写

```kotlin
@Test
fun `搜索应该不区分大小写`() {
    // Given
    val contacts = listOf(
        ContactProfile(id = "1", name = "Test User", targetGoal = "合作")
    )
    val viewModel = createViewModelWithContacts(contacts)
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    
    // When
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery("test"))
    
    // Then
    val state = viewModel.uiState.value
    assertEquals(1, state.searchResults.size)
}
```

---

## 三、UI 测试用例

### 3.1 Compose UI 测试

**测试文件**：`presentation/src/androidTest/kotlin/com/empathy/ai/presentation/ui/screen/contact/ContactListSearchUITest.kt`

#### TC-UI-001：搜索图标可见性

```kotlin
@Test
fun `搜索图标应该在联系人列表页面可见`() {
    composeTestRule.setContent {
        ContactListScreenContent(
            uiState = ContactListUiState(contacts = sampleContacts),
            onEvent = {},
            onNavigateToDetail = {},
            onNavigate = {},
            onAddClick = {}
        )
    }
    
    composeTestRule.onNodeWithContentDescription("搜索").assertIsDisplayed()
}
```

#### TC-UI-002：点击搜索图标展开搜索框

```kotlin
@Test
fun `点击搜索图标应该展开搜索框`() {
    var isSearching = false
    
    composeTestRule.setContent {
        ContactListScreenContent(
            uiState = ContactListUiState(
                contacts = sampleContacts,
                isSearching = isSearching
            ),
            onEvent = { event ->
                if (event is ContactListUiEvent.StartSearch) {
                    isSearching = true
                }
            },
            onNavigateToDetail = {},
            onNavigate = {},
            onAddClick = {}
        )
    }
    
    composeTestRule.onNodeWithContentDescription("搜索").performClick()
    
    assertTrue(isSearching)
}
```

#### TC-UI-003：搜索模式显示搜索框

```kotlin
@Test
fun `搜索模式下应该显示搜索输入框`() {
    composeTestRule.setContent {
        ContactListScreenContent(
            uiState = ContactListUiState(
                contacts = sampleContacts,
                isSearching = true
            ),
            onEvent = {},
            onNavigateToDetail = {},
            onNavigate = {},
            onAddClick = {}
        )
    }
    
    composeTestRule.onNodeWithText("搜索联系人").assertIsDisplayed()
}
```

#### TC-UI-004：取消按钮可见性

```kotlin
@Test
fun `搜索模式下应该显示取消按钮`() {
    composeTestRule.setContent {
        ContactListScreenContent(
            uiState = ContactListUiState(
                contacts = sampleContacts,
                isSearching = true
            ),
            onEvent = {},
            onNavigateToDetail = {},
            onNavigate = {},
            onAddClick = {}
        )
    }
    
    composeTestRule.onNodeWithText("取消").assertIsDisplayed()
}
```

#### TC-UI-005：点击取消退出搜索

```kotlin
@Test
fun `点击取消按钮应该退出搜索模式`() {
    var cancelClicked = false
    
    composeTestRule.setContent {
        ContactListScreenContent(
            uiState = ContactListUiState(
                contacts = sampleContacts,
                isSearching = true
            ),
            onEvent = { event ->
                if (event is ContactListUiEvent.CancelSearch) {
                    cancelClicked = true
                }
            },
            onNavigateToDetail = {},
            onNavigate = {},
            onAddClick = {}
        )
    }
    
    composeTestRule.onNodeWithText("取消").performClick()
    
    assertTrue(cancelClicked)
}
```

#### TC-UI-006：搜索结果显示

```kotlin
@Test
fun `搜索结果应该正确显示`() {
    val searchResults = listOf(
        ContactProfile(id = "1", name = "张三", targetGoal = "合作")
    )
    
    composeTestRule.setContent {
        ContactListScreenContent(
            uiState = ContactListUiState(
                contacts = sampleContacts,
                isSearching = true,
                searchQuery = "张",
                searchResults = searchResults
            ),
            onEvent = {},
            onNavigateToDetail = {},
            onNavigate = {},
            onAddClick = {}
        )
    }
    
    composeTestRule.onNodeWithText("张三").assertIsDisplayed()
}
```

#### TC-UI-007：空结果提示

```kotlin
@Test
fun `搜索无结果时应该显示提示`() {
    composeTestRule.setContent {
        ContactListScreenContent(
            uiState = ContactListUiState(
                contacts = sampleContacts,
                isSearching = true,
                searchQuery = "不存在的联系人",
                searchResults = emptyList()
            ),
            onEvent = {},
            onNavigateToDetail = {},
            onNavigate = {},
            onAddClick = {}
        )
    }
    
    composeTestRule.onNodeWithText("未找到匹配的联系人").assertIsDisplayed()
}
```

---

## 四、边界测试用例

### 4.1 特殊输入测试

#### TC-EDGE-001：特殊字符搜索

```kotlin
@Test
fun `搜索特殊字符不应该崩溃`() {
    // Given
    val viewModel = createViewModelWithContacts(sampleContacts)
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    
    // When & Then (不应该抛出异常)
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery("@#$%^&*()"))
    
    val state = viewModel.uiState.value
    assertTrue(state.searchResults.isEmpty())
}
```

#### TC-EDGE-002：超长字符串搜索

```kotlin
@Test
fun `搜索超长字符串不应该崩溃`() {
    // Given
    val viewModel = createViewModelWithContacts(sampleContacts)
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    val longString = "a".repeat(1000)
    
    // When & Then (不应该抛出异常)
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery(longString))
    
    val state = viewModel.uiState.value
    assertTrue(state.searchResults.isEmpty())
}
```

#### TC-EDGE-003：空格搜索

```kotlin
@Test
fun `只有空格的搜索词应该被视为空`() {
    // Given
    val viewModel = createViewModelWithContacts(sampleContacts)
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    
    // When
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery("   "))
    
    // Then
    val state = viewModel.uiState.value
    assertTrue(state.searchResults.isEmpty())
}
```

#### TC-EDGE-004：联系人列表为空时搜索

```kotlin
@Test
fun `联系人列表为空时搜索应该返回空结果`() {
    // Given
    val viewModel = createViewModelWithContacts(emptyList())
    viewModel.onEvent(ContactListUiEvent.StartSearch)
    
    // When
    viewModel.onEvent(ContactListUiEvent.UpdateSearchQuery("张三"))
    
    // Then
    val state = viewModel.uiState.value
    assertTrue(state.searchResults.isEmpty())
}
```

---

## 五、测试数据

### 5.1 示例联系人数据

```kotlin
val sampleContacts = listOf(
    ContactProfile(
        id = "1",
        name = "张三",
        targetGoal = "建立良好的合作关系",
        contextDepth = 10,
        facts = listOf(
            Fact(key = "职业", value = "产品经理", timestamp = System.currentTimeMillis(), source = FactSource.MANUAL),
            Fact(key = "爱好", value = "摄影", timestamp = System.currentTimeMillis(), source = FactSource.MANUAL)
        )
    ),
    ContactProfile(
        id = "2",
        name = "李四",
        targetGoal = "成为好朋友",
        contextDepth = 15,
        facts = listOf(
            Fact(key = "职业", value = "设计师", timestamp = System.currentTimeMillis(), source = FactSource.MANUAL)
        )
    ),
    ContactProfile(
        id = "3",
        name = "王五",
        targetGoal = "保持联系",
        contextDepth = 8,
        facts = emptyList()
    )
)
```

---

## 六、测试执行

### 6.1 运行命令

```bash
# 运行单元测试
./gradlew :presentation:test --tests "*BUG00063*"

# 运行UI测试
./gradlew :presentation:connectedAndroidTest --tests "*ContactListSearchUITest*"

# 运行所有相关测试
./gradlew :presentation:test --tests "*ContactSearch*"
```

### 6.2 测试覆盖率要求

| 指标 | 目标 |
|------|------|
| 行覆盖率 | ≥ 80% |
| 分支覆盖率 | ≥ 70% |
| 方法覆盖率 | ≥ 90% |

---

## 七、验收标准

| 测试类型 | 通过标准 |
|----------|----------|
| 单元测试 | 全部通过 |
| UI测试 | 全部通过 |
| 边界测试 | 全部通过 |
| 手动测试 | 符合预期行为 |

---

## 八、相关文档

- **BUG文档**：[BUG-00063-联系人搜索功能缺失.md](../BUG/BUG-00063-联系人搜索功能缺失.md)
- **修复方案**：[BUG-00063-联系人搜索功能缺失-修复方案.md](../BUG/BUG-00063-联系人搜索功能缺失-修复方案.md)
