# TE-00065：事实流编辑功能测试用例

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档编号** | TE-00065 |
| **关联BUG** | BUG-00065 |
| **测试类型** | 功能测试 + 单元测试 |
| **编写者** | Kiro |
| **编写日期** | 2026-01-10 |

---

## 一、测试范围

### 1.1 测试目标

验证事实流编辑功能的完整性和正确性，确保：
1. 时光轴视图中点击事实卡片能打开编辑对话框
2. 清单视图中点击事实行能打开编辑对话框
3. 编辑和删除功能正常工作
4. UI 交互流畅

### 1.2 测试模块

| 模块 | 文件 | 测试类型 |
|------|------|----------|
| UI组件 | `ModernTimelineView.kt` | 单元测试 |
| UI组件 | `ModernListView.kt` | 单元测试 |
| UI组件 | `FactStreamTab.kt` | 单元测试 |
| ViewModel | `ContactDetailTabViewModel.kt` | 单元测试（已有） |

---

## 二、单元测试用例

### 2.1 ModernTimelineView 测试

**测试文件**：`presentation/src/test/kotlin/com/empathy/ai/presentation/ui/component/factstream/BUG00065ModernTimelineViewTest.kt`

#### TC-001：点击事实卡片触发编辑回调

```kotlin
@Test
fun `点击UserFact类型项目应该触发onFactEdit回调`() {
    // Given
    var editedFactId: String? = null
    val fact = Fact(
        id = "fact_1",
        key = "职业",
        value = "产品经理",
        timestamp = System.currentTimeMillis(),
        source = FactSource.MANUAL
    )
    val items = listOf(
        TimelineItem.UserFact(
            id = "item_1",
            timestamp = System.currentTimeMillis(),
            emotionType = EmotionType.NEUTRAL,
            fact = fact
        )
    )
    
    composeTestRule.setContent {
        ModernTimelineView(
            items = items,
            onItemClick = {},
            onFactEdit = { factId -> editedFactId = factId }
        )
    }
    
    // When
    composeTestRule.onNodeWithText("职业").performClick()
    
    // Then
    assertEquals("fact_1", editedFactId)
}
```

#### TC-002：点击非事实类型项目触发通用点击回调

```kotlin
@Test
fun `点击Conversation类型项目应该触发onItemClick回调`() {
    // Given
    var clickedItem: TimelineItem? = null
    val items = listOf(
        TimelineItem.Conversation(
            id = "conv_1",
            timestamp = System.currentTimeMillis(),
            emotionType = EmotionType.SWEET,
            log = ConversationLog(
                id = 1,
                contactId = "contact_1",
                userInput = "今天很开心",
                aiResponse = "继续保持",
                timestamp = System.currentTimeMillis(),
                isSummarized = false
            )
        )
    )
    
    composeTestRule.setContent {
        ModernTimelineView(
            items = items,
            onItemClick = { item -> clickedItem = item },
            onFactEdit = {}
        )
    }
    
    // When
    composeTestRule.onNodeWithText("对话记录").performClick()
    
    // Then
    assertNotNull(clickedItem)
    assertTrue(clickedItem is TimelineItem.Conversation)
}
```

#### TC-003：onFactEdit 为 null 时点击事实触发通用点击

```kotlin
@Test
fun `onFactEdit为null时点击UserFact应该触发onItemClick`() {
    // Given
    var clickedItem: TimelineItem? = null
    val fact = Fact(
        id = "fact_1",
        key = "职业",
        value = "产品经理",
        timestamp = System.currentTimeMillis(),
        source = FactSource.MANUAL
    )
    val items = listOf(
        TimelineItem.UserFact(
            id = "item_1",
            timestamp = System.currentTimeMillis(),
            emotionType = EmotionType.NEUTRAL,
            fact = fact
        )
    )
    
    composeTestRule.setContent {
        ModernTimelineView(
            items = items,
            onItemClick = { item -> clickedItem = item },
            onFactEdit = null  // 不提供编辑回调
        )
    }
    
    // When
    composeTestRule.onNodeWithText("职业").performClick()
    
    // Then
    assertNotNull(clickedItem)
    assertTrue(clickedItem is TimelineItem.UserFact)
}
```

### 2.2 ModernListView 测试

**测试文件**：`presentation/src/test/kotlin/com/empathy/ai/presentation/ui/component/factstream/BUG00065ModernListViewTest.kt`

#### TC-004：清单视图点击事实行触发编辑回调

```kotlin
@Test
fun `非选择模式下点击UserFact应该触发onFactEdit回调`() {
    // Given
    var editedFactId: String? = null
    val fact = Fact(
        id = "fact_1",
        key = "爱好",
        value = "摄影",
        timestamp = System.currentTimeMillis(),
        source = FactSource.MANUAL
    )
    val items = listOf(
        TimelineItem.UserFact(
            id = "item_1",
            timestamp = System.currentTimeMillis(),
            emotionType = EmotionType.NEUTRAL,
            fact = fact
        )
    )
    
    composeTestRule.setContent {
        ModernListView(
            items = items,
            selectedItems = emptySet(),
            isSelectionMode = false,
            onItemClick = {},
            onItemSelect = { _, _ -> },
            onFactEdit = { factId -> editedFactId = factId }
        )
    }
    
    // When
    composeTestRule.onNodeWithText("爱好").performClick()
    
    // Then
    assertEquals("fact_1", editedFactId)
}
```

#### TC-005：选择模式下点击事实行切换选中状态

```kotlin
@Test
fun `选择模式下点击UserFact应该切换选中状态而非触发编辑`() {
    // Given
    var selectedId: String? = null
    var isSelected: Boolean? = null
    val fact = Fact(
        id = "fact_1",
        key = "爱好",
        value = "摄影",
        timestamp = System.currentTimeMillis(),
        source = FactSource.MANUAL
    )
    val items = listOf(
        TimelineItem.UserFact(
            id = "item_1",
            timestamp = System.currentTimeMillis(),
            emotionType = EmotionType.NEUTRAL,
            fact = fact
        )
    )
    
    composeTestRule.setContent {
        ModernListView(
            items = items,
            selectedItems = emptySet(),
            isSelectionMode = true,  // 选择模式
            onItemClick = {},
            onItemSelect = { id, selected -> 
                selectedId = id
                isSelected = selected
            },
            onFactEdit = { fail("不应该触发编辑回调") }
        )
    }
    
    // When
    composeTestRule.onNodeWithText("爱好").performClick()
    
    // Then
    assertEquals("item_1", selectedId)
    assertTrue(isSelected == true)
}
```

### 2.3 FactStreamTab 测试

**测试文件**：`presentation/src/test/kotlin/com/empathy/ai/presentation/ui/screen/contact/factstream/BUG00065FactStreamTabTest.kt`

#### TC-006：FactStreamTab 传递 onFactEdit 到时光轴视图

```kotlin
@Test
fun `时光轴模式下点击事实应该触发onFactEdit回调`() {
    // Given
    var editedFactId: String? = null
    val fact = Fact(
        id = "fact_1",
        key = "生日",
        value = "1月1日",
        timestamp = System.currentTimeMillis(),
        source = FactSource.MANUAL
    )
    val items = listOf(
        TimelineItem.UserFact(
            id = "item_1",
            timestamp = System.currentTimeMillis(),
            emotionType = EmotionType.NEUTRAL,
            fact = fact
        )
    )
    
    composeTestRule.setContent {
        FactStreamTab(
            items = items,
            viewMode = ViewMode.Timeline,
            selectedFilters = emptySet(),
            onViewModeChange = {},
            onFilterToggle = {},
            onFactEdit = { factId -> editedFactId = factId }
        )
    }
    
    // When
    composeTestRule.onNodeWithText("生日").performClick()
    
    // Then
    assertEquals("fact_1", editedFactId)
}
```

#### TC-007：FactStreamTab 传递 onFactEdit 到清单视图

```kotlin
@Test
fun `清单模式下点击事实应该触发onFactEdit回调`() {
    // Given
    var editedFactId: String? = null
    val fact = Fact(
        id = "fact_2",
        key = "职业",
        value = "设计师",
        timestamp = System.currentTimeMillis(),
        source = FactSource.MANUAL
    )
    val items = listOf(
        TimelineItem.UserFact(
            id = "item_2",
            timestamp = System.currentTimeMillis(),
            emotionType = EmotionType.NEUTRAL,
            fact = fact
        )
    )
    
    composeTestRule.setContent {
        FactStreamTab(
            items = items,
            viewMode = ViewMode.List,
            selectedFilters = emptySet(),
            onViewModeChange = {},
            onFilterToggle = {},
            onFactEdit = { factId -> editedFactId = factId }
        )
    }
    
    // When
    composeTestRule.onNodeWithText("职业").performClick()
    
    // Then
    assertEquals("fact_2", editedFactId)
}
```

### 2.4 ViewModel 集成测试

**测试文件**：`presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/BUG00065FactEditIntegrationTest.kt`

#### TC-008：StartEditFact 事件设置编辑状态

```kotlin
@Test
fun `StartEditFact事件应该设置showEditFactDialog为true`() {
    // Given
    val viewModel = createViewModel()
    val fact = Fact(
        id = "fact_1",
        key = "职业",
        value = "产品经理",
        timestamp = System.currentTimeMillis(),
        source = FactSource.MANUAL
    )
    
    // When
    viewModel.onEvent(ContactDetailUiEvent.StartEditFact(fact))
    
    // Then
    val state = viewModel.uiState.value
    assertTrue(state.showEditFactDialog)
    assertEquals(fact, state.editingFact)
}
```

#### TC-009：ConfirmEditFact 事件更新事实

```kotlin
@Test
fun `ConfirmEditFact事件应该更新事实内容`() = runTest {
    // Given
    val viewModel = createViewModelWithFacts(listOf(
        Fact(
            id = "fact_1",
            key = "职业",
            value = "产品经理",
            timestamp = System.currentTimeMillis(),
            source = FactSource.MANUAL
        )
    ))
    viewModel.onEvent(ContactDetailUiEvent.StartEditFact(viewModel.uiState.value.facts[0]))
    
    // When
    viewModel.onEvent(ContactDetailUiEvent.ConfirmEditFact(
        factId = "fact_1",
        newKey = "工作",
        newValue = "高级产品经理"
    ))
    
    // Then
    advanceUntilIdle()
    val state = viewModel.uiState.value
    assertFalse(state.showEditFactDialog)
    assertNull(state.editingFact)
    val updatedFact = state.facts.find { it.id == "fact_1" }
    assertEquals("工作", updatedFact?.key)
    assertEquals("高级产品经理", updatedFact?.value)
}
```

#### TC-010：DeleteFactById 事件删除事实

```kotlin
@Test
fun `DeleteFactById事件应该从列表中移除事实`() = runTest {
    // Given
    val viewModel = createViewModelWithFacts(listOf(
        Fact(
            id = "fact_1",
            key = "职业",
            value = "产品经理",
            timestamp = System.currentTimeMillis(),
            source = FactSource.MANUAL
        ),
        Fact(
            id = "fact_2",
            key = "爱好",
            value = "摄影",
            timestamp = System.currentTimeMillis(),
            source = FactSource.MANUAL
        )
    ))
    
    // When
    viewModel.onEvent(ContactDetailUiEvent.DeleteFactById("fact_1"))
    
    // Then
    advanceUntilIdle()
    val state = viewModel.uiState.value
    assertEquals(1, state.facts.size)
    assertNull(state.facts.find { it.id == "fact_1" })
    assertNotNull(state.facts.find { it.id == "fact_2" })
}
```

#### TC-011：CancelEditFact 事件关闭对话框

```kotlin
@Test
fun `CancelEditFact事件应该关闭编辑对话框`() {
    // Given
    val viewModel = createViewModel()
    val fact = Fact(
        id = "fact_1",
        key = "职业",
        value = "产品经理",
        timestamp = System.currentTimeMillis(),
        source = FactSource.MANUAL
    )
    viewModel.onEvent(ContactDetailUiEvent.StartEditFact(fact))
    
    // When
    viewModel.onEvent(ContactDetailUiEvent.CancelEditFact)
    
    // Then
    val state = viewModel.uiState.value
    assertFalse(state.showEditFactDialog)
    assertNull(state.editingFact)
}
```

---

## 三、边界测试用例

### 3.1 空值和边界情况

#### TC-EDGE-001：编辑内容为空

```kotlin
@Test
fun `编辑内容为空时应该显示错误提示`() = runTest {
    // Given
    val viewModel = createViewModelWithFacts(listOf(
        Fact(
            id = "fact_1",
            key = "职业",
            value = "产品经理",
            timestamp = System.currentTimeMillis(),
            source = FactSource.MANUAL
        )
    ))
    viewModel.onEvent(ContactDetailUiEvent.StartEditFact(viewModel.uiState.value.facts[0]))
    
    // When
    viewModel.onEvent(ContactDetailUiEvent.ConfirmEditFact(
        factId = "fact_1",
        newKey = "",  // 空内容
        newValue = ""
    ))
    
    // Then
    advanceUntilIdle()
    val state = viewModel.uiState.value
    assertEquals("内容不能为空", state.error)
    assertTrue(state.showEditFactDialog)  // 对话框仍然打开
}
```

#### TC-EDGE-002：编辑内容未变化

```kotlin
@Test
fun `编辑内容未变化时应该显示提示`() = runTest {
    // Given
    val viewModel = createViewModelWithFacts(listOf(
        Fact(
            id = "fact_1",
            key = "职业",
            value = "产品经理",
            timestamp = System.currentTimeMillis(),
            source = FactSource.MANUAL
        )
    ))
    viewModel.onEvent(ContactDetailUiEvent.StartEditFact(viewModel.uiState.value.facts[0]))
    
    // When
    viewModel.onEvent(ContactDetailUiEvent.ConfirmEditFact(
        factId = "fact_1",
        newKey = "职业",      // 未变化
        newValue = "产品经理"  // 未变化
    ))
    
    // Then
    advanceUntilIdle()
    val state = viewModel.uiState.value
    assertEquals("内容未变化", state.successMessage)
    assertFalse(state.showEditFactDialog)  // 对话框关闭
}
```

#### TC-EDGE-003：事实列表为空

```kotlin
@Test
fun `事实列表为空时时光轴应该显示空状态`() {
    // Given
    composeTestRule.setContent {
        ModernTimelineView(
            items = emptyList(),
            onItemClick = {},
            onFactEdit = {}
        )
    }
    
    // Then
    composeTestRule.onNodeWithText("时光轴空空如也").assertIsDisplayed()
}
```

#### TC-EDGE-004：删除不存在的事实

```kotlin
@Test
fun `删除不存在的事实应该不影响列表`() = runTest {
    // Given
    val viewModel = createViewModelWithFacts(listOf(
        Fact(
            id = "fact_1",
            key = "职业",
            value = "产品经理",
            timestamp = System.currentTimeMillis(),
            source = FactSource.MANUAL
        )
    ))
    val initialCount = viewModel.uiState.value.facts.size
    
    // When
    viewModel.onEvent(ContactDetailUiEvent.DeleteFactById("non_existent_id"))
    
    // Then
    advanceUntilIdle()
    val state = viewModel.uiState.value
    assertEquals(initialCount, state.facts.size)  // 数量不变
}
```

---

## 四、测试数据

### 4.1 示例事实数据

```kotlin
val sampleFacts = listOf(
    Fact(
        id = "fact_1",
        key = "职业",
        value = "产品经理",
        timestamp = System.currentTimeMillis(),
        source = FactSource.MANUAL
    ),
    Fact(
        id = "fact_2",
        key = "爱好",
        value = "摄影、旅行",
        timestamp = System.currentTimeMillis() - 3600000,
        source = FactSource.MANUAL
    ),
    Fact(
        id = "fact_3",
        key = "生日",
        value = "1月15日",
        timestamp = System.currentTimeMillis() - 86400000,
        source = FactSource.AI_INFERRED
    )
)
```

### 4.2 示例时间线项目数据

```kotlin
val sampleTimelineItems = listOf(
    TimelineItem.UserFact(
        id = "item_1",
        timestamp = System.currentTimeMillis(),
        emotionType = EmotionType.NEUTRAL,
        fact = sampleFacts[0]
    ),
    TimelineItem.Conversation(
        id = "item_2",
        timestamp = System.currentTimeMillis() - 1800000,
        emotionType = EmotionType.SWEET,
        log = ConversationLog(
            id = 1,
            contactId = "contact_1",
            userInput = "今天很开心",
            aiResponse = "继续保持",
            timestamp = System.currentTimeMillis() - 1800000,
            isSummarized = false
        )
    ),
    TimelineItem.UserFact(
        id = "item_3",
        timestamp = System.currentTimeMillis() - 3600000,
        emotionType = EmotionType.NEUTRAL,
        fact = sampleFacts[1]
    )
)
```

---

## 五、测试执行

### 5.1 运行命令

```bash
# 运行所有 BUG-00065 相关测试
./gradlew :presentation:test --tests "*BUG00065*"

# 运行 ModernTimelineView 测试
./gradlew :presentation:test --tests "*BUG00065ModernTimelineViewTest*"

# 运行 ModernListView 测试
./gradlew :presentation:test --tests "*BUG00065ModernListViewTest*"

# 运行 FactStreamTab 测试
./gradlew :presentation:test --tests "*BUG00065FactStreamTabTest*"

# 运行集成测试
./gradlew :presentation:test --tests "*BUG00065FactEditIntegrationTest*"
```

### 5.2 测试覆盖率要求

| 指标 | 目标 |
|------|------|
| 行覆盖率 | ≥ 80% |
| 分支覆盖率 | ≥ 70% |
| 方法覆盖率 | ≥ 90% |

---

## 六、手动测试清单

### 6.1 时光轴视图测试

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 进入联系人详情页，切换到「事实流」标签 | 显示事实流页面 |
| 2 | 确保处于「时光轴」视图模式 | 显示时光轴视图 |
| 3 | 点击一个事实卡片（如"职业：产品经理"） | 弹出编辑对话框 |
| 4 | 修改事实内容，点击保存 | 对话框关闭，事实内容更新 |
| 5 | 再次点击该事实卡片 | 弹出编辑对话框，显示更新后的内容 |
| 6 | 点击删除按钮 | 弹出确认对话框 |
| 7 | 确认删除 | 事实从列表中移除 |

### 6.2 清单视图测试

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 切换到「清单」视图模式 | 显示清单视图 |
| 2 | 点击一个事实行 | 弹出编辑对话框 |
| 3 | 修改事实内容，点击保存 | 对话框关闭，事实内容更新 |
| 4 | 长按进入选择模式 | 显示勾选框 |
| 5 | 在选择模式下点击事实行 | 切换选中状态，不弹出编辑对话框 |

---

## 七、验收标准

| 测试类型 | 通过标准 |
|----------|----------|
| 单元测试 | 全部通过 |
| 边界测试 | 全部通过 |
| 手动测试 | 符合预期行为 |

---

## 八、相关文档

- **BUG文档**：[BUG-00065-事实流编辑功能缺失.md](../BUG/BUG-00065-事实流编辑功能缺失.md)
- **修复方案**：[BUG-00065-事实流编辑功能缺失-修复方案.md](../BUG/BUG-00065-事实流编辑功能缺失-修复方案.md)

---

## 九、变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2026-01-10 | v1.0 | 初始版本 | Kiro |
