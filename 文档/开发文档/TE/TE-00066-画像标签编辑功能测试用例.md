# TE-00066：画像标签编辑功能测试用例

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档编号** | TE-00066 |
| **关联BUG** | BUG-00066 |
| **测试类型** | 功能测试 + 单元测试 |
| **编写者** | Kiro |
| **编写日期** | 2026-01-10 |
| **状态** | 待执行 |

---

## 一、测试范围

### 1.1 测试目标

验证画像标签编辑功能的完整性和正确性，确保：
- 用户可以编辑已添加的标签内容
- 用户可以切换标签类型
- 编辑后数据正确保存到数据库
- UI 实时更新显示新内容

### 1.2 测试模块

| 模块 | 测试内容 |
|------|----------|
| **Domain** | EditBrainTagUseCase 单元测试 |
| **Data** | BrainTagDao.updateTag() 单元测试 |
| **Data** | BrainTagRepositoryImpl.updateTag() 单元测试 |
| **Presentation** | ContactDetailTabViewModel 编辑方法测试 |
| **Presentation** | EditBrainTagDialog UI 测试 |
| **Integration** | 端到端编辑流程测试 |

---

## 二、单元测试用例

### 2.1 EditBrainTagUseCase 测试

**测试文件**：`domain/src/test/kotlin/com/empathy/ai/domain/usecase/EditBrainTagUseCaseTest.kt`

```kotlin
package com.empathy.ai.domain.usecase

import com.empathy.ai.domain.model.BrainTag
import com.empathy.ai.domain.model.TagType
import com.empathy.ai.domain.repository.BrainTagRepository
import io.mockk.coEvery
import io.mockk.coVerify
import io.mockk.mockk
import kotlinx.coroutines.test.runTest
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test

class EditBrainTagUseCaseTest {

    private lateinit var repository: BrainTagRepository
    private lateinit var useCase: EditBrainTagUseCase

    @Before
    fun setup() {
        repository = mockk()
        useCase = EditBrainTagUseCase(repository)
    }

    @Test
    fun `编辑标签内容成功`() = runTest {
        // Given
        val tagId = 1L
        val newContent = "新的标签内容"
        val newType = TagType.RISK_RED
        
        coEvery { repository.updateTag(any()) } returns Result.success(Unit)
        
        // When
        val result = useCase(tagId, newContent, newType)
        
        // Then
        assertTrue(result.isSuccess)
        coVerify { repository.updateTag(any()) }
    }

    @Test
    fun `编辑标签类型成功`() = runTest {
        // Given
        val tagId = 1L
        val newContent = "标签内容"
        val newType = TagType.STRATEGY_GREEN
        
        coEvery { repository.updateTag(any()) } returns Result.success(Unit)
        
        // When
        val result = useCase(tagId, newContent, newType)
        
        // Then
        assertTrue(result.isSuccess)
    }

    @Test
    fun `编辑空内容失败`() = runTest {
        // Given
        val tagId = 1L
        val newContent = ""
        val newType = TagType.RISK_RED
        
        // When
        val result = useCase(tagId, newContent, newType)
        
        // Then
        assertTrue(result.isFailure)
        assertEquals("标签内容不能为空", result.exceptionOrNull()?.message)
    }

    @Test
    fun `编辑空白内容失败`() = runTest {
        // Given
        val tagId = 1L
        val newContent = "   "
        val newType = TagType.RISK_RED
        
        // When
        val result = useCase(tagId, newContent, newType)
        
        // Then
        assertTrue(result.isFailure)
    }

    @Test
    fun `仓库更新失败时返回失败结果`() = runTest {
        // Given
        val tagId = 1L
        val newContent = "新内容"
        val newType = TagType.RISK_RED
        val error = Exception("数据库错误")
        
        coEvery { repository.updateTag(any()) } returns Result.failure(error)
        
        // When
        val result = useCase(tagId, newContent, newType)
        
        // Then
        assertTrue(result.isFailure)
        assertEquals("数据库错误", result.exceptionOrNull()?.message)
    }

    @Test
    fun `从雷区切换到策略类型`() = runTest {
        // Given
        val tagId = 1L
        val newContent = "标签内容"
        val newType = TagType.STRATEGY_GREEN
        
        coEvery { repository.updateTag(any()) } returns Result.success(Unit)
        
        // When
        val result = useCase(tagId, newContent, newType)
        
        // Then
        assertTrue(result.isSuccess)
        coVerify {
            repository.updateTag(match { it.type == TagType.STRATEGY_GREEN })
        }
    }

    @Test
    fun `从策略切换到雷区类型`() = runTest {
        // Given
        val tagId = 1L
        val newContent = "标签内容"
        val newType = TagType.RISK_RED
        
        coEvery { repository.updateTag(any()) } returns Result.success(Unit)
        
        // When
        val result = useCase(tagId, newContent, newType)
        
        // Then
        assertTrue(result.isSuccess)
        coVerify {
            repository.updateTag(match { it.type == TagType.RISK_RED })
        }
    }
}
```

### 2.2 BrainTagRepositoryImpl 测试

**测试文件**：`data/src/test/kotlin/com/empathy/ai/data/repository/BrainTagRepositoryImplUpdateTest.kt`

```kotlin
package com.empathy.ai.data.repository

import com.empathy.ai.data.local.dao.BrainTagDao
import com.empathy.ai.data.local.entity.BrainTagEntity
import com.empathy.ai.domain.model.BrainTag
import com.empathy.ai.domain.model.TagType
import io.mockk.coEvery
import io.mockk.coVerify
import io.mockk.mockk
import kotlinx.coroutines.test.runTest
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test

class BrainTagRepositoryImplUpdateTest {

    private lateinit var dao: BrainTagDao
    private lateinit var repository: BrainTagRepositoryImpl

    @Before
    fun setup() {
        dao = mockk()
        repository = BrainTagRepositoryImpl(dao)
    }

    @Test
    fun `更新标签成功`() = runTest {
        // Given
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "新内容",
            type = TagType.RISK_RED
        )
        
        val existingEntity = BrainTagEntity(
            id = 1L,
            contactId = "contact_1",
            content = "旧内容",
            type = "RISK_RED",
            source = "MANUAL"
        )
        
        coEvery { dao.getTagById(1L) } returns existingEntity
        coEvery { dao.updateTag(any(), any(), any()) } returns Unit
        
        // When
        val result = repository.updateTag(tag)
        
        // Then
        assertTrue(result.isSuccess)
        coVerify { dao.updateTag(1L, "新内容", "RISK_RED") }
    }

    @Test
    fun `更新不存在的标签失败`() = runTest {
        // Given
        val tag = BrainTag(
            id = 999L,
            contactId = "contact_1",
            content = "新内容",
            type = TagType.RISK_RED
        )
        
        coEvery { dao.getTagById(999L) } returns null
        
        // When
        val result = repository.updateTag(tag)
        
        // Then
        assertTrue(result.isFailure)
        assertEquals("标签不存在", result.exceptionOrNull()?.message)
    }

    @Test
    fun `更新标签类型`() = runTest {
        // Given
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "内容",
            type = TagType.STRATEGY_GREEN
        )
        
        val existingEntity = BrainTagEntity(
            id = 1L,
            contactId = "contact_1",
            content = "内容",
            type = "RISK_RED",
            source = "MANUAL"
        )
        
        coEvery { dao.getTagById(1L) } returns existingEntity
        coEvery { dao.updateTag(any(), any(), any()) } returns Unit
        
        // When
        val result = repository.updateTag(tag)
        
        // Then
        assertTrue(result.isSuccess)
        coVerify { dao.updateTag(1L, "内容", "STRATEGY_GREEN") }
    }

    @Test
    fun `数据库异常时返回失败`() = runTest {
        // Given
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "新内容",
            type = TagType.RISK_RED
        )
        
        coEvery { dao.getTagById(1L) } throws Exception("数据库连接失败")
        
        // When
        val result = repository.updateTag(tag)
        
        // Then
        assertTrue(result.isFailure)
    }
}
```

### 2.3 ContactDetailTabViewModel 测试

**测试文件**：`presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/BUG00066EditBrainTagTest.kt`

```kotlin
package com.empathy.ai.presentation.viewmodel

import com.empathy.ai.domain.model.BrainTag
import com.empathy.ai.domain.model.TagType
import com.empathy.ai.domain.usecase.EditBrainTagUseCase
import com.empathy.ai.domain.usecase.GetBrainTagsUseCase
import com.empathy.ai.domain.usecase.GetContactUseCase
import com.empathy.ai.domain.usecase.SaveBrainTagUseCase
import com.empathy.ai.domain.usecase.DeleteBrainTagUseCase
import com.empathy.ai.domain.repository.ConversationRepository
import com.empathy.ai.domain.repository.DailySummaryRepository
import com.empathy.ai.presentation.ui.screen.contact.ContactDetailUiEvent
import io.mockk.coEvery
import io.mockk.mockk
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.ExperimentalCoroutinesApi
import kotlinx.coroutines.test.StandardTestDispatcher
import kotlinx.coroutines.test.resetMain
import kotlinx.coroutines.test.runTest
import kotlinx.coroutines.test.setMain
import org.junit.After
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test

@OptIn(ExperimentalCoroutinesApi::class)
class BUG00066EditBrainTagTest {

    private val testDispatcher = StandardTestDispatcher()
    
    private lateinit var viewModel: ContactDetailTabViewModel
    private lateinit var editBrainTagUseCase: EditBrainTagUseCase
    private lateinit var getContactUseCase: GetContactUseCase
    private lateinit var getBrainTagsUseCase: GetBrainTagsUseCase
    private lateinit var saveBrainTagUseCase: SaveBrainTagUseCase
    private lateinit var deleteBrainTagUseCase: DeleteBrainTagUseCase
    private lateinit var conversationRepository: ConversationRepository
    private lateinit var dailySummaryRepository: DailySummaryRepository

    @Before
    fun setup() {
        Dispatchers.setMain(testDispatcher)
        
        editBrainTagUseCase = mockk()
        getContactUseCase = mockk()
        getBrainTagsUseCase = mockk()
        saveBrainTagUseCase = mockk()
        deleteBrainTagUseCase = mockk()
        conversationRepository = mockk()
        dailySummaryRepository = mockk()
        
        // 注意：实际测试时需要根据 ViewModel 的构造函数调整
    }

    @After
    fun tearDown() {
        Dispatchers.resetMain()
    }

    @Test
    fun `开始编辑标签时显示对话框`() = runTest {
        // Given
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "测试标签",
            type = TagType.RISK_RED
        )
        
        // When
        // viewModel.onEvent(ContactDetailUiEvent.StartEditBrainTag(tag))
        // testDispatcher.scheduler.advanceUntilIdle()
        
        // Then
        // val state = viewModel.uiState.value
        // assertTrue(state.showEditBrainTagDialog)
        // assertEquals(tag, state.editingBrainTag)
        
        // 占位测试，实际实现后取消注释
        assertTrue(true)
    }

    @Test
    fun `取消编辑时关闭对话框`() = runTest {
        // Given
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "测试标签",
            type = TagType.RISK_RED
        )
        
        // When
        // viewModel.onEvent(ContactDetailUiEvent.StartEditBrainTag(tag))
        // viewModel.onEvent(ContactDetailUiEvent.CancelEditBrainTag)
        // testDispatcher.scheduler.advanceUntilIdle()
        
        // Then
        // val state = viewModel.uiState.value
        // assertFalse(state.showEditBrainTagDialog)
        // assertNull(state.editingBrainTag)
        
        assertTrue(true)
    }

    @Test
    fun `确认编辑成功时关闭对话框并显示成功消息`() = runTest {
        // Given
        coEvery { editBrainTagUseCase(any(), any(), any()) } returns Result.success(Unit)
        
        // When
        // viewModel.onEvent(ContactDetailUiEvent.ConfirmEditBrainTag(1L, "新内容", TagType.RISK_RED))
        // testDispatcher.scheduler.advanceUntilIdle()
        
        // Then
        // val state = viewModel.uiState.value
        // assertFalse(state.showEditBrainTagDialog)
        // assertEquals("标签已更新", state.successMessage)
        
        assertTrue(true)
    }

    @Test
    fun `确认编辑失败时显示错误消息`() = runTest {
        // Given
        coEvery { editBrainTagUseCase(any(), any(), any()) } returns Result.failure(Exception("更新失败"))
        
        // When
        // viewModel.onEvent(ContactDetailUiEvent.ConfirmEditBrainTag(1L, "新内容", TagType.RISK_RED))
        // testDispatcher.scheduler.advanceUntilIdle()
        
        // Then
        // val state = viewModel.uiState.value
        // assertEquals("更新失败", state.error)
        
        assertTrue(true)
    }

    @Test
    fun `编辑空内容时显示错误消息`() = runTest {
        // When
        // viewModel.onEvent(ContactDetailUiEvent.ConfirmEditBrainTag(1L, "", TagType.RISK_RED))
        // testDispatcher.scheduler.advanceUntilIdle()
        
        // Then
        // val state = viewModel.uiState.value
        // assertEquals("标签内容不能为空", state.error)
        
        assertTrue(true)
    }

    @Test
    fun `编辑后类型从雷区变为策略`() = runTest {
        // Given
        coEvery { editBrainTagUseCase(any(), any(), any()) } returns Result.success(Unit)
        
        // When
        // viewModel.onEvent(ContactDetailUiEvent.ConfirmEditBrainTag(1L, "内容", TagType.STRATEGY_GREEN))
        // testDispatcher.scheduler.advanceUntilIdle()
        
        // Then
        // 验证 UseCase 被调用时传入了正确的类型
        // coVerify { editBrainTagUseCase(1L, "内容", TagType.STRATEGY_GREEN) }
        
        assertTrue(true)
    }
}
```

---

## 三、UI 测试用例

### 3.1 EditBrainTagDialog 测试

**测试文件**：`presentation/src/androidTest/kotlin/com/empathy/ai/presentation/ui/component/dialog/EditBrainTagDialogTest.kt`

```kotlin
package com.empathy.ai.presentation.ui.component.dialog

import androidx.compose.ui.test.*
import androidx.compose.ui.test.junit4.createComposeRule
import com.empathy.ai.domain.model.BrainTag
import com.empathy.ai.domain.model.TagType
import org.junit.Rule
import org.junit.Test

class EditBrainTagDialogTest {

    @get:Rule
    val composeTestRule = createComposeRule()

    @Test
    fun 对话框显示当前标签内容() {
        // Given
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "测试标签内容",
            type = TagType.RISK_RED
        )
        
        // When
        composeTestRule.setContent {
            EditBrainTagDialog(
                tag = tag,
                onConfirm = { _, _, _ -> },
                onDismiss = {}
            )
        }
        
        // Then
        composeTestRule.onNodeWithText("测试标签内容").assertIsDisplayed()
    }

    @Test
    fun 对话框显示编辑标签标题() {
        // Given
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "内容",
            type = TagType.RISK_RED
        )
        
        // When
        composeTestRule.setContent {
            EditBrainTagDialog(
                tag = tag,
                onConfirm = { _, _, _ -> },
                onDismiss = {}
            )
        }
        
        // Then
        composeTestRule.onNodeWithText("编辑标签").assertIsDisplayed()
    }

    @Test
    fun 点击保存按钮触发确认回调() {
        // Given
        var confirmCalled = false
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "内容",
            type = TagType.RISK_RED
        )
        
        // When
        composeTestRule.setContent {
            EditBrainTagDialog(
                tag = tag,
                onConfirm = { _, _, _ -> confirmCalled = true },
                onDismiss = {}
            )
        }
        
        composeTestRule.onNodeWithText("保存").performClick()
        
        // Then
        assert(confirmCalled)
    }

    @Test
    fun 点击取消按钮触发取消回调() {
        // Given
        var dismissCalled = false
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "内容",
            type = TagType.RISK_RED
        )
        
        // When
        composeTestRule.setContent {
            EditBrainTagDialog(
                tag = tag,
                onConfirm = { _, _, _ -> },
                onDismiss = { dismissCalled = true }
            )
        }
        
        composeTestRule.onNodeWithText("取消").performClick()
        
        // Then
        assert(dismissCalled)
    }

    @Test
    fun 雷区类型标签显示雷区选中状态() {
        // Given
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "内容",
            type = TagType.RISK_RED
        )
        
        // When
        composeTestRule.setContent {
            EditBrainTagDialog(
                tag = tag,
                onConfirm = { _, _, _ -> },
                onDismiss = {}
            )
        }
        
        // Then
        composeTestRule.onNodeWithText("🚫 雷区").assertIsSelected()
    }

    @Test
    fun 策略类型标签显示策略选中状态() {
        // Given
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "内容",
            type = TagType.STRATEGY_GREEN
        )
        
        // When
        composeTestRule.setContent {
            EditBrainTagDialog(
                tag = tag,
                onConfirm = { _, _, _ -> },
                onDismiss = {}
            )
        }
        
        // Then
        composeTestRule.onNodeWithText("✅ 策略").assertIsSelected()
    }

    @Test
    fun 可以切换标签类型() {
        // Given
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "内容",
            type = TagType.RISK_RED
        )
        
        // When
        composeTestRule.setContent {
            EditBrainTagDialog(
                tag = tag,
                onConfirm = { _, _, _ -> },
                onDismiss = {}
            )
        }
        
        // 点击策略类型
        composeTestRule.onNodeWithText("✅ 策略").performClick()
        
        // Then
        composeTestRule.onNodeWithText("✅ 策略").assertIsSelected()
    }

    @Test
    fun 可以修改标签内容() {
        // Given
        val tag = BrainTag(
            id = 1L,
            contactId = "contact_1",
            content = "原内容",
            type = TagType.RISK_RED
        )
        
        // When
        composeTestRule.setContent {
            EditBrainTagDialog(
                tag = tag,
                onConfirm = { _, _, _ -> },
                onDismiss = {}
            )
        }
        
        // 清空并输入新内容
        composeTestRule.onNodeWithText("原内容").performTextClearance()
        composeTestRule.onNodeWithText("").performTextInput("新内容")
        
        // Then
        composeTestRule.onNodeWithText("新内容").assertIsDisplayed()
    }
}
```

---

## 四、集成测试用例

### 4.1 端到端编辑流程测试

| 测试ID | 测试步骤 | 预期结果 |
|--------|----------|----------|
| E2E-001 | 1. 进入联系人详情页<br>2. 切换到画像标签页<br>3. 点击一个标签<br>4. 修改内容<br>5. 点击保存 | 标签内容更新，显示成功提示 |
| E2E-002 | 1. 进入联系人详情页<br>2. 切换到画像标签页<br>3. 点击一个雷区标签<br>4. 切换为策略类型<br>5. 点击保存 | 标签颜色从红变绿，显示成功提示 |
| E2E-003 | 1. 进入联系人详情页<br>2. 切换到画像标签页<br>3. 点击一个标签<br>4. 清空内容<br>5. 点击保存 | 显示错误提示"内容不能为空" |
| E2E-004 | 1. 进入联系人详情页<br>2. 切换到画像标签页<br>3. 点击一个标签<br>4. 点击取消 | 对话框关闭，标签内容不变 |
| E2E-005 | 1. 进入联系人详情页<br>2. 切换到画像标签页<br>3. 长按一个标签 | 触发删除功能（不是编辑） |

---

## 五、回归测试

### 5.1 确保不影响现有功能

| 测试ID | 测试场景 | 预期结果 |
|--------|----------|----------|
| REG-001 | 添加新标签 | 功能正常，不受影响 |
| REG-002 | 删除标签（长按） | 功能正常，不受影响 |
| REG-003 | 查看标签列表 | 功能正常，不受影响 |
| REG-004 | 标签分类显示 | 功能正常，不受影响 |
| REG-005 | AI 推断标签确认/驳回 | 功能正常，不受影响 |

---

## 六、测试执行命令

```bash
# 运行 EditBrainTagUseCase 单元测试
./gradlew :domain:test --tests "*EditBrainTagUseCaseTest*"

# 运行 BrainTagRepositoryImpl 更新测试
./gradlew :data:test --tests "*BrainTagRepositoryImplUpdateTest*"

# 运行 ViewModel 编辑标签测试
./gradlew :presentation:test --tests "*BUG00066EditBrainTagTest*"

# 运行 EditBrainTagDialog UI 测试
./gradlew :presentation:connectedAndroidTest --tests "*EditBrainTagDialogTest*"

# 运行所有 BUG-00066 相关测试
./gradlew test --tests "*BUG00066*"
./gradlew test --tests "*EditBrainTag*"
```

---

## 七、测试环境

| 项目 | 要求 |
|------|------|
| **Android 版本** | API 24+ (Android 7.0+) |
| **测试框架** | JUnit 4.13.2, MockK 1.13.13 |
| **协程测试** | kotlinx-coroutines-test 1.9.0 |
| **UI 测试** | Compose UI Test |
| **设备** | 模拟器或真机 |

---

## 八、变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2026-01-10 | v1.0 | 初始版本 | Kiro |
