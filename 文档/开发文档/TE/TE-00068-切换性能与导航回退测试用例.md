# TE-00068：切换性能与导航回退测试用例

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档编号** | TE-00068 |
| **关联BUG** | BUG-00068 |
| **测试类型** | 功能测试 + UI测试 + 回归测试 |
| **编写者** | Codex |
| **编写日期** | 2026-01-10 |

---

## 一、测试范围

### 1.1 测试目标

验证以下问题在修复后符合预期：
1. AI军师Tab多次切换仍能正确显示内容并触发导航。
2. 设置 -> AI配置/提示词编辑返回应回到设置页。
3. 非Tab页面切换性能与重建闪烁得到缓解。

### 1.2 关联模块

| 模块 | 文件 | 测试类型 |
|------|------|----------|
| AI军师入口 | `AiAdvisorScreen.kt` / `AiAdvisorEntryViewModel.kt` | 单元测试 + UI测试 |
| 主导航 | `MainActivity.kt` / `NavGraph.kt` | UI测试 + 手动回归 |
| 页面缓存 | `BottomNavScaffold.kt` | 手动回归 |

---

## 二、单元测试用例

### 2.1 ViewModel 测试

**测试文件**：`presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/BUG00068AiAdvisorEntryViewModelTest.kt`

#### TC-001：首次进入有历史联系人时导航到Chat

```kotlin
@Test
fun `首次进入且lastContact存在时应导航到Chat`() = runTest {
    // Given
    val viewModel = createViewModel(lastContactId = "c1", contactExists = true)

    // Then
    val state = viewModel.uiState.value
    assertTrue(state.navigationTarget is AiAdvisorNavigationTarget.Chat)
}
```

#### TC-002：首次进入无历史联系人时导航到ContactSelect

```kotlin
@Test
fun `首次进入且lastContact为空时应导航到ContactSelect`() = runTest {
    // Given
    val viewModel = createViewModel(lastContactId = null, contactExists = false)

    // Then
    val state = viewModel.uiState.value
    assertTrue(state.navigationTarget is AiAdvisorNavigationTarget.ContactSelect)
}
```

#### TC-003：导航完成后可再次刷新导航目标

```kotlin
@Test
fun `导航完成后刷新应重新计算导航目标`() = runTest {
    // Given
    val viewModel = createViewModel(lastContactId = "c1", contactExists = true)
    viewModel.resetNavigationState()

    // When
    viewModel.refreshNavigationTarget()

    // Then
    val state = viewModel.uiState.value
    assertTrue(state.navigationTarget is AiAdvisorNavigationTarget.Chat)
}
```

#### TC-004：联系人不存在时清理偏好并导航到选择页

```kotlin
@Test
fun `联系人不存在应清理偏好并导航到ContactSelect`() = runTest {
    // Given
    val viewModel = createViewModel(lastContactId = "c1", contactExists = false)

    // Then
    val state = viewModel.uiState.value
    assertTrue(state.navigationTarget is AiAdvisorNavigationTarget.ContactSelect)
    assertTrue(preferencesCleared)
}
```

---

## 三、UI 测试用例

### 3.1 Compose UI 测试

**测试文件**：`presentation/src/androidTest/kotlin/com/empathy/ai/presentation/ui/screen/BUG00068NavigationUiTest.kt`

#### TC-UI-001：AI军师Tab二次进入仍有内容

```kotlin
@Test
fun `切换AI军师Tab多次应显示内容`() {
    launchMainScreen()
    selectTab("AI军师")
    selectTab("联系人")
    selectTab("AI军师")

    composeTestRule.onNodeWithText("AI军师").assertIsDisplayed()
}
```

#### TC-UI-002：设置 -> AI配置返回回到设置

```kotlin
@Test
fun `AI配置返回应回到设置页`() {
    launchMainScreen()
    selectTab("设置")
    clickSettingItem("AI 服务商")
    pressBack()

    composeTestRule.onNodeWithText("设置").assertIsDisplayed()
}
```

#### TC-UI-003：设置 -> 提示词编辑返回回到设置

```kotlin
@Test
fun `提示词编辑返回应回到设置页`() {
    launchMainScreen()
    selectTab("设置")
    clickSettingItem("提示词设置")
    pressBack()

    composeTestRule.onNodeWithText("设置").assertIsDisplayed()
}
```

---

## 四、手动回归测试用例

### 4.1 性能与切换

| 用例编号 | 场景 | 操作步骤 | 预期结果 |
|---------|------|---------|----------|
| TC-M-001 | Tab切换稳定性 | 联系人->AI军师->设置循环5次 | 无黑屏/白屏，页面内容正常 |
| TC-M-002 | 非Tab页面切换 | 联系人详情->返回->AI知识->返回 | 页面切换无明显黑屏 |
| TC-M-003 | 设置深层页面 | 设置->AI配置->编辑服务商->返回 | 返回链路到设置页 |
| TC-M-004 | 提示词编辑链路 | 设置->提示词编辑->返回 | 返回链路到设置页 |

---

## 五、边界测试

### 5.1 异常路径

#### TC-EDGE-001：lastContactId为空 + 切换Tab
期望：每次进入AI军师Tab进入联系人选择页面或稳定内容页。

#### TC-EDGE-002：联系人被删除后再次进入AI军师
期望：自动清理偏好并进入联系人选择页面。

---

## 六、测试执行

### 6.1 运行命令

```bash
# 运行单元测试
./gradlew :presentation:testDebugUnitTest --rerun

# 运行UI测试
./gradlew :presentation:connectedAndroidTest --tests "*BUG00068NavigationUiTest*"
```

### 6.2 执行记录

| 时间 | 命令 | 结果 | 备注 |
|------|------|------|------|
| 2026-01-10 | `./gradlew :presentation:testDebugUnitTest --rerun` | 失败 | `transformDebugClassesWithAsm` 删除目录失败 |
| 2026-01-10 | `./gradlew :presentation:testDebugUnitTest --rerun` | 失败 | `compileDebugUnitTestKotlin`，大量 `Unresolved reference` 于现有测试 |
| 2026-01-10 | `./gradlew :app:assembleDebug` | 失败 | `:app:compileDebugKotlin`，`FloatingWindowService`/`AppTheme` 多处 `Unresolved reference` |
| 2026-01-10 | `./gradlew :presentation:bundleLibCompileToJarDebug --rerun-tasks` | 失败 | Gradle 任务长时间执行超时，中断于 `:domain:compileKotlin`/`kapt` 阶段 |
| 2026-01-10 | `./gradlew :app:compileDebugKotlin` | 失败 | Gradle 任务长时间执行超时，中断于 `:app:kaptDebugKotlin` 阶段 |
| 2026-01-10 | `./gradlew :presentation:clean :presentation:assembleDebug --no-daemon` | 通过 | `presentation` 产物可用 |
| 2026-01-10 | `./gradlew :app:assembleDebug --no-daemon` | 通过 | 生成 `app/build/outputs/apk/debug/app-debug.apk` |
| 2026-01-10 | `adb -s 127.0.0.1:7555 install -r app/build/outputs/apk/debug/app-debug.apk` | 通过 | MuMu 安装成功 |
| 2026-01-10 | `adb -s 127.0.0.1:7555 shell am start -n com.empathy.ai/.ui.MainActivity` | 通过 | 启动 MainActivity 成功 |
| 2026-01-10 | `adb -s 127.0.0.1:7555 logcat -d` | 通过 | 仅见系统/渲染日志，无明显崩溃栈 |
| 2026-01-10 | `adb -s 127.0.0.1:7555 logcat -c` | 通过 | 清空日志，等待人工验收 |
| 2026-01-10 | `adb -s 127.0.0.1:7555 logcat -d` | 通过 | 当前未输出 `com.empathy.ai` 日志（可能未执行手动用例或日志被过滤） |

### 6.3 验收标准

| 测试类型 | 通过标准 |
|----------|----------|
| 单元测试 | 全部通过 |
| UI测试 | 全部通过 |
| 手动测试 | 符合预期行为 |

---

## 七、相关文档

- **BUG文档**：[BUG-00068-AI军师入口与设置回退及非Tab性能覆盖问题.md](../BUG/BUG-00068-AI军师入口与设置回退及非Tab性能覆盖问题.md)
