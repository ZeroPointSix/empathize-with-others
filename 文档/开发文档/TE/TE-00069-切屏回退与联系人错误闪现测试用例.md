# TE-00069：切屏回退与联系人错误闪现测试用例

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档编号** | TE-00069 |
| **关联BUG** | BUG-00069 |
| **测试类型** | 功能测试 + UI测试 + 回归测试 |
| **编写者** | Codex |
| **编写日期** | 2026-01-11 |

---

## 一、测试范围

### 1.1 测试目标
验证以下问题修复后符合预期：
1. AI军师入口不再出现双页面叠加或Logo被覆盖。
2. AI军师返回不再需要退两层。
3. 切屏黑屏现象显著改善。
4. 联系人点击进入时不再闪现“出错了”。
5. 新建联系人进入时无黑屏。
6. AI配置/提示词配置系统返回回到设置页。
7. 底部导航栏“AI军师”标签更名为“心语”。
8. 联系人详情返回时回到联系人Tab，而不是设置页。
9. 联系人列表初次进入不闪现“出错了”卡片。

### 1.2 关联模块

| 模块 | 文件 | 测试类型 |
|------|------|----------|
| AI军师入口 | `AiAdvisorScreen.kt` / `AiAdvisorEntryViewModel.kt` | 单元测试 + UI测试 |
| 主导航 | `MainActivity.kt` / `NavGraph.kt` | UI测试 + 手动回归 |
| 设置返回 | `PromptEditorNavigation.kt` / `AiConfigScreen.kt` | UI测试 + 手动回归 |
| 联系人详情 | `ContactDetailTabScreen.kt` / `ContactDetailTabViewModel.kt` | 单元测试 + 手动回归 |

---

## 二、单元测试用例（草案）

### 2.1 ViewModel 测试

**测试文件建议**：`presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/BUG00069AiAdvisorEntryViewModelTest.kt`

#### TC-001：入口稳定页不触发叠加导航
```kotlin
@Test
fun `入口页可见时仅触发单次导航`() = runTest {
    val viewModel = createViewModel(lastContactId = "c1", contactExists = true)
    viewModel.refreshNavigationTarget()
    viewModel.resetNavigationState()
    viewModel.refreshNavigationTarget()
    assertTrue(viewModel.uiState.value.navigationTarget is AiAdvisorNavigationTarget.Chat)
}
```

**测试文件建议**：`presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/BUG00069ContactDetailTabViewModelTest.kt`

#### TC-002：加载成功后 error 为空
```kotlin
@Test
fun `联系人加载成功后不应保留error`() = runTest {
    val viewModel = createViewModelWithContact("c1")
    viewModel.loadContactDetail("c1")
    assertNull(viewModel.uiState.value.error)
}
```

---

## 三、UI 测试用例（草案）

**测试文件建议**：`presentation/src/androidTest/kotlin/com/empathy/ai/presentation/ui/BUG00069NavigationUiTest.kt`

#### TC-UI-001：AI军师入口不出现双页面
```kotlin
@Test
fun `进入AI军师后不应出现双页面叠加`() {
    launchMainScreen()
    selectTab("心语")
    // 检查仅出现稳定入口或对话页的关键元素
    composeTestRule.onNodeWithText("AI军师").assertExists()
}
```

#### TC-UI-002：AI军师返回仅需一次
```kotlin
@Test
fun `AI军师返回不应需要两层`() {
    launchMainScreen()
    selectTab("心语")
    pressBack()
    composeTestRule.onNodeWithText("联系人").assertIsDisplayed()
}
```

#### TC-UI-003：设置 -> AI配置系统返回回到设置
```kotlin
@Test
fun `AI配置系统返回应回到设置页`() {
    launchMainScreen()
    selectTab("设置")
    clickSettingItem("AI 服务商")
    pressBack()
    composeTestRule.onNodeWithText("设置").assertIsDisplayed()
}
```

#### TC-UI-004：设置 -> 提示词配置系统返回回到设置
```kotlin
@Test
fun `提示词编辑系统返回应回到设置页`() {
    launchMainScreen()
    selectTab("设置")
    clickSettingItem("提示词设置")
    pressBack()
    composeTestRule.onNodeWithText("设置").assertIsDisplayed()
}
```

---

## 四、手动回归测试用例

| 用例编号 | 场景 | 操作步骤 | 预期结果 |
|---------|------|---------|----------|
| TC-M-001 | AI军师入口叠加 | 联系人 -> AI军师 | 无Logo被覆盖、无多层叠加 |
| TC-M-002 | AI军师返回层级 | AI军师进入后返回 | 一次返回回到上一Tab |
| TC-M-003 | Tab切屏黑屏 | 联系人/AI军师/设置循环切换5次 | 无明显黑屏 |
| TC-M-004 | 联系人错误闪现 | 点击联系人进入详情 | 不出现“出错了”闪现 |
| TC-M-005 | 新建联系人黑屏 | 点击新建联系人 | 无黑屏/空白 |
| TC-M-006 | AI配置返回 | 设置 -> AI配置 -> 返回 | 回到设置页 |
| TC-M-007 | 提示词配置返回 | 设置 -> 提示词编辑 -> 返回 | 回到设置页 |
| TC-M-008 | Tab标签更名 | 检查底部导航栏 | 显示“心语”而非“AI军师” |
| TC-M-009 | 联系人详情返回 | 联系人 -> 概览 -> 返回 | 回到联系人Tab，不跳设置 |
| TC-M-010 | 联系人列表错误闪现 | 冷启动进入联系人列表 | 不出现“出错了”卡片 |

---

## 五、边界测试

### 5.1 异常路径

#### TC-EDGE-001：lastContactId为空 + 多次切换AI军师
期望：每次进入均显示稳定入口或联系人选择页。

#### TC-EDGE-002：联系人不存在 + 进入详情
期望：显示明确错误页面，且不闪现后恢复。

---

## 六、执行命令（如需）

```bash
# 单元测试（示例）
./gradlew :presentation:testDebugUnitTest --tests "*BUG00069*"

# UI测试（示例）
./gradlew :presentation:connectedAndroidTest --tests "*BUG00069NavigationUiTest*"
```

---

## 七、相关文档

- **BUG文档**：`文档/开发文档/BUG/BUG-00069-切屏回退与联系人错误闪现问题.md`
