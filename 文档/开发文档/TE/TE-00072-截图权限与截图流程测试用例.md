# TE-00072：截图权限与截图流程测试用例
## 文档信息
| 项目 | 内容 |
|------|------|
| 文档编号 | TE-00072 |
| 关联BUG | BUG-00072 |
| 测试类型 | 功能测试 + 回归测试 + 兼容性测试 |
| 编写者 | Codex |
| 编写日期 | 2026-01-16 |

---

## 一、测试范围
### 1.1 测试目标
验证截图权限在设置页授权后可复用，悬浮窗截图流程可进入遮罩框并生成缩略图：
1. 设置页授权后开关状态正确刷新。
2. 悬浮窗截图进入黑色遮罩框并完成截图。
3. 授权失效/清除后提示重新授权。
4. 进程重启后如权限缓存失效，应引导重新授权。

### 1.2 关联模块
| 模块 | 文件 | 测试类型 |
|------|------|----------|
| 截图权限中转 | `app/src/main/java/com/empathy/ai/ui/ScreenshotPermissionActivity.kt` | 功能 |
| 悬浮窗服务 | `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt` | 集成/回归 |
| 悬浮窗偏好 | `data/src/main/kotlin/com/empathy/ai/data/local/FloatingWindowPreferences.kt` | 功能 |
| 设置页状态 | `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/SettingsViewModel.kt` | 功能 |

---

## 二、手动测试用例

| 用例编号 | 场景 | 步骤 | 预期结果 |
|---------|------|------|----------|
| TC-M-001 | 设置页授权 | 设置页 → 点击“截图权限” → 选择“整个屏幕” → 返回设置页 | 开关变为开启 |
| TC-M-002 | 悬浮窗截图 | 打开悬浮窗 → 点击“截图” | 出现黑色遮罩框 |
| TC-M-003 | 截图缩略图 | 遮罩框拖拽选区 → 松手 | 生成截图缩略图 |
| TC-M-004 | 清除权限 | 设置页关闭“截图权限” | 开关关闭，权限清除 |
| TC-M-005 | 失效提示 | 权限关闭后点击悬浮窗“截图” | 提示需重新授权 |
| TC-M-006 | 进程重启 | 授权后杀进程并重启 App → 进入设置页 | 开关关闭，提示需重新授权 |

---

## 三、兼容性测试矩阵
| 设备/环境 | 版本 | 预期 |
|-----------|------|------|
| OPPO 真机 | Android 12+ | 授权可复用，截图流程正常 |
| MuMu 模拟器 | Android 12+ | 授权可复用，截图流程正常 |

---

## 四、回归测试关注点
- 悬浮窗启停与最小化/恢复不受影响。
- 连续截屏开关行为不回归。
- 悬浮窗权限与通知栏状态不受影响。

---

## 五、执行命令（如需）
```bash
# 构建
./gradlew :app:assembleDebug

# 安装到 OPPO
adb -s <device-id> install -r app/build/outputs/apk/debug/app-debug.apk
```

---

## 六、相关文档
- `文档/开发文档/BUG/BUG-00072-截图黑屏排查尝试记录.md`
