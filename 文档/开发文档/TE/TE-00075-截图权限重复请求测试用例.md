# TE-00075：截图权限重复请求测试用例
## 文档信息
| 项目 | 内容 |
|------|------|
| 文档编号 | TE-00075 |
| 关联BUG | BUG-00075 |
| 测试类型 | 功能测试 + 回归测试 + 兼容性测试 |
| 编写者 | Codex |
| 编写日期 | 2026-01-17 |

---

## 一、测试范围
### 1.1 测试目标
验证“设置页授权后悬浮窗截图仍再次弹窗”的修复效果：
1. 设置页授权后，同进程首次截图不再重复弹窗。
2. 权限失效或进程重启后，仍可正确引导重新授权。
3. Android 14+ 与 Android 13- 行为符合预期差异。

### 1.2 关联模块
| 模块 | 文件 | 测试类型 |
|------|------|----------|
| 截图权限中转 | `app/src/main/java/com/empathy/ai/ui/ScreenshotPermissionActivity.kt` | 功能 |
| 悬浮窗服务 | `app/src/main/java/com/empathy/ai/service/FloatingWindowService.kt` | 集成/回归 |
| 权限缓存 | `data/src/main/kotlin/com/empathy/ai/data/local/FloatingWindowPreferences.kt` | 功能 |
| 设置页逻辑 | `presentation/src/main/kotlin/com/empathy/ai/presentation/viewmodel/SettingsViewModel.kt` | 功能 |

---

## 二、手动测试用例

| 用例编号 | 场景 | 步骤 | 预期结果 |
|---------|------|------|----------|
| TC-M-001 | 设置页授权后首次截图 | 设置页 → “截图权限”授权 → 打开悬浮窗 → 点击“截图” | **不再弹出第二次授权**（同进程） |
| TC-M-002 | 权限失效后再次截图 | 完成截图后继续截图（触发权限失效场景） | 若 MediaProjection 失效，应提示重新授权 |
| TC-M-003 | 进程重启后截图 | 授权后杀进程并重启 App → 悬浮窗截图 | Android 14+ 需重新授权；Android 13- 可复用 |
| TC-M-004 | 设置页关闭权限 | 设置页关闭“截图权限” → 悬浮窗截图 | 提示需要重新授权 |

---

## 三、兼容性测试矩阵
| 设备/环境 | 版本 | 预期 |
|-----------|------|------|
| OPPO 真机 | Android 14+ | 设置页授权后首次截图不重复弹窗；重启后需重新授权 |
| 模拟器 | Android 13- | 设置页授权后首次截图不重复弹窗；重启后可复用 |

---

## 四、回归测试关注点
- 截图遮罩框展示与缩略图生成不回归。
- 连续截屏逻辑不回归。
- 悬浮窗服务前台服务类型切换不回归。

---

## 五、执行命令（如需）
```bash
# 构建
./gradlew :app:assembleDebug
```

---

## 六、相关文档
- `文档/开发文档/BUG/BUG-00075-截图完成后跳出权限请求分析.md`
