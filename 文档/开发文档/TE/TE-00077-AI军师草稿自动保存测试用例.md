# TE-00077：AI军师草稿自动保存测试用例

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档编号** | TE-00077 |
| **关联需求** | FREE-20260119 AI军师草稿自动保存与恢复 |
| **测试类型** | 功能测试 + 单元测试 |
| **编写者** | Codex |
| **编写日期** | 2026-01-19 |

---

## 一、测试范围

### 1.1 测试目标

验证 AI 军师会话草稿自动保存与恢复能力，确保：
1. 输入草稿能在会话切换后恢复
2. 发送消息后草稿自动清除
3. 草稿保存有节流（避免频繁写入）
4. 空草稿不会被恢复
5. 恢复草稿时展示提示，可手动关闭或自动消失
6. 删除会话后草稿同步清理
7. 清除所有设置时草稿同步清理
8. 清除偏好失败时回退清草稿且不影响结果

### 1.2 测试模块

| 模块 | 文件 | 测试类型 |
|------|------|----------|
| ViewModel | `AiAdvisorChatViewModel.kt` | 单元测试 |
| Preferences | `AiAdvisorPreferences.kt` | 单元测试（UseCase级别） |
| Settings ViewModel | `SettingsViewModel.kt` | 单元测试 |
| Session History ViewModel | `SessionHistoryViewModel.kt` | 单元测试 |
| Contact UseCase | `DeleteContactUseCase.kt` | 单元测试 |
| Preferences UseCase | `ClearAdvisorPreferencesUseCase.kt` | 单元测试 |

---

## 二、单元测试用例

**测试文件**：
- `domain/src/test/kotlin/com/empathy/ai/domain/usecase/GetAdvisorDraftUseCaseTest.kt`
- `domain/src/test/kotlin/com/empathy/ai/domain/usecase/SaveAdvisorDraftUseCaseTest.kt`
- `domain/src/test/kotlin/com/empathy/ai/domain/usecase/ClearAdvisorDraftUseCaseTest.kt`
- `domain/src/test/kotlin/com/empathy/ai/domain/usecase/ClearAllAdvisorDraftsUseCaseTest.kt`
- `presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/AiAdvisorChatDraftTest.kt`
- `presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/SettingsViewModelBug00070Test.kt`
- `presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/SessionHistoryViewModelDraftTest.kt`
- `domain/src/test/kotlin/com/empathy/ai/domain/usecase/DeleteContactUseCaseTest.kt`
- `domain/src/test/kotlin/com/empathy/ai/domain/usecase/ClearAdvisorPreferencesUseCaseTest.kt`

### TC-001：更新输入后触发延迟保存草稿

```kotlin
@Test
fun `updateInput 触发延迟保存草稿`() = runTest {
    val sessionId = "session-1"
    val viewModel = createViewModel()
    viewModel.switchSession(sessionId)
    viewModel.updateInput("你好")
    advanceTimeBy(400)
    coVerify { saveAdvisorDraftUseCase(sessionId, "你好") }
}
```

### TC-002：切换会话恢复草稿

```kotlin
@Test
fun `切换会话时恢复草稿`() = runTest {
    val sessionId = "session-2"
    val viewModel = createViewModel()
    viewModel.switchSession(sessionId)
    assertEquals("草稿内容", viewModel.uiState.value.inputText)
}
```

### TC-003：草稿存取/清除用例成功与失败分支

已在以下单元测试中覆盖：
- `GetAdvisorDraftUseCaseTest`
- `SaveAdvisorDraftUseCaseTest`
- `ClearAdvisorDraftUseCaseTest`
- `ClearAllAdvisorDraftsUseCaseTest`

### TC-003b：清除全部草稿用例成功与失败分支

```kotlin
@Test
fun `清除全部草稿成功返回success`() = runTest {
    every { repository.clearAllDrafts() } returns Unit
    val result = useCase()
    assertTrue(result.isSuccess)
}

@Test
fun `清除全部草稿异常返回failure`() = runTest {
    val error = IllegalStateException("clear all failed")
    every { repository.clearAllDrafts() } throws error
    val result = useCase()
    assertTrue(result.isFailure)
}
```

### TC-004：恢复草稿时显示提示

```kotlin
@Test
fun `切换会话恢复草稿时显示提示`() = runTest {
    val sessionId = "session-3"
    coEvery { getAdvisorDraftUseCase(sessionId) } returns Result.success("草稿内容")
    val viewModel = createViewModel()
    viewModel.switchSession(sessionId)
    testDispatcher.scheduler.runCurrent()
    assertEquals(
        R.string.advisor_draft_restored_message,
        viewModel.uiState.value.draftRestoredMessageResId
    )
}
```

### TC-004b：草稿恢复提示自动关闭

```kotlin
@Test
fun `草稿恢复提示自动关闭`() = runTest {
    val sessionId = "session-4"
    coEvery { getAdvisorDraftUseCase(sessionId) } returns Result.success("草稿内容")
    val viewModel = createViewModel()
    viewModel.switchSession(sessionId)
    testDispatcher.scheduler.runCurrent()
    advanceTimeBy(3000)
    assertNull(viewModel.uiState.value.draftRestoredMessageResId)
}
```

### TC-005：更新输入后清除草稿恢复提示

```kotlin
@Test
fun `更新输入后清除草稿恢复提示`() = runTest {
    val sessionId = "session-5"
    coEvery { getAdvisorDraftUseCase(sessionId) } returns Result.success("草稿内容")
    val viewModel = createViewModel()
    viewModel.switchSession(sessionId)
    testDispatcher.scheduler.runCurrent()
    viewModel.updateInput("新的输入")
    assertNull(viewModel.uiState.value.draftRestoredMessageResId)
}
```

### TC-006：设置页清除 AI 军师草稿

```kotlin
@Test
fun `clear advisor drafts should clear data and show success message`() = runTest {
    coEvery { mockClearAllAdvisorDraftsUseCase() } returns Result.success(Unit)
    every {
        mockApplication.getString(R.string.settings_clear_advisor_drafts_success)
    } returns "AI 军师草稿已清除"
    val viewModel = createViewModel()
    viewModel.onEvent(SettingsUiEvent.ClearAdvisorDrafts)
    assertEquals("AI 军师草稿已清除", viewModel.uiState.value.successMessage)
}
```

### TC-006b：设置页清除草稿失败提示

```kotlin
@Test
fun `clear advisor drafts failure should show error message`() = runTest {
    coEvery { mockClearAllAdvisorDraftsUseCase() } returns Result.failure(IllegalStateException())
    every {
        mockApplication.getString(R.string.settings_clear_advisor_drafts_failed)
    } returns "清除草稿失败"
    val viewModel = createViewModel()
    viewModel.onEvent(SettingsUiEvent.ClearAdvisorDrafts)
    assertEquals("清除草稿失败", viewModel.uiState.value.error)
}
```

### TC-006c：设置页清除草稿失败空消息兜底

```kotlin
@Test
fun `clear advisor drafts failure should fallback when error message is blank`() = runTest {
    coEvery { mockClearAllAdvisorDraftsUseCase() } returns Result.failure(IllegalStateException(""))
    every {
        mockApplication.getString(R.string.settings_clear_advisor_drafts_failed)
    } returns "清除草稿失败"
    val viewModel = createViewModel()
    viewModel.onEvent(SettingsUiEvent.ClearAdvisorDrafts)
    assertEquals("清除草稿失败", viewModel.uiState.value.error)
}
```

### TC-006d：清除所有设置时清理偏好

```kotlin
@Test
fun `clear all data should clear advisor preferences`() = runTest {
    coEvery { mockClearAdvisorPreferencesUseCase() } returns Result.success(Unit)
    coEvery { mockSettingsRepository.setDataMaskingEnabled(true) } returns Result.success(Unit)
    coEvery { mockSettingsRepository.setLocalFirstModeEnabled(true) } returns Result.success(Unit)
    every { mockPreferencesRepository.saveEnabled(false) } just Runs
    every { mockPreferencesRepository.saveContinuousScreenshotEnabled(false) } just Runs
    val viewModel = createViewModel()
    viewModel.onEvent(SettingsUiEvent.ClearAllData)
    testDispatcher.scheduler.advanceUntilIdle()
    coVerify { mockClearAdvisorPreferencesUseCase() }
    assertEquals("所有设置已清除", viewModel.uiState.value.successMessage)
}
```

### TC-006e：清除所有设置偏好失败时回退清草稿

```kotlin
@Test
fun `clear all data should fallback to clear drafts when preferences fail`() = runTest {
    coEvery { mockClearAdvisorPreferencesUseCase() } returns Result.failure(IllegalStateException("prefs fail"))
    coEvery { mockClearAllAdvisorDraftsUseCase() } returns Result.success(Unit)
    coEvery { mockSettingsRepository.setDataMaskingEnabled(true) } returns Result.success(Unit)
    coEvery { mockSettingsRepository.setLocalFirstModeEnabled(true) } returns Result.success(Unit)
    every { mockPreferencesRepository.saveEnabled(false) } just Runs
    every { mockPreferencesRepository.saveContinuousScreenshotEnabled(false) } just Runs
    val viewModel = createViewModel()
    viewModel.onEvent(SettingsUiEvent.ClearAllData)
    testDispatcher.scheduler.advanceUntilIdle()
    coVerify { mockClearAdvisorPreferencesUseCase() }
    coVerify { mockClearAllAdvisorDraftsUseCase() }
    assertEquals("所有设置已清除", viewModel.uiState.value.successMessage)
}
```

### TC-006f：清除所有设置时草稿清理失败不影响结果

```kotlin
@Test
fun `clear all data should succeed even when clear drafts fails`() = runTest {
    coEvery { mockClearAdvisorPreferencesUseCase() } returns Result.failure(IllegalStateException("prefs fail"))
    coEvery { mockClearAllAdvisorDraftsUseCase() } returns Result.failure(IllegalStateException("draft fail"))
    coEvery { mockSettingsRepository.setDataMaskingEnabled(true) } returns Result.success(Unit)
    coEvery { mockSettingsRepository.setLocalFirstModeEnabled(true) } returns Result.success(Unit)
    every { mockPreferencesRepository.saveEnabled(false) } just Runs
    every { mockPreferencesRepository.saveContinuousScreenshotEnabled(false) } just Runs
    val viewModel = createViewModel()
    viewModel.onEvent(SettingsUiEvent.ClearAllData)
    testDispatcher.scheduler.advanceUntilIdle()
    coVerify { mockClearAdvisorPreferencesUseCase() }
    coVerify { mockClearAllAdvisorDraftsUseCase() }
    assertEquals("所有设置已清除", viewModel.uiState.value.successMessage)
}
```

### TC-007：删除会话时清除草稿

```kotlin
@Test
fun `delete session should clear draft`() = runTest {
    val sessionId = "session-1"
    coEvery { aiAdvisorRepository.deleteSession(sessionId) } returns Result.success(Unit)
    coEvery { clearAdvisorDraftUseCase(sessionId) } returns Result.success(Unit)
    val viewModel = createViewModel()
    viewModel.deleteSession(sessionId)
    advanceUntilIdle()
    coVerify { clearAdvisorDraftUseCase(sessionId) }
}
```

### TC-008：删除联系人后清理会话草稿

```kotlin
@Test
fun `删除联系人成功后清理会话草稿`() = runTest {
    val contactId = "contact-1"
    val sessions = listOf(
        AiAdvisorSession(id = "session-1", contactId = contactId, title = "s1", messageCount = 0, createdAt = 1L, updatedAt = 1L)
    )
    coEvery { aiAdvisorRepository.getSessions(contactId) } returns Result.success(sessions)
    coEvery { contactRepository.deleteProfile(contactId) } returns Result.success(Unit)
    coEvery { clearAdvisorDraftUseCase(any()) } returns Result.success(Unit)
    val result = useCase(contactId)
    assertTrue(result.isSuccess)
    coVerify { clearAdvisorDraftUseCase("session-1") }
}
```

### TC-008b：清理草稿失败不影响联系人删除

```kotlin
@Test
fun `清理草稿失败不影响联系人删除结果`() = runTest {
    val contactId = "contact-1"
    val sessions = listOf(
        AiAdvisorSession(id = "session-1", contactId = contactId, title = "s1", messageCount = 0, createdAt = 1L, updatedAt = 1L)
    )
    coEvery { aiAdvisorRepository.getSessions(contactId) } returns Result.success(sessions)
    coEvery { contactRepository.deleteProfile(contactId) } returns Result.success(Unit)
    coEvery { clearAdvisorDraftUseCase(any()) } returns Result.failure(Exception("draft failed"))
    val result = useCase(contactId)
    assertTrue(result.isSuccess)
    coVerify { clearAdvisorDraftUseCase("session-1") }
}
```

---

## 三、人工测试用例

### TC-101：会话切换后草稿恢复

**前置条件**：存在至少 2 个会话  
**步骤**：
1. 进入 AI 军师会话 A
2. 输入一段未发送内容（如“待问的问题”）
3. 切换到会话 B
4. 再切回会话 A

**预期结果**：
1. 会话 A 的输入框自动恢复草稿内容

### TC-102：发送消息后草稿清空

**步骤**：
1. 在任意会话输入草稿
2. 点击发送

**预期结果**：
1. 输入框清空
2. 切换离开再返回该会话，草稿不再恢复

### TC-103：清空输入后不再恢复草稿

**步骤**：
1. 在任意会话输入草稿
2. 手动删除文本至空
3. 切换会话后再返回

**预期结果**：
1. 输入框保持为空，不恢复已清空的草稿

### TC-104：切换联系人后草稿仍可恢复

**步骤**：
1. 在联系人 A 的会话中输入草稿
2. 切换到联系人 B
3. 返回联系人 A

**预期结果**：
1. 联系人 A 原会话草稿仍可恢复

### TC-105：恢复草稿提示展示与关闭

**步骤**：
1. 在会话 A 输入草稿后切换到会话 B
2. 再切回会话 A
3. 等待 3 秒观察提示条
4. 点击提示条或开始输入新内容

**预期结果**：
1. 输入框恢复草稿内容
2. 显示“已恢复上次草稿”提示
3. 等待 3 秒后提示自动消失
4. 点击提示或开始输入后提示消失

### TC-106：设置页清除 AI 军师草稿

**步骤**：
1. 进入设置 → 数据管理
2. 点击“清除 AI 军师草稿”
3. 在确认弹窗中点击“确定清除”
4. 返回 AI 军师会话页面

**预期结果**：
1. 显示“AI 军师草稿已清除”的成功提示
2. 会话草稿不再恢复
3. 会话历史记录保持不变

---

## 四、补充说明

- 草稿使用加密偏好存储，最多保留 12 个会话草稿
- 保存策略使用 350ms 延迟写入以减少频繁持久化
