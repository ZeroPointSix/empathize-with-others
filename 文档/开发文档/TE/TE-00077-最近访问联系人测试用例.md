# TE-00077：最近访问联系人测试用例

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档编号** | TE-00077 |
| **关联需求** | FREE-00008 最近访问联系人快捷入口 |
| **测试类型** | 功能测试 + 单元测试 |
| **编写者** | Codex |
| **编写日期** | 2026-01-19 |

---

## 一、测试范围

### 1.1 测试目标

验证最近访问联系人功能的完整性与正确性，确保：
1. 进入联系人详情后会记录为“最近访问”
2. 最近访问列表按访问顺序显示并去重
3. 清空按钮可移除最近访问列表
4. 返回列表时会刷新最近访问区块

### 1.2 测试模块

| 模块 | 文件 | 测试类型 |
|------|------|----------|
| Domain UseCase | `GetContactRecentHistoryUseCase.kt` | 单元测试 |
| Domain UseCase | `RecordContactVisitUseCase.kt` | 单元测试 |
| Domain UseCase | `ClearContactRecentHistoryUseCase.kt` | 单元测试 |
| ViewModel | `ContactListViewModel.kt` | 单元测试 |
| ViewModel | `ContactDetailViewModel.kt` | 人工验证 |
| UI | `ContactListScreen.kt` | 人工测试 |

---

## 二、单元测试用例

**测试文件**：
- `domain/src/test/kotlin/com/empathy/ai/domain/usecase/GetContactRecentHistoryUseCaseTest.kt`
- `domain/src/test/kotlin/com/empathy/ai/domain/usecase/RecordContactVisitUseCaseTest.kt`
- `domain/src/test/kotlin/com/empathy/ai/domain/usecase/ClearContactRecentHistoryUseCaseTest.kt`
- `presentation/src/test/kotlin/com/empathy/ai/presentation/viewmodel/ContactRecentContactsFeatureTest.kt`

### TC-001：加载最近联系人应按历史顺序映射到列表

```kotlin
@Test
fun `加载最近联系人应按历史顺序映射到列表`() = runTest {
    val viewModel = createViewModel(recentIds = listOf("2", "1"))
    testDispatcher.scheduler.advanceUntilIdle()

    val recentNames = viewModel.uiState.value.recentContacts.map { it.name }
    assertEquals(listOf("李四", "张三"), recentNames)
}
```

### TC-002：清空最近联系人应清空列表

```kotlin
@Test
fun `清空最近联系人应清空列表`() = runTest {
    val viewModel = createViewModel(recentIds = listOf("1"))
    testDispatcher.scheduler.advanceUntilIdle()

    viewModel.onEvent(ContactListUiEvent.ClearRecentContacts)
    testDispatcher.scheduler.advanceUntilIdle()

    assertTrue(viewModel.uiState.value.recentContacts.isEmpty())
}
```

### TC-003：最近联系人用例成功与失败分支

已在以下单元测试中覆盖：
- `GetContactRecentHistoryUseCaseTest`
- `RecordContactVisitUseCaseTest`
- `ClearContactRecentHistoryUseCaseTest`

---

## 三、人工测试用例

### TC-101：最近访问区块展示

**前置条件**：至少打开过一个联系人详情

**步骤**：
1. 打开联系人列表
2. 进入任意联系人详情
3. 返回联系人列表

**预期结果**：
1. 列表顶部出现“最近访问”区块
2. 刚访问的联系人显示在区块首位

### TC-102：最近访问去重与顺序更新

**步骤**：
1. 依次访问联系人 A、B、A
2. 返回联系人列表

**预期结果**：
1. 最近访问顺序为 A、B
2. 不出现重复联系人

### TC-103：清空最近访问

**步骤**：
1. 联系人列表顶部点击“清空”

**预期结果**：
1. 最近访问区块消失
2. 联系人主列表正常保留

### TC-104：重启后最近访问仍可用

**步骤**：
1. 进入任意联系人详情后返回列表
2. 退出应用并杀掉进程
3. 重新启动应用并打开联系人列表

**预期结果**：
1. 最近访问区块仍展示
2. 列表顺序与上次访问保持一致

---

## 四、补充说明

- 最近访问最大保存条数为 5 条
- 最近访问存储使用 SharedPreferences

---

## 五、更新记录

- 2026-01-19：版本 1.12.6 构建复跑，未新增/修改用例（安装因设备缺失未完成）。
- 2026-01-19：尝试连接本地模拟器失败，安装仍未完成。
- 2026-01-19：重启 adb 并 reconnect 失败，未新增/修改用例。
- 2026-01-20：尝试连接 127.0.0.1:5554 失败，未新增/修改用例。
- 2026-01-20：尝试连接 192.0.2.1:7555 并 reconnect offline 失败，未新增/修改用例。
- 2026-01-20：设备恢复后完成安装与启动验证（`adb install` / `am start`），未新增/修改用例。
- 2026-01-20：更新到 1.12.7，重跑 domain 与 presentation 单测；首次因 SDK 未配置失败，设置 ANDROID_HOME 后通过；完成 assembleDebug 与安装启动验证。
- 2026-01-20：修复新详情页未记录最近访问问题，新增 `ContactDetailTabRecentVisitTest`，运行通过；完成 1.12.9 构建与安装验证。
