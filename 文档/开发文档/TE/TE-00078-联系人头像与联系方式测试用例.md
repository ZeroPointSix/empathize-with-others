# TE-00078：联系人头像与联系方式测试用例

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档编号 | TE-00078 |
| 关联PRD | PRD-00037 |
| 关联FD | FD-00037 |
| 关联TDD | TDD-00037 |
| 关联TD | TD-00037 |
| 测试类型 | 功能测试 + 兼容性测试 + 回归测试 |
| 编写者 | Codex |
| 编写日期 | 2026-01-20 |

---

## 一、测试范围

### 1.1 测试目标
验证联系人头像与联系方式功能的正确性与稳定性：
1. 联系方式输入、保存与详情页展示正确。
2. 头像支持相册/拍照上传与裁剪，支持多次更换。
3. 默认头像为姓名首字 + 随机背景色且颜色稳定。
4. 权限拒绝/上传失败时提示原因且不影响保存。
5. 数据仅本地保存，升级迁移无数据丢失。

### 1.2 关联模块
| 模块 | 文件 | 测试类型 |
|------|------|----------|
| 联系人模型 | `domain/src/main/kotlin/com/empathy/ai/domain/model/ContactProfile.kt` | 单元 |
| 联系人DAO | `data/src/main/kotlin/com/empathy/ai/data/local/dao/ContactDao.kt` | 单元 |
| 联系人仓库 | `data/src/main/kotlin/com/empathy/ai/data/repository/ContactRepositoryImpl.kt` | 单元 |
| 数据迁移 | `data/src/main/kotlin/com/empathy/ai/data/di/DatabaseModule.kt` | 迁移 |
| 新建联系人 | `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/screen/contact/CreateContactScreen.kt` | 功能 |
| 详情展示 | `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/overview/IdentityCard.kt` | 功能 |
| 编辑对话框 | `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/dialog/EditContactInfoDialog.kt` | 功能 |
| 头像选择 | `presentation/src/main/kotlin/com/empathy/ai/presentation/ui/component/contact/AvatarPicker.kt` | 功能 |

---

## 二、单元测试

### 测试文件
- `data/src/test/.../ContactRepositoryImplTest.kt`
- `domain/src/test/.../ContactProfileTest.kt`

### 测试用例
| 用例编号 | 场景 | 预期结果 |
|---------|------|----------|
| TC-UT-001 | ContactProfile 默认值（contactInfo/头像颜色） | 默认值合法且不影响现有逻辑 |
| TC-UT-002 | entityToDomain 映射新增字段 | contactInfo/avatarColorSeed 映射正确 |
| TC-UT-003 | domainToEntity 映射新增字段 | 数据落库字段正确 |
| TC-UT-004 | updateContactInfo 更新 | 联系方式更新成功 |
| TC-UT-005 | updateAvatar 更新 | 头像地址与颜色索引更新成功 |

---

## 三、数据库迁移测试

### 测试文件
- `data/src/androidTest/.../DatabaseMigration16To17Test.kt`

### 测试用例
| 用例编号 | 场景 | 步骤 | 预期结果 |
|---------|------|------|----------|
| TC-MIG-001 | v16→v17 迁移 | 旧库升级后读取 profiles | 新字段存在且默认值正确 |
| TC-MIG-002 | 旧数据兼容 | 升级后读取旧联系人 | 头像/联系方式展示正常 |

---

## 四、功能测试（手动）

| 用例编号 | 场景 | 步骤 | 预期结果 |
|---------|------|------|----------|
| TC-M-001 | 新建联系人填写联系方式 | 新建联系人 → 填写联系方式 → 保存 → 进入详情页 | 详情页显示联系方式 |
| TC-M-002 | 联系方式为空 | 新建联系人不填联系方式 → 保存 | 详情页显示占位文本 |
| TC-M-003 | 编辑联系方式 | 详情页 → 编辑 → 修改联系方式 → 保存 | 详情页更新显示 |
| TC-M-004 | 相册上传头像 | 编辑页 → 选择相册 → 裁剪 → 保存 | 头像更新为选择图片 |
| TC-M-005 | 拍照上传头像 | 编辑页 → 拍照 → 裁剪 → 保存 | 头像更新为拍照图片 |
| TC-M-006 | 多次更换头像 | 连续更换头像 2 次 | 头像以最新选择为准 |
| TC-M-007 | 权限拒绝 | 拒绝相机/相册权限 | 提示原因，头像保持不变 |
| TC-M-008 | 裁剪取消 | 进入裁剪后取消 | 头像保持不变 |
| TC-M-009 | 默认头像 | 未上传头像 | 显示姓名首字 + 随机色 |
| TC-M-010 | 默认颜色稳定 | 重启 App 后进入详情页 | 默认头像颜色不变化 |

---

## 五、兼容性测试矩阵

| 设备/环境 | 版本 | 预期 |
|-----------|------|------|
| OPPO 真机 | Android 12+ | 相册/拍照/裁剪流程正常 |
| MuMu 模拟器 | Android 12+ | 头像选择可用，详情展示正确 |

---

## 六、回归测试关注点

1. 联系人姓名/目标编辑不受影响。  
2. 联系人详情页与列表页展示无异常。  
3. 联系人保存/删除流程正常。  
4. 事实流/标签编辑功能不受影响。  

---

## 七、测试数据准备

- 联系人A：姓名“张三”，联系方式“13000000000”  
- 联系人B：姓名“李四”，联系方式为空  
- 测试图片：  
  - 正方形头像 512x512（JPG/PNG）  
  - 横图 1280x720  
  - 竖图 720x1280  

---

## 八、执行记录

| 日期 | 内容 | 结果 |
|------|------|------|
| 2026-01-21 | 版本更新至 1.14.17，`assembleDebug` 构建完成并安装到设备 | 完成 |
| 2026-01-21 | `:data:testDebugUnitTest --tests "*ContactRepositoryImplTest"` | 完成 |
| 2026-01-21 | `:data:connectedAndroidTest` 仅筛选 Migration16To17Test（设备上用例被跳过） | 跳过 |
| 2026-01-21 | `:data:connectedAndroidTest` 仅筛选 Migration16To17Test（补齐 schema 17 资产） | 完成 |
| 2026-01-21 | 手动用例 TC-M-001 ~ TC-M-010 与异常场景待执行 | 待执行 |

---

**创建时间**: 2026-01-20  
**创建者**: Codex  
**状态**: 进行中
