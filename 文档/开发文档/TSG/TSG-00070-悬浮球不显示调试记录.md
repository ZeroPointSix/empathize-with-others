# TSG-00070-悬浮球不显示调试记录

## 背景
- 问题现象：悬浮球在真机与模拟器内均未按预期显示，重点表现为“App 内不可见”。
- 目标：记录已尝试的方法、证据与结论，便于继续排查。

## 环境
- 项目：PRD36-picture
- 设备：MuMu 模拟器（192.0.2.1:7555）、OPPO 真机（QCUKF6DUW46XKVU8）
- 分支/提交：回退到 `c8b5e07`（feat: 实现截屏功能并支持多模态AI分析）

## 尝试记录
1. 编译与安装
   - `.\gradlew.bat :app:assembleDebug`
   - `adb -s 192.0.2.1:7555 install -r app\build\outputs\apk\debug\app-debug.apk`
   - `adb -s QCUKF6DUW46XKVU8 install -r app\build\outputs\apk\debug\app-debug.apk`

2. 启动与截图验证
   - `adb -s 192.0.2.1:7555 shell am start -n com.empathy.ai/com.empathy.ai.ui.MainActivity`
   - `adb -s 192.0.2.1:7555 exec-out screencap -p > ...\mumu-xxx.png`
   - 观察：App 内悬浮球未显示；桌面截图曾观察到悬浮球存在。

3. 权限检查
   - `adb -s 192.0.2.1:7555 shell cmd appops get com.empathy.ai SYSTEM_ALERT_WINDOW`
   - 结果：SYSTEM_ALERT_WINDOW 允许。
   - `adb -s 192.0.2.1:7555 shell cmd appops get com.empathy.ai POST_NOTIFICATION`
   - 结果：默认允许或无记录。

4. 服务状态与日志
   - `adb -s 192.0.2.1:7555 shell dumpsys activity services | rg "FloatingWindowService|com.empathy.ai"`
   - 结果：服务处于运行中。
   - `adb -s 192.0.2.1:7555 logcat -d -v time | rg "FloatingWindowService|AndroidFloatingWindowManager"`
   - 结果：日志显示“悬浮球已显示”等，但 UI 未在 App 内出现。

5. 窗口层级与显示屏分析
   - `adb -s 192.0.2.1:7555 shell dumpsys window windows`
   - 现象：
     - App 窗口在 displayId=8。
     - 悬浮层（SYSTEM_ALERT_WINDOW）在 displayId=0。
   - 结论：悬浮层显示在默认显示屏，未覆盖 App 所在显示屏，导致“App 内不可见”。

6. 修复方案尝试（已回退）
   - 尝试方向：启动服务时携带 displayId，Service 使用 displayContext + WindowManager 绑定对应显示屏。
   - 涉及点：
     - Settings 侧采集 `LocalView.current.display?.displayId`
     - Service 侧 `createDisplayContext()` 创建 WindowManager
   - 结果：方案未继续验证，已回退至 `c8b5e07`。

7. 回退与清理
   - `git reset --hard c8b5e07`
   - `git clean -fd`
   - 说明：已清除调试产物与临时记录。

## 当前状态
- 代码已回退到 `c8b5e07`。
- APK 已安装到 MuMu 和 OPPO。
- 仍需继续验证截屏多模态功能，以及悬浮球在 App 内的表现。

## 继续尝试建议
- 在 MuMu 内重新授权悬浮窗权限后，观察 App 内是否出现悬浮球。
- 如仍不显示：再次确认 displayId 与 overlay 目标显示屏是否一致。
