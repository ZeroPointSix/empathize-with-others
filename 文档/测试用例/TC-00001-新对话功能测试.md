# TC-00001: 新对话功能测试

## 用例信息

| 项目 | 内容 |
|------|------|
| 用例编号 | TC-00001 |
| 所属模块 | AI军师 - 会话管理 |
| 优先级 | P0 |
| 前置条件 | 进入会话历史页面 |

## 测试目标

验证"新建会话"功能能够正确创建新会话并跳转到聊天界面。

---

## 测试用例 1: 新建会话按钮点击

### 用例描述

点击"新建"按钮后，系统应该创建新会话并跳转到聊天页面。

### 前置条件

1. 用户已打开 AI军师功能
2. 用户已进入会话历史页面 (`/advisor/sessions/{contactId}`)
3. 页面已加载完成（`isLoading = false`）

### 测试步骤

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击导航栏右侧"新建"按钮 | 按钮响应点击事件 |
| 2 | 观察系统行为 | 创建新会话成功 |
| 3 | 观察页面跳转 | 跳转到聊天页面，显示新会话内容 |

### 预期结果

1. 创建新会话的 UseCase 被调用
2. 新会话添加到会话列表顶部
3. 页面跳转到 `/advisor/chat/{contactId}?sessionId={newSessionId}`

### 测试数据

- `contactId`: 任意有效联系人ID（如 "contact_001"）

### 测试环境

- 设备: Android 模拟器/真机
- 系统版本: Android 7.0+

---

## 测试用例 2: 从空状态创建新会话

### 用例描述

在无历史会话的空状态页面，点击"发起新对话"按钮应能创建新会话。

### 前置条件

1. 用户进入会话历史页面
2. 该联系人没有任何历史会话（`isEmpty = true`）

### 测试步骤

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 确认页面显示"暂无历史会话"空状态 | 显示空状态视图 |
| 2 | 点击"发起新对话"按钮 | 按钮响应点击事件 |
| 3 | 观察系统行为 | 创建新会话成功 |
| 4 | 观察页面跳转 | 跳转到聊天页面 |

### 预期结果

1. 空状态视图中的"发起新对话"按钮正常工作
2. 创建新会话成功
3. 跳转到聊天页面

---

## 测试用例 3: 会话列表点击跳转

### 用例描述

点击会话列表中的某个会话，应跳转到对应会话的聊天页面。

### 前置条件

1. 用户进入会话历史页面
2. 会话列表中有多个会话

### 测试步骤

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击任意会话列表项 | 选中会话高亮 |
| 2 | 观察页面跳转 | 跳转到该会话的聊天页面 |

### 预期结果

1. 点击的会话ID被正确传递
2. 页面跳转到 `/advisor/chat/{contactId}?sessionId={sessionId}`
3. 聊天页面加载该会话的历史消息

### 边界情况

- 大量会话时的性能表现
- 网络延迟时的加载状态

---

## 测试用例 4: 验证会话创建后ID唯一性

### 用例描述

连续创建多个新会话，每个会话应有唯一的ID。

### 前置条件

1. 用户进入会话历史页面

### 测试步骤

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击"新建"按钮创建会话1 | 会话1创建成功 |
| 2 | 在聊天页面返回会话历史 | 返回会话历史页面 |
| 3 | 再次点击"新建"创建会话2 | 会话2创建成功 |
| 4 | 检查两个会话的ID | ID 不相同 |

### 预期结果

1. 每次创建的会话ID唯一
2. 新会话出现在列表顶部
3. 旧会话仍然保留在列表中

---

## 自动化测试用例 (Unit Test)

### Test 1: SessionHistoryViewModel.createNewSession

```kotlin
@Test
fun `createNewSession should create session and emit success`() = runTest {
    // Given
    val contactId = "test_contact"
    val expectedSession = AiAdvisorSession.create(contactId, "新对话")
    whenever(aiAdvisorRepository.createSession(any()))
        .thenReturn(Result.success(expectedSession))

    // When
    viewModel.createNewSession()

    // Then
    verify(aiAdvisorRepository).createSession(any())
    assertEquals(listOf(expectedSession), viewModel.uiState.value.sessions)
    assertEquals(expectedSession.id, viewModel.uiState.value.newCreatedSessionId)
}
```

### Test 2: SessionHistoryViewModel.createNewSession failure

```kotlin
@Test
fun `createNewSession should emit error on failure`() = runTest {
    // Given
    val contactId = "test_contact"
    whenever(aiAdvisorRepository.createSession(any()))
        .thenReturn(Result.failure(Exception("创建失败")))

    // When
    viewModel.createNewSession()

    // Then
    assertEquals("创建失败", viewModel.uiState.value.error)
}
```

### Test 3: NavGraph onCreateNewSession navigation

```kotlin
@Test
fun `NavGraph should navigate with correct sessionId after creation`() {
    // Given - 需要集成测试验证
    // 当 onCreateNewSession 被调用后
    // 应该使用新创建的 sessionId 进行导航

    // Then - 验证导航到正确路由
    verify(navController).navigate(
        route = "advisor/chat/contact_001?sessionId=new_session_id"
    )
}
```

---

## 测试结果记录

| 用例编号 | 测试日期 | 测试人员 | 测试结果 | 备注 |
|---------|---------|---------|---------|------|
| TC-00001-01 | - | - | 待测试 | 新建会话按钮点击 |
| TC-00001-02 | - | - | 待测试 | 空状态创建会话 |
| TC-00001-03 | - | - | 待测试 | 会话列表点击跳转 |
| TC-00001-04 | - | - | 待测试 | 会话ID唯一性 |

## 关联文档

- BUG-00001: 新对话按钮无法创建新会话
- PRD-00029: AI军师UI架构优化需求
- TDD-00029: AI军师UI架构优化技术设计
