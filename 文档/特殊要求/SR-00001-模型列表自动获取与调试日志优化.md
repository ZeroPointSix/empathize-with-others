# SR-00001 模型列表自动获取与调试日志优化

> 文档类型：特殊需求（Special Requirement）
> 创建日期：2025-12-17
> 状态：开发完成，待验收

---

## 1. 需求概述

本文档包含两个独立的优化需求：

1. **模型列表自动获取**：支持从 AI 服务商 API 自动获取可用模型列表
2. **调试日志优化**：在调试模式下显示完整的提示词内容

---

## 2. 需求一：模型列表自动获取

### 2.1 背景

当前用户配置 AI 服务商时，需要手动输入模型 ID（如 `gpt-4o-mini`、`deepseek-chat`）。这存在以下问题：

- **成本高**：用户需要查阅服务商文档获取准确的模型 ID
- **易出错**：模型 ID 格式复杂，容易输入错误
- **不及时**：服务商新增模型后，用户无法及时获知

### 2.2 功能需求

#### FR-001：获取模型列表 API

- 系统应支持调用 OpenAI 兼容的 `/models` 端点获取可用模型列表
- 支持的服务商：
  - OpenAI：`GET https://api.openai.com/v1/models`
  - DeepSeek：`GET https://api.deepseek.com/models`
  - 其他 OpenAI 兼容服务商

#### FR-002：UI 交互

- 在服务商配置对话框中添加"获取模型列表"按钮
- 点击后显示加载状态
- 成功后自动填充模型列表
- 失败后显示错误提示，保留手动添加能力

#### FR-003：兼容性处理

- 如果服务商不支持 `/models` 端点，显示友好提示
- 保留手动添加模型的能力（现有功能不变）
- 支持混合模式：自动获取 + 手动补充

### 2.3 技术设计

#### 2.3.1 API 层

```kotlin
// OpenAiApi.kt 新增方法
@GET
suspend fun listModels(
    @Url fullUrl: String,
    @HeaderMap headers: Map<String, String>
): ModelsResponseDto

// 新增 DTO
data class ModelsResponseDto(
    val data: List<ModelDto>,
    val `object`: String? = null
)

data class ModelDto(
    val id: String,
    val `object`: String? = null,
    val created: Long? = null,
    val owned_by: String? = null
)
```

#### 2.3.2 Repository 层

```kotlin
// AiProviderRepository.kt 新增方法
suspend fun fetchAvailableModels(provider: AiProvider): Result<List<AiModel>>
```

#### 2.3.3 UI 层

```kotlin
// AiConfigUiEvent.kt 新增事件
data object FetchModels : AiConfigUiEvent

// AiConfigUiState.kt 新增状态
val isFetchingModels: Boolean = false
val fetchModelsError: String? = null
```

### 2.4 验收标准

- [ ] 点击"获取模型列表"按钮后，能成功获取 OpenAI 模型列表
- [ ] 点击"获取模型列表"按钮后，能成功获取 DeepSeek 模型列表
- [ ] 获取失败时显示错误提示
- [ ] 手动添加模型功能不受影响
- [ ] 单元测试覆盖率 > 80%

---

## 3. 需求二：调试日志优化

### 3.1 背景

当前 `AiRepositoryImpl` 在记录调试日志时，将提示词截取为前 500/800 字符：

```kotlin
// 第 360 行
android.util.Log.d("AiRepositoryImpl", "PromptContext预览(前800字符): ${promptContext.take(800)}")

// 第 379 行
android.util.Log.d("AiRepositoryImpl", "SystemInstruction预览(前500字符): ${effectiveSystemInstruction.take(500)}")
```

这导致开发者在调试时无法看到完整的提示词内容，影响问题排查效率。

### 3.2 功能需求

#### FR-004：完整日志输出

- 在 Debug 构建模式下，输出完整的提示词内容
- 在 Release 构建模式下，保持截取（安全和性能考虑）

#### FR-005：分段输出

- 如果提示词超过 4000 字符（Android Log 限制），分多条日志输出
- 添加序号标识便于拼接

#### FR-006：日志格式优化

- 添加清晰的分隔线
- 显示总长度信息
- 显示分段信息（如 "第 1/3 段"）

### 3.3 技术设计

#### 3.3.1 日志工具类

```kotlin
// DebugLogger.kt
object DebugLogger {
    private const val MAX_LOG_LENGTH = 4000
    
    fun logFullPrompt(tag: String, label: String, content: String) {
        if (!BuildConfig.DEBUG) {
            // Release 模式：截取输出
            Log.d(tag, "$label (前500字符): ${content.take(500)}")
            return
        }
        
        // Debug 模式：完整输出
        Log.d(tag, "========== $label 开始 (总长度: ${content.length}) ==========")
        
        if (content.length <= MAX_LOG_LENGTH) {
            Log.d(tag, content)
        } else {
            // 分段输出
            val segments = content.chunked(MAX_LOG_LENGTH)
            segments.forEachIndexed { index, segment ->
                Log.d(tag, "[$label 第 ${index + 1}/${segments.size} 段]\n$segment")
            }
        }
        
        Log.d(tag, "========== $label 结束 ==========")
    }
}
```

#### 3.3.2 修改 AiRepositoryImpl

```kotlin
// 替换原有的截取日志
DebugLogger.logFullPrompt("AiRepositoryImpl", "PromptContext", promptContext)
DebugLogger.logFullPrompt("AiRepositoryImpl", "SystemInstruction", effectiveSystemInstruction)
```

### 3.4 验收标准

- [ ] Debug 模式下能看到完整的提示词内容
- [ ] Release 模式下保持截取输出
- [ ] 超长提示词能正确分段输出
- [ ] 日志格式清晰易读
- [ ] 单元测试覆盖率 > 80%

---

## 4. 任务清单

### 4.1 需求一：模型列表自动获取

| 任务 ID | 任务描述 | 预估工时 | 状态 |
|---------|----------|----------|------|
| SR001-T01 | 创建 ModelsResponseDto 和 ModelDto | 0.5h | ✅ 已完成 |
| SR001-T02 | OpenAiApi 添加 listModels 方法 | 0.5h | ✅ 已完成 |
| SR001-T03 | AiProviderRepository 添加 fetchAvailableModels 接口 | 0.5h | ✅ 已完成 |
| SR001-T04 | AiProviderRepositoryImpl 实现 fetchAvailableModels | 1h | ✅ 已完成 |
| SR001-T05 | AiConfigUiEvent 添加 FetchModels 事件 | 0.5h | ✅ 已完成 |
| SR001-T06 | AiConfigUiState 添加获取模型状态 | 0.5h | ✅ 已完成 |
| SR001-T07 | AiConfigViewModel 实现 fetchModels 逻辑 | 1h | ✅ 已完成 |
| SR001-T08 | ProviderFormDialog 添加"获取模型列表"按钮 | 1h | ✅ 已完成 |
| SR001-T09 | 编写单元测试 | 1.5h | ✅ 已完成 |
| SR001-T10 | 集成测试和验收 | 1h | 待验收 |

### 4.2 需求二：调试日志优化

| 任务 ID | 任务描述 | 预估工时 | 状态 |
|---------|----------|----------|------|
| SR001-T11 | 创建 DebugLogger 工具类 | 0.5h | ✅ 已完成 |
| SR001-T12 | 修改 AiRepositoryImpl 日志输出 | 0.5h | ✅ 已完成 |
| SR001-T13 | 编写单元测试 | 0.5h | ✅ 已完成 |
| SR001-T14 | 验证 Debug/Release 模式行为 | 0.5h | 待验收 |

---

## 5. 风险评估

### 5.1 需求一风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 部分服务商不支持 /models 端点 | 中 | 保留手动添加能力，显示友好提示 |
| API Key 权限不足 | 低 | 捕获 403 错误，提示用户检查权限 |
| 模型列表过长 | 低 | 添加搜索/过滤功能 |

### 5.2 需求二风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 日志泄露敏感信息 | 中 | Release 模式保持截取 |
| 日志过多影响性能 | 低 | 仅在 Debug 模式启用完整日志 |

---

## 6. 相关文档

- [AiProvider 模型定义](../../app/src/main/java/com/empathy/ai/domain/model/AiProvider.kt)
- [AiProviderRepository 接口](../../app/src/main/java/com/empathy/ai/domain/repository/AiProviderRepository.kt)
- [AiRepositoryImpl 实现](../../app/src/main/java/com/empathy/ai/data/repository/AiRepositoryImpl.kt)
- [ProviderFormDialog UI](../../app/src/main/java/com/empathy/ai/presentation/ui/component/dialog/ProviderFormDialog.kt)
