# TDD-00007: 提示词系统三层分离架构设计

## 文档信息

**文档编号**: TDD-00007  
**版本**: 1.0  
**创建日期**: 2025-12-16  
**状态**: ✅ 已实现  
**关联BUG**: BUG-00010（自定义提示词未生效）

---

## 1. 问题背景

### 1.1 原有设计问题

原有提示词系统存在以下架构问题：

1. **职责边界模糊**：用户提示词和系统约束混在一起
2. **技术细节暴露**：用户需要了解 `{{CONTEXT_DATA_PLACEHOLDER}}` 等占位符
3. **系统指令分散**：`SystemPrompts.kt` 和 `AiRepositoryImpl.kt` 重复定义系统指令
4. **用户认知负担**：用户不清楚自己的输入会放在哪里，也不知道哪些数据会自动注入

### 1.2 用户心智模型 vs 系统模型

| 用户期望 | 系统实际 |
|---------|---------|
| "我告诉AI要怎么分析" | 用户输入 + 系统约束 + 运行时数据 → 最终提示词 |
| 不需要知道技术细节 | 暴露了占位符语法 |
| 只关心AI的行为风格 | 混入了数据注入逻辑 |

---

## 2. 三层分离架构

### 2.1 架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          提示词三层分离架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  第一层：系统约束层（System Layer）                                           │
│  ├── 特点：用户不可见、不可编辑                                               │
│  ├── 内容：                                                                  │
│  │   ├── Header: 角色定义（你是一个专业的社交沟通顾问...）                      │
│  │   └── Footer: 输出格式约束（JSON Schema）                                  │
│  └── 来源：SystemPrompts.kt                                                  │
│                                                                             │
│  第二层：用户指令层（User Instruction Layer）                                  │
│  ├── 特点：用户可编辑                                                         │
│  ├── 内容：                                                                  │
│  │   ├── 全局场景指令：定义AI的分析风格、关注重点                               │
│  │   └── 联系人专属指令：针对特定联系人的特殊要求                               │
│  └── 来源：PromptRepository                                                  │
│                                                                             │
│  第三层：运行时数据层（Runtime Data Layer）                                    │
│  ├── 特点：系统自动注入、用户不可见                                            │
│  ├── 内容：                                                                  │
│  │   ├── 联系人画像（Facts、Tags）                                            │
│  │   ├── 聊天记录                                                            │
│  │   └── 攻略目标                                                            │
│  └── 来源：UseCase 构建                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 最终组装顺序

```
┌─────────────────────────────────────────────────────────────────────┐
│ [系统Header]                                                        │
│   你是一个专业的社交沟通分析助手...                                    │
│                                                                     │
│ [用户全局指令]（如有）                                                │
│   【用户自定义指令】                                                  │
│   分析时要特别关注对方的情绪变化...                                    │
│                                                                     │
│ [用户联系人指令]（如有）                                              │
│   【针对此联系人的特殊指令】                                          │
│   和她聊天时要注意避开前任话题...                                      │
│                                                                     │
│ [运行时数据]                                                         │
│   【上下文数据】                                                      │
│   【攻略目标】追求她成为女朋友                                         │
│   【已知信息】生日: 12月21日, 爱好: 阅读                               │
│   【雷区警告】不要提前任                                              │
│   【聊天记录】...                                                     │
│                                                                     │
│ [系统Footer]                                                        │
│   请以JSON格式返回分析结果...                                         │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. API 设计

### 3.1 PromptBuilder 新 API

```kotlin
/**
 * 构建完整的系统指令（包含运行时数据）
 *
 * @param scene 场景类型
 * @param contactId 联系人ID（可选）
 * @param context 变量上下文
 * @param runtimeData 运行时数据（由UseCase构建）
 * @return 构建好的完整系统指令
 */
suspend fun buildSystemInstruction(
    scene: PromptScene,
    contactId: String? = null,
    context: PromptContext,
    runtimeData: String = ""
): String

/**
 * 仅获取用户自定义指令部分
 *
 * 用于需要单独获取用户指令的场景（如Function Calling模式）
 * 不包含系统Header/Footer
 */
suspend fun getUserInstructionOnly(
    scene: PromptScene,
    contactId: String? = null,
    context: PromptContext
): String
```

### 3.2 调用示例

```kotlin
// AnalyzeChatUseCase 中的调用
val runtimeData = buildContextData(
    targetGoal = profile.targetGoal,
    facts = profile.facts,
    redTags = redTags,
    greenTags = greenTags,
    conversationHistory = maskedContext
)

val systemInstruction = promptBuilder.buildSystemInstruction(
    scene = PromptScene.ANALYZE,
    contactId = contactId,
    context = promptContext,
    runtimeData = runtimeData  // 运行时数据直接传入
)
```

---

## 4. 用户体验改进

### 4.1 用户编辑界面

用户在编辑提示词时：

- ✅ 只需要定义"AI应该怎么做"
- ✅ 不需要知道数据会自动注入
- ✅ 不需要了解占位符语法
- ✅ 占位符文本更加友好

### 4.2 占位符文本示例

| 场景 | 占位符文本 |
|------|-----------|
| 分析 | "例如：分析时要特别关注对方的情绪变化，给出温和的回复建议" |
| 检查 | "例如：检查时要特别注意工作相关话题，避免敏感词汇" |
| 提取 | "例如：重点关注对方提到的兴趣爱好和重要日期" |
| 总结 | "例如：总结今天的对话亮点和需要注意的地方" |
| 联系人 | "例如：和她聊天时要注意避开前任话题，多聊她喜欢的书" |

---

## 5. 兼容性处理

### 5.1 废弃方法

```kotlin
@Deprecated(
    message = "使用 buildSystemInstruction(scene, contactId, context, runtimeData) 替代",
    replaceWith = ReplaceWith("buildSystemInstruction(scene, contactId, context, runtimeData)")
)
fun injectContextData(instruction: String, contextData: String): String
```

### 5.2 向后兼容

- 旧的 `injectContextData` 方法保留，但标记为 `@Deprecated`
- 如果指令中包含旧的占位符，仍然会正确替换
- 如果没有占位符，会追加数据到末尾

---

## 6. 修改文件清单

| 文件 | 修改类型 | 说明 |
|------|---------|------|
| `domain/util/PromptBuilder.kt` | 重构 | 实现三层分离架构 |
| `domain/usecase/AnalyzeChatUseCase.kt` | 修改 | 使用新API |
| `data/repository/AiRepositoryImpl.kt` | 修改 | 优化Function Calling分支 |
| `test/.../PromptBuilderTest.kt` | 更新 | 适配新API |

---

## 7. 设计原则

1. **关注点分离**：系统约束、用户指令、运行时数据各司其职
2. **用户友好**：隐藏技术细节，降低使用门槛
3. **可扩展性**：新增场景只需在 `SystemPrompts` 中添加 Header/Footer
4. **向后兼容**：保留废弃方法，平滑迁移

---

## 8. 相关文档

- [BUG-00010-自定义提示词未生效问题分析](../BUG/BUG-00010-自定义提示词未生效问题分析.md)
- [TDD-00005-提示词管理系统技术设计](TDD-00005-提示词管理系统技术设计.md)
- [TD-00006-提示词编辑界面任务清单](../TD/TD-00006-提示词编辑界面任务清单.md)
