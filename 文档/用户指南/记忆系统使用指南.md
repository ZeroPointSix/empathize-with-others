# 联系人画像记忆系统使用指南

> **文档类型**: 用户指南  
> **创建日期**: 2025-12-14  
> **适用版本**: v1.0+  
> **状态**: 📝 草稿

---

## 📖 系统概述

联系人画像记忆系统是共情AI助手的核心功能之一，它能够：

- 🤖 **自动记录**：每次AI分析后自动记录对话内容
- 📊 **智能总结**：每天自动总结与联系人的互动
- 📈 **关系追踪**：持续追踪与联系人的关系进展
- 🧠 **上下文构建**：为AI提供完整的历史上下文

---

## 🎯 当前可用功能

### ✅ 已实现（后端）

#### 1. 自动记录互动

**工作原理**：
- 每次在聊天页面点击"分析聊天"按钮
- 系统自动记录用户输入和AI响应
- 数据存储在本地数据库的 `conversation_logs` 表

**数据内容**：
```kotlin
ConversationLog {
    id: Long                    // 记录ID
    contactId: String           // 联系人ID
    userInput: String           // 用户输入的内容
    aiResponse: String?         // AI的响应内容
    timestamp: Long             // 记录时间戳
    isSummarized: Boolean       // 是否已被总结
}
```

#### 2. 智能上下文构建

**工作原理**：
- 当你点击"分析聊天"时，系统会：
  1. 提取最近的对话记录（根据 `contextDepth` 设置）
  2. 加载该联系人的每日总结
  3. 加载联系人的画像信息（Facts）
  4. 构建完整的上下文发送给AI

**上下文结构**：
```
=== 联系人画像 ===
姓名: 张三
目标: 建立良好的合作关系
关系分数: 75

=== 画像记录 ===
- 喜欢摄影（2024-12-10）
- 最近工作压力大（2024-12-12）

=== 历史总结 ===
[2024-12-13] 今天讨论了项目进展...

=== 最近对话 ===
[用户] 你好，最近怎么样？
[AI] 根据画像，建议...
```

#### 3. 每日自动总结

**工作原理**：
- 每天在设定的时间（默认22:00）自动触发
- 系统会：
  1. 查找所有未总结的对话记录
  2. 按联系人分组
  3. 调用AI生成每日总结
  4. 更新关系分数
  5. 提取新的画像信息（Facts）

**总结内容**：
```kotlin
DailySummary {
    id: Long                    // 总结ID
    contactId: String           // 联系人ID
    summaryDate: String         // 总结日期（YYYY-MM-DD）
    content: String             // 总结内容
    keyEvents: List<String>     // 关键事件列表
    relationshipScore: Int      // 当天的关系分数
    createdAt: Long             // 创建时间戳
}
```

#### 4. 关系进展追踪

**工作原理**：
- 每次总结时，AI会评估关系分数（0-100）
- 分数存储在 `ContactProfile.relationshipScore`
- 历史分数存储在每日总结中

**分数含义**：
- **0-30**：关系冷淡，需要改善
- **31-60**：关系一般，有提升空间
- **61-80**：关系良好，保持现状
- **81-100**：关系优秀，深度信任

#### 5. 画像信息提取

**工作原理**：
- AI在总结时会提取关键信息
- 自动生成 `Fact` 对象
- 存储在 `ContactProfile.facts` 列表中

**Fact结构**：
```kotlin
Fact {
    key: String                 // 信息类别（如"兴趣爱好"）
    value: String               // 具体内容（如"喜欢摄影"）
    timestamp: Long             // 记录时间
    source: String              // 来源（AI_INFERRED）
    confidence: Float           // 置信度（0.0-1.0）
}
```

---

## 🚧 待实现（前端UI）

### ❌ 当前缺失的UI功能

#### 1. 记忆时间线页面

**功能**：查看与联系人的完整互动历史

**包含内容**：
- 关系进展曲线图
- 每日总结列表（可展开/折叠）
- 对话记录列表
- 画像信息变化历史

**预计位置**：联系人详情页的新Tab

#### 2. 每日总结管理页面

**功能**：集中管理所有联系人的每日总结

**包含内容**：
- 按日期查看所有总结
- 按联系人筛选
- 手动触发总结
- 查看失败的总结任务

**预计位置**：主菜单新增入口

#### 3. 对话记录管理页面

**功能**：查看和管理所有对话记录

**包含内容**：
- 对话记录列表
- 按联系人/时间筛选
- 查看总结状态
- 手动删除记录

**预计位置**：联系人详情或主菜单

#### 4. 聊天页面记忆提示

**功能**：在聊天时显示关键记忆

**包含内容**：
- 最新总结摘要
- 关键画像信息
- 快速跳转到完整记忆

**预计位置**：聊天页面顶部

#### 5. 设置页面记忆配置

**功能**：配置记忆系统参数

**包含内容**：
- 自动总结开关
- 总结时间设置
- 数据保留策略
- 存储使用情况
- 手动清理按钮

**预计位置**：设置页面新增部分

---

## 💡 当前如何使用

### 场景1：让系统记录对话

```
步骤：
1. 打开应用 → 联系人列表
2. 点击某个联系人 → 进入聊天页面
3. 输入一些消息（模拟对话）
4. 点击右上角的"分析"按钮（🧠图标）
5. 系统会：
   - 分析聊天内容
   - 自动记录到数据库
   - 显示分析结果
```

**数据存储位置**：
- 数据库表：`conversation_logs`
- 可以通过数据库工具查看（如Android Studio的Database Inspector）

### 场景2：触发每日总结

**自动触发**：
```
- 系统会在每天22:00自动运行
- 需要应用在后台运行
- 使用WorkManager调度任务
```

**手动触发**（需要代码调用）：
```kotlin
// 在代码中手动触发
val summarizeUseCase = SummarizeDailyConversationsUseCase(...)
viewModelScope.launch {
    summarizeUseCase()
}
```

**数据存储位置**：
- 数据库表：`daily_summaries`
- 关系分数更新到：`profiles.relationship_score`
- 新的Facts添加到：`profiles.facts`

### 场景3：查看记录的数据

**使用Android Studio Database Inspector**：

```
步骤：
1. 打开Android Studio
2. 运行应用到模拟器/真机
3. View → Tool Windows → App Inspection
4. 选择 Database Inspector
5. 选择 empathy_ai_database
6. 查看以下表：
   - conversation_logs（对话记录）
   - daily_summaries（每日总结）
   - profiles（联系人信息，包含facts和relationshipScore）
```

**使用adb命令**：

```bash
# 导出数据库文件
adb exec-out run-as com.empathy.ai cat databases/empathy_ai_database > empathy_ai.db

# 使用SQLite工具打开
sqlite3 empathy_ai.db

# 查询对话记录
SELECT * FROM conversation_logs ORDER BY timestamp DESC LIMIT 10;

# 查询每日总结
SELECT * FROM daily_summaries ORDER BY summary_date DESC;

# 查询联系人关系分数
SELECT id, name, relationship_score, last_interaction_date FROM profiles;
```

---

## 🔧 配置说明

### 记忆系统配置

**配置文件**：`MemoryPreferences`

**可配置项**：

```kotlin
// 自动总结开关
autoSummaryEnabled: Boolean = true

// 总结时间（小时，0-23）
summaryHour: Int = 22

// 对话记录保留天数
conversationRetentionDays: Int = 30

// 总结记录保留天数
summaryRetentionDays: Int = 90

// 失败任务最大重试次数
maxRetryCount: Int = 3
```

**修改配置**（需要代码）：

```kotlin
val preferences = MemoryPreferences(context)

// 修改总结时间为每天20:00
preferences.setSummaryHour(20)

// 修改对话保留天数为60天
preferences.setConversationRetentionDays(60)
```

### 联系人上下文深度

**配置位置**：每个联系人的 `contextDepth` 字段

**含义**：AI分析时会读取最近N条对话记录

**默认值**：10条

**修改方法**：
1. 进入联系人详情页
2. 点击"编辑"
3. 调整"上下文深度"滑块（5-30）
4. 保存

---

## 📊 数据流程图

### 对话记录流程

```
用户输入消息
    ↓
点击"分析聊天"
    ↓
ChatViewModel.analyzeChat()
    ↓
AnalyzeChatUseCase
    ↓
MemoryLogger.logInteraction()  ← 自动记录
    ↓
ConversationRepository.insertLog()
    ↓
存储到 conversation_logs 表
```

### 每日总结流程

```
定时任务触发（22:00）
    ↓
SummarizeDailyConversationsUseCase
    ↓
查询未总结的对话记录
    ↓
按联系人分组
    ↓
对每个联系人：
    ├─ ContextBuilder.buildContext()
    ├─ AiRepository.generateSummary()
    ├─ AiSummaryProcessor.process()
    ├─ 更新 relationship_score
    ├─ 添加新的 facts
    └─ 保存到 daily_summaries 表
```

---

## 🐛 常见问题

### Q1: 为什么看不到记录的数据？

**A**: 当前版本没有UI展示，需要通过以下方式查看：
- Android Studio的Database Inspector
- adb命令导出数据库
- 等待UI功能开发完成（预计10-15天）

### Q2: 每日总结什么时候运行？

**A**: 默认每天22:00自动运行，需要：
- 应用在后台运行
- 设备未进入省电模式
- 有网络连接（调用AI API）

### Q3: 如何手动触发总结？

**A**: 当前版本需要通过代码调用，UI功能正在开发中。

### Q4: 数据会保留多久？

**A**: 
- 对话记录：默认30天
- 每日总结：默认90天
- 可以通过配置修改

### Q5: 如何清理过期数据？

**A**: 
- 自动清理：每天总结时自动清理
- 手动清理：调用 `DataCleanupManager.cleanupExpiredData()`
- UI功能正在开发中

---

## 🚀 即将推出

根据 [PRD-00004-联系人画像记忆系统UI集成需求](../开发文档/PRD/PRD-00004-联系人画像记忆系统UI集成需求.md)，以下功能即将推出：

### 第一批（预计1-2周）

- ✨ 记忆时间线页面
- ✨ 每日总结管理页面
- ✨ 对话记录管理页面

### 第二批（预计2-3周）

- ✨ 聊天页面记忆提示
- ✨ 设置页面记忆配置
- ✨ 关系进展可视化

---

## 📚 相关文档

- [PRD-00003-联系人画像记忆系统需求](../开发文档/PRD/PRD-00003-联系人画像记忆系统需求.md)
- [PRD-00004-联系人画像记忆系统UI集成需求](../开发文档/PRD/PRD-00004-联系人画像记忆系统UI集成需求.md)
- [FD-00003-联系人画像记忆系统设计](../开发文档/FD/FD-00003-联系人画像记忆系统设计.md)
- [IMPL-00003-联系人画像记忆系统实现进度](../开发文档/IMPL/IMPL-00003-联系人画像记忆系统实现进度.md)

---

**文档版本**: v1.0  
**最后更新**: 2025-12-14  
**更新者**: Kiro
